<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>KLMZ MUSIC</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  
  <style>
  *{box-sizing:border-box}
  body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#181818;color:#fff;padding:2rem}
  header{background:#121212;padding:1rem;display:flex;align-items:center;justify-content:space-between;border-radius:12px;margin-bottom:2rem}
  .logo{font-weight:700;font-size:1.4rem;color:#1DB954}
  .user-section{display:flex;align-items:center;gap:1rem}
  .user-info{display:none;align-items:center;gap:0.5rem;background:#333;padding:0.5rem 1rem;border-radius:8px}
  .user-info.admin{background:#1DB954;animation:adminGlow 2s infinite alternate}
  @keyframes adminGlow{0%{box-shadow:0 0 5px #1DB954}100%{box-shadow:0 0 20px #1DB954,0 0 30px #1DB954}}
  .lock-icon{cursor:pointer;font-size:1.4rem;padding:0.5rem;border-radius:8px;background:#333;transition:all 0.2s}
  .lock-icon:hover{background:#444}
  .lock-icon.admin{background:#1DB954;animation:crownPulse 1.5s infinite}
  @keyframes crownPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
  .status{padding:1.5rem;border-radius:12px;font-family:monospace;margin:2rem 0;border-left:4px solid #1DB954}
  .status.success{background:#1a2e1a;color:#51cf66;border-left-color:#51cf66}
  .status.error{background:#2d1517;color:#ff6b6b;border-left-color:#ff6b6b}
  .status.info{background:#1e2833;color:#74c0fc;border-left-color:#74c0fc}
  .status.admin{background:#1DB954;color:#fff;border-left-color:#fff;font-weight:bold}
  .album-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:2rem;margin-top:2rem}
  .album-card{text-align:center;padding:2rem;background:#282828;border-radius:12px;transition:transform 0.3s;position:relative}
  .album-card:hover{transform:scale(1.05)}
  .album-actions{position:absolute;top:0.5rem;right:0.5rem;display:none;gap:0.5rem}
  .album-card:hover .album-actions{display:flex}
  .test-buttons{display:flex;gap:1rem;margin-top:2rem;flex-wrap:wrap}
  .btn{padding:0.75rem 1.5rem;background:#1DB954;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:0.9rem;transition:background 0.2s}
  .btn:hover{background:#1ed760}
  .btn.secondary{background:#333;color:#fff}
  .btn.secondary:hover{background:#444}
  .btn.danger{background:#dc3545}
  .btn.danger:hover{background:#c82333}
  .btn.admin{background:linear-gradient(45deg,#1DB954,#1ed760);box-shadow:0 4px 15px rgba(29,185,84,0.3)}
  .btn.small{padding:0.5rem;font-size:0.8rem;min-width:auto}
  .empty-state{text-align:center;padding:3rem;color:#666;grid-column:1/-1;background:#222;border-radius:12px}
  .admin-badge{background:linear-gradient(45deg,#1DB954,#1ed760);color:#fff;padding:0.25rem 0.75rem;border-radius:20px;font-size:0.8rem;font-weight:bold;margin-left:0.5rem}

  /* Panel de administraci√≥n */
  .admin-panel{display:none;background:#222;border-radius:12px;padding:2rem;margin:2rem 0;border:2px solid #1DB954}
  .admin-panel.show{display:block}
  .admin-tabs{display:flex;gap:1rem;margin-bottom:2rem;border-bottom:1px solid #333}
  .admin-tab{background:none;border:none;color:#999;padding:1rem;cursor:pointer;border-bottom:2px solid transparent;transition:all 0.2s}
  .admin-tab.active{color:#1DB954;border-bottom-color:#1DB954}
  .admin-content{display:none}
  .admin-content.active{display:block}
  .form-row{display:flex;gap:1rem;margin-bottom:1rem}
  .form-group{flex:1;margin-bottom:1.5rem}
  .form-group label{display:block;margin-bottom:0.5rem;color:#ccc;font-weight:600}
  .form-group input, .form-group textarea{width:100%;padding:0.75rem;background:#333;border:1px solid #555;border-radius:8px;color:#fff;font-size:1rem;font-family:inherit}
  .form-group input:focus, .form-group textarea:focus{outline:none;border-color:#1DB954;box-shadow:0 0 0 2px rgba(29,185,84,0.2)}
  .form-group textarea{resize:vertical;min-height:100px}
  
  /* Subida de portada */
  .cover-upload{border:2px dashed #555;padding:2rem;text-align:center;border-radius:8px;transition:all 0.2s;cursor:pointer;position:relative;overflow:hidden}
  .cover-upload:hover{border-color:#1DB954}
  .cover-upload.has-image{border-color:#1DB954;background-size:cover;background-position:center;background-repeat:no-repeat}
  .cover-upload-overlay{background:rgba(0,0,0,0.7);padding:1rem;border-radius:4px;position:relative;z-index:2}
  .cover-preview{width:100px;height:100px;border-radius:8px;object-fit:cover;margin:0 auto 1rem;display:none}
  
  .file-upload{border:2px dashed #555;padding:2rem;text-align:center;border-radius:8px;transition:border-color 0.2s}
  .file-upload:hover{border-color:#1DB954}
  .file-upload.dragover{border-color:#1DB954;background:#1a2e1a}
  .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:2rem}
  .stat-card{background:#333;padding:1.5rem;border-radius:8px;text-align:center}
  .stat-number{font-size:2rem;font-weight:bold;color:#1DB954;margin-bottom:0.5rem}
  .stat-label{color:#999;font-size:0.9rem}

  /* Modal styles */
  .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;align-items:center;justify-content:center}
  .modal.show{display:flex}
  .modal-content{background:#222;padding:2rem;border-radius:12px;width:90%;max-width:500px;position:relative;max-height:80vh;overflow-y:auto}
  .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem}
  .modal-title{font-size:1.4rem;color:#1DB954;margin:0}
  .close-btn{background:none;border:none;color:#999;font-size:1.5rem;cursor:pointer;padding:0}
  .close-btn:hover{color:#fff}
  .auth-buttons{display:flex;gap:1rem;margin-top:2rem}
  .auth-toggle{text-align:center;margin-top:1rem;color:#999}
  .auth-toggle button{background:none;border:none;color:#1DB954;cursor:pointer;text-decoration:underline}
  </style>
</head>

<body>
  <header>
    <span class="logo">üéµ KLMZ MUSIC</span>
    <div class="user-section">
      <div id="userInfo" class="user-info">
        <span id="userName"></span>
        <button class="btn danger" onclick="logout()">Salir</button>
      </div>
      <div id="lockIcon" class="lock-icon" onclick="openAuthModal()">üîí</div>
    </div>
  </header>

  <main>
    <h1>√Ålbumes</h1>
    <div id="status" class="status info">üîÑ Inicializando conexi√≥n directa...</div>
    
    <div class="test-buttons">
      <button class="btn" onclick="testConnection()">üîç Probar Conexi√≥n</button>
      <button class="btn secondary" onclick="addTestAlbum()" id="addAlbumBtn">‚ûï Agregar √Ålbum de Prueba</button>
      <button class="btn secondary" onclick="loadAlbums()">üìÄ Cargar √Ålbumes</button>
      <button class="btn admin" onclick="toggleAdminPanel()" id="adminPanelBtn" style="display:none">üëë Panel Admin</button>
    </div>
    
    <!-- Panel de administraci√≥n -->
    <div id="adminPanel" class="admin-panel">
      <div class="admin-tabs">
        <button class="admin-tab active" onclick="switchAdminTab('albums')">üìÄ Crear √Ålbum</button>
        <button class="admin-tab" onclick="switchAdminTab('upload')">üì§ Subir Archivos</button>
        <button class="admin-tab" onclick="switchAdminTab('stats')">üìä Estad√≠sticas</button>
        <button class="admin-tab" onclick="switchAdminTab('settings')">‚öôÔ∏è Configuraci√≥n</button>
      </div>
      
      <!-- Tab: Crear √Ålbum -->
      <div id="adminTabAlbums" class="admin-content active">
        <h3>üéµ Crear Nuevo √Ålbum</h3>
        <form id="albumForm" onsubmit="createAlbumWithCover(event)">
          <div class="form-row">
            <div class="form-group">
              <label for="albumName">Nombre del √Ålbum: *</label>
              <input type="text" id="albumName" required placeholder="Ej: KLMZ Hits Vol. 1">
            </div>
            <div class="form-group">
              <label for="artistName">Artista: *</label>
              <input type="text" id="artistName" required placeholder="Ej: Freddy Granados">
            </div>
          </div>
          
          <div class="form-group">
            <label>Portada del √Ålbum: *</label>
            <div id="coverUpload" class="cover-upload" onclick="$('coverInput').click()">
              <div class="cover-upload-overlay">
                <img id="coverPreview" class="cover-preview" alt="Preview">
                <div id="coverUploadText">
                  <p>üì∏ Haz clic para subir portada</p>
                  <p style="color:#999;font-size:0.9rem;">JPG, PNG (m√°x. 5MB)</p>
                </div>
              </div>
            </div>
            <input type="file" id="coverInput" accept=".jpg,.jpeg,.png" style="display:none" onchange="handleCoverUpload(event)">
          </div>
          
          <button type="submit" class="btn admin" id="createAlbumBtn">‚ûï Crear √Ålbum</button>
        </form>
      </div>
      
      <!-- Tab: Subir Archivos -->
      <div id="adminTabUpload" class="admin-content">
        <h3>üì§ Subir Archivos de Audio</h3>
        <div class="file-upload" id="fileUpload">
          <p>üéµ Arrastra archivos de m√∫sica aqu√≠ o haz clic para seleccionar</p>
          <p style="color:#999;font-size:0.9rem;">Soporta: MP3, WAV, FLAC</p>
          <input type="file" id="fileInput" multiple accept=".mp3,.wav,.flac" style="display:none">
        </div>
        <div id="uploadProgress" style="display:none;margin-top:1rem;">
          <div style="background:#333;border-radius:8px;overflow:hidden;">
            <div id="progressBar" style="background:#1DB954;height:20px;width:0%;transition:width 0.3s;"></div>
          </div>
          <p id="uploadStatus" style="margin-top:0.5rem;text-align:center;"></p>
        </div>
      </div>
      
      <!-- Tab: Estad√≠sticas -->
      <div id="adminTabStats" class="admin-content">
        <h3>üìä Estad√≠sticas del Sistema</h3>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number" id="statAlbums">-</div>
            <div class="stat-label">√Ålbumes</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="statSongs">-</div>
            <div class="stat-label">Canciones</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="statStorage">-</div>
            <div class="stat-label">Archivos</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="statUsers">1</div>
            <div class="stat-label">Usuarios</div>
          </div>
        </div>
        <button class="btn" onclick="refreshStats()">üîÑ Actualizar Estad√≠sticas</button>
      </div>
      
      <!-- Tab: Configuraci√≥n -->
      <div id="adminTabSettings" class="admin-content">
        <h3>‚öôÔ∏è Configuraci√≥n del Sistema</h3>
        <div class="form-group">
          <label>Estado del Sistema:</label>
          <p style="color:#51cf66;">‚úÖ Todos los servicios funcionando correctamente</p>
        </div>
        <div class="form-group">
          <label>Informaci√≥n del Proyecto:</label>
          <p style="color:#999;font-family:monospace;font-size:0.9rem;">
            Project ID: 68ab0cf2000365979a71<br>
            Database ID: 68ab0d9b00124af501a5<br>
            Endpoint: https://nyc.cloud.appwrite.io/v1
          </p>
        </div>
        <button class="btn secondary" onclick="testAllServices()">üîç Probar Todos los Servicios</button>
        <button class="btn danger" onclick="clearAllData()" style="margin-left:1rem;">üóëÔ∏è Limpiar Datos de Prueba</button>
      </div>
    </div>
    
    <div id="albums" class="album-grid"></div>
  </main>

  <!-- Modal de autenticaci√≥n -->
  <div id="authModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle" class="modal-title">Iniciar Sesi√≥n</h2>
        <button class="close-btn" onclick="closeAuthModal()">&times;</button>
      </div>
      
      <form id="authForm" onsubmit="handleAuth(event)">
        <div class="form-group">
          <label for="email">Email:</label>
          <input type="email" id="email" required>
        </div>
        
        <div class="form-group">
          <label for="password">Contrase√±a:</label>
          <input type="password" id="password" required>
        </div>
        
        <div id="nameGroup" class="form-group" style="display:none">
          <label for="name">Nombre:</label>
          <input type="text" id="name">
        </div>
        
        <div class="auth-buttons">
          <button type="submit" class="btn" id="authSubmitBtn">Iniciar Sesi√≥n</button>
          <button type="button" class="btn secondary" onclick="closeAuthModal()">Cancelar</button>
        </div>
      </form>
      
      <div class="auth-toggle">
        <span id="toggleText">¬øNo tienes cuenta?</span>
        <button type="button" onclick="toggleAuthMode()" id="toggleBtn">Registrarse</button>
      </div>
    </div>
  </div>

  <script>
    // Configuraci√≥n
    const CONFIG = {
      endpoint: 'https://nyc.cloud.appwrite.io/v1',
      projectId: '68ab0cf2000365979a71',
      databaseId: '68ab0d9b00124af501a5',
      albumsCollectionId: '68ab0dd00024ddeb51fd',
      songsCollectionId: '68ab0f0e002d9f334b0d',
      bucketId: '68ab1101001cff947e6b'
    };

    const $ = id => document.getElementById(id);
    let isLoginMode = true;
    let currentUser = null;
    let isAdmin = false;
    let currentAlbums = [];
    let selectedCoverFile = null;

    function setStatus(message, type = 'info') {
      const emoji = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'admin' ? 'üëë' : 'üîÑ';
      $('status').innerHTML = `${emoji} ${message}`;
      $('status').className = `status ${type}`;
    }

    // Funci√≥n para verificar si el usuario es admin
    function checkUserAdmin(user) {
      if (user.labels) {
        if (Array.isArray(user.labels)) {
          return user.labels.includes('admin');
        } else if (typeof user.labels === 'object') {
          return user.labels.admin === true || user.labels.admin === 'true';
        }
      }
      const adminEmails = ['klmzr230@gmail.com'];
      return adminEmails.includes(user.email.toLowerCase());
    }

    // Cliente Appwrite extendido
    class SimpleAppwriteClient {
      constructor(endpoint, projectId) {
        this.endpoint = endpoint;
        this.projectId = projectId;
        this.headers = {
          'X-Appwrite-Project': projectId,
          'Content-Type': 'application/json'
        };
      }

      async request(method, path, params = {}) {
        let url = `${this.endpoint}${path}`;
        const options = {
          method,
          headers: { ...this.headers },
          credentials: 'include'
        };

        if (method === 'GET' && Object.keys(params).length > 0) {
          const queryString = new URLSearchParams(params).toString();
          url = `${url}?${queryString}`;
        } else if (method !== 'GET') {
          options.body = JSON.stringify(params);
        }

        const response = await fetch(url, options);
        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.message || `HTTP ${response.status}`);
        }

        return data;
      }

      async getAccount() {
        return this.request('GET', '/account');
      }

      async createUser(email, password, name) {
        return this.request('POST', '/account', {
          userId: 'unique()',
          email,
          password,
          name
        });
      }

      async createSession(email, password) {
        return this.request('POST', '/account/sessions/email', {
          email,
          password
        });
      }

      async deleteSession() {
        return this.request('DELETE', '/account/sessions/current');
      }

      async listDocuments(databaseId, collectionId, queries = []) {
        return this.request('GET', `/databases/${databaseId}/collections/${collectionId}/documents`, { queries });
      }

      async createDocument(databaseId, collectionId, documentId, data) {
        return this.request('POST', `/databases/${databaseId}/collections/${collectionId}/documents`, {
          documentId,
          data
        });
      }

      async deleteDocument(databaseId, collectionId, documentId) {
        return this.request('DELETE', `/databases/${databaseId}/collections/${collectionId}/documents/${documentId}`);
      }

      async createFile(bucketId, fileId, file) {
        const formData = new FormData();
        formData.append('fileId', fileId);
        formData.append('file', file);

        const options = {
          method: 'POST',
          headers: {
            'X-Appwrite-Project': this.projectId,
          },
          credentials: 'include',
          body: formData
        };

        const response = await fetch(`${this.endpoint}/storage/buckets/${bucketId}/files`, options);
        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.message || `HTTP ${response.status}`);
        }

        return data;
      }

      async listFiles(bucketId) {
        return this.request('GET', `/storage/buckets/${bucketId}/files`);
      }

      getFilePreview(bucketId, fileId, width = 300, height = 300) {
        return `${this.endpoint}/storage/buckets/${bucketId}/files/${fileId}/preview?width=${width}&height=${height}&project=${this.projectId}`;
      }
    }

    const client = new SimpleAppwriteClient(CONFIG.endpoint, CONFIG.projectId);

    // Manejar subida de portada
    function handleCoverUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      // Validar tama√±o
      if (file.size > 5 * 1024 * 1024) {
        setStatus('‚ùå La imagen debe ser menor a 5MB', 'error');
        return;
      }

      // Validar tipo
      if (!['image/jpeg', 'image/jpg', 'image/png'].includes(file.type)) {
        setStatus('‚ùå Solo se permiten im√°genes JPG y PNG', 'error');
        return;
      }

      selectedCoverFile = file;

      // Mostrar preview
      const reader = new FileReader();
      reader.onload = (e) => {
        const coverUpload = $('coverUpload');
        const coverPreview = $('coverPreview');
        const coverUploadText = $('coverUploadText');

        coverPreview.src = e.target.result;
        coverPreview.style.display = 'block';
        coverUploadText.innerHTML = `
          <p>‚úÖ ${file.name}</p>
          <p style="color:#1DB954;font-size:0.9rem;">Haz clic para cambiar</p>
        `;
        coverUpload.classList.add('has-image');
        coverUpload.style.backgroundImage = `url(${e.target.result})`;
      };
      reader.readAsDataURL(file);

      setStatus(`‚úÖ Portada seleccionada: ${file.name}`, 'success');
    }

    // Crear √°lbum con portada (SIN descripci√≥n)
    async function createAlbumWithCover(event) {
      event.preventDefault();
      
      if (!isAdmin) {
        setStatus('Solo los administradores pueden crear √°lbumes', 'error');
        return;
      }

      const name = $('albumName').value;
      const artist = $('artistName').value;

      if (!selectedCoverFile) {
        setStatus('‚ùå Debes subir una portada para el √°lbum', 'error');
        return;
      }

      setStatus('üëë Creando √°lbum...', 'admin');
      $('createAlbumBtn').disabled = true;
      $('createAlbumBtn').textContent = 'Creando...';

      try {
        // 1. Subir la portada primero
        setStatus('üì∏ Subiendo portada...', 'admin');
        const coverId = 'cover-' + Date.now();
        const coverFile = await client.createFile(CONFIG.bucketId, coverId, selectedCoverFile);
        
        // 2. Crear el √°lbum con la ID de la portada (SIN description)
        setStatus('üíΩ Creando √°lbum en la base de datos...', 'admin');
        const albumData = {
          name,
          artistName: artist,
          coverStorageId: coverFile.$id
        };

        await client.createDocument(
          CONFIG.databaseId,
          CONFIG.albumsCollectionId,
          'album-' + Date.now(),
          albumData
        );

        setStatus(`üëë ¬°√Ålbum "${name}" creado exitosamente!`, 'admin');
        
        // Limpiar formulario
        $('albumForm').reset();
        selectedCoverFile = null;
        $('coverPreview').style.display = 'none';
        $('coverUpload').classList.remove('has-image');
        $('coverUpload').style.backgroundImage = '';
        $('coverUploadText').innerHTML = `
          <p>üì∏ Haz clic para subir portada</p>
          <p style="color:#999;font-size:0.9rem;">JPG, PNG (m√°x. 5MB)</p>
        `;
        
        // Recargar √°lbumes
        setTimeout(loadAlbums, 1000);
        
      } catch (error) {
        console.error('Error:', error);
        setStatus(`‚ùå Error creando √°lbum: ${error.message}`, 'error');
      }

      $('createAlbumBtn').disabled = false;
      $('createAlbumBtn').textContent = '‚ûï Crear √Ålbum';
    }

    // Funciones de autenticaci√≥n
    function openAuthModal() {
      $('authModal').classList.add('show');
    }

    function closeAuthModal() {
      $('authModal').classList.remove('show');
      resetAuthForm();
    }

    function toggleAuthMode() {
      isLoginMode = !isLoginMode;
      
      if (isLoginMode) {
        $('modalTitle').textContent = 'Iniciar Sesi√≥n';
        $('authSubmitBtn').textContent = 'Iniciar Sesi√≥n';
        $('toggleText').textContent = '¬øNo tienes cuenta?';
        $('toggleBtn').textContent = 'Registrarse';
        $('nameGroup').style.display = 'none';
        $('name').required = false;
      } else {
        $('modalTitle').textContent = 'Crear Cuenta';
        $('authSubmitBtn').textContent = 'Registrarse';
        $('toggleText').textContent = '¬øYa tienes cuenta?';
        $('toggleBtn').textContent = 'Iniciar Sesi√≥n';
        $('nameGroup').style.display = 'block';
        $('name').required = true;
      }
    }

    function resetAuthForm() {
      $('authForm').reset();
      isLoginMode = true;
      toggleAuthMode();
      toggleAuthMode();
    }

    async function handleAuth(event) {
      event.preventDefault();
      
      const email = $('email').value;
      const password = $('password').value;
      const name = $('name').value;

      try {
        if (isLoginMode) {
          setStatus('Iniciando sesi√≥n...');
          await client.createSession(email, password);
          const user = await client.getAccount();
          
          currentUser = user;
          isAdmin = checkUserAdmin(user);
          
          updateUserInterface(user);
          closeAuthModal();
          
          if (isAdmin) {
            setStatus(`¬°Bienvenido ADMIN ${user.name}! Panel de administraci√≥n disponible.`, 'admin');
          } else {
            setStatus(`¬°Bienvenido, ${user.name}!`, 'success');
          }
          
        } else {
          setStatus('Creando cuenta...');
          await client.createUser(email, password, name);
          await client.createSession(email, password);
          const user = await client.getAccount();
          
          currentUser = user;
          isAdmin = checkUserAdmin(user);
          
          updateUserInterface(user);
          closeAuthModal();
          setStatus(`¬°Cuenta creada! Bienvenido, ${user.name}!`, 'success');
        }
        
      } catch (error) {
        console.error('Error de autenticaci√≥n:', error);
        setStatus(`Error: ${error.message}`, 'error');
      }
    }

    function updateUserInterface(user) {
      if (isAdmin) {
        $('lockIcon').textContent = 'üëë';
        $('lockIcon').classList.add('admin');
        $('userName').innerHTML = `${user.name}<span class="admin-badge">ADMIN</span>`;
        $('userInfo').classList.add('admin');
        $('adminPanelBtn').style.display = 'inline-block';
      } else {
        $('lockIcon').textContent = 'üë§';
        $('userName').textContent = user.name;
      }
      $('userInfo').style.display = 'flex';
    }

    async function logout() {
      try {
        setStatus('Cerrando sesi√≥n...');
        await client.deleteSession();
        
        currentUser = null;
        isAdmin = false;
        $('lockIcon').textContent = 'üîí';
        $('lockIcon').classList.remove('admin');
        $('userInfo').style.display = 'none';
        $('userInfo').classList.remove('admin');
        $('adminPanelBtn').style.display = 'none';
        $('adminPanel').classList.remove('show');
        setStatus('Sesi√≥n cerrada correctamente', 'success');
        
      } catch (error) {
        console.error('Error al cerrar sesi√≥n:', error);
        setStatus(`Error cerrando sesi√≥n: ${error.message}`, 'error');
      }
    }

    async function testConnection() {
      setStatus('Probando conexi√≥n...');
      
      try {
        const user = await client.getAccount();
        currentUser = user;
        isAdmin = checkUserAdmin(user);
        
        updateUserInterface(user);
        
        if (isAdmin) {
          setStatus(`‚úÖ Conectado como ADMINISTRADOR: ${user.name}`, 'admin');
        } else {
          setStatus(`‚úÖ Conectado como usuario: ${user.name}`, 'success');
        }
      } catch (error) {
        if (error.message.includes('401') || 
            error.message.includes('missing scope') || 
            error.message.includes('guests') ||
            error.message.includes('Unauthorized')) {
          setStatus('‚úÖ Conectado como visitante - CORS OK', 'success');
        } else {
          setStatus(`‚ùå Error: ${error.message}`, 'error');
        }
      }
    }

    async function loadAlbums() {
      setStatus('Cargando √°lbumes...');
      
      try {
        const response = await client.listDocuments(CONFIG.databaseId, CONFIG.albumsCollectionId);
        currentAlbums = response.documents;
        
        if (response.documents.length === 0) {
          $('albums').innerHTML = `
            <div class="empty-state">
              <h2>üéµ Conexi√≥n exitosa</h2>
              <p>No hay √°lbumes en la base de datos.<br>Usa el panel admin para crear √°lbumes con portadas.</p>
            </div>
          `;
          setStatus('‚úÖ Conexi√≥n exitosa - Base de datos vac√≠a', 'success');
        } else {
          displayAlbums(response.documents);
          setStatus(`‚úÖ ${response.documents.length} √°lbum(es) cargados`, 'success');
        }
        
      } catch (error) {
        console.error('Error:', error);
        let errorMsg = error.message;
        
        if (error.message.includes('401')) {
          errorMsg = 'Sin permisos de lectura. Configura permisos p√∫blicos en la Collection.';
        } else if (error.message.includes('404')) {
          errorMsg = 'Collection no encontrada. Verifica los IDs de configuraci√≥n.';
        }
        
        setStatus(`‚ùå ${errorMsg}`, 'error');
      }
    }

    async function addTestAlbum() {
      if (!currentUser) {
        setStatus('Debes iniciar sesi√≥n para agregar √°lbumes', 'error');
        openAuthModal();
        return;
      }

      setStatus('Agregando √°lbum de prueba...');
      
      try {
        const albumData = {
          name: `√Ålbum ${isAdmin ? 'ADMIN' : 'Usuario'} - ${new Date().toLocaleTimeString()}`,
          artistName: isAdmin ? 'Admin Freddy' : 'Usuario Demo',
          coverStorageId: 'test-cover-' + Date.now()
        };

        await client.createDocument(
          CONFIG.databaseId,
          CONFIG.albumsCollectionId,
          'album-' + Date.now(),
          albumData
        );

        if (isAdmin) {
          setStatus('üëë √Ålbum agregado por ADMINISTRADOR', 'admin');
        } else {
          setStatus('‚úÖ √Ålbum agregado correctamente', 'success');
        }
        
        setTimeout(loadAlbums, 1000);
        
      } catch (error) {
        console.error('Error:', error);
        setStatus(`‚ùå ${error.message}`, 'error');
      }
    }

    // Funciones del Panel de Administraci√≥n
    function toggleAdminPanel() {
      if (!isAdmin) return;
      
      const panel = $('adminPanel');
      if (panel.classList.contains('show')) {
        panel.classList.remove('show');
      } else {
        panel.classList.add('show');
        refreshStats();
      }
    }

    function switchAdminTab(tabName) {
      document.querySelectorAll('.admin-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.admin-content').forEach(content => content.classList.remove('active'));
      
      document.querySelector(`[onclick="switchAdminTab('${tabName}')"]`).classList.add('active');
      $(`adminTab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.add('active');
    }

    async function deleteAlbum(albumId, albumName) {
      if (!isAdmin) return;
      
      if (!confirm(`¬øEst√°s seguro de eliminar el √°lbum "${albumName}"?`)) return;

      setStatus('Eliminando √°lbum...');

      try {
        await client.deleteDocument(CONFIG.databaseId, CONFIG.albumsCollectionId, albumId);
        setStatus(`üëë √Ålbum "${albumName}" eliminado`, 'admin');
        setTimeout(loadAlbums, 500);
      } catch (error) {
        console.error('Error:', error);
        setStatus(`‚ùå Error eliminando √°lbum: ${error.message}`, 'error');
      }
    }

    async function refreshStats() {
      if (!isAdmin) return;

      try {
        const albums = await client.listDocuments(CONFIG.databaseId, CONFIG.albumsCollectionId);
        const songs = await client.listDocuments(CONFIG.databaseId, CONFIG.songsCollectionId);
        const files = await client.listFiles(CONFIG.bucketId);

        $('statAlbums').textContent = albums.total || albums.documents.length;
        $('statSongs').textContent = songs.total || songs.documents.length;
        $('statStorage').textContent = files.total || files.files?.length || 0;

      } catch (error) {
        console.log('Error obteniendo estad√≠sticas:', error);
        $('statAlbums').textContent = currentAlbums.length;
        $('statSongs').textContent = '0';
        $('statStorage').textContent = '0';
      }
    }

    async function testAllServices() {
      if (!isAdmin) return;
      
      setStatus('üëë Probando todos los servicios...', 'admin');
      
      try {
        await client.getAccount();
        console.log('‚úÖ Account service OK');
        
        await client.listDocuments(CONFIG.databaseId, CONFIG.albumsCollectionId);
        console.log('‚úÖ Database service OK');
        
        await client.listFiles(CONFIG.bucketId);
        console.log('‚úÖ Storage service OK');
        
        setStatus('üëë Todos los servicios funcionan correctamente', 'admin');
        
      } catch (error) {
        setStatus(`‚ùå Error en servicios: ${error.message}`, 'error');
      }
    }

    async function clearAllData() {
      if (!isAdmin) return;
      
      if (!confirm('‚ö†Ô∏è PELIGRO: ¬øEliminar TODOS los √°lbumes de prueba? Esta acci√≥n no se puede deshacer.')) return;

      setStatus('üóëÔ∏è Eliminando datos de prueba...');

      try {
        const response = await client.listDocuments(CONFIG.databaseId, CONFIG.albumsCollectionId);
        let deleted = 0;
        
        for (const album of response.documents) {
          if (album.name.includes('Prueba') || album.name.includes('Demo') || album.name.includes('Test') || album.name.includes('ADMIN')) {
            await client.deleteDocument(CONFIG.databaseId, CONFIG.albumsCollectionId, album.$id);
            deleted++;
          }
        }
        
        setStatus(`üëë ${deleted} √°lbum(es) de prueba eliminados`, 'admin');
        setTimeout(loadAlbums, 1000);
        
      } catch (error) {
        setStatus(`‚ùå Error limpiando datos: ${error.message}`, 'error');
      }
    }

    // Setup file upload para archivos de audio
    document.addEventListener('DOMContentLoaded', () => {
      const fileUpload = $('fileUpload');
      const fileInput = $('fileInput');
      
      fileUpload.addEventListener('click', () => fileInput.click());
      
      fileUpload.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileUpload.classList.add('dragover');
      });
      
      fileUpload.addEventListener('dragleave', () => {
        fileUpload.classList.remove('dragover');
      });
      
      fileUpload.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUpload.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
      });
      
      fileInput.addEventListener('change', (e) => {
        handleFiles(e.target.files);
      });
    });

    async function handleFiles(files) {
      if (!isAdmin) {
        setStatus('Solo los administradores pueden subir archivos', 'error');
        return;
      }

      const uploadProgress = $('uploadProgress');
      const progressBar = $('progressBar');
      const uploadStatus = $('uploadStatus');
      
      uploadProgress.style.display = 'block';
      
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const progress = ((i + 1) / files.length) * 100;
        
        progressBar.style.width = progress + '%';
        uploadStatus.textContent = `Subiendo ${file.name} (${i + 1}/${files.length})...`;
        
        try {
          const fileId = 'upload-' + Date.now() + '-' + i;
          await client.createFile(CONFIG.bucketId, fileId, file);
          console.log(`‚úÖ Archivo ${file.name} subido`);
        } catch (error) {
          console.error(`‚ùå Error subiendo ${file.name}:`, error);
        }
      }
      
      uploadStatus.textContent = `‚úÖ ${files.length} archivo(s) subido(s) correctamente`;
      setStatus(`üëë ${files.length} archivo(s) subido(s) al Storage`, 'admin');
      
      setTimeout(() => {
        uploadProgress.style.display = 'none';
        progressBar.style.width = '0%';
      }, 3000);
    }

    function displayAlbums(albums) {
      $('albums').innerHTML = albums.map((album, index) => {
        let coverUrl;
        try {
          coverUrl = client.getFilePreview(CONFIG.bucketId, album.coverStorageId);
        } catch (error) {
          coverUrl = '';
        }

        return `
          <div class="album-card">
            ${isAdmin ? `
              <div class="album-actions">
                <button class="btn danger small" onclick="deleteAlbum('${album.$id}', '${album.name}')" title="Eliminar">üóëÔ∏è</button>
              </div>
            ` : ''}
            <div style="width:140px;height:140px;border-radius:12px;margin:0 auto 1rem;overflow:hidden;">
              ${coverUrl ? 
                `<img src="${coverUrl}" alt="${album.name}" style="width:100%;height:100%;object-fit:cover;">` :
                `<div style="width:100%;height:100%;background:linear-gradient(135deg, #1DB954, #1ed760);display:flex;align-items:center;justify-content:center;font-size:3rem;color:white;text-shadow:0 2px 4px rgba(0,0,0,0.3);">üéµ</div>`
              }
            </div>
            <h3 style="margin:0.5rem 0;font-size:1.1rem;">${album.name}</h3>
            <p style="color:#999;margin:0;font-size:0.9rem;">${album.artistName}</p>
            <p style="color:#666;font-size:0.8rem;margin-top:0.5rem;">ID: ${album.$id.slice(-8)}</p>
          </div>
        `;
      }).join('');
    }

    // Auto-test al cargar
    document.addEventListener('DOMContentLoaded', () => {
      setStatus('P√°gina cargada - Probando conexi√≥n autom√°ticamente...');
      setTimeout(testConnection, 500);
    });

    // Cerrar modal al hacer clic fuera
    window.addEventListener('click', (event) => {
      if (event.target === $('authModal')) {
        closeAuthModal();
      }
    });
  </script>
</body>
</html>
