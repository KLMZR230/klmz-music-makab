<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KLMZ MUSIC</title>
<meta name="description" content="KLMZ MUSIC - Tu plataforma de m√∫sica personal" />
<meta name="theme-color" content="#1db954" />
<link rel="manifest" href="manifest.json">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{
    --bg:#0a0a0a;
    --panel:#181818;
    --panel2:#1f1f1f;
    --text:#fff;
    --muted:#b3b3b3;
    --brand:#1db954;
    --brand-hover:#1ed760;
    --stroke:#2a2a2a;
    --accent:#ff6b35;
    --error:#ff4444;
    --warning:#ffab00;
    --success:#4caf50;
    
    /* Variables m√≥viles con iconos m√°s grandes */
    --mobile-header-height: 35px;
    --mobile-player-height: 45px;
    --mobile-bottom-bar-height: 35px;
    --mobile-padding: 8px;
    --album-icon-size: 75px;
    --album-card-height: 115px;
  }
  
  *{box-sizing:border-box;-webkit-tap-highlight-color: transparent;}
  
  body{
    margin:0;
    background: radial-gradient(ellipse at center, #0f0f0f 0%, var(--bg) 100%);
    color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
    padding-bottom:var(--mobile-bottom-bar-height);
    overflow-x:hidden;
    line-height:1.6;
    overflow: auto;
    -webkit-overflow-scrolling: touch;
    font-size: 13px;
  }
  
  /* Animaciones */
  @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
  @keyframes slideUp{from{transform:translateY(30px);opacity:0}to{transform:translateY(0);opacity:1}}
  @keyframes slideDown{from{transform:translateY(0);opacity:1}to{transform:translateY(100px);opacity:0}}
  @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
  @keyframes bounce{0%,20%,50%,80%,100%{transform:translateY(0)}40%{transform:translateY(-10px)}60%{transform:translateY(-5px)}}
  @keyframes skeleton-loading{0%{background-position:200% 0}100%{background-position:-200% 0}}
  
  .fade-in{animation:fadeIn 0.4s ease}
  .slide-up{animation:slideUp 0.3s ease}
  .slide-down{animation:slideDown 0.3s ease}
  .bounce{animation:bounce 0.8s ease}
  
  .loading{
    position:fixed;
    inset:0;
    background:linear-gradient(135deg, var(--bg), #0f0f0f);
    display:flex;
    align-items:center;
    justify-content:center;
    flex-direction:column;
    z-index:9999;
  }
  
  .loading .spinner{
    width:40px;
    height:40px;
    border:3px solid transparent;
    border-top:3px solid var(--brand);
    border-radius:50%;
    animation:spin 1s linear infinite;
  }
  
  .loading .text{
    margin-top:16px;
    color:var(--muted);
    font-weight:600;
    font-size:14px;
  }
  
  /* Toast notifications */
  .toast-notification {
    position: fixed;
    bottom: 50px;
    right: 12px;
    background: rgba(0,0,0,0.9);
    color: white;
    padding: 10px 14px;
    border-radius: 12px;
    font-weight: 600;
    transform: translateX(400px);
    transition: all 0.4s ease;
    z-index: 1000;
    font-size: 11px;
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255,255,255,0.1);
  }
  
  .toast-notification.show {
    transform: translateX(0);
  }
  
  .toast-notification.success {
    border-left: 3px solid var(--success);
  }
  
  .toast-notification.error {
    border-left: 3px solid var(--error);
  }
  
  .toast-notification.info {
    border-left: 3px solid var(--brand);
  }
  
  /* Header */
  header{
    position:sticky;
    top:0;
    z-index:10;
    background:linear-gradient(135deg, #1db954 0%, #1ed760 50%, #1aa34a 100%);
    padding:8px 16px;
    font-weight:800;
    height:var(--mobile-header-height);
  }
  
  header .row{
    display:flex;
    align-items:center;
    gap:10px;
    justify-content:space-between;
    height:100%;
  }
  
  .brand{
    font-size:16px;
    display:flex;
    align-items:center;
    gap:6px;
  }
  
  .brand .logo{
    width:22px;
    height:22px;
    border-radius:8px;
    background:linear-gradient(135deg,#ff6b35,#ff4500);
    display:grid;
    place-items:center;
    font-weight:900;
    color:#fff;
    font-size:14px;
  }
  
  .tools{
    display:flex;
    gap:8px;
    align-items:center;
  }
  
  /* Botones */
  .btn{
    background:linear-gradient(135deg, #1db954, #1ed760);
    border:none;
    color:#fff;
    padding:6px 12px;
    border-radius:8px;
    cursor:pointer;
    font-weight:600;
    font-size:10px;
    transition:all 0.3s ease;
  }
  
  .btn:hover{
    background:linear-gradient(135deg, #1ed760, #17c653);
    transform:translateY(-1px);
  }
  
  .btn.ghost{
    background:rgba(255,255,255,0.1);
    border:1px solid rgba(255,255,255,0.2);
  }
  
  .btn.ghost:hover{
    background:rgba(255,255,255,0.2);
  }
  
  .btn.small{padding:4px 8px;font-size:9px}
  .btn.danger{background:linear-gradient(135deg, var(--error), #cc0000)}
  
  .icon-btn{
    background:rgba(255,255,255,0.1);
    border:1px solid rgba(255,255,255,0.2);
    color:#fff;
    padding:6px 8px;
    border-radius:8px;
    cursor:pointer;
    font-size:12px;
    transition:all 0.3s ease;
  }
  
  /* Bot√≥n de regresar */
  .back-btn{
    background:rgba(255,255,255,0.1);
    border:1px solid rgba(255,255,255,0.2);
    color:#fff;
    width:32px;
    height:32px;
    border-radius:8px;
    font-size:14px;
    display:grid;
    place-items:center;
    cursor:pointer;
    transition:all 0.3s ease;
    backdrop-filter:blur(10px);
  }
  
  .back-btn:hover{
    background:rgba(255,255,255,0.2);
    transform:scale(1.05);
    box-shadow:0 3px 12px rgba(255,255,255,0.2);
  }
  
  .backline{
    display:flex;
    align-items:center;
    gap:12px;
    margin-bottom:16px;
  }
  
  .container{
    padding:var(--mobile-padding);
    max-width:1200px;
    margin:auto;
  }
  
  /* Grid */
  .grid{display:grid;gap:10px}
  
  .grid.albums{
    grid-template-columns:repeat(5,1fr);
    gap:10px;
    max-height:calc(4 * var(--album-card-height) + 3 * 10px);
    overflow:hidden;
  }
  
  /* √Ålbumes con iconos grandes */
  .album-card{
    background:linear-gradient(145deg, #1f1f23, #16161a);
    border:1px solid rgba(255, 255, 255, 0.05);
    padding:12px;
    cursor:pointer;
    text-align:center;
    transition:all 0.3s ease;
    border-radius:16px;
    height:var(--album-card-height);
  }
  
  .album-card:hover{
    transform:translateY(-8px) scale(1.05);
    box-shadow:0 12px 30px rgba(0, 0, 0, 0.4);
    border-color:rgba(29, 185, 84, 0.3);
  }
  
  .album-cover{
    width:100%;
    aspect-ratio:1/1;
    object-fit:cover;
    background:#0b0b0b;
    border:3px solid rgba(255,255,255,0.1);
    transition:all 0.3s ease;
    border-radius:50%;
    max-width:var(--album-icon-size);
    max-height:var(--album-icon-size);
    box-shadow:0 8px 25px rgba(0, 0, 0, 0.4);
  }
  
  .album-cover:hover{
    transform:scale(1.1);
    border-color:rgba(29, 185, 84, 0.6);
  }
  
  .album-title{
    margin:8px 0 4px;
    font-weight:700;
    font-size:12px;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }
  
  .album-meta{
    color:var(--muted);
    font-size:10px;
    font-weight:500;
  }
  
  /* Skeleton loading */
  .album-skeleton {
    background: linear-gradient(90deg, #2a2a2a 25%, #3a3a3a 50%, #2a2a2a 75%);
    background-size: 200% 100%;
    animation: skeleton-loading 1.5s infinite;
    border-radius: 50%;
    aspect-ratio: 1/1;
  }
  
  .section-title{
    margin:4px 0 10px;
    font-size:18px;
    font-weight:900;
    background:linear-gradient(135deg, var(--brand), var(--accent));
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    background-clip:text;
  }
  
  .muted{color:var(--muted)}
  
  /* Player SIN barra de tiempo */
  .player{
    position:fixed;
    left:0;
    right:0;
    bottom:var(--mobile-bottom-bar-height);
    background:linear-gradient(135deg, #1f1f1f 0%, #2a2a2a 100%);
    border-top:2px solid rgba(29, 185, 84, 0.3);
    padding:6px 10px;
    z-index:20;
    display:none;
    height:var(--mobile-player-height);
    cursor:pointer;
  }
  
  .player.show{
    display:flex;
    align-items:center;
    gap:8px;
  }
  
  .np{
    display:flex;
    align-items:center;
    gap:8px;
    flex:1;
    min-width:0;
  }
  
  .np img{
    width:32px;
    height:32px;
    border-radius:8px;
    object-fit:cover;
    background:#0b0b0b;
  }
  
  .np .titles{flex:1;min-width:0}
  
  .np .titles .t{
    font-weight:700;
    font-size:11px;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }
  
  .np .titles .a{
    color:var(--muted);
    font-size:9px;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }
  
  .player-controls{
    display:flex;
    align-items:center;
    gap:6px;
  }
  
  .player-controls .circle{
    width:28px;
    height:28px;
    border-radius:50%;
    display:grid;
    place-items:center;
    background:linear-gradient(135deg, #2a2a2a, #3a3a3a);
    font-size:11px;
    font-weight:900;
    cursor:pointer;
    transition:all 0.3s ease;
    border:2px solid rgba(255,255,255,0.2);
  }
  
  .player-controls .circle:hover{
    background:linear-gradient(135deg, var(--brand), var(--brand-hover));
    border-color:var(--brand);
  }
  
  .player-controls .sm{width:24px;height:24px;font-size:9px}
  
  .vol{
    display:flex;
    align-items:center;
    gap:4px;
    min-width:40px;
  }
  
  .vol span{
    font-size:9px;
    color:var(--muted);
  }
  
  .vol input[type="range"]{
    width:30px;
    height:3px;
    -webkit-appearance:none;
    background:rgba(255,255,255,0.2);
    border-radius:2px;
    outline:none;
  }
  
  .vol input[type="range"]::-webkit-slider-thumb{
    -webkit-appearance:none;
    width:8px;
    height:8px;
    background:var(--brand);
    border-radius:50%;
  }
  
  /* Bottom Bar */
  #bottomBar{
    position:fixed;
    bottom:0;
    left:0;
    width:100%;
    height:var(--mobile-bottom-bar-height);
    background:linear-gradient(135deg, var(--panel2) 0%, #252525 100%);
    border-top:1px solid rgba(29, 185, 84, 0.2);
    display:grid;
    grid-template-columns:1fr 1fr 1fr 1fr;
    place-items:center;
    z-index:40;
  }
  
  #bottomBar button{
    background:transparent;
    border:none;
    color:var(--muted);
    cursor:pointer;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:2px;
    font-size:7px;
    font-weight:600;
    padding:4px;
    border-radius:8px;
    transition:all 0.3s ease;
  }
  
  #bottomBar button.active,#bottomBar button:hover{
    color:var(--brand);
    background:rgba(29, 185, 84, 0.1);
  }
  
  #bottomBar .icon{
    width:16px;
    height:16px;
    stroke:currentColor;
    stroke-width:2.5;
    fill:none;
  }
  
  /* Now Playing Overlay */
  #npOverlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.95);
    backdrop-filter:blur(30px);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:40;
  }
  
  #npCard{
    background:linear-gradient(145deg, #111 0%, #222 50%, #111 100%);
    border:2px solid rgba(29, 185, 84, 0.3);
    border-radius:20px;
    width:min(350px,90vw);
    padding:20px;
    display:grid;
    gap:16px;
    justify-items:center;
  }
  
  #npCard img{
    width:min(240px,70vw);
    height:min(240px,70vw);
    border-radius:16px;
    object-fit:cover;
    background:#0b0b0b;
    cursor:pointer;
    touch-action:manipulation;
  }
  
  #npCard .t{
    font-size:18px;
    font-weight:900;
    text-align:center;
    background:linear-gradient(135deg, var(--brand), var(--accent));
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    background-clip:text;
  }
  
  #npCard .a{
    color:var(--muted);
    text-align:center;
    font-size:14px;
  }
  
  .controls{
    display:flex;
    flex-direction:column;
    gap:16px;
    width:100%;
  }
  
  .controls .buttons{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:16px;
  }
  
  .controls .buttons .circle{
    width:50px;
    height:50px;
    border-radius:50%;
    display:grid;
    place-items:center;
    background:linear-gradient(135deg, #222, #333);
    font-size:20px;
    font-weight:900;
    cursor:pointer;
    transition:all 0.3s ease;
    border:2px solid rgba(255,255,255,0.2);
  }
  
  .controls .buttons .circle:hover{
    background:linear-gradient(135deg, var(--brand), var(--brand-hover));
    border-color:var(--brand);
  }
  
  .controls .buttons .sm{width:40px;height:40px;font-size:16px}
  
  .controls .seek{
    display:flex;
    align-items:center;
    gap:12px;
  }
  
  .controls input[type="range"]{
    width:100%;
    height:6px;
    -webkit-appearance:none;
    background:rgba(255,255,255,0.2);
    border-radius:3px;
    outline:none;
  }
  
  .controls input[type="range"]::-webkit-slider-thumb{
    -webkit-appearance:none;
    width:16px;
    height:16px;
    background:var(--brand);
    border-radius:50%;
  }
  
  .no-results{
    text-align:center;
    color:var(--muted);
    padding:40px 20px;
  }
  
  /* Inputs */
  input[type="text"],input[type="email"],input[type="password"],select{
    width:100%;
    padding:8px 12px;
    border-radius:8px;
    border:1px solid rgba(255,255,255,0.1);
    background:rgba(255,255,255,0.05);
    color:#fff;
    font-size:12px;
  }
  
  input:focus,select:focus{
    outline:none;
    border-color:var(--brand);
  }
  
  .stack{display:grid;gap:12px}
  .row{display:flex;gap:8px;align-items:center}
  .card{
    background:rgba(255, 255, 255, 0.05);
    border:1px solid rgba(255, 255, 255, 0.1);
    border-radius:16px;
    padding:16px;
  }
  
  /* Expansi√≥n de √°lbum SIN espacio negro - CON SCROLL PARA TODAS LAS CANCIONES */
  .album-expansion {
    grid-column: 1 / -1;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    padding: 16px;
    margin: 12px 0 0 0;
    animation: slideUp 0.3s ease;
    max-height: 70vh;
    overflow-y: auto;
  }
  
  .album-expansion.slide-down {
    animation: slideDown 0.3s ease;
  }
  
  /* Lista de canciones con scroll */
  .songs-list-container {
    max-height: 50vh;
    overflow-y: auto;
    overflow-x: hidden;
  }
  
  .song-plain-item{
    padding:8px;
    border-radius:8px;
    cursor:pointer;
    transition:all 0.3s ease;
    margin-bottom:2px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }
  
  .song-plain-item:last-child{
    border-bottom: none;
  }
  
  .song-plain-item:hover{
    background:rgba(29, 185, 84, 0.1);
    transform: translateX(4px);
  }
  
  .favorite-btn{
    background:none;
    border:none;
    color:var(--muted);
    cursor:pointer;
    font-size:16px;
    padding:4px;
    border-radius:50%;
    transition:all 0.3s ease;
  }
  
  .favorite-btn:hover{
    color:#ff4444;
    background:rgba(255, 68, 68, 0.1);
  }
  
  #albumView,#favoritesView,#downloadsView,#playlistsView,#playlistView,#searchView{display:none}
  
  .tag{
    padding:4px 8px;
    border:1px solid rgba(255,255,255,0.2);
    border-radius:8px;
    font-size:9px;
    color:var(--muted);
    background:rgba(255,255,255,0.05);
  }
  
  @media (max-width: 320px) {
    .grid.albums {
      grid-template-columns: repeat(4, 1fr);
    }
  }
</style>
</head>

<body>
<div id="loadingScreen" class="loading">
  <div class="spinner"></div>
  <div class="text">Cargando KLMZ MUSIC...</div>
</div>

<header>
  <div class="row">
    <div class="brand">
      <span class="logo">üî•</span> 
      KLMZ MUSIC
    </div>
    <div class="tools">
      <span class="muted" style="font-size: 11px;">Tu m√∫sica</span>
      <button class="icon-btn" onclick="showLogin()">üîë</button>
      <button class="btn ghost" id="btn-logout" style="display:none" onclick="logout()">Salir</button>
    </div>
  </div>
</header>

<div class="container">
  <div class="row muted" style="margin-bottom:16px;">
    <span class="tag">Cat√°logo p√∫blico</span>
    <span id="adminTag" class="tag" style="display:none;background:var(--brand);color:white;">Admin</span>
    <span id="userTag" class="tag" style="display:none;background:var(--accent);color:white;">Usuario</span>
  </div>

  <div id="homeContent">
    <div class="section-title">Albums</div>
    <div id="albumsGrid" class="grid albums"></div>
    <div id="emptyAlbums" class="no-results" style="display:none">
      <div style="font-size:48px;margin-bottom:16px">üéµ</div>
      <div>No hay √°lbumes todav√≠a</div>
    </div>
  </div>
</div>

<!-- Player SIN barra de tiempo -->
<div class="player" id="player" onclick="openNowPlaying()">
  <div class="np">
    <img id="npCover" alt="cover">
    <div class="titles">
      <div id="npTitle" class="t">Cargando...</div>
      <div id="npAlbum" class="a">‚Äî</div>
    </div>
  </div>
  <div class="player-controls">
    <button class="circle sm" onclick="event.stopPropagation(); prevTrack()">‚èÆ</button>
    <button class="circle" id="playBtn" onclick="event.stopPropagation(); togglePlay()">‚ñ∂</button>
    <button class="circle sm" onclick="event.stopPropagation(); nextTrack()">‚è≠</button>
  </div>
  <div class="vol">
    <span>üîä</span>
    <input id="vol" type="range" min="0" max="1" step="0.01" value="1" oninput="setVolume(this.value)" onclick="event.stopPropagation()" />
  </div>
  <audio id="audio" preload="none" crossorigin="anonymous"></audio>
</div>

<!-- Now Playing Overlay -->
<div id="npOverlay" onclick="closeNowPlaying()">
  <div id="npCard" onclick="event.stopPropagation()">
    <img id="npBigCover" alt="cover">
    <div class="t" id="npBigTitle">‚Äî</div>
    <div class="a" id="npBigAlbum">‚Äî</div>
    
    <div class="controls">
      <div class="buttons">
        <button class="circle sm" onclick="prevTrack()">‚èÆ</button>
        <button class="circle" onclick="togglePlay()" id="playBtnBig">‚ñ∂</button>
        <button class="circle sm" onclick="nextTrack()">‚è≠</button>
      </div>
      <div class="seek">
        <span id="curTimeBig" class="muted">0:00</span>
        <input id="seekBig" type="range" min="0" max="100" value="0" oninput="seekAudio(this.value)" />
        <span id="durTimeBig" class="muted">0:00</span>
      </div>
    </div>
  </div>
</div>

<!-- Bottom Bar -->
<div id="bottomBar">
  <button id="btn-home" onclick="goHome()" class="active">
    <svg class="icon" viewBox="0 0 24 24"><path d="M3 11L12 2l9 9v9a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2v-5H9v5a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-9z"/></svg>
    <span>Inicio</span>
  </button>
  <button id="btn-search" onclick="showSearch()">
    <svg class="icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="7"/><line x1="16.5" y1="16.5" x2="21" y2="21"/></svg>
    <span>Buscar</span>
  </button>
  <button id="btn-playlists" onclick="showPlaylists()">
    <svg class="icon" viewBox="0 0 24 24"><path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/></svg>
    <span>Playlists</span>
  </button>
  <button id="btn-account" onclick="showAccount()">
    <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="7" r="4"/><path d="M5.5 21a7.5 7.5 0 0 1 13 0"/></svg>
    <span>Cuenta</span>
  </button>
</div>

<div id="loginModal" class="card" style="display:none;position:fixed;inset:0;margin:auto;max-width:350px;height:max-content;z-index:50">
  <div class="stack">
    <div class="section-title">Iniciar sesi√≥n</div>
    <input id="email" type="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Contrase√±a" />
    <div class="row">
      <button class="btn" onclick="login()">Entrar</button>
      <button class="btn ghost" onclick="hideLogin()">Cancelar</button>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL = "https://nqbldvpnqhngdtalvzov.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xYmxkdnBucWhuZ2R0YWx2em92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyMjY0NjUsImV4cCI6MjA3MDgwMjQ2NX0.Zzg5D219sW7bhvl0_R5ypX9MF6nRzBSDIeo2Lvebab0";
const ADMIN_EMAIL = "klmzr@gmail.com";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let isAdmin = false, isLoggedIn = false, currentUser = null;
let albums = [], songsByAlbum = {}, flatSongs = [];
let queue = [], qIndex = -1, currentAlbum = null;
let touchStartY = 0, touchEndY = 0;

function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = `toast-notification ${type}`;
  toast.textContent = message;
  
  document.body.appendChild(toast);
  setTimeout(() => toast.classList.add('show'), 100);
  
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => {
      if (document.body.contains(toast)) {
        document.body.removeChild(toast);
      }
    }, 300);
  }, 2000);
}

function showSkeletonLoading() {
  const albumsGrid = document.getElementById("albumsGrid");
  if (!albumsGrid) return;
  
  albumsGrid.innerHTML = '';
  for (let i = 0; i < 20; i++) {
    const skeleton = document.createElement('div');
    skeleton.className = 'album-card';
    skeleton.innerHTML = `
      <div class="album-skeleton"></div>
      <div class="album-title">Loading...</div>
      <div class="album-meta">Loading...</div>
    `;
    albumsGrid.appendChild(skeleton);
  }
}

async function refreshCatalog() {
  console.log('üîÑ Cargando cat√°logo...');
  showSkeletonLoading();
  
  try {
    const { data: alb, error: e1 } = await sb
      .from("albums")
      .select("*")
      .order("created_at", {ascending: false})
      .limit(20);
    
    if (e1) { 
      console.error('‚ùå Error:', e1); 
      showToast('Error cargando √°lbumes', 'error'); 
      return; 
    }
    
    albums = alb || [];
    console.log('‚úÖ √Ålbumes:', albums.length);
    
    songsByAlbum = {};
    flatSongs = [];
    
    for (const album of albums) {
      try {
        const { data: ss, error: e2 } = await sb
          .from("songs")
          .select("*")
          .eq("album_id", album.id)
          .order("created_at", {ascending: true});
        
        if (!e2 && ss) {
          songsByAlbum[album.id] = ss;
          console.log(`üéµ √Ålbum "${album.title}": ${ss.length} canciones`);
          
          for (const song of ss) {
            flatSongs.push({...song, album_title: album.title, cover_url: album.cover_url});
          }
        } else {
          songsByAlbum[album.id] = [];
          console.error('‚ùå Error cargando canciones para √°lbum:', album.title, e2);
        }
      } catch (error) {
        console.error('‚ùå Error procesando √°lbum:', album.title, error);
        songsByAlbum[album.id] = [];
      }
    }
    
    console.log('üéµ Total canciones cargadas:', flatSongs.length);
    renderAlbums();
    showToast('Cat√°logo cargado', 'success');
    
  } catch (error) {
    console.error('‚ùå Error general:', error);
    showToast('Error cargando cat√°logo', 'error');
  }
}

function renderAlbums(list = albums) {
  const albumsGrid = document.getElementById("albumsGrid");
  const emptyAlbums = document.getElementById("emptyAlbums");
  
  if (!albumsGrid) return;
  
  albumsGrid.innerHTML = "";
  
  if (list.length === 0) {
    if (emptyAlbums) emptyAlbums.style.display = 'block';
    return;
  }
  
  if (emptyAlbums) emptyAlbums.style.display = 'none';
  
  list.slice(0, 20).forEach((album, index) => {
    const count = (songsByAlbum[album.id]?.length || 0);
    const card = document.createElement("div");
    card.className = "album-card slide-up";
    card.style.animationDelay = `${index * 0.05}s`;
    
    card.innerHTML = `
      <img class="album-cover" src="${album.cover_url || ''}" alt="${album.title}" 
           onerror="this.style.background='var(--panel)'; this.innerHTML='üéµ'; this.style.fontSize='2.5rem'; this.style.display='flex'; this.style.alignItems='center'; this.style.justifyContent='center';"
           loading="lazy">
      <div class="album-title">${album.title}</div>
      <div class="album-meta">${album.artist || 'Sin artista'} ‚Ä¢ ${count}</div>
    `;
    
    card.onclick = () => openAlbum(album);
    albumsGrid.appendChild(card);
  });
}

function openAlbum(album) {
  currentAlbum = album;
  const songs = songsByAlbum[album.id] || [];
  console.log(`üîì Abriendo √°lbum "${album.title}" con ${songs.length} canciones`);
  
  const albumsGrid = document.getElementById("albumsGrid");
  const targetCard = Array.from(albumsGrid.querySelectorAll('.album-card')).find(card => 
    card.querySelector('.album-title').textContent === album.title
  );
  
  if (!targetCard) return;
  
  // Remover expansi√≥n existente
  const existingExpansion = albumsGrid.querySelector('.album-expansion');
  if (existingExpansion) existingExpansion.remove();
  
  const expansion = document.createElement('div');
  expansion.className = 'album-expansion slide-up';
  
  // HEADER CON BOT√ìN DE REGRESAR
  const headerHTML = `
    <div class="backline">
      <button class="back-btn" onclick="closeAlbumExpansion()" title="Volver">‚Üê</button>
      <span class="muted" style="font-size: 11px;">Volver al inicio</span>
    </div>
    
    <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 16px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 12px;">
      <img src="${album.cover_url || ''}" alt="${album.title}" 
           style="width: 70px; height: 70px; border-radius: 12px; object-fit: cover;"
           onerror="this.style.background='var(--panel)'; this.innerHTML='üéµ'; this.style.display='flex'; this.style.alignItems='center'; this.style.justifyContent='center'; this.style.fontSize='2.5rem';">
      <div style="flex: 1;">
        <h3 style="margin: 0 0 4px 0; font-size: 18px; font-weight: 800; color: var(--brand);">${album.title}</h3>
        <p style="margin: 0 0 8px 0; color: var(--muted); font-size: 12px;">${album.artist || 'Sin artista'} ‚Ä¢ ${songs.length} canciones</p>
        <div style="display: flex; gap: 8px;">
          <button class="btn small" onclick="playAllFromAlbum('${album.id}')">‚ñ∂ Todo (${songs.length})</button>
          <button class="btn small ghost" onclick="closeAlbumExpansion()">‚úï Cerrar</button>
        </div>
      </div>
    </div>
  `;
  
  let songsHTML = '';
  if (!songs.length) {
    songsHTML = `<div style="text-align: center; padding: 30px; color: var(--muted);"><div style="font-size: 42px; margin-bottom: 12px;">üéµ</div><div>Sin canciones en este √°lbum</div></div>`;
  } else {
    songsHTML = `
      <div style="margin-bottom: 12px; color: var(--brand); font-weight: 700; font-size: 14px;">
        üìã Lista completa (${songs.length} canciones):
      </div>
      <div class="songs-list-container">
    `;
    
    // MOSTRAR TODAS LAS CANCIONES DEL √ÅLBUM
    songs.forEach((song, idx) => {
      songsHTML += `
        <div class="song-plain-item" onclick="playAlbumSong('${album.id}', ${idx})">
          <div style="display: flex; align-items: center; gap: 10px;">
            <div style="min-width: 24px; text-align: center; color: var(--muted); font-weight: 700; font-size: 11px;">${idx + 1}</div>
            <div style="flex: 1; font-weight: 600; font-size: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${song.title}">${song.title}</div>
            <button class="favorite-btn" onclick="event.stopPropagation(); toggleFavorite('${song.id}')" title="Agregar a favoritos">ü§ç</button>
          </div>
        </div>
      `;
    });
    
    songsHTML += '</div>';
  }
  
  expansion.innerHTML = headerHTML + songsHTML;
  targetCard.parentNode.insertBefore(expansion, targetCard.nextSibling);
  
  // Scroll suave hacia la expansi√≥n
  setTimeout(() => {
    expansion.scrollIntoView({behavior: 'smooth', block: 'nearest'});
  }, 100);
}

function playAlbumSong(albumId, songIndex) {
  const album = albums.find(a => a.id === albumId);
  if (!album) {
    console.error('‚ùå √Ålbum no encontrado:', albumId);
    showToast('√Ålbum no encontrado', 'error');
    return;
  }
  
  const songs = songsByAlbum[albumId] || [];
  if (!songs[songIndex]) {
    console.error('‚ùå Canci√≥n no encontrada:', songIndex, 'en √°lbum:', albumId);
    showToast('Canci√≥n no encontrada', 'error');
    return;
  }
  
  const song = songs[songIndex];
  console.log(`üéµ Reproduciendo canci√≥n ${songIndex + 1}/${songs.length}: "${song.title}"`);
  console.log('üîó URL de audio:', song.song_url);
  
  // CONFIGURAR COLA COMPLETA DEL √ÅLBUM
  queue = songs.map(s => ({
    ...s, 
    album_title: album.title, 
    cover_url: album.cover_url
  }));
  qIndex = songIndex;
  
  console.log(`üî¢ Cola configurada: ${queue.length} canciones, iniciando en √≠ndice ${qIndex}`);
  playTrack(queue[qIndex]);
}

function playAllFromAlbum(albumId) {
  const album = albums.find(a => a.id === albumId);
  if (!album) {
    console.error('‚ùå √Ålbum no encontrado:', albumId);
    showToast('√Ålbum no encontrado', 'error');
    return;
  }
  
  const songs = songsByAlbum[albumId] || [];
  if (!songs.length) {
    console.error('‚ùå √Ålbum sin canciones:', albumId);
    showToast('Este √°lbum no tiene canciones', 'error');
    return;
  }
  
  console.log(`üéµ Reproduciendo √°lbum completo "${album.title}" con ${songs.length} canciones`);
  
  // CONFIGURAR COLA COMPLETA DEL √ÅLBUM
  queue = songs.map(s => ({
    ...s, 
    album_title: album.title, 
    cover_url: album.cover_url
  }));
  qIndex = 0;
  
  console.log(`üî¢ Cola completa configurada: ${queue.length} canciones`);
  console.log('üîó Primera canci√≥n URL:', queue[0].song_url);
  
  playTrack(queue);
  showToast(`‚ñ∂ Reproduciendo "${album.title}" completo (${songs.length} canciones)`, 'success');
}

function closeAlbumExpansion() {
  const expansion = document.querySelector('.album-expansion');
  if (expansion) {
    expansion.classList.add('slide-down');
    setTimeout(() => expansion.remove(), 300);
  }
  currentAlbum = null;
  console.log('üì± √Ålbum cerrado, volviendo al grid principal');
}

function playTrack(song) {
  if (!song) {
    console.error('‚ùå Canci√≥n es null o undefined');
    showToast('Error: Canci√≥n no v√°lida', 'error');
    return;
  }
  
  if (!song.song_url) {
    console.error('‚ùå No hay URL de audio para:', song.title);
    showToast(`Error: No hay URL para "${song.title}"`, 'error');
    return;
  }
  
  console.log(`üéµ Reproduciendo: "${song.title}" (${qIndex + 1}/${queue.length})`);
  console.log('üîó URL:', song.song_url);
  
  const audioEl = document.getElementById("audio");
  const npTitle = document.getElementById("npTitle");
  const npAlbum = document.getElementById("npAlbum");
  const npCover = document.getElementById("npCover");
  const npBigTitle = document.getElementById("npBigTitle");
  const npBigAlbum = document.getElementById("npBigAlbum");
  const npBigCover = document.getElementById("npBigCover");
  const playerElement = document.getElementById("player");
  const playBtn = document.getElementById("playBtn");
  const playBtnBig = document.getElementById("playBtnBig");
  
  // Parar audio actual
  audioEl.pause();
  audioEl.currentTime = 0;
  
  // Configurar nueva canci√≥n
  audioEl.src = song.song_url;
  
  // Actualizar UI
  if (npTitle) npTitle.textContent = song.title;
  if (npAlbum) npAlbum.textContent = song.album_title || "‚Äî";
  if (npCover) npCover.src = song.cover_url || "";
  if (npBigTitle) npBigTitle.textContent = song.title;
  if (npBigAlbum) npBigAlbum.textContent = song.album_title || "‚Äî";
  if (npBigCover) npBigCover.src = song.cover_url || "";
  
  // Mostrar player
  if (playerElement) {
    playerElement.classList.add('show');
    document.body.style.paddingBottom = '80px';
  }
  
  // Intentar reproducir
  audioEl.play().then(() => {
    console.log(`‚úÖ Reproducci√≥n exitosa: "${song.title}"`);
    if (playBtn) playBtn.textContent = "‚è∏";
    if (playBtnBig) playBtnBig.textContent = "‚è∏";
  }).catch(error => {
    console.error('‚ùå Error reproduciendo:', error);
    showToast(`Error reproduciendo "${song.title}"`, 'error');
  });
}

function togglePlay() {
  const audioEl = document.getElementById("audio");
  const playBtn = document.getElementById("playBtn");
  const playBtnBig = document.getElementById("playBtnBig");
  
  if (audioEl.paused) { 
    audioEl.play().then(() => {
      console.log('‚ñ∂ Audio reanudado');
      if (playBtn) playBtn.textContent = "‚è∏";
      if (playBtnBig) playBtnBig.textContent = "‚è∏";
    }).catch(error => {
      console.error('‚ùå Error reanudando:', error);
      showToast('Error reanudando reproducci√≥n', 'error');
    });
  } else { 
    audioEl.pause(); 
    console.log('‚è∏ Audio pausado');
    if (playBtn) playBtn.textContent = "‚ñ∂";
    if (playBtnBig) playBtnBig.textContent = "‚ñ∂";
  }
}

function nextTrack() { 
  if (!queue.length) {
    console.log('‚ùå No hay canciones en cola');
    showToast('No hay canciones en cola', 'error');
    return;
  }
  
  qIndex = (qIndex + 1) % queue.length; 
  console.log(`‚è≠ Siguiente canci√≥n: ${qIndex + 1}/${queue.length}`);
  playTrack(queue[qIndex]); 
}

function prevTrack() { 
  if (!queue.length) {
    console.log('‚ùå No hay canciones en cola');
    showToast('No hay canciones en cola', 'error');
    return;
  }
  
  qIndex = (qIndex - 1 + queue.length) % queue.length; 
  console.log(`‚èÆ Canci√≥n anterior: ${qIndex + 1}/${queue.length}`);
  playTrack(queue[qIndex]); 
}

function setVolume(v) { 
  const audioEl = document.getElementById("audio");
  audioEl.volume = v; 
}

function seekAudio(percent) { 
  const audioEl = document.getElementById("audio");
  if (!audioEl.duration || isNaN(audioEl.duration)) return; 
  audioEl.currentTime = (percent / 100) * audioEl.duration; 
}

function fmt(t) { 
  if (!isFinite(t)) return "0:00"; 
  const m = Math.floor(t / 60);
  const s = Math.floor(t % 60); 
  return `${m}:${s.toString().padStart(2, "0")}`; 
}

function initSwipeGesture() {
  const npBigCover = document.getElementById('npBigCover');
  if (npBigCover) {
    npBigCover.addEventListener('touchstart', (e) => {
      touchStartY = e.changedTouches[0].screenY;
    }, {passive: true});

    npBigCover.addEventListener('touchend', (e) => {
      touchEndY = e.changedTouches.screenY;
      if (touchEndY - touchStartY > 50) {
        closeNowPlaying();
        showToast('üéµ Cerrado por gesto', 'info');
      }
    }, {passive: true});
  }
}

function openNowPlaying() {
  const npOverlay = document.getElementById("npOverlay");
  if (npOverlay) {
    npOverlay.style.display = "flex";
    setTimeout(initSwipeGesture, 100);
  }
}

function closeNowPlaying() { 
  const npOverlay = document.getElementById("npOverlay");
  if (npOverlay) npOverlay.style.display = "none"; 
}

function setActiveNav(activeButton) {
  document.querySelectorAll('#bottomBar button').forEach(btn => btn.classList.remove('active'));
  const targetBtn = document.getElementById(`btn-${activeButton}`);
  if (targetBtn) targetBtn.classList.add('active');
}

function goHome() {
  setActiveNav('home');
  closeAlbumExpansion();
}

function showSearch() {
  setActiveNav('search');
  showToast('üîç B√∫squeda pr√≥ximamente', 'info');
}

function showPlaylists() {
  setActiveNav('playlists');
  if (!isLoggedIn) {
    showLogin();
    showToast('Inicia sesi√≥n para playlists', 'error');
    return;
  }
  showToast('üì± Playlists pr√≥ximamente', 'info');
}

function showAccount() {
  setActiveNav('account');
  if(isAdmin) {
    showToast('üëë Admin: klmzr@gmail.com', 'success');
  } else if (isLoggedIn) {
    showToast(`üë§ Usuario: ${currentUser.email}`, 'success');
  } else {
    showLogin();
  }
}

function showLogin() { 
  const modal = document.getElementById("loginModal");
  if (modal) modal.style.display = "block";
}

function hideLogin() { 
  const modal = document.getElementById("loginModal");
  if (modal) modal.style.display = "none";
}

async function login() {
  const emailEl = document.getElementById("email");
  const passwordEl = document.getElementById("password");
  
  if (!emailEl || !passwordEl) {
    showToast('Error en elementos de login', 'error');
    return;
  }

  const email = emailEl.value.trim();
  const password = passwordEl.value;
  
  if (!email || !password) {
    showToast('Ingresa email y contrase√±a', 'error');
    return;
  }
  
  try {
    let result = await sb.auth.signInWithPassword({ email, password });
    
    if (result.error) {
      result = await sb.auth.signUp({ email, password });
      if (result.error) {
        showToast("Error: " + result.error.message, 'error');
        return;
      }
      showToast('Cuenta creada', 'success');
    } else {
      showToast('Bienvenido', 'success');
    }
    
    currentUser = result.data.user;
    isLoggedIn = !!currentUser;
    isAdmin = (email.toLowerCase() === ADMIN_EMAIL.toLowerCase());
    
    const btnLogout = document.getElementById("btn-logout");
    const adminTag = document.getElementById("adminTag");
    const userTag = document.getElementById("userTag");
    
    if (btnLogout) btnLogout.style.display = "inline-flex";
    
    if (isAdmin && adminTag) {
      adminTag.style.display = "inline-block";
      showToast('Modo Admin activado', 'success');
    }
    
    if (isLoggedIn && userTag) {
      userTag.style.display = "inline-block";
    }
    
    hideLogin();
    await refreshCatalog();
    
  } catch (error) {
    console.error('‚ùå Error login:', error);
    showToast('Error de conexi√≥n', 'error');
  }
}

async function logout() {
  try {
    await sb.auth.signOut();
    currentUser = null;
    isLoggedIn = false;
    isAdmin = false;
    
    const adminTag = document.getElementById("adminTag");
    const userTag = document.getElementById("userTag");
    const btnLogout = document.getElementById("btn-logout");
    
    if (adminTag) adminTag.style.display = "none";
    if (userTag) userTag.style.display = "none";
    if (btnLogout) btnLogout.style.display = "none";
    
    showToast('Sesi√≥n cerrada', 'success');
    goHome();
    
  } catch (error) {
    console.error('‚ùå Error logout:', error);
  }
}

// Placeholder functions
function toggleFavorite(songId) { 
  showToast('‚ù§Ô∏è Favoritos pr√≥ximamente', 'info');
}

// Event listeners
document.getElementById("audio").addEventListener("timeupdate", () => {
  const audioEl = document.getElementById("audio");
  const seekBig = document.getElementById("seekBig");
  const curTimeBig = document.getElementById("curTimeBig");
  const durTimeBig = document.getElementById("durTimeBig");
  
  if (!audioEl.duration) return;
  const p = (audioEl.currentTime / audioEl.duration) * 100;
  
  if (seekBig) seekBig.value = p;
  if (curTimeBig) curTimeBig.textContent = fmt(audioEl.currentTime);
  if (durTimeBig) durTimeBig.textContent = fmt(audioEl.duration);
});

// Auto-advance to next track when current ends
document.getElementById("audio").addEventListener("ended", () => {
  console.log('üîÑ Canci√≥n terminada, avanzando autom√°ticamente...');
  nextTrack();
});

// Error handling for audio
document.getElementById("audio").addEventListener("error", (e) => {
  console.error('‚ùå Error de audio:', e);
  showToast('Error reproduciendo audio', 'error');
});

// Audio loaded successfully
document.getElementById("audio").addEventListener("canplay", () => {
  console.log('‚úÖ Audio listo para reproducir');
});

// Hide loading screen
setTimeout(() => {
  const loadingScreen = document.getElementById('loadingScreen');
  if (loadingScreen) {
    loadingScreen.style.display = 'none';
  }
}, 1500);

// Initialize app
(async () => {
  console.log('üöÄ Inicializando KLMZ MUSIC...');
  
  try {
    const { data } = await sb.auth.getSession();
    
    if (data?.session?.user?.email) {
      const email = data.session.user.email;
      currentUser = data.session.user;
      isLoggedIn = true;
      isAdmin = (email.toLowerCase() === ADMIN_EMAIL.toLowerCase());
      
      const btnLogout = document.getElementById("btn-logout");
      const adminTag = document.getElementById("adminTag");
      const userTag = document.getElementById("userTag");
      
      if (btnLogout) btnLogout.style.display = "inline-flex";
      
      if (isAdmin && adminTag) {
        adminTag.style.display = "inline-block";
      }
      
      if (isLoggedIn && userTag) {
        userTag.style.display = "inline-block";
      }
    }
    
    await refreshCatalog();
    
    console.log('‚úÖ KLMZ MUSIC inicializado correctamente');
    showToast('üöÄ KLMZ MUSIC cargado', 'success');
    
  } catch (error) {
    console.error('‚ùå Error inicializaci√≥n:', error);
    showToast('Error inicializando', 'error');
  }
})();

</script>

</body>
</html>
