<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>KLMZ MUSIC</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white font-sans flex flex-col min-h-screen">
  <header class="flex justify-between items-center p-4 bg-black">
    <h1 class="text-2xl font-bold">‚ô´ KLMZ MUSIC</h1>
    <button id="adminBtn" class="bg-green-600 px-4 py-2 rounded hover:bg-green-700">Acceso Admin</button>
  </header>

  <!-- Login admin -->
  <section id="loginSection" class="hidden p-4">
    <h2 class="text-xl mb-2">Iniciar sesi√≥n Admin</h2>
    <input id="email" type="email" value="klmzr@gmail.com" class="p-2 text-black w-full mb-2 rounded" placeholder="Correo">
    <input id="password" type="password" class="p-2 text-black w-full mb-2 rounded" placeholder="Contrase√±a">
    <button id="loginBtn" class="bg-green-600 px-4 py-2 rounded hover:bg-green-700">Entrar</button>
  </section>

  <!-- Panel admin -->
  <section id="adminPanel" class="hidden p-4 bg-gray-800">
    <h2 class="text-lg font-semibold mb-2">Panel Admin</h2>
    <div class="mb-4">
      <input id="albumTitle" type="text" class="p-2 text-black w-full mb-2 rounded" placeholder="Nombre del √°lbum">
      <input id="albumCover" type="file" accept="image/*" class="mb-2">
      <button id="uploadAlbumBtn" class="bg-blue-600 px-4 py-2 rounded hover:bg-blue-700">Subir √Ålbum</button>
    </div>
    <div class="mb-4">
      <select id="albumSelect" class="p-2 text-black rounded mb-2 w-full"></select>
      <input id="songFiles" type="file" multiple accept="audio/*" class="mb-2">
      <button id="uploadSongsBtn" class="bg-blue-600 px-4 py-2 rounded hover:bg-blue-700">Subir Canciones</button>
    </div>
  </section>

  <!-- Listado de √°lbumes -->
  <main id="albums" class="grid grid-cols-2 md:grid-cols-5 gap-6 p-6 flex-grow"></main>

  <!-- Reproductor estilo Spotify -->
  <footer id="player" class="hidden fixed bottom-0 left-0 right-0 bg-black p-4 flex items-center justify-between">
    <!-- Info canci√≥n -->
    <div class="flex items-center space-x-4 w-1/4">
      <img id="playerCover" src="" class="w-14 h-14 rounded shadow hidden">
      <div>
        <p id="currentSong" class="font-semibold">Nada reproduci√©ndose</p>
        <p id="currentAlbum" class="text-sm text-gray-400"></p>
      </div>
    </div>

    <!-- Controles -->
    <div class="flex flex-col items-center space-y-2 w-2/4">
      <div class="flex items-center space-x-6">
        <button id="prevBtn" class="text-xl">‚èÆ</button>
        <button id="playPauseBtn" class="text-2xl">‚ñ∂Ô∏è</button>
        <button id="nextBtn" class="text-xl">‚è≠</button>
      </div>
      <div class="flex items-center space-x-2 w-full">
        <span id="currentTime">0:00</span>
        <input type="range" id="progressBar" class="w-full" value="0" min="0" max="100">
        <span id="duration">0:00</span>
      </div>
    </div>

    <!-- Volumen -->
    <div class="flex items-center space-x-2 w-1/4 justify-end">
      <span>üîä</span>
      <input type="range" id="volume" class="w-24" min="0" max="1" step="0.01" value="1">
    </div>
  </footer>

  <audio id="audio"></audio>

<script>
const supabaseUrl = "https://nqbldvpnqhngdtalvzov.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xYmxkdnBucWhuZ2R0YWx2em92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyMjY0NjUsImV4cCI6MjA3MDgwMjQ2NX0.Zzg5D219sW7bhvl0_R5ypX9MF6nRzBSDIeo2Lvebab0";
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

let isAdmin = false;
let albumsData = [];
let currentAlbumSongs = [];
let currentSongIndex = 0;
let currentAlbumData = null;

// elementos UI
const adminBtn = document.getElementById("adminBtn");
const loginSection = document.getElementById("loginSection");
const loginBtn = document.getElementById("loginBtn");
const adminPanel = document.getElementById("adminPanel");
const albumsDiv = document.getElementById("albums");

const audio = document.getElementById("audio");
const player = document.getElementById("player");
const playPauseBtn = document.getElementById("playPauseBtn");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const currentSongEl = document.getElementById("currentSong");
const currentAlbumEl = document.getElementById("currentAlbum");
const playerCover = document.getElementById("playerCover");
const currentTimeEl = document.getElementById("currentTime");
const durationEl = document.getElementById("duration");
const progressBar = document.getElementById("progressBar");
const volumeSlider = document.getElementById("volume");

adminBtn.onclick = () => {
  loginSection.classList.toggle("hidden");
};

loginBtn.onclick = () => {
  const email = document.getElementById("email").value;
  const pass = document.getElementById("password").value;
  if (email === "klmzr@gmail.com" && pass === "1234") {
    isAdmin = true;
    adminPanel.classList.remove("hidden");
    loginSection.classList.add("hidden");
    alert("‚úÖ Hola Admin");
  } else {
    alert("Acceso denegado");
  }
};

async function loadAlbums() {
  const { data, error } = await supabase.from("albums").select("*").order("created_at", { ascending: false });
  if (error) { console.error(error); return; }
  albumsData = data;
  renderAlbums();
}

function renderAlbums() {
  albumsDiv.innerHTML = "";
  albumsData.forEach(album => {
    const div = document.createElement("div");
    div.className = "bg-gray-800 p-3 rounded-lg shadow hover:bg-gray-700 cursor-pointer transition transform hover:scale-105";
    div.innerHTML = `
      <img src="${album.cover_url}" alt="${album.title}" class="rounded-lg mb-3 w-full aspect-square object-cover">
      <h3 class="font-semibold truncate">${album.title}</h3>
    `;
    div.onclick = () => openAlbum(album);
    albumsDiv.appendChild(div);
  });
}

async function openAlbum(album) {
  const { data: songs, error } = await supabase.from("songs").select("*").eq("album_id", album.id);
  if (error) { console.error(error); return; }
  currentAlbumSongs = songs;
  currentSongIndex = 0;
  currentAlbumData = album;

  albumsDiv.innerHTML = `
    <button onclick="loadAlbums()" class="mb-4 text-green-400">‚¨Ö Volver</button>
    <div class="flex items-center space-x-6 mb-6">
      <img src="${album.cover_url}" class="w-40 h-40 rounded-lg object-cover">
      <div>
        <h2 class="text-3xl font-bold">${album.title}</h2>
        <p class="text-gray-400">${songs.length} canciones</p>
      </div>
    </div>
    <ul class="space-y-2">
      ${songs.map((s, i) => `<li class="p-3 bg-gray-700 rounded hover:bg-gray-600 cursor-pointer flex items-center justify-between" onclick="playSong(${i})">
        <span>${i+1}. ${s.title}</span>
        <span>‚ñ∂Ô∏è</span>
      </li>`).join("")}
    </ul>
  `;
}

async function playSong(index) {
  currentSongIndex = index;
  const song = currentAlbumSongs[index];
  const { data } = supabase.storage.from("songs").getPublicUrl(song.song_url);
  audio.src = data.publicUrl;
  audio.play();
  player.classList.remove("hidden");
  playPauseBtn.textContent = "‚è∏";
  currentSongEl.textContent = song.title;
  currentAlbumEl.textContent = currentAlbumData ? currentAlbumData.title : "";
  playerCover.src = currentAlbumData ? currentAlbumData.cover_url : "";
  playerCover.classList.remove("hidden");
}

playPauseBtn.onclick = () => {
  if (audio.paused) { audio.play(); playPauseBtn.textContent = "‚è∏"; }
  else { audio.pause(); playPauseBtn.textContent = "‚ñ∂Ô∏è"; }
};
prevBtn.onclick = () => { if (currentSongIndex > 0) playSong(currentSongIndex - 1); };
nextBtn.onclick = () => { if (currentSongIndex < currentAlbumSongs.length - 1) playSong(currentSongIndex + 1); };

audio.ontimeupdate = () => {
  progressBar.value = (audio.currentTime / audio.duration) * 100 || 0;
  currentTimeEl.textContent = formatTime(audio.currentTime);
  durationEl.textContent = formatTime(audio.duration);
};
progressBar.oninput = () => { audio.currentTime = (progressBar.value / 100) * audio.duration; };
volumeSlider.oninput = () => { audio.volume = volumeSlider.value; };

function formatTime(sec) {
  if (isNaN(sec)) return "0:00";
  const m = Math.floor(sec / 60);
  const s = Math.floor(sec % 60).toString().padStart(2, "0");
  return `${m}:${s}`;
}

loadAlbums();
</script>
</body>
</html>
