<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>KLMZ MUSIC</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1DB954">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Metal+Mania&display=swap');
        * { box-sizing: border-box; }
        body { margin: 0; font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; background: #181818; color: #fff; padding-bottom: 84px; transition: all 0.3s ease; }
        header { background: #121212; padding: 1rem 1.5rem; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; transition: all 0.3s ease; }
        .logo { font-weight: bold; font-size: 1.4rem; letter-spacing: 1px; transition: all 0.3s ease; }
        .user-actions { display:flex; align-items: center; gap:.5rem; }
        .lock-icon { cursor:pointer; font-size:1.4rem; color:#fff; user-select:none; transition: all 0.3s ease; }
        .lock-icon:hover { opacity:.7;}
        .theme-selector { display: flex; align-items: center; gap: 0.3rem; margin-right: 0.5rem; }
        .theme-selector label { font-size: 0.7rem; color: #b3b3b3; }
        .theme-selector select { background: #333; color: #fff; border: 1px solid #555; border-radius: 4px; padding: 0.1rem 0.2rem; font-size: 0.7rem; cursor: pointer; transition: all 0.3s ease; }
        .app-container { display: flex; min-height: calc(100vh - 60px);}
        main { flex:1; padding:1rem; max-width:900px; margin:0 auto;}
        #search-input { width: 100%; padding: 1rem; background: #242424; border: none; border-radius: 4px; color: #fff; margin-bottom: 2rem; transition: all 0.3s ease; }
        .section-title { font-size:1.8rem; font-weight:bold; margin-bottom:1.5rem; transition: all 0.3s ease; }
        .album-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(140px,1fr)); gap:1.5rem;}
        .album-card { background:none; padding:1rem; cursor:pointer; display:flex; flex-direction:column; align-items:center; text-align:center; transition: all 0.3s ease; border-radius: 12px; }
        .album-card:hover { transform:scale(1.05); box-shadow: 0 0 15px rgba(29, 185, 84, 0.4); }
        .album-img { border-radius:50%; width:100px; height:100px; object-fit:cover; margin-bottom:.7rem; background:#333; transition: all 0.3s ease; border: 3px solid #444; }
        .album-title { font-size:.98rem; font-weight: bold; margin-bottom: 0.4rem; transition: all 0.3s ease; }
        .album-artist { font-size: .9rem; color: #b3b3b3; transition: all 0.3s ease; }
        .album-detail-img { width: 200px; height: 200px; border-radius: 50%; object-fit: cover; margin: 0 auto 1.5rem; display: block; border: 4px solid #444; transition: all 0.3s ease; }
        .song-list { width:100%; margin-top:1rem; padding-bottom: 120px; }
        .song-list ul { list-style:none; padding:0; margin:0;}
        .song-list li { padding:.7rem; cursor:pointer; color:#1db954; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center; transition: all 0.3s ease; gap: 1rem;}
        .song-list li:hover { color:#fff; background: rgba(255,255,255,.05); transform: translateX(2px);}
        .song-list .song-info { flex-grow: 1; min-width: 0; }
        .song-list .song-title { font-weight: 500; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .song-list .song-artist { color:#b3b3b3; font-size: 0.85rem; }
        .song-list li:hover .song-title { color: #1DB954; font-weight: 600; }
        .song-meta { display: flex; align-items: center; gap: 1.5rem; flex-shrink: 0;}
        .song-actions { display: flex; gap: 0.8rem; align-items: center; }
        .song-actions span { font-size: 1.2rem; cursor: pointer; color: #666; transition: all 0.3s ease; }
        .song-actions span:hover { color: #fff; transform: scale(1.1); }
        .play-icon { font-size: 1.1rem !important; }
        .playlist-item { background: #242424; padding: 1rem; margin-bottom: 0.8rem; border-radius: 8px; cursor: pointer; border-left: 3px solid #1DB954; transition: all 0.3s ease; display: flex; justify-content: space-between; align-items: center;}
        .playlist-item:hover { background: #333; border-left-color: #1ed760; }
        .playlist-info strong { font-size: 1.1rem; }
        .playlist-info small { font-size: 0.8rem; color: #b3b3b3; display: block; }
        .playlist-actions .delete-playlist { font-size: 1.2rem; color: #555; }
        .playlist-actions .delete-playlist:hover { color: #ff4757; }
        #add-to-playlist-modal ul { list-style: none; padding: 0; max-height: 40vh; overflow-y: auto; }
        #add-to-playlist-modal li { padding: 1rem; border-bottom: 1px solid #444; cursor: pointer; }
        #add-to-playlist-modal li:hover { background: #404040; color: #1DB954; }
        #add-to-playlist-modal li:last-child { border-bottom: none; }
        .modal-header { font-size: 1.2rem; font-weight: bold; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #444; }
        .player { position: fixed; bottom: 84px; left: 0; right: 0; background: #212121cc; border-top: 1px solid #282828; z-index: 300; display: flex; align-items: center; padding: 0.8rem 1.2rem; min-height: 56px; cursor: pointer; box-shadow: 0 -2px 10px #0002; transition: all 0.3s ease;}
        .player-img-mini { width:44px; height:44px; border-radius:100%; object-fit:cover; margin-right:1rem;}
        .player-info-mini { flex:1; overflow:hidden;}
        .player-title-mini { font-weight:bold; font-size:1rem; line-height:1.2;}
        .player-artist-mini { color:#b3b3b3; font-size:0.9rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
        .player-controls-inline { display:flex; align-items:center; gap:.5rem;}
        .play-btn-inline { background: none; color:#fff; border:none; font-size:1.8rem; cursor:pointer; transition: all 0.3s ease; padding: 0; }
        .play-btn-inline:hover { opacity: 0.7; }
        .full-player-backdrop { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.97); z-index:9999; align-items:center; justify-content:center; flex-direction:column; transition: all 0.3s ease;}
        .full-player-backdrop.active { display: flex;}
        .full-player-cover { width: 200px; height: 200px; border-radius: 12px; object-fit:cover; margin: 0 auto 2rem; display: block; transition: all 0.3s ease;}
        .full-player-title { font-size: 1.8rem; font-weight: bold; margin: 1rem 0 .5rem 0; text-align: center;}
        .full-player-artist { color: #b3b3b3; font-size: 1.1rem; margin-bottom: 2rem; text-align: center;}
        .full-player-controls { display: flex; flex-direction: column; align-items: center; gap: 1.5rem; width: 100%; }
        .full-control-buttons { display: flex; gap: 3rem; align-items: center; }
        .full-control-btn { background: none; border: none; color: #fff; font-size: 2.2rem; padding: 0; cursor: pointer; transition: all 0.3s ease; }
        .full-control-btn:hover { color: #1DB954; }
        .full-play-btn { font-size: 3.5rem; }
        .full-play-btn:hover { transform: scale(1.1); color: #1DB954; }
        .mode-controls { display: flex; gap: 1rem; margin-top: 1rem; justify-content: center; }
        .mode-btn { background: none; border: 1px solid #444; color: #b3b3b3; padding: 0.5rem; border-radius: 50%; cursor: pointer; font-size: 1.2rem; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; }
        .mode-btn:hover { color: #fff; border-color: #666; }
        .mode-btn.active { color: #1DB954; border-color: #1DB954; background: rgba(29,185,84,0.1); }
        .full-progress-bar { flex: 1; height: 8px; background: #4f4f4f; border-radius: 4px; cursor: pointer; position: relative;}
        .full-progress-fill { height: 100%; background: #1DB954; border-radius: 4px; width: 0%; position: absolute; top: 0; left: 0; transition: all 0.3s ease;}
        .full-progress-container { width: 90%; max-width: 400px; display: flex; align-items: center; gap: 1rem;}
        .full-progress-time { font-size: 1rem; color: #b3b3b3; min-width: 50px;}
        .full-player-volume { margin-top: 1rem;}
        .full-volume-slider { width: 150px; }
        .full-player-close { position: absolute; top: 30px; right: 40px; background: none; border: none; font-size: 2.5rem; color: #fff; cursor: pointer; transition: all 0.3s ease; }
        .full-player-close:hover { color: #ff4757; }
        .modal { position: fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,.80); display:none; align-items:center; justify-content:center; z-index:2000; transition: all 0.3s ease;}
        .modal-content { background:#282828; padding:2rem; border-radius:8px; width:95%; max-width:430px; max-height:90vh; overflow-y:auto; transition: all 0.3s ease; }
        .modal-content p a { color: #1DB954; text-decoration: none; }
        .modal-content p { text-align: center; margin-top: 1rem; }
        .form-group { margin-bottom:1rem;}
        .form-group label { display:block; margin-bottom:0.5rem;}
        .form-group input, .form-group select { width:100%; padding:.7rem; background:#404040; border:1px solid #555; border-radius:4px; color:#fff; transition: all 0.3s ease;}
        .btn-primary { background:#1DB954; color:#fff; border:none; padding:.7rem 1.5rem; border-radius:999px; cursor:pointer; width:100%; margin-top:.7rem; transition: all 0.3s ease; }
        .btn-primary:hover { background:#1ed760; }
        .btn-danger { background:#e22134; color:#fff; border:none; padding:.5rem 1rem; border-radius:4px; cursor:pointer; transition: all 0.3s ease; }
        .btn-danger:hover { background:#ff4757; }
        .close-modal { position:absolute; top:1rem; right:1rem; background:none; border:none; color:#fff; font-size:1.2rem; cursor:pointer;}
        .user-menu { position: relative; display: inline-block; }
        .user-dropdown { display: none; position: absolute; right: 0; top: calc(100% + 10px); background: #282828; min-width: 200px; border-radius: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); z-index: 1000; border: 1px solid #404040; transition: all 0.3s ease; }
        .user-dropdown.show { display: block; animation: dropdownFadeIn 0.2s ease; }
        .user-dropdown-item { padding: 0.8rem 1rem; cursor: pointer; border-bottom: 1px solid #404040; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; transition: all 0.3s ease; }
        .user-dropdown-item:last-child { border-bottom: none; }
        .user-dropdown-item:hover { background: #404040; }
        .user-dropdown-item.logout { color: #ff4757; border-top: 1px solid #404040; margin-top: 0.3rem; }
        .user-info { padding: 0.8rem 1rem; border-bottom: 2px solid #404040; font-size: 0.85rem; color: #b3b3b3; }
        .user-info strong { color: #fff; font-size: 0.9rem; }
        .bottom-nav { position: fixed; left: 0; right: 0; bottom: 20px; background: #181818; border-top: 1px solid #272727; display: flex; height: 64px; z-index: 5000; transition: all 0.3s ease; }
        .bottom-nav-item { color: #b3b3b3; text-align: center; flex: 1; font-size: 1.14rem; padding: 4px 0 0 0; border-radius: 7px; cursor: pointer; display: flex; flex-direction: column; align-items: center; transition: all 0.3s ease;}
        .bottom-nav-item.active { color: #1DB954; background: rgba(29,185,84,.09);}
        .bottom-nav-item:hover {background:rgba(255,255,255,0.05);}
        .bottom-nav-item .icon { font-size: 1.12rem; }
        .bottom-nav-item small { font-size: 0.67rem;}
        .content-section { display: none; }
        .content-section.active { display: block; }
        .back-btn { margin-bottom: 1.2rem; background: #222; color: #fff; border: none; padding: 0.5rem 1.5rem; border-radius: 999px; cursor: pointer; transition: all 0.3s ease; }
        .back-btn:hover { background: #333; }
        .copyright { position: fixed; bottom: 0; left: 0; width: 100%; height: 20px; background: #0a0a0a; color: #666; font-size: 0.7rem; text-align: center; padding: 2px 0; z-index: 10000; border-top: 1px solid #222; }
        .loading-indicator { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.9); color: #fff; padding: 1.5rem 2.5rem; border-radius: 12px; font-size: 1rem; z-index: 2000; border: 2px solid #1DB954; }
        
        /* --- ESTILOS DE BÚSQUEDA --- */
        .search-song-item, .search-album-item { background: #242424; padding: 0.8rem; margin-bottom: 0.8rem; border-radius: 8px; cursor: pointer; display: flex; align-items: center; transition: all 0.3s ease; }
        .search-song-item:hover, .search-album-item:hover { background: #333; }
        .search-song-info, .search-album-info { flex: 1; }
        .search-song-title, .search-album-title { font-weight: bold; margin-bottom: 0.2rem; }
        .search-song-artist, .search-album-artist { font-size: 0.9rem; color: #b3b3b3; }
        .search-album-img { width: 50px; height: 50px; border-radius: 8px; margin-right: 1rem; object-fit: cover; background: #333; }
        #search-results h3 { margin-top: 1.5rem; margin-bottom: 1rem; border-bottom: 1px solid #444; padding-bottom: 0.5rem; }
        
        .favorites-list, .downloads-list { margin-top: 1rem; }
        .favorite-item, .download-item { background: #242424; padding: 1rem; margin-bottom: 0.8rem; border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid #1DB954; transition: all 0.3s ease; }
        .favorite-item:hover, .download-item:hover { background: #333; }
        .favorite-info, .download-info { flex: 1; }
        .favorite-title, .download-title { font-weight: bold; margin-bottom: 0.3rem; color: #fff; }
        .favorite-artist, .download-artist { font-size: 0.9rem; color: #b3b3b3; }
        .download-item-actions { display: flex; gap: 0.5rem; align-items: center; }
        .delete-download { cursor: pointer; color: #ff4757; font-size: 1rem; transition: all 0.3s ease; }
        .delete-download:hover { transform: scale(1.2); }
        #album-detail, #playlist-detail { padding-bottom: 120px; }
        .admin-section { margin-bottom: 2.5rem; background: #242424; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #1DB954; }
        .admin-section h3 { margin-top: 0; border-bottom: 2px solid #1DB954; padding-bottom: 0.8rem; margin-bottom: 1.5rem; color: #1DB954; display: flex; align-items: center; gap: 0.5rem; }
        .admin-form { margin-bottom: 2rem; }
        .admin-form input[type="file"] { background: #333; border: 2px dashed #1DB954; padding: 1rem; border-radius: 8px; text-align: center; cursor: pointer; }
        .admin-form input[type="file"]:hover { background: #404040; }
        .btn-secondary { background: #555; color: #fff; border: none; padding: .7rem 1.5rem; border-radius: 999px; cursor: pointer; transition: all 0.3s ease; margin-right: 0.5rem; }
        .btn-secondary:hover { background: #666; }
        .admin-album-item { background: #2c2c2c; border-radius: 8px; margin-bottom: 1.5rem; border-left: 3px solid #1DB954; overflow: hidden; }
        .admin-album-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #333; }
        .admin-item-info { flex: 1; }
        .admin-item-info strong { color: #1DB954; font-size: 1.1rem; }
        .admin-item-info small { color: #b3b3b3; display: block; margin-top: 0.3rem; }
        .admin-item-actions button { margin-left: 0.5rem; padding: 0.4rem 0.8rem; font-size: 0.85rem; }
        .admin-song-list { padding: 0.5rem 1rem 1rem; }
        .admin-song-item { display: flex; justify-content: space-between; align-items: center; padding: 0.8rem; border-bottom: 1px solid #404040; }
        .admin-song-item:last-child { border-bottom: none; }
        .admin-song-actions button { margin-left: 0.5rem; padding: 0.3rem 0.6rem; font-size: 0.8rem; }
        .no-songs { color: #888; padding: 1rem; text-align: center; font-style: italic; }
        .admin-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { background: #333; padding: 1.5rem; border-radius: 8px; text-align: center; border-left: 4px solid #1DB954; }
        .stat-number { font-size: 2rem; font-weight: bold; color: #1DB954; }
        .stat-label { color: #b3b3b3; margin-top: 0.5rem; }
        .offline-indicator { background: #ff4757; color: white; padding: 0.3rem 0.8rem; border-radius: 12px; font-size: 0.8rem; margin-left: 0.5rem; }
        .multi-upload-section { background: rgba(29,185,84,0.1); border: 2px dashed #1DB954; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem; text-align: center; }
        .multi-upload-section h4 { color: #1DB954; margin-top: 0; }
        .file-queue { margin-top: 1rem; max-height: 200px; overflow-y: auto; }
        .file-queue-item { background: #333; padding: 0.8rem; margin-bottom: 0.5rem; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; }
        .file-queue-item.uploading { border-left: 3px solid #ff9800; }
        .file-queue-item.success { border-left: 3px solid #4caf50; }
        .file-queue-item.error { border-left: 3px solid #f44336; }
        .file-remove { color: #ff4757; cursor: pointer; font-size: 1.2rem; }
        .file-remove:hover { transform: scale(1.2); }
        .upload-progress-container { margin-top: 0.5rem; }
        .upload-progress-bar { background-color: #555; border-radius: 4px; height: 6px; overflow: hidden; }
        .upload-progress-fill { background-color: #1DB954; height: 100%; width: 0%; transition: width 0.2s ease-in-out; }
        .batch-upload-progress { margin-top: 1rem; }
        .batch-progress-bar { background: #444; height: 8px; border-radius: 4px; overflow: hidden; }
        .batch-progress-fill { background: #1DB954; height: 100%; width: 0%; transition: width 0.3s ease; }
        .hidden-badge { background: #555; color: #ccc; font-size: 0.7rem; padding: 2px 6px; border-radius: 8px; margin-left: 0.5rem; vertical-align: middle; font-weight: normal; }
        body.offline-mode { background: linear-gradient(135deg, #1a3d1a 0%, #0d2d0d 100%) !important; }
        body.offline-mode .section-title { color: #90ee90 !important; }
        body.offline-mode .download-item { background: #1a4d1a !important; border-left-color: #90ee90 !important; }
        body.offline-mode .bottom-nav { background: #0d2d0d !important; }
        body.offline-mode .offline-indicator { background: #ff9800 !important; animation: pulse 2s infinite; }

        /* TEMAS COMPLETOS */
        body.theme-default .album-img, body.theme-default .album-detail-img { border-color: #1DB954; }
        body.theme-fire .album-img, body.theme-fire .album-detail-img { border-color: #ff4500; }
        body.theme-fire { background: radial-gradient(ellipse at center, #3d0303 0%, #1a0000 70%) !important; color: #ffcc80 !important; }
        body.theme-fire .logo { font-family: 'Metal Mania', cursive !important; font-size: 1.8rem !important; color: #ff4500 !important; text-shadow: 0 0 5px #ff4500, 0 0 10px #ff4500, 0 0 20px #ff8c00, 0 0 40px #ff0000 !important; animation: logo-flicker 2s infinite linear alternate; }
        body.theme-fire .section-title { font-family: 'Metal Mania', cursive !important; color: #ff8c00 !important; }
        body.theme-fire header { background: rgba(10,0,0,0.8) !important; border-bottom: 2px solid #ff4500; }
        body.theme-fire .album-card:hover { animation: fire-glow 1.5s ease-in-out infinite alternate; }
        body.theme-fire .btn-primary { background: #ff4500 !important; color: #fff !important; }
        body.theme-fire .song-list li { color: #ff8c00 !important; }
        body.theme-fire .bottom-nav-item.active { color: #ff4500 !important; background: rgba(255, 69, 0, 0.2); }
        body.theme-neon .album-img, body.theme-neon .album-detail-img { border-color: #00ff88; }
        body.theme-neon { background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 70%, #0f0f23 100%) !important; color: #00ff88 !important; }
        body.theme-neon .logo { color: #00ff88 !important; text-shadow: 0 0 15px #00ff88, 0 0 30px #00ff88 !important; animation: neonPulse 2s ease-in-out infinite alternate !important; }
        body.theme-neon header { background: #0f0f23 !important; border-bottom: 1px solid #00ff88; }
        body.theme-neon .album-card:hover { box-shadow: 0 0 25px rgba(0,255,136,0.6) !important; }
        body.theme-neon .btn-primary { background: #00ff88 !important; color: #000 !important; }
        body.theme-neon .song-list li { color: #00ff88 !important; }
        body.theme-neon .bottom-nav-item.active { color: #00ff88 !important; }
        body.theme-minimal .album-img, body.theme-minimal .album-detail-img { border-color: #f5f5f5; }
        body.theme-minimal { background: linear-gradient(135deg, #0f0f0f 0%, #1c1c1c 50%, #2a2a2a 70%, #1a1a1a 100%) !important; color: #f5f5f5 !important; }
        body.theme-minimal header { background: #0f0f0f !important; border-bottom: 1px solid #333; }
        body.theme-minimal .album-card:hover { box-shadow: 0 0 20px rgba(245,245,245,0.4) !important; }
        body.theme-minimal .btn-primary { background: #f5f5f5 !important; color: #0f0f0f !important; }
        body.theme-minimal .song-list li { color: #f5f5f5 !important; }
        body.theme-minimal .bottom-nav-item.active { color: #f5f5f5 !important; }
        body.theme-sunset .album-img, body.theme-sunset .album-detail-img { border-color: #ff7043; }
        body.theme-sunset { background: linear-gradient(135deg, #2c1810 0%, #4a2c2a 30%, #6d4c41 60%, #1a1a1a 100%) !important; color: #ffab91 !important; }
        body.theme-sunset .logo { color: #ff7043 !important; text-shadow: 0 0 10px #ff7043; }
        body.theme-sunset .album-card:hover { box-shadow: 0 0 20px rgba(255, 112, 67, 0.6); }
        body.theme-sunset .btn-primary { background: #ff7043 !important; color: #fff !important; }
        body.theme-sunset .bottom-nav-item.active { color: #ff7043 !important; }
        body.theme-pastel .album-img, body.theme-pastel .album-detail-img { border-color: #bb86fc; }
        body.theme-pastel { background: linear-gradient(135deg, #1a1625 0%, #2d2438 50%, #3d2f47 70%, #4a3b5c 100%) !important; color: #d4c5f9 !important; }
        body.theme-pastel .logo { color: #bb86fc !important; text-shadow: 0 0 10px #bb86fc; }
        body.theme-pastel .album-card:hover { box-shadow: 0 0 20px rgba(187, 134, 252, 0.6); }
        body.theme-pastel .btn-primary { background: #bb86fc !important; color: #1a1625 !important; }
        body.theme-pastel .bottom-nav-item.active { color: #bb86fc !important; }
        body.theme-luxury .album-img, body.theme-luxury .album-detail-img { border-color: #3498db; }
        body.theme-luxury { background: linear-gradient(135deg, #0f1419 0%, #1a252f 50%, #2c3e50 70%, #34495e 100%) !important; color: #f0f8ff !important; }
        body.theme-luxury .logo { color: #3498db !important; text-shadow: 0 0 10px #3498db; }
        body.theme-luxury .album-card:hover { box-shadow: 0 0 20px rgba(52, 152, 219, 0.6); }
        body.theme-luxury .btn-primary { background: linear-gradient(45deg, #3498db, #2980b9) !important; color: #fff !important; }
        body.theme-luxury .bottom-nav-item.active { color: #3498db !important; }
        body.theme-oceanic .album-img, body.theme-oceanic .album-detail-img { border-color: #17a2b8; }
        body.theme-oceanic { background: linear-gradient(135deg, #0a192f 0%, #173a5e 50%, #3b6978 70%, #84a9ac 100%) !important; color: #e0e0e0 !important; }
        body.theme-oceanic .logo { color: #17a2b8 !important; text-shadow: 0 0 10px #17a2b8; }
        body.theme-oceanic .album-card:hover { box-shadow: 0 0 20px rgba(23, 162, 184, 0.6); }
        body.theme-oceanic .btn-primary { background: #17a2b8 !important; color: #fff !important; }
        body.theme-oceanic .bottom-nav-item.active { color: #17a2b8 !important; }
        body.theme-hacker .album-img, body.theme-hacker .album-detail-img { border-color: #39ff14; }
        body.theme-hacker { background: #000 !important; color: #39ff14 !important; font-family: 'Courier New', Courier, monospace !important; }
        body.theme-hacker .logo, body.theme-hacker .section-title { color: #39ff14 !important; text-shadow: 0 0 5px #39ff14, 0 0 10px #39ff14; }
        body.theme-hacker header { background: #050505 !important; border-bottom: 1px solid #39ff14; }
        body.theme-hacker .album-card:hover { box-shadow: 0 0 20px rgba(57, 255, 20, 0.7) !important; }
        body.theme-hacker .btn-primary { background: #39ff14 !important; color: #000 !important; font-weight: bold; }
        body.theme-hacker .song-list li { color: #39ff14 !important; }
        body.theme-hacker .bottom-nav-item.active { color: #39ff14 !important; background: rgba(57, 255, 20, 0.1); }
        body.theme-cyber .album-img, body.theme-cyber .album-detail-img { border-color: #ff00ff; }
        body.theme-cyber { background: linear-gradient(135deg, #0b0213 0%, #1d0f2b 100%) !important; color: #e0e0e0 !important; font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif !important; }
        body.theme-cyber .logo { color: #ff00ff !important; text-shadow: 0 0 8px #ff00ff; }
        body.theme-cyber header { background: rgba(11, 2, 19, 0.8) !important; backdrop-filter: blur(5px); border-bottom: 1px solid #ff00ff; }
        body.theme-cyber .album-card:hover { box-shadow: 0 0 18px rgba(255, 0, 255, 0.6) !important; }
        body.theme-cyber .btn-primary { background: #ff00ff !important; color: #fff !important; }
        body.theme-cyber .song-list li { color: #ff00ff !important; }
        body.theme-cyber .bottom-nav-item.active { color: #ff00ff !important; background: rgba(255, 0, 255, 0.1); }
        body.theme-floral .album-img, body.theme-floral .album-detail-img { border-color: #ff85a2; }
        body.theme-floral { background: linear-gradient(135deg, #3d1c2b 0%, #4a2c3a 100%) !important; color: #ffe0e9 !important; }
        body.theme-floral .logo { color: #ff85a2 !important; text-shadow: 0 0 8px #ff85a2; }
        body.theme-floral header { background: rgba(45, 20, 35, 0.8) !important; backdrop-filter: blur(5px); border-bottom: 1px solid #ff85a2; }
        body.theme-floral .album-card:hover { box-shadow: 0 0 18px rgba(255, 133, 162, 0.6) !important; }
        body.theme-floral .btn-primary { background: #ff85a2 !important; color: #3d1c2b !important; font-weight: bold; }
        body.theme-floral .song-list li { color: #ff85a2 !important; }
        body.theme-floral .bottom-nav-item.active { color: #ff85a2 !important; background: rgba(255, 133, 162, 0.1); }
        @keyframes fire-glow { from { box-shadow: 0 0 10px #ff8c00, 0 0 20px #ff8c00, 0 0 30px #ff4500, 0 0 40px #ff0000; } to { box-shadow: 0 0 15px #ff8c00, 0 0 25px #ff8c00, 0 0 40px #ff4500, 0 0 55px #ff0000; } } @keyframes logo-flicker { 0%, 100% { text-shadow: 0 0 5px #ff4500, 0 0 10px #ff4500, 0 0 20px #ff8c00, 0 0 40px #ff0000; opacity: 1; } 50% { text-shadow: 0 0 8px #ff4500, 0 0 15px #ff4500, 0 0 25px #ff8c00, 0 0 45px #ff0000; opacity: 0.95; } } @keyframes neonPulse { 0% { text-shadow: 0 0 15px #00ff88, 0 0 30px #00ff88; } 100% { text-shadow: 0 0 25px #00ff88, 0 0 40px #00ff88, 0 0 60px #00ff88; } } @keyframes dropdownFadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } } @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 152, 0, 0.4); } 70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(255, 152, 0, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 152, 0, 0); } }

        @media (min-width: 600px) {
            body { padding-bottom: 0; }
            .player { bottom: 0; left: 0; right: auto; width: 300px; height: 100vh; flex-direction: column; align-items: center; justify-content: flex-start; padding: 2rem 1.2rem; border-top: none; border-right: 1px solid #282828; background: #212121; }
            .player-img-mini { width: 180px; height: 180px; border-radius: 8px; margin-right: 0; margin-bottom: 1.5rem; }
            .player-info-mini { text-align: center; margin-bottom: 2rem; }
            .player-title-mini { font-size: 1.4rem; }
            .player-artist-mini { font-size: 1.1rem; }
            .player-controls-inline { gap: 1.5rem; }
            .play-btn-inline { font-size: 3rem; }
            .bottom-nav { display: none; }
            .full-player-close { display: none; }
            main { margin-left: 300px; padding-bottom: 2rem; }
            .app-container { min-height: 100vh; }
            .song-list li { padding: 1rem; }
            .album-grid { grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); }
            .album-img { width: 140px; height: 140px; }
            .album-card { padding: 1.2rem; }
            .player:hover { cursor: default; }
            .full-player-backdrop { display: none !important; }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
</head>
<body class="theme-default">

    <div id="loading-indicator" class="loading-indicator" style="display:none;">Cargando...</div>

    <header>
        <span class="logo">KLMZ MUSIC</span>
        <div class="user-actions">
            <div class="theme-selector">
                <label for="theme-select">Tema:</label>
                <select id="theme-select">
                    <option value="default">Default (Spotify)</option>
                    <option value="fire">Fire (Metal)</option>
                    <option value="neon">Neon (Synthwave)</option>
                    <option value="minimal">Minimal</option>
                    <option value="sunset">Sunset</option>
                    <option value="pastel">Pastel</option>
                    <option value="luxury">Luxury</option>
                    <option value="oceanic">Oceanic</option>
                    <option value="hacker">Hacker (Matrix)</option>
                    <option value="cyber">Cyberpunk</option>
                    <option value="floral">Floral</option>
                </select>
            </div>
            <span id="lock-icon" class="lock-icon fa-solid fa-unlock-keyhole" title="Desbloquear/Bloquear Admin"></span>
            <div id="user-menu" class="user-menu">
                <span id="user-avatar" class="lock-icon fa-solid fa-user-circle" style="cursor: pointer;" title="Menú de Usuario"></span>
                <div id="user-dropdown" class="user-dropdown">
                    </div>
            </div>
        </div>
    </header>

    <div class="app-container">
        <main id="main-content">
            
            <section id="home-section" class="content-section active">
                <h2 class="section-title"><i class="fa-solid fa-compact-disc"></i> Álbumes Destacados</h2>
                <div id="album-list" class="album-grid">
                    </div>
            </section>

            <section id="album-detail" class="content-section">
                <button class="back-btn" onclick="showSection('home-section')"><i class="fa-solid fa-arrow-left"></i> Volver a Álbumes</button>
                <img id="album-detail-img" class="album-detail-img" src="" alt="Album Cover">
                <h2 class="section-title" id="album-detail-title" style="text-align:center;"></h2>
                <p style="text-align:center; color: #b3b3b3; font-size: 1.1rem;" id="album-detail-artist"></p>
                <div class="song-list">
                    <ul id="songs-of-album-list">
                        </ul>
                </div>
            </section>
            
            <section id="search-section" class="content-section">
                <h2 class="section-title"><i class="fa-solid fa-magnifying-glass"></i> Buscar Música</h2>
                <input type="text" id="search-input" placeholder="Busca canciones, artistas o álbumes...">
                <div id="search-results">
                    </div>
            </section>

            <section id="favorites-section" class="content-section">
                <h2 class="section-title"><i class="fa-solid fa-heart"></i> Mis Favoritos</h2>
                <div id="favorites-list" class="favorites-list">
                    </div>
            </section>

            <section id="playlists-section" class="content-section">
                <h2 class="section-title"><i class="fa-solid fa-list"></i> Mis Playlists</h2>
                <button class="btn-primary" style="margin-bottom: 1.5rem; width: 50%;" id="create-playlist-btn"><i class="fa-solid fa-plus"></i> Crear Nueva Playlist</button>
                <div id="playlists-list">
                    </div>
            </section>

            <section id="playlist-detail" class="content-section">
                <button class="back-btn" onclick="showSection('playlists-section')"><i class="fa-solid fa-arrow-left"></i> Volver a Playlists</button>
                <h2 class="section-title" id="playlist-detail-title"></h2>
                <p style="color: #b3b3b3; margin-top: -1rem; margin-bottom: 1.5rem;" id="playlist-song-count"></p>
                <div class="song-list">
                    <ul id="songs-of-playlist-list">
                        </ul>
                </div>
            </section>

            <section id="downloads-section" class="content-section">
                <h2 class="section-title"><i class="fa-solid fa-download"></i> Mis Descargas (<span id="offline-status">Online</span>)</h2>
                <div id="downloads-list" class="downloads-list">
                    </div>
            </section>

            <section id="admin-section" class="content-section">
                <h2 class="section-title"><i class="fa-solid fa-user-lock"></i> Panel de Administración</h2>

                <div class="admin-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="stat-albums">0</div>
                        <div class="stat-label">Álbumes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="stat-songs">0</div>
                        <div class="stat-label">Canciones</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="stat-users">0</div>
                        <div class="stat-label">Usuarios</div>
                    </div>
                </div>

                <div class="admin-section multi-upload-section">
                    <h4><i class="fa-solid fa-cloud-arrow-up"></i> Subida Múltiple de Canciones</h4>
                    <form id="multi-upload-form" class="admin-form">
                        <div class="form-group">
                            <label for="multi-upload-files">Selecciona Archivos MP3:</label>
                            <input type="file" id="multi-upload-files" multiple accept=".mp3">
                        </div>
                        <div class="file-queue" id="file-queue">
                            </div>
                        <div class="batch-upload-progress" style="display: none;">
                            <div class="batch-progress-bar">
                                <div class="batch-progress-fill" id="batch-progress-fill"></div>
                            </div>
                            <small id="batch-progress-text" style="display: block; margin-top: 5px; color: #1DB954;"></small>
                        </div>
                        <button type="submit" class="btn-primary" id="start-multi-upload-btn" style="margin-top: 1.5rem;" disabled>
                            <i class="fa-solid fa-upload"></i> Iniciar Subida
                        </button>
                    </form>
                </div>


                <div class="admin-section">
                    <h3><i class="fa-solid fa-list-check"></i> Gestión de Álbumes</h3>
                    <form id="create-album-form" class="admin-form">
                        <div class="form-group">
                            <label for="album-title-admin">Título del Álbum:</label>
                            <input type="text" id="album-title-admin" required>
                        </div>
                        <div class="form-group">
                            <label for="album-artist-admin">Artista:</label>
                            <input type="text" id="album-artist-admin" required>
                        </div>
                        <div class="form-group">
                            <label for="album-cover-admin">Portada (JPG/PNG):</label>
                            <input type="file" id="album-cover-admin" accept="image/jpeg,image/png" required>
                        </div>
                        <button type="submit" class="btn-primary"><i class="fa-solid fa-plus"></i> Crear Álbum</button>
                    </form>

                    <div id="admin-album-list">
                        </div>
                </div>

                <div class="admin-section" style="display:none;">
                    <h3><i class="fa-solid fa-users"></i> Gestión de Usuarios</h3>
                    <div id="admin-user-list">
                        </div>
                </div>
            </section>

        </main>
    </div>

    <div id="mini-player" class="player" style="display:none;">
        <img id="player-img-mini" class="player-img-mini" src="" alt="Mini Player Cover">
        <div class="player-info-mini">
            <div id="player-title-mini" class="player-title-mini"></div>
            <div id="player-artist-mini" class="player-artist-mini"></div>
        </div>
        <div class="player-controls-inline">
            <button id="prev-btn-inline" class="play-btn-inline" style="font-size: 1.4rem;"><i class="fa-solid fa-backward-step"></i></button>
            <button id="play-pause-btn-inline" class="play-btn-inline"><i class="fa-solid fa-play"></i></button>
            <button id="next-btn-inline" class="play-btn-inline" style="font-size: 1.4rem;"><i class="fa-solid fa-forward-step"></i></button>
        </div>
    </div>

    <div id="full-player-backdrop" class="full-player-backdrop">
        <button id="full-player-close" class="full-player-close"><i class="fa-solid fa-chevron-down"></i></button>
        <img id="full-player-cover" class="full-player-cover" src="" alt="Full Player Cover">
        <div id="full-player-title" class="full-player-title"></div>
        <div id="full-player-artist" class="full-player-artist"></div>

        <div class="full-player-controls">
            <div class="full-progress-container">
                <span id="full-current-time" class="full-progress-time">0:00</span>
                <div id="full-progress-bar" class="full-progress-bar">
                    <div id="full-progress-fill" class="full-progress-fill"></div>
                </div>
                <span id="full-duration" class="full-progress-time">0:00</span>
            </div>

            <div class="full-control-buttons">
                <button id="shuffle-btn-full" class="full-control-btn"><i class="fa-solid fa-shuffle"></i></button>
                <button id="prev-btn-full" class="full-control-btn"><i class="fa-solid fa-backward-step"></i></button>
                <button id="play-pause-btn-full" class="full-control-btn full-play-btn"><i class="fa-solid fa-play"></i></button>
                <button id="next-btn-full" class="full-control-btn"><i class="fa-solid fa-forward-step"></i></button>
                <button id="repeat-btn-full" class="full-control-btn"><i class="fa-solid fa-repeat"></i></button>
            </div>

            <div class="full-player-volume">
                <i class="fa-solid fa-volume-high" style="margin-right: 0.5rem; color: #b3b3b3;"></i>
                <input type="range" id="full-volume-slider" class="full-volume-slider" min="0" max="1" step="0.01" value="1">
            </div>

            <div class="mode-controls">
                <button id="mode-fav-btn" class="mode-btn" title="Añadir a Favoritos"><i class="fa-solid fa-heart"></i></button>
                <button id="mode-playlist-btn" class="mode-btn" title="Añadir a Playlist"><i class="fa-solid fa-list-ul"></i></button>
                <button id="mode-download-btn" class="mode-btn" title="Descargar"><i class="fa-solid fa-cloud-arrow-down"></i></button>
            </div>
        </div>
    </div>


    <nav class="bottom-nav">
        <div class="copyright">Derechos de autor © 2024. Todos los derechos reservados.</div>
        <a class="bottom-nav-item active" data-section="home-section">
            <i class="icon fa-solid fa-house"></i>
            <small>Inicio</small>
        </a>
        <a class="bottom-nav-item" data-section="search-section">
            <i class="icon fa-solid fa-magnifying-glass"></i>
            <small>Buscar</small>
        </a>
        <a class="bottom-nav-item" data-section="favorites-section">
            <i class="icon fa-solid fa-heart"></i>
            <small>Favoritos</small>
        </a>
        <a class="bottom-nav-item" data-section="playlists-section">
            <i class="icon fa-solid fa-list"></i>
            <small>Playlists</small>
        </a>
        <a class="bottom-nav-item" data-section="downloads-section">
            <i class="icon fa-solid fa-download"></i>
            <small>Descargas</small>
        </a>
    </nav>


    <div id="create-playlist-modal" class="modal">
        <div class="modal-content">
            <button class="close-modal"><i class="fa-solid fa-xmark"></i></button>
            <div class="modal-header"><i class="fa-solid fa-list-ul"></i> Crear Nueva Playlist</div>
            <form id="playlist-form">
                <div class="form-group">
                    <label for="playlist-name">Nombre de la Playlist:</label>
                    <input type="text" id="playlist-name" required>
                </div>
                <button type="submit" class="btn-primary"><i class="fa-solid fa-circle-check"></i> Crear</button>
            </form>
        </div>
    </div>

    <div id="add-to-playlist-modal" class="modal">
        <div class="modal-content">
            <button class="close-modal"><i class="fa-solid fa-xmark"></i></button>
            <div class="modal-header"><i class="fa-solid fa-list-ul"></i> Añadir a Playlist</div>
            <p>Selecciona una playlist para añadir la canción:</p>
            <ul id="playlist-select-list">
                </ul>
        </div>
    </div>

    <div id="login-modal" class="modal">
        <div class="modal-content">
            <button class="close-modal"><i class="fa-solid fa-xmark"></i></button>
            <div class="modal-header"><i class="fa-solid fa-lock"></i> Acceso Restringido</div>
            <form id="login-form">
                <div class="form-group">
                    <label for="login-pin">Introduce tu PIN:</label>
                    <input type="password" id="login-pin" maxlength="4" required>
                </div>
                <button type="submit" class="btn-primary"><i class="fa-solid fa-key"></i> Acceder</button>
                <p><a href="#" id="forgot-pin-link">¿Olvidaste tu PIN?</a></p>
            </form>
            <form id="registration-form" style="display: none;">
                <div class="modal-header" style="margin-top: 1.5rem;">Registro de PIN de Usuario</div>
                <p>Establece un PIN de 4 dígitos para proteger tu cuenta:</p>
                <div class="form-group">
                    <label for="register-pin">Nuevo PIN (4 dígitos):</label>
                    <input type="password" id="register-pin" maxlength="4" required>
                </div>
                <button type="submit" class="btn-primary">Registrar PIN</button>
            </form>
            <form id="admin-pin-set-form" style="display: none;">
                <div class="modal-header" style="margin-top: 1.5rem;">Configuración de PIN de Administrador</div>
                <p>Establece un PIN de 4 dígitos para acceder al panel de administrador:</p>
                <div class="form-group">
                    <label for="admin-register-pin">Nuevo PIN de Admin (4 dígitos):</label>
                    <input type="password" id="admin-register-pin" maxlength="4" required>
                </div>
                <button type="submit" class="btn-primary">Establecer PIN Admin</button>
            </form>
        </div>
    </div>


    <script>
        // Data Store (Will persist across sessions in localStorage)
        let albums = [];
        let songsWithAlbumInfo = [];
        let playlists = [];
        let favorites = [];
        let downloads = [];
        let currentSong = null;
        let currentSongIndex = -1;
        let currentPlaylist = [];
        let currentAudio = new Audio();
        let isPlaying = false;
        let repeatMode = 'none'; // 'none', 'one', 'all'
        let adminMode = false;
        let adminPin = localStorage.getItem('adminPin') || null;
        let userPin = localStorage.getItem('userPin') || null;
        let loggedIn = false;
        let theme = localStorage.getItem('appTheme') || 'default';
        let isMobile = window.matchMedia("(max-width: 599px)").matches;
        let initialLoad = true;

        // DOM Elements
        const $ = selector => document.querySelector(selector);
        const $$ = selector => document.querySelectorAll(selector);

        // Core Functions
        
        function getUniqueId() {
            return 'id-' + Date.now() + '-' + Math.random().toString(16).slice(2);
        }

        function saveData() {
            localStorage.setItem('albums', JSON.stringify(albums));
            localStorage.setItem('playlists', JSON.stringify(playlists));
            localStorage.setItem('favorites', JSON.stringify(favorites));
            localStorage.setItem('downloads', JSON.stringify(downloads));
            localStorage.setItem('appTheme', theme);
        }

        function loadData() {
            albums = JSON.parse(localStorage.getItem('albums')) || [];
            playlists = JSON.parse(localStorage.getItem('playlists')) || [];
            favorites = JSON.parse(localStorage.getItem('favorites')) || [];
            downloads = JSON.parse(localStorage.getItem('downloads')) || [];
            theme = localStorage.getItem('appTheme') || 'default';
            // Also load pins and user state
            adminPin = localStorage.getItem('adminPin');
            userPin = localStorage.getItem('userPin');
            loggedIn = !!userPin;
            if (loggedIn) {
                 // Attempt to re-set admin mode if the pin is set and matched (for convenience)
                if(localStorage.getItem('isAdminSession') === 'true' && localStorage.getItem('adminPin')) {
                    const savedAdminPin = localStorage.getItem('adminPin');
                    if (savedAdminPin === userPin) { // Simple check, typically admin has separate credentials but here we link it for simplicity
                         setAdminMode(true);
                    }
                }
            }
        }
        
        function applyTheme(newTheme) {
            document.body.className = '';
            document.body.classList.add(`theme-${newTheme}`);
            theme = newTheme;
            localStorage.setItem('appTheme', theme);
            $('#theme-select').value = newTheme;

            // Update theme color for PWA (needs full reload to be reliable on some platforms, but we try)
            const themeColorMeta = $('meta[name="theme-color"]');
            let color = '#1DB954';
            switch(newTheme) {
                case 'fire': color = '#ff4500'; break;
                case 'neon': color = '#00ff88'; break;
                case 'minimal': color = '#f5f5f5'; break;
                case 'sunset': color = '#ff7043'; break;
                case 'pastel': color = '#bb86fc'; break;
                case 'luxury': color = '#3498db'; break;
                case 'oceanic': color = '#17a2b8'; break;
                case 'hacker': color = '#39ff14'; break;
                case 'cyber': color = '#ff00ff'; break;
                case 'floral': color = '#ff85a2'; break;
                default: color = '#1DB954';
            }
            if (themeColorMeta) {
                themeColorMeta.setAttribute('content', color);
            }
        }

        function showSection(sectionId) {
            $$('.content-section').forEach(section => section.classList.remove('active'));
            $(sectionId).classList.add('active');
            
            // Highlight correct bottom nav item
            $$('.bottom-nav-item').forEach(item => item.classList.remove('active'));
            const activeNav = $(`[data-section="${sectionId}"]`);
            if (activeNav) activeNav.classList.add('active');

            // Handle unique section updates
            if (sectionId === 'home-section') renderAlbumList();
            if (sectionId === 'playlists-section') renderPlaylistList();
            if (sectionId === 'favorites-section') renderFavoritesList();
            if (sectionId === 'downloads-section') renderDownloadsList();
            if (sectionId === 'admin-section') renderAdminPanel();
        }

        function openModal(modalId) {
            $(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            $(modalId).style.display = 'none';
        }
        
        function updateSongsWithAlbumInfo() {
            songsWithAlbumInfo = albums.flatMap(album => 
                album.songs.map(song => ({
                    ...song,
                    albumId: album.id,
                    albumTitle: album.title,
                    albumArtist: album.artist,
                    albumCover: album.cover
                }))
            );
        }

        // --- User/Admin Functions ---
        function setAdminMode(enable) {
            adminMode = enable;
            const lockIcon = $('#lock-icon');
            if (enable) {
                lockIcon.classList.remove('fa-unlock-keyhole');
                lockIcon.classList.add('fa-lock');
                lockIcon.title = "Bloquear Admin";
                localStorage.setItem('isAdminSession', 'true');
            } else {
                lockIcon.classList.remove('fa-lock');
                lockIcon.classList.add('fa-unlock-keyhole');
                lockIcon.title = "Desbloquear/Bloquear Admin";
                localStorage.setItem('isAdminSession', 'false');
                if ($('#admin-section').classList.contains('active')) {
                    showSection('home-section');
                }
            }
            renderUserDropdown();
            // Show/hide admin-specific elements if needed, but for now we rely on the link in the dropdown
        }

        function renderUserDropdown() {
            const dropdown = $('#user-dropdown');
            const userAvatar = $('#user-avatar');
            dropdown.innerHTML = '';
            
            if (loggedIn) {
                userAvatar.classList.add('fa-solid');
                userAvatar.classList.remove('fa-user-circle');
                userAvatar.classList.add('fa-user'); // Change icon for logged in state
                
                const userInfo = document.createElement('div');
                userInfo.className = 'user-info';
                userInfo.innerHTML = `Conectado como: <strong>Usuario</strong>`;
                if (adminPin && adminPin === userPin) {
                     userInfo.innerHTML += `<br> <small style="color: #1DB954;">(Admin)</small>`;
                }
                dropdown.appendChild(userInfo);

                const logoutItem = document.createElement('div');
                logoutItem.className = 'user-dropdown-item logout';
                logoutItem.innerHTML = '<i class="fa-solid fa-right-from-bracket"></i> Cerrar Sesión';
                logoutItem.onclick = logout;
                dropdown.appendChild(logoutItem);

                if (adminPin && adminPin === userPin) {
                    const adminItem = document.createElement('div');
                    adminItem.className = 'user-dropdown-item';
                    adminItem.innerHTML = `<i class="fa-solid fa-user-lock"></i> Panel Admin (${adminMode ? 'ON' : 'OFF'})`;
                    adminItem.onclick = () => {
                        if (adminMode) {
                            setAdminMode(false);
                            showSection('home-section');
                        } else {
                            setAdminMode(true);
                            showSection('admin-section');
                        }
                    };
                    dropdown.prepend(adminItem);
                }
            } else {
                userAvatar.classList.remove('fa-user');
                userAvatar.classList.add('fa-user-circle');
                
                const loginItem = document.createElement('div');
                loginItem.className = 'user-dropdown-item';
                loginItem.innerHTML = '<i class="fa-solid fa-arrow-right-to-bracket"></i> Iniciar Sesión';
                loginItem.onclick = () => { openModal('#login-modal'); $('#registration-form').style.display = 'none'; $('#login-form').style.display = 'block'; };
                dropdown.appendChild(loginItem);

                if (!userPin) {
                     const registerItem = document.createElement('div');
                     registerItem.className = 'user-dropdown-item';
                     registerItem.innerHTML = '<i class="fa-solid fa-user-plus"></i> Registrarme';
                     registerItem.onclick = () => { openModal('#login-modal'); $('#login-form').style.display = 'none'; $('#registration-form').style.display = 'block'; };
                     dropdown.appendChild(registerItem);
                }
                
                if (!adminPin) {
                    const setAdminItem = document.createElement('div');
                    setAdminItem.className = 'user-dropdown-item';
                    setAdminItem.innerHTML = '<i class="fa-solid fa-key"></i> Configurar Admin PIN';
                    setAdminItem.onclick = () => { openModal('#login-modal'); $('#login-form').style.display = 'none'; $('#registration-form').style.display = 'none'; $('#admin-pin-set-form').style.display = 'block'; };
                    dropdown.appendChild(setAdminItem);
                }
            }
            
            // If the user pin is set, and the user is not logged in, but the admin pin is not set, allow admin pin setup
            if (userPin && !loggedIn && !adminPin) {
                const setAdminItem = document.createElement('div');
                setAdminItem.className = 'user-dropdown-item';
                setAdminItem.innerHTML = '<i class="fa-solid fa-key"></i> Configurar Admin PIN';
                setAdminItem.onclick = () => { openModal('#login-modal'); $('#login-form').style.display = 'none'; $('#registration-form').style.display = 'none'; $('#admin-pin-set-form').style.display = 'block'; };
                dropdown.appendChild(setAdminItem);
            }
        }
        
        function logout() {
            loggedIn = false;
            setAdminMode(false);
            localStorage.removeItem('isAdminSession');
            renderUserDropdown();
            showSection('home-section');
            alert('Sesión cerrada.');
        }


        // --- Render Functions ---

        function renderAlbumList() {
            const list = $('#album-list');
            list.innerHTML = '';
            albums.forEach(album => {
                const card = document.createElement('div');
                card.className = 'album-card';
                card.dataset.albumId = album.id;
                card.onclick = () => renderAlbumDetail(album.id);
                
                const isHidden = album.hidden && adminMode;
                
                card.innerHTML = `
                    <img class="album-img" src="${album.cover}" alt="${album.title} cover">
                    <div class="album-title">${album.title}${isHidden ? ' <span class="hidden-badge">Oculto</span>' : ''}</div>
                    <div class="album-artist">${album.artist}</div>
                `;
                list.appendChild(card);
            });
        }

        function renderAlbumDetail(albumId) {
            const album = albums.find(a => a.id === albumId);
            if (!album) return;

            $('#album-detail-img').src = album.cover;
            $('#album-detail-img').alt = `${album.title} Cover`;
            $('#album-detail-title').textContent = album.title;
            $('#album-detail-artist').textContent = album.artist;

            const list = $('#songs-of-album-list');
            list.innerHTML = '';

            album.songs.forEach((song, index) => {
                const li = document.createElement('li');
                li.dataset.songId = song.id;
                li.dataset.songIndex = index;
                li.dataset.albumId = album.id; // Store album context
                
                // Add album info to song object for playSong function
                const songWithAlbum = {
                    ...song,
                    albumTitle: album.title,
                    albumArtist: album.artist,
                    albumCover: album.cover
                };

                const isFavorite = favorites.some(fav => fav.id === song.id);
                const isDownloaded = downloads.some(dl => dl.id === song.id);

                li.innerHTML = `
                    <div class="song-info">
                        <span class="song-title">${song.title}</span>
                        <span class="song-artist">${song.artist}</span>
                    </div>
                    <div class="song-meta">
                        ${isDownloaded ? '<i class="fa-solid fa-download" style="color:#1DB954;"></i>' : ''}
                        <div class="song-actions">
                            <span class="fa-solid fa-play play-icon" data-song-index="${index}" title="Reproducir"></span>
                            <span class="fa-solid fa-list-ul add-to-playlist" data-song='${JSON.stringify(songWithAlbum)}' title="Añadir a Playlist"></span>
                            <span class="fa-solid ${isFavorite ? 'fa-heart' : 'fa-regular fa-heart'} toggle-favorite" data-song='${JSON.stringify(songWithAlbum)}' title="Favorito"></span>
                            <span class="fa-solid fa-cloud-arrow-down download-song" data-song='${JSON.stringify(songWithAlbum)}' title="Descargar"></span>
                        </div>
                    </div>
                `;
                list.appendChild(li);
            });

            showSection('album-detail');
        }

        function renderPlaylistList() {
            const list = $('#playlists-list');
            list.innerHTML = '';

            if (playlists.length === 0) {
                list.innerHTML = `<p style="color: #b3b3b3; text-align: center;">Aún no tienes playlists. ¡Crea una!</p>`;
                return;
            }

            playlists.forEach(playlist => {
                const item = document.createElement('div');
                item.className = 'playlist-item';
                item.dataset.playlistId = playlist.id;
                item.onclick = (e) => {
                    if (!e.target.closest('.playlist-actions')) {
                        renderPlaylistDetail(playlist.id);
                    }
                };

                item.innerHTML = `
                    <div class="playlist-info">
                        <strong>${playlist.name}</strong>
                        <small>${playlist.songs.length} Canciones</small>
                    </div>
                    <div class="playlist-actions">
                        <span class="fa-solid fa-xmark delete-playlist" data-playlist-id="${playlist.id}" title="Eliminar Playlist"></span>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function renderPlaylistDetail(playlistId) {
            const playlist = playlists.find(p => p.id === playlistId);
            if (!playlist) return;

            $('#playlist-detail-title').textContent = playlist.name;
            $('#playlist-song-count').textContent = `${playlist.songs.length} Canciones`;

            const list = $('#songs-of-playlist-list');
            list.innerHTML = '';

            playlist.songs.forEach((song, index) => {
                const li = document.createElement('li');
                li.dataset.songId = song.id;
                li.dataset.songIndex = index;
                li.dataset.playlistId = playlist.id;
                
                // For a playlist, the play button should play the song in the context of the playlist
                
                const isFavorite = favorites.some(fav => fav.id === song.id);
                const isDownloaded = downloads.some(dl => dl.id === song.id);

                li.innerHTML = `
                    <div class="song-info">
                        <span class="song-title">${song.title}</span>
                        <span class="song-artist">${song.artist} | ${song.albumTitle}</span>
                    </div>
                    <div class="song-meta">
                        ${isDownloaded ? '<i class="fa-solid fa-download" style="color:#1DB954;"></i>' : ''}
                        <div class="song-actions">
                            <span class="fa-solid fa-play play-icon" data-song-index="${index}" title="Reproducir"></span>
                            <span class="fa-solid fa-xmark remove-from-playlist" data-song-id="${song.id}" data-playlist-id="${playlist.id}" title="Eliminar de Playlist"></span>
                            <span class="fa-solid ${isFavorite ? 'fa-heart' : 'fa-regular fa-heart'} toggle-favorite" data-song='${JSON.stringify(song)}' title="Favorito"></span>
                        </div>
                    </div>
                `;
                list.appendChild(li);
            });

            showSection('playlist-detail');
        }

        function renderFavoritesList() {
            const list = $('#favorites-list');
            list.innerHTML = '';

            if (favorites.length === 0) {
                list.innerHTML = `<p style="color: #b3b3b3; text-align: center;">Aún no tienes canciones favoritas. ¡Añade algunas!</p>`;
                return;
            }

            favorites.forEach(song => {
                const item = document.createElement('div');
                item.className = 'favorite-item';
                item.dataset.songId = song.id;
                item.dataset.song = JSON.stringify(song); // For easy playback via general event listener
                
                item.innerHTML = `
                    <div class="favorite-info">
                        <span class="favorite-title">${song.title}</span>
                        <span class="favorite-artist">${song.artist} | ${song.albumTitle}</span>
                    </div>
                    <div class="song-actions">
                        <span class="fa-solid fa-play play-icon" data-song='${JSON.stringify(song)}' title="Reproducir"></span>
                        <span class="fa-solid fa-heart toggle-favorite" data-song='${JSON.stringify(song)}' title="Quitar de Favoritos"></span>
                    </div>
                `;
                list.appendChild(item);
            });
        }
        
        function renderDownloadsList() {
            const list = $('#downloads-list');
            list.innerHTML = '';
            
            const offlineIndicator = $('#offline-status');
            const hasDownloads = downloads.length > 0;
            const isOnline = navigator.onLine;

            if (!isOnline) {
                document.body.classList.add('offline-mode');
                offlineIndicator.textContent = 'Offline';
            } else {
                document.body.classList.remove('offline-mode');
                offlineIndicator.textContent = 'Online';
            }

            if (downloads.length === 0) {
                list.innerHTML = `<p style="color: #b3b3b3; text-align: center;">Aún no has descargado ninguna canción. ¡Descarga algunas!</p>`;
                return;
            }

            downloads.forEach(song => {
                const item = document.createElement('div');
                item.className = 'download-item';
                item.dataset.songId = song.id;
                item.dataset.song = JSON.stringify(song);
                
                const availableLocally = song.localFileUrl; // In a real PWA/app, check if file exists

                item.innerHTML = `
                    <div class="download-info">
                        <span class="download-title">${song.title}</span>
                        <span class="download-artist">${song.artist} | ${song.albumTitle}</span>
                    </div>
                    <div class="download-item-actions">
                        ${availableLocally ? `<span class="fa-solid fa-play play-icon" data-song='${JSON.stringify(song)}' title="Reproducir"></span>` : '<i class="fa-solid fa-triangle-exclamation" style="color:orange;" title="Fichero local no disponible"></i>'}
                        <span class="fa-solid fa-trash delete-download" data-song-id="${song.id}" title="Eliminar Descarga"></span>
                    </div>
                `;
                list.appendChild(item);
            });
        }
        
        // --- Player Functions ---

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }
        
        function updateMiniPlayerDisplay() {
            const player = $('#mini-player');
            if (currentSong) {
                player.style.display = 'flex';
                $('#player-img-mini').src = currentSong.albumCover || 'default-cover.png';
                $('#player-title-mini').textContent = currentSong.title;
                $('#player-artist-mini').textContent = currentSong.artist;
                
                const playPauseBtn = $('#play-pause-btn-inline');
                playPauseBtn.innerHTML = isPlaying ? '<i class="fa-solid fa-pause"></i>' : '<i class="fa-solid fa-play"></i>';
                
                // For desktop view, update the song info under the cover
                if (!isMobile) {
                    $('#player-img-mini').style.borderRadius = '8px';
                    $('#player-img-mini').style.width = '180px';
                    $('#player-img-mini').style.height = '180px';
                    $('#player-title-mini').style.whiteSpace = 'normal';
                } else {
                    $('#player-img-mini').style.borderRadius = '100%';
                    $('#player-img-mini').style.width = '44px';
                    $('#player-img-mini').style.height = '44px';
                    $('#player-title-mini').style.whiteSpace = 'nowrap';
                }
                
                updateFullPlayerDisplay();
            } else {
                player.style.display = 'none';
                currentAudio.pause();
                currentAudio.src = '';
            }
        }

        function updateFullPlayerDisplay() {
            if (!currentSong) {
                $('#full-player-backdrop').classList.remove('active');
                return;
            }
            
            // Player controls
            const fullPlayPauseBtn = $('#play-pause-btn-full');
            fullPlayPauseBtn.innerHTML = isPlaying ? '<i class="fa-solid fa-pause"></i>' : '<i class="fa-solid fa-play"></i>';
            
            // Song Info
            $('#full-player-cover').src = currentSong.albumCover || 'default-cover.png';
            $('#full-player-title').textContent = currentSong.title;
            $('#full-player-artist').textContent = currentSong.artist;
            
            // Modes
            const favBtn = $('#mode-fav-btn');
            const isFav = favorites.some(fav => fav.id === currentSong.id);
            if (isFav) {
                favBtn.classList.add('active');
                favBtn.innerHTML = '<i class="fa-solid fa-heart"></i>';
            } else {
                favBtn.classList.remove('active');
                favBtn.innerHTML = '<i class="fa-regular fa-heart"></i>';
            }
            
            // Repeat mode
            const repeatBtn = $('#repeat-btn-full');
            repeatBtn.classList.remove('active');
            repeatBtn.innerHTML = '<i class="fa-solid fa-repeat"></i>'; // Default
            if (repeatMode === 'all') {
                repeatBtn.classList.add('active');
            } else if (repeatMode === 'one') {
                repeatBtn.classList.add('active');
                repeatBtn.innerHTML = '<i class="fa-solid fa-repeat" style="position:relative;"><i class="fa-solid fa-1" style="font-size: 0.5em; position: absolute; bottom: -3px; right: -5px;"></i></i>';
            }
        }

        function togglePlayPause() {
            if (!currentSong) return;

            if (isPlaying) {
                currentAudio.pause();
                isPlaying = false;
            } else {
                currentAudio.play().catch(error => {
                    console.error("Autoplay failed:", error);
                    alert("No se pudo iniciar la reproducción. Toca la pantalla una vez para permitir la reproducción automática.");
                });
                isPlaying = true;
            }
            updateMiniPlayerDisplay();
        }

        function playSong(song, playlist, playlistSource, index) {
            currentSong = song;
            currentPlaylist = playlist; // The full list of songs currently being played from
            currentSongIndex = index; // Index within that playlist
            
            let songUrl = song.url;
            
            // Check if downloaded version is available
            const downloadedSong = downloads.find(dl => dl.id === song.id);
            if (downloadedSong && downloadedSong.localFileUrl) {
                songUrl = downloadedSong.localFileUrl; // Use local URL if available
            }

            // If the song is already playing and we clicked it again, toggle pause
            if (currentAudio.src === songUrl && isPlaying) {
                 togglePlayPause();
                 return;
            }
            
            currentAudio.src = songUrl;
            
            // Handle loading indicator while audio loads
            const loadingIndicator = $('#loading-indicator');
            loadingIndicator.style.display = 'block';
            
            currentAudio.load();
            currentAudio.play().then(() => {
                isPlaying = true;
                loadingIndicator.style.display = 'none';
            }).catch(error => {
                console.error("Playback failed or was interrupted:", error);
                isPlaying = false;
                loadingIndicator.style.display = 'none';
                alert("Error al reproducir la canción. Revisa la URL o permite la reproducción automática.");
            });
            
            updateMiniPlayerDisplay();
        }

        function playNext() {
            if (currentPlaylist.length === 0) return;
            
            if (repeatMode === 'one') {
                playSong(currentSong, currentPlaylist, currentPlaylist, currentSongIndex); // Replay current song
                return;
            }
            
            let nextIndex = currentSongIndex + 1;
            if (nextIndex >= currentPlaylist.length) {
                if (repeatMode === 'all') {
                    nextIndex = 0; // Loop back to start
                } else {
                    // Stop playback
                    currentSong = null;
                    isPlaying = false;
                    updateMiniPlayerDisplay();
                    return;
                }
            }
            
            const nextSong = currentPlaylist[nextIndex];
            playSong(nextSong, currentPlaylist, currentPlaylist, nextIndex);
        }

        function playPrev() {
            if (currentPlaylist.length === 0) return;

            let prevIndex = currentSongIndex - 1;
            if (prevIndex < 0) {
                if (repeatMode === 'all') {
                    prevIndex = currentPlaylist.length - 1; // Loop back to end
                } else {
                    prevIndex = 0; // Stick to the first song
                    currentAudio.currentTime = 0; // Rewind the song
                    return;
                }
            }
            
            const prevSong = currentPlaylist[prevIndex];
            playSong(prevSong, currentPlaylist, currentPlaylist, prevIndex);
        }
        
        function openFullPlayer() {
             if (currentSong) {
                $('#full-player-backdrop').classList.add('active');
                updateFullPlayerDisplay();
             }
        }
        
        // Audio event listeners
        currentAudio.addEventListener('ended', playNext);
        
        currentAudio.addEventListener('timeupdate', () => {
            if (currentSong) {
                const currentTime = currentAudio.currentTime;
                const duration = currentAudio.duration;
                
                $('#full-current-time').textContent = formatTime(currentTime);
                if (isFinite(duration) && duration > 0) {
                    $('#full-duration').textContent = formatTime(duration);
                    const progress = (currentTime / duration) * 100;
                    $('#full-progress-fill').style.width = `${progress}%`;
                } else {
                    $('#full-duration').textContent = '--:--';
                    $('#full-progress-fill').style.width = '0%';
                }
            }
        });

        // --- CRUD/Logic Functions ---

        function toggleFavorite(song) {
            const index = favorites.findIndex(fav => fav.id === song.id);
            if (index > -1) {
                favorites.splice(index, 1);
                alert(`"${song.title}" eliminado de favoritos.`);
            } else {
                favorites.push(song);
                alert(`"${song.title}" añadido a favoritos.`);
            }
            saveData();
            // Re-render relevant lists
            if ($('#favorites-section').classList.contains('active')) renderFavoritesList();
            if ($('#album-detail').classList.contains('active')) renderAlbumDetail(song.albumId);
            updateFullPlayerDisplay();
        }

        function createPlaylist(name) {
            if (playlists.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                alert('Ya existe una playlist con ese nombre.');
                return;
            }
            const newPlaylist = {
                id: getUniqueId(),
                name: name,
                songs: []
            };
            playlists.push(newPlaylist);
            saveData();
            renderPlaylistList();
            alert(`Playlist "${name}" creada con éxito.`);
            closeModal('#create-playlist-modal');
        }

        function deletePlaylist(playlistId) {
            if (!confirm('¿Estás seguro de que quieres eliminar esta playlist?')) return;
            playlists = playlists.filter(p => p.id !== playlistId);
            saveData();
            renderPlaylistList();
        }

        function addToPlaylist(song, playlistId) {
            const playlist = playlists.find(p => p.id === playlistId);
            if (!playlist) return;

            if (playlist.songs.some(s => s.id === song.id)) {
                alert(`"${song.title}" ya está en la playlist "${playlist.name}".`);
                return;
            }
            
            // Clean the song object before saving it to the playlist to prevent bloating.
            const cleanSong = {
                 id: song.id,
                 title: song.title,
                 artist: song.artist,
                 url: song.url,
                 albumId: song.albumId,
                 albumTitle: song.albumTitle,
                 albumArtist: song.albumArtist,
                 albumCover: song.albumCover
            };

            playlist.songs.push(cleanSong);
            saveData();
            alert(`"${song.title}" añadido a "${playlist.name}".`);
            closeModal('#add-to-playlist-modal');
        }
        
        function removeFromPlaylist(songId, playlistId) {
             const playlist = playlists.find(p => p.id === playlistId);
             if (!playlist) return;
             
             playlist.songs = playlist.songs.filter(s => s.id !== songId);
             saveData();
             renderPlaylistDetail(playlistId);
             alert('Canción eliminada de la playlist.');
        }

        // --- Download/Offline Logic ---

        function downloadSong(song) {
            if (downloads.some(dl => dl.id === song.id)) {
                alert(`"${song.title}" ya está descargada.`);
                return;
            }

            // This is a placeholder for a real PWA/Service Worker download logic
            // In a real application, you'd use the Fetch API and Cache API to save the song file.
            alert(`Iniciando descarga de "${song.title}"... (Simulación: Esto no descarga el archivo MP3 real en el navegador)`);
            
            // Simulating a successful download by creating a fake local URL
            const downloadedSong = {
                ...song,
                localFileUrl: song.url // For the demo, we use the remote URL but mark it as local.
            };

            downloads.push(downloadedSong);
            saveData();
            
            alert(`"${song.title}" se ha marcado como descargada.`);
            if ($('#downloads-section').classList.contains('active')) renderDownloadsList();
        }
        
        function deleteDownload(songId) {
            if (!confirm('¿Estás seguro de que quieres eliminar esta descarga local?')) return;
            
            // In a real PWA, you'd also delete the file from the Cache API/IndexedDB
            downloads = downloads.filter(dl => dl.id !== songId);
            saveData();
            
            alert('Descarga eliminada.');
            renderDownloadsList();
        }
        
        // --- Admin Panel Functions ---
        
        function renderAdminPanel() {
            if (!adminMode) {
                $('#admin-section').innerHTML = '<h2 class="section-title" style="text-align:center;"><i class="fa-solid fa-lock"></i> Acceso denegado. <br><small style="color:#b3b3b3;">Activa el modo administrador.</small></h2>';
                return;
            }
            
            // Stats
            $('#stat-albums').textContent = albums.length;
            $('#stat-songs').textContent = songsWithAlbumInfo.length;
            $('#stat-users').textContent = userPin ? '1' : '0'; // Simple user count based on userPin existence
            
            const list = $('#admin-album-list');
            list.innerHTML = '';
            
            if (albums.length === 0) {
                 list.innerHTML = `<p class="no-songs">No hay álbumes para gestionar.</p>`;
                 return;
            }

            albums.forEach(album => {
                const item = document.createElement('div');
                item.className = 'admin-album-item';
                item.innerHTML = `
                    <div class="admin-album-header">
                        <div class="admin-item-info">
                            <strong>${album.title}</strong>
                            <small>${album.artist} (${album.songs.length} canciones)</small>
                            ${album.hidden ? '<span class="hidden-badge" style="background:#ff9800;">Oculto</span>' : ''}
                        </div>
                        <div class="admin-item-actions">
                            <button class="btn-secondary" onclick="toggleAlbumVisibility('${album.id}')">
                                <i class="fa-solid ${album.hidden ? 'fa-eye' : 'fa-eye-slash'}"></i> ${album.hidden ? 'Mostrar' : 'Ocultar'}
                            </button>
                            <button class="btn-danger" onclick="deleteAlbum('${album.id}')"><i class="fa-solid fa-trash"></i> Eliminar Álbum</button>
                        </div>
                    </div>
                    <div class="admin-song-list">
                        ${album.songs.length > 0 ? album.songs.map(song => `
                            <div class="admin-song-item">
                                <span style="flex:1;">${song.title} - ${song.artist}</span>
                                <div class="admin-song-actions">
                                    <button class="btn-danger" onclick="deleteSong('${album.id}', '${song.id}')"><i class="fa-solid fa-trash-can"></i> Eliminar</button>
                                </div>
                            </div>
                        `).join('') : '<p class="no-songs">No hay canciones en este álbum.</p>'}
                    </div>
                `;
                list.appendChild(item);
            });
        }
        
        function createAlbum(title, artist, coverFile) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const newAlbum = {
                    id: getUniqueId(),
                    title: title,
                    artist: artist,
                    cover: e.target.result, // Base64 URL
                    songs: [],
                    hidden: false
                };
                albums.push(newAlbum);
                saveData();
                updateSongsWithAlbumInfo();
                renderAdminPanel();
                alert(`Álbum "${title}" creado.`);
                $('#create-album-form').reset();
            };
            reader.readAsDataURL(coverFile);
        }

        function deleteAlbum(albumId) {
            if (!confirm('¿Estás seguro de que quieres eliminar este álbum y todas sus canciones?')) return;
            albums = albums.filter(a => a.id !== albumId);
            saveData();
            updateSongsWithAlbumInfo();
            renderAdminPanel();
            alert('Álbum eliminado.');
        }
        
        function toggleAlbumVisibility(albumId) {
            const album = albums.find(a => a.id === albumId);
            if (!album) return;
            album.hidden = !album.hidden;
            saveData();
            renderAdminPanel();
            renderAlbumList();
            alert(`Álbum "${album.title}" ahora está ${album.hidden ? 'oculto' : 'visible'}.`);
        }
        
        function deleteSong(albumId, songId) {
            if (!confirm('¿Estás seguro de que quieres eliminar esta canción?')) return;
            const album = albums.find(a => a.id === albumId);
            if (album) {
                album.songs = album.songs.filter(s => s.id !== songId);
                saveData();
                updateSongsWithAlbumInfo();
                renderAdminPanel();
                alert('Canción eliminada del álbum.');
            }
        }
        
        // --- Multi Upload Logic ---
        let fileQueue = [];
        let isUploading = false;
        
        function handleFileSelection(files) {
            fileQueue = [...files].map(file => ({
                id: getUniqueId(),
                file: file,
                status: 'pending', // 'pending', 'uploading', 'success', 'error'
                progress: 0,
                selectedAlbumId: albums.length > 0 ? albums[0].id : null // Default to first album
            }));
            renderFileQueue();
            $('#start-multi-upload-btn').disabled = fileQueue.length === 0;
        }
        
        function renderFileQueue() {
            const queueDiv = $('#file-queue');
            queueDiv.innerHTML = '';
            
            if (fileQueue.length === 0) {
                queueDiv.innerHTML = '<p class="no-songs">Selecciona archivos MP3 para subirlos.</p>';
                return;
            }

            fileQueue.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = `file-queue-item ${item.status}`;
                
                // Select for album
                const albumSelect = `<select data-file-id="${item.id}" onchange="updateFileAlbum(this.value, '${item.id}')" style="background:#555; color:#fff; border:none; padding: 4px; border-radius: 4px;">
                    ${albums.map(a => `<option value="${a.id}" ${item.selectedAlbumId === a.id ? 'selected' : ''}>${a.title}</option>`).join('')}
                </select>`;

                itemDiv.innerHTML = `
                    <div style="flex: 1; min-width: 0;">
                        ${item.file.name} 
                        <span style="font-size: 0.8em; color: #999;">(${Math.round(item.file.size / 1024)} KB)</span>
                        <div class="upload-progress-container" style="${item.status === 'uploading' ? 'display:block;' : 'display:none;'}">
                            <div class="upload-progress-bar"><div class="upload-progress-fill" style="width: ${item.progress}%;"></div></div>
                        </div>
                    </div>
                    ${item.status === 'pending' ? albumSelect : ''}
                    <span style="margin-left: 1rem; flex-shrink: 0;">
                        ${item.status === 'pending' ? '<i class="fa-solid fa-clock" style="color:#ff9800;"></i>' : 
                          item.status === 'uploading' ? '<i class="fa-solid fa-spinner fa-spin" style="color:#fff;"></i>' : 
                          item.status === 'success' ? '<i class="fa-solid fa-check-circle" style="color:#4caf50;"></i>' : 
                          item.status === 'error' ? '<i class="fa-solid fa-times-circle" style="color:#f44336;"></i>' : ''}
                    </span>
                    ${item.status === 'pending' ? `<span class="file-remove" onclick="removeFileFromQueue('${item.id}')"><i class="fa-solid fa-xmark"></i></span>` : ''}
                `;
                queueDiv.appendChild(itemDiv);
            });
        }
        
        function updateFileAlbum(albumId, fileId) {
             const fileItem = fileQueue.find(f => f.id === fileId);
             if (fileItem) {
                 fileItem.selectedAlbumId = albumId;
             }
        }

        function removeFileFromQueue(fileId) {
            fileQueue = fileQueue.filter(f => f.id !== fileId);
            renderFileQueue();
            $('#start-multi-upload-btn').disabled = fileQueue.length === 0;
        }

        async function startMultiUpload() {
            if (isUploading || fileQueue.length === 0) return;
            
            isUploading = true;
            $('#start-multi-upload-btn').disabled = true;
            $('#start-multi-upload-btn').innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Subiendo...';
            $('#batch-upload-progress').style.display = 'block';

            let completedCount = 0;
            const totalFiles = fileQueue.length;
            
            const batchProgressText = $('#batch-progress-text');
            const batchProgressFill = $('#batch-progress-fill');

            for (let i = 0; i < fileQueue.length; i++) {
                const item = fileQueue[i];
                if (item.status !== 'pending') continue;

                item.status = 'uploading';
                renderFileQueue();
                batchProgressText.textContent = `Subiendo: ${i + 1} de ${totalFiles} - ${item.file.name}`;

                // --- Simulation of Song Upload and ID3 Tagging ---
                // In a real app, you'd send the file to a server for processing.
                await new Promise(resolve => setTimeout(resolve, 1500)); // Simulate upload time

                try {
                    // This is a simple mock of ID3 tag reading for the demo
                    const songTitle = item.file.name.split('.mp3')[0] || 'Unknown Title';
                    const [artistName, trackTitle] = songTitle.includes(' - ') ? songTitle.split(' - ') : ['Unknown Artist', songTitle];
                    
                    const newSong = {
                        id: getUniqueId(),
                        title: (trackTitle || songTitle).trim(),
                        artist: (artistName || 'Unknown Artist').trim(),
                        url: `simulated_url_${item.id}.mp3` // Placeholder URL
                    };
                    
                    // Find the target album
                    const targetAlbum = albums.find(a => a.id === item.selectedAlbumId);

                    if (targetAlbum) {
                        // Attach album info to song
                         const songToSave = {
                            ...newSong,
                            albumId: targetAlbum.id,
                            albumTitle: targetAlbum.title,
                            albumArtist: targetAlbum.artist,
                            albumCover: targetAlbum.cover
                        };
                        targetAlbum.songs.push(songToSave);
                        item.status = 'success';
                        completedCount++;
                    } else {
                        throw new Error('Álbum no encontrado.');
                    }
                    
                } catch (error) {
                    console.error('Error during simulated upload:', error);
                    item.status = 'error';
                }
                
                item.progress = 100; // Update progress bar
                batchProgressFill.style.width = `${((i + 1) / totalFiles) * 100}%`;
                renderFileQueue();
            }

            // --- Finalization ---
            isUploading = false;
            saveData();
            updateSongsWithAlbumInfo();
            renderAdminPanel(); // Refresh stats and list
            
            $('#start-multi-upload-btn').disabled = false;
            $('#start-multi-upload-btn').innerHTML = '<i class="fa-solid fa-upload"></i> Iniciar Subida';
            $('#batch-upload-progress').style.display = 'none';
            batchProgressFill.style.width = '0%';
            fileQueue = []; // Clear the queue
            renderFileQueue();
            
            alert(`Carga por lotes finalizada. Éxito: ${completedCount}/${totalFiles}`);
        }
        
        // --- Search Functions ---
        
        function handleSearch(query) {
            const resultsDiv = $('#search-results');
            resultsDiv.innerHTML = '';
            
            if (query.length < 2) {
                resultsDiv.innerHTML = `<p style="color: #b3b3b3; text-align: center;">Introduce al menos 2 caracteres para buscar.</p>`;
                return;
            }
            
            const lowerQuery = query.toLowerCase();
            
            // 1. Search Songs
            const songResults = songsWithAlbumInfo.filter(song => 
                song.title.toLowerCase().includes(lowerQuery) || 
                song.artist.toLowerCase().includes(lowerQuery) || 
                song.albumTitle.toLowerCase().includes(lowerQuery)
            );
            
            if (songResults.length > 0) {
                resultsDiv.innerHTML += `<h3><i class="fa-solid fa-music"></i> Canciones (${songResults.length})</h3>`;
                songResults.forEach(song => {
                    const item = document.createElement('div');
                    item.className = 'search-song-item';
                    item.dataset.songId = song.id;
                    item.innerHTML = `
                        <img class="search-album-img" src="${song.albumCover}" alt="${song.albumTitle} cover">
                        <div class="search-song-info">
                            <div class="search-song-title">${song.title}</div>
                            <div class="search-song-artist">${song.artist} | ${song.albumTitle}</div>
                        </div>
                        <span class="fa-solid fa-play play-icon" data-song='${JSON.stringify(song)}' title="Reproducir"></span>
                    `;
                    resultsDiv.appendChild(item);
                });
            }
            
            // 2. Search Albums
            const albumResults = albums.filter(album => 
                album.title.toLowerCase().includes(lowerQuery) || 
                album.artist.toLowerCase().includes(lowerQuery)
            );
            
            if (albumResults.length > 0) {
                 resultsDiv.innerHTML += `<h3><i class="fa-solid fa-compact-disc"></i> Álbumes (${albumResults.length})</h3>`;
                 const albumGrid = document.createElement('div');
                 albumGrid.className = 'album-grid';
                 
                 albumResults.forEach(album => {
                    const card = document.createElement('div');
                    card.className = 'album-card';
                    card.dataset.albumId = album.id;
                    card.onclick = () => renderAlbumDetail(album.id);
                    
                    card.innerHTML = `
                        <img class="album-img" src="${album.cover}" alt="${album.title} cover">
                        <div class="album-title">${album.title}</div>
                        <div class="album-artist">${album.artist}</div>
                    `;
                    albumGrid.appendChild(card);
                 });
                 resultsDiv.appendChild(albumGrid);
            }
            
            if (songResults.length === 0 && albumResults.length === 0) {
                resultsDiv.innerHTML = `<p style="color: #b3b3b3; text-align: center;">No se encontraron resultados para "${query}".</p>`;
            }
        }


        // --- Initialization and Event Listeners ---
        
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            updateSongsWithAlbumInfo();
            applyTheme(theme);
            renderAlbumList(); // Initial view is Home
            renderUserDropdown(); // Initial user state

            // --- Navigation ---
            $$('.bottom-nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const sectionId = item.dataset.section;
                    showSection(sectionId);
                });
            });

            // --- Theme Selector ---
            $('#theme-select').addEventListener('change', (e) => {
                applyTheme(e.target.value);
            });
            
            // --- Search Input ---
            $('#search-input').addEventListener('input', (e) => {
                handleSearch(e.target.value.trim());
            });

            // --- Modals and General UI ---
            $$('.close-modal').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    closeModal(e.target.closest('.modal').id);
                });
            });

            // --- Login/Registration Forms ---
            $('#login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const pin = $('#login-pin').value;
                if (pin === userPin) {
                    loggedIn = true;
                    closeModal('#login-modal');
                    renderUserDropdown();
                    alert('Acceso exitoso.');
                    
                    // Check if admin pin matches for admin mode shortcut
                    if (adminPin && pin === adminPin) {
                        setAdminMode(true);
                    }
                } else {
                    alert('PIN incorrecto. Inténtalo de nuevo.');
                }
            });
            
            $('#registration-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const pin = $('#register-pin').value;
                if (pin.length !== 4 || isNaN(pin)) {
                    alert('El PIN debe ser de 4 dígitos numéricos.');
                    return;
                }
                userPin = pin;
                localStorage.setItem('userPin', pin);
                loggedIn = true;
                closeModal('#login-modal');
                renderUserDropdown();
                alert('Registro exitoso. ¡Bienvenido!');
            });
            
             $('#admin-pin-set-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const pin = $('#admin-register-pin').value;
                if (pin.length !== 4 || isNaN(pin)) {
                    alert('El PIN de Admin debe ser de 4 dígitos numéricos.');
                    return;
                }
                adminPin = pin;
                localStorage.setItem('adminPin', pin);
                
                // If userPin is not set, set it to the admin pin and log in
                if (!userPin) {
                    userPin = pin;
                    localStorage.setItem('userPin', pin);
                    loggedIn = true;
                }
                
                closeModal('#login-modal');
                renderUserDropdown();
                alert('PIN de Administrador establecido con éxito.');
            });
            
            $('#forgot-pin-link').addEventListener('click', (e) => {
                 e.preventDefault();
                 alert('Esta es una función de demostración. En una aplicación real, se enviaría un correo electrónico o se usaría otra forma de recuperación de contraseña. Por ahora, si olvidaste tu PIN en esta demo, borra los datos de almacenamiento local de tu navegador.');
            });

            // --- User Menu Dropdown Toggle ---
            $('#user-avatar').addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent document click from closing it instantly
                $('#user-dropdown').classList.toggle('show');
            });
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#user-menu')) {
                    $('#user-dropdown').classList.remove('show');
                }
            });


            // --- Player Controls ---
            
            // Mini Player Controls
            $('#play-pause-btn-inline').addEventListener('click', togglePlayPause);
            $('#next-btn-inline').addEventListener('click', playNext);
            $('#prev-btn-inline').addEventListener('click', playPrev);

            // Full Player Controls
            $('#full-player-close').addEventListener('click', () => $('#full-player-backdrop').classList.remove('active'));
            $('#play-pause-btn-full').addEventListener('click', togglePlayPause);
            $('#next-btn-full').addEventListener('click', playNext);
            $('#prev-btn-full').addEventListener('click', playPrev);
            $('#shuffle-btn-full').addEventListener('click', () => alert('Función de "Aleatorio" no implementada en la demo.'));
            
            $('#repeat-btn-full').addEventListener('click', () => {
                if (repeatMode === 'none') {
                    repeatMode = 'all';
                    alert('Repetir: Playlist Completa');
                } else if (repeatMode === 'all') {
                    repeatMode = 'one';
                    alert('Repetir: Una Canción');
                } else {
                    repeatMode = 'none';
                    alert('Repetir: Desactivado');
                }
                updateFullPlayerDisplay();
            });

            // Progress Bar seek
            $('#full-progress-bar').addEventListener('click', (e) => {
                if (currentSong && isFinite(currentAudio.duration) && currentAudio.duration > 0) {
                    const rect = e.currentTarget.getBoundingClientRect();
                    const clickX = e.clientX - rect.left;
                    const percent = clickX / rect.width;
                    currentAudio.currentTime = currentAudio.duration * percent;
                }
            });
            
            // Volume Slider
            $('#full-volume-slider').addEventListener('input', (e) => {
                currentAudio.volume = e.target.value;
            });
            currentAudio.volume = $('#full-volume-slider').value; // Set initial volume

            // Mode Buttons
            $('#mode-fav-btn').addEventListener('click', () => {
                if (currentSong) toggleFavorite(currentSong);
            });
            
            $('#mode-playlist-btn').addEventListener('click', () => {
                if (currentSong) {
                    openModal('#add-to-playlist-modal');
                    const list = $('#playlist-select-list');
                    list.innerHTML = playlists.map(p => 
                        `<li data-playlist-id="${p.id}" data-song='${JSON.stringify(currentSong)}'>${p.name} (${p.songs.length})</li>`
                    ).join('');
                }
            });
            
            $('#mode-download-btn').addEventListener('click', () => {
                 if (currentSong) downloadSong(currentSong);
            });


            // --- Playlist Forms ---
            
            $('#create-playlist-btn').addEventListener('click', () => openModal('#create-playlist-modal'));

            $('#playlist-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const name = $('#playlist-name').value.trim();
                if (name) createPlaylist(name);
            });

            // General click listener for dynamically added elements (Favorites, Playlists, Songs)
            document.addEventListener('click', (e) => {
                
                // ADD TO PLAYLIST SELECTION
                const playlistSelectLi = e.target.closest('#playlist-select-list li');
                if (playlistSelectLi) {
                    const song = JSON.parse(playlistSelectLi.dataset.song);
                    const playlistId = playlistSelectLi.dataset.playlistId;
                    addToPlaylist(song, playlistId);
                    return;
                }

                // TOGGLE FAVORITE
                if (e.target.matches('.toggle-favorite')) {
                    const song = JSON.parse(e.target.dataset.song);
                    toggleFavorite(song);
                    return;
                }
                
                // DOWNLOAD SONG
                 if (e.target.matches('.download-song')) {
                    const song = JSON.parse(e.target.dataset.song);
                    downloadSong(song);
                    return;
                }
                
                // DELETE DOWNLOAD
                if (e.target.matches('.delete-download')) {
                    const songId = e.target.dataset.songId;
                    deleteDownload(songId);
                    return;
                }

                // REMOVE FROM PLAYLIST
                if (e.target.matches('.remove-from-playlist')) {
                    const songId = e.target.dataset.songId;
                    const playlistId = e.target.dataset.playlistId;
                    removeFromPlaylist(songId, playlistId);
                    return;
                }

                // DELETE PLAYLIST
                if (e.target.matches('.delete-playlist')) {
                    const playlistId = e.target.dataset.playlistId;
                    deletePlaylist(playlistId);
                    return;
                }
                
                // ADD TO PLAYLIST BUTTON (from song list)
                if (e.target.matches('.add-to-playlist')) {
                    const song = JSON.parse(e.target.dataset.song);
                    openModal('#add-to-playlist-modal');
                    const list = $('#playlist-select-list');
                    list.innerHTML = playlists.map(p => 
                        `<li data-playlist-id="${p.id}" data-song='${JSON.stringify(song)}'>${p.name} (${p.songs.length})</li>`
                    ).join('');
                    return;
                }
                
                // --- Reproduction Triggers (must be last) ---
                
                // Play song from Album Detail List
                const songLi = e.target.closest('#songs-of-album-list li');
                if (songLi) {
                    const albumId = songLi.dataset.albumId;
                    const album = albums.find(a => a.id === albumId);
                    const index = parseInt(songLi.dataset.songIndex);
                    if (album && !isNaN(index)) {
                         // Find the song with full album info
                         const song = songsWithAlbumInfo.find(s => s.id === songLi.dataset.songId);
                         if (song) playSong(song, album.songs, album.songs, index);
                    }
                    return;
                }
                
                // Play song from Playlist Detail List
                const playlistSongLi = e.target.closest('#songs-of-playlist-list li');
                if (playlistSongLi) {
                    const playlistId = playlistSongLi.dataset.playlistId;
                    const playlist = playlists.find(p => p.id === playlistId);
                    const index = parseInt(playlistSongLi.dataset.songIndex);
                    if (playlist && !isNaN(index)) {
                         const song = playlist.songs[index];
                         playSong(song, playlist.songs, playlist.songs, index);
                    }
                    return;
                }
                
                // Play button (general, like from Favorites or Search result)
                if (e.target.matches('.play-icon') && e.target.dataset.song) {
                    const song = JSON.parse(e.target.dataset.song);
                    
                    // Default to playing a single song from its context
                    playSong(song, [song], [song], 0);
                    return;
                }
                
                // Play song from Search Result Item
                const searchSongItem = e.target.closest('.search-song-item');
                if (searchSongItem && !e.target.matches('.play-icon')) {
                    const song = songsWithAlbumInfo.find(s => s.id === searchSongItem.dataset.songId);
                    if (song) playSong(song, [song], [song], 0);
                    return;
                }
                
                // Play song from Favorite Item
                const favoriteItem = e.target.closest('.favorite-item');
                if (favoriteItem && !e.target.matches('.play-icon')) {
                    const song = JSON.parse(favoriteItem.dataset.song);
                    if(song) playSong(song, [song], [song], 0);
                    return;
                }
                
                // Play song from Download Item
                const downloadItem = e.target.closest('.download-item');
                if (downloadItem && !e.target.matches('.play-icon')) {
                    const song = JSON.parse(downloadItem.dataset.song);
                    if(song) playSong(song, [song], [song], 0);
                    return;
                }

                if (e.target.closest('#mini-player') && !e.target.closest('.player-controls-inline')) { openFullPlayer(); }
            });
            
            // --- Admin Panel Listeners ---
            
            // Lock icon to toggle admin section display (for quick access if PIN is set)
            $('#lock-icon').addEventListener('click', () => {
                if (adminPin) {
                    openModal('#login-modal');
                    $('#login-form').style.display = 'block';
                    $('#registration-form').style.display = 'none';
                    $('#admin-pin-set-form').style.display = 'none';
                    $('#login-pin').value = '';
                    
                    // If already logged in, but not in admin mode, require admin pin
                    if (loggedIn && userPin !== adminPin) {
                         alert('Introduce el PIN de Administrador para acceder.');
                    } else if (loggedIn && adminPin === userPin) {
                        // User is logged in as admin, just toggle the mode
                        setAdminMode(!adminMode);
                        if(adminMode) showSection('admin-section');
                    }

                } else {
                    alert('Por favor, configura un PIN de administrador primero.');
                    openModal('#login-modal');
                    $('#login-form').style.display = 'none';
                    $('#registration-form').style.display = 'none';
                    $('#admin-pin-set-form').style.display = 'block';
                }
            });
            
            // Album Creation
            $('#create-album-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const title = $('#album-title-admin').value.trim();
                const artist = $('#album-artist-admin').value.trim();
                const coverFile = $('#album-cover-admin').files[0];
                
                if (title && artist && coverFile) {
                    createAlbum(title, artist, coverFile);
                } else {
                    alert('Por favor, rellena todos los campos para el álbum.');
                }
            });
            
            // Multi Upload Handlers
            $('#multi-upload-files').addEventListener('change', (e) => {
                handleFileSelection(e.target.files);
            });
            
            $('#multi-upload-form').addEventListener('submit', (e) => {
                e.preventDefault();
                startMultiUpload();
            });
            
        });
    </script>
    <script async="async" data-cfasync="false" src="//pl27638112.revenuecpmgate.com/2f9b36b527e21b2d6323dcdd425f8...@keyframes dropdownFadeIn { 
    from { 
        opacity: 0; 
        transform: translateY(-10px); 
    } 
    to { 
        opacity: 1; 
        transform: translateY(0); 
    } 
}
    </style>
</head>

<body>
    <script>
        // ... (Tu código JavaScript que estaba completo) ...
    </script>
    
    <script async="async" data-cfasync="false" src="//pl27638112.revenuecpmgate.com/2f9b36b527e21b2d6323dcdd425f8.js"></script> 
    
    </body>
</html>
