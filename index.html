<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>KLMZ MUSIC</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  
  <!-- SDK Appwrite -->
  <script src="https://cdn.jsdelivr.net/npm/appwrite@13/dist/appwrite.umd.js"></script>
  
  <style>
  *{box-sizing:border-box}
  body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#181818;color:#fff;padding-bottom:2rem}
  header{background:#121212;padding:1rem;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;border-bottom:1px solid #333}
  .logo{font-weight:700;font-size:1.4rem;color:#1DB954}
  .lock-icon{cursor:pointer;font-size:1.4rem;padding:0.5rem;border-radius:8px;transition:background 0.2s}
  .lock-icon:hover{background:#333}
  main{padding:1rem;max-width:1200px;margin:0 auto}
  .section-title{font-size:1.8rem;font-weight:700;margin:1.5rem 0;color:#fff}
  .album-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:1.5rem;margin-top:2rem}
  .album-card{text-align:center;cursor:pointer;padding:1.5rem;border-radius:12px;background:#282828;transition:all 0.3s ease;border:1px solid transparent}
  .album-card:hover{transform:translateY(-4px);background:#333;border-color:#1DB954;box-shadow:0 8px 25px rgba(29,185,84,0.3)}
  .album-img{width:140px;height:140px;border-radius:8px;object-fit:cover;margin-bottom:1rem;background:#444;border:2px solid #555}
  .album-title{font-weight:600;margin-bottom:0.5rem;font-size:1rem;color:#fff}
  .album-artist{color:#b3b3b3;font-size:0.9rem}
  .loading{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.95);color:#fff;padding:2rem 3rem;border-radius:12px;border:2px solid #1DB954;font-size:1.1rem;z-index:1000}
  .status{margin:2rem 0;padding:1.5rem;border-radius:12px;font-family:monospace;font-size:0.95rem;border-left:4px solid #1DB954}
  .status.error{background:#2d1517;color:#ff6b6b;border-left-color:#ff6b6b}
  .status.success{background:#1a2e1a;color:#51cf66;border-left-color:#51cf66}
  .status.info{background:#1e2833;color:#74c0fc;border-left-color:#74c0fc}
  .empty-state{text-align:center;padding:4rem 2rem;color:#666}
  .empty-state h2{color:#999;margin-bottom:1rem}
  </style>
</head>

<body>
  <header>
    <span class="logo">üéµ KLMZ MUSIC</span>
    <div class="lock-icon" id="lockIcon">üîí</div>
  </header>

  <main>
    <h1 class="section-title">√Ålbumes</h1>
    
    <div id="status" class="status info">
      üîÑ Inicializando conexi√≥n con Appwrite...
    </div>
    
    <div id="albums" class="album-grid"></div>
  </main>

  <div id="loading" class="loading" hidden>
    <div>üéµ Cargando...</div>
  </div>

  <script>
    // üîß CONFIGURACI√ìN KLMZ MUSIC
    const CONFIG = {
      endpoint: 'https://nyc.cloud.appwrite.io/v1',
      projectId: '68ab0cf2000365979a71',
      databaseId: '68ab0d9b00124af501a5',
      albumsCollectionId: '68ab0dd00024ddeb51fd',
      songsCollectionId: '68ab0f0e002d9f334b0d',
      bucketId: '68ab1101001cff947e6b'
    };

    // üõ†Ô∏è Utilidades
    const $ = id => document.getElementById(id);
    const show = el => el.hidden = false;
    const hide = el => el.hidden = true;

    function setStatus(message, type = 'info') {
      const status = $('status');
      const emoji = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : 'üîÑ';
      status.innerHTML = `${emoji} ${message}`;
      status.className = `status ${type}`;
    }

    // üöÄ Inicializaci√≥n
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('üéµ KLMZ MUSIC iniciando...');
      
      // Verificar SDK
      if (typeof Appwrite === 'undefined') {
        setStatus('Error: SDK de Appwrite no se pudo cargar desde el CDN', 'error');
        return;
      }
      
      console.log('‚úÖ SDK de Appwrite cargado correctamente');
      
      // Configurar cliente Appwrite
      const { Client, Databases, Storage, Account } = Appwrite;
      
      const client = new Client()
        .setEndpoint(CONFIG.endpoint)
        .setProject(CONFIG.projectId);
      
      const databases = new Databases(client);
      const storage = new Storage(client);
      const account = new Account(client);
      
      // Probar conexi√≥n con Appwrite
      setStatus('Verificando conexi√≥n con Appwrite...');
      
      try {
        await account.get();
        setStatus('Conectado con sesi√≥n de usuario activa', 'success');
        $('lockIcon').textContent = 'üë§';
      } catch (error) {
        if (error.code === 401) {
          setStatus('Conectado como visitante (CORS configurado correctamente)', 'success');
          console.log('‚úÖ CORS funcionando - visitante sin sesi√≥n');
        } else {
          setStatus(`Error de conexi√≥n: ${error.message}`, 'error');
          console.error('‚ùå Error de conexi√≥n:', error);
          return;
        }
      }
      
      // Cargar √°lbumes
      await loadAlbums();
      
      // üìÄ Funci√≥n para cargar √°lbumes
      async function loadAlbums() {
        setStatus('Cargando √°lbumes desde la base de datos...');
        show($('loading'));
        
        try {
          console.log('üì° Consultando colecci√≥n de √°lbumes...');
          
          const response = await databases.listDocuments(
            CONFIG.databaseId, 
            CONFIG.albumsCollectionId
          );
          
          console.log(`üìÄ Respuesta obtenida: ${response.documents.length} √°lbum(es)`);
          
          if (response.documents.length === 0) {
            $('albums').innerHTML = `
              <div class="empty-state">
                <h2>üéµ No hay √°lbumes disponibles</h2>
                <p>Agrega algunos √°lbumes desde el panel de administraci√≥n</p>
              </div>
            `;
            setStatus('Base de datos lista pero sin √°lbumes todav√≠a', 'info');
          } else {
            displayAlbums(response.documents);
            setStatus(`${response.documents.length} √°lbum(es) cargado(s) correctamente`, 'success');
          }
          
        } catch (error) {
          console.error('‚ùå Error cargando √°lbumes:', error);
          
          if (error.code === 404) {
            setStatus('Collection de √°lbumes no encontrada - verifica los IDs', 'error');
          } else if (error.code === 401) {
            setStatus('Sin permisos para leer √°lbumes - configura permisos p√∫blicos', 'error');
          } else {
            setStatus(`Error cargando √°lbumes: ${error.message}`, 'error');
          }
          
          $('albums').innerHTML = `
            <div class="empty-state">
              <h2>‚ùå Error al cargar √°lbumes</h2>
              <p>Revisa la configuraci√≥n de Appwrite y los permisos</p>
            </div>
          `;
        }
        
        hide($('loading'));
      }
      
      // üé® Mostrar √°lbumes en la interfaz
      function displayAlbums(albums) {
        console.log('üé® Renderizando √°lbumes en la interfaz...');
        
        $('albums').innerHTML = albums.map(album => {
          try {
            const coverUrl = storage.getFilePreview(
              CONFIG.bucketId, 
              album.coverStorageId, 
              300, 300,
              'center', 85
            );
            
            return `
              <div class="album-card" onclick="selectAlbum('${album.$id}', '${album.name}')">
                <img class="album-img" 
                     src="${coverUrl}" 
                     alt="Portada de ${album.name}" 
                     loading="lazy"
                     onerror="this.style.background='#444'; this.src='data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"140\" height=\"140\" fill=\"%23666\"><text x=\"50%\" y=\"50%\" text-anchor=\"middle\" dy=\".3em\" font-size=\"40\">üéµ</text></svg>'" />
                <div class="album-title">${album.name}</div>
                <div class="album-artist">${album.artistName}</div>
              </div>
            `;
          } catch (error) {
            console.warn('‚ö†Ô∏è Error procesando √°lbum:', album, error);
            return '';
          }
        }).join('');
        
        console.log('‚úÖ √Ålbumes renderizados correctamente');
      }
      
      // üéµ Funci√≥n para seleccionar un √°lbum (placeholder)
      window.selectAlbum = function(albumId, albumName) {
        console.log(`üéµ √Ålbum seleccionado: ${albumName} (ID: ${albumId})`);
        setStatus(`√Ålbum seleccionado: "${albumName}"`, 'info');
        
        // Aqu√≠ puedes agregar la l√≥gica para:
        // - Mostrar las canciones del √°lbum
        // - Crear un reproductor
        // - Navegar a una vista detallada
      };
      
      // üîê Manejar clic en icono de login (placeholder)
      $('lockIcon').addEventListener('click', () => {
        console.log('üîê Login/register clicked');
        setStatus('Funcionalidad de login en desarrollo', 'info');
      });
    });
  </script>
</body>
</html>
