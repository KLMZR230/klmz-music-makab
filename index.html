<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KLMZ MUSIC</title>
<meta name="theme-color" content="#1db954" />
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
/* ...[Mismos estilos previos, sin cambios, incluye back-btn, grids, players, etc.]... */
body{margin:0;background: #121212;color:#fff;font-family:sans-serif;padding-bottom:40px;}
#homeContent,#searchView,#playlistsView{display:none}
.back-btn{background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:#fff;width:32px;height:32px;border-radius:8px;font-size:16px;display:grid;place-items:center;cursor:pointer;margin-right:12px;}
.back-btn:hover{background:rgba(255,255,255,0.18);}
.backline{display:flex;align-items:center;margin-bottom:12px;}
.grid.albums{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;}
.grid.playlists{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;}
.album-card,.playlist-card{background:#252525;padding:12px;border-radius:14px;text-align:center;cursor:pointer;}
input[type="text"]{border-radius:8px;padding:8px 12px;width:100%;font-size:15px;border:1px solid #2c2c2c;background:#181818;color:#fff;margin-bottom:12px;}
.btn{background:#1db954;color:#fff;border:none;border-radius:8px;padding:7px 15px;cursor:pointer;}
.btn.ghost{background:rgba(255,255,255,0.1);color:#fff;}
.section-title{font-size:20px;font-weight:800;margin-bottom:8px;}
.no-results{text-align:center;color:#aaa;margin-top:40px;}
#bottomBar{position:fixed;bottom:0;left:0;width:100%;background:#191919;border-top:1px solid #232323;z-index:10;display:grid;grid-template-columns:1fr 1fr 1fr 1fr;height:40px;}
#bottomBar button{border:none;background:transparent;color:#bbb;font-size:10px;font-weight:600;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:2px 0;cursor:pointer;}
#bottomBar button.active,#bottomBar button:focus{color:#1db954;}
#bottomBar .icon{width:18px;height:18px;fill:none;stroke:currentColor;}

@media (max-width: 600px) { .grid.albums{grid-template-columns:repeat(3,1fr);} .grid.playlists{grid-template-columns:1fr;}}
</style>
</head>
<body>
<div id="loadingScreen" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:10000;background:#191919;color:#fff;">
  <div>Cargando...</div>
</div>

<header>
  <div style="padding:10px 13px 6px;font-size:18px;font-weight:800;letter-spacing:1px;color:#1db954;">KLMZ MUSIC</div>
</header>
<div class="container" style="padding:13px">

  <div id="homeContent">
    <div class="section-title">Albums</div>
    <div id="albumsGrid" class="grid albums"></div>
    <div id="emptyAlbums" class="no-results" style="display:none">No hay √°lbumes todav√≠a</div>
  </div>

  <div id="searchView">
    <div class="backline">
      <button class="back-btn" onclick="goHome()" title="Volver">‚Üê</button>
      <span style="font-size:13px;">Volver</span>
    </div>
    <div class="section-title">Buscar Canci√≥n</div>
    <input id="searchInput" type="text" autocomplete="off" placeholder="Busca t√≠tulo, artista o √°lbum..." oninput="doSearch()">
    <div id="searchResults" class="grid albums"></div>
    <div id="noSearchResults" class="no-results" style="display:none">No hay resultados</div>
  </div>
  
  <div id="playlistsView">
    <div class="backline">
      <button class="back-btn" onclick="goHome()" title="Volver">‚Üê</button>
      <span style="font-size:13px;">Volver</span>
    </div>
    <div class="section-title">Tus Playlists</div>
    <div id="playlistsGrid" class="grid playlists"></div>
    <div id="emptyPlaylists" class="no-results" style="display:none">No tienes playlists a√∫n</div>
  </div>
</div>

<!-- Player y BottomBar -->
<div id="bottomBar">
  <button id="btn-home" onclick="goHome();"><svg class="icon" viewBox="0 0 24 24"><path d="M3 11L12 2l9 9v9a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2v-5H9v5a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-9z"/></svg><span>Inicio</span></button>
  <button id="btn-search" onclick="showSearch();"><svg class="icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="7"/><line x1="16.5" y1="16.5" x2="21" y2="21"/></svg><span>Buscar</span></button>
  <button id="btn-playlists" onclick="showPlaylists();"><svg class="icon" viewBox="0 0 24 24"><path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/></svg><span>Playlists</span></button>
  <button id="btn-account" onclick="showAccount();"><svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="7" r="4"/><path d="M5.5 21a7.5 7.5 0 0 1 13 0"/></svg><span>Cuenta</span></button>
</div>
<audio id="audio"></audio>
<script>
const SUPABASE_URL = "https://nqbldvpnqhngdtalvzov.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xYmxkdnBucWhuZ2R0YWx2em92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyMjY0NjUsImV4cCI6MjA3MDgwMjQ2NX0.Zzg5D219sW7bhvl0_R5ypX9MF6nRzBSDIeo2Lvebab0";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
let albums = [], songsByAlbum = {}, flatSongs = [], playlists = [];

function showView(viewId) {
  ["homeContent","searchView","playlistsView"].forEach(id=>{
    document.getElementById(id).style.display = id===viewId ? "block":"none";
  });
  Array.from(document.querySelectorAll("#bottomBar button")).forEach(btn=>{
    btn.classList.remove("active");
  });
  if(viewId==="homeContent") document.getElementById("btn-home").classList.add("active");
  if(viewId==="searchView") document.getElementById("btn-search").classList.add("active");
  if(viewId==="playlistsView") document.getElementById("btn-playlists").classList.add("active");
}
function goHome() { showView("homeContent"); }
function showSearch() {
  showView("searchView");
  document.getElementById("searchInput").focus();
  doSearch();
}
function showPlaylists() {
  showView("playlistsView");
  renderPlaylists();
}
function showAccount() {
  showView("homeContent");
  alert("Gesti√≥n de cuenta pr√≥ximamente.");
}

async function refreshCatalog() {
  const {data:albumsData} = await sb.from('albums').select("*").order('created_at',{ascending:false}).limit(30);
  albums = albumsData||[];
  songsByAlbum = {};
  flatSongs = [];
  for(const album of albums){
    const {data:songsData} = await sb.from("songs").select("*").eq("album_id",album.id).order("created_at",{ascending:true});
    songsByAlbum[album.id] = songsData||[];
    (songsData||[]).forEach(s=>flatSongs.push({...s, album, cover_url:album.cover_url}));
  }
  renderAlbums();
}
function renderAlbums(){
  const grid = document.getElementById("albumsGrid");
  if(!grid) return;
  grid.innerHTML = "";
  if(albums.length === 0){document.getElementById("emptyAlbums").style.display="block"; return;}
  document.getElementById("emptyAlbums").style.display="none";
  albums.forEach(album=>{
    const n = (songsByAlbum[album.id]?.length)||0;
    const card = document.createElement('div');
    card.className = "album-card";
    card.innerHTML =
      `<img class="album-cover" src="${album.cover_url||""}" alt="${album.title}" loading="lazy">
      <div class="album-title">${album.title}</div>
      <div class="album-meta">${album.artist||"Sin artista"} ‚Ä¢ ${n}</div>
      `;
    card.onclick=()=>openAlbumView(album);
    grid.appendChild(card);
  });
}
function openAlbumView(album){
  // Cerrar anteriores
  const old = document.getElementById("albumExpansion");
  if(old) old.remove();
  const parent = document.getElementById("albumsGrid");
  const songs = songsByAlbum[album.id]||[];
  // Crear expansi√≥n con back
  const div = document.createElement("div");
  div.id="albumExpansion"; div.className = "album-expansion";
  div.innerHTML = `
    <div class="backline"><button class="back-btn" onclick="removeAlbumExpansion()">‚Üê</button>
      <span style="font-size:13px;">Volver</span></div>
    <div style="display:flex;gap:12px;align-items:center;margin-bottom:16px;">
      <img src="${album.cover_url||""}" style="width:70px;height:70px;border-radius:12px;">
      <div>
        <h3 style="margin:0 0 4px;font-size:18px;font-weight:800;color:var(--brand);">${album.title}</h3>
        <p style="margin:0 0 7px;color:#bbb;font-size:12px;">${album.artist||'Sin artista'} ‚Ä¢ ${songs.length} canciones</p>
        <div style="display:flex;gap:8px;">
          <button class="btn small" onclick="playAllFromAlbum('${album.id}')">‚ñ∂ Todo</button>
          <button class="btn small ghost" onclick="removeAlbumExpansion()">‚úï</button>
        </div>
      </div></div>
    <div class="songs-list-container">
      ${songs.map((song,i)=>`
        <div class="song-plain-item" onclick="playAlbumSong('${album.id}',${i})">
          <div style="display:flex;align-items:center;gap:10px;">
            <div style="width:22px;text-align:center;color:#aaa;font-weight:600;">${i+1}</div>
            <div style="flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${song.title}</div>
            <button class="favorite-btn" onclick="event.stopPropagation();alert('Favoritos pr√≥ximamente')">ü§ç</button>
          </div>
        </div>
      `).join("")}
      ${songs.length===0?'<div class="no-results">No hay canciones en este √°lbum</div>':''}
    </div>
  `;
  parent.parentNode.insertBefore(div,parent.nextSibling);
  setTimeout(()=>div.scrollIntoView({behavior:'smooth',block:'nearest'}),100);
}
function removeAlbumExpansion(){
  const old = document.getElementById("albumExpansion");
  if(old) old.remove();
}
function playAllFromAlbum(albumId){
  const album = albums.find(a=>a.id===albumId);
  if(!album) return;
  const songs = songsByAlbum[albumId]||[];
  if(!songs.length) return;
  queue = songs.map(s=>({...s, album_title:album.title, cover_url:album.cover_url}));
  qIndex = 0;
  playTrack(queue[qIndex]);
}
function playAlbumSong(albumId,songIndex){
  const album = albums.find(a=>a.id===albumId);
  if(!album) return;
  const songs = songsByAlbum[albumId]||[];
  queue = songs.map(s=>({...s, album_title:album.title, cover_url:album.cover_url}));
  qIndex=parseInt(songIndex,10)||0;
  playTrack(queue[qIndex]);
}
function playTrack(song){
  const audio = document.getElementById("audio");
  audio.pause();
  audio.src = song.song_url;
  audio.currentTime = 0;
  audio.play();
}
document.getElementById("audio").addEventListener("ended",()=>{ if(queue && queue.length>0){ qIndex=(qIndex+1)%queue.length; playTrack(queue[qIndex]); }});

function doSearch(){
  const q = (document.getElementById("searchInput").value||"").toLowerCase();
  const res = q.length>1
    ? flatSongs.filter(s =>
        (s.title||"").toLowerCase().includes(q) ||
        (s.album?.title||"").toLowerCase().includes(q) ||
        (s.album?.artist||"").toLowerCase().includes(q)
      )
    : [];
  const grid = document.getElementById("searchResults");
  grid.innerHTML = "";
  document.getElementById("noSearchResults").style.display = (res.length===0 && q)? "block":"none";
  res.forEach(song=>{
    const div = document.createElement('div');
    div.className = "album-card";
    div.innerHTML = `<img class="album-cover" src="${song.cover_url||''}"><div class="album-title">${song.title}</div><div class="album-meta">${song.album?.artist||'Artista'}</div>`;
    div.onclick=()=>{ queue=[song];qIndex=0; playTrack(song); };
    grid.appendChild(div);
  });
}

async function renderPlaylists(){
  // Simula playlists, coloca aqu√≠ tu l√≥gica real de carga
  const grid = document.getElementById("playlistsGrid");
  grid.innerHTML = "";
  grid.innerHTML = playlists.length
    ? playlists.map(pl=>`<div class="playlist-card">${pl.name}</div>`).join("")
    : '';
  document.getElementById("emptyPlaylists").style.display = playlists.length===0?"block":"none";
}

setTimeout(() => document.getElementById('loadingScreen').style.display='none',1200);
refreshCatalog().then(goHome);
</script>
</body>
</html>
