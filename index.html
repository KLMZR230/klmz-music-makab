<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KLMZ MUSIC</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --color-bg: #121212;
      --color-sidebar: #000;
      --color-primary: #1db954;
      --color-secondary: #282828;
      --color-card: #181818;
      --color-text-main: #fff;
      --color-text-dark: #b3b3b3;
      --color-text-muted: #8d8d8d;
    }
    body {
      margin: 0;
      font-family: 'Montserrat', Arial, sans-serif;
      background: var(--color-bg);
      color: var(--color-text-main);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .container {
      display: flex;
      flex: 1;
    }
    aside {
      width: 220px;
      background: var(--color-sidebar);
      display: flex;
      flex-direction: column;
      padding: 28px 16px;
      min-height: 100vh;
      box-sizing: border-box;
      border-right: 1px solid #222;
    }
    .logo {
      font-weight: 900;
      font-size: 28px;
      color: var(--color-primary);
      margin-bottom: 40px;
      letter-spacing: -1px;
      text-align: center;
    }
    .side-menu a {
      color: var(--color-text-dark);
      text-decoration: none;
      font-size: 17px;
      display: flex;
      align-items: center;
      margin-bottom: 22px;
      font-weight: 500;
      transition: color .2s;
    }
    .side-menu a.active,
    .side-menu a:hover {
      color: var(--color-primary);
    }
    main {
      flex: 1;
      background: var(--color-bg);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 40px 16px 40px;
      background: var(--color-bg);
      border-bottom: 1px solid #232323;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .search-bar {
      width: 320px;
      background: var(--color-secondary);
      border-radius: 20px;
      display: flex;
      align-items: center;
      padding: 6px 16px;
      color: var(--color-text-dark);
    }
    .search-bar input {
      border: none;
      background: transparent;
      outline: none;
      color: var(--color-text-main);
      font-size: 16px;
      width: 90%;
      margin-left: 8px;
    }
    .albums-section {
      padding: 32px 40px;
    }
    .albums-title {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 30px;
    }
    .albums {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
      gap: 28px;
    }
    .album {
      background: var(--color-card);
      border-radius: 10px;
      padding: 20px 20px 18px 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      transition: background .2s, transform .1s;
      box-shadow: 0 2px 10px 0 #0009;
    }
    .album:hover {
      background: #232323;
      transform: translateY(-2px) scale(1.02);
    }
    .album img {
      width: 100%;
      height: 160px;
      object-fit: cover;
      border-radius: 7px;
      box-shadow: 0 2px 12px #0005;
    }
    .albumName {
      font-size: 16px;
      font-weight: 600;
      margin: 17px 0 3px;
      text-align: center;
    }
    .albumSongs {
      color: var(--color-text-dark);
      font-size: 12px;
      margin-bottom: 8px;
      text-align: center;
    }
    .play-btn {
      margin-top: 8px;
      background: var(--color-primary);
      border: none;
      border-radius: 50%;
      width: 35px;
      height: 35px;
      cursor: pointer;
      font-size: 16px;
      color: white;
      transition: background .2s;
    }
    .play-btn:hover {
      background: #17a24b;
    }
    .songs-list {
      display: none;
      margin-top: 10px;
      width: 100%;
    }
    .song-item {
      background: #1a1a1a;
      padding: 8px 12px;
      margin: 4px 0;
      border-radius: 5px;
      font-size: 12px;
      cursor: pointer;
      transition: background .2s;
    }
    .song-item:hover {
      background: #2a2a2a;
    }
    .upload-section {
      background: var(--color-secondary);
      margin: 30px 40px;
      padding: 25px 30px;
      border-radius: 13px;
      max-width: 600px;
    }
    .upload-section label { 
      display: block; 
      margin-top: 13px; 
      font-size: 15px;
    }
    .upload-section input[type="text"], 
    .upload-section input[type="file"],
    .upload-section select {
      width: 100%; 
      padding: 8px; 
      margin-top: 2px; 
      border-radius: 5px; 
      border: none; 
      box-sizing: border-box; 
      background: #191919; 
      color: #efefef;
    }
    .upload-section button {
      margin-top: 18px;
      background: var(--color-primary);
      color: #fff;
      border: none;
      border-radius: 20px;
      padding: 8px 30px;
      font-weight: 800;
      font-size: 15px;
      cursor: pointer;
      transition: background .2s;
    }
    .upload-section button:hover { 
      background: #18a24b;
    }
    .player-bar {
      background: var(--color-card);
      position: fixed;
      bottom: 0;
      left: 220px;
      width: calc(100% - 220px);
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-top: 1px solid #212121;
      z-index: 20;
      padding: 0 20px;
      box-sizing: border-box;
    }
    .player-info {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      max-width: 300px;
    }
    .player-info img {
      width: 50px;
      height: 50px;
      border-radius: 4px;
    }
    .track-info {
      color: var(--color-text-main);
      font-size: 14px;
    }
    .track-artist {
      color: var(--color-text-dark);
      font-size: 12px;
    }
    .player-controls {
      display: flex;
      align-items: center;
      gap: 18px;
      flex: 1;
      justify-content: center;
    }
    .player-controls button {
      background: none; 
      border: none; 
      color: #fff; 
      font-size: 28px; 
      cursor: pointer;
      transition: color .18s;
    }
    .player-controls button:hover { 
      color: var(--color-primary);
    }
    .volume-controls {
      flex: 1;
      display: flex;
      justify-content: flex-end;
    }
    footer {
      width: 100vw;
      font-size: 13px;
      color: #555;
      text-align: center;
      background: #191919;
      margin-top: 100px;
      padding: 14px 0 12px;
      letter-spacing: .1em;
      border-top: 1px solid #222;
    }
    @media (max-width: 900px){
      aside { width: 65px !important;}
      .player-bar { left: 65px; width: calc(100% - 65px);}
      .logo { font-size: 0;}
      .side-menu a { font-size: 0;}
      .side-menu a:before {
        content: '';
        width: 16px;
        height: 16px;
        border-radius: 3px;
        display: inline-block;
        margin-right: 0;
        background: #222;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
</head>
<body>
<div class="container">
  <aside>
    <div class="logo">KLMZ MUSIC</div>
    <nav class="side-menu">
      <a href="#albums" class="active">üéµ Inicio</a>
      <a href="#upload">‚¨ÜÔ∏è Subir M√∫sica</a>
    </nav>
  </aside>
  <main>
    <div class="topbar">
      <div class="search-bar">
        <span>üîç</span>
        <input type="text" id="searchInput" placeholder="Buscar √°lbum...">
      </div>
    </div>
    <section class="albums-section">
      <div class="albums-title">√Ålbumes</div>
      <div class="albums" id="albumsList"></div>
    </section>
    <section class="upload-section" id="upload">
      <h3 style="margin-bottom:12px; font-weight:700;">Subir Nueva M√∫sica</h3>
      <form id="uploadForm">
        <label for="uploadType">Tipo de Subida</label>
        <select id="uploadType">
          <option value="new-album">Nuevo √Ålbum</option>
          <option value="existing-album">Agregar a √Ålbum Existente</option>
        </select>
        
        <div id="newAlbumFields">
          <label for="albumTitle">T√≠tulo del √Ålbum</label>
          <input type="text" id="albumTitle" name="albumTitle">
          <label for="coverFile">Portada del √Ålbum</label>
          <input type="file" id="coverFile" name="coverFile" accept="image/*">
        </div>
        
        <div id="existingAlbumFields" style="display:none;">
          <label for="existingAlbum">Seleccionar √Ålbum</label>
          <select id="existingAlbum"></select>
        </div>
        
        <label for="songTitle">T√≠tulo de la Canci√≥n</label>
        <input type="text" id="songTitle" name="songTitle" required>
        <label for="songFile">Archivo de M√∫sica</label>
        <input type="file" id="songFile" name="songFile" accept="audio/*" required>
        
        <button type="submit">Subir</button>
      </form>
    </section>
  </main>
</div>

<div class="player-bar" id="playerBar" style="display:none;">
  <div class="player-info">
    <img id="currentAlbumCover" src="" alt="Album cover">
    <div>
      <div class="track-info" id="currentTrack"></div>
      <div class="track-artist" id="currentAlbum"></div>
    </div>
  </div>
  <div class="player-controls">
    <button id="prevBtn">‚èÆ</button>
    <button id="playBtn">‚ñ∂</button>
    <button id="pauseBtn" style="display:none;">‚è∏</button>
    <button id="nextBtn">‚è≠</button>
  </div>
  <div class="volume-controls">
    <audio id="audioPlayer" style="display:none;"></audio>
  </div>
</div>

<footer>
  &copy; 2025 Freddy Granados - KLMZ MUSIC<br>
  Plataforma de M√∫sica Independiente
</footer>

<script>
// Configurar Supabase - REEMPLAZA CON TUS DATOS REALES
const SUPABASE_URL = '<https://nqbldvpnqhngdtalvzov.supabase.co>';
const SUPABASE_KEY = '<eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xYmxkdnBucWhuZ2R0YWx2em92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyMjY0NjUsImV4cCI6MjA3MDgwMjQ2NX0.Zzg5D219sW7bhvl0_R5ypX9MF6nRzBSDIeo2Lvebab0>';
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let albumsData = [];
let songsData = [];
let currentSongIndex = 0;
let currentPlaylist = [];
const audioPlayer = document.getElementById('audioPlayer');

// Cargar √°lbumes con sus canciones
async function cargarAlbums() {
  try {
    // Obtener √°lbumes
    const { data: albums, error: albumsError } = await supabase
      .from('albums')
      .select('*')
      .order('created_at', { ascending: false });

    if (albumsError) throw albumsError;

    // Obtener todas las canciones
    const { data: songs, error: songsError } = await supabase
      .from('songs')
      .select('*')
      .order('created_at', { ascending: true });

    if (songsError) throw songsError;

    albumsData = albums || [];
    songsData = songs || [];

    mostrarAlbums();
    cargarSelectAlbums();
  } catch (error) {
    console.error('Error cargando datos:', error);
  }
}

function mostrarAlbums() {
  const albumsContainer = document.getElementById('albumsList');
  albumsContainer.innerHTML = '';

  if (albumsData.length === 0) {
    albumsContainer.innerHTML = '<p>No hay √°lbumes a√∫n.</p>';
    return;
  }

  albumsData.forEach((album, index) => {
    const albumSongs = songsData.filter(song => song.album_id === album.id);
    const songCount = albumSongs.length;

    albumsContainer.innerHTML += `
      <div class="album" data-album-id="${album.id}">
        <img src="${album.cover_url}" alt="${album.title}" onerror="this.src='https://misc.scdn.co/liked-songs/liked-songs-640.png'">
        <div class="albumName">${album.title}</div>
        <div class="albumSongs">${songCount} canci√≥n${songCount !== 1 ? 'es' : ''}</div>
        <button class="play-btn" onclick="playAlbum('${album.id}')">‚ñ∂</button>
        <div class="songs-list" id="songs-${album.id}">
          ${albumSongs.map((song, i) => `
            <div class="song-item" onclick="playSong('${song.id}', '${album.id}')">
              ${i + 1}. ${song.title}
            </div>
          `).join('')}
        </div>
      </div>
    `;
  });
}

function cargarSelectAlbums() {
  const select = document.getElementById('existingAlbum');
  select.innerHTML = '<option value="">Selecciona un √°lbum...</option>';
  albumsData.forEach(album => {
    select.innerHTML += `<option value="${album.id}">${album.title}</option>`;
  });
}

// Funciones de reproducci√≥n
function playAlbum(albumId) {
  const albumSongs = songsData.filter(song => song.album_id === albumId);
  if (albumSongs.length > 0) {
    currentPlaylist = albumSongs;
    currentSongIndex = 0;
    playSong(albumSongs[0].id, albumId);
  }
}

function playSong(songId, albumId) {
  const song = songsData.find(s => s.id === songId);
  const album = albumsData.find(a => a.id === albumId);
  
  if (song && album) {
    audioPlayer.src = song.song_url;
    audioPlayer.play();
    
    document.getElementById('playerBar').style.display = 'flex';
    document.getElementById('currentTrack').textContent = song.title;
    document.getElementById('currentAlbum').textContent = album.title;
    document.getElementById('currentAlbumCover').src = album.cover_url;
    
    document.getElementById('playBtn').style.display = 'none';
    document.getElementById('pauseBtn').style.display = 'block';
    
    // Actualizar √≠ndice actual en la playlist
    const songIndex = currentPlaylist.findIndex(s => s.id === songId);
    if (songIndex !== -1) {
      currentSongIndex = songIndex;
    }
  }
}

// Controles del reproductor
document.getElementById('playBtn').onclick = () => {
  audioPlayer.play();
  document.getElementById('playBtn').style.display = 'none';
  document.getElementById('pauseBtn').style.display = 'block';
};

document.getElementById('pauseBtn').onclick = () => {
  audioPlayer.pause();
  document.getElementById('playBtn').style.display = 'block';
  document.getElementById('pauseBtn').style.display = 'none';
};

document.getElementById('prevBtn').onclick = () => {
  if (currentPlaylist.length > 0 && currentSongIndex > 0) {
    currentSongIndex--;
    const prevSong = currentPlaylist[currentSongIndex];
    playSong(prevSong.id, prevSong.album_id);
  }
};

document.getElementById('nextBtn').onclick = () => {
  if (currentPlaylist.length > 0 && currentSongIndex < currentPlaylist.length - 1) {
    currentSongIndex++;
    const nextSong = currentPlaylist[currentSongIndex];
    playSong(nextSong.id, nextSong.album_id);
  }
};

// Auto-play siguiente canci√≥n
audioPlayer.addEventListener('ended', () => {
  document.getElementById('nextBtn').click();
});

// B√∫squeda
document.getElementById('searchInput').addEventListener('input', function() {
  const filtro = this.value.toLowerCase();
  const albums = document.querySelectorAll('.album');
  
  albums.forEach(album => {
    const title = album.querySelector('.albumName').textContent.toLowerCase();
    album.style.display = title.includes(filtro) ? 'flex' : 'none';
  });
});

// Cambio de tipo de subida
document.getElementById('uploadType').onchange = function() {
  const newAlbumFields = document.getElementById('newAlbumFields');
  const existingAlbumFields = document.getElementById('existingAlbumFields');
  const albumTitle = document.getElementById('albumTitle');
  const coverFile = document.getElementById('coverFile');
  
  if (this.value === 'new-album') {
    newAlbumFields.style.display = 'block';
    existingAlbumFields.style.display = 'none';
    albumTitle.required = true;
    coverFile.required = true;
  } else {
    newAlbumFields.style.display = 'none';
    existingAlbumFields.style.display = 'block';
    albumTitle.required = false;
    coverFile.required = false;
  }
};

// Subida de archivos
document.getElementById('uploadForm').onsubmit = async function(e) {
  e.preventDefault();
  
  const uploadType = document.getElementById('uploadType').value;
  const songTitle = document.getElementById('songTitle').value.trim();
  const songFile = document.getElementById('songFile').files[0];
  
  if (!songTitle || !songFile) {
    alert('Por favor completa todos los campos requeridos.');
    return;
  }
  
  try {
    let albumId;
    
    if (uploadType === 'new-album') {
      const albumTitle = document.getElementById('albumTitle').value.trim();
      const coverFile = document.getElementById('coverFile').files[0];
      
      if (!albumTitle || !coverFile) {
        alert('Para un nuevo √°lbum necesitas t√≠tulo y portada.');
        return;
      }
      
      // Subir portada
      const coverExt = coverFile.name.split('.').pop();
      const coverFileName = `${Date.now()}-${Math.random().toString(36).substring(2)}.${coverExt}`;
      
      const { error: coverError } = await supabase.storage
        .from('covers')
        .upload(coverFileName, coverFile);
      
      if (coverError) throw coverError;
      
      const { data: coverUrl } = supabase.storage
        .from('covers')
        .getPublicUrl(coverFileName);
      
      // Crear √°lbum
      const { data: newAlbum, error: albumError } = await supabase
        .from('albums')
        .insert([{
          title: albumTitle,
          cover_url: coverUrl.publicUrl
        }])
        .select()
        .single();
      
      if (albumError) throw albumError;
      albumId = newAlbum.id;
      
    } else {
      albumId = document.getElementById('existingAlbum').value;
      if (!albumId) {
        alert('Selecciona un √°lbum existente.');
        return;
      }
    }
    
    // Subir canci√≥n
    const songExt = songFile.name.split('.').pop();
    const songFileName = `${Date.now()}-${Math.random().toString(36).substring(2)}.${songExt}`;
    
    const { error: songError } = await supabase.storage
      .from('songs')
      .upload(songFileName, songFile);
    
    if (songError) throw songError;
    
    const { data: songUrl } = supabase.storage
      .from('songs')
      .getPublicUrl(songFileName);
    
    // Crear registro de canci√≥n
    const { error: dbError } = await supabase
      .from('songs')
      .insert([{
        album_id: albumId,
        title: songTitle,
        song_url: songUrl.publicUrl
      }]);
    
    if (dbError) throw dbError;
    
    alert('¬°M√∫sica subida exitosamente!');
    this.reset();
    document.getElementById('uploadType').onchange();
    cargarAlbums();
    
  } catch (error) {
    console.error('Error:', error);
    alert('Error al subir la m√∫sica: ' + error.message);
  }
};

// Inicializar
cargarAlbums();
</script>
</body>
</html>
