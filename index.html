<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>KLMZ MUSIC</title>
<style>
:root{
  --bg:#121212;--card:#181818;--soft:#232323;--text:#eaeaea;--muted:#b3b3b3;--brand:#1DB954;--danger:#e74c3c;--shadow:rgba(0,0,0,.35)
}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans",sans-serif}
*{box-sizing:border-box}
.header{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:linear-gradient(180deg,rgba(0,0,0,.7),rgba(0,0,0,.2) 70%,transparent)}
.brand{display:flex;align-items:center;gap:10px;font-weight:700}
.brand .logo{width:32px;height:32px;border-radius:8px;background:var(--brand);display:grid;place-items:center;color:#000;font-weight:900}
.header-right{display:flex;align-items:center;gap:10px}
.theme-selector select{background:var(--soft);border:1px solid #2a2a2a;color:var(--text);padding:6px 10px;border-radius:8px}
.user-menu{position:relative}
.user-btn{display:flex;align-items:center;gap:8px;background:var(--soft);border:1px solid #2a2a2a;color:var(--text);padding:6px 10px;border-radius:999px;cursor:pointer}
.user-dropdown{position:absolute;right:0;top:42px;background:var(--card);border:1px solid #2a2a2a;border-radius:12px;box-shadow:0 20px 40px var(--shadow);min-width:220px;display:none}
.user-dropdown.show{display:block}
.user-dropdown .section-title{padding:10px 12px;color:var(--muted);font-size:.8rem}
.user-dropdown .item{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;cursor:pointer}
.user-dropdown .item:hover{background:rgba(255,255,255,.04)}
.user-email{padding:10px 12px;color:var(--text);font-size:.9rem;border-top:1px solid #2a2a2a}
.container{padding:16px;max-width:1100px;margin:0 auto}
#loading-indicator{display:none;text-align:center;padding:24px}
.album-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:14px}
.album-card{background:var(--card);border:1px solid #2a2a2a;border-radius:14px;overflow:hidden;cursor:pointer;transition:transform .15s ease,box-shadow .15s ease}
.album-card:hover{transform:translateY(-2px);box-shadow:0 10px 30px var(--shadow)}
.album-img{width:100%;aspect-ratio:1/1;object-fit:cover;display:block}
.album-title{font-weight:700;padding:10px 10px 2px}
.album-artist{padding:0 10px 12px;color:var(--muted);font-size:.9rem}
.content-section{display:none}
.content-section.active{display:block}
.search-bar{margin:14px 0}
.search-input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #2a2a2a;background:var(--soft);color:var(--text)}
.search-song-item{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #222;background:var(--card);border-radius:10px;margin-bottom:8px}
.search-song-title{font-weight:600}
.search-song-artist{color:var(--muted);font-size:.9rem}
#album-detail{display:none}
.song-list ul{list-style:none;margin:0;padding:0}
.song-list li{display:flex;align-items:center;gap:10px;justify-content:space-between;padding:12px;border-bottom:1px solid #222}
.song-actions{display:flex;align-items:center;gap:12px}
.download-icon{cursor:pointer}
.download-icon.downloaded{color:var(--brand)}
.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);display:flex;justify-content:space-around;border-top:1px solid #222;padding:6px 0}
.bottom-nav-item{flex:1;text-align:center;padding:8px 0;color:var(--muted);cursor:pointer}
.bottom-nav-item.active{color:var(--text);font-weight:700}
#mini-player{position:fixed;left:12px;right:12px;bottom:62px;background:rgba(24,24,24,.95);border:1px solid #2a2a2a;border-radius:16px;display:none;align-items:center;gap:12px;padding:8px 10px;box-shadow:0 10px 30px var(--shadow)}
.mini-cover{width:44px;height:44px;border-radius:8px;object-fit:cover}
.mini-meta{flex:1;overflow:hidden}
.mini-title{font-size:.95rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.mini-artist{color:var(--muted);font-size:.82rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.player-controls-inline button{background:transparent;border:none;color:var(--text);font-size:1.2rem;cursor:pointer}
#full-player{position:fixed;inset:0;background:rgba(0,0,0,.9);backdrop-filter:blur(8px);display:none;flex-direction:column;align-items:center;justify-content:center;padding:20px}
#full-player.active{display:flex}
.full-cover{width:260px;height:260px;border-radius:16px;object-fit:cover;box-shadow:0 20px 60px var(--shadow);border:1px solid #2a2a2a}
.full-meta{margin-top:12px;text-align:center}
.full-title{font-size:1.2rem;font-weight:800}
.full-artist{color:var(--muted);margin-top:4px}
.full-progress{width:88%;height:8px;background:#222;border-radius:999px;margin:16px auto;cursor:pointer;position:relative;overflow:hidden;border:1px solid #2a2a2a}
.full-progress-fill{position:absolute;left:0;top:0;bottom:0;width:0;background:var(--brand)}
.full-times{display:flex;justify-content:space-between;width:88%;font-size:.85rem;color:var(--muted)}
.player-row{display:flex;align-items:center;gap:12px;margin-top:10px}
.player-row button{background:var(--soft);border:1px solid #2a2a2a;color:var(--text);padding:10px 14px;border-radius:999px;cursor:pointer}
.player-row button.active{outline:2px solid var(--brand)}
.volume{width:180px}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:20}
.modal-content{background:var(--card);border:1px solid #2a2a2a;border-radius:14px;max-width:420px;width:92%;padding:18px}
.btn-primary,.btn-secondary,.btn-danger{border:none;padding:10px 14px;border-radius:10px;cursor:pointer}
.btn-primary{background:var(--brand);color:#000}
.btn-secondary{background:var(--soft);color:var(--text);border:1px solid #2a2a2a}
.btn-danger{background:var(--danger);color:#fff}
.admin-section{background:var(--card);border:1px solid #2a2a2a;border-radius:14px;padding:16px;margin-bottom:18px}
.admin-form .form-group{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
.admin-form input,.admin-form select{background:var(--soft);border:1px solid #2a2a2a;color:var(--text);padding:10px;border-radius:10px}
.admin-list .admin-item{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid #222}
.admin-item-actions{display:flex;gap:8px}
.favorites-list .favorite-item,.downloads-list .download-item{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--card);border:1px solid #2a2a2a;border-radius:12px;margin-bottom:10px}
.favorite-title,.download-title{font-weight:700}
.favorite-artist,.download-artist{color:var(--muted);font-size:.9rem}
.theme-neon{--bg:#05060a;--card:#0b0e16;--soft:#0e1320;--text:#e8f0ff;--muted:#9fb3ff;--brand:#7cf67c}
.theme-minimal{--bg:#0f0f10;--card:#141416;--soft:#1a1b1e;--text:#f5f5f5;--muted:#a9a9a9;--brand:#58d68d}
.theme-sunset{--bg:#0f0a0a;--card:#181012;--soft:#231519;--text:#fff2ec;--muted:#f4b8a7;--brand:#ff7f50}
.theme-pastel{--bg:#111217;--card:#171922;--soft:#1c2030;--text:#f7f7ff;--muted:#c9cff7;--brand:#8ad1ff}
.theme-luxury{--bg:#0b0c0f;--card:#121418;--soft:#171a20;--text:#f2f2f2;--muted:#c0c0c0;--brand:#c8a96a}
.theme-oceanic{--bg:#0a1014;--card:#0f171d;--soft:#13202a;--text:#e7f5ff;--muted:#9cc6de;--brand:#2cc0ff}
</style>
</head>
<body>
<header class="header">
  <div class="brand">
    <div id="header-lock-icon" class="logo">K</div>
    <div>KLMZ MUSIC</div>
  </div>
  <div class="header-right">
    <div class="theme-selector">
      <select onchange="changeTheme(this.value)">
        <option value="default">Tema: Default</option>
        <option value="neon">Neon</option>
        <option value="minimal">Minimal</option>
        <option value="sunset">Sunset</option>
        <option value="pastel">Pastel</option>
        <option value="luxury">Luxury</option>
        <option value="oceanic">Oceanic</option>
      </select>
    </div>
    <div class="user-menu">
      <button class="user-btn" onclick="toggleUserMenu()">
        <span>Menú</span>
      </button>
      <div class="user-dropdown" id="user-dropdown">
        <div class="section-title">Cuenta</div>
        <div class="item" id="login-menu-item" onclick="showAuth('login')"><span>Iniciar sesión</span><span>→</span></div>
        <div class="item" id="register-menu-item" onclick="showAuth('register')"><span>Registrarse</span><span>→</span></div>
        <div class="item" id="logout-menu-item" style="display:none" onclick="confirmLogout()"><span>Cerrar sesión</span><span>→</span></div>
        <div class="item" id="admin-menu-item" style="display:none" onclick="(function(){toggleUserMenu();goToAdmin();})()"><span>Panel Admin</span><span>⚙️</span></div>
        <div class="user-email"><span id="user-email-display"></span></div>
      </div>
    </div>
  </div>
</header>

<div class="container">
  <div class="search-bar content-section active" id="home-section">
    <input id="search-input" class="search-input" placeholder="Buscar álbumes o canciones..." oninput="searchMusic()"/>
    <div id="search-results" style="margin-top:10px"></div>
    <div id="loading-indicator">Cargando...</div>
    <div id="albums" class="album-grid"></div>
    <div id="album-detail"></div>
  </div>

  <div id="favorites-section" class="content-section">
    <h2>Favoritos</h2>
    <div id="favorites-content">Cargando...</div>
  </div>

  <div id="downloads-section" class="content-section">
    <h2>Descargas</h2>
    <div id="downloads-content">Cargando...</div>
  </div>

  <div id="admin-section" class="content-section">
    <h2>Panel de Administración</h2>
    <div id="admin-content"></div>
  </div>
</div>

<div id="mini-player">
  <img id="mini-player-img" class="mini-cover" src="" alt="">
  <div class="mini-meta">
    <div id="mini-player-title" class="mini-title"></div>
    <div id="mini-player-artist" class="mini-artist"></div>
  </div>
  <div class="player-controls-inline">
    <button id="mini-prev-btn" onclick="previousSong()">⏮</button>
    <button id="mini-play-btn" onclick="togglePlay()">▶</button>
    <button id="mini-next-btn" onclick="nextSong()">⏭</button>
  </div>
</div>

<div id="full-player">
  <img id="full-player-cover" class="full-cover" src="" alt="">
  <div class="full-meta">
    <div id="full-player-title" class="full-title"></div>
    <div id="full-player-artist" class="full-artist"></div>
  </div>
  <div class="full-progress" onclick="seekToFull(event)">
    <div id="full-progress-fill" class="full-progress-fill"></div>
  </div>
  <div class="full-times">
    <span id="full-current-time">0:00</span>
    <span id="full-total-time">0:00</span>
  </div>
  <div class="player-row">
    <button onclick="previousSong()">⏮</button>
    <button id="full-play-btn" onclick="togglePlay()">▶</button>
    <button onclick="nextSong()">⏭</button>
    <button id="repeat-btn" onclick="toggleRepeatMode()">🔁</button>
    <button id="shuffle-btn" onclick="toggleShuffleMode()">🔀</button>
    <input class="volume" type="range" min="0" max="100" value="70" oninput="setVolume(this.value)"/>
    <button onclick="closeFullPlayer()">Cerrar</button>
  </div>
</div>

<div id="auth-modal" class="modal">
  <div class="modal-content">
    <div id="login-form" style="display:none">
      <h3>Iniciar sesión</h3>
      <form onsubmit="login(event)">
        <div class="form-group"><label>Email</label><input id="login-email" type="email" required></div>
        <div class="form-group"><label>Contraseña</label><input id="login-password" type="password" required></div>
        <button class="btn-primary" type="submit">Entrar</button>
      </form>
    </div>
    <div id="register-form" style="display:none">
      <h3>Registro</h3>
      <form onsubmit="register(event)">
        <div class="form-group"><label>Email</label><input id="register-email" type="email" required></div>
        <div class="form-group"><label>Contraseña</label><input id="register-password" type="password" required></div>
        <div class="form-group"><label>Confirmar</label><input id="register-confirm" type="password" required></div>
        <button class="btn-primary" type="submit">Crear cuenta</button>
      </form>
    </div>
  </div>
</div>

<audio id="audio-player" preload="metadata"></audio>

<div id="info-modal-backdrop" class="modal" style="display:none"></div>
<div id="confirm-modal-backdrop" class="modal" style="display:none"></div>

<div class="bottom-nav">
  <div id="nav-home" class="bottom-nav-item active" onclick="showSection('home')">Inicio</div>
  <div id="nav-search" class="bottom-nav-item" onclick="showSection('home')">Buscar</div>
  <div id="nav-favs" class="bottom-nav-item" onclick="showSection('favorites')">Favoritos</div>
  <div id="nav-downloads" class="bottom-nav-item" onclick="showSection('downloads')">Descargas</div>
  <div id="nav-admin" class="bottom-nav-item" onclick="goToAdmin()">Admin</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/appwrite@13"></script>
<script>
let supabase=null;
let appwriteClient=null;
let appwriteDatabases=null;
let appwriteStorage=null;

let currentSong=null;
let currentAlbum=null;
let currentPlaylist=[];
let currentIndex=0;
let isPlaying=false;
let allAlbums=[];
let allSongs=[];
let currentUser=null;
let songsWithAlbumInfo=[];
let repeatMode='off';
let shuffleMode=false;
let originalPlaylist=[];
let db;

const SUPABASE_URL='https://nqbldvpnqhngdtalvzov.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xYmxkdnBucWhuZ2R0YWx2em92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyMjY0NjUsImV4cCI6MjA3MDgwMjQ2NX0.Zzg5D219sW7bhvl0_R5ypX9MF6nRzBSDIeo2Lvebab0';
const ADMIN_EMAIL='klmzr@gmail.com';

const APPWRITE_ENDPOINT='https://nyc.cloud.appwrite.io/v1';
const APPWRITE_PROJECT_ID='68ab0cf2000365979a71';
const APPWRITE_DATABASE_ID='68ab0d9b00124af501a5';
const APPWRITE_SONGS_COLLECTION_ID='68ab0f0e002d9f334b0d';
const APPWRITE_SONGS_BUCKET_ID='68ab1101001cff947e6b';

function initDB(){
  return new Promise((resolve,reject)=>{
    const request=indexedDB.open('KLMZMusicDB',2);
    request.onerror=()=>reject('Error al abrir IndexedDB');
    request.onsuccess=e=>{db=e.target.result;resolve(db)};
    request.onupgradeneeded=e=>{
      let _db=e.target.result;
      if(!_db.objectStoreNames.contains('songs')){_db.createObjectStore('songs',{keyPath:'id'})}
    }
  })
}
async function saveSongToDB(songData){
  return new Promise((resolve,reject)=>{
    const tx=db.transaction(['songs'],'readwrite');
    const store=tx.objectStore('songs');
    const req=store.put(songData);
    req.onsuccess=()=>resolve();
    req.onerror=ev=>reject('Error al guardar la canción: '+ev.target.error)
  })
}
async function getSongFromDB(songId){
  return new Promise((resolve,reject)=>{
    const tx=db.transaction(['songs'],'readonly');
    const store=tx.objectStore('songs');
    const req=store.get(songId);
    req.onsuccess=()=>resolve(req.result);
    req.onerror=ev=>reject('Error al obtener la canción: '+ev.target.error)
  })
}
async function getAllDownloadedSongs(){
  return new Promise((resolve,reject)=>{
    const tx=db.transaction(['songs'],'readonly');
    const store=tx.objectStore('songs');
    const req=store.getAll();
    req.onsuccess=()=>resolve(req.result);
    req.onerror=ev=>reject('Error al obtener todas las canciones: '+ev.target.error)
  })
}
window.downloadSong=async function(songId,element){
  if(element.classList.contains('downloaded')){showInfoModal('Esta canción ya está descargada.');return}
  try{
    const song=allSongs.find(s=>s.$id===songId);
    if(!song)throw new Error('Canción no encontrada');
    element.textContent='...';
    const audioUrl=appwriteStorage.getFileDownload(APPWRITE_SONGS_BUCKET_ID,song.file_id);
    const album=allAlbums.find(a=>a.id===song.album_id);
    const coverUrl=album?album.cover_url:'';
    const audioResponse=await fetch(audioUrl);
    if(!audioResponse.ok)throw new Error('Error en la red al descargar audio');
    const audioBlob=await audioResponse.blob();
    let coverBlob=null;
    if(coverUrl){const coverResponse=await fetch(coverUrl);coverBlob=await coverResponse.blob()}
    const songData={id:song.$id,metadata:{...song,albums:album},audio:audioBlob,cover:coverBlob};
    await saveSongToDB(songData);
    showInfoModal(`${song.title} descargada con éxito.`);
    element.textContent='↓';
    element.classList.add('downloaded');
  }catch(error){
    console.error('Error al descargar:',error);
    showInfoModal('No se pudo descargar la canción.');
    element.textContent='↓';
  }
};
async function loadDownloads(){
  const content=document.getElementById('downloads-content');
  try{
    const downloadedSongs=await getAllDownloadedSongs();
    if(downloadedSongs.length===0){content.innerHTML=`<div style="text-align: center; padding: 2rem;">No tienes canciones descargadas</div>`;return}
    let html='<div class="downloads-list">';
    downloadedSongs.forEach(songItem=>{
      const song=songItem.metadata;
      html+=`
        <div class="download-item" onclick="playDownloadedSong('${song.id}')">
          <div class="download-info">
            <div class="download-title">${song.title}</div>
            <div class="download-artist">${song.albums.artist} • ${song.albums.title}</div>
          </div>
          <span style="font-size: 1.1rem;">▶</span>
        </div>`
    });
    html+='</div>';
    content.innerHTML=html;
  }catch(error){
    console.error(error);
    content.innerHTML='Error al cargar las descargas.';
  }
}
window.playDownloadedSong=async songId=>{
  const songData=await getSongFromDB(songId);
  if(songData){
    currentPlaylist=[songData.metadata];
    currentIndex=0;
    playSong(songData.metadata,songData.metadata.albums);
  }
};

window.playSong=async function(song,album,playlist=[song],index=0){
  currentSong=song;
  currentAlbum=album;
  currentPlaylist=playlist;
  currentIndex=index;
  const audio=document.getElementById('audio-player');
  audio.pause();
  updateAllPlayers();
  const onCanPlay=()=>{audio.play().catch(err=>{console.error("Error al reproducir:",err);if(err.name!=='AbortError'){showInfoModal('No se pudo reproducir la canción.')}});audio.removeEventListener('canplay',onCanPlay)};
  audio.addEventListener('canplay',onCanPlay);
  try{
    const downloadedSong=await getSongFromDB(song.$id);
    if(downloadedSong&&downloadedSong.audio){
      const audioURL=URL.createObjectURL(downloadedSong.audio);
      audio.src=audioURL;
    }else{
      const fileUrl=appwriteStorage.getFileDownload(APPWRITE_SONGS_BUCKET_ID,song.file_id);
      audio.src=fileUrl;
    }
  }catch(error){
    console.error("Error al buscar canción en DB, reproduciendo desde red:",error);
    const fileUrl=appwriteStorage.getFileDownload(APPWRITE_SONGS_BUCKET_ID,song.file_id);
    audio.src=fileUrl;
  }
  audio.load();
};

window.changeTheme=function(theme){
  const body=document.body;
  body.classList.remove('theme-neon','theme-minimal','theme-sunset','theme-pastel','theme-luxury','theme-oceanic');
  if(theme&&theme!=='default'){body.classList.add('theme-'+theme)}
  localStorage.setItem('klmz_theme',theme);
}
function loadSavedTheme(){
  const savedTheme=localStorage.getItem('klmz_theme')||'default';
  document.querySelector('.theme-selector select').value=savedTheme;
  changeTheme(savedTheme);
}

async function loadData(){
  showLoadingIndicator(true);
  try{
    const { createClient }=await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
    supabase=createClient(SUPABASE_URL,SUPABASE_KEY);
    appwriteClient=new Appwrite.Client();
    appwriteClient.setEndpoint(APPWRITE_ENDPOINT).setProject(APPWRITE_PROJECT_ID);
    appwriteDatabases=new Appwrite.Databases(appwriteClient);
    appwriteStorage=new Appwrite.Storage(appwriteClient);
    supabase.auth.onAuthStateChange((event,session)=>{currentUser=session?.user||null;updateAuthUI()});
    const { data:{ session }}=await supabase.auth.getSession();
    currentUser=session?.user||null;
    updateAuthUI();
    await loadAllData();
  }catch(error){
    console.error('Error conectando a servicios:',error);
    showErrorMessage('Error de conexión. Revisa tu internet o las credenciales de tu base de datos.');
  }finally{
    showLoadingIndicator(false);
  }
}
async function loadAllData(){
  try{
    const { data:albums, error:albumsError }=await supabase.from('albums').select('*');
    if(albumsError)throw albumsError;
    const { documents:songs }=await appwriteDatabases.listDocuments(APPWRITE_DATABASE_ID,APPWRITE_SONGS_COLLECTION_ID,[Appwrite.Query.limit(200)]);
    allAlbums=albums||[];
    allSongs=songs||[];
    songsWithAlbumInfo=allSongs.map(song=>{const album=allAlbums.find(a=>a.id===song.album_id);return {...song,albums:album}});
    displayAlbums(allAlbums);
  }catch(error){
    console.error('Error cargando datos:',error);
    showErrorMessage('No se pudieron cargar los álbumes');
  }
}
function displayAlbums(albums){
  const container=document.getElementById('albums');
  if(!albums||albums.length===0){container.innerHTML='<h2>No hay álbumes disponibles</h2>';return}
  container.innerHTML=albums.map(album=>`
    <div class="album-card" onclick='showAlbumDetail(${JSON.stringify(album).replace(/"/g,'&quot;')})'>
      <img class="album-img" src="${album.cover_url}" alt="${album.title}" loading="lazy">
      <div class="album-title">${album.title}</div>
      <div class="album-artist">${album.artist}</div>
    </div>`).join('');
}
async function showAlbumDetail(album){
  currentAlbum=album;
  document.getElementById('albums').style.display='none';
  const detailView=document.getElementById('album-detail');
  detailView.style.display='block';
  detailView.innerHTML=`
    <button class="btn-secondary" onclick="showAlbumsGrid()">⟵ Volver</button>
    <div style="text-align:center;margin-bottom:1.2rem;">
      <img class="album-img" src="${album.cover_url}" style="width:200px;height:200px;display:block;margin:0 auto 1rem;">
      <div class="album-title" style="font-size:1.3rem;">${album.title}</div>
      <div class="album-artist" style="font-size:1rem;color:#b3b3b3;">${album.artist}</div>
    </div>
    <div class="song-list" id="detail-song-list">Cargando...</div>
  `;
  try{
    const { documents:songs }=await appwriteDatabases.listDocuments(APPWRITE_DATABASE_ID,APPWRITE_SONGS_COLLECTION_ID,[Appwrite.Query.equal('album_id',album.id),Appwrite.Query.limit(200)]);
    const listDiv=document.getElementById('detail-song-list');
    if(!songs||songs.length===0){listDiv.innerHTML='No hay canciones en este álbum.';return}
    currentPlaylist=songs;
    originalPlaylist=[...songs];
    const favorites=getLocalFavorites();
    const downloaded=await getAllDownloadedSongs();
    const downloadedIds=downloaded.map(s=>s.id);
    listDiv.innerHTML='<ul>'+songs.map((song,idx)=>`
      <li>
        <div onclick="playSongFromPlaylist(${idx})" style="flex:1;">${song.title}</div>
        <div class="song-actions">
          <span onclick="toggleFavorite('${song.$id}', this)" style="cursor:pointer;color:${favorites.includes(song.$id)?'#1DB954':'#666'};">${favorites.includes(song.$id)?'❤️':'🤍'}</span>
          <span class="download-icon ${downloadedIds.includes(song.$id)?'downloaded':''}" onclick="event.stopPropagation(); downloadSong('${song.$id}', this)">↓</span>
          <span class="play-icon" onclick="playSongFromPlaylist(${idx})">▶</span>
        </div>
      </li>`).join('')+'</ul>';
  }catch(error){
    console.error("Error al cargar canciones del álbum:",error);
    const listDiv=document.getElementById('detail-song-list');
    listDiv.innerHTML="Error al cargar las canciones.";
  }
}

function updateAllPlayers(){updateMiniPlayer();updateFullPlayer();updatePlayButtons()}
async function updateMiniPlayer(){
  document.getElementById('mini-player').style.display='flex';
  const downloadedSong=await getSongFromDB(currentSong?.$id||'').catch(()=>null);
  let coverUrl=currentAlbum?.cover_url||'';
  if(downloadedSong&&downloadedSong.cover){coverUrl=URL.createObjectURL(downloadedSong.cover)}
  document.getElementById('mini-player-img').src=coverUrl||'';
  document.getElementById('mini-player-title').textContent=currentSong?.title||'Sin título';
  document.getElementById('mini-player-artist').textContent=currentAlbum?.artist||'Desconocido';
}
async function updateFullPlayer(){
  const downloadedSong=await getSongFromDB(currentSong?.$id||'').catch(()=>null);
  let coverUrl=currentAlbum?.cover_url||'';
  if(downloadedSong&&downloadedSong.cover){coverUrl=URL.createObjectURL(downloadedSong.cover)}
  document.getElementById('full-player-cover').src=coverUrl||'';
  document.getElementById('full-player-title').textContent=currentSong?.title||'Sin título';
  document.getElementById('full-player-artist').textContent=currentAlbum?.artist||'Desconocido';
}
function updatePlayButtons(){
  const playText=isPlaying?'⏸':'▶';
  ['mini-play-btn','full-play-btn'].forEach(id=>{const btn=document.getElementById(id);if(btn)btn.textContent=playText})
}
window.togglePlay=function(){
  const audio=document.getElementById('audio-player');
  if(isPlaying) audio.pause(); else audio.play();
}
window.nextSong=function(){
  if(currentPlaylist.length===0)return;
  currentIndex=(currentIndex+1)%currentPlaylist.length;
  playSong(currentPlaylist[currentIndex],currentAlbum,currentPlaylist,currentIndex);
}
window.previousSong=function(){
  if(currentPlaylist.length===0)return;
  currentIndex=(currentIndex>0)?currentIndex-1:currentPlaylist.length-1;
  playSong(currentPlaylist[currentIndex],currentAlbum,currentPlaylist,currentIndex);
}
function handleSongEnded(){
  if(repeatMode==='all'||currentIndex<currentPlaylist.length-1) nextSong(); else {isPlaying=false;updatePlayButtons()}
}
window.setVolume=value=>{document.getElementById('audio-player').volume=value/100}
function updateProgressBar(){
  const audio=document.getElementById('audio-player');
  if(!audio.duration)return;
  const progress=(audio.currentTime/audio.duration)*100;
  document.getElementById('full-progress-fill').style.width=`${progress}%`;
  document.getElementById('full-current-time').textContent=formatTime(audio.currentTime);
  document.getElementById('full-total-time').textContent=formatTime(audio.duration);
}
function formatTime(seconds){
  const min=Math.floor(seconds/60);
  const sec=Math.floor(seconds%60).toString().padStart(2,'0');
  return `${min}:${sec}`;
}
window.seekToFull=event=>{
  const audio=document.getElementById('audio-player');
  const rect=event.currentTarget.getBoundingClientRect();
  audio.currentTime=((event.clientX-rect.left)/rect.width)*audio.duration;
}
function openFullPlayer(){document.getElementById('full-player').classList.add('active')}
window.closeFullPlayer=function(){document.getElementById('full-player').classList.remove('active')}
window.toggleRepeatMode=function(){repeatMode=(repeatMode==='all')?'off':'all';updateModeButtonsUI()}
window.toggleShuffleMode=function(){shuffleMode=!shuffleMode;updateModeButtonsUI()}
function updateModeButtonsUI(){
  document.getElementById('repeat-btn').classList.toggle('active',repeatMode==='all');
  document.getElementById('shuffle-btn').classList.toggle('active',shuffleMode);
}

window.toggleUserMenu=function(){
  const dropdown=document.getElementById('user-dropdown');
  dropdown.classList.toggle('show');
  if(dropdown.classList.contains('show')){setTimeout(()=>{document.addEventListener('click',closeUserMenuOutside)},100)}
}
function closeUserMenuOutside(event){
  const userMenu=document.querySelector('.user-menu');
  if(!userMenu.contains(event.target)){
    document.getElementById('user-dropdown').classList.remove('show');
    document.removeEventListener('click',closeUserMenuOutside);
  }
}
function goToAdmin(){document.getElementById('user-dropdown').classList.remove('show');showSection('admin')}
function confirmLogout(){showConfirmationModal('¿Estás seguro de que quieres cerrar sesión?',logout)}
async function logout(){
  try{
    const { error }=await supabase.auth.signOut();
    if(error) throw error;
    currentUser=null;updateAuthUI();showInfoModal('Sesión cerrada correctamente');
  }catch(error){console.error('Error logout:',error);showInfoModal('Error cerrando sesión')}
}
function updateAuthUI(){
  const [headerLockIcon,userInfo,userEmail,adminMenu,loginMenu,registerMenu,logoutMenu]=[
    'header-lock-icon','user-info-section','user-email-display','admin-menu-item','login-menu-item','register-menu-item','logout-menu-item'
  ].map(id=>document.getElementById(id));
  if(currentUser){
    if(userInfo) userInfo.style.display='block';
    if(userEmail) userEmail.textContent=currentUser.email;
    if(loginMenu) loginMenu.style.display='none';
    if(registerMenu) registerMenu.style.display='none';
    if(logoutMenu) logoutMenu.style.display='flex';
    if(isAdmin()){
      if(headerLockIcon) headerLockIcon.innerHTML='⚙️';
      if(adminMenu) adminMenu.style.display='flex';
    }else{
      if(headerLockIcon) headerLockIcon.innerHTML='👤';
      if(adminMenu) adminMenu.style.display='none';
    }
  }else{
    if(headerLockIcon) headerLockIcon.innerHTML='🔒';
    if(userInfo) userInfo.style.display='none';
    if(adminMenu) adminMenu.style.display='none';
    if(loginMenu) loginMenu.style.display='flex';
    if(registerMenu) registerMenu.style.display='flex';
    if(logoutMenu) logoutMenu.style.display='none';
  }
}
function isAdmin(){return currentUser&&currentUser.email===ADMIN_EMAIL}
window.login=async function(event){
  event.preventDefault();
  const email=document.getElementById('login-email').value;
  const password=document.getElementById('login-password').value;
  try{
    const { error }=await supabase.auth.signInWithPassword({email,password});
    if(error) throw error;
    showInfoModal('¡Bienvenido!');closeAuth();
  }catch(error){showInfoModal('Error de login: '+error.message)}
}
window.register=async function(event){
  event.preventDefault();
  const email=document.getElementById('register-email').value;
  const password=document.getElementById('register-password').value;
  if(password!==document.getElementById('register-confirm').value){showInfoModal('Las contraseñas no coinciden');return}
  try{
    const { error }=await supabase.auth.signUp({email,password});
    if(error) throw error;
    showInfoModal('Registro exitoso. Revisa tu correo.');closeAuth();
  }catch(error){showInfoModal('Error de registro: '+error.message)}
}
window.showAuth=function(type){
  document.getElementById('user-dropdown').classList.remove('show');
  document.getElementById('login-form').style.display=(type==='login')?'block':'none';
  document.getElementById('register-form').style.display=(type==='register')?'block':'none';
  document.getElementById('auth-modal').style.display='flex';
}
window.closeAuth=function(){document.getElementById('auth-modal').style.display='none'}

const getLocalFavorites=()=>JSON.parse(localStorage.getItem('klmz_favorites')||'[]');
const saveLocalFavorites=favs=>localStorage.setItem('klmz_favorites',JSON.stringify(favs));
window.toggleFavorite=function(songId,el){
  let favorites=getLocalFavorites();
  const isFavorite=favorites.includes(songId);
  if(isFavorite) favorites=favorites.filter(id=>id!==songId); else favorites.push(songId);
  saveLocalFavorites(favorites);
  if(el){el.style.color=isFavorite?'#666':'#1DB954';el.innerHTML=isFavorite?'🤍':'❤️'}
  if(document.getElementById('favorites-section').classList.contains('active')) loadFavorites();
}
async function loadFavorites(){
  const content=document.getElementById('favorites-content');
  const favorites=getLocalFavorites();
  if(favorites.length===0){content.innerHTML=`<div style="text-align: center; padding: 3rem;"><h2>No tienes favoritos</h2></div>`;return}
  try{
    const songsResponse=await appwriteDatabases.listDocuments(APPWRITE_DATABASE_ID,APPWRITE_SONGS_COLLECTION_ID,[Appwrite.Query.equal('$id',favorites)]);
    const songs=songsResponse.documents.map(song=>{const album=allAlbums.find(a=>a.id===song.album_id);return {...song,albums:album}});
    let html='<div class="favorites-list">';
    songs.forEach(song=>{
      html+=`<div class="favorite-item" onclick="playSongFromFavorites('${song.$id}')">
        <div class="favorite-info">
          <div class="favorite-title">${song.title}</div>
          <div class="favorite-artist">${song.albums?.artist||'Desconocido'} • ${song.albums?.title||''}</div>
        </div>
        <div class="song-actions">
          <span onclick="event.stopPropagation(); toggleFavorite('${song.$id}', this);" style="cursor:pointer;color:#1DB954;font-size:1.2rem;">❤️</span>
          <span style="font-size:1.1rem;">▶</span>
        </div>
      </div>`
    });
    content.innerHTML=html+'</div>';
  }catch(error){
    console.error("Error cargando favoritos:",error);
    content.innerHTML=`Error cargando favoritos.`;
  }
}
window.playSongFromFavorites=async function(songId){
  const song=songsWithAlbumInfo.find(s=>s.$id===songId);
  if(song) playSong(song,song.albums,[song],0);
}

window.showSection=function(section){
  document.querySelectorAll('.content-section').forEach(s=>s.classList.remove('active'));
  document.getElementById(`${section}-section`).classList.add('active');
  document.querySelectorAll('.bottom-nav-item').forEach(a=>a.classList.remove('active'));
  const navIdMap={home:'home',search:'search',downloads:'downloads',favorites:'favs',admin:'admin'};
  const navItem=document.getElementById(`nav-${navIdMap[section]||'home'}`);
  if(navItem) navItem.classList.add('active');
  if(section==='home'){showAlbumsGrid()}
  if(section==='favorites') loadFavorites();
  if(section==='downloads') loadDownloads();
  if(section==='admin'){
    if(!isAdmin()){showInfoModal('Acceso denegado. Solo para administradores.');showSection('home');return}
    renderAdminPanel();
  }
}
window.showAlbumsGrid=function(){
  document.getElementById('album-detail').style.display='none';
  document.getElementById('albums').style.display='grid';
}
window.playSongFromPlaylist=function(index){playSong(currentPlaylist[index],currentAlbum,currentPlaylist,index)}
window.searchMusic=function(){
  const query=document.getElementById('search-input').value.toLowerCase().trim();
  const results=document.getElementById('search-results');
  if(!query){results.innerHTML='';return}
  const foundAlbums=allAlbums.filter(a=>a.title.toLowerCase().includes(query)||a.artist.toLowerCase().includes(query));
  const foundSongs=songsWithAlbumInfo.filter(s=>s.title.toLowerCase().includes(query)||(s.albums&&s.albums.artist.toLowerCase().includes(query)));
  let html='';
  if(foundAlbums.length){
    html+='<h3>📀 Álbumes</h3><div class="album-grid">'+foundAlbums.map(album=>`
      <div class="album-card" onclick='showAlbumDetail(${JSON.stringify(album).replace(/"/g,'&quot;')})'>
        <img class="album-img" src="${album.cover_url}"><div class="album-title">${album.title}</div><div class="album-artist">${album.artist}</div>
      </div>`).join('')+'</div>';
  }
  if(foundSongs.length){
    html+='<h3>🎵 Canciones</h3>'+foundSongs.map(song=>`
      <div class="search-song-item" onclick="playSongFromSearch('${song.$id}')">
        <div class="search-song-info"><div class="search-song-title">${song.title}</div><div class="search-song-artist">${song.albums?.artist||'Desconocido'}</div></div>
        <div style="font-size:1.1rem;">▶</div>
      </div>`).join('');
  }
  results.innerHTML=(html||'<h3>No se encontraron resultados</h3>');
}
window.playSongFromSearch=async function(songId){
  const song=songsWithAlbumInfo.find(s=>s.$id===songId);
  if(song) playSong(song,song.albums,[song],0);
}

function showLoadingIndicator(show){document.getElementById('loading-indicator').style.display=show?'block':'none'}
function showErrorMessage(message){
  document.getElementById('albums').innerHTML=`
    <div style="text-align:center;padding:3rem;">
      <h2>${message}</h2>
      <p>Puedes acceder a tu música descargada.</p>
      <button onclick="showSection('downloads')" class="btn-primary" style="margin-top:1rem;">Ir a Descargas</button>
    </div>`;
}
function showInfoModal(message){
  const existing=document.getElementById('info-modal-backdrop');
  if(existing&&existing.childElementCount) return;
  const modal=document.getElementById('info-modal-backdrop');
  modal.innerHTML=`<div class="modal-content"><p style="margin-bottom:1.5rem;text-align:center;font-size:1.1rem;">${message}</p><button class="btn-primary" onclick="document.getElementById('info-modal-backdrop').style.display='none';document.getElementById('info-modal-backdrop').innerHTML=''">OK</button></div>`;
  modal.style.display='flex';
}
function showConfirmationModal(message,onConfirm){
  const existing=document.getElementById('confirm-modal-backdrop');
  if(existing&&existing.childElementCount) return;
  const modal=document.getElementById('confirm-modal-backdrop');
  modal.innerHTML=`<div class="modal-content">
    <p style="margin-bottom:1.5rem;text-align:center;font-size:1.1rem;">${message}</p>
    <div style="display:flex;gap:1rem;justify-content:center">
      <button class="btn-secondary" onclick="document.getElementById('confirm-modal-backdrop').style.display='none';document.getElementById('confirm-modal-backdrop').innerHTML=''">Cancelar</button>
      <button class="btn-danger" onclick="(${onConfirm})();document.getElementById('confirm-modal-backdrop').style.display='none';document.getElementById('confirm-modal-backdrop').innerHTML=''">Confirmar</button>
    </div>
  </div>`;
  modal.style.display='flex';
}

async function renderAdminPanel(){
  const adminContent=document.getElementById('admin-content');
  adminContent.innerHTML=`
    <div class="admin-section">
      <h4>Gestión de Álbumes (Supabase)</h4>
      <form id="album-form" class="admin-form">
        <input type="hidden" id="album-id">
        <div class="form-group"><label>Título</label><input type="text" id="album-title" required></div>
        <div class="form-group"><label>Artista</label><input type="text" id="album-artist" required></div>
        <div class="form-group"><label>URL Portada</label><input type="url" id="album-cover" required></div>
        <button type="submit" class="btn-primary">Guardar Álbum</button>
        <button type="button" id="cancel-album-edit" class="btn-secondary" style="display:none;margin-top:.5rem;">Cancelar Edición</button>
      </form>
      <div id="admin-album-list" class="admin-list">Cargando álbumes...</div>
    </div>
    <div class="admin-section">
      <h4>Gestión de Canciones (Appwrite)</h4>
      <form id="song-form" class="admin-form">
        <input type="hidden" id="song-id">
        <div class="form-group"><label>Título</label><input type="text" id="song-title" required></div>
        <div class="form-group"><label>Archivo de Canción</label><input type="file" id="song-file" accept="audio/*"></div>
        <div class="form-group"><label>Álbum</label><select id="song-album-select" required></select></div>
        <button type="submit" class="btn-primary">Subir Canción</button>
        <button type="button" id="cancel-song-edit" class="btn-secondary" style="display:none;margin-top:.5rem;">Cancelar Edición</button>
      </form>
      <div id="admin-song-list" class="admin-list">Cargando canciones...</div>
    </div>`;
  await renderAdminLists();
  setupAdminForms();
}
async function renderAdminLists(){
  const [{ data:albums }, { documents:songs }]=await Promise.all([
    supabase.from('albums').select('*'),
    appwriteDatabases.listDocuments(APPWRITE_DATABASE_ID,APPWRITE_SONGS_COLLECTION_ID,[Appwrite.Query.limit(200)])
  ]);
  allAlbums=albums||[];
  allSongs=songs||[];
  const albumList=document.getElementById('admin-album-list');
  albumList.innerHTML=allAlbums.map(album=>`
    <div class="admin-item">
      <div class="admin-item-info"><strong>${album.title}</strong><br><small>${album.artist}</small></div>
      <div class="admin-item-actions">
        <button class="btn-secondary" onclick="editAlbum('${album.id}','${album.title.replace(/'/g,"&#39;")}','${album.artist.replace(/'/g,"&#39;")}','${(album.cover_url||'').replace(/'/g,"&#39;")}')">Editar</button>
        <button class="btn-danger" onclick="deleteAlbum('${album.id}')">Borrar</button>
      </div>
    </div>`).join('');
  const songList=document.getElementById('admin-song-list');
  const songsWithAlbumInfoAdmin=allSongs.map(song=>{const album=allAlbums.find(a=>a.id===song.album_id);return {...song,albums:album}});
  songList.innerHTML=songsWithAlbumInfoAdmin.map(song=>`
    <div class="admin-item">
      <div class="admin-item-info"><strong>${song.title}</strong><br><small>${song.albums?.title||'Sin álbum'}</small></div>
      <div class="admin-item-actions">
        <button class="btn-secondary" onclick="editSong('${song.$id}','${song.title.replace(/'/g,"&#39;")}','${song.album_id}')">Editar</button>
        <button class="btn-danger" onclick="deleteSong('${song.$id}','${song.file_id}')">Borrar</button>
      </div>
    </div>`).join('');
  const albumSelect=document.getElementById('song-album-select');
  albumSelect.innerHTML=`<option value="">-- Seleccionar Álbum --</option>`+allAlbums.map(album=>`<option value="${album.id}">${album.title}</option>`).join('');
}
function setupAdminForms(){
  const albumForm=document.getElementById('album-form');
  albumForm.addEventListener('submit',async e=>{
    e.preventDefault();
    const id=document.getElementById('album-id').value;
    const title=document.getElementById('album-title').value;
    const artist=document.getElementById('album-artist').value;
    const cover_url=document.getElementById('album-cover').value;
    showLoadingIndicator(true);
    const { error }=id?await supabase.from('albums').update({title,artist,cover_url}).eq('id',id):await supabase.from('albums').insert([{title,artist,cover_url}]);
    showLoadingIndicator(false);
    if(error){showInfoModal('Error guardando álbum: '+error.message)}
    else{
      showInfoModal('Álbum guardado con éxito.');
      albumForm.reset();document.getElementById('album-id').value='';document.getElementById('cancel-album-edit').style.display='none';
      await loadAllData();await renderAdminLists();
    }
  });
  document.getElementById('cancel-album-edit').addEventListener('click',()=>{
    albumForm.reset();document.getElementById('album-id').value='';document.getElementById('cancel-album-edit').style.display='none';
  });
  const songForm=document.getElementById('song-form');
  songForm.addEventListener('submit',async e=>{
    e.preventDefault();
    const title=document.getElementById('song-title').value;
    const album_id=document.getElementById('song-album-select').value;
    const song_file=document.getElementById('song-file').files[0];
    if(!song_file){showInfoModal("Por favor, selecciona un archivo de audio.");return}
    showLoadingIndicator(true);
    try{
      const uploadedFile=await appwriteStorage.createFile(APPWRITE_SONGS_BUCKET_ID,Appwrite.ID.unique(),song_file);
      await appwriteDatabases.createDocument(APPWRITE_DATABASE_ID,APPWRITE_SONGS_COLLECTION_ID,Appwrite.ID.unique(),{title,album_id,file_id:uploadedFile.$id});
      showInfoModal('Canción subida y guardada con éxito.');
      songForm.reset();
      await loadAllData();await renderAdminLists();
    }catch(error){
      showInfoModal('Error subiendo canción: '+error.message);
      console.error('Error:',error);
    }finally{showLoadingIndicator(false)}
  });
}
window.editAlbum=(id,title,artist,cover_url)=>{
  document.getElementById('album-id').value=id;
  document.getElementById('album-title').value=title;
  document.getElementById('album-artist').value=artist;
  document.getElementById('album-cover').value=cover_url;
  document.getElementById('cancel-album-edit').style.display='inline-block';
  document.getElementById('album-form').scrollIntoView({behavior:'smooth'});
};
window.deleteAlbum=id=>{
  showConfirmationModal('¿Seguro que quieres borrar este álbum? Esto también borrará las canciones asociadas en Appwrite.',async ()=>{
    showLoadingIndicator(true);
    try{
      const { documents:songsToDelete }=await appwriteDatabases.listDocuments(APPWRITE_DATABASE_ID,APPWRITE_SONGS_COLLECTION_ID,[Appwrite.Query.equal('album_id',id),Appwrite.Query.limit(200)]);
      const deletePromises=songsToDelete.map(async song=>{
        await appwriteDatabases.deleteDocument(APPWRITE_DATABASE_ID,APPWRITE_SONGS_COLLECTION_ID,song.$id);
        await appwriteStorage.deleteFile(APPWRITE_SONGS_BUCKET_ID,song.file_id);
      });
      await Promise.all(deletePromises);
      const { error }=await supabase.from('albums').delete().eq('id',id);
      if(error) throw error;
      showInfoModal('Álbum borrado con éxito.');
      await loadAllData();await renderAdminLists();
    }catch(error){showInfoModal('Error borrando álbum: '+error.message)}
    finally{showLoadingIndicator(false)}
  });
};
window.editSong=(id,title,album_id)=>{
  document.getElementById('song-id').value=id;
  document.getElementById('song-title').value=title;
  document.getElementById('song-album-select').value=album_id;
  showInfoModal("No se puede editar el archivo de una canción, solo el título. Si quieres cambiar el audio, bórrala y vuelve a subirla.");
};
window.deleteSong=(songId,fileId)=>{
  showConfirmationModal('¿Seguro que quieres borrar esta canción?',async ()=>{
    showLoadingIndicator(true);
    try{
      await appwriteDatabases.deleteDocument(APPWRITE_DATABASE_ID,APPWRITE_SONGS_COLLECTION_ID,songId);
      await appwriteStorage.deleteFile(APPWRITE_SONGS_BUCKET_ID,fileId);
      showInfoModal('Canción borrada con éxito.');
      await loadAllData();await renderAdminLists();
    }catch(error){showInfoModal('Error borrando canción: '+error.message)}
    finally{showLoadingIndicator(false)}
  });
};

document.addEventListener('DOMContentLoaded',()=>{
  const audio=document.getElementById('audio-player');
  audio.addEventListener('ended',handleSongEnded);
  audio.addEventListener('timeupdate',updateProgressBar);
  audio.addEventListener('play',()=>{isPlaying=true;updatePlayButtons()});
  audio.addEventListener('pause',()=>{isPlaying=false;updatePlayButtons()});
  document.getElementById('mini-player').addEventListener('click',e=>{if(!e.target.closest('.player-controls-inline')) openFullPlayer()});
  loadSavedTheme();
  initDB().then(()=>{}).catch(err=>{console.error("DB error:",err);showInfoModal("La aplicación no puede funcionar sin la base de datos local.")});
});
window.onload=function(){
  loadData();
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  }
};
</script>
</body>
</html>
