<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KLMZ MUSIC</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; background: #111; color: #fff; margin: 0; padding: 0; }
  .container { max-width: 600px; margin: 50px auto; padding: 20px; }
  input { width: 100%; padding: 10px; margin: 10px 0; border-radius: 5px; border: none; }
  button { padding: 10px 20px; margin: 10px 0; border: none; border-radius: 5px; cursor: pointer; background: #1DB954; color: #fff; }
  .album { display: inline-block; margin: 10px; text-align: center; }
  .album img { width: 150px; height: 150px; object-fit: cover; border-radius: 10px; }
  #logout { background: red; }
</style>
</head>
<body>

<div class="container" id="auth-container">
  <h1>KLMZ MUSIC</h1>
  <input type="email" id="email" placeholder="Correo">
  <input type="password" id="password" placeholder="Contraseña">
  <button onclick="login()">Iniciar sesión</button>
  <button onclick="signup()">Registrarse</button>
</div>

<div class="container" id="app-container" style="display:none;">
  <h1>Bienvenido a KLMZ MUSIC</h1>
  <button id="logout" onclick="logout()">Cerrar sesión</button>
  <h2>Subir Álbum</h2>
  <input type="text" id="album-name" placeholder="Nombre del álbum">
  <input type="file" id="album-cover">
  <button onclick="uploadAlbum()">Subir Álbum</button>
  <h2>Mis Álbumes</h2>
  <div id="albums"></div>
</div>

<script>
  const supabaseUrl = 'https://lvrkifepqhxxmdcasncf.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2cmtpZmVwcWh4eG1kY2FzbmNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMjU3NTMsImV4cCI6MjA3MDcwMTc1M30.I-jHvTMEHHrUMM1-2YQrb-58YU4KmTrJuc95GJcjzhk';
  const supabase = supabase.createClient(supabaseUrl, supabaseKey);

  supabase.auth.onAuthStateChange((event, session) => {
    if (session) loadApp();
    else showAuth();
  });

  async function login() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const { error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) { alert(error.message); return; }
    loadApp();
  }

  async function signup() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const { error } = await supabase.auth.signUp({ email, password });
    if (error) { alert(error.message); return; }
    alert('Usuario registrado. Confirma tu correo.');
  }

  async function logout() {
    await supabase.auth.signOut();
    showAuth();
  }

  function showAuth() {
    document.getElementById('auth-container').style.display = 'block';
    document.getElementById('app-container').style.display = 'none';
  }

  async function loadApp() {
    document.getElementById('auth-container').style.display = 'none';
    document.getElementById('app-container').style.display = 'block';
    fetchAlbums();
  }

  async function uploadAlbum() {
    const albumName = document.getElementById('album-name').value;
    const file = document.getElementById('album-cover').files[0];
    if (!albumName || !file) { alert('Nombre y portada son obligatorios'); return; }

    const fileExt = file.name.split('.').pop();
    const fileName = `${Date.now()}.${fileExt}`;
    const { error: uploadError } = await supabase.storage
      .from('media')
      .upload(fileName, file);

    if (uploadError) { alert(uploadError.message); return; }

    const url = supabase.storage.from('media').getPublicUrl(fileName).data.publicUrl;
    await supabase.from('albums').insert([{ name: albumName, cover_url: url }]);
    fetchAlbums();
  }

  async function fetchAlbums() {
    const albumsContainer = document.getElementById('albums');
    albumsContainer.innerHTML = '';

    // 1️⃣ Obtener álbumes de la tabla 'albums'
    const { data: tableAlbums, error: tableError } = await supabase.from('albums').select('*');
    if (tableError) console.log(tableError);

    // 2️⃣ Obtener archivos del bucket 'media' (álbumes antiguos)
    const { data: bucketFiles, error: bucketError } = await supabase.storage.from('media').list();
    if (bucketError) console.log(bucketError);

    // Combinar ambos
    const combined = [];

    if (bucketFiles) {
      bucketFiles.forEach(file => {
        const url = supabase.storage.from('media').getPublicUrl(file.name).data.publicUrl;
        combined.push({ name: file.name, cover_url: url });
      });
    }

    if (tableAlbums) combined.push(...tableAlbums);

    // Mostrar
    combined.forEach(album => {
      albumsContainer.innerHTML += `<div class="album">
        <img src="${album.cover_url}" alt="${album.name}"><br>${album.name}
      </div>`;
    });
  }

  supabase.auth.getSession().then(({ data }) => {
    if (data.session) loadApp();
    else showAuth();
  });

</script>
</body>
</html>
