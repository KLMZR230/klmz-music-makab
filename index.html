import React, { useState, useEffect } from "react";
import { supabase } from "./supabaseClient";

function App() {
  const [albums, setAlbums] = useState([]);
  const [songs, setSongs] = useState([]);
  const [selectedAlbum, setSelectedAlbum] = useState(null);
  const [currentSong, setCurrentSong] = useState(null);

  useEffect(() => {
    fetchAlbums();
  }, []);

  const fetchAlbums = async () => {
    const { data, error } = await supabase.from("albums").select("*");
    if (!error) setAlbums(data);
  };

  const fetchSongs = async (albumId) => {
    setSelectedAlbum(albums.find((a) => a.id === albumId));
    const { data, error } = await supabase
      .from("songs")
      .select("*")
      .eq("album_id", albumId);
    if (!error) setSongs(data);
  };

  const playSong = (song) => {
    setCurrentSong(song);
  };

  return (
    <div className="bg-black min-h-screen text-white">
      <header className="p-6 text-3xl font-bold">üéµ Mi Spotify Clone</header>

      {/* √Ålbumes */}
      {!selectedAlbum && (
        <div className="grid grid-cols-2 md:grid-cols-4 gap-6 p-6">
          {albums.map((album) => (
            <div
              key={album.id}
              className="cursor-pointer"
              onClick={() => fetchSongs(album.id)}
            >
              <img
                src={album.cover_url}
                alt={album.title}
                className="w-full h-48 object-cover rounded-lg shadow-lg"
              />
              <p className="mt-2 text-center font-semibold">{album.title}</p>
            </div>
          ))}
        </div>
      )}

      {/* Canciones de un √°lbum */}
      {selectedAlbum && (
        <div className="p-6">
          <button
            className="mb-4 text-green-400 hover:underline"
            onClick={() => {
              setSelectedAlbum(null);
              setSongs([]);
            }}
          >
            ‚Üê Volver
          </button>
          <h2 className="text-2xl font-bold mb-4">{selectedAlbum.title}</h2>

          <ul className="space-y-2">
            {songs.map((song, index) => (
              <li
                key={song.id}
                onClick={() => playSong(song)}
                className="flex items-center justify-between p-3 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700 transition"
              >
                <div className="flex items-center gap-3">
                  <span className="text-gray-400 w-6">{index + 1}</span>
                  <span className="text-white font-medium truncate max-w-xs">
                    {song.title.replace(".mp3", "")}
                  </span>
                </div>
                <button className="text-green-500 hover:text-green-400">
                  ‚ñ∂
                </button>
              </li>
            ))}
          </ul>
        </div>
      )}

      {/* Reproductor */}
      {currentSong && (
        <div className="fixed bottom-0 left-0 right-0 bg-gray-900 p-4 flex items-center justify-between">
          <div>
            <p className="font-semibold">
              {currentSong.title.replace(".mp3", "")}
            </p>
          </div>
          <audio
            controls
            autoPlay
            src={currentSong.song_url}
            className="w-64"
          />
        </div>
      )}
    </div>
  );
}

export default App;
