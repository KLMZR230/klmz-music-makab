<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>KLMZ MUSIC</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #111; color: #fff; }
    .container { max-width: 800px; margin: 0 auto; padding: 20px; }
    input, button { padding: 10px; margin: 5px 0; width: 100%; }
    .album { border: 1px solid #444; padding: 10px; margin: 10px 0; display: flex; align-items: center; }
    .album img { width: 100px; height: 100px; object-fit: cover; margin-right: 10px; }
    audio { width: 100%; margin-top: 5px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>KLMZ MUSIC</h1>

    <div id="auth">
      <h2>Iniciar sesión / Registro</h2>
      <input type="email" id="email" placeholder="Correo electrónico">
      <input type="password" id="password" placeholder="Contraseña">
      <button onclick="login()">Iniciar sesión</button>
      <button onclick="signup()">Registrarse</button>
    </div>

    <div id="app" style="display:none;">
      <h2>Bienvenido <span id="user-email"></span></h2>
      <button onclick="logout()">Cerrar sesión</button>

      <h3>Subir álbum</h3>
      <input type="text" id="album-name" placeholder="Nombre del álbum">
      <input type="file" id="cover-file" accept="image/*">
      <input type="file" id="song-file" accept="audio/*" multiple>
      <button onclick="uploadAlbum()">Subir álbum</button>

      <h3>Álbumes existentes</h3>
      <div id="albums"></div>
    </div>
  </div>

  <script>
    // ----------------------- Configura tu Supabase aquí -----------------------
    const supabaseUrl = 'https://lvrkifepqhxxmdcasncf.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2cmtpZmVwcWh4eG1kY2FzbmNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMjU3NTMsImV4cCI6MjA3MDcwMTc1M30.I-jHvTMEHHrUMM1-2YQrb-58YU4KmTrJuc95GJcjzhk';
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);
    const bucketName = 'media'; // Usamos tu único bucket
    // --------------------------------------------------------------------------

    // LOGIN
    async function login() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) alert(error.message);
      else loadApp();
    }

    // SIGNUP
    async function signup() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const { data, error } = await supabase.auth.signUp({ email, password });
      if (error) alert(error.message);
      else alert('Usuario registrado. Revisa tu correo para confirmar.');
    }

    // LOGOUT
    async function logout() {
      await supabase.auth.signOut();
      document.getElementById('auth').style.display = 'block';
      document.getElementById('app').style.display = 'none';
      document.getElementById('albums').innerHTML = '';
    }

    // CARGAR APP
    async function loadApp() {
      const user = supabase.auth.getUser();
      document.getElementById('auth').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      document.getElementById('user-email').innerText = (await user).data.user.email;
      loadAlbums();
    }

    // CARGAR ÁLBUMES EXISTENTES
    async function loadAlbums() {
      const { data: albums, error } = await supabase
        .from('albums')
        .select('*')
        .order('id', { ascending: false });

      if (error) { console.error(error); return; }

      const albumsDiv = document.getElementById('albums');
      albumsDiv.innerHTML = '';

      for (let album of albums) {
        const div = document.createElement('div');
        div.className = 'album';
        div.innerHTML = `
          <img src="${album.cover_url}" alt="${album.name}">
          <div>
            <h4>${album.name}</h4>
            <div id="songs-${album.id}"></div>
          </div>
        `;
        albumsDiv.appendChild(div);
        loadSongs(album.id);
      }
    }

    // CARGAR CANCIONES DE UN ÁLBUM
    async function loadSongs(albumId) {
      const { data: songs, error } = await supabase
        .from('songs')
        .select('*')
        .eq('album_id', albumId);

      if (error) { console.error(error); return; }

      const songsDiv = document.getElementById(`songs-${albumId}`);
      songsDiv.innerHTML = '';

      for (let song of songs) {
        const audio = document.createElement('audio');
        audio.controls = true;
        audio.src = song.file_url;
        songsDiv.appendChild(audio);
      }
    }

    // SUBIR ÁLBUM
    async function uploadAlbum() {
      const albumName = document.getElementById('album-name').value;
      const coverFile = document.getElementById('cover-file').files[0];
      const songFiles = document.getElementById('song-file').files;

      if (!albumName || !coverFile || songFiles.length === 0) {
        alert('Completa todos los campos');
        return;
      }

      // Subir portada
      const coverPath = `covers/${Date.now()}-${coverFile.name}`;
      const { data: coverData, error: coverError } = await supabase.storage
        .from(bucketName)
        .upload(coverPath, coverFile);

      if (coverError) { alert(coverError.message); return; }
      const { publicUrl: coverUrl } = supabase.storage.from(bucketName).getPublicUrl(coverPath);

      // Crear registro de álbum
      const { data: albumData, error: albumError } = await supabase
        .from('albums')
        .insert([{ name: albumName, cover_url: coverUrl }])
        .select()
        .single();

      if (albumError) { alert(albumError.message); return; }

      const albumId = albumData.id;

      // Subir canciones
      for (let songFile of songFiles) {
        const songPath = `songs/${Date.now()}-${songFile.name}`;
        const { error: songError } = await supabase.storage.from(bucketName).upload(songPath, songFile);
        if (songError) { console.error(songError.message); continue; }

        const { publicUrl: songUrl } = supabase.storage.from(bucketName).getPublicUrl(songPath);
        await supabase.from('songs').insert([{ album_id: albumId, file_url: songUrl }]);
      }

      alert('Álbum subido correctamente');
      loadAlbums();
    }

    // Mantener sesión
    supabase.auth.onAuthStateChange((event, session) => {
      if (session) loadApp();
      else logout();
    });

    // Inicializar si ya hay sesión
    supabase.auth.getSession().then(({ data }) => {
      if (data.session) loadApp();
    });
  </script>
</body>
</html>
