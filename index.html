<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>KLMZ MUSIC</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1DB954">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; background: #181818; color: #fff; padding-bottom: 84px; transition: all 0.3s ease; }
        header { background: #121212; padding: 1rem 1.5rem; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
        .logo { font-weight: bold; font-size: 1.4rem; letter-spacing: 1px; transition: all 0.3s ease; }
        .user-actions { display:flex; align-items: center; gap:.5rem; }
        .lock-icon { cursor:pointer; font-size:1.4rem; color:#fff; user-select:none; transition: all 0.3s ease; }
        .theme-selector { display: flex; align-items: center; gap: 0.3rem; margin-right: 0.5rem; }
        .theme-selector select { background: #333; color: #fff; border: 1px solid #555; border-radius: 4px; padding: 0.2rem; cursor: pointer; transition: all 0.3s ease; }
        main { flex:1; padding:1rem; max-width:900px; margin:0 auto;}
        .section-title { font-size:1.8rem; font-weight:bold; margin-bottom:1.5rem; transition: all 0.3s ease; }
        .album-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(140px,1fr)); gap:1.5rem;}
        .album-card { background:none; padding:0; cursor:pointer; display:flex; flex-direction:column; align-items:center; text-align:center; border: 2px solid transparent; border-radius: 12px; transition: all 0.3s ease; }
        .album-card:hover { transform:scale(1.05); }
        .album-img { border-radius:50%; width:100px; height:100px; object-fit:cover; margin-bottom:.7rem; background:#333; transition: all 0.3s ease; }
        .album-title { font-size:.98rem; font-weight: bold; margin-bottom: 0.4rem; transition: all 0.3s ease; }
        .album-artist { font-size: .9rem; color: #b3b3b3; transition: all 0.3s ease; }
        .song-list ul { list-style:none; padding:0; margin:0;}
        .song-list li { padding:.7rem; cursor:pointer; color:#1db954; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center; transition: all 0.3s ease;}
        .song-list li:hover { color:#fff; background: rgba(255,255,255,.05);}
        .song-actions { display: flex; gap: 0.8rem; align-items: center; }
        .action-btn { cursor: pointer; font-size: 1.2rem; transition: all 0.2s ease; }
        .action-btn:hover { transform: scale(1.1); }
        .favorite-btn { color: #666; }
        .favorite-btn.active { color: #ff4757; animation: heartBeat 0.3s ease; }
        .download-btn { color: #666; }
        .download-btn.downloaded { color: #1DB954; }
        .play-btn { color: #1DB954; }
        .player { position: fixed; bottom: 84px; left: 0; right: 0; background: #212121; border-top: 1px solid #282828; z-index: 300; display: none; align-items: center; padding: 0.8rem 1.2rem; transition: all 0.3s ease;}
        .player-img-mini { width:44px; height:44px; border-radius:50%; object-fit:cover; margin-right:1rem;}
        .player-info-mini { flex:1; overflow:hidden;}
        .player-title-mini { font-weight:bold; font-size:1rem; }
        .player-artist-mini { color:#b3b3b3; font-size:0.9rem; }
        .player-controls-inline { display:flex; align-items:center; gap:.5rem;}
        .play-btn-inline { background: #1DB954; color:#fff; border:none; border-radius:50%; width:36px; height:36px; cursor:pointer; transition: all 0.3s ease; }
        .modal { position: fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,.80); display:none; align-items:center; justify-content:center; z-index:2000; transition: all 0.3s ease;}
        .modal-content { background:#282828; padding:2rem; border-radius:8px; width:95%; max-width:430px; position: relative; transition: all 0.3s ease; }
        .form-group { margin-bottom:1rem;}
        .form-group input, .form-group select { width:100%; padding:.7rem; background:#404040; border:1px solid #555; border-radius:4px; color:#fff; transition: all 0.3s ease;}
        .btn-primary { background:#1DB954; color:#fff; border:none; padding:.7rem 1.5rem; border-radius:999px; cursor:pointer; width:100%; margin-top:.7rem; transition: all 0.3s ease; }
        .btn-primary:hover { background:#1ed760; }
        .btn-danger { background:#e22134; color:#fff; border:none; padding:.5rem 1rem; border-radius:4px; cursor:pointer; transition: all 0.3s ease; }
        .btn-danger:hover { background:#ff4757; }
        .close-modal { position:absolute; top:1rem; right:1rem; background:none; border:none; color:#fff; font-size:1.2rem; cursor:pointer;}
        .user-menu { position: relative; display: inline-block; }
        .user-dropdown { display: none; position: absolute; right: 0; top: calc(100% + 10px); background: #282828; min-width: 200px; border-radius: 8px; z-index: 1000; transition: all 0.3s ease; }
        .user-dropdown.show { display: block; }
        .user-dropdown-item { padding: 0.8rem 1rem; cursor: pointer; border-bottom: 1px solid #404040; transition: all 0.3s ease; }
        .user-dropdown-item:hover { background: #404040; }
        .bottom-nav { position: fixed; left: 0; right: 0; bottom: 20px; background: #181818; border-top: 1px solid #272727; display: flex; height: 64px; z-index: 5000; transition: all 0.3s ease; }
        .bottom-nav-item { color: #b3b3b3; text-align: center; flex: 1; padding: 4px 0; cursor: pointer; display: flex; flex-direction: column; align-items: center; transition: all 0.3s ease;}
        .bottom-nav-item.active { color: #1DB954; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .back-btn { margin-bottom: 1.2rem; background: #222; color: #fff; border: none; padding: 0.5rem 1.5rem; border-radius: 99px; cursor: pointer; transition: all 0.3s ease; }
        .back-btn:hover { background: #333; }
        .loading-indicator { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.9); color: #fff; padding: 1.5rem 2.5rem; border-radius: 12px; z-index: 2000; display: none; }
        .admin-section { margin-bottom: 2rem; background: #242424; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #1DB954; }
        .admin-form input[type="file"] { background: #333; border: 2px dashed #1DB954; padding: 1rem; border-radius: 8px; cursor: pointer; }
        .upload-progress { background: #333; border: 1px solid #1DB954; border-radius: 8px; padding: 1rem; margin: 1rem 0; }
        .upload-progress.success { background: #1a4a2e; border-color: #1DB954; }
        .upload-progress.error { background: #4a1a1a; border-color: #ff4757; }
        .copyright { position: fixed; bottom: 0; left: 0; width: 100%; height: 20px; background: #0a0a0a; color: #666; font-size: 0.7rem; text-align: center; padding: 2px 0; z-index: 10000; }
        
        /* Favoritos */
        .favorite-item { background: #242424; padding: 1rem; margin-bottom: 0.8rem; border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid #ff4757; transition: all 0.3s ease; }
        .favorite-item:hover { background: #333; transform: translateX(5px); }
        .favorite-info { flex: 1; }
        .favorite-title { font-weight: bold; margin-bottom: 0.3rem; color: #fff; }
        .favorite-artist { font-size: 0.9rem; color: #b3b3b3; }
        .favorite-album { font-size: 0.8rem; color: #666; margin-top: 0.2rem; }
        
        /* Animaciones */
        @keyframes heartBeat { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        
        /* Temas básicos */
        body.theme-neon { background: linear-gradient(135deg, #0a0a0a, #1a1a2e, #16213e) !important; }
        body.theme-neon .logo { color: #00ff88 !important; text-shadow: 0 0 20px #00ff88 !important; }
        body.theme-neon .btn-primary { background: linear-gradient(45deg, #00ff88, #00cc6a) !important; color: #000 !important; }
        body.theme-neon .song-list li { color: #00ff88 !important; }
        body.theme-neon .play-btn-inline { background: #00ff88 !important; color: #000 !important; }
        body.theme-neon .bottom-nav-item.active { color: #00ff88 !important; }
        
        body.theme-sunset { background: linear-gradient(135deg, #2c1810, #4a2c2a, #6d4c41) !important; }
        body.theme-sunset .logo { color: #ff7043 !important; text-shadow: 0 0 15px #ff7043 !important; }
        body.theme-sunset .btn-primary { background: linear-gradient(45deg, #ff7043, #ff5722) !important; }
        body.theme-sunset .song-list li { color: #ff7043 !important; }
        body.theme-sunset .play-btn-inline { background: #ff7043 !important; }
        body.theme-sunset .bottom-nav-item.active { color: #ff7043 !important; }
        
        body.theme-oceanic { background: linear-gradient(135deg, #0a192f, #173a5e, #3b6978) !important; }
        body.theme-oceanic .logo { color: #17a2b8 !important; text-shadow: 0 0 15px #17a2b8 !important; }
        body.theme-oceanic .btn-primary { background: linear-gradient(45deg, #17a2b8, #138496) !important; }
        body.theme-oceanic .song-list li { color: #17a2b8 !important; }
        body.theme-oceanic .play-btn-inline { background: #17a2b8 !important; }
        body.theme-oceanic .bottom-nav-item.active { color: #17a2b8 !important; }
    </style>
</head>
<body>
    <div class="loading-indicator" id="loading">🎵 Cargando...</div>
    
    <header>
        <span class="logo">KLMZ MUSIC</span>
        <div class="user-actions">
            <div class="theme-selector">
                <select id="theme-select" onchange="changeTheme(this.value)">
                    <option value="default">🎵 Default</option>
                    <option value="neon">⚡ Neon</option>
                    <option value="sunset">🌅 Sunset</option>
                    <option value="oceanic">🌊 Oceanic</option>
                </select>
            </div>
            <div class="user-menu">
                <div class="lock-icon" onclick="toggleUserMenu()">🔒</div>
                <div class="user-dropdown" id="userDropdown">
                    <div class="user-dropdown-item" onclick="showAuth('login')">🔐 Iniciar Sesión</div>
                    <div class="user-dropdown-item" onclick="showAuth('register')">📝 Registrarse</div>
                    <div class="user-dropdown-item" id="adminBtn" onclick="showSection('admin')" style="display:none;">⚙️ Panel Admin</div>
                    <div class="user-dropdown-item" id="logoutBtn" onclick="logout()" style="display:none;">🚪 Cerrar Sesión</div>
                </div>
            </div>
        </div>
    </header>

    <main>
        <section class="content-section active" id="home-section">
            <div class="section-title">Albums</div>
            <div class="album-grid" id="albums">
                <div style="text-align: center; padding: 2rem; color: #666;">
                    <h3>Cargando álbumes...</h3>
                </div>
            </div>
            <div id="album-detail" style="display:none;"></div>
        </section>

        <section class="content-section" id="search-section">
            <div class="section-title">🔍 Buscar Música</div>
            <input type="text" placeholder="¿Qué quieres escuchar?" id="search-input" style="width:100%; padding:1rem; background:#242424; border:none; border-radius:4px; color:#fff; margin-bottom:2rem;" onkeyup="searchMusic()">
            <div id="search-results"></div>
        </section>

        <section class="content-section" id="favorites-section">
            <div class="section-title">❤️ Mis Favoritos</div>
            <div id="favorites-content">
                <div style="text-align: center; padding: 2rem; color: #666;">
                    <h3>Cargando favoritos...</h3>
                </div>
            </div>
        </section>

        <section class="content-section" id="downloads-section">
            <div class="section-title">📥 Mis Descargas</div>
            <div id="downloads-content">
                <div style="text-align: center; padding: 2rem; color: #666;">
                    <h3>Cargando descargas...</h3>
                </div>
            </div>
        </section>

        <section class="content-section" id="admin-section">
            <div class="section-title">⚙️ Panel de Administración</div>
            <div id="admin-content"></div>
        </section>
    </main>

    <nav class="bottom-nav">
        <div class="bottom-nav-item active" onclick="showSection('home')">
            <div style="font-size: 1.2rem;">⌂</div>
            <small>Inicio</small>
        </div>
        <div class="bottom-nav-item" onclick="showSection('search')">
            <div style="font-size: 1.2rem;">🔍</div>
            <small>Buscar</small>
        </div>
        <div class="bottom-nav-item" onclick="showSection('downloads')">
            <div style="font-size: 1.2rem;">↓</div>
            <small>Descargas</small>
        </div>
        <div class="bottom-nav-item" onclick="showSection('favorites')">
            <div style="font-size: 1.2rem;">♡</div>
            <small>Favoritos</small>
        </div>
    </nav>

    <div class="player" id="mini-player">
        <img class="player-img-mini" id="player-img" alt="cover">
        <div class="player-info-mini">
            <div class="player-title-mini" id="player-title"></div>
            <div class="player-artist-mini" id="player-artist"></div>
        </div>
        <div class="player-controls-inline">
            <button class="play-btn-inline" id="play-btn" onclick="togglePlay()">▶</button>
        </div>
    </div>

    <div class="modal" id="auth-modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal()">&times;</button>
            <div id="login-form">
                <h2>Iniciar Sesión</h2>
                <form onsubmit="login(event)">
                    <div class="form-group">
                        <input type="email" id="login-email" placeholder="Email" required>
                    </div>
                    <div class="form-group">
                        <input type="password" id="login-password" placeholder="Contraseña" required>
                    </div>
                    <button type="submit" class="btn-primary">Iniciar Sesión</button>
                </form>
            </div>
            <div id="register-form" style="display: none;">
                <h2>Registrarse</h2>
                <form onsubmit="register(event)">
                    <div class="form-group">
                        <input type="email" id="register-email" placeholder="Email" required>
                    </div>
                    <div class="form-group">
                        <input type="password" id="register-password" placeholder="Contraseña" required>
                    </div>
                    <div class="form-group">
                        <input type="password" id="register-confirm" placeholder="Confirmar Contraseña" required>
                    </div>
                    <button type="submit" class="btn-primary">Registrarse</button>
                </form>
            </div>
        </div>
    </div>

    <div class="copyright">© 2025 KLMZ MUSIC - Desarrollado por Freddy Granados</div>
    <audio id="audio-player" preload="metadata"></audio>

    <script>
        // ===== VARIABLES GLOBALES =====
        let supabase;
        let currentUser = null;
        let allAlbums = [];  // ✅ CORREGIDO: era "allAlbumes"
        let allSongs = [];
        let currentSong = null;
        let currentAlbum = null;
        let currentPlaylist = [];
        let currentIndex = 0;
        let isPlaying = false;
        let isCordova = false;
        
        const CONFIG = {
            supabaseUrl: 'https://nqbldvpnqhngdtalvzov.supabase.co',
            supabaseKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xYmxkdnBucWhuZ2R0YWx2em92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyMjY0NjUsImV4cCI6MjA3MDgwMjQ2NX0.Zzg5D219sW7bhvl0_R5ypX9MF6nRzBSDIeo2Lvebab0',
            adminEmail: 'klmzr@gmail.com'
        };
        
        console.log('🚀 KLMZ MUSIC - Iniciando aplicación...');
        
        // ===== SISTEMA DE FAVORITOS COMPLETO =====
        class FavoritesManager {
            constructor() {
                this.favorites = this.loadFavorites();
            }

            loadFavorites() {
                try {
                    const stored = localStorage.getItem('klmz_favorites');
                    return stored ? JSON.parse(stored) : [];
                } catch (error) {
                    console.error('Error cargando favoritos:', error);
                    return [];
                }
            }

            saveFavorites() {
                try {
                    localStorage.setItem('klmz_favorites', JSON.stringify(this.favorites));
                    console.log('✅ Favoritos guardados:', this.favorites.length);
                } catch (error) {
                    console.error('Error guardando favoritos:', error);
                }
            }

            isFavorite(songId) {
                return this.favorites.some(fav => fav.id === songId);
            }

            addFavorite(song, album) {
                if (this.isFavorite(song.id)) {
                    console.log('⚠️ Canción ya en favoritos:', song.title);
                    return false;
                }

                const favorite = {
                    id: song.id,
                    title: song.title,
                    artist: album.artist,
                    album: album.title,
                    song_url: song.song_url,
                    cover_url: album.cover_url,
                    addedAt: new Date().toISOString()
                };

                this.favorites.push(favorite);
                this.saveFavorites();
                
                console.log('❤️ Agregado a favoritos:', song.title);
                return true;
            }

            removeFavorite(songId) {
                const initialLength = this.favorites.length;
                this.favorites = this.favorites.filter(fav => fav.id !== songId);
                
                if (this.favorites.length < initialLength) {
                    this.saveFavorites();
                    console.log('💔 Removido de favoritos');
                    return true;
                }
                
                return false;
            }

            toggleFavorite(song, album) {
                if (this.isFavorite(song.id)) {
                    this.removeFavorite(song.id);
                    return false;
                } else {
                    this.addFavorite(song, album);
                    return true;
                }
            }

            getAllFavorites() {
                return [...this.favorites];
            }

            getFavorite(songId) {
                return this.favorites.find(fav => fav.id === songId);
            }

            clearFavorites() {
                this.favorites = [];
                this.saveFavorites();
                console.log('🧹 Favoritos limpiados');
            }
        }

        // Instancia global de favoritos
        const favoritesManager = new FavoritesManager();
        
        // ===== FUNCIONES DE FAVORITOS =====
        function toggleFavorite(song, album, element) {
            console.log('❤️ Toggle favorito:', song.title);
            
            const wasAdded = favoritesManager.toggleFavorite(song, album);
            
            if (element) {
                element.innerHTML = wasAdded ? '❤️' : '🤍';
                element.classList.toggle('active', wasAdded);
                element.title = wasAdded ? 'Quitar de favoritos' : 'Agregar a favoritos';
            }
            
            updateAllFavoriteButtons(song.id, wasAdded);
            
            const message = wasAdded ? `❤️ "${song.title}" agregada a favoritos` : `💔 "${song.title}" removida de favoritos`;
            showToast(message);
            
            if (document.getElementById('favorites-section').classList.contains('active')) {
                setTimeout(() => loadFavorites(), 500);
            }
        }

        function updateAllFavoriteButtons(songId, isFavorite) {
            const buttons = document.querySelectorAll(`[data-song-id="${songId}"] .favorite-btn`);
            buttons.forEach(btn => {
                btn.innerHTML = isFavorite ? '❤️' : '🤍';
                btn.classList.toggle('active', isFavorite);
                btn.title = isFavorite ? 'Quitar de favoritos' : 'Agregar a favoritos';
            });
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: #333;
                color: #fff;
                padding: 12px 24px;
                border-radius: 25px;
                z-index: 10000;
                font-size: 14px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: slideInOut 2.5s ease-in-out;
            `;
            
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideInOut {
                    0% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
                    15%, 85% { opacity: 1; transform: translateX(-50%) translateY(0); }
                    100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
                }
            `;
            
            document.head.appendChild(style);
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (document.body.contains(toast)) document.body.removeChild(toast);
                if (document.head.contains(style)) document.head.removeChild(style);
            }, 2500);
        }

        async function loadFavorites() {
            console.log('❤️ Cargando sección de favoritos...');
            
            try {
                showLoading(true);
                const favorites = favoritesManager.getAllFavorites();
                const content = document.getElementById('favorites-content');
                
                if (favorites.length === 0) {
                    content.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #666;">
                            <div style="font-size: 4rem; margin-bottom: 1rem;">💔</div>
                            <h3>No tienes favoritos aún</h3>
                            <p>Marca canciones como favoritas presionando ❤️ en cualquier álbum</p>
                            <button onclick="showSection('home')" class="btn-primary" style="width: auto; margin-top: 1rem;">
                                🎵 Explorar Música
                            </button>
                        </div>
                    `;
                    return;
                }
                
                console.log(`❤️ Mostrando ${favorites.length} favoritos`);
                
                content.innerHTML = `
                    <div style="margin-bottom: 1rem; text-align: center; color: #ff4757;">
                        <strong>${favorites.length} canciones favoritas</strong>
                        <button onclick="clearAllFavorites()" class="btn-danger" style="margin-left: 1rem; width: auto; padding: 0.3rem 1rem; font-size: 0.8rem;">
                            🗑️ Limpiar Todo
                        </button>
                    </div>
                    
                    <div class="favorites-list">
                        ${favorites.sort((a, b) => new Date(b.addedAt) - new Date(a.addedAt)).map(favorite => `
                            <div class="favorite-item" data-song-id="${favorite.id}">
                                <div class="favorite-info" onclick="playFavoriteSong('${favorite.id}')">
                                    <div class="favorite-title">${favorite.title}</div>
                                    <div class="favorite-artist">${favorite.artist}</div>
                                    <div class="favorite-album">${favorite.album}</div>
                                    <small style="color: #666; font-size: 0.7rem;">
                                        Agregado: ${new Date(favorite.addedAt).toLocaleDateString()}
                                    </small>
                                </div>
                                <div class="song-actions">
                                    <span class="action-btn favorite-btn active" 
                                          onclick="toggleFavoriteFromList('${favorite.id}', this)" 
                                          title="Quitar de favoritos">❤️</span>
                                    <span class="action-btn play-btn" 
                                          onclick="playFavoriteSong('${favorite.id}')" 
                                          title="Reproducir">▶</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
            } catch (error) {
                console.error('❌ Error cargando favoritos:', error);
                document.getElementById('favorites-content').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #ff4757;">
                        <h3>❌ Error cargando favoritos</h3>
                        <p>${error.message}</p>
                        <button onclick="loadFavorites()" class="btn-primary" style="width: auto; margin-top: 1rem;">
                            🔄 Reintentar
                        </button>
                    </div>
                `;
            } finally {
                showLoading(false);
            }
        }

        function toggleFavoriteFromList(songId, element) {
            const favorite = favoritesManager.getFavorite(songId);
            if (favorite) {
                const song = {
                    id: favorite.id,
                    title: favorite.title,
                    song_url: favorite.song_url
                };
                
                const album = {
                    title: favorite.album,
                    artist: favorite.artist,
                    cover_url: favorite.cover_url
                };
                
                toggleFavorite(song, album, element);
            }
        }

        function playFavoriteSong(songId) {
            const favorite = favoritesManager.getFavorite(songId);
            if (!favorite) {
                alert('❌ Canción favorita no encontrada');
                return;
            }
            
            console.log('🎵 Reproduciendo favorito:', favorite.title);
            
            const song = {
                id: favorite.id,
                title: favorite.title,
                song_url: favorite.song_url
            };
            
            const album = {
                title: favorite.album,
                artist: favorite.artist,
                cover_url: favorite.cover_url
            };
            
            playSong(song, album);
        }

        function clearAllFavorites() {
            if (!confirm('¿Estás seguro de que quieres eliminar TODOS los favoritos? Esta acción no se puede deshacer.')) {
                return;
            }
            
            favoritesManager.clearFavorites();
            showToast('🧹 Todos los favoritos han sido eliminados');
            loadFavorites();
        }
        
        // ===== FUNCIONES BÁSICAS =====
        function detectEnvironment() {
            isCordova = !!(window.cordova || window.phonegap);
            console.log('📱 Entorno:', isCordova ? 'Cordova APK' : 'Navegador Web');
            return isCordova;
        }
        
        function changeTheme(theme) {
            console.log('🎨 Cambiando tema:', theme);
            const body = document.body;
            ['theme-neon', 'theme-sunset', 'theme-oceanic'].forEach(t => body.classList.remove(t));
            if (theme !== 'default') body.classList.add('theme-' + theme);
            localStorage.setItem('klmz_theme', theme);
        }
        
        function loadTheme() {
            const saved = localStorage.getItem('klmz_theme') || 'default';
            document.getElementById('theme-select').value = saved;
            changeTheme(saved);
        }
        
        async function initSupabase() {
            try {
                console.log('🔄 Inicializando Supabase...');
                supabase = window.supabase.createClient(CONFIG.supabaseUrl, CONFIG.supabaseKey);
                
                supabase.auth.onAuthStateChange((event, session) => {
                    currentUser = session?.user || null;
                    updateAuthUI();
                });
                
                const { data: { session } } = await supabase.auth.getSession();
                currentUser = session?.user || null;
                updateAuthUI();
                console.log('✅ Supabase inicializado');
                return true;
            } catch (error) {
                console.error('❌ Error Supabase:', error);
                return false;
            }
        }
        
        async function loadData() {
            try {
                showLoading(true);
                console.log('📊 Cargando datos...');
                
                if (!supabase) throw new Error('Supabase no inicializado');
                
                const { data: albums, error: albumError } = await supabase
                    .from('albums').select('*').order('created_at', { ascending: false });
                if (albumError) throw albumError;
                
                const { data: songs, error: songError } = await supabase
                    .from('songs').select('*, albums:album_id(*)').order('created_at', { ascending: false });
                if (songError) throw songError;
                
                allAlbums = albums || [];  // ✅ CORREGIDO: Variable correcta
                allSongs = songs || [];
                
                console.log(`✅ Cargados: ${allAlbums.length} álbumes, ${allSongs.length} canciones`);
                displayAlbums();
                
            } catch (error) {
                console.error('❌ Error cargando datos:', error);
                document.getElementById('albums').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #ff4757;">
                        <h3>❌ Error de conexión</h3>
                        <p>${error.message}</p>
                        <button onclick="loadData()" class="btn-primary" style="width: auto; margin-top: 1rem;">🔄 Reintentar</button>
                    </div>
                `;
            } finally {
                showLoading(false);
            }
        }
        
        function displayAlbums() {
            const container = document.getElementById('albums');
            
            if (allAlbums.length === 0) {  // ✅ CORREGIDO: Variable correcta
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <h3>📀 No hay álbumes</h3>
                        <p>Inicia sesión como admin para subir música</p>
                        ${currentUser?.email === CONFIG.adminEmail ? '<button onclick="showSection(\'admin\')" class="btn-primary" style="width: auto; margin-top: 1rem;">⚙️ Ir al Panel Admin</button>' : ''}
                    </div>
                `;
                return;
            }
            
            container.innerHTML = allAlbums.map(album => `  ✅ CORREGIDO: Variable correcta
                <div class="album-card" onclick="showAlbum('${album.id}')">
                    <img class="album-img" src="${album.cover_url}" alt="${album.title}" onerror="this.style.background='#333'; this.alt='🎵';">
                    <div class="album-title">${album.title}</div>
                    <div class="album-artist">${album.artist}</div>
                </div>
            `).join('');
        }
        
        async function showAlbum(albumId) {
            try {
                console.log('🔍 Mostrando álbum:', albumId);
                
                const album = allAlbums.find(a => a.id === albumId);  // ✅ CORREGIDO: Variable correcta
                if (!album) return;
                
                currentAlbum = album;
                
                document.getElementById('albums').style.display = 'none';
                const detail = document.getElementById('album-detail');
                detail.style.display = 'block';
                
                detail.innerHTML = `
                    <button class="back-btn" onclick="backToAlbums()">⟵ Volver</button>
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <img src="${album.cover_url}" style="width: 200px; height: 200px; border-radius: 12px;" onerror="this.style.background='#333';">
                        <h2>${album.title}</h2>
                        <p style="color: #b3b3b3;">${album.artist}</p>
                    </div>
                    <div id="song-list">🔄 Cargando canciones...</div>
                `;
                
                const { data: songs } = await supabase.from('songs').select('*').eq('album_id', albumId);
                const songList = document.getElementById('song-list');
                
                if (!songs || songs.length === 0) {
                    songList.innerHTML = `
                        <div style="text-align: center; color: #666; padding: 2rem;">
                            <h3>📭 No hay canciones</h3>
                            <p>Este álbum aún no tiene canciones</p>
                            ${currentUser?.email === CONFIG.adminEmail ? '<button onclick="showSection(\'admin\')" class="btn-primary" style="width: auto; margin-top: 1rem;">⚙️ Subir Canciones</button>' : ''}
                        </div>
                    `;
                    return;
                }
                
                currentPlaylist = songs;
                
                songList.innerHTML = `
                    <div class="song-list">
                        <ul>
                            ${songs.map((song, idx) => `
                                <li data-song-id="${song.id}">
                                    <span onclick="playSong(${JSON.stringify(song).replace(/"/g, '&quot;')}, ${JSON.stringify(album).replace(/"/g, '&quot;')})" style="flex: 1; cursor: pointer;">
                                        ${song.title}
                                    </span>
                                    <div class="song-actions">
                                        <span class="action-btn favorite-btn ${favoritesManager.isFavorite(song.id) ? 'active' : ''}" 
                                              onclick="toggleFavorite(${JSON.stringify(song).replace(/"/g, '&quot;')}, ${JSON.stringify(album).replace(/"/g, '&quot;')}, this)" 
                                              title="${favoritesManager.isFavorite(song.id) ? 'Quitar de favoritos' : 'Agregar a favoritos'}">
                                            ${favoritesManager.isFavorite(song.id) ? '❤️' : '🤍'}
                                        </span>
                                        <span class="action-btn download-btn" 
                                              onclick="downloadSong(${JSON.stringify(song).replace(/"/g, '&quot;')}, ${JSON.stringify(album).replace(/"/g, '&quot;')}, this)" 
                                              title="Descargar para offline">↓</span>
                                        <span class="action-btn play-btn" 
                                              onclick="playSong(${JSON.stringify(song).replace(/"/g, '&quot;')}, ${JSON.stringify(album).replace(/"/g, '&quot;')})" 
                                              title="Reproducir">▶</span>
                                    </div>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
                
            } catch (error) {
                console.error('❌ Error mostrando álbum:', error);
            }
        }
        
        function playSong(song, album, playlist = [], index = 0) {
            if (!song || !song.song_url) {
                console.error('❌ Datos de canción inválidos');
                return;
            }
            
            currentSong = song;
            currentAlbum = album;
            currentPlaylist = playlist;
            currentIndex = index;
            
            console.log('🎵 Reproduciendo:', song.title);
            
            const audio = document.getElementById('audio-player');
            audio.src = song.song_url;
            audio.play();
            
            updatePlayer();
        }
        
        function updatePlayer() {
            const player = document.getElementById('mini-player');
            if (currentSong && currentAlbum) {
                player.style.display = 'flex';
                document.getElementById('player-img').src = currentAlbum.cover_url || '';
                document.getElementById('player-title').textContent = currentSong.title;
                document.getElementById('player-artist').textContent = currentAlbum.artist;
            }
        }
        
        function togglePlay() {
            const audio = document.getElementById('audio-player');
            const btn = document.getElementById('play-btn');
            
            if (audio.paused) {
                audio.play();
                btn.textContent = '⏸';
                isPlaying = true;
            } else {
                audio.pause();
                btn.textContent = '▶';
                isPlaying = false;
            }
        }
        
        function backToAlbums() {
            document.getElementById('album-detail').style.display = 'none';
            document.getElementById('albums').style.display = 'grid';
        }
        
        function downloadSong(song, album, element) {
            element.textContent = '⏳';
            element.style.color = '#ff9800';
            
            setTimeout(() => {
                element.classList.add('downloaded');
                element.textContent = '✓';
                element.style.color = '#1DB954';
                showToast(`✅ "${song.title}" descargada (demo)`);
            }, 2000);
        }
        
        function loadDownloads() {
            document.getElementById('downloads-content').innerHTML = `
                <div style="text-align: center; padding: 2rem; color: #666;">
                    <h3>📥 Descargas Offline</h3>
                    <p>Entorno: ${isCordova ? '📱 APK' : '🌐 Web'}</p>
                    <p>Las descargas reales se implementarán con Cordova</p>
                </div>
            `;
        }
        
        function showSection(sectionName) {
            console.log('🧭 Navegando a:', sectionName);
            
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.bottom-nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById(sectionName + '-section').classList.add('active');
            
            // Marcar navegación activa
            const navMap = { home: 0, search: 1, downloads: 2, favorites: 3 };
            const navItems = document.querySelectorAll('.bottom-nav-item');
            if (navMap.hasOwnProperty(sectionName)) {
                navItems[navMap[sectionName]].classList.add('active');
            }
            
            if (sectionName === 'favorites') {
                loadFavorites();
            }
            
            if (sectionName === 'downloads') {
                loadDownloads();
            }
            
            if (sectionName === 'admin') {
                if (!currentUser || currentUser.email !== CONFIG.adminEmail) {
                    alert('🔒 Solo el administrador puede acceder');
                    showSection('home');
                    return;
                }
                loadAdminPanel();
            }
        }
        
        function searchMusic() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const results = document.getElementById('search-results');
            
            if (!query) {
                results.innerHTML = '';
                return;
            }
            
            const found = allSongs.filter(s => 
                s.title.toLowerCase().includes(query) || 
                s.albums?.artist?.toLowerCase().includes(query)
            );
            
            if (found.length === 0) {
                results.innerHTML = '<p style="color: #666;">No se encontraron resultados</p>';
                return;
            }
            
            results.innerHTML = found.map(song => `
                <div style="padding: 1rem; background: #242424; margin: 0.5rem 0; border-radius: 8px; cursor: pointer;" onclick="playSong(${JSON.stringify(song).replace(/"/g, '&quot;')}, ${JSON.stringify(song.albums).replace(/"/g, '&quot;')})">
                    <strong>${song.title}</strong><br>
                    <small style="color: #b3b3b3;">${song.albums?.artist || 'Desconocido'}</small>
                </div>
            `).join('');
        }
        
        function toggleUserMenu() { document.getElementById('userDropdown').classList.toggle('show'); }
        
        function showAuth(type) {
            document.getElementById('userDropdown').classList.remove('show');
            document.getElementById('login-form').style.display = type === 'login' ? 'block' : 'none';
            document.getElementById('register-form').style.display = type === 'register' ? 'block' : 'none';
            document.getElementById('auth-modal').style.display = 'flex';
        }
        
        function closeModal() { document.getElementById('auth-modal').style.display = 'none'; }
        function showLoading(show) { document.getElementById('loading').style.display = show ? 'block' : 'none'; }
        
        function updateAuthUI() {
            const adminBtn = document.getElementById('adminBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const lockIcon = document.querySelector('.lock-icon');
            
            if (currentUser) {
                lockIcon.textContent = '👤';
                logoutBtn.style.display = 'block';
                if (currentUser.email === CONFIG.adminEmail) {
                    adminBtn.style.display = 'block';
                    lockIcon.textContent = '⚙️';
                }
            } else {
                lockIcon.textContent = '🔒';
                adminBtn.style.display = 'none';
                logoutBtn.style.display = 'none';
            }
        }
        
        async function login(event) {
            event.preventDefault();
            try {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                const { error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;
                alert('✅ ¡Bienvenido!');
                closeModal();
            } catch (error) {
                alert('❌ Error: ' + error.message);
            }
        }
        
        async function register(event) {
            event.preventDefault();
            try {
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const confirm = document.getElementById('register-confirm').value;
                if (password !== confirm) { alert('❌ Las contraseñas no coinciden'); return; }
                const { error } = await supabase.auth.signUp({ email, password });
                if (error) throw error;
                alert('✅ Registro exitoso. Revisa tu email.');
                closeModal();
            } catch (error) {
                alert('❌ Error: ' + error.message);
            }
        }
        
        async function logout() {
            try {
                await supabase.auth.signOut();
                alert('✅ Sesión cerrada');
                showSection('home');
            } catch (error) {
                console.error('Error logout:', error);
            }
        }
        
        function loadAdminPanel() {
            document.getElementById('admin-content').innerHTML = `
                <div style="text-align: center; padding: 2rem; color: #666;">
                    <h3>⚙️ Panel Admin</h3>
                    <p><strong>Álbumes:</strong> ${allAlbums.length}</p>
                    <p><strong>Canciones:</strong> ${allSongs.length}</p>
                    <p>Panel completo disponible próximamente</p>
                </div>
            `;
        }
        
        // ===== INICIALIZACIÓN =====
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('🚀 === INICIALIZANDO KLMZ MUSIC ===');
            
            try {
                loadTheme();
                detectEnvironment();
                
                const supabaseOk = await initSupabase();
                if (supabaseOk) {
                    await loadData();
                    console.log('✅ === APLICACIÓN INICIADA CORRECTAMENTE ===');
                } else {
                    console.error('❌ Error inicializando aplicación');
                }
                
                const audio = document.getElementById('audio-player');
                audio.addEventListener('ended', () => {
                    isPlaying = false;
                    document.getElementById('play-btn').textContent = '▶';
                });
                
            } catch (error) {
                console.error('❌ Error crítico:', error);
                showLoading(false);
            }
        });
        
        document.addEventListener('deviceready', () => {
            console.log('📱 === CORDOVA DEVICE READY ===');
            detectEnvironment();
        }, false);
        
        console.log('✅ === SCRIPT CARGADO COMPLETAMENTE ===');
    </script>
</body>
</html>
