<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>KLMZ MUSIC</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  
  <style>
    /* Estilos Base y Generales */
    * { box-sizing: border-box; }
    body { margin: 0; font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; background: #181818; color: #fff; padding-bottom: 84px; transition: all 0.3s ease;}
    header { background: #121212; padding: 1rem 1.5rem; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; transition: all 0.3s ease; }
    .logo { font-weight: bold; font-size: 1.4rem; letter-spacing: 1px; transition: all 0.3s ease; color: #1DB954; }
    .user-actions { display:flex; align-items: center; gap:.5rem; }
    .lock-icon { cursor:pointer; font-size:1.4rem; color:#fff; user-select:none; transition: all 0.3s ease; }
    .lock-icon:hover { opacity:.7;}
    .lock-icon.admin{background:#1DB954;animation:crownPulse 1.5s infinite;border-radius:8px;padding:0.5rem;}
    @keyframes crownPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
    .theme-selector { display: flex; align-items: center; gap: 0.3rem; margin-right: 0.5rem; }
    .theme-selector label { font-size: 0.7rem; color: #b3b3b3; }
    .theme-selector select { background: #333; color: #fff; border: 1px solid #555; border-radius: 4px; padding: 0.1rem 0.2rem; font-size: 0.7rem; cursor: pointer; transition: all 0.3s ease; }
    .app-container { display: flex; min-height: calc(100vh - 60px);}
    main { flex:1; padding:1rem; max-width:900px; margin:0 auto;}
    .section-title { font-size:1.8rem; font-weight:bold; margin-bottom:1.5rem; transition: all 0.3s ease; }
    .album-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(140px,1fr)); gap:1.5rem;}
    .album-card { background:none; padding:0; cursor:pointer; display:flex; flex-direction:column; align-items:center; text-align:center; transition: transform 0.3s; position: relative;}
    .album-card:hover { transform:scale(1.05);}
    .album-actions{position:absolute;top:0.5rem;right:0.5rem;display:none;gap:0.5rem;z-index:2;}
    .album-card:hover .album-actions{display:flex;}
    .album-img { border-radius:50%; width:100px; height:100px; object-fit:cover; margin-bottom:.7rem; background:#333; transition: all 0.3s ease; }
    .album-title { font-size:.98rem; font-weight: bold; margin-bottom: 0.4rem; transition: all 0.3s ease; }
    .album-artist { font-size: .9rem; color: #b3b3b3; transition: all 0.3s ease; }

    /* Contenedor principal de la barra de navegaci√≥n */
    .bottom-nav {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 20px;
        background: #181818;
        border-top: 1px solid #272727;
        display: flex;
        height: 64px;
        z-index: 5000;
        transition: all 0.3s ease;
    }

    .bottom-nav-item {
        color: #b3b3b3;         
        text-align: center;
        flex: 1;                
        font-size: 1.14rem;
        padding: 4px 0 0 0;
        border-radius: 7px;
        cursor: pointer;
        display: flex;
        flex-direction: column; 
        align-items: center;
        transition: all 0.3s ease;
    }

    .bottom-nav-item.active {
        color: #1DB954;                        
        background: rgba(29, 185, 84, .09); 
    }

    .bottom-nav-item:hover {
        background: rgba(255, 255, 255, 0.05); 
    }

    .bottom-nav-item .icon {
        font-size: 1.12rem;
    }

    .bottom-nav-item small {
        font-size: 0.67rem;
    }

    .download-icon {
        cursor: pointer;      
        color: #666;          
        font-size: 1.2rem;    
    }

    .download-icon.downloaded {
        color: #1DB954;      
    }

    .content-section { display: none; }
    .content-section.active { display: block; }
    .copyright { position: fixed; bottom: 0; left: 0; width: 100%; height: 20px; background: #0a0a0a; color: #666; font-size: 0.7rem; text-align: center; padding: 2px 0; z-index: 10000; border-top: 1px solid #222; }
    .empty-state{text-align:center;padding:3rem;color:#666;background:#333;border-radius:12px}
    .modal { position: fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,.80); display:none; align-items:center; justify-content:center; z-index:2000; transition: all 0.3s ease;}
    .modal.show{display:flex;}
    .modal-content { background:#282828; padding:2rem; border-radius:8px; width:95%; max-width:430px; max-height:90vh; overflow-y:auto; transition: all 0.3s ease; position:relative; }
    .form-group { margin-bottom:1rem;}
    .form-group label { display:block; margin-bottom:0.5rem;}
    .form-group input, .form-group select { width:100%; padding:.7rem; background:#404040; border:1px solid #555; border-radius:4px; color:#fff; transition: all 0.3s ease;}
    .form-group input:focus, .form-group select:focus{outline:none;border-color:#1DB954;}
    .btn-primary { background:#1DB954; color:#fff; border:none; padding:.7rem 1.5rem; border-radius:999px; cursor:pointer; width:100%; margin-top:.7rem; transition: all 0.3s ease; }
    .btn-primary:hover { background:#1ed760; }
    .btn-danger { background:#e22134; color:#fff; border:none; padding:.5rem 1rem; border-radius:4px; cursor:pointer; transition: all 0.3s ease; }
    .btn{background:#1DB954;color:#fff;border:none;padding:.7rem 1.5rem;border-radius:8px;cursor:pointer;transition:all 0.3s ease;}
    .btn:hover{background:#1ed760;}
    .btn.secondary{background:#555;}
    .btn.secondary:hover{background:#666;}
    .btn.small{padding:.3rem .6rem;font-size:.8rem;}
    .btn.admin{background:linear-gradient(45deg,#1DB954,#1ed760);box-shadow:0 4px 15px rgba(29,185,84,0.3);}
    .close-modal { position:absolute; top:1rem; right:1rem; background:none; border:none; color:#fff; font-size:1.2rem; cursor:pointer;}
    .user-info { display: none; }
    .admin-badge{background:linear-gradient(45deg,#1DB954,#1ed760);color:#fff;padding:0.25rem 0.75rem;border-radius:20px;font-size:0.8rem;font-weight:bold;margin-left:0.5rem}
    .back-btn{background:#333;color:#fff;border:none;padding:0.5rem 1.5rem;border-radius:99px;cursor:pointer;margin-bottom:1rem;transition:all 0.3s ease;}
    .back-btn:hover{background:#555;}

    /* Status y elementos espec√≠ficos de KLMZ */
    .status{padding:1.5rem;border-radius:12px;font-family:monospace;margin:2rem 0;border-left:4px solid #1DB954}
    .status.success{background:#1a2e1a;color:#51cf66;border-left-color:#51cf66}
    .status.error{background:#2d1517;color:#ff6b6b;border-left-color:#ff6b6b}
    .status.info{background:#1e2833;color:#74c0fc;border-left-color:#74c0fc}
    .status.admin{background:#1DB954;color:#fff;border-left-color:#fff;font-weight:bold}
    .admin-panel{display:none;background:#242424;border-radius:12px;padding:2rem;margin:2rem 0;border:2px solid #1DB954}
    .admin-panel.show{display:block}
    .admin-tabs{display:flex;gap:1rem;margin-bottom:2rem;border-bottom:1px solid #333}
    .admin-tab{background:none;border:none;color:#999;padding:1rem;cursor:pointer;border-bottom:2px solid transparent;transition:all 0.2s}
    .admin-tab.active{color:#1DB954;border-bottom-color:#1DB954}
    .admin-content{display:none}
    .admin-content.active{display:block}
    .form-row{display:flex;gap:1rem;margin-bottom:1rem}
    .cover-upload{border:2px dashed #555;padding:2rem;text-align:center;border-radius:8px;transition:all 0.2s;cursor:pointer;position:relative;overflow:hidden}
    .cover-upload:hover{border-color:#1DB954}
    .cover-upload.has-image{border-color:#1DB954;background-size:cover;background-position:center;background-repeat:no-repeat}
    .cover-upload-overlay{background:rgba(0,0,0,0.7);padding:1rem;border-radius:4px;position:relative;z-index:2}
    .cover-preview{width:100px;height:100px;border-radius:8px;object-fit:cover;margin:0 auto 1rem;display:none}
    .file-upload{border:2px dashed #555;padding:2rem;text-align:center;border-radius:8px;transition:border-color 0.2s}
    .file-upload:hover{border-color:#1DB954}
    .file-upload.dragover{border-color:#1DB954;background:#1a2e1a}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:2rem}
    .stat-card{background:#333;padding:1.5rem;border-radius:8px;text-align:center}
    .stat-number{font-size:2rem;font-weight:bold;color:#1DB954;margin-bottom:0.5rem}
    .stat-label{color:#999;font-size:0.9rem}
    .test-buttons{display:flex;gap:1rem;margin-top:2rem;flex-wrap:wrap}

    /* üéµ ESTILOS PARA DETALLES DE √ÅLBUM Y CANCIONES */
    .album-detail{padding:2rem 0;}
    .album-detail-header{display:flex;gap:2rem;margin-bottom:2rem;align-items:flex-end;}
    .album-detail-cover{width:200px;height:200px;border-radius:12px;object-fit:cover;box-shadow:0 8px 32px rgba(0,0,0,0.3);}
    .album-detail-info{flex:1;}
    .album-detail-type{color:#b3b3b3;font-size:0.9rem;margin-bottom:0.5rem;}
    .album-detail-title{font-size:2.5rem;font-weight:bold;margin-bottom:1rem;}
    .album-detail-artist{font-size:1.2rem;color:#b3b3b3;margin-bottom:1rem;}
    .album-detail-stats{color:#b3b3b3;font-size:0.9rem;}
    .songs-section{margin-top:2rem;}
    .songs-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;}
    .song-item{display:flex;align-items:center;padding:0.8rem;border-radius:8px;cursor:pointer;transition:all 0.3s ease;}
    .song-item:hover{background:rgba(255,255,255,0.05);}
    .song-number{width:20px;color:#b3b3b3;font-size:0.9rem;}
    .song-info{flex:1;margin-left:1rem;}
    .song-title{font-weight:500;margin-bottom:0.2rem;}
    .song-artist{color:#b3b3b3;font-size:0.9rem;}
    .song-actions{display:flex;gap:0.5rem;align-items:center;}

    /* ‚úÖ NUEVOS ESTILOS PARA M√öLTIPLES ARCHIVOS */
    .files-selected{background:#1a2e1a;border:2px solid #1DB954;padding:1rem;border-radius:8px;margin-top:1rem;}
    .file-list{max-height:200px;overflow-y:auto;margin-top:0.5rem;}
    .file-item{display:flex;justify-content:space-between;align-items:center;padding:0.5rem;border-bottom:1px solid #333;}
    .file-item:last-child{border-bottom:none;}
    .file-name{color:#1DB954;font-size:0.9rem;}
    .file-size{color:#666;font-size:0.8rem;}

    /* ‚úÖ TEMAS VISUALES */
    body.theme-neon { background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 70%, #0a0a0a 100%) !important; color: #00ff88 !important; }
    body.theme-neon .logo { color: #00ff88 !important; text-shadow: 0 0 15px #00ff88, 0 0 30px #00ff88 !important; animation: neonPulse 2s ease-in-out infinite alternate !important; }
    body.theme-neon .section-title { color: #00ff88 !important; text-shadow: 0 0 15px rgba(0,255,136,0.7) !important; }
    body.theme-neon .bottom-nav { background: linear-gradient(180deg, rgba(26,26,46,0.95), rgba(10,10,10,0.95)) !important; border-top: 2px solid #00ff88 !important; }
    body.theme-neon .bottom-nav-item.active { color: #00ff88 !important; background: rgba(0,255,136,0.15) !important; }
    body.theme-minimal { background: linear-gradient(135deg, #0f0f0f 0%, #1c1c1c 50%, #2a2a2a 70%, #0f0f0f 100%) !important; color: #f5f5f5 !important; }
    body.theme-minimal .bottom-nav { background: rgba(28,28,28,0.95) !important; }
    body.theme-minimal .bottom-nav-item.active { color: #f5f5f5 !important; background: rgba(245,245,245,0.08) !important; }
    body.theme-sunset { background: linear-gradient(135deg, #2c1810 0%, #4a2c2a 30%, #6d4c41 60%, #1a1a1a 100%) !important; color: #ffab91 !important; }
    body.theme-sunset .bottom-nav-item.active { color: #ff8a65 !important; background: rgba(255,138,101,0.15) !important; }
    body.theme-pastel { background: linear-gradient(135deg, #1a1625 0%, #2d2438 50%, #3d2f47 70%, #4a3b5c 100%) !important; color: #d4c5f9 !important; }
    body.theme-pastel .bottom-nav-item.active { color: #d4c5f9 !important; background: rgba(184,169,232,0.15) !important; }
    body.theme-luxury { background: linear-gradient(135deg, #0f1419 0%, #1a252f 50%, #2c3e50 70%, #34495e 100%) !important; color: #f0f8ff !important; }
    body.theme-luxury .bottom-nav-item.active { color: #d4af37 !important; background: rgba(212,175,55,0.15) !important; }
    body.theme-oceanic { background: linear-gradient(135deg, #0a192f 0%, #173a5e 50%, #3b6978 70%, #84a9ac 100%) !important; color: #e0e0e0 !important; }
    body.theme-oceanic .bottom-nav-item.active { color: #98ded9 !important; background: rgba(152, 222, 217, 0.1) !important; }

    @keyframes neonPulse { 0% { text-shadow: 0 0 15px #00ff88, 0 0 30px #00ff88; } 100% { text-shadow: 0 0 25px #00ff88, 0 0 40px #00ff88, 0 0 60px #00ff88; } }
    @media (max-width: 768px) { .album-img { width: 80px; height: 80px; } .album-detail-header{flex-direction:column;text-align:center;} .album-detail-cover{width:150px;height:150px;margin:0 auto;} }
  </style>
</head>

<body>
  <header>
    <span class="logo">üéµ KLMZ MUSIC</span>
    <div class="user-actions">
      <div class="theme-selector">
        <label>Tema:</label>
        <select id="themeSelect">
          <option value="">Spotify</option>
          <option value="theme-neon">‚ö° Neon</option>
          <option value="theme-minimal">‚ú® Minimal</option>
          <option value="theme-sunset">üåÖ Sunset</option>
          <option value="theme-pastel">üå∏ Pastel</option>
          <option value="theme-luxury">üíé Luxury</option>
          <option value="theme-oceanic">üåä Oceanic</option>
        </select>
      </div>
      <div id="userInfo" class="user-info">
        <span id="userName"></span>
        <button class="btn-danger" onclick="logout()">Salir</button>
      </div>
      <div id="lockIcon" class="lock-icon">üîí</div>
    </div>
  </header>

  <div class="app-container">
    <main>
      <!-- Secci√≥n Inicio -->
      <div id="homeSection" class="content-section active">
        <h1 class="section-title">√Ålbumes</h1>
        <div id="status" class="status info">üîÑ Inicializando conexi√≥n directa...</div>
        
        <!-- Botones admin -->
        <div class="test-buttons" id="adminButtons" style="display:none;">
          <button class="btn" onclick="testConnection()">üîç Probar Conexi√≥n</button>
          <button class="btn secondary" onclick="addTestAlbum()">‚ûï Agregar √Ålbum de Prueba</button>
          <button class="btn secondary" onclick="loadAlbums()">üìÄ Cargar √Ålbumes</button>
          <button class="btn admin" onclick="toggleAdminPanel()">üëë Panel Admin</button>
        </div>
        
        <!-- Panel de administraci√≥n COMPLETO -->
        <div id="adminPanel" class="admin-panel">
          <div class="admin-tabs">
            <button class="admin-tab active" onclick="switchAdminTab('albums')">üìÄ Crear √Ålbum</button>
            <button class="admin-tab" onclick="switchAdminTab('songs')">üéµ Agregar Canciones</button>
            <button class="admin-tab" onclick="switchAdminTab('upload')">üì§ Subir Archivos</button>
            <button class="admin-tab" onclick="switchAdminTab('stats')">üìä Estad√≠sticas</button>
            <button class="admin-tab" onclick="switchAdminTab('settings')">‚öôÔ∏è Configuraci√≥n</button>
          </div>
          
          <!-- Tab: Crear √Ålbum -->
          <div id="adminTabAlbums" class="admin-content active">
            <h3>üéµ Crear Nuevo √Ålbum</h3>
            <form id="albumForm" onsubmit="createAlbumWithCover(event)">
              <div class="form-row">
                <div class="form-group">
                  <label for="albumName">Nombre del √Ålbum: *</label>
                  <input type="text" id="albumName" required placeholder="Ej: KLMZ Hits Vol. 1">
                </div>
                <div class="form-group">
                  <label for="artistName">Artista: *</label>
                  <input type="text" id="artistName" required placeholder="Ej: Freddy Granados">
                </div>
              </div>
              
              <div class="form-group">
                <label>Portada del √Ålbum: *</label>
                <div id="coverUpload" class="cover-upload" onclick="document.getElementById('coverInput').click()">
                  <div class="cover-upload-overlay">
                    <img id="coverPreview" class="cover-preview" alt="Preview">
                    <div id="coverUploadText">
                      <p>üì∏ Haz clic para subir portada</p>
                      <p style="color:#999;font-size:0.9rem;">JPG, PNG (m√°x. 5MB)</p>
                    </div>
                  </div>
                </div>
                <input type="file" id="coverInput" accept=".jpg,.jpeg,.png" style="display:none" onchange="handleCoverUpload(event)">
              </div>
              
              <button type="submit" class="btn admin" id="createAlbumBtn">‚ûï Crear √Ålbum</button>
            </form>
          </div>

          <!-- ‚úÖ TAB MEJORADA: Agregar M√∫ltiples Canciones -->
          <div id="adminTabSongs" class="admin-content">
            <h3>üéµ Agregar Canciones a √Ålbum</h3>
            <div class="form-group">
              <label for="selectAlbum">Seleccionar √Ålbum: *</label>
              <select id="selectAlbum" required>
                <option value="">Selecciona un √°lbum...</option>
              </select>
            </div>
            
            <form id="songForm" onsubmit="addMultipleSongsToAlbum(event)">
              <div class="form-group">
                <label for="defaultArtist">Artista por Defecto:</label>
                <input type="text" id="defaultArtist" placeholder="Ej: Freddy Granados (se aplicar√° a todas las canciones)">
              </div>
              
              <div class="form-group">
                <label>Archivos de Audio: *</label>
                <div class="file-upload" id="songFileUpload">
                  <p>üéµ Arrastra m√∫ltiples archivos de m√∫sica aqu√≠ o haz clic para seleccionar</p>
                  <p style="color:#999;font-size:0.9rem;">Soporta: MP3, WAV, FLAC - Selecciona m√∫ltiples archivos</p>
                  <input type="file" id="songFileInput" multiple accept=".mp3,.wav,.flac" style="display:none">
                </div>
                <div id="selectedFiles" class="files-selected" style="display:none;">
                  <p><strong>Archivos seleccionados:</strong></p>
                  <div id="filesList" class="file-list"></div>
                </div>
              </div>
              
              <button type="submit" class="btn admin" id="addSongsBtn">‚ûï Agregar Canciones</button>
            </form>
          </div>
          
          <!-- Tab: Subir Archivos -->
          <div id="adminTabUpload" class="admin-content">
            <h3>üì§ Subir Archivos de Audio</h3>
            <div class="file-upload" id="fileUpload">
              <p>üéµ Arrastra archivos de m√∫sica aqu√≠ o haz clic para seleccionar</p>
              <p style="color:#999;font-size:0.9rem;">Soporta: MP3, WAV, FLAC</p>
              <input type="file" id="fileInput" multiple accept=".mp3,.wav,.flac" style="display:none">
            </div>
            <div id="uploadProgress" style="display:none;margin-top:1rem;">
              <div style="background:#333;border-radius:8px;overflow:hidden;">
                <div id="progressBar" style="background:#1DB954;height:20px;width:0%;transition:width 0.3s;"></div>
              </div>
              <p id="uploadStatus" style="margin-top:0.5rem;text-align:center;"></p>
            </div>
          </div>
          
          <!-- Tab: Estad√≠sticas -->
          <div id="adminTabStats" class="admin-content">
            <h3>üìä Estad√≠sticas del Sistema</h3>
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-number" id="statAlbums">-</div>
                <div class="stat-label">√Ålbumes</div>
              </div>
              <div class="stat-card">  
                <div class="stat-number" id="statSongs">-</div>
                <div class="stat-label">Canciones</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="statStorage">-</div>
                <div class="stat-label">Archivos</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="statUsers">1</div>
                <div class="stat-label">Usuarios</div>
              </div>
            </div>
            <button class="btn" onclick="refreshStats()">üîÑ Actualizar Estad√≠sticas</button>
          </div>
          
          <!-- Tab: Configuraci√≥n -->
          <div id="adminTabSettings" class="admin-content">
            <h3>‚öôÔ∏è Configuraci√≥n del Sistema</h3>
            <div class="form-group">
              <label>Estado del Sistema:</label>
              <p style="color:#51cf66;">‚úÖ Todos los servicios funcionando correctamente</p>
            </div>
            <div class="form-group">
              <label>Informaci√≥n del Proyecto:</label>
              <p style="color:#999;font-family:monospace;font-size:0.9rem;">
                Project ID: 68ab0cf2000365979a71<br>
                Database ID: 68ab0d9b00124af501a5<br>
                Endpoint: https://nyc.cloud.appwrite.io/v1
              </p>
            </div>
            <div class="form-group">
              <label>üëë Desarrollador & Propietario:</label>
              <p style="color:#1DB954;font-weight:bold;font-size:1.1rem;">
                üéµ Freddy Granados<br>
                <span style="color:#999;font-size:0.9rem;font-weight:normal;">Creador y desarrollador de KLMZ MUSIC</span><br>
                <span style="color:#666;font-size:0.8rem;font-weight:normal;">¬© 2025 Todos los derechos reservados</span>
              </p>
            </div>
            <button class="btn secondary" onclick="testAllServices()">üîç Probar Todos los Servicios</button>
            <button class="btn secondary" onclick="debugSystemState()" style="margin-left:1rem;">üîç Debug Sistema</button>
            <button class="btn-danger" onclick="clearAllData()" style="margin-left:1rem;">üóëÔ∏è Limpiar Datos de Prueba</button>
          </div>
        </div>
        
        <div id="albums" class="album-grid"></div>
      </div>

      <!-- ‚úÖ SECCI√ìN: Detalle de √Ålbum -->
      <div id="albumDetailSection" class="content-section">
        <button class="back-btn" onclick="showSection('home')">‚Üê Volver a √Ålbumes</button>
        <div id="albumDetailContent" class="album-detail"></div>
      </div>

      <!-- Secci√≥n Buscar -->
      <div id="searchSection" class="content-section">
        <h1 class="section-title">Buscar</h1>
        <input type="text" id="searchInput" placeholder="üîç Buscar √°lbumes, artistas..." style="width:100%;padding:1rem;background:#242424;border:1px solid #555;border-radius:8px;color:#fff;margin-bottom:2rem;font-size:1rem;">
        <div id="searchResults" class="album-grid">
          <div class="empty-state">
            <h2>üîç Buscar m√∫sica</h2>
            <p>Escribe el nombre de un √°lbum o artista para buscar.</p>
          </div>
        </div>
      </div>

      <!-- Secci√≥n Biblioteca -->
      <div id="librarySection" class="content-section">
        <h1 class="section-title">Mi Biblioteca</h1>
        <div class="empty-state">
          <h2>üìö Tu Biblioteca</h2>
          <p>Aqu√≠ aparecer√°n tus √°lbumes favoritos y m√∫sica guardada.</p>
        </div>
      </div>

      <!-- Secci√≥n Perfil -->
      <div id="profileSection" class="content-section">
        <h1 class="section-title">Perfil</h1>
        <div style="text-align:center;padding:2rem;">
          <div id="profileContent">
            <div class="empty-state">
              <h2>üë§ Mi Perfil</h2>
              <p>Inicia sesi√≥n para ver tu perfil y configuraci√≥n.</p>
              <button class="btn-primary" onclick="openAuthModal()" style="width:auto;margin-top:1rem;padding:0.8rem 2rem;">Iniciar Sesi√≥n</button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Navegaci√≥n inferior -->
  <div class="bottom-nav">
    <div class="bottom-nav-item active" data-section="home">
      <div class="icon">üè†</div>
      <small>Inicio</small>
    </div>
    <div class="bottom-nav-item" data-section="search">
      <div class="icon">üîç</div>
      <small>Buscar</small>
    </div>
    <div class="bottom-nav-item" data-section="library">
      <div class="icon">üìö</div>
      <small>Biblioteca</small>
    </div>
    <div class="bottom-nav-item" data-section="profile">
      <div class="icon">üë§</div>
      <small>Perfil</small>
    </div>
  </div>

  <!-- ‚úÖ COPYRIGHT SIN "POWERED BY APPWRITE" -->
  <div class="copyright">
    ¬© 2025 KLMZ MUSIC - Desarrollado por Freddy Granados
  </div>

  <!-- Modal de autenticaci√≥n -->
  <div id="authModal" class="modal">
    <div class="modal-content">
      <button class="close-modal" onclick="closeAuthModal()">&times;</button>
      <h2 id="modalTitle">Iniciar Sesi√≥n</h2>
      
      <form id="authForm" onsubmit="handleAuth(event)">
        <div class="form-group">
          <label for="email">Email:</label>
          <input type="email" id="email" required>
        </div>
        
        <div class="form-group">
          <label for="password">Contrase√±a:</label>
          <input type="password" id="password" required>
        </div>
        
        <div id="nameGroup" class="form-group" style="display:none">
          <label for="name">Nombre:</label>
          <input type="text" id="name">
        </div>
        
        <button type="submit" class="btn-primary" id="authSubmitBtn">Iniciar Sesi√≥n</button>
      </form>
      
      <p><span id="toggleText">¬øNo tienes cuenta?</span>
      <a href="#" onclick="toggleAuthMode()" id="toggleBtn">Registrarse</a></p>
    </div>
  </div>

  <script>
    // Variables globales
    const CONFIG = {
      endpoint: 'https://nyc.cloud.appwrite.io/v1',
      projectId: '68ab0cf2000365979a71',
      databaseId: '68ab0d9b00124af501a5',
      albumsCollectionId: '68ab0dd00024ddeb51fd',
      songsCollectionId: '68ab0f0e002d9f334b0d',
      bucketId: '68ab1101001cff947e6b'
    };

    const $ = id => document.getElementById(id);
    let isLoginMode = true;
    let currentUser = null;
    let isAdmin = false;
    let currentAlbums = [];
    let currentAlbumSongs = [];
    let selectedCoverFile = null;
    let selectedSongFiles = [];

    function setStatus(message, type = 'info') {
      const emoji = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'admin' ? 'üëë' : 'üîÑ';
      $('status').innerHTML = `${emoji} ${message}`;
      $('status').className = `status ${type}`;
    }

    // ‚úÖ FUNCI√ìN DE NAVEGACI√ìN MEJORADA
    function showSection(section) {
      console.log('Cambiando a secci√≥n:', section);
      
      document.querySelectorAll('.content-section').forEach(sec => {
        sec.classList.remove('active');
      });
      
      const targetSection = document.getElementById(section + 'Section');
      if (targetSection) {
        targetSection.classList.add('active');
      }
      
      document.querySelectorAll('.bottom-nav-item').forEach(item => {
        item.classList.remove('active');
      });
      
      const activeNavItem = document.querySelector(`[data-section="${section}"]`);
      if (activeNavItem) {
        activeNavItem.classList.add('active');
      }

      if (section === 'home') {
        loadAlbums();
        loadAlbumsForSelect();
      } else if (section === 'search') {
        setTimeout(() => {
          const searchInput = document.getElementById('searchInput');
          if (searchInput) searchInput.focus();
        }, 100);
      } else if (section === 'profile') {
        updateProfileSection();
      }
    }

    function changeTheme(theme) {
      const themes = ['theme-neon', 'theme-minimal', 'theme-sunset', 'theme-pastel', 'theme-luxury', 'theme-oceanic'];
      themes.forEach(t => document.body.classList.remove(t));
      
      if (theme) {
        document.body.classList.add(theme);
        localStorage.setItem('klmzTheme', theme);
      } else {
        localStorage.removeItem('klmzTheme');
      }
    }
    // ‚úÖ CLIENTE APPWRITE CON UPLOAD DE ARCHIVOS Y URL CORREGIDA
    class SimpleAppwriteClient {
      constructor(endpoint, projectId) {
        this.endpoint = endpoint;
        this.projectId = projectId;
        this.headers = {
          'X-Appwrite-Project': projectId,
          'Content-Type': 'application/json'
        };
      }

      async request(method, path, params = {}) {
        let url = `${this.endpoint}${path}`;
        const options = {
          method,
          headers: { ...this.headers },
          credentials: 'include'
        };

        if (method === 'GET' && Object.keys(params).length > 0) {
          const queryString = new URLSearchParams(params).toString();
          url = `${url}?${queryString}`;
        } else if (method !== 'GET') {
          options.body = JSON.stringify(params);
        }

        const response = await fetch(url, options);

        if (response.status === 204) {
          return { success: true };
        }

        const text = await response.text();
        if (!text) {
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          return { success: true };
        }

        const data = JSON.parse(text);
        if (!response.ok) {
          throw new Error(data.message || `HTTP ${response.status}`);
        }

        return data;
      }

      async getAccount() {
        return this.request('GET', '/account');
      }

      async createUser(email, password, name) {
        return this.request('POST', '/account', {
          userId: 'unique()',
          email,
          password,
          name
        });
      }

      async createSession(email, password) {
        return this.request('POST', '/account/sessions/email', { email, password });
      }

      async deleteSession() {
        return this.request('DELETE', '/account/sessions/current');
      }

      async listDocuments(databaseId, collectionId) {
        return this.request('GET', `/databases/${databaseId}/collections/${collectionId}/documents`);
      }

      async createDocument(databaseId, collectionId, documentId, data, permissions = []) {
        return this.request('POST', `/databases/${databaseId}/collections/${collectionId}/documents`, {
          documentId,
          data,
          permissions
        });
      }

      async deleteDocument(databaseId, collectionId, documentId) {
        return this.request('DELETE', `/databases/${databaseId}/collections/${collectionId}/documents/${documentId}`);
      }

      async createFile(bucketId, fileId, file) {
        const formData = new FormData();
        formData.append('fileId', fileId);
        formData.append('file', file);

        const options = {
          method: 'POST',
          headers: {
            'X-Appwrite-Project': this.projectId,
          },
          credentials: 'include',
          body: formData
        };

        const response = await fetch(`${this.endpoint}/storage/buckets/${bucketId}/files`, options);
        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.message || `HTTP ${response.status}`);
        }

        return data;
      }

      async listFiles(bucketId) {
        return this.request('GET', `/storage/buckets/${bucketId}/files`);
      }

      // ‚úÖ FUNCI√ìN CORREGIDA PARA OBTENER URL DE IMAGEN
      getFilePreview(bucketId, fileId, width = 300, height = 300) {
        return `${this.endpoint}/storage/buckets/${bucketId}/files/${fileId}/preview?width=${width}&height=${height}&project=${this.projectId}`;
      }

      // ‚úÖ FUNCI√ìN PARA OBTENER URL DIRECTA DEL ARCHIVO
      getFileView(bucketId, fileId) {
        return `${this.endpoint}/storage/buckets/${bucketId}/files/${fileId}/view?project=${this.projectId}`;
      }
    }

    const client = new SimpleAppwriteClient(CONFIG.endpoint, CONFIG.projectId);

    // ‚úÖ MANEJAR SUBIDA DE PORTADA
    function handleCoverUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (file.size > 5 * 1024 * 1024) {
        setStatus('‚ùå La imagen debe ser menor a 5MB', 'error');
        return;
      }

      if (!['image/jpeg', 'image/jpg', 'image/png'].includes(file.type)) {
        setStatus('‚ùå Solo se permiten im√°genes JPG y PNG', 'error');
        return;
      }

      selectedCoverFile = file;

      const reader = new FileReader();
      reader.onload = (e) => {
        const coverUpload = $('coverUpload');
        const coverPreview = $('coverPreview');
        const coverUploadText = $('coverUploadText');

        coverPreview.src = e.target.result;
        coverPreview.style.display = 'block';
        coverUploadText.innerHTML = `
          <p>‚úÖ ${file.name}</p>
          <p style="color:#1DB954;font-size:0.9rem;">Haz clic para cambiar</p>
        `;
        coverUpload.classList.add('has-image');
        coverUpload.style.backgroundImage = `url(${e.target.result})`;
      };
      reader.readAsDataURL(file);

      setStatus(`‚úÖ Portada seleccionada: ${file.name}`, 'success');
    }

    // ‚úÖ CREAR √ÅLBUM CON PORTADA (PROBLEMA DE GUARDADO CORREGIDO)
    async function createAlbumWithCover(event) {
      event.preventDefault();
      
      if (!isAdmin) {
        setStatus('Solo los administradores pueden crear √°lbumes', 'error');
        return;
      }

      const name = $('albumName').value;
      const artist = $('artistName').value;

      if (!selectedCoverFile) {
        setStatus('‚ùå Debes subir una portada para el √°lbum', 'error');
        return;
      }

      console.log('üîÑ Iniciando creaci√≥n de √°lbum con portada...');
      console.log('Nombre del √°lbum:', name);
      console.log('Artista:', artist);
      console.log('Archivo de portada:', selectedCoverFile);

      setStatus('üëë Creando √°lbum...', 'admin');
      $('createAlbumBtn').disabled = true;
      $('createAlbumBtn').textContent = 'Creando...';

      try {
        // 1. Subir la portada primero
        console.log('üì∏ Subiendo portada al storage...');
        setStatus('üì∏ Subiendo portada...', 'admin');
        const coverId = `cover-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        console.log('ID de portada generado:', coverId);
        
        const coverFile = await client.createFile(CONFIG.bucketId, coverId, selectedCoverFile);
        console.log('‚úÖ Portada subida exitosamente. Response:', coverFile);
        console.log('üîë ID del archivo de portada:', coverFile.$id);
        
        // 2. Crear el √°lbum con permisos de propietario - ‚úÖ GUARDAR CORRECTAMENTE EL coverStorageId
        setStatus('üíΩ Creando √°lbum en la base de datos...', 'admin');
        const albumData = {
          name: name,
          artistName: artist,
          coverStorageId: coverFile.$id  // ‚úÖ CORRECCI√ìN: Guardar el ID exacto del archivo
        };

        console.log('üíæ Datos del √°lbum a guardar:', albumData);

        // ‚úÖ FORMATO CORRECTO DE PERMISOS
        const permissions = [
          'read("any")',
          `write("user:${currentUser.$id}")`,
          `delete("user:${currentUser.$id}")`
        ];

        console.log('üîê Permisos:', permissions);

        const albumId = `album-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        console.log('üìù Creando documento con ID:', albumId);

        await client.createDocument(
          CONFIG.databaseId,
          CONFIG.albumsCollectionId,
          albumId,
          albumData,
          permissions
        );

        console.log('‚úÖ √Ålbum creado exitosamente en la base de datos');
        setStatus(`üëë ¬°√Ålbum "${name}" creado exitosamente!`, 'admin');
        
        // Limpiar formulario
        $('albumForm').reset();
        selectedCoverFile = null;
        $('coverPreview').style.display = 'none';
        $('coverUpload').classList.remove('has-image');
        $('coverUpload').style.backgroundImage = '';
        $('coverUploadText').innerHTML = `
          <p>üì∏ Haz clic para subir portada</p>
          <p style="color:#999;font-size:0.9rem;">JPG, PNG (m√°x. 5MB)</p>
        `;
        
        setTimeout(() => {
          loadAlbums();
          loadAlbumsForSelect();
        }, 1000);
        
      } catch (error) {
        console.error('‚ùå Error completo:', error);
        console.error('Stack trace:', error.stack);
        setStatus(`‚ùå Error creando √°lbum: ${error.message}`, 'error');
      }

      $('createAlbumBtn').disabled = false;
      $('createAlbumBtn').textContent = '‚ûï Crear √Ålbum';
    }

    // ‚úÖ CARGAR √ÅLBUMES EN SELECTOR
    async function loadAlbumsForSelect() {
      try {
        const response = await client.listDocuments(CONFIG.databaseId, CONFIG.albumsCollectionId);
        const selectAlbum = $('selectAlbum');
        
        selectAlbum.innerHTML = '<option value="">Selecciona un √°lbum...</option>';
        
        response.documents.forEach(album => {
          const option = document.createElement('option');
          option.value = album.$id;
          option.textContent = `${album.name} - ${album.artistName}`;
          selectAlbum.appendChild(option);
        });
        
      } catch (error) {
        console.error('Error cargando √°lbumes para selector:', error);
      }
    }

    // ‚úÖ FUNCI√ìN CORREGIDA: Agregar m√∫ltiples canciones con manejo de errores robusto
    async function addMultipleSongsToAlbum(event) {
      event.preventDefault();
      
      if (!isAdmin) {
        setStatus('Solo los administradores pueden agregar canciones', 'error');
        return;
      }

      const albumId = $('selectAlbum').value;
      const defaultArtist = $('defaultArtist').value || 'Artista Desconocido';

      if (!albumId) {
        setStatus('‚ùå Debes seleccionar un √°lbum', 'error');
        return;
      }

      if (selectedSongFiles.length === 0) {
        setStatus('‚ùå Debes seleccionar archivos de m√∫sica', 'error');
        return;
      }

      console.log(`üîÑ Iniciando subida de ${selectedSongFiles.length} archivos...`);
      console.log('√Ålbum ID:', albumId);
      console.log('Artista por defecto:', defaultArtist);

      setStatus(`üëë Procesando ${selectedSongFiles.length} canci√≥n(es)...`, 'admin');
      $('addSongsBtn').disabled = true;
      $('addSongsBtn').textContent = 'Subiendo...';

      let successCount = 0;
      let errorCount = 0;
      const errors = [];

      try {
        // Procesar cada archivo individualmente
        for (let i = 0; i < selectedSongFiles.length; i++) {
          const file = selectedSongFiles[i];
          const progress = Math.round(((i + 1) / selectedSongFiles.length) * 100);
          
          setStatus(`üëë Procesando "${file.name}" (${i + 1}/${selectedSongFiles.length}) - ${progress}%`, 'admin');
          console.log(`üéµ Procesando archivo ${i + 1}:`, file.name, `(${file.size} bytes)`);

          try {
            // 1. Subir archivo de audio
            console.log('üì§ Subiendo archivo de audio...');
            const audioId = `audio-${Date.now()}-${i}-${Math.random().toString(36).substr(2, 9)}`;
            const audioFile = await client.createFile(CONFIG.bucketId, audioId, file);
            console.log('‚úÖ Archivo subido con ID:', audioFile.$id);
            
            // 2. Extraer t√≠tulo del archivo (sin extensi√≥n)
            const songTitle = file.name.replace(/\.[^/.]+$/, "").replace(/_/g, ' ');
            console.log('üè∑Ô∏è T√≠tulo extra√≠do:', songTitle);
            
            // 3. Crear datos de la canci√≥n
            const songData = {
              title: songTitle,
              artist: defaultArtist,
              albumId: albumId,
              audioFileId: audioFile.$id
            };
            console.log('üíæ Datos de la canci√≥n:', songData);

            // 4. Definir permisos
            const permissions = [
              'read("any")',
              `write("user:${currentUser.$id}")`,
              `delete("user:${currentUser.$id}")`
            ];
            console.log('üîê Permisos:', permissions);

            // 5. Crear documento en la base de datos
            const songId = `song-${Date.now()}-${i}-${Math.random().toString(36).substr(2, 9)}`;
            console.log('üìù Creando documento con ID:', songId);
            
            await client.createDocument(
              CONFIG.databaseId,
              CONFIG.songsCollectionId,
              songId,
              songData,
              permissions
            );

            console.log(`‚úÖ Canci√≥n "${songTitle}" agregada exitosamente`);
            successCount++;

          } catch (fileError) {
            console.error(`‚ùå Error procesando ${file.name}:`, fileError);
            console.error('Stack:', fileError.stack);
            errors.push({
              fileName: file.name,
              error: fileError.message,
              details: fileError.stack
            });
            errorCount++;
            
            // Continuar con el siguiente archivo en lugar de parar
            continue;
          }
        }

        // Mostrar resultados finales
        console.log(`üèÅ Proceso completado. Exitosas: ${successCount}, Errores: ${errorCount}`);
        
        if (successCount > 0 && errorCount === 0) {
          setStatus(`üëë ¬°${successCount} canci√≥n(es) agregada(s) exitosamente!`, 'admin');
        } else if (successCount > 0 && errorCount > 0) {
          setStatus(`üëë ${successCount} canci√≥n(es) agregada(s), ${errorCount} error(es). Ver consola para detalles.`, 'admin');
          console.warn('‚ö†Ô∏è Errores detallados:', errors);
        } else {
          setStatus(`‚ùå No se pudo agregar ninguna canci√≥n. ${errorCount} error(es) encontrados. Ver consola.`, 'error');
          console.error('üö® Todos los archivos fallaron. Errores:', errors);
          
          // Mostrar primer error en pantalla para debugging
          if (errors.length > 0) {
            console.error('üîç Primer error detallado:', errors[0]);
            setStatus(`‚ùå Error principal: ${errors[0].error}`, 'error');
          }
        }
        
        // Limpiar formulario solo si hubo al menos un √©xito
        if (successCount > 0) {
          $('songForm').reset();
          $('selectAlbum').value = '';
          $('defaultArtist').value = '';
          selectedSongFiles = [];
          $('selectedFiles').style.display = 'none';
          $('songFileUpload').innerHTML = `
            <p>üéµ Arrastra m√∫ltiples archivos de m√∫sica aqu√≠ o haz clic para seleccionar</p>
            <p style="color:#999;font-size:0.9rem;">Soporta: MP3, WAV, FLAC - Selecciona m√∫ltiples archivos</p>
          `;
        }
        
      } catch (generalError) {
        console.error('üö® Error general en la funci√≥n:', generalError);
        setStatus(`‚ùå Error general: ${generalError.message}`, 'error');
      }

      // Restaurar bot√≥n
      $('addSongsBtn').disabled = false;
      $('addSongsBtn').textContent = '‚ûï Agregar Canciones';
    }

    // ‚úÖ FUNCI√ìN DE DEBUGGING: Verificar estado del sistema
    async function debugSystemState() {
      console.log('üîç DEBUGGING - Estado del sistema:');
      console.log('Usuario actual:', currentUser);
      console.log('Es admin:', isAdmin);
      console.log('Archivos seleccionados:', selectedSongFiles.length);
      console.log('CONFIG:', CONFIG);
      
      try {
        // Probar conexi√≥n a cada servicio
        console.log('üß™ Probando Account API...');
        const accountTest = await client.getAccount();
        console.log('‚úÖ Account API OK:', accountTest.name);
        
        console.log('üß™ Probando Database API...');
        const albumsTest = await client.listDocuments(CONFIG.databaseId, CONFIG.albumsCollectionId);
        console.log('‚úÖ Database API OK:', albumsTest.documents.length, '√°lbumes');
        
        console.log('üß™ Probando Storage API...');
        const storageTest = await client.listFiles(CONFIG.bucketId);
        console.log('‚úÖ Storage API OK:', storageTest.files?.length || 0, 'archivos');
        
        setStatus('‚úÖ Debugging completado - Ver consola para detalles', 'success');
        
      } catch (error) {
        console.error('‚ùå Error en debugging:', error);
        setStatus(`‚ùå Error en debugging: ${error.message}`, 'error');
      }
    }

    // ‚úÖ FUNCI√ìN HELPER: Formatear tama√±o de archivo
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // ‚úÖ VER DETALLE DE √ÅLBUM
    async function viewAlbumDetail(albumId, albumName) {
      try {
        setStatus('Cargando detalles del √°lbum...');
        
        const album = currentAlbums.find(a => a.$id === albumId);
        if (!album) {
          setStatus('‚ùå √Ålbum no encontrado', 'error');
          return;
        }

        const songsResponse = await client.listDocuments(CONFIG.databaseId, CONFIG.songsCollectionId);
        const albumSongs = songsResponse.documents.filter(song => song.albumId === albumId);
        
        showAlbumDetail(album, albumSongs);
        showSection('albumDetail');
        
        setStatus(`‚úÖ ${albumSongs.length} canci√≥n(es) cargadas`, 'success');
        
      } catch (error) {
        console.error('Error cargando detalles:', error);
        setStatus(`‚ùå Error: ${error.message}`, 'error');
      }
    }

    // ‚úÖ MOSTRAR DETALLE DE √ÅLBUM CON PORTADAS CORREGIDAS
    function showAlbumDetail(album, songs) {
      console.log('üìã Mostrando detalle del √°lbum:', album);
      console.log('üñºÔ∏è coverStorageId del √°lbum:', album.coverStorageId);
      
      let coverUrl = null;
      
      // ‚úÖ VERIFICAR SI HAY coverStorageId V√ÅLIDO
      if (album.coverStorageId && !album.coverStorageId.startsWith('test-cover-')) {
        try {
          coverUrl = client.getFilePreview(CONFIG.bucketId, album.coverStorageId, 200, 200);
          console.log('üîó URL de portada generada:', coverUrl);
        } catch (error) {
          console.error('‚ùå Error generando URL de portada:', error);
          coverUrl = null;
        }
      } else {
        console.log('‚ö†Ô∏è No hay coverStorageId v√°lido o es un test cover');
      }

      const albumDetailContent = $('albumDetailContent');
      
      albumDetailContent.innerHTML = `
        <div class="album-detail-header">
          <div style="width:200px;height:200px;border-radius:12px;overflow:hidden;">
            ${coverUrl ? 
              `<img src="${coverUrl}" alt="${album.name}" class="album-detail-cover" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" crossorigin="anonymous">
               <div class="album-detail-cover" style="width:200px;height:200px;background:linear-gradient(135deg, #1DB954, #1ed760);display:none;align-items:center;justify-content:center;font-size:4rem;color:white;text-shadow:0 2px 4px rgba(0,0,0,0.3);">üéµ</div>` :
              `<div class="album-detail-cover" style="width:200px;height:200px;background:linear-gradient(135deg, #1DB954, #1ed760);display:flex;align-items:center;justify-content:center;font-size:4rem;color:white;text-shadow:0 2px 4px rgba(0,0,0,0.3);">üéµ</div>`
            }
          </div>
          <div class="album-detail-info">
            <div class="album-detail-type">√ÅLBUM</div>
            <h1 class="album-detail-title">${album.name}</h1>
            <div class="album-detail-artist">${album.artistName}</div>
            <div class="album-detail-stats">
              ${songs.length} canci√≥n${songs.length !== 1 ? 'es' : ''}
            </div>
          </div>
        </div>

        <div class="songs-section">
          <div class="songs-header">
            <h3>Canciones</h3>
            ${isAdmin ? `
              <button class="btn small" onclick="switchAdminTab('songs'); showSection('home');">‚ûï Agregar Canciones</button>
            ` : ''}
          </div>
          
          ${songs.length > 0 ? `
            <div class="songs-list">
              ${songs.map((song, index) => `
                <div class="song-item">
                  <div class="song-number">${index + 1}</div>
                  <div class="song-info">
                    <div class="song-title">${song.title}</div>
                    <div class="song-artist">${song.artist}</div>
                  </div>
                  <div class="song-actions">
                    ${song.audioFileId ? `<button class="btn small" onclick="playSong('${song.audioFileId}')">‚ñ∂Ô∏è</button>` : ''}
                    ${isAdmin ? `<button class="btn danger small" onclick="deleteSong('${song.$id}', '${song.title}')">üóëÔ∏è</button>` : ''}
                  </div>
                </div>
              `).join('')}
            </div>
          ` : `
            <div class="empty-state">
              <h3>üéµ Sin canciones</h3>
              <p>${isAdmin ? 'Agrega canciones usando el panel admin.' : 'Este √°lbum a√∫n no tiene canciones.'}</p>
            </div>
          `}
        </div>
      `;
    }

    // ‚úÖ REPRODUCIR CANCI√ìN
    function playSong(audioFileId) {
      try {
        const audioUrl = client.getFileView(CONFIG.bucketId, audioFileId);
        
        let audio = document.getElementById('musicPlayer');
        if (!audio) {
          audio = document.createElement('audio');
          audio.id = 'musicPlayer';
          audio.controls = true;
          audio.style.position = 'fixed';
          audio.style.bottom = '100px';
          audio.style.left = '50%';
          audio.style.transform = 'translateX(-50%)';
          audio.style.zIndex = '6000';
          document.body.appendChild(audio);
        }
        
        audio.src = audioUrl;
        audio.play();
        
        setStatus('üéµ Reproduciendo canci√≥n...', 'success');
        
      } catch (error) {
        setStatus(`‚ùå Error reproduciendo: ${error.message}`, 'error');
      }
    }

    // ‚úÖ ELIMINAR CANCI√ìN
    async function deleteSong(songId, songTitle) {
      if (!isAdmin) return;
      
      if (!confirm(`¬øEst√°s seguro de eliminar "${songTitle}"?`)) return;

      try {
        await client.deleteDocument(CONFIG.databaseId, CONFIG.songsCollectionId, songId);
        setStatus(`üëë Canci√≥n "${songTitle}" eliminada`, 'admin');
        
        const currentAlbumId = $('selectAlbum').value;
        if (currentAlbumId) {
          setTimeout(() => viewAlbumDetail(currentAlbumId, 'Album'), 500);
        }
        
      } catch (error) {
        setStatus(`‚ùå Error eliminando canci√≥n: ${error.message}`, 'error');
      }
    }

    // ‚úÖ FUNCIONES PANEL ADMIN
    function toggleAdminPanel() {
      if (!isAdmin) return;
      
      const panel = $('adminPanel');
      if (panel.classList.contains('show')) {
        panel.classList.remove('show');
      } else {
        panel.classList.add('show');
        refreshStats();
      }
    }

    function switchAdminTab(tabName) {
      document.querySelectorAll('.admin-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.admin-content').forEach(content => content.classList.remove('active'));
      
      document.querySelector(`[onclick="switchAdminTab('${tabName}')"]`).classList.add('active');
      $(`adminTab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.add('active');
      
      if (tabName === 'songs') {
        loadAlbumsForSelect();
      }
    }

    async function refreshStats() {
      if (!isAdmin) return;

      try {
        const albums = await client.listDocuments(CONFIG.databaseId, CONFIG.albumsCollectionId);
        const songs = await client.listDocuments(CONFIG.databaseId, CONFIG.songsCollectionId);
        const files = await client.listFiles(CONFIG.bucketId);

        $('statAlbums').textContent = albums.total || albums.documents.length;
        $('statSongs').textContent = songs.total || songs.documents.length;
        $('statStorage').textContent = files.total || files.files?.length || 0;

      } catch (error) {
        console.log('Error obteniendo estad√≠sticas:', error);
        $('statAlbums').textContent = currentAlbums.length;
        $('statSongs').textContent = '0';
        $('statStorage').textContent = '0';
      }
    }

    async function testAllServices() {
      if (!isAdmin) return;
      
      setStatus('üëë Probando todos los servicios...', 'admin');
      
      try {
        await client.getAccount();
        await client.listDocuments(CONFIG.databaseId, CONFIG.albumsCollectionId);
        await client.listFiles(CONFIG.bucketId);
        
        setStatus('üëë Todos los servicios funcionan correctamente', 'admin');
        
      } catch (error) {
        setStatus(`‚ùå Error en servicios: ${error.message}`, 'error');
      }
    }

    async function clearAllData() {
      if (!isAdmin) return;
      
      if (!confirm('‚ö†Ô∏è PELIGRO: ¬øEliminar TODOS los datos de prueba? Esta acci√≥n no se puede deshacer.')) return;

      setStatus('üóëÔ∏è Eliminando datos de prueba...');

      try {
        const albums = await client.listDocuments(CONFIG.databaseId, CONFIG.albumsCollectionId);
        const songs = await client.listDocuments(CONFIG.databaseId, CONFIG.songsCollectionId);
        
        let deleted = 0;
        
        for (const song of songs.documents) {
          if (song.title && (song.title.includes('Test') || song.title.includes('Prueba') || song.title.includes('Demo'))) {
            await client.deleteDocument(CONFIG.databaseId, CONFIG.songsCollectionId, song.$id);
            deleted++;
          }
        }
        
        for (const album of albums.documents) {
          if (album.name.includes('Prueba') || album.name.includes('Demo') || album.name.includes('Test') || album.name.includes('ADMIN')) {
            await client.deleteDocument(CONFIG.databaseId, CONFIG.albumsCollectionId, album.$id);
            deleted++;
          }
        }
        
        setStatus(`üëë ${deleted} elemento(s) de prueba eliminados`, 'admin');
        setTimeout(loadAlbums, 1000);
        
      } catch (error) {
        setStatus(`‚ùå Error limpiando datos: ${error.message}`, 'error');
      }
    }

    // ‚úÖ MANEJAR SUBIDA DE ARCHIVOS DE AUDIO
    async function handleFiles(files) {
      if (!isAdmin) {
        setStatus('Solo los administradores pueden subir archivos', 'error');
        return;
      }

      const uploadProgress = $('uploadProgress');
      const progressBar = $('progressBar');
      const uploadStatus = $('uploadStatus');
      
      uploadProgress.style.display = 'block';
      
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const progress = ((i + 1) / files.length) * 100;
        
        progressBar.style.width = progress + '%';
        uploadStatus.textContent = `Subiendo ${file.name} (${i + 1}/${files.length})...`;
        
        try {
          const fileId = 'upload-' + Date.now() + '-' + i;
          await client.createFile(CONFIG.bucketId, fileId, file);
          console.log(`‚úÖ Archivo ${file.name} subido`);
        } catch (error) {
          console.error(`‚ùå Error subiendo ${file.name}:`, error);
        }
      }
      
      uploadStatus.textContent = `‚úÖ ${files.length} archivo(s) subido(s) correctamente`;
      setStatus(`üëë ${files.length} archivo(s) subido(s) al Storage`, 'admin');
      
      setTimeout(() => {
        uploadProgress.style.display = 'none';
        progressBar.style.width = '0%';
      }, 3000);
    }

    // ‚úÖ FUNCIONES B√ÅSICAS
    async function testConnection() {
      setStatus('Probando conexi√≥n...');
      try {
        const user = await client.getAccount();
        currentUser = user;
        isAdmin = user.email === 'klmzr230@gmail.com';
        updateUserInterface(user);
        
        setStatus(`‚úÖ Conectado como: ${user.name}`, isAdmin ? 'admin' : 'success');
        
      } catch (error) {
        setStatus('‚úÖ Conectado como visitante - CORS OK', 'success');
      }
    }

    function updateUserInterface(user) {
      if (isAdmin) {
        $('lockIcon').textContent = 'üëë';
        $('lockIcon').classList.add('admin');
        $('userName').innerHTML = `${user.name}<span class="admin-badge">ADMIN</span>`;
        $('userInfo').style.display = 'flex';
        $('adminButtons').style.display = 'flex';
      } else {
        $('lockIcon').textContent = 'üë§';
        $('userName').textContent = user.name;
        $('userInfo').style.display = 'flex';
        $('adminButtons').style.display = 'none';
      }
    }

    async function loadAlbums() {
      setStatus('Cargando √°lbumes...');
      try {
        const response = await client.listDocuments(CONFIG.databaseId, CONFIG.albumsCollectionId);
        currentAlbums = response.documents || [];
        
        console.log('üìÄ √Ålbumes cargados:', currentAlbums);
        
        if (currentAlbums.length === 0) {
          $('albums').innerHTML = `
            <div class="empty-state">
              <h2>üéµ Conexi√≥n exitosa</h2>
              <p>No hay √°lbumes disponibles.${isAdmin ? '<br>Usa el panel admin para crear √°lbumes.' : ''}</p>
            </div>
          `;
        } else {
          displayAlbums(currentAlbums);
        }
        setStatus(`‚úÖ ${currentAlbums.length} √°lbum(es) cargados`, 'success');
      } catch (error) {
        setStatus(`‚ùå Error: ${error.message}`, 'error');
      }
    }

    // ‚úÖ MOSTRAR √ÅLBUMES CON PORTADAS CORREGIDAS
    function displayAlbums(albums, containerId = 'albums') {
      const container = $(containerId);
      
      container.innerHTML = albums.map(album => {
        console.log('üñºÔ∏è Procesando √°lbum:', album.name, 'coverStorageId:', album.coverStorageId);
        
        let coverUrl = null;
        
        // ‚úÖ VERIFICAR SI HAY coverStorageId V√ÅLIDO
        if (album.coverStorageId && !album.coverStorageId.startsWith('test-cover-')) {
          try {
            coverUrl = client.getFilePreview(CONFIG.bucketId, album.coverStorageId);
            console.log('üîó URL generada para', album.name, ':', coverUrl);
          } catch (error) {
            console.error('‚ùå Error generando URL para', album.name, ':', error);
            coverUrl = null;
          }
        } else {
          console.log('‚ö†Ô∏è Sin portada v√°lida para', album.name);
        }

        return `
          <div class="album-card" onclick="viewAlbumDetail('${album.$id}', '${album.name}')">
            ${isAdmin && containerId === 'albums' ? `
              <div class="album-actions">
                <button class="btn danger small" onclick="event.stopPropagation(); deleteAlbum('${album.$id}', '${album.name}')" title="Eliminar">üóëÔ∏è</button>
              </div>
            ` : ''}
            <div style="width:100px;height:100px;border-radius:50%;margin:0 auto 0.7rem;overflow:hidden;">
              ${coverUrl ? 
                `<img src="${coverUrl}" alt="${album.name}" class="album-img" style="width:100%;height:100%;object-fit:cover;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" crossorigin="anonymous">
                 <div class="album-img" style="width:100%;height:100%;background:linear-gradient(135deg, #1DB954, #1ed760);display:none;align-items:center;justify-content:center;font-size:2rem;color:white;text-shadow:0 2px 4px rgba(0,0,0,0.3);">üéµ</div>` :
                `<div class="album-img" style="width:100%;height:100%;background:linear-gradient(135deg, #1DB954, #1ed760);display:flex;align-items:center;justify-content:center;font-size:2rem;color:white;text-shadow:0 2px 4px rgba(0,0,0,0.3);">üéµ</div>`
              }
            </div>
            <div class="album-title">${album.name}</div>
            <div class="album-artist">${album.artistName}</div>
          </div>
        `;
      }).join('');
    }

    async function deleteAlbum(albumId, albumName) {
      if (!isAdmin) return;
      
      if (!confirm(`¬øEst√°s seguro de eliminar el √°lbum "${albumName}"?`)) return;

      setStatus('Eliminando √°lbum...');
      try {
        await client.deleteDocument(CONFIG.databaseId, CONFIG.albumsCollectionId, albumId);
        setStatus(`üëë √Ålbum "${albumName}" eliminado exitosamente`, 'admin');
        setTimeout(loadAlbums, 500);
      } catch (error) {
        setStatus(`‚ùå Error eliminando √°lbum: ${error.message}`, 'error');
      }
    }

    // ‚úÖ AGREGAR √ÅLBUM DE PRUEBA
    async function addTestAlbum() {
      if (!currentUser) {
        setStatus('Inicia sesi√≥n primero', 'error');
        openAuthModal();
        return;
      }

      try {
        const albumData = {
          name: `√Ålbum Test - ${new Date().toLocaleTimeString()}`,
          artistName: isAdmin ? 'Admin Freddy Granados' : 'Usuario Test',
          coverStorageId: 'test-cover-' + Date.now()
        };

        const permissions = [
          'read("any")',
          `write("user:${currentUser.$id}")`,
          `delete("user:${currentUser.$id}")`
        ];

        await client.createDocument(
          CONFIG.databaseId,
          CONFIG.albumsCollectionId,
          'album-' + Date.now(),
          albumData,
          permissions
        );

        setStatus('‚úÖ √Ålbum creado correctamente', isAdmin ? 'admin' : 'success');
        setTimeout(() => {
          loadAlbums();
          loadAlbumsForSelect();
        }, 1000);
      } catch (error) {
        setStatus(`‚ùå Error: ${error.message}`, 'error');
      }
    }

    // ‚úÖ AUTH FUNCTIONS
    function openAuthModal() {
      $('authModal').classList.add('show');
    }

    function closeAuthModal() {
      $('authModal').classList.remove('show');
    }

    function toggleAuthMode() {
      isLoginMode = !isLoginMode;
      
      if (isLoginMode) {
        $('modalTitle').textContent = 'Iniciar Sesi√≥n';
        $('authSubmitBtn').textContent = 'Iniciar Sesi√≥n';
        $('toggleText').textContent = '¬øNo tienes cuenta?';
        $('toggleBtn').textContent = 'Registrarse';
        $('nameGroup').style.display = 'none';
      } else {
        $('modalTitle').textContent = 'Crear Cuenta';
        $('authSubmitBtn').textContent = 'Registrarse';
        $('toggleText').textContent = '¬øYa tienes cuenta?';
        $('toggleBtn').textContent = 'Iniciar Sesi√≥n';
        $('nameGroup').style.display = 'block';
      }
    }

    async function handleAuth(event) {
      event.preventDefault();
      const email = $('email').value;
      const password = $('password').value;
      const name = $('name').value;

      try {
        if (isLoginMode) {
          await client.createSession(email, password);
          const user = await client.getAccount();
          currentUser = user;
          isAdmin = user.email === 'klmzr230@gmail.com';
          
          updateUserInterface(user);
          closeAuthModal();
          setStatus(`¬°Bienvenido ${user.name}!`, isAdmin ? 'admin' : 'success');
        } else {
          await client.createUser(email, password, name);
          await client.createSession(email, password);
          const user = await client.getAccount();
          currentUser = user;
          isAdmin = user.email === 'klmzr230@gmail.com';
          
          updateUserInterface(user);
          closeAuthModal();
          setStatus(`¬°Cuenta creada! Bienvenido ${user.name}!`, isAdmin ? 'admin' : 'success');
        }
      } catch (error) {
        setStatus(`Error: ${error.message}`, 'error');
      }
    }

    async function logout() {
      try {
        await client.deleteSession();
        currentUser = null;
        isAdmin = false;
        $('lockIcon').textContent = 'üîí';
        $('lockIcon').classList.remove('admin');
        $('userInfo').style.display = 'none';
        $('adminButtons').style.display = 'none';
        $('adminPanel').classList.remove('show');
        setStatus('Sesi√≥n cerrada', 'success');
        
        if (document.getElementById('profileSection').classList.contains('active')) {
          updateProfileSection();
        }
      } catch (error) {
        setStatus(`Error: ${error.message}`, 'error');
      }
    }

    // ‚úÖ SEARCH FUNCTION
    function performSearch() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
      const searchResults = document.getElementById('searchResults');
      
      if (!searchTerm) {
        searchResults.innerHTML = '<div class="empty-state"><h2>üîç Buscar m√∫sica</h2><p>Escribe para buscar.</p></div>';
        return;
      }
      
      const filteredAlbums = currentAlbums.filter(album => 
        album.name.toLowerCase().includes(searchTerm) || 
        album.artistName.toLowerCase().includes(searchTerm)
      );
      
      if (filteredAlbums.length === 0) {
        searchResults.innerHTML = `<div class="empty-state"><h2>üîç Sin resultados</h2><p>No encontrado: "${searchTerm}"</p></div>`;
      } else {
        displayAlbums(filteredAlbums, 'searchResults');
      }
    }

    // ‚úÖ FUNCI√ìN ACTUALIZAR PERFIL
    function updateProfileSection() {
      const profileContent = document.getElementById('profileContent');
      
      if (currentUser) {
        profileContent.innerHTML = `
          <div style="max-width:400px;margin:0 auto;text-align:left;">
            <div style="text-align:center;margin-bottom:2rem;">
              <div style="width:100px;height:100px;background:${isAdmin ? 'linear-gradient(45deg,#1DB954,#1ed760)' : '#333'};border-radius:50%;margin:0 auto 1rem;display:flex;align-items:center;justify-content:center;font-size:3rem;">
                ${isAdmin ? 'üëë' : 'üë§'}
              </div>
              <h2>${currentUser.name}</h2>
              <p style="color:#999;">${currentUser.email}</p>
              ${isAdmin ? '<p style="color:#1DB954;font-weight:bold;">üéµ ADMINISTRADOR KLMZ MUSIC</p>' : ''}
              ${isAdmin ? '<p style="color:#666;font-size:0.9rem;">Desarrollado por Freddy Granados</p>' : ''}
            </div>
            
            <div class="form-group">
              <h3>Configuraci√≥n de cuenta</h3>
              <button class="btn-danger" onclick="logout()" style="width:100%;margin-top:1rem;">Cerrar Sesi√≥n</button>
            </div>
          </div>
        `;
      } else {
        profileContent.innerHTML = `
          <div class="empty-state">
            <h2>üë§ Mi Perfil</h2>
            <p>Inicia sesi√≥n para ver tu perfil y configuraci√≥n.</p>
            <button class="btn-primary" onclick="openAuthModal()" style="width:auto;margin-top:1rem;padding:0.8rem 2rem;">Iniciar Sesi√≥n</button>
          </div>
        `;
      }
    }

    // ‚úÖ NUEVA FUNCI√ìN: Manejar m√∫ltiples archivos de canciones
    function handleMultipleSongFiles(files) {
      selectedSongFiles = Array.from(files);
      
      if (selectedSongFiles.length > 0) {
        $('selectedFiles').style.display = 'block';
        
        const filesList = $('filesList');
        filesList.innerHTML = selectedSongFiles.map((file, index) => `
          <div class="file-item">
            <span class="file-name">${file.name}</span>
            <span class="file-size">${formatFileSize(file.size)}</span>
          </div>
        `).join('');
        
        $('songFileUpload').innerHTML = `
          <p>‚úÖ ${selectedSongFiles.length} archivo(s) seleccionado(s)</p>
          <p style="color:#1DB954;font-size:0.9rem;">Haz clic para cambiar selecci√≥n</p>
        `;
        
        setStatus(`‚úÖ ${selectedSongFiles.length} archivo(s) de m√∫sica seleccionados`, 'success');
      }
    }

    // ‚úÖ INICIALIZACI√ìN COMPLETA
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM cargado, inicializando KLMZ MUSIC...');

      // Cargar tema guardado
      const savedTheme = localStorage.getItem('klmzTheme');
      if (savedTheme) {
        document.body.classList.add(savedTheme);
        $('themeSelect').value = savedTheme;
      }

      // Event listeners para navegaci√≥n
      document.querySelectorAll('.bottom-nav-item').forEach(item => {
        item.addEventListener('click', function(e) {
          e.preventDefault();
          const section = this.getAttribute('data-section');
          showSection(section);
        });
      });

      // Event listener para tema
      $('themeSelect').addEventListener('change', function() {
        changeTheme(this.value);
      });

      // Event listener para b√∫squeda
      const searchInput = document.getElementById('searchInput');
      if (searchInput) {
        searchInput.addEventListener('input', performSearch);
      }

      // Event listener para auth icon
      $('lockIcon').addEventListener('click', openAuthModal);

      // Setup file upload para archivos de audio
      const fileUpload = $('fileUpload');
      const fileInput = $('fileInput');
      
      if (fileUpload && fileInput) {
        fileUpload.addEventListener('click', () => fileInput.click());
        
        fileUpload.addEventListener('dragover', (e) => {
          e.preventDefault();
          fileUpload.classList.add('dragover');
        });
        
        fileUpload.addEventListener('dragleave', () => {
          fileUpload.classList.remove('dragover');
        });
        
        fileUpload.addEventListener('drop', (e) => {
          e.preventDefault();
          fileUpload.classList.remove('dragover');
          handleFiles(e.dataTransfer.files);
        });
        
        fileInput.addEventListener('change', (e) => {
          handleFiles(e.target.files);
        });
      }

      // ‚úÖ Setup file upload para m√∫ltiples canciones
      const songFileUpload = $('songFileUpload');
      const songFileInput = $('songFileInput');
      
      if (songFileUpload && songFileInput) {
        songFileUpload.addEventListener('click', () => songFileInput.click());
        
        songFileUpload.addEventListener('dragover', (e) => {
          e.preventDefault();
          songFileUpload.classList.add('dragover');
        });
        
        songFileUpload.addEventListener('dragleave', () => {
          songFileUpload.classList.remove('dragover');
        });
        
        songFileUpload.addEventListener('drop', (e) => {
          e.preventDefault();
          songFileUpload.classList.remove('dragover');
          handleMultipleSongFiles(e.dataTransfer.files);
        });
        
        songFileInput.addEventListener('change', (e) => {
          handleMultipleSongFiles(e.target.files);
        });
      }

      // Inicializaci√≥n autom√°tica
      setTimeout(() => {
        testConnection();
        loadAlbums();
        loadAlbumsForSelect();
      }, 500);

      console.log('‚úÖ KLMZ MUSIC inicializado correctamente');
    });

    // Cerrar modal al hacer clic fuera
    window.addEventListener('click', function(event) {
      if (event.target === $('authModal')) {
        closeAuthModal();
      }
    });

    console.log('üéµ KLMZ MUSIC - Sistema completo cargado');
    console.log('üëë Desarrollado por: Freddy Granados');
    console.log('‚úÖ Funcionalidades: Portadas corregidas ‚úì | M√∫ltiples canciones ‚úì | Debugging ‚úì');

  </script>
</body>
</html>
