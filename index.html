<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>KLMZ MUSIC</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #121212; color: white; }
    header { background: #1db954; padding: 1rem; text-align: center; font-size: 1.5rem; font-weight: bold; }
    .hidden { display: none; }
    .album-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px,1fr)); gap: 1rem; padding: 1rem; }
    .album { background: #181818; padding: .5rem; border-radius: 8px; cursor: pointer; transition: transform .2s; text-align: center; }
    .album:hover { transform: scale(1.05); background: #282828; }
    .album img { width: 100%; border-radius: 6px; }
    .songs { padding: .5rem; }
    .song { padding: .25rem; cursor: pointer; }
    .song:hover { color: #1db954; }
    #player { position: fixed; bottom: 0; left: 0; right: 0; background: #181818; padding: 1rem; border-top: 1px solid #333; display: none; }
    #player.active { display: block; }
    .loading { text-align: center; padding: 2rem; font-size: 1.2rem; }
    .spinner { border: 4px solid #333; border-top: 4px solid #1db954; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: auto; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <header>♫ KLMZ MUSIC</header>

  <div id="login">
    <h2 style="text-align:center">Iniciar sesión</h2>
    <input type="email" id="email" placeholder="Email" value="klmzr@gmail.com"><br>
    <input type="password" id="password" placeholder="Contraseña"><br>
    <button onclick="login()">Entrar</button>
  </div>

  <div id="app" class="hidden">
    <button onclick="logout()">Salir</button>
    <h3>Subir Álbum</h3>
    <input id="album-name" placeholder="Nombre del álbum"><br>
    <input type="file" id="cover-file"><br>
    <button onclick="uploadAlbum()">Subir Álbum</button>

    <h3>Subir Canciones</h3>
    <select id="album-select"></select><br>
    <input type="file" id="song-files" multiple><br>
    <button onclick="uploadSongs()">Subir Canciones</button>

    <h3>Álbumes</h3>
    <div id="loading" class="loading"><div class="spinner"></div><p>Cargando música...</p></div>
    <div id="albums" class="album-grid"></div>
  </div>

  <div id="player">
    <div id="now-playing">Nada reproduciéndose</div>
    <audio id="audio" controls></audio>
  </div>

<script>
const supabaseUrl = "https://nqbldvpnqhngdtalvzov.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xYmxkdnBucWhuZ2R0YWx2em92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyMjY0NjUsImV4cCI6MjA3MDgwMjQ2NX0.Zzg5D219sW7bhvl0_R5ypX9MF6nRzBSDIeo2Lvebab0";
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

let currentUser = null;

async function login() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  if (email !== "klmzr@gmail.com") return alert("Solo admin permitido");
  const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
  if (error) { alert(error.message); return; }
  currentUser = data.user;
  document.getElementById("login").classList.add("hidden");
  document.getElementById("app").classList.remove("hidden");
  loadAlbums();
}

async function logout() {
  await supabaseClient.auth.signOut();
  document.getElementById("login").classList.remove("hidden");
  document.getElementById("app").classList.add("hidden");
}

async function uploadAlbum() {
  const name = document.getElementById("album-name").value;
  const file = document.getElementById("cover-file").files[0];
  if (!name || !file) return alert("Faltan datos");

  const filePath = `${Date.now()}_${file.name}`;
  const { error: uploadError } = await supabaseClient.storage.from("covers").upload(filePath, file);
  if (uploadError) return alert("Error subiendo portada: " + uploadError.message);

  const coverUrl = `${supabaseUrl}/storage/v1/object/public/covers/${filePath}`;

  const { error } = await supabaseClient.from("albums").insert([{ name, cover_url: coverUrl }]);
  if (error) return alert("Error guardando álbum: " + error.message);

  alert("Álbum subido");
  document.getElementById("album-name").value = "";
  document.getElementById("cover-file").value = "";
  loadAlbums();
}

async function uploadSongs() {
  const albumId = document.getElementById("album-select").value;
  const files = document.getElementById("song-files").files;
  if (!albumId || files.length === 0) return alert("Selecciona álbum y canciones");

  for (let file of files) {
    const filePath = `${albumId}/${Date.now()}_${file.name}`;
    const { error: uploadError } = await supabaseClient.storage.from("songs").upload(filePath, file);
    if (uploadError) { alert("Error subiendo canción: " + uploadError.message); continue; }

    // URL pública fija
    const publicUrl = `${supabaseUrl}/storage/v1/object/public/songs/${filePath}`;

    await supabaseClient.from("songs").insert([{ 
      album_id: albumId, 
      title: file.name, 
      file_url: publicUrl 
    }]);
  }

  alert("Canciones subidas!");
  document.getElementById("song-files").value = "";
  loadAlbums();
}

async function loadAlbums() {
  document.getElementById("loading").style.display = "block";
  const { data: albums } = await supabaseClient.from("albums").select("*");
  const container = document.getElementById("albums");
  container.innerHTML = "";
  if (albums && albums.length > 0) {
    for (let album of albums) {
      const albumDiv = document.createElement("div");
      albumDiv.className = "album";
      albumDiv.innerHTML = `<img src="${album.cover_url}" alt="${album.name}"><div>${album.name}</div>`;
      albumDiv.onclick = () => toggleSongs(album.id, albumDiv);
      container.appendChild(albumDiv);
    }
    // llenar select
    const sel = document.getElementById("album-select");
    sel.innerHTML = "";
    albums.forEach(a => {
      const opt = document.createElement("option");
      opt.value = a.id;
      opt.textContent = a.name;
      sel.appendChild(opt);
    });
  } else {
    container.innerHTML = "<p>No hay álbumes todavía.</p>";
  }
  document.getElementById("loading").style.display = "none";
}

async function toggleSongs(albumId, albumDiv) {
  const open = albumDiv.querySelector(".songs");
  if (open) { open.remove(); return; }

  const { data: songs } = await supabaseClient.from("songs").select("*").eq("album_id", albumId);
  const songsDiv = document.createElement("div");
  songsDiv.className = "songs";
  if (songs && songs.length > 0) {
    songs.forEach(s => {
      const div = document.createElement("div");
      div.className = "song";
      div.textContent = s.title;
      div.onclick = () => playSong(s);
      songsDiv.appendChild(div);
    });
  } else {
    songsDiv.innerHTML = "<p>Sin canciones</p>";
  }
  albumDiv.appendChild(songsDiv);
}

function playSong(song) {
  const player = document.getElementById("player");
  player.classList.add("active");
  document.getElementById("now-playing").textContent = "▶ " + song.title;
  const audio = document.getElementById("audio");
  audio.src = song.file_url;
  audio.play().catch(err => console.error("Error reproduciendo:", err));
}
</script>
</body>
</html>
