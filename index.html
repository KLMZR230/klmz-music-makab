<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KLMZ MUSIC</title>
<meta name="description" content="KLMZ MUSIC - Tu plataforma de m√∫sica personal" />
<meta name="theme-color" content="#1db954" />
<link rel="manifest" href="manifest.json">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js')
      .then(registration => {
        console.log('‚úÖ Service Worker registrado:', registration);
      })
      .catch(error => {
        console.log('‚ùå Error registrando Service Worker:', error);
      });
  });
}
</script>
<style>
  :root{--bg:#121212;--panel:#181818;--panel2:#1f1f1f;--text:#fff;--muted:#b3b3b3;--brand:#1db954;--brand-hover:#17a84b;--stroke:#2a2a2a;--accent:#ff6b35;--error:#ff4444;--warning:#ffab00;--success:#4caf50;}
  /* ... el resto de tu CSS, como lo mandaste ... */
</style>
</head>
<body>
<div id="loadingScreen" class="loading">
  <div class="spinner"></div>
  <div class="text">Cargando KLMZ MUSIC...</div>
</div>
<div id="gestureHint" class="gesture-hint"></div>
<header>
  <div class="row">
    <div class="brand">
      <span class="logo">üî•</span> 
      KLMZ MUSIC
    </div>
    <div class="tools">
      <span class="muted" id="albumsTitle">Tu m√∫sica</span>
      <button class="icon-btn" id="btn-login" title="Admin" onclick="showLogin()">üîë</button>
      <button class="btn ghost" id="btn-logout" style="display:none" onclick="logout()">Salir</button>
    </div>
  </div>
</header>
<div class="container">
  <div class="row muted" style="margin-bottom:20px;">
    <span class="tag">Cat√°logo p√∫blico</span>
    <span id="adminTag" class="tag" style="display:none">Admin</span>
    <span id="userTag" class="tag" style="display:none">Usuario</span>
    <span id="offlineTag" class="tag" style="display:none;background:var(--success)">Offline</span>
  </div>
  <div id="musicControls" class="music-controls" style="display:none;">
    <button class="control-btn" id="shuffleBtn" onclick="toggleShuffle()" title="Aleatorio">
      <span>üîÄ</span> Shuffle
    </button>
    <button class="control-btn" id="repeatBtn" onclick="toggleRepeat()" title="Repetir">
      <span>üîÅ</span> Repeat
    </button>
    <button class="control-btn" onclick="showFavorites()" title="Favoritos">
      <span>‚ù§Ô∏è</span> Favoritos
    </button>
    <button class="control-btn" onclick="showDownloads()" title="Descargas">
      <span>‚¨á</span> Offline
    </button>
  </div>
  <!-- ...Vistas: searchView, playlistsView, favoritesView, downloadsView ... -->
  <div id="adminPanel" class="card stack" style="display:none">
    <div class="section-title">Panel Admin</div>
    <div class="inputs">
      <div class="stack">
        <div class="pill">Crear nuevo √°lbum</div>
        <input id="albumTitle" type="text" placeholder="T√≠tulo del √°lbum" />
        <input id="albumArtist" type="text" placeholder="Artista del √°lbum" />
        <input id="albumCover" type="file" accept="image/*" />
        <button class="btn" onclick="uploadAlbum()">Subir √Ålbum</button>
      </div>
      <!-- ... el resto de la secci√≥n admin tal como mandaste ... -->
    </div>
  </div>
  <div id="homeContent">
    <div class="section-title">Albums</div>
    <div id="albumsGrid" class="grid albums"></div>
    <div id="emptyAlbums" class="muted" style="display:none">No hay √°lbumes todav√≠a.</div>
  </div>
  <div id="albumView" class="card stack">
    <div class="backline">
      <button class="back-btn" onclick="closeAlbumView()" title="Volver">‚Üê</button>
      <span class="muted">Volver</span>
    </div>
    <div class="album-hero">
      <img id="avCover" alt="cover">
      <div class="info">
        <div id="avTitle" class="title">‚Äî</div>
        <div id="avMeta" class="meta">‚Äî</div>
      </div>
    </div>
    <div id="avSongs" class="song-plain-list"></div>
  </div>
  <!-- ...Tu reproductor, overlays, modales y todo lo dem√°s hasta la primer apertura de <script>... -->
</div>
<div class="player" id="player" onclick="openNowPlaying()">
  <div class="np">
    <img id="npCover" alt="cover">
    <div class="titles">
      <div id="npTitle" class="t">Cargando...</div>
      <div id="npAlbum" class="a">‚Äî</div>
    </div>
  </div>
  <div class="player-controls">
    <button class="circle sm" onclick="event.stopPropagation(); prevTrack()">‚èÆ</button>
    <button class="circle" id="playBtn" onclick="event.stopPropagation(); togglePlay()">‚ñ∂</button>
    <button class="circle sm" onclick="event.stopPropagation(); nextTrack()">‚è≠</button>
  </div>
  <div class="player-seek">
    <span id="curTime" class="time">0:00</span>
    <input id="seek" type="range" min="0" max="100" value="0" oninput="seekAudio(this.value)" onclick="event.stopPropagation()" />
    <span id="durTime" class="time">0:00</span>
  </div>
  <div class="vol">
    <span>Vol</span>
    <input id="vol" type="range" min="0" max="1" step="0.01" value="1" oninput="setVolume(this.value)" onclick="event.stopPropagation()" />
  </div>
  <div class="soundwave" id="soundwave" style="display:none">
    <div class="bar"></div><div class="bar"></div><div class="bar"></div>
  </div>
  <audio id="audio" preload="none" crossorigin="anonymous"></audio>
</div>
<div id="npOverlay" onclick="closeNowPlaying()">
  <div id="npCard" onclick="event.stopPropagation()">
    <img id="npBigCover" alt="cover">
    <div class="t" id="npBigTitle">‚Äî</div>
    <div class="a" id="npBigAlbum">‚Äî</div>
    
    <div class="row" style="margin:16px 0">
      <button class="favorite-btn" id="npFavoriteBtn" onclick="toggleCurrentFavorite()" title="Favorito">ü§ç</button>
      <button class="download-btn" id="npDownloadBtn" onclick="downloadCurrentSong()" title="Descargar">‚¨á</button>
    </div>
    
    <div class="soundwave" style="margin:20px 0;">
      <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
    </div>
    
    <div class="controls" style="width:100%;max-width:520px">
      <div class="buttons">
        <button class="circle sm" onclick="prevTrack()">‚èÆ</button>
        <button class="circle" onclick="togglePlay()" id="playBtnBig">‚ñ∂</button>
        <button class="circle sm" onclick="nextTrack()">‚è≠</button>
      </div>
      <div class="seek">
        <span id="curTimeBig" class="muted">0:00</span>
        <input id="seekBig" type="range" min="0" max="100" value="0" oninput="seekAudio(this.value)" />
        <span id="durTimeBig" class="muted">0:00</span>
      </div>
    </div>
  </div>
</div>
<div id="bottomBar">
  <button id="btn-home" title="Inicio" onclick="goHome(); setActiveNav('home')" class="active">
    <svg class="icon" viewBox="0 0 24 24"><path d="M3 11L12 2l9 9v9a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2v-5H9v5a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-9z"/></svg>
    <span class="label">Inicio</span>
  </button>
  <button id="btn-search" title="Buscar" onclick="showSearch()">
    <svg class="icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="7"/><line x1="16.5" y1="16.5" x2="21" y2="21"/></svg>
    <span class="label">Buscar</span>
  </button>
  <button id="btn-playlists" title="Playlists" onclick="showPlaylists()">
    <svg class="icon" viewBox="0 0 24 24"><path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/></svg>
    <span class="label">Playlists</span>
  </button>
  <button id="btn-account" title="Cuenta" onclick="showAccount()">
    <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="7" r="4"/><path d="M5.5 21a7.5 7.5 0 0 1 13 0"/></svg>
    <span class="label">Cuenta</span>
  </button>
</div>
<div id="playlistModal" class="playlist-modal">
  <div class="playlist-modal-content">
    <div class="section-title">Agregar a Playlist</div>
    <div class="playlist-grid" id="playlistModalGrid"></div>
    <div class="row" style="margin-top:16px;gap:8px">
      <button class="btn small" onclick="createPlaylistFromModal()">+ Nueva Playlist</button>
      <button class="btn small ghost" onclick="closePlaylistModal()">Cancelar</button>
    </div>
  </div>
</div>
<div id="loginModal" class="card" style="display:none;position:fixed;inset:0;margin:auto;max-width:420px;height:max-content;z-index:50">
  <div class="stack">
    <div class="section-title">Iniciar sesi√≥n</div>
    <input id="email" type="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Contrase√±a" />
    <div class="row">
      <button class="btn" onclick="login()">Entrar</button>
      <button class="btn ghost" onclick="hideLogin()">Cancelar</button>
    </div>
    <small class="muted">Crea una cuenta o inicia sesi√≥n para gestionar playlists.</small>
  </div>
</div>
<script>
const SUPABASE_URL = "https://nqbldvpnqhngdtalvzov.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xYmxkdnBucWhuZ2R0YWx2em92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyMjY0NjUsImV4cCI6MjA3MDgwMjQ2NX0.Zzg5D219sW7bhvl0_R5ypX9MF6nRzBSDIeo2Lvebab0";
const ADMIN_EMAIL = "klmzr@gmail.com";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
let isAdmin = false, isLoggedIn = false, currentUser = null;
let albums = [], songsByAlbum = {}, flatSongs = [], playlists = [];
let queue = [], qIndex = -1, currentAlbum = null, currentPlaylist = null;
let isShuffleMode = false, repeatMode = 0;
let favorites = new Set(), downloads = new Map();
let touchStartY = 0, touchEndY = 0;
let currentSongForPlaylist = null;
const albumsGrid = document.getElementById("albumsGrid");
const emptyAlbums = document.getElementById("emptyAlbums");
const npCover = document.getElementById("npCover");
const npTitle = document.getElementById("npTitle");
const npAlbum = document.getElementById("npAlbum");
const playBtn = document.getElementById("playBtn");
const audioEl = document.getElementById("audio");
const seekEl = document.getElementById("seek");
const curTime = document.getElementById("curTime");
const durTime = document.getElementById("durTime");
const playerElement = document.getElementById("player");
const loadingScreen = document.getElementById("loadingScreen");
const shuffleBtn = document.getElementById("shuffleBtn");
const repeatBtn = document.getElementById("repeatBtn");
const musicControls = document.getElementById("musicControls");
const albumView = document.getElementById("albumView");
const avCover = document.getElementById("avCover");
const avTitle = document.getElementById("avTitle");
const avMeta = document.getElementById("avMeta");
const avSongs = document.getElementById("avSongs");
const homeContent = document.getElementById("homeContent");
const npOverlay = document.getElementById("npOverlay");
const npBigCover = document.getElementById("npBigCover");
const npBigTitle = document.getElementById("npBigTitle");
const npBigAlbum = document.getElementById("npBigAlbum");
const curTimeBig = document.getElementById("curTimeBig");
const durTimeBig = document.getElementById("durTimeBig");
const seekBig = document.getElementById("seekBig");
const playBtnBig = document.getElementById("playBtnBig");
const npFavoriteBtn = document.getElementById("npFavoriteBtn");
const npDownloadBtn = document.getElementById("npDownloadBtn");
const favoritesView = document.getElementById("favoritesView");
const downloadsView = document.getElementById("downloadsView");
const favoritesList = document.getElementById("favoritesList");
const downloadsList = document.getElementById("downloadsList");
const playlistsView = document.getElementById("playlistsView");
const playlistsGrid = document.getElementById("playlistsGrid");
const playlistView = document.getElementById("playlistView");
const gestureHint = document.getElementById("gestureHint");
const playlistModal = document.getElementById("playlistModal");

// FUNCI√ìN MODIFICADA PARA √ÅLBUM CON ARTISTA
async function uploadAlbum() {
  if (!isAdmin) return alert("No autorizado");
  const title = document.getElementById("albumTitle").value.trim();
  const artist = document.getElementById("albumArtist").value.trim();
  const file = document.getElementById("albumCover").files[0];
  if (!title || !artist || !file) return alert("Completa t√≠tulo, artista y portada");
  const path = `${Date.now()}-${safeName(file.name)}`;
  const { error: upErr } = await sb.storage.from("covers").upload(path, file);
  if (upErr) return alert("Error subiendo portada: " + upErr.message);
  const { data: pub } = sb.storage.from("covers").getPublicUrl(path);
  const cover_url = pub.publicUrl;
  const { error: insErr } = await sb.from("albums").insert([{ title, artist, cover_url }]);
  if (insErr) return alert("Error guardando √°lbum: " + insErr.message);
  document.getElementById("albumTitle").value = "";
  document.getElementById("albumArtist").value = "";
  document.getElementById("albumCover").value = "";
  showMessage("√Ålbum creado exitosamente", "success");
  await refreshCatalogOptimized();
}

// FUNCI√ìN MODIFICADA PARA AGRUPAR POR ARTISTA
function renderAlbums() {
  albumsGrid.innerHTML = "";
  
  // Agrupa √°lbumes por artista
  const albumsByArtist = {};
  albums.forEach(album => {
    const artist = album.artist || "Sin artista";
    if (!albumsByArtist[artist]) albumsByArtist[artist] = [];
    albumsByArtist[artist].push(album);
  });

  Object.keys(albumsByArtist).sort().forEach(artist => {
    // Encabezado del artista
    const artistHeader = document.createElement("div");
    artistHeader.className = "section-title";
    artistHeader.textContent = artist;
    albumsGrid.appendChild(artistHeader);

    // Grid de √°lbumes de ese artista
    const artistGrid = document.createElement("div");
    artistGrid.className = "grid albums";
    albumsByArtist[artist].forEach(album => {
      const songCount = songsByAlbum[album.id] ? songsByAlbum[album.id].length : 0;
      const card = document.createElement("div");
      card.className = "album-card";
      card.innerHTML = `
        <img class="album-cover" src="${album.cover_url}" alt="${album.title}">
        <div class="album-title">${album.title}</div>
        <div class="album-meta">${songCount} ${songCount === 1 ? 'canci√≥n' : 'canciones'}</div>
      `;
      card.addEventListener('click', () => {
        openAlbum(album);
      });
      artistGrid.appendChild(card);
    });
    albumsGrid.appendChild(artistGrid);
  });
}

// ---- RESTO DE TUS FUNCIONES JS TAL COMO LAS ENVIASTE ----
// (todas las dem√°s funciones van igual que las copiaste originalmente)

</script>
</body>
</html>
