<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KLMZ MUSIC</title>
<meta name="description" content="KLMZ MUSIC - Tu plataforma de m√∫sica personal" />
<meta name="theme-color" content="#1db954" />
<link rel="manifest" href="manifest.json">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js')
      .then(registration => {
        console.log('‚úÖ Service Worker registrado:', registration);
      })
      .catch(error => {
        console.log('‚ùå Error registrando Service Worker:', error);
      });
  });
}
</script>
<style>
  /* ... TODO (igual que antes, no se corta nada aqu√≠) ... */
</style>
</head>
<body>
<div id="loadingScreen" class="loading">
  <div class="spinner"></div>
  <div class="text">Cargando KLMZ MUSIC...</div>
</div>
<!-- ... resto de tu HTML ... -->
  <div id="adminPanel" class="card stack" style="display:none">
    <div class="section-title">Panel Admin</div>
    <div class="inputs">
      <div class="stack">
        <div class="pill">Crear nuevo √°lbum</div>
        <input id="albumTitle" type="text" placeholder="T√≠tulo del √°lbum" />
        <input id="albumArtist" type="text" placeholder="Artista del √°lbum" />
        <input id="albumCover" type="file" accept="image/*" />
        <button class="btn" onclick="uploadAlbum()">Subir √Ålbum</button>
      </div>
      <div class="stack">
        <div class="pill">Agregar canciones a un √°lbum existente</div>
        <select id="albumSelect"></select>
        <input id="songTitle" type="text" placeholder="T√≠tulo de la canci√≥n (opcional si subes 1)" />
        <input id="songFiles" type="file" accept="audio/*" multiple />
        <button class="btn" onclick="uploadSong()">Subir Canciones</button>
      </div>
      <div class="stack">
        <div class="pill">Eliminar canciones individuales</div>
        <select id="deleteSongAlbumSelect" onchange="loadSongsForDeletion()">
          <option value="">Selecciona un √°lbum</option>
        </select>
        <select id="deleteSongSelect" style="display:none">
          <option value="">Selecciona una canci√≥n</option>
        </select>
        <button class="btn danger" onclick="deleteSong()" id="deleteSongBtn" style="display:none">üóëÔ∏è Eliminar Canci√≥n</button>
      </div>
      <div class="stack">
        <div class="pill">Eliminar √°lbumes completos</div>
        <select id="deleteAlbumSelect"></select>
        <button class="btn ghost" onclick="deleteAlbum()">Eliminar √Ålbum Completo</button>
      </div>
      <!-- NUEVA SECCI√ìN: Editar artista de √°lbum -->
      <div class="stack">
        <div class="pill">Editar artista de √°lbum</div>
        <select id="editAlbumSelect"></select>
        <input id="editAlbumArtist" type="text" placeholder="Nuevo nombre de artista" />
        <button class="btn" onclick="editAlbumArtist()">Actualizar Artista</button>
      </div>
    </div>
  </div>
<!-- ...resto del HTML de p√°gina, hasta el reproductor y modales... -->

<script>
const SUPABASE_URL = "https://nqbldvpnqhngdtalvzov.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xYmxkdnBucWhuZ2R0YWx2em92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyMjY0NjUsImV4cCI6MjA3MDgwMjQ2NX0.Zzg5D219sW7bhvl0_R5ypX9MF6nRzBSDIeo2Lvebab0";
const ADMIN_EMAIL = "klmzr@gmail.com";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
let isAdmin = false, isLoggedIn = false, currentUser = null;
let albums = [], userPlaylists = [], publicPlaylists = [];
let songsByAlbum = {}, songsByPlaylist = {}, flatSongs = [];
let queue = [], qIndex = -1, currentAlbum = null, currentPlaylist = null;

function setActiveNav(activeButton) {
  document.querySelectorAll('#bottomBar button').forEach(btn => btn.classList.remove('active'));
  const targetBtn = document.getElementById(`btn-${activeButton}`);
  if (targetBtn) targetBtn.classList.add('active');
}

function showError(msg) {
  const errorEl = document.createElement('div');
  errorEl.className = 'error-msg';
  errorEl.textContent = msg;
  errorEl.style.position = 'fixed';
  errorEl.style.top = '20px';
  errorEl.style.right = '20px';
  errorEl.style.zIndex = '9999';
  document.body.appendChild(errorEl);
  setTimeout(() => errorEl.remove(), 4000);
}

function showSuccess(msg) {
  const successEl = document.createElement('div');
  successEl.className = 'success-msg';
  successEl.textContent = msg;
  successEl.style.position = 'fixed';
  successEl.style.top = '20px';
  successEl.style.right = '20px';
  successEl.style.zIndex = '9999';
  document.body.appendChild(successEl);
  setTimeout(() => successEl.remove(), 3000);
}

// -- ACTUALIZA TAMBI√âN EL SELECTOR DE EDICI√ìN DE ARTISTA ---
function updateAdminSelects() {
  const adminSel = document.getElementById("albumSelect");
  const delSel = document.getElementById("deleteAlbumSelect");
  const editSel = document.getElementById("editAlbumSelect");

  if (adminSel) {
    adminSel.innerHTML = '<option value="">Selecciona un √°lbum</option>';
    albums.forEach(album => {
      const option = document.createElement("option");
      option.value = album.id;
      option.textContent = album.title;
      adminSel.appendChild(option);
    });
  }
  if (delSel) {
    delSel.innerHTML = '<option value="">Selecciona un √°lbum</option>';
    albums.forEach(album => {
      const option = document.createElement("option");
      option.value = album.id;
      option.textContent = album.title;
      delSel.appendChild(option);
    });
  }
  if (editSel) {
    editSel.innerHTML = '<option value="">Selecciona un √°lbum</option>';
    albums.forEach(album => {
      const option = document.createElement("option");
      option.value = album.id;
      option.textContent = album.title;
      editSel.appendChild(option);
    });
  }
}

// Carga el nombre del artista al seleccionar un √°lbum para editar artista
document.addEventListener("DOMContentLoaded", function(){
  const editSel = document.getElementById("editAlbumSelect");
  if (editSel) {
    editSel.addEventListener("change", function() {
      const albumId = this.value;
      const album = albums.find(a => a.id === albumId);
      document.getElementById("editAlbumArtist").value = album ? (album.artist || "") : "";
    });
  }
});

// ACTUALIZA ARTISTA EN SUPABASE
async function editAlbumArtist() {
  if (!isAdmin) return alert("No autorizado");
  const albumId = document.getElementById("editAlbumSelect").value;
  const newArtist = document.getElementById("editAlbumArtist").value.trim();
  if (!albumId || !newArtist) {
    showError("Elige un √°lbum y escribe un nombre de artista");
    return;
  }
  const { error } = await sb.from("albums").update({ artist: newArtist }).eq("id", albumId);
  if (error) {
    showError("Error actualizando artista: " + error.message);
    return;
  }
  showSuccess("Artista actualizado");
  await refreshCatalog();
  updateAdminSelects();
}

// ... el resto de tu script JS sigue aqu√≠ ...
async function refreshCatalog() {
  console.log('üîÑ Cargando √°lbumes...');
  
  try {
    const { data: alb, error: e1 } = await sb
      .from("albums")
      .select("*")
      .order("created_at", {ascending: false});
    
    if (e1) { 
      console.error('‚ùå Error cargando √°lbumes:', e1); 
      showError('Error cargando √°lbumes: ' + e1.message); 
      return; 
    }
    
    albums = alb || [];
    console.log('‚úÖ √Ålbumes cargados:', albums.length);
    
    const emptyAlbums = document.getElementById("emptyAlbums");
    if (emptyAlbums) {
      emptyAlbums.style.display = albums.length ? "none" : "block";
    }
    
    // Load songs for each album
    songsByAlbum = {};
    flatSongs = [];
    
    for (const album of albums) {
      try {
        const { data: ss, error: e2 } = await sb
          .from("songs")
          .select("*")
          .eq("album_id", album.id)
          .order("created_at", {ascending: true});
        
        if (e2) { 
          console.error('‚ùå Error cargando canciones para √°lbum:', album.title, e2); 
          continue; 
        }
        
        songsByAlbum[album.id] = ss || [];
        
        for (const song of (ss || [])) {
          flatSongs.push({
            ...song, 
            album_title: album.title, 
            cover_url: album.cover_url
          });
        }
      } catch (error) {
        console.error('‚ùå Error procesando √°lbum:', album.title, error);
      }
    }
    
    console.log('üìÄ Total canciones cargadas:', flatSongs.length);
    renderAlbums();
    updateAdminSelects();
    
  } catch (error) {
    console.error('‚ùå Error en refreshCatalog:', error);
    showError('Error cargando cat√°logo');
  }
}

function renderAlbums(list = albums) {
  console.log('üé® Renderizando √°lbumes:', list.length);
  
  const albumsGrid = document.getElementById("albumsGrid");
  const emptyAlbums = document.getElementById("emptyAlbums");
  
  if (!albumsGrid) {
    console.error('‚ùå albumsGrid no encontrado');
    return;
  }
  
  albumsGrid.innerHTML = "";
  
  if (list.length === 0) {
    console.log('üìÇ No hay √°lbumes para mostrar');
    if (emptyAlbums) emptyAlbums.style.display = 'block';
    return;
  }
  
  if (emptyAlbums) emptyAlbums.style.display = 'none';
  
  list.forEach((album, index) => {
    const count = (songsByAlbum[album.id]?.length || 0);
    const card = document.createElement("div");
    card.className = "album-card";
    
    card.innerHTML = `
      <img class="album-cover" src="${album.cover_url || ''}" alt="${album.title}" onerror="this.style.background='var(--panel)'; this.style.display='flex'; this.style.alignItems='center'; this.style.justifyContent='center'; this.innerHTML='üéµ';">
      <div class="album-title">${album.title}</div>
      <div class="album-meta">${album.artist || 'Sin artista'} ‚Ä¢ ${count} ${count === 1 ? 'canci√≥n' : 'canciones'}</div>
    `;
    
    card.onclick = () => openAlbum(album);
    albumsGrid.appendChild(card);
    
    console.log(`üìÄ ${index + 1}. ${album.title} - ${album.artist || 'Sin artista'} - ${count} canciones`);
  });
}

function openAlbum(album) {
  console.log('üéµ Abriendo √°lbum:', album.title);
  currentAlbum = album;
  const songs = songsByAlbum[album.id] || [];
  
  const avCover = document.getElementById("avCover");
  const avTitle = document.getElementById("avTitle");
  const avMeta = document.getElementById("avMeta");
  const avSongs = document.getElementById("avSongs");
  const albumView = document.getElementById("albumView");
  
  if (avCover) avCover.src = album.cover_url || "";
  if (avTitle) avTitle.textContent = album.title;
  if (avMeta) avMeta.textContent = `${album.artist || 'Sin artista'} ‚Ä¢ ${songs.length} ${songs.length === 1 ? 'canci√≥n' : 'canciones'}`;
  
  if (avSongs) {
    avSongs.innerHTML = "";
    
    if (!songs.length) {
      avSongs.innerHTML = `<div class="muted" style="padding:12px 0">Este √°lbum no tiene canciones todav√≠a.</div>`;
    } else {
      songs.forEach((song, idx) => {
        const row = document.createElement("div");
        row.className = "song-plain-item";
        
        row.innerHTML = `
          <div class="idx">${idx + 1}</div>
          <div class="title">${song.title}</div>
          <div class="actions">
            <button class="favorite-btn" onclick="event.stopPropagation(); toggleFavorite('${song.id}')" title="Favorito">ü§ç</button>
            <button class="download-btn" onclick="event.stopPropagation(); downloadSong('${song.id}')" title="Descargar">‚¨á</button>
          </div>
        `;
        
        row.onclick = () => {
          console.log('üéµ Reproduciendo canci√≥n:', song.title);
          queue = songs.map(s => ({
            ...s, 
            album_title: album.title, 
            cover_url: album.cover_url
          }));
          qIndex = -1;
          startQueueAt(idx);
        };
        
        avSongs.appendChild(row);
      });
    }
  }
  
  if (albumView) {
    albumView.style.display = "block";
    albumView.scrollIntoView({behavior: "smooth", block: "start"});
  }
}

function closeAlbumView() {
  const albumView = document.getElementById("albumView");
  if (albumView) albumView.style.display = "none";
  currentAlbum = null;
}

// Music Player Functions
function startQueueAt(idx) { 
  if (!queue.length) return; 
  qIndex = idx; 
  playTrack(queue[qIndex]); 
}

function playTrack(song) {
  console.log('üéµ Reproduciendo:', song.title, song.song_url);
  
  if (!song.song_url) {
    showError(`Error: No hay URL de audio para "${song.title}"`);
    nextTrack();
    return;
  }
  
  const audioEl = document.getElementById("audio");
  const npTitle = document.getElementById("npTitle");
  const npAlbum = document.getElementById("npAlbum");
  const npCover = document.getElementById("npCover");
  const npBigTitle = document.getElementById("npBigTitle");
  const npBigAlbum = document.getElementById("npBigAlbum");
  const npBigCover = document.getElementById("npBigCover");
  const playerElement = document.getElementById("player");
  const playBtn = document.getElementById("playBtn");
  const playBtnBig = document.getElementById("playBtnBig");
  
  audioEl.pause();
  audioEl.currentTime = 0;
  audioEl.src = song.song_url;
  audioEl.load();
  
  // Update UI
  if (npTitle) npTitle.textContent = song.title;
  if (npAlbum) npAlbum.textContent = song.album_title || "‚Äî";
  if (npCover) npCover.src = song.cover_url || "";
  if (npBigTitle) npBigTitle.textContent = song.title;
  if (npBigAlbum) npBigAlbum.textContent = song.album_title || "‚Äî";
  if (npBigCover) npBigCover.src = song.cover_url || "";
  
  if (playerElement) {
    playerElement.classList.add('show');
    document.body.style.paddingBottom = '120px';
  }
  
  const playPromise = audioEl.play();
  if (playPromise !== undefined) {
    playPromise
      .then(() => {
        console.log('‚úÖ Reproducci√≥n exitosa:', song.title);
        if (playBtn) playBtn.textContent = "‚è∏";
        if (playBtnBig) playBtnBig.textContent = "‚è∏";
        toggleSoundwave(true);
      })
      .catch((error) => {
        console.error('‚ùå Error de reproducci√≥n:', error);
        showError(`No se puede reproducir "${song.title}"`);
        setTimeout(() => nextTrack(), 2000);
      });
  }
}

function togglePlay() {
  const audioEl = document.getElementById("audio");
  const playBtn = document.getElementById("playBtn");
  const playBtnBig = document.getElementById("playBtnBig");
  
  if (audioEl.paused) { 
    const playPromise = audioEl.play();
    if (playPromise !== undefined) {
      playPromise
        .then(() => {
          if (playBtn) playBtn.textContent = "‚è∏"; 
          if (playBtnBig) playBtnBig.textContent = "‚è∏"; 
          toggleSoundwave(true);
        })
        .catch((error) => {
          console.error('Error al reanudar:', error);
          showError('Error al reanudar reproducci√≥n');
        });
    }
  } else { 
    audioEl.pause(); 
    if (playBtn) playBtn.textContent = "‚ñ∂"; 
    if (playBtnBig) playBtnBig.textContent = "‚ñ∂"; 
    toggleSoundwave(false);
  }
}

function nextTrack() { 
  if (!queue.length) return; 
  qIndex = (qIndex + 1) % queue.length; 
  playTrack(queue[qIndex]); 
}

function prevTrack() { 
  if (!queue.length) return; 
  qIndex = (qIndex - 1 + queue.length) % queue.length; 
  playTrack(queue[qIndex]); 
}

function setVolume(v) { 
  const audioEl = document.getElementById("audio");
  audioEl.volume = v; 
}

function seekAudio(percent) { 
  const audioEl = document.getElementById("audio");
  if (!audioEl.duration || isNaN(audioEl.duration)) return; 
  audioEl.currentTime = (percent / 100) * audioEl.duration; 
}

function fmt(t) { 
  if (!isFinite(t)) return "0:00"; 
  const m = Math.floor(t / 60);
  const s = Math.floor(t % 60); 
  return `${m}:${s.toString().padStart(2, "0")}`; 
}

function toggleSoundwave(show) {
  const wave = document.getElementById('soundwave');
  if (wave) {
    wave.style.display = show ? 'flex' : 'none';
  }
}

function openNowPlaying() {
  const npOverlay = document.getElementById("npOverlay");
  if (npOverlay) npOverlay.style.display = "flex";
}

function closeNowPlaying() { 
  const npOverlay = document.getElementById("npOverlay");
  if (npOverlay) npOverlay.style.display = "none"; 
}

// Navigation Functions
function goHome() {
  window.scrollTo({top:0, behavior:'smooth'});
  closeAlbumView();
  setActiveNav('home');
}

function showSearch() {
  const searchView = document.getElementById('searchView');
  const homeContent = document.getElementById('homeContent');
  if (searchView && homeContent) {
    homeContent.style.display = 'none';
    searchView.style.display = 'block';
    const noResults = document.getElementById('noSearchResults');
    if (noResults) noResults.style.display = 'block';
  }
  setActiveNav('search');
}

function closeSearchView() {
  const searchView = document.getElementById('searchView');
  const homeContent = document.getElementById('homeContent');
  if (searchView && homeContent) {
    searchView.style.display = 'none';
    homeContent.style.display = 'block';
  }
  setActiveNav('home');
}

function showPlaylists() {
  setActiveNav('playlists');
}

function showAccount() {
  if(isAdmin) {
    alert('Cuenta Admin: ' + ADMIN_EMAIL + '\n\nFuncionalidades:\n‚Ä¢ Crear √°lbumes\n‚Ä¢ Subir canciones\n‚Ä¢ Eliminar √°lbumes\n‚Ä¢ Gestionar playlists');
  } else if (isLoggedIn) {
    alert('Informaci√≥n de Cuenta\n\nUsuario: ' + currentUser.email + '\n\nFuncionalidades:\n‚Ä¢ Crear playlists\n‚Ä¢ Gestionar tu m√∫sica');
  } else {
    showLogin();
  }
  setActiveNav('account');
}

// Auth Functions
function showLogin() { 
  const modal = document.getElementById("loginModal");
  if (modal) modal.style.display = "block"; 
}

function hideLogin() { 
  const modal = document.getElementById("loginModal");
  if (modal) modal.style.display = "none"; 
}

async function login() {
  const emailEl = document.getElementById("email");
  const passwordEl = document.getElementById("password");
  
  if (!emailEl || !passwordEl) {
    showError('Error: elementos de login no encontrados');
    return;
  }

  const email = emailEl.value.trim();
  const password = passwordEl.value;
  
  if (!email || !password) {
    showError('Ingresa email y contrase√±a');
    return;
  }
  
  try {
    let result = await sb.auth.signInWithPassword({ email, password });
    
    if (result.error) {
      result = await sb.auth.signUp({ email, password });
      if (result.error) {
        showError("Error: " + result.error.message);
        return;
      }
      showSuccess('Cuenta creada! Revisa tu email si es necesario.');
    }
    
    currentUser = result.data.user;
    isLoggedIn = !!currentUser;
    isAdmin = (email.toLowerCase() === ADMIN_EMAIL.toLowerCase());
    
    // Update UI
    const btnLogin = document.getElementById("btn-login");
    const btnLogout = document.getElementById("btn-logout");
    const adminPanel = document.getElementById("adminPanel");
    const adminTag = document.getElementById("adminTag");
    const userTag = document.getElementById("userTag");
    
    if (btnLogin) btnLogin.style.display = "none";
    if (btnLogout) btnLogout.style.display = "inline-flex";
    
    if (isAdmin && adminPanel && adminTag) {
      adminPanel.style.display = "block";
      adminTag.style.display = "inline-block";
    }
    
    if (isLoggedIn && userTag) {
      userTag.style.display = "inline-block";
    }
    
    hideLogin();
    await refreshCatalog();
    
  } catch (error) {
    console.error('Error en login:', error);
    showError('Error de conexi√≥n');
  }
}

async function logout() {
  try {
    await sb.auth.signOut();
    currentUser = null;
    isLoggedIn = false;
    isAdmin = false;
    
    // Update UI
    const adminPanel = document.getElementById("adminPanel");
    const adminTag = document.getElementById("adminTag");
    const userTag = document.getElementById("userTag");
    const btnLogin = document.getElementById("btn-login");
    const btnLogout = document.getElementById("btn-logout");
    
    if (adminPanel) adminPanel.style.display = "none";
    if (adminTag) adminTag.style.display = "none";
    if (userTag) userTag.style.display = "none";
    if (btnLogin) btnLogin.style.display = "inline-flex";
    if (btnLogout) btnLogout.style.display = "none";
    
  } catch (error) {
    console.error('Error en logout:', error);
  }
}

// Admin Functions
function safeName(name) { 
  return name.replace(/[^a-zA-Z0-9_\-.]+/g, "-"); 
}

async function uploadAlbum() {
  if (!isAdmin) return alert("No autorizado");
  const title = document.getElementById("albumTitle").value.trim();
  const artist = document.getElementById("albumArtist").value.trim();
  const file = document.getElementById("albumCover").files[0];
  if (!title || !file) return alert("Completa t√≠tulo y portada");
  
  const path = `${Date.now()}-${safeName(file.name)}`;
  const { error: upErr } = await sb.storage.from("covers").upload(path, file);
  if (upErr) return alert("Error subiendo portada: " + upErr.message);
  
  const { data: pub } = sb.storage.from("covers").getPublicUrl(path);
  const cover_url = pub.publicUrl;
  
  const { error: insErr } = await sb.from("albums").insert([{ title, artist: artist || null, cover_url }]);
  if (insErr) return alert("Error guardando √°lbum: " + insErr.message);
  
  document.getElementById("albumTitle").value = "";
  document.getElementById("albumArtist").value = "";
  document.getElementById("albumCover").value = "";
  showSuccess("√Ålbum creado exitosamente");
  await refreshCatalog();
}

async function uploadSong() {
  if (!isAdmin) return alert("No autorizado");
  const albumId = document.getElementById("albumSelect").value;
  const titleInput = document.getElementById("songTitle").value.trim();
  const files = document.getElementById("songFiles").files;
  if (!albumId || files.length === 0) return alert("Selecciona un √°lbum y al menos un archivo de audio");
  
  let ok = 0, fail = 0;
  for (const file of files) {
    console.log('Subiendo archivo:', file.name, 'Tipo:', file.type, 'Tama√±o:', file.size);
    
    if (!file.type.startsWith('audio/')) {
      console.error('Archivo no es audio:', file.name);
      fail++;
      continue;
    }
    
    const path = `${Date.now()}-${safeName(file.name)}`;
    const { error: upErr } = await sb.storage.from("songs").upload(path, file);
    if (upErr) { 
      console.error('Error subida:', upErr); 
      fail++; 
      continue; 
    }
    
    const { data: pub } = sb.storage.from("songs").getPublicUrl(path);
    const song_url = pub.publicUrl;
    console.log('URL generada:', song_url);
    
    const title = (files.length === 1 && titleInput) ? titleInput : file.name.replace(/\.[^/.]+$/, "");
    const { error: insErr } = await sb.from("songs").insert([{ album_id: albumId, title, song_url }]);
    if (insErr) { 
      console.error('Error DB:', insErr); 
      fail++; 
    } else { 
      ok++; 
    }
  }
  
  document.getElementById("songTitle").value = "";
  document.getElementById("songFiles").value = "";
  showSuccess(`Subida completa: ${ok} exitosas, ${fail} error(es)`);
  await refreshCatalog();
}

async function deleteAlbum() {
  if (!isAdmin) return alert("No autorizado");
  const albumId = document.getElementById("deleteAlbumSelect").value;
  if (!albumId) return alert("Selecciona un √°lbum");
  if (!confirm("¬øEliminar √°lbum y todas sus canciones?")) return;
  
  const { error: delSongsErr } = await sb.from("songs").delete().eq("album_id", albumId);
  if (delSongsErr) { alert("Error borrando canciones: " + delSongsErr.message); return; }
  
  const { error: delAlbErr } = await sb.from("albums").delete().eq("id", albumId);
  if (delAlbErr) { alert("Error borrando √°lbum: " + delAlbErr.message); return; }
  
  showSuccess("√Ålbum eliminado exitosamente");
  if (currentAlbum?.id === albumId) closeAlbumView();
  await refreshCatalog();
}

// Audio Event Listeners
document.getElementById("audio").addEventListener("timeupdate", () => {
  const audioEl = document.getElementById("audio");
  const seekEl = document.getElementById("seek");
  const curTime = document.getElementById("curTime");
  const durTime = document.getElementById("durTime");
  const seekBig = document.getElementById("seekBig");
  const curTimeBig = document.getElementById("curTimeBig");
  const durTimeBig = document.getElementById("durTimeBig");
  
  if (!audioEl.duration) return;
  const p = (audioEl.currentTime / audioEl.duration) * 100;
  
  if (seekEl) seekEl.value = p;
  if (curTime) curTime.textContent = fmt(audioEl.currentTime);
  if (durTime) durTime.textContent = fmt(audioEl.duration);
  if (seekBig) seekBig.value = p;
  if (curTimeBig) curTimeBig.textContent = fmt(audioEl.currentTime);
  if (durTimeBig) durTimeBig.textContent = fmt(audioEl.duration);
});

document.getElementById("audio").addEventListener("ended", () => nextTrack());

// Placeholder functions
function toggleFavorite(songId) { console.log('Toggle favorite:', songId); }
function downloadSong(songId) { console.log('Download song:', songId); }
function searchSongs(value) { console.log('Search:', value); }
function createNewPlaylist() { console.log('Create playlist'); }
function showFavorites() { console.log('Show favorites'); }
function showDownloads() { console.log('Show downloads'); }
function toggleShuffle() { console.log('Toggle shuffle'); }
function toggleRepeat() { console.log('Toggle repeat'); }
function toggleCurrentFavorite() { console.log('Toggle current favorite'); }
function downloadCurrentSong() { console.log('Download current song'); }
function createPlaylistFromModal() { console.log('Create playlist from modal'); }
function closePlaylistModal() { console.log('Close playlist modal'); }
function playPlaylist() { console.log('Play playlist'); }
function deletePlaylist() { console.log('Delete playlist'); }
function loadSongsForDeletion() { console.log('Load songs for deletion'); }
function deleteSong() { console.log('Delete song'); }
function sortAlbums(value) { console.log('Sort albums:', value); }
function closePlaylistView() { console.log('Close playlist view'); }
function closeFavoritesView() { goHome(); }
function closeDownloadsView() { goHome(); }
function closePlaylistsView() { goHome(); }
async function loadPlaylists() { console.log('Load playlists'); }

// Hide loading screen
setTimeout(() => {
  const loadingScreen = document.getElementById('loadingScreen');
  if (loadingScreen) {
    loadingScreen.style.display = 'none';
    console.log('‚úÖ Pantalla de carga ocultada');
  }
}, 1500);

// Initialization
(async () => {
  console.log('üöÄ Inicializando KLMZ MUSIC...');
  
  try {
    const { data } = await sb.auth.getSession();
    
    if (data?.session?.user?.email) {
      const email = data.session.user.email;
      currentUser = data.session.user;
      isLoggedIn = true;
      isAdmin = (email.toLowerCase() === ADMIN_EMAIL.toLowerCase());
      
      console.log('üë§ Usuario logueado:', email, isAdmin ? '(Admin)' : '(Usuario)');
      
      // Update UI for logged in user
      const btnLogin = document.getElementById("btn-login");
      const btnLogout = document.getElementById("btn-logout");
      const adminPanel = document.getElementById("adminPanel");
      const adminTag = document.getElementById("adminTag");
      const userTag = document.getElementById("userTag");
      
      if (btnLogin) btnLogin.style.display = "none";
      if (btnLogout) btnLogout.style.display = "inline-flex";
      
      if (isAdmin && adminPanel && adminTag) {
        adminPanel.style.display = "block";
        adminTag.style.display = "inline-block";
      }
      
      if (isLoggedIn && userTag) {
        userTag.style.display = "inline-block";
      }
    }
    
    await refreshCatalog();
    console.log('‚úÖ Aplicaci√≥n inicializada correctamente');
    
  } catch (error) {
    console.error('‚ùå Error en inicializaci√≥n:', error);
    showError('Error inicializando aplicaci√≥n');
  }
})();

</script>

</body>
</html>
