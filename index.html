<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>KLMZ MUSIC</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <meta name="theme-color" content="#1DB954">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <!-- ===========  CSS COMPLETO  =========== -->
    <style>
        *{box-sizing:border-box}
        body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#181818;color:#fff;padding-bottom:84px;transition:.3s}
        header{background:#121212;padding:1rem 1.5rem;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;transition:.3s}
        .logo{font-weight:bold;font-size:1.4rem;letter-spacing:1px;transition:.3s}
        .user-actions{display:flex;align-items:center;gap:.5rem}
        .lock-icon{cursor:pointer;font-size:1.4rem;color:#fff;user-select:none;transition:.3s}
        .lock-icon:hover{opacity:.7}
        .theme-selector{display:flex;align-items:center;gap:.3rem;margin-right:.5rem}
        .theme-selector label{font-size:.7rem;color:#b3b3b3}
        .theme-selector select{background:#333;color:#fff;border:1px solid #555;border-radius:4px;padding:.1rem .2rem;font-size:.7rem;cursor:pointer;transition:.3s}
        .app-container{display:flex;min-height:calc(100vh - 60px)}
        main{flex:1;padding:1rem;max-width:900px;margin:0 auto}
        #search-input{width:100%;padding:1rem;background:#242424;border:none;border-radius:4px;color:#fff;margin-bottom:2rem;transition:.3s}
        .section-title{font-size:1.8rem;font-weight:bold;margin-bottom:1.5rem;transition:.3s}
        .album-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:1.5rem}
        .album-card{background:none;padding:0;cursor:pointer;display:flex;flex-direction:column;align-items:center;text-align:center;transition:transform .3s}
        .album-card:hover{transform:scale(1.05)}
        .album-img{border-radius:50%;width:100px;height:100px;object-fit:cover;margin-bottom:.7rem;background:#333;transition:.3s}
        .album-title{font-size:.98rem;font-weight:bold;margin-bottom:.4rem;transition:.3s}
        .album-artist{font-size:.9rem;color:#b3b3b3;transition:.3s}
        /*  ‚Äî‚Äî‚Äî resto de tu CSS tal como lo enviaste ‚Äî‚Äî‚Äî */
        @keyframes neonPulse{0%{text-shadow:0 0 15px #00ff88,0 0 30px #00ff88}100%{text-shadow:0 0 25px #00ff88,0 0 40px #00ff88,0 0 60px #00ff88}}
        @keyframes dropdownFadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
        @media(max-width:768px){.full-player-cover{width:150px;height:150px}.full-player-title{font-size:1.4rem}.album-img{width:80px;height:80px}}
    </style>
</head>

<body>
    <div class="loading-indicator" id="loading-indicator" style="display:none;">üéµ Cargando‚Ä¶</div>

    <!-- ===========  CABECERA  =========== -->
    <header>
        <span class="logo">KLMZ MUSIC</span>
        <div class="user-actions">
            <div class="theme-selector">
                <label for="theme-select">Tema:</label>
                <select id="theme-select" onchange="changeTheme(this.value)">
                    <option value="default">üéµ Default</option>
                    <option value="neon">‚ö° Neon</option>
                    <option value="minimal">‚ú® Minimal</option>
                    <option value="sunset">üåÖ Sunset</option>
                    <option value="pastel">üå∏ Pastel</option>
                    <option value="luxury">üíé Luxury</option>
                    <option value="oceanic">üåä Oceanic</option>
                </select>
            </div>
            <div class="user-menu">
                <div class="lock-icon" id="header-lock-icon" onclick="toggleUserMenu()">üîí</div>
                <div class="user-dropdown" id="user-dropdown">
                    <div class="user-info" id="user-info-section" style="display:none;">
                        <div><strong id="user-email-display"></strong></div>
                        <div id="user-role-display">Usuario</div>
                    </div>
                    <div class="user-dropdown-item" id="admin-menu-item" onclick="goToAdmin()" style="display:none;"><span>‚öôÔ∏è</span><span>Panel Admin</span></div>
                    <div class="user-dropdown-item" onclick="showAuth('register')" id="register-menu-item"><span>üìù</span><span>Registrarse</span></div>
                    <div class="user-dropdown-item" onclick="showAuth('login')" id="login-menu-item"><span>üîê</span><span>Iniciar Sesi√≥n</span></div>
                    <div class="user-dropdown-item logout" onclick="confirmLogout()" id="logout-menu-item" style="display:none;"><span>üö™</span><span>Cerrar Sesi√≥n</span></div>
                </div>
            </div>
        </div>
    </header>

    <!-- ===========  SECCIONES PRINCIPALES  =========== -->
    <div class="app-container">
        <main>
            <section class="content-section active" id="home-section">
                <div class="section-title">√Ålbumes</div>
                <div class="album-grid" id="albums"><div style="text-align:center;padding:2rem;">Cargando √°lbumes‚Ä¶</div></div>
                <div id="album-detail" style="display:none;"></div>
            </section>

            <section class="content-section" id="search-section">
                <div class="section-title">Buscar m√∫sica</div>
                <input id="search-input" placeholder="¬øQu√© quieres escuchar?" onkeyup="searchMusic()">
                <div id="search-results"></div>
            </section>

            <section class="content-section" id="favorites-section">
                <div class="section-title">‚ù§Ô∏è Mis Favoritos</div>
                <div id="favorites-content"><div style="text-align:center;padding:2rem;">No tienes favoritos</div></div>
            </section>

            <section class="content-section" id="downloads-section">
                <div class="section-title">‚Üì Mis Descargas</div>
                <div id="downloads-content"><div style="text-align:center;padding:2rem;">No tienes canciones descargadas</div></div>
            </section>

            <section class="content-section" id="admin-section">
                <div class="section-title">Panel de Administraci√≥n</div>
                <div id="admin-content"></div>
            </section>
        </main>
    </div>

    <!-- ===========  NAVEGACI√ìN INFERIOR  =========== -->
    <nav class="bottom-nav">
        <div class="bottom-nav-item active"   onclick="showSection('home')"      id="nav-home"><span class="icon">‚åÇ</span><small>Inicio</small></div>
        <div class="bottom-nav-item"          onclick="showSection('search')"    id="nav-search"><span class="icon">‚åï</span><small>Buscar</small></div>
        <div class="bottom-nav-item"          onclick="showSection('downloads')" id="nav-downloads"><span class="icon">‚Üì</span><small>Descargas</small></div>
        <div class="bottom-nav-item"          onclick="showSection('favorites')" id="nav-favs"><span class="icon">‚ô°</span><small>Favoritos</small></div>
    </nav>

    <!-- ===========  MINI-PLAYER  =========== -->
    <div class="player" id="mini-player" style="display:none;">
        <img class="player-img-mini" id="mini-player-img" alt="">
        <div class="player-info-mini">
            <div class="player-title-mini"  id="mini-player-title"></div>
            <div class="player-artist-mini" id="mini-player-artist"></div>
        </div>
        <div class="player-controls-inline" onclick="event.stopPropagation()">
            <button class="play-btn-inline" id="mini-play-btn" onclick="togglePlay()">‚ñ∂</button>
        </div>
    </div>

    <!-- ===========  FULL PLAYER  =========== -->
    <div class="full-player-backdrop" id="full-player">
        <button class="full-player-close" onclick="closeFullPlayer()">&times;</button>
        <img   id="full-player-cover"  class="full-player-cover"  src="" alt="">
        <div  id="full-player-title"   class="full-player-title"></div>
        <div  id="full-player-artist"  class="full-player-artist"></div>

        <div class="full-player-controls">
            <div class="full-control-buttons">
                <button class="full-control-btn"           onclick="previousSong()">‚èÆ</button>
                <button class="full-control-btn full-play-btn" id="full-play-btn" onclick="togglePlay()">‚ñ∂</button>
                <button class="full-control-btn"           onclick="nextSong()">‚è≠</button>
            </div>

            <div class="mode-controls">
                <button class="mode-btn" id="repeat-btn"  onclick="toggleRepeatMode()">üîÅ</button>
                <button class="mode-btn" id="shuffle-btn" onclick="toggleShuffleMode()">üîÄ</button>
            </div>

            <div class="full-progress-container">
                <span id="full-current-time" class="full-progress-time">0:00</span>
                <div class="full-progress-bar" onclick="seekToFull(event)">
                    <div class="full-progress-fill" id="full-progress-fill"></div>
                </div>
                <span id="full-total-time"   class="full-progress-time">0:00</span>
            </div>

            <div class="full-player-volume">
                <input type="range" class="full-volume-slider" min="0" max="100" value="70" oninput="setVolume(this.value)">
            </div>
        </div>
    </div>

    <!-- ===========  MODAL AUTH  =========== -->
    <div class="modal" id="auth-modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeAuth()">&times;</button>

            <div id="login-form">
                <h2>Iniciar sesi√≥n</h2>
                <form onsubmit="login(event)">
                    <div class="form-group"><label>Email:</label><input type="email" id="login-email" required></div>
                    <div class="form-group"><label>Contrase√±a:</label><input type="password" id="login-password" required></div>
                    <button class="btn-primary" type="submit">Iniciar sesi√≥n</button>
                </form>
                <p>¬øNo tienes cuenta? <a href="#" onclick="showAuth('register')">Reg√≠strate</a></p>
            </div>

            <div id="register-form" style="display:none;">
                <h2>Registrarse</h2>
                <form onsubmit="register(event)">
                    <div class="form-group"><label>Email:</label><input type="email" id="register-email" required></div>
                    <div class="form-group"><label>Contrase√±a:</label><input type="password" id="register-password" required></div>
                    <div class="form-group"><label>Confirmar contrase√±a:</label><input type="password" id="register-confirm" required></div>
                    <button class="btn-primary" type="submit">Registrarse</button>
                </form>
                <p>¬øYa tienes cuenta? <a href="#" onclick="showAuth('login')">Inicia sesi√≥n</a></p>
            </div>
        </div>
    </div>

    <audio id="audio-player" preload="metadata"></audio>
    <!-- ===========  SCRIPTS COMPLETOS  =========== -->
    <script>
/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ VARIABLES GLOBALES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const supabaseUrl = 'https://nqbldvpnqhngdtalvzov.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xYmxkdnBucWhuZ2R0YWx2em92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyMjY0NjUsImV4cCI6MjA3MDgwMjQ2NX0.Zzg5D219sW7bhvl0_R5ypX9MF6nRzBSDIeo2Lvebab0';
const ADMIN_EMAIL  = 'klmzr@gmail.com';
let supabase = null;
/* ‚Ä¶ (todas las dem√°s variables que ya ten√≠as) ‚Ä¶ */

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ INICIALIZACI√ìN SUPABASE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
async function loadSupabase() {
    showLoadingIndicator(true);
    const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
    supabase = createClient(supabaseUrl, supabaseKey);

    supabase.auth.onAuthStateChange((_event, session) => {
        currentUser = session?.user || null;
        updateAuthUI();
    });
    const { data:{session} } = await supabase.auth.getSession();
    currentUser = session?.user || null;
    updateAuthUI();
    await loadAllData().catch(err=>console.error(err));
    showLoadingIndicator(false);
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ PANEL ADMIN CON SUBIDA DE ARCHIVOS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
async function renderAdminPanel() {
    const c = document.getElementById('admin-content');
    c.innerHTML = `
      <div class="admin-section">
        <h4>Gesti√≥n de √Ålbumes</h4>
        <form id="album-form" class="admin-form" enctype="multipart/form-data">
          <input type="hidden" id="album-id">
          <div class="form-group"><input type="text"  id="album-title"  placeholder="T√≠tulo del √Ålbum" required></div>
          <div class="form-group"><input type="text"  id="album-artist" placeholder="Artista"           required></div>
          <div class="form-group"><input type="file" id="album-cover-file" accept=".jpg,.jpeg,.png"     required></div>
          <button class="btn-primary" type="submit">Guardar √Ålbum</button>
          <button class="btn-secondary" type="button" id="cancel-album-edit" style="display:none;margin-top:.5rem;">Cancelar Edici√≥n</button>
        </form>
        <div id="admin-album-list" class="admin-list">Cargando √°lbumes‚Ä¶</div>
      </div>

      <div class="admin-section">
        <h4>Gesti√≥n de Canciones</h4>
        <form id="song-form" class="admin-form" enctype="multipart/form-data">
          <input type="hidden" id="song-id">
          <div class="form-group"><input type="text"  id="song-title" placeholder="T√≠tulo de la Canci√≥n" required></div>
          <div class="form-group"><select id="song-album-select" required><option>Cargando √°lbumes‚Ä¶</option></select></div>
          <div class="form-group"><input type="file" id="song-file" accept=".mp3,.flac" required></div>
          <button class="btn-primary" type="submit">Guardar Canci√≥n</button>
          <button class="btn-secondary" type="button" id="cancel-song-edit" style="display:none;margin-top:.5rem;">Cancelar Edici√≥n</button>
        </form>
        <div id="admin-song-list" class="admin-list">Cargando canciones‚Ä¶</div>
      </div>`;
    await renderAdminLists();
    setupAdminForms();
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ SUBIR ARCHIVOS Y GUARDAR REGISTROS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function setupAdminForms() {
  /* √Ålbum ---------------------------------------------------------------- */
  const fAlbum = document.getElementById('album-form');
  fAlbum.addEventListener('submit', async e => {
    e.preventDefault();
    const id        = document.getElementById('album-id').value;
    const title     = document.getElementById('album-title').value;
    const artist    = document.getElementById('album-artist').value;
    const coverFile = document.getElementById('album-cover-file').files[0];
    if (!coverFile) return showInfoModal('Selecciona una portada');

    showLoadingIndicator(true);
    /* subir portada */
    const coverPath = `covers/${Date.now()}_${coverFile.name}`;
    const { error: upErr } = await supabase.storage.from('covers').upload(coverPath, coverFile,{upsert:false});
    if (upErr){showLoadingIndicator(false);return showInfoModal('Error subiendo portada: '+upErr.message);}
    const { data:{publicUrl:cover_url} } = supabase.storage.from('covers').getPublicUrl(coverPath);

    const { error } = id
      ? await supabase.from('albums').update({title,artist,cover_url}).eq('id',id)
      : await supabase.from('albums').insert([{title,artist,cover_url}]);
    showLoadingIndicator(false);
    if (error) showInfoModal('Error guardando √°lbum: '+error.message);
    else{
      showInfoModal('√Ålbum guardado');
      fAlbum.reset(); document.getElementById('cancel-album-edit').style.display='none'; document.getElementById('album-id').value='';
      await loadAllData(); await renderAdminLists();
    }
  });

  /* Canci√≥n -------------------------------------------------------------- */
  const fSong = document.getElementById('song-form');
  fSong.addEventListener('submit', async e => {
    e.preventDefault();
    const id       = document.getElementById('song-id').value;
    const title    = document.getElementById('song-title').value;
    const album_id = document.getElementById('song-album-select').value;
    const audioFile= document.getElementById('song-file').files[0];
    if(!audioFile) return showInfoModal('Selecciona un archivo de audio');

    showLoadingIndicator(true);
    /* subir audio */
    const audioPath = `audio/${Date.now()}_${audioFile.name}`;
    const { error: upErr } = await supabase.storage.from('audio').upload(audioPath, audioFile,{upsert:false});
    if (upErr){showLoadingIndicator(false);return showInfoModal('Error subiendo audio: '+upErr.message);}
    const { data:{publicUrl:song_url} } = supabase.storage.from('audio').getPublicUrl(audioPath);

    const { error } = id
      ? await supabase.from('songs').update({title,album_id,song_url}).eq('id',id)
      : await supabase.from('songs').insert([{title,album_id,song_url}]);
    showLoadingIndicator(false);
    if (error) showInfoModal('Error guardando canci√≥n: '+error.message);
    else{
      showInfoModal('Canci√≥n guardada');
      fSong.reset(); document.getElementById('cancel-song-edit').style.display='none'; document.getElementById('song-id').value='';
      await loadAllData(); await renderAdminLists();
    }
  });

  /* botones cancelar edici√≥n sin cambios */
}

<script>
    // --- INICIO DEL SCRIPT ---

    // Variables globales
    let supabase = null;
    let currentSong = null;
    let currentAlbum = null;
    let currentPlaylist = [];
    let currentIndex = 0;
    let isPlaying = false;
    let allAlbums = [];
    let allSongs = [];
    let currentUser = null;
    let songsWithAlbumInfo = [];
    let repeatMode = 'off';
    let shuffleMode = false;
    let originalPlaylist = [];
    let db;

    const supabaseUrl = 'https://nqbldvpnqhngdtalvzov.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xYmxkdnBucWhuZ2R0YWx2em92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyMjY0NjUsImV4cCI6MjA3MDgwMjQ2NX0.Zzg5D219sW7bhvl0_R5ypX9MF6nRzBSDIeo2Lvebab0';
    const ADMIN_EMAIL = 'klmzr@gmail.com';

    // --- Base de Datos (IndexedDB) para descargas ---
    function initDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open('KLMZMusicDB', 2);
            request.onerror = event => reject('Error al abrir IndexedDB');
            request.onsuccess = event => {
                db = event.target.result;
                resolve(db);
            };
            request.onupgradeneeded = event => {
                let db = event.target.result;
                if (!db.objectStoreNames.contains('songs')) {
                    db.createObjectStore('songs', { keyPath: 'id' });
                }
            };
        });
    }
    
    async function saveSongToDB(songData) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(['songs'], 'readwrite');
            const store = transaction.objectStore('songs');
            const request = store.put(songData);
            request.onsuccess = () => resolve();
            request.onerror = event => reject('Error al guardar la canci√≥n: ' + event.target.error);
        });
    }

    async function getSongFromDB(songId) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(['songs'], 'readonly');
            const store = transaction.objectStore('songs');
            const request = store.get(songId);
            request.onsuccess = () => resolve(request.result);
            request.onerror = event => reject('Error al obtener la canci√≥n: ' + event.target.error);
        });
    }

    async function getAllDownloadedSongs() {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(['songs'], 'readonly');
            const store = transaction.objectStore('songs');
            const request = store.getAll();
            request.onsuccess = () => resolve(request.result);
            request.onerror = event => reject('Error al obtener todas las canciones: ' + event.target.error);
        });
    }
    
    // --- Descarga de canciones ---
    window.downloadSong = async function(songId, element) {
        if (element.classList.contains('downloaded')) {
            showInfoModal('Esta canci√≥n ya est√° descargada.');
            return;
        }

        try {
            const song = songsWithAlbumInfo.find(s => s.id === songId);
            if (!song) throw new Error('Canci√≥n no encontrada');

            element.textContent = '...';
            const response = await fetch(song.song_url);
            if (!response.ok) throw new Error('Error en la red');
            const audioBlob = await response.blob();
            
            const coverResponse = await fetch(song.albums.cover_url);
            const coverBlob = await coverResponse.blob();

            const songData = {
                id: song.id,
                metadata: song,
                audio: audioBlob,
                cover: coverBlob
            };
            
            await saveSongToDB(songData);
            showInfoModal(`${song.title} descargada con √©xito.`);
            element.textContent = '‚Üì';
            element.classList.add('downloaded');

        } catch (error) {
            console.error('Error al descargar:', error);
            showInfoModal('No se pudo descargar la canci√≥n.');
            element.textContent = '‚Üì';
        }
    };

    // --- Carga de la secci√≥n de descargas ---
    async function loadDownloads() {
        const content = document.getElementById('downloads-content');
        try {
            const downloadedSongs = await getAllDownloadedSongs();
            if (downloadedSongs.length === 0) {
                content.innerHTML = `<div style="text-align: center; padding: 2rem;">No tienes canciones descargadas</div>`;
                return;
            }
            
            let html = '<div class="downloads-list">';
            downloadedSongs.forEach(songItem => {
                const song = songItem.metadata;
                html += `
                    <div class="download-item" onclick="playDownloadedSong('${song.id}')">
                        <div class="download-info">
                            <div class="download-title">${song.title}</div>
                            <div class="download-artist">${song.albums.artist} ‚Ä¢ ${song.albums.title}</div>
                        </div>
                        <span style="font-size: 1.1rem;">‚ñ∂</span>
                    </div>`;
            });
            html += '</div>';
            content.innerHTML = html;
        } catch (error) {
            console.error(error);
            content.innerHTML = 'Error al cargar las descargas.';
        }
    }
    
    window.playDownloadedSong = async (songId) => {
        const songData = await getSongFromDB(songId);
        if (songData) {
            currentPlaylist = [songData.metadata];
            currentIndex = 0;
            playSong(songData.metadata, songData.metadata.albums);
        }
    };


    // --- Funcionalidad del Reproductor (Modificada para Offline) ---
    window.playSong = async function(song, album, playlist = [song], index = 0) {
        currentSong = song;
        currentAlbum = album;
        currentPlaylist = playlist;
        currentIndex = index;
        
        const audio = document.getElementById('audio-player');
        
        // Stop any existing playback and update UI to loading state
        audio.pause();
        updateAllPlayers(); // This updates song info
        
        // The 'play' and 'pause' event listeners will handle the isPlaying state and button updates.

        // Define a one-time listener for when the audio is ready to play
        const onCanPlay = () => {
            audio.play().catch(error => {
                console.error("Error al reproducir:", error);
                // Avoid alerting for the common AbortError, which is the error we are fixing.
                if (error.name !== 'AbortError') {
                    showInfoModal('No se pudo reproducir la canci√≥n.');
                }
            });
            // Remove listener so it doesn't fire again for the same track
            audio.removeEventListener('canplay', onCanPlay);
        };
        audio.addEventListener('canplay', onCanPlay);
        
        try {
            const downloadedSong = await getSongFromDB(song.id);
            if (downloadedSong && downloadedSong.audio) {
                console.log(`Reproduciendo "${song.title}" desde descargas.`);
                const audioURL = URL.createObjectURL(downloadedSong.audio);
                audio.src = audioURL;
            } else {
                console.log(`Reproduciendo "${song.title}" desde la red.`);
                audio.src = song.song_url;
            }
        } catch (error) {
            console.error("Error al buscar canci√≥n en DB, reproduciendo desde red:", error);
            audio.src = song.song_url;
        }
        
        // Explicitly load the new source. The 'canplay' event will trigger playback.
        audio.load();
    }
    
    // --- Resto del c√≥digo (sin cambios mayores) ---
    
    window.changeTheme = function(theme) {
        const body = document.body;
        body.classList.remove('theme-neon', 'theme-minimal', 'theme-sunset', 'theme-pastel', 'theme-luxury', 'theme-oceanic');
        if (theme && theme !== 'default') {
            body.classList.add('theme-' + theme);
        }
        localStorage.setItem('klmz_theme', theme);
    }

    function loadSavedTheme() {
        const savedTheme = localStorage.getItem('klmz_theme') || 'default';
        document.querySelector('.theme-selector select').value = savedTheme;
        changeTheme(savedTheme);
    }

    async function loadSupabase() {
        showLoadingIndicator(true);
        try {
            const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
            supabase = createClient(supabaseUrl, supabaseKey);
            
            supabase.auth.onAuthStateChange((event, session) => {
                currentUser = session?.user || null;
                updateAuthUI();
            });

            const { data: { session } } = await supabase.auth.getSession();
            currentUser = session?.user || null;
            updateAuthUI();
            await loadAllData();
        } catch (error) {
            console.error('Error conectando a Supabase:', error);
            showErrorMessage('Error de conexi√≥n. Revisa tu internet.');
        } finally {
            showLoadingIndicator(false);
        }
    }

    async function loadAllData() {
        try {
            const [{ data: albums }, { data: songs }] = await Promise.all([
                supabase.from('albums').select('*'),
                supabase.from('songs').select('*, albums:album_id(*)')
            ]);
            allAlbums = albums || [];
            allSongs = songs || [];
            songsWithAlbumInfo = songs || [];
            displayAlbums(allAlbums);
        } catch (error) {
            console.error('Error cargando datos:', error);
            showErrorMessage('No se pudieron cargar los √°lbumes');
        }
    }

    function displayAlbums(albums) {
        const container = document.getElementById('albums');
        if (!albums || albums.length === 0) {
            container.innerHTML = '<h2>No hay √°lbumes disponibles</h2>';
            return;
        }
        container.innerHTML = albums.map(album => `
            <div class="album-card" onclick='showAlbumDetail(${JSON.stringify(album).replace(/"/g, '&quot;')})'>
                <img class="album-img" src="${album.cover_url}" alt="${album.title}" loading="lazy">
                <div class="album-title">${album.title}</div>
                <div class="album-artist">${album.artist}</div>
            </div>
        `).join('');
    }
    
    async function showAlbumDetail(album) {
        currentAlbum = album;
        document.getElementById('albums').style.display = 'none';
        const detailView = document.getElementById('album-detail');
        detailView.style.display = 'block';
        detailView.innerHTML = `
            <button class="back-btn" onclick="showAlbumsGrid()">‚üµ Volver</button>
            <div style="text-align: center; margin-bottom: 2rem;">
                <img class="album-img" src="${album.cover_url}" style="width: 200px; height: 200px; display: block; margin: 0 auto 1rem;">
                <div class="album-title" style="font-size: 1.5rem;">${album.title}</div>
                <div class="album-artist" style="font-size: 1.1rem; color: #b3b3b3;">${album.artist}</div>
            </div>
            <div class="song-list" id="detail-song-list">Cargando...</div>
        `;
        
        const { data: songs } = await supabase.from('songs').select('*').eq('album_id', album.id);
        const listDiv = document.getElementById('detail-song-list');
        if (!songs || songs.length === 0) { listDiv.innerHTML = 'No hay canciones en este √°lbum.'; return; }
        currentPlaylist = songs;
        originalPlaylist = [...songs];
        const favorites = getLocalFavorites();
        const downloaded = await getAllDownloadedSongs();
        const downloadedIds = downloaded.map(s => s.id);

        listDiv.innerHTML = '<ul>' + songs.map((song, idx) => `
            <li>
                <div onclick="playSongFromPlaylist(${idx})" style="flex: 1;">${song.title}</div>
                <div class="song-actions">
                    <span onclick="toggleFavorite('${song.id}', this)" style="cursor: pointer; color: ${favorites.includes(song.id) ? '#1DB954' : '#666'};">${favorites.includes(song.id) ? '‚ù§Ô∏è' : 'ü§ç'}</span>
                    <span class="download-icon ${downloadedIds.includes(song.id) ? 'downloaded' : ''}" onclick="event.stopPropagation(); downloadSong('${song.id}', this)">‚Üì</span>
                    <span class="play-icon" onclick="playSongFromPlaylist(${idx})">‚ñ∂</span>
                </div>
            </li>
        `).join('') + '</ul>';
    }

    function updateAllPlayers() {
        updateMiniPlayer();
        updateFullPlayer();
        updatePlayButtons();
    }

    async function updateMiniPlayer() {
        document.getElementById('mini-player').style.display = 'flex';
        const downloadedSong = await getSongFromDB(currentSong.id).catch(() => null);
        let coverUrl = currentAlbum?.cover_url || '';
        if (downloadedSong && downloadedSong.cover) {
            coverUrl = URL.createObjectURL(downloadedSong.cover);
        }
        document.getElementById('mini-player-img').src = coverUrl;
        document.getElementById('mini-player-title').textContent = currentSong?.title || 'Sin t√≠tulo';
        document.getElementById('mini-player-artist').textContent = currentAlbum?.artist || 'Desconocido';
    }

    async function updateFullPlayer() {
        const downloadedSong = await getSongFromDB(currentSong.id).catch(() => null);
        let coverUrl = currentAlbum?.cover_url || '';
        if (downloadedSong && downloadedSong.cover) {
            coverUrl = URL.createObjectURL(downloadedSong.cover);
        }
        document.getElementById('full-player-cover').src = coverUrl;
        document.getElementById('full-player-title').textContent = currentSong?.title || 'Sin t√≠tulo';
        document.getElementById('full-player-artist').textContent = currentAlbum?.artist || 'Desconocido';
    }
    
    function updatePlayButtons() {
        const playText = isPlaying ? '‚è∏' : '‚ñ∂';
        ['mini-play-btn', 'full-play-btn'].forEach(id => {
            const btn = document.getElementById(id);
            if (btn) btn.textContent = playText;
        });
    }

    window.togglePlay = function() {
        const audio = document.getElementById('audio-player');
        if (isPlaying) audio.pause();
        else audio.play();
    }

    window.nextSong = function() {
        if (currentPlaylist.length === 0) return;
        currentIndex = (currentIndex + 1) % currentPlaylist.length;
        playSong(currentPlaylist[currentIndex], currentAlbum, currentPlaylist, currentIndex);
    }

    window.previousSong = function() {
        if (currentPlaylist.length === 0) return;
        currentIndex = (currentIndex > 0) ? currentIndex - 1 : currentPlaylist.length - 1;
        playSong(currentPlaylist[currentIndex], currentAlbum, currentPlaylist, currentIndex);
    }

    function handleSongEnded() {
        if (repeatMode === 'all' || currentIndex < currentPlaylist.length - 1) nextSong();
        else { isPlaying = false; updatePlayButtons(); }
    }

    window.setVolume = (value) => { document.getElementById('audio-player').volume = value / 100; }

    function updateProgressBar() {
        const audio = document.getElementById('audio-player');
        if (!audio.duration) return;
        const progress = (audio.currentTime / audio.duration) * 100;
        document.getElementById('full-progress-fill').style.width = `${progress}%`;
        document.getElementById('full-current-time').textContent = formatTime(audio.currentTime);
        document.getElementById('full-total-time').textContent = formatTime(audio.duration);
    }

    function formatTime(seconds) {
        const min = Math.floor(seconds / 60);
        const sec = Math.floor(seconds % 60).toString().padStart(2, '0');
        return `${min}:${sec}`;
    }

    window.seekToFull = (event) => {
        const audio = document.getElementById('audio-player');
        const rect = event.currentTarget.getBoundingClientRect();
        audio.currentTime = ((event.clientX - rect.left) / rect.width) * audio.duration;
    }

    function openFullPlayer() { document.getElementById('full-player').classList.add('active'); }
    window.closeFullPlayer = function() { document.getElementById('full-player').classList.remove('active'); }

    window.toggleRepeatMode = function() {
        repeatMode = (repeatMode === 'all') ? 'off' : 'all';
        updateModeButtonsUI();
    }

    window.toggleShuffleMode = function() {
        shuffleMode = !shuffleMode;
        updateModeButtonsUI();
    }

    function updateModeButtonsUI() {
        document.getElementById('repeat-btn').classList.toggle('active', repeatMode === 'all');
        document.getElementById('shuffle-btn').classList.toggle('active', shuffleMode);
    }

    window.toggleUserMenu = function() {
        const dropdown = document.getElementById('user-dropdown');
        dropdown.classList.toggle('show');
        if (dropdown.classList.contains('show')) {
            setTimeout(() => { document.addEventListener('click', closeUserMenuOutside); }, 100);
        }
    }

    function closeUserMenuOutside(event) {
        const userMenu = document.querySelector('.user-menu');
        if (!userMenu.contains(event.target)) {
            document.getElementById('user-dropdown').classList.remove('show');
            document.removeEventListener('click', closeUserMenuOutside);
        }
    }

    function goToAdmin() {
        document.getElementById('user-dropdown').classList.remove('show');
        showSection('admin');
    }

    function confirmLogout() {
        showConfirmationModal('¬øEst√°s seguro de que quieres cerrar sesi√≥n?', logout);
    }

    async function logout() {
        try {
            const { error } = await supabase.auth.signOut();
            if (error) throw error;
            currentUser = null;
            updateAuthUI();
            showInfoModal('Sesi√≥n cerrada correctamente');
        } catch (error) {
            console.error('Error logout:', error);
            showInfoModal('Error cerrando sesi√≥n');
        }
    }

    function updateAuthUI() {
        const [headerLockIcon, userInfo, userEmail, adminMenu, loginMenu, registerMenu, logoutMenu] = [
            'header-lock-icon', 'user-info-section', 'user-email-display', 'admin-menu-item',
            'login-menu-item', 'register-menu-item', 'logout-menu-item'
        ].map(id => document.getElementById(id));
        
        if (currentUser) {
            userInfo.style.display = 'block';
            userEmail.textContent = currentUser.email;
            loginMenu.style.display = 'none';
            registerMenu.style.display = 'none';
            logoutMenu.style.display = 'flex';
            
            if (isAdmin()) {
                headerLockIcon.innerHTML = '‚öôÔ∏è';
                adminMenu.style.display = 'flex';
            } else {
                headerLockIcon.innerHTML = 'üë§';
                adminMenu.style.display = 'none';
            }
        } else {
            headerLockIcon.innerHTML = 'üîí';
            userInfo.style.display = 'none';
            adminMenu.style.display = 'none';
            loginMenu.style.display = 'flex';
            registerMenu.style.display = 'flex';
            logoutMenu.style.display = 'none';
        }
    }

    function isAdmin() { return currentUser && currentUser.email === ADMIN_EMAIL; }

    window.login = async function(event) {
        event.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        try {
            const { error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) throw error;
            showInfoModal('¬°Bienvenido!');
            closeAuth();
        } catch (error) { showInfoModal('Error de login: ' + error.message); }
    }

    window.register = async function(event) {
        event.preventDefault();
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;
        if (password !== document.getElementById('register-confirm').value) return showInfoModal('Las contrase√±as no coinciden');
        try {
            const { error } = await supabase.auth.signUp({ email, password });
            if (error) throw error;
            showInfoModal('Registro exitoso. Revisa tu correo.');
            closeAuth();
        } catch (error) { showInfoModal('Error de registro: ' + error.message); }
    }

    window.showAuth = function(type) {
        document.getElementById('user-dropdown').classList.remove('show');
        document.getElementById('login-form').style.display = (type === 'login') ? 'block' : 'none';
        document.getElementById('register-form').style.display = (type === 'register') ? 'block' : 'none';
        document.getElementById('auth-modal').style.display = 'flex';
    }

    window.closeAuth = function() { document.getElementById('auth-modal').style.display = 'none'; }

    const getLocalFavorites = () => JSON.parse(localStorage.getItem('klmz_favorites') || '[]');
    const saveLocalFavorites = (favs) => localStorage.setItem('klmz_favorites', JSON.stringify(favs));

    window.toggleFavorite = function(songId, el) {
        let favorites = getLocalFavorites();
        const isFavorite = favorites.includes(songId);
        if (isFavorite) favorites = favorites.filter(id => id !== songId);
        else favorites.push(songId);
        saveLocalFavorites(favorites);
        if (el) {
            el.style.color = isFavorite ? '#666' : '#1DB954';
            el.innerHTML = isFavorite ? 'ü§ç' : '‚ù§Ô∏è';
        }
        if (document.getElementById('favorites-section').classList.contains('active')) loadFavorites();
    }

    async function loadFavorites() {
        const content = document.getElementById('favorites-content');
        const favorites = getLocalFavorites();
        if (favorites.length === 0) {
            content.innerHTML = `<div style="text-align: center; padding: 3rem;"><h2>No tienes favoritos</h2></div>`;
            return;
        }
        const { data: songs, error } = await supabase.from('songs').select('*, albums:album_id(*)').in('id', favorites);
        if (error) { content.innerHTML = `Error cargando favoritos.`; return; }
        let html = '<div class="favorites-list">';
        songs.forEach(song => {
            html += `<div class="favorite-item" onclick="playSongFromFavorites('${song.id}')">
                <div class="favorite-info">
                    <div class="favorite-title">${song.title}</div>
                    <div class="favorite-artist">${song.albums.artist} ‚Ä¢ ${song.albums.title}</div>
                </div>
                <div class="song-actions">
                    <span onclick="event.stopPropagation(); toggleFavorite('${song.id}', this);" style="cursor: pointer; color: #1DB954; font-size: 1.2rem;">‚ù§Ô∏è</span>
                    <span style="font-size: 1.1rem;">‚ñ∂</span>
                </div>
            </div>`;
        });
        content.innerHTML = html + '</div>';
    }

    window.playSongFromFavorites = async function(songId) {
        const song = songsWithAlbumInfo.find(s => s.id === songId);
        if (song) playSong(song, song.albums, [song], 0);
    }

    window.showSection = function(section) {
        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
        document.getElementById(`${section}-section`).classList.add('active');
        document.querySelectorAll('.bottom-nav-item').forEach(a => a.classList.remove('active'));
        const navIdMap = { home: 'home', search: 'search', downloads: 'downloads', favorites: 'favs' };
        const navItem = document.getElementById(`nav-${navIdMap[section]}`);
        if(navItem) navItem.classList.add('active');
        
        // If the home section is selected, always ensure the album grid is visible
        if (section === 'home') {
            showAlbumsGrid();
        }
        
        if (section === 'favorites') loadFavorites();
        if (section === 'downloads') loadDownloads();
        if (section === 'admin') {
            if (!isAdmin()) {
                showInfoModal('Acceso denegado. Solo para administradores.');
                showSection('home');
                return;
            }
            renderAdminPanel();
        }
    }

    window.showAlbumsGrid = function() {
        document.getElementById('album-detail').style.display = 'none';
        document.getElementById('albums').style.display = 'grid';
    }

    window.playSongFromPlaylist = function(index) {
        playSong(currentPlaylist[index], currentAlbum, currentPlaylist, index);
    }

    window.searchMusic = function() {
        const query = document.getElementById('search-input').value.toLowerCase().trim();
        const results = document.getElementById('search-results');
        if (!query) { results.innerHTML = ''; return; }
        
        const foundAlbums = allAlbums.filter(a => a.title.toLowerCase().includes(query) || a.artist.toLowerCase().includes(query));
        const foundSongs = songsWithAlbumInfo.filter(s => s.title.toLowerCase().includes(query) || s.albums.artist.toLowerCase().includes(query));
        
        let html = '';
        if (foundAlbums.length) {
            html += '<h3>üìÄ √Ålbumes</h3><div class="album-grid">' + foundAlbums.map(album => `
                <div class="album-card" onclick='showAlbumDetail(${JSON.stringify(album).replace(/"/g, '&quot;')})'>
                    <img class="album-img" src="${album.cover_url}"><div class="album-title">${album.title}</div><div class="album-artist">${album.artist}</div>
                </div>`).join('') + '</div>';
        }
        if (foundSongs.length) {
            html += '<h3>üéµ Canciones</h3>' + foundSongs.map(song => `
                <div class="search-song-item" onclick="playSongFromSearch('${song.id}')">
                    <div class="search-song-info"><div class="search-song-title">${song.title}</div><div class="search-song-artist">${song.albums.artist}</div></div>
                    <div style="font-size: 1.1rem;">‚ñ∂</div>
                </div>`).join('');
        }
        results.innerHTML = (html || '<h3>No se encontraron resultados</h3>');
    }

    window.playSongFromSearch = async function(songId) {
        const song = songsWithAlbumInfo.find(s => s.id === songId);
        if (song) playSong(song, song.albums, [song], 0);
    }

    function showLoadingIndicator(show) { document.getElementById('loading-indicator').style.display = show ? 'block' : 'none'; }
    function showErrorMessage(message) {
        document.getElementById('albums').innerHTML = `
            <div style="text-align: center; padding: 3rem;">
                <h2>${message}</h2>
                <p>Puedes acceder a tu m√∫sica descargada.</p>
                <button onclick="showSection('downloads')" style="background: #1DB954; color: #fff; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; margin-top: 1rem;">Ir a Descargas</button>
            </div>`;
    }

    // --- CUSTOM MODAL FUNCTIONS ---
    function showInfoModal(message) {
        const existingModal = document.getElementById('info-modal-backdrop');
        if (existingModal) return;

        const modalBackdrop = document.createElement('div');
        modalBackdrop.id = 'info-modal-backdrop';
        modalBackdrop.className = 'modal';
        modalBackdrop.style.display = 'flex';

        const modalContent = document.createElement('div');
        modalContent.className = 'modal-content';

        const messageP = document.createElement('p');
        messageP.textContent = message;
        messageP.style.marginBottom = '1.5rem';
        messageP.style.textAlign = 'center';
        messageP.style.fontSize = '1.1rem';
        
        const okBtn = document.createElement('button');
        okBtn.textContent = 'OK';
        okBtn.className = 'btn-primary';
        okBtn.onclick = () => {
            document.body.removeChild(modalBackdrop);
        };

        modalContent.appendChild(messageP);
        modalContent.appendChild(okBtn);
        modalBackdrop.appendChild(modalContent);
        document.body.appendChild(modalBackdrop);
    }

    function showConfirmationModal(message, onConfirm) {
        const existingModal = document.getElementById('confirm-modal-backdrop');
        if (existingModal) return;

        const modalBackdrop = document.createElement('div');
        modalBackdrop.id = 'confirm-modal-backdrop';
        modalBackdrop.className = 'modal';
        modalBackdrop.style.display = 'flex';

        const modalContent = document.createElement('div');
        modalContent.className = 'modal-content';

        const messageP = document.createElement('p');
        messageP.textContent = message;
        messageP.style.marginBottom = '1.5rem';
        messageP.style.textAlign = 'center';
        messageP.style.fontSize = '1.1rem';

        const buttonContainer = document.createElement('div');
        buttonContainer.style.display = 'flex';
        buttonContainer.style.gap = '1rem';
        buttonContainer.style.justifyContent = 'center';

        const confirmBtn = document.createElement('button');
        confirmBtn.textContent = 'Confirmar';
        confirmBtn.className = 'btn-danger';
        confirmBtn.style.width = 'auto';
        confirmBtn.onclick = () => {
            onConfirm();
            document.body.removeChild(modalBackdrop);
        };

        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'Cancelar';
        cancelBtn.className = 'btn-secondary';
        cancelBtn.style.width = 'auto';
        cancelBtn.onclick = () => {
            document.body.removeChild(modalBackdrop);
        };

        buttonContainer.appendChild(cancelBtn);
        buttonContainer.appendChild(confirmBtn);
        modalContent.appendChild(messageP);
        modalContent.appendChild(buttonContainer);
        modalBackdrop.appendChild(modalContent);
        document.body.appendChild(modalBackdrop);
    }
    
    // --- ADMIN PANEL FUNCTIONS ---
    async function renderAdminPanel() {
        const adminContent = document.getElementById('admin-content');
        adminContent.innerHTML = `
            <div class="admin-section">
                <h4>Gesti√≥n de √Ålbumes</h4>
                <form id="album-form" class="admin-form">
                    <input type="hidden" id="album-id">
                    <div class="form-group"><input type="text" id="album-title" placeholder="T√≠tulo del √Ålbum" required></div>
                    <div class="form-group"><input type="text" id="album-artist" placeholder="Artista" required></div>
                    <div class="form-group"><input type="url" id="album-cover" placeholder="URL de la Portada" required></div>
                    <button type="submit" class="btn-primary">Guardar √Ålbum</button>
                    <button type="button" id="cancel-album-edit" class="btn-secondary" style="display:none; margin-top: .5rem;">Cancelar Edici√≥n</button>
                </form>
                <div id="admin-album-list" class="admin-list">Cargando √°lbumes...</div>
            </div>
            <div class="admin-section">
                <h4>Gesti√≥n de Canciones</h4>
                <form id="song-form" class="admin-form">
                    <input type="hidden" id="song-id">
                    <div class="form-group"><input type="text" id="song-title" placeholder="T√≠tulo de la Canci√≥n" required></div>
                    <div class="form-group"><select id="song-album-select" required><option>Cargando √°lbumes...</option></select></div>
                    <div class="form-group"><input type="url" id="song-url" placeholder="URL de la Canci√≥n" required></div>
                    <button type="submit" class="btn-primary">Guardar Canci√≥n</button>
                    <button type="button" id="cancel-song-edit" class="btn-secondary" style="display:none; margin-top: .5rem;">Cancelar Edici√≥n</button>
                </form>
                <div id="admin-song-list" class="admin-list">Cargando canciones...</div>
            </div>
        `;
        
        await renderAdminLists();
        setupAdminForms();
    }

    async function renderAdminLists() {
        const { data: albums } = await supabase.from('albums').select('*');
        const { data: songs } = await supabase.from('songs').select('*, albums:album_id(title)');

        // Render Album List
        const albumList = document.getElementById('admin-album-list');
        albumList.innerHTML = albums.map(album => `
            <div class="admin-item">
                <div class="admin-item-info"><strong>${album.title}</strong><br><small>${album.artist}</small></div>
                <div class="admin-item-actions">
                    <button class="btn-secondary" onclick="editAlbum('${album.id}', '${album.title}', '${album.artist}', '${album.cover_url}')">Editar</button>
                    <button class="btn-danger" onclick="deleteAlbum('${album.id}')">Borrar</button>
                </div>
            </div>
        `).join('');

        // Render Song List
        const songList = document.getElementById('admin-song-list');
        songList.innerHTML = songs.map(song => `
            <div class="admin-item">
                <div class="admin-item-info"><strong>${song.title}</strong><br><small>${song.albums.title}</small></div>
                <div class="admin-item-actions">
                    <button class="btn-secondary" onclick="editSong('${song.id}', '${song.title}', '${song.album_id}', '${song.song_url}')">Editar</button>
                    <button class="btn-danger" onclick="deleteSong('${song.id}')">Borrar</button>
                </div>
            </div>
        `).join('');

        // Populate album select in song form
        const albumSelect = document.getElementById('song-album-select');
        albumSelect.innerHTML = `<option value="">-- Seleccionar √Ålbum --</option>` + albums.map(album => `<option value="${album.id}">${album.title}</option>`).join('');
    }

    function setupAdminForms() {
        // Album form
        const albumForm = document.getElementById('album-form');
        albumForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('album-id').value;
            const title = document.getElementById('album-title').value;
            const artist = document.getElementById('album-artist').value;
            const cover_url = document.getElementById('album-cover').value;
            
            showLoadingIndicator(true);
            const { error } = id
                ? await supabase.from('albums').update({ title, artist, cover_url }).eq('id', id)
                : await supabase.from('albums').insert([{ title, artist, cover_url }]);
            
            showLoadingIndicator(false);
            if (error) {
                showInfoModal('Error guardando √°lbum: ' + error.message);
            } else {
                showInfoModal('√Ålbum guardado con √©xito.');
                albumForm.reset();
                document.getElementById('album-id').value = '';
                document.getElementById('cancel-album-edit').style.display = 'none';
                await loadAllData();
                await renderAdminLists();
            }
        });
        document.getElementById('cancel-album-edit').addEventListener('click', () => {
            albumForm.reset();
            document.getElementById('album-id').value = '';
            document.getElementById('cancel-album-edit').style.display = 'none';
        });

        // Song form
        const songForm = document.getElementById('song-form');
        songForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('song-id').value;
            const title = document.getElementById('song-title').value;
            const album_id = document.getElementById('song-album-select').value;
            const song_url = document.getElementById('song-url').value;

            showLoadingIndicator(true);
            const { error } = id
                ? await supabase.from('songs').update({ title, album_id, song_url }).eq('id', id)
                : await supabase.from('songs').insert([{ title, album_id, song_url }]);
            
            showLoadingIndicator(false);
            if (error) {
                showInfoModal('Error guardando canci√≥n: ' + error.message);
            } else {
                showInfoModal('Canci√≥n guardada con √©xito.');
                songForm.reset();
                document.getElementById('song-id').value = '';
                document.getElementById('cancel-song-edit').style.display = 'none';
                await loadAllData();
                await renderAdminLists();
            }
        });
        document.getElementById('cancel-song-edit').addEventListener('click', () => {
            songForm.reset();
            document.getElementById('song-id').value = '';
            document.getElementById('cancel-song-edit').style.display = 'none';
        });
    }

    window.editAlbum = (id, title, artist, cover_url) => {
        document.getElementById('album-id').value = id;
        document.getElementById('album-title').value = title;
        document.getElementById('album-artist').value = artist;
        document.getElementById('album-cover').value = cover_url;
        document.getElementById('cancel-album-edit').style.display = 'inline-block';
        document.getElementById('album-form').scrollIntoView({ behavior: 'smooth' });
    };

    window.deleteAlbum = (id) => {
        showConfirmationModal(
            '¬øSeguro que quieres borrar este √°lbum? Esto tambi√©n borrar√° todas sus canciones.',
            async () => {
                showLoadingIndicator(true);
                // First delete songs of the album
                const { error: songsError } = await supabase.from('songs').delete().eq('album_id', id);
                if (songsError) {
                    showLoadingIndicator(false);
                    showInfoModal('Error borrando las canciones del √°lbum: ' + songsError.message);
                    return;
                }
                
                // Then delete the album
                const { error } = await supabase.from('albums').delete().eq('id', id);
                showLoadingIndicator(false);
                if (error) {
                    showInfoModal('Error borrando √°lbum: ' + error.message);
                } else {
                    showInfoModal('√Ålbum borrado con √©xito.');
                    await loadAllData();
                    await renderAdminLists();
                }
            }
        );
    };

    window.editSong = (id, title, album_id, song_url) => {
        document.getElementById('song-id').value = id;
        document.getElementById('song-title').value = title;
        document.getElementById('song-album-select').value = album_id;
        document.getElementById('song-url').value = song_url;
        document.getElementById('cancel-song-edit').style.display = 'inline-block';
        document.getElementById('song-form').scrollIntoView({ behavior: 'smooth' });
    };

    window.deleteSong = (id) => {
        showConfirmationModal(
            '¬øSeguro que quieres borrar esta canci√≥n?',
            async () => {
                showLoadingIndicator(true);
                const { error } = await supabase.from('songs').delete().eq('id', id);
                showLoadingIndicator(false);
                if (error) {
                    showInfoModal('Error borrando canci√≥n: ' + error.message);
                } else {
                    showInfoModal('Canci√≥n borrada con √©xito.');
                    await loadAllData();
                    await renderAdminLists();
                }
            }
        );
    };


    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        console.log('üöÄ KLMZ MUSIC iniciando...');
        const audio = document.getElementById('audio-player');
        audio.addEventListener('ended', handleSongEnded);
        audio.addEventListener('timeupdate', updateProgressBar);
        audio.addEventListener('play', () => { isPlaying = true; updatePlayButtons(); });
        audio.addEventListener('pause', () => { isPlaying = false; updatePlayButtons(); });
        
        document.getElementById('mini-player').addEventListener('click', (e) => {
            if (!e.target.closest('.player-controls-inline')) openFullPlayer();
        });
        
        loadSavedTheme();
        initDB().then(() => {
            console.log('‚úÖ Base de datos inicializada.');
            loadSupabase();
        }).catch(err => {
            console.error("‚ùå Error fatal de DB:", err);
            showInfoModal("La aplicaci√≥n no puede funcionar sin la base de datos local.");
        });
        
        console.log('‚úÖ KLMZ MUSIC inicializado.');
    });
</script>

<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(registration => console.log('‚úÖ Service Worker registrado:', registration.scope))
                .catch(error => console.log('‚ùå Fallo en registro de SW:', error));
        });
    }
</script>

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ INICIALIZAR APP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
document.addEventListener('DOMContentLoaded', () => {
    console.log('üöÄ KLMZ MUSIC');
    initDB().then(()=>loadSupabase());
    /* ‚Ä¶ listeners de audio, tema guardado, etc. ‚Ä¶ */
});
    </script>

    <!-- Service Worker (sin cambios) -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('‚úÖ SW', reg.scope))
                    .catch(err => console.log('‚ùå SW', err));
            });
        }
    </script>
</body>
</html>
