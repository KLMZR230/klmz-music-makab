<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KLMZ MUSIC</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{
    --bg:#121212;--panel:#181818;--panel2:#1f1f1f;--text:#fff;--muted:#b3b3b3;--brand:#1db954;--brand-hover:#17a84b;--stroke:#2a2a2a;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;padding-bottom:70px;}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#1db954 0%,#1db954 60%,#179b47 100%);padding:14px 18px;font-weight:800;letter-spacing:.3px}
  header .row{display:flex;align-items:center;gap:12px;justify-content:space-between}
  .brand{font-size:20px;display:flex;align-items:center;gap:8px}
  .brand .logo{display:inline-grid;place-items:center;width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg, #ff6b35, #ff4500);font-weight:900;color:#fff;font-size:16px}
  .tools{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{background:var(--brand);border:none;color:#fff;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:600}
  .btn:hover{background:var(--brand-hover)}
  .btn.ghost{background:transparent;border:1px solid #fff1}
  .btn.small{padding:6px 10px;font-size:12px}
  .icon-btn{background:transparent;border:1px solid #ffffff22;color:#fff;padding:8px 10px;border-radius:10px;cursor:pointer;font-size:18px;line-height:1}
  .icon-btn:hover{background:#ffffff14}
  .container{padding:18px;max-width:1100px;margin:auto}
  .card{background:var(--panel);border:1px solid var(--stroke);border-radius:14px;padding:14px}
  .grid{display:grid;gap:16px}
  /* Álbumes estilo Spotify: redondos y pequeños, varias filas */
  .grid.albums{
    grid-template-columns:repeat(auto-fill,minmax(90px,1fr));
  }
  .grid.playlists{
    grid-template-columns:repeat(auto-fill,minmax(120px,1fr));
  }
  .album-card, .playlist-card{
    background:transparent;border:none;padding:8px;cursor:pointer;text-align:center;transition:.15s transform ease;
  }
  .album-card:hover, .playlist-card:hover{transform:translateY(-2px)}
  .album-cover{
    width:100%;
    aspect-ratio:1/1;
    border-radius:50%;
    object-fit:cover;
    background:#0b0b0b;
    border:1px solid var(--stroke);
  }
  .playlist-cover{
    width:100%;
    aspect-ratio:1/1;
    border-radius:12px;
    object-fit:cover;
    background:linear-gradient(135deg, var(--brand), #2e7d32);
    border:1px solid var(--stroke);
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:2rem;
  }
  .album-title, .playlist-title{margin:8px 2px 0;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:.92rem}
  .album-meta, .playlist-meta{margin:0;color:var(--muted);font-size:.78rem}
  .list{display:flex;flex-direction:column;gap:8px}
  .muted{color:var(--muted)}
  .section-title{margin:6px 2px 12px;font-size:1.1rem;font-weight:800;letter-spacing:.2px}
  .inputs{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  input[type="text"],input[type="email"],input[type="password"],select,textarea{
    width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--stroke);background:#101010;color:#fff
  }
  textarea{min-height:60px;resize:vertical;}
  input[type="file"]{width:100%;padding:10px;border-radius:10px;border:1px dashed var(--stroke);background:#0f0f0f;color:#muted}
  .stack{display:grid;gap:10px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .spacer{height:8px}
  .pill{padding:6px 10px;border-radius:999px;background:#ffffff10;border:1px solid var(--stroke);font-size:.8rem;color:#fff}
  /* Vista de Álbum tipo Spotify */
  #albumView, #playlistView{display:none}
  .album-hero, .playlist-hero{display:flex;gap:14px;align-items:center}
  .album-hero img, .playlist-hero .cover{width:96px;height:96px;border-radius:12px;border:1px solid var(--stroke);object-fit:cover;background:#0b0b0b}
  .playlist-hero .cover{background:linear-gradient(135deg, var(--brand), #2e7d32);display:flex;align-items:center;justify-content:center;font-size:2rem;color:#fff}
  .album-hero .info, .playlist-hero .info{min-width:0;flex:1}
  .album-hero .title, .playlist-hero .title{font-size:1.2rem;font-weight:900}
  .album-hero .meta, .playlist-hero .meta{color:var(--muted);font-size:.9rem}
  .song-plain-list{margin-top:8px}
  .song-plain-item{
    padding:10px 0;border-bottom:1px solid #1f1f1f;display:flex;align-items:center;gap:10px
  }
  .song-plain-item:last-child{border-bottom:none}
  .song-plain-item .idx{min-width:20px;text-align:right;color:var(--muted)}
  .song-plain-item .title{flex:1;font-weight:600}
  .song-plain-item .album{color:var(--muted);font-size:.9rem;min-width:120px}
  .song-plain-item .more{font-size:18px;color:var(--muted);cursor:pointer;padding:4px;position:relative}
  .song-plain-item .more:hover{background:#ffffff14;border-radius:4px}
  .song-plain-item.error{color:#ff6b6b}
  .backline{display:flex;align-items:center;gap:10px}
  .back-btn{background:transparent;border:1px solid #ffffff22;color:#fff;width:36px;height:36px;border-radius:10px;font-size:18px;display:grid;place-items:center;cursor:pointer}
  .back-btn:hover{background:#ffffff14}
  /* Player solo aparece cuando hay música reproduciéndose */
  .player{
    position:fixed;left:0;right:0;bottom:70px;
    background:#181818;border-top:1px solid var(--stroke);
    padding:14px 16px;z-index:20;
    display:none;
    animation: slideUp 0.3s ease;
  }
  @keyframes slideUp {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
  }
  .player.show{display:block;}
  .player .wrap{display:grid;grid-template-columns:1fr;gap:12px;align-items:center}
  .np{display:flex;align-items:center;gap:12px;min-width:0}
  .np img{width:68px;height:68px;border-radius:12px;border:1px solid var(--stroke);object-fit:cover;background:#0b0b0b}
  .np .titles{min-width:0}
  .np .titles .t{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:1rem}
  .np .titles .a{color:var(--muted);font-size:.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .controls{display:flex;flex-direction:column;gap:10px}
  .controls .buttons{
    display:flex;align-items:center;justify-content:center;gap:18px
  }
  .controls .buttons .circle{
    width:64px;height:64px;border-radius:50%;
    display:grid;place-items:center;border:1px solid var(--stroke);
    background:#222;font-size:26px;font-weight:900;cursor:pointer
  }
  .controls .buttons .sm{width:52px;height:52px;font-size:22px}
  .controls .seek{display:flex;align-items:center;gap:10px}
  .controls input[type="range"]{width:100%}
  .right{display:flex;justify-content:space-between;gap:10px;align-items:center}
  .vol{display:flex;align-items:center;gap:8px}
  .tag{padding:4px 8px;border:1px solid var(--stroke);border-radius:8px;font-size:.8rem;color:var(--muted)}
  .link{color:#9adfff;text-decoration:none}
  /* Now Playing pantalla completa */
  #npOverlay{
    position:fixed;inset:0;background:#000c;backdrop-filter:blur(6px);
    display:none;align-items:center;justify-content:center;z-index:40
  }
  #npCard{
    background:#111;border:1px solid var(--stroke);border-radius:18px;
    width:min(520px,92vw);padding:18px;display:grid;gap:12px;justify-items:center
  }
  #npCard img{width:min(420px,82vw);height:min(420px,82vw);border-radius:14px;object-fit:cover;border:1px solid var(--stroke);background:#0b0b0b}
  #npCard .t{font-size:1.1rem;font-weight:900}
  #npCard .a{color:var(--muted)}
  /* Barra inferior fija con iconos profesionales y nombres */
  #bottomBar {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 70px;
    background: var(--panel2);
    border-top: 1px solid var(--stroke);
    display: grid;
    grid-template-columns: 1fr 1fr 1fr 1fr;
    place-items: center;
    padding: 8px 20px 4px;
    box-shadow: 0 -1px 10px rgba(0,0,0,0.8);
    z-index: 40;
  }
  #bottomBar button {
    background: transparent;
    border: none;
    color: var(--muted);
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    font-size: 10px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    user-select: none;
    transition: color 0.3s ease;
  }
  #bottomBar button.active, #bottomBar button:hover {
    color: var(--brand);
  }
  #bottomBar .icon {
    width: 28px;
    height: 28px;
    stroke: currentColor;
    stroke-width: 2;
    fill: none;
  }
  #bottomBar .label {
    font-size: 10px;
    font-weight: 600;
    margin-top: 2px;
  }
  /* Footer dinámico que aparece al hacer scroll hasta abajo */
  .scroll-footer {
    display: none;
    position: fixed;
    bottom: 70px;
    left: 0;
    width: 100%;
    background: var(--bg);
    border-top: 1px solid var(--stroke);
    padding: 12px 0;
    text-align: center;
    color: var(--muted);
    font-size: 12px;
    font-weight: 500;
    z-index: 30;
    animation: slideUpFooter 0.3s ease;
  }
  @keyframes slideUpFooter {
    from { 
      opacity: 0;
      transform: translateY(10px); 
    }
    to { 
      opacity: 1;
      transform: translateY(0); 
    }
  }
  /* Onda de sonido simple con barras animadas */
  .soundwave {
    width: 100px;
    height: 40px;
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .bar {
    width: 6px;
    height: 15px;
    background: var(--brand);
    border-radius: 3px;
    animation: wave 1.2s infinite ease-in-out;
    animation-fill-mode: both;
  }
  .bar:nth-child(1) { animation-delay: -1.1s; }
  .bar:nth-child(2) { animation-delay: -0.9s; }
  .bar:nth-child(3) { animation-delay: -0.7s; }
  .bar:nth-child(4) { animation-delay: -0.5s; }
  .bar:nth-child(5) { animation-delay: -0.3s; }
  @keyframes wave {
    0%, 40%, 100% { height: 15px; }
    20% { height: 35px; }
  }
  /* Error indicator */
  .error-msg {
    background: #ff4444;
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 12px;
    position: fixed;
    top: 80px;
    right: 20px;
    z-index: 100;
    animation: fadeInOut 4s ease;
  }
  @keyframes fadeInOut {
    0%, 100% { opacity: 0; }
    10%, 90% { opacity: 1; }
  }
  /* Dropdown menu */
  .dropdown {
    position: absolute;
    background: var(--panel);
    border: 1px solid var(--stroke);
    border-radius: 8px;
    min-width: 180px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.8);
    z-index: 1000;
    display: none;
  }
  .dropdown.show {
    display: block;
  }
  .dropdown-item {
    padding: 10px 14px;
    cursor: pointer;
    border-bottom: 1px solid var(--stroke);
    font-size: 13px;
  }
  .dropdown-item:last-child {
    border-bottom: none;
  }
  .dropdown-item:hover {
    background: var(--panel2);
  }
  .dropdown-item.create-new {
    color: var(--brand);
    font-weight: 600;
  }
  /* Modal styles */
  .modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 60;
  }
  .modal.show {
    display: flex;
  }
  .modal-content {
    background: var(--panel);
    border: 1px solid var(--stroke);
    border-radius: 14px;
    padding: 20px;
    max-width: 450px;
    width: 90%;
  }
  @media (max-width:800px){
    .inputs{grid-template-columns:1fr}
    .player .wrap{grid-template-columns:1fr}
    .np img{width:72px;height:72px}
    .controls .buttons .circle{width:76px;height:76px;font-size:30px}
    .controls .buttons .sm{width:60px;height:60px;font-size:24px}
    body{padding-bottom:70px;}
    .player{bottom:70px;}
    .player.show{bottom:70px;}
    #bottomBar {padding: 6px 10px 2px; height: 70px;}
    #bottomBar button {font-size: 9px; gap: 3px;}
    #bottomBar .icon {width: 24px; height: 24px;}
    #bottomBar .label {font-size: 9px;}
    .scroll-footer {bottom: 70px;}
  }
</style>
</head>
<body>
<header>
  <div class="row">
    <div class="brand">
      <span class="logo">🔥</span> 
      KLMZ MUSIC
    </div>
    <div class="tools">
      <span class="muted" id="albumsTitle">Tu música</span>
      <button class="icon-btn" id="btn-login" title="Admin" onclick="showLogin()">🔑</button>
      <button class="btn ghost" id="btn-logout" style="display:none" onclick="logout()">Salir</button>
    </div>
  </div>
</header>
<div class="container">
  <!-- Información de estado -->
  <div class="row muted" style="margin-bottom:20px;">
    <span class="tag">Catálogo público</span>
    <span id="adminTag" class="tag" style="display:none">Admin</span>
    <span id="userTag" class="tag" style="display:none">Usuario</span>
  </div>
  
  <!-- Panel Admin -->
  <div id="adminPanel" class="card stack" style="display:none">
    <div class="section-title">Panel Admin</div>
    <div class="inputs">
      <div class="stack">
        <div class="pill">Crear nuevo álbum</div>
        <input id="albumTitle" type="text" placeholder="Título del álbum" />
        <input id="albumCover" type="file" accept="image/*" />
        <button class="btn" onclick="uploadAlbum()">Subir Álbum</button>
      </div>
      <div class="stack">
        <div class="pill">Agregar canciones a un álbum existente</div>
        <select id="albumSelect"></select>
        <input id="songTitle" type="text" placeholder="Título de la canción (opcional si subes 1)" />
        <input id="songFiles" type="file" accept="audio/*" multiple />
        <button class="btn" onclick="uploadSong()">Subir Canciones</button>
      </div>
      <div class="stack">
        <div class="pill">Borrar</div>
        <select id="deleteAlbumSelect"></select>
        <button class="btn ghost" onclick="deleteAlbum()">Eliminar Álbum</button>
      </div>
    </div>
  </div>

  <!-- Panel de Usuario (Mis Playlists) -->
  <div id="userPanel" class="card stack" style="display:none">
    <div class="row">
      <div class="section-title">Mis Playlists</div>
      <button class="btn small" onclick="showCreatePlaylistModal()">+ Nueva Playlist</button>
    </div>
    <div id="userPlaylistsGrid" class="grid playlists"></div>
    <div id="emptyPlaylists" class="muted" style="display:none">No tienes playlists todavía. ¡Crea tu primera playlist!</div>
  </div>
  
  <!-- Grilla de Álbumes -->
  <div class="section-title">Albums</div>
  <div id="albumsGrid" class="grid albums"></div>
  <div id="emptyAlbums" class="muted" style="display:none">No hay álbumes todavía.</div>

  <!-- Playlists Públicas -->
  <div id="publicPlaylistsSection" style="display:none">
    <div class="spacer"></div>
    <div class="section-title">Playlists Públicas</div>
    <div id="publicPlaylistsGrid" class="grid playlists"></div>
  </div>
  
  <!-- Vista de Álbum -->
  <div id="albumView" class="card stack">
    <div class="backline">
      <button class="back-btn" onclick="closeAlbumView()" title="Volver">←</button>
      <span class="muted">Volver</span>
    </div>
    <div class="album-hero">
      <img id="avCover" alt="cover">
      <div class="info">
        <div id="avTitle" class="title">—</div>
        <div id="avMeta" class="meta">—</div>
      </div>
    </div>
    <div id="avSongs" class="song-plain-list"></div>
  </div>

  <!-- Vista de Playlist -->
  <div id="playlistView" class="card stack">
    <div class="backline">
      <button class="back-btn" onclick="closePlaylistView()" title="Volver">←</button>
      <span class="muted">Volver</span>
    </div>
    <div class="playlist-hero">
      <div class="cover" id="pvCover">🎵</div>
      <div class="info">
        <div id="pvTitle" class="title">—</div>
        <div id="pvMeta" class="meta">—</div>
        <div id="pvDescription" class="muted" style="margin-top:8px;font-size:14px"></div>
      </div>
      <div id="playlistActions" style="display:none">
        <button class="btn small" onclick="editPlaylist()">Editar</button>
        <button class="btn ghost small" onclick="deletePlaylistConfirm()">Eliminar</button>
      </div>
    </div>
    <div id="pvSongs" class="song-plain-list"></div>
  </div>
</div>

<!-- Player que aparece solo al reproducir -->
<div class="player" id="player" onclick="openNowPlaying()">
  <div class="wrap">
    <div class="np">
      <img id="npCover" alt="cover">
      <div class="titles">
        <div id="npTitle" class="t">Cargando...</div>
        <div id="npAlbum" class="a">—</div>
      </div>
    </div>
    <div class="controls">
      <div class="buttons">
        <button class="circle sm" onclick="event.stopPropagation(); prevTrack()">⏮</button>
        <button class="circle" id="playBtn" onclick="event.stopPropagation(); togglePlay()">▶</button>
        <button class="circle sm" onclick="event.stopPropagation(); nextTrack()">⏭</button>
      </div>
      <div class="seek">
        <span id="curTime" class="muted">0:00</span>
        <input id="seek" type="range" min="0" max="100" value="0" oninput="seekAudio(this.value)" onclick="event.stopPropagation()" />
        <span id="durTime" class="muted">0:00</span>
      </div>
    </div>
    <div class="right">
      <div class="vol">
        <span class="muted">Vol</span>
        <input id="vol" type="range" min="0" max="1" step="0.01" value="1" oninput="setVolume(this.value)" onclick="event.stopPropagation()" />
      </div>
      <div class="soundwave" id="soundwave" style="display:none">
        <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
      </div>
      <audio id="audio" preload="none" crossorigin="anonymous"></audio>
    </div>
  </div>
</div>

<!-- Now Playing Fullscreen -->
<div id="npOverlay" onclick="closeNowPlaying()">
  <div id="npCard" onclick="event.stopPropagation()">
    <img id="npBigCover" alt="cover">
    <div class="t" id="npBigTitle">—</div>
    <div class="a" id="npBigAlbum">—</div>
    <div class="soundwave" style="margin:20px 0;">
      <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
    </div>
    <div class="controls" style="width:100%;max-width:520px">
      <div class="buttons">
        <button class="circle sm" onclick="prevTrack()">⏮</button>
        <button class="circle" onclick="togglePlay()" id="playBtnBig">▶</button>
        <button class="circle sm" onclick="nextTrack()">⏭</button>
      </div>
      <div class="seek">
        <span id="curTimeBig" class="muted">0:00</span>
        <input id="seekBig" type="range" min="0" max="100" value="0" oninput="seekAudio(this.value)" />
        <span id="durTimeBig" class="muted">0:00</span>
      </div>
    </div>
  </div>
</div>

<!-- Barra inferior con playlists incluidas -->
<div id="bottomBar">
  <button id="btn-home" title="Inicio" onclick="goHome(); setActiveNav('home')" class="active" aria-label="Inicio">
    <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
      <path d="M3 11L12 2l9 9v9a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2v-5H9v5a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-9z"/>
    </svg>
    <span class="label">Inicio</span>
  </button>
  <button id="btn-search" title="Buscar" onclick="focusSearch(); setActiveNav('search')" aria-label="Buscar">
    <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
      <circle cx="11" cy="11" r="7"/>
      <line x1="16.5" y1="16.5" x2="21" y2="21"/>
    </svg>
    <span class="label">Buscar</span>
  </button>
  <button id="btn-playlists" title="Playlists" onclick="showPlaylists(); setActiveNav('playlists')" aria-label="Playlists">
    <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
      <path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/>
    </svg>
    <span class="label">Playlists</span>
  </button>
  <button id="btn-account" title="Cuenta" onclick="showAccount(); setActiveNav('account')" aria-label="Cuenta">
    <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
      <circle cx="12" cy="7" r="4"/>
      <path d="M5.5 21a7.5 7.5 0 0 1 13 0"/>
    </svg>
    <span class="label">Cuenta</span>
  </button>
</div>

<!-- Footer dinámico con derechos de autor (aparece solo al hacer scroll hasta abajo) -->
<div id="scrollFooter" class="scroll-footer">
  &copy; <script>document.write(new Date().getFullYear())</script> Freddy Granados. Todos los derechos reservados.
</div>

<!-- Modal para crear/editar playlist -->
<div id="playlistModal" class="modal">
  <div class="modal-content">
    <div class="stack">
      <div class="section-title" id="playlistModalTitle">Nueva Playlist</div>
      <input id="playlistName" type="text" placeholder="Nombre de la playlist" />
      <textarea id="playlistDescription" placeholder="Descripción (opcional)"></textarea>
      <label style="display:flex;align-items:center;gap:8px;">
        <input type="checkbox" id="playlistPublic"> Hacer pública
      </label>
      <div class="row">
        <button class="btn" onclick="savePlaylist()">Guardar</button>
        <button class="btn ghost" onclick="closePlaylistModal()">Cancelar</button>
      </div>
    </div>
  </div>
</div>

<!-- Dropdown para agregar a playlist -->
<div id="playlistDropdown" class="dropdown">
  <div class="dropdown-item create-new" onclick="showCreatePlaylistModal()">+ Nueva Playlist</div>
  <div id="playlistDropdownContent"></div>
</div>

<!-- Modal Login -->
<div id="loginModal" class="card" style="display:none;position:fixed;inset:0;margin:auto;max-width:420px;height:max-content;z-index:50">
  <div class="stack">
    <div class="section-title">Iniciar sesión</div>
    <input id="email" type="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Contraseña" />
    <div class="row">
      <button class="btn" onclick="login()">Entrar</button>
      <button class="btn ghost" onclick="hideLogin()">Cancelar</button>
    </div>
    <small class="muted">Crea una cuenta o inicia sesión para gestionar playlists.</small>
  </div>
</div>

<script>
  const SUPABASE_URL  = "https://nqbldvpnqhngdtalvzov.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xYmxkdnBucWhuZ2R0YWx2em92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyMjY0NjUsImV4cCI6MjA3MDgwMjQ2NX0.Zzg5D219sW7bhvl0_R5ypX9MF6nRzBSDIeo2Lvebab0";
  const ADMIN_EMAIL = "klmzr@gmail.com";
  
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  
  let isAdmin = false, isLoggedIn = false, currentUser = null;
  let albums = [], userPlaylists = [], publicPlaylists = [];
  let songsByAlbum = {}, songsByPlaylist = {}, flatSongs = [];
  let queue = [], qIndex = -1, currentAlbum = null, currentPlaylist = null;
  let editingPlaylistId = null, selectedSongForPlaylist = null;
  
  // UI refs
  const albumsGrid = document.getElementById("albumsGrid");
  const emptyAlbums = document.getElementById("emptyAlbums");
  const npCover = document.getElementById("npCover");
  const npTitle = document.getElementById("npTitle");
  const npAlbum = document.getElementById("npAlbum");
  const playBtn = document.getElementById("playBtn");
  const audioEl = document.getElementById("audio");
  const seekEl = document.getElementById("seek");
  const curTime = document.getElementById("curTime");
  const durTime = document.getElementById("durTime");
  const npOverlay = document.getElementById("npOverlay");
  const npBigCover = document.getElementById("npBigCover");
  const npBigTitle = document.getElementById("npBigTitle");
  const npBigAlbum = document.getElementById("npBigAlbum");
  const curTimeBig = document.getElementById("curTimeBig");
  const durTimeBig = document.getElementById("durTimeBig");
  const seekBig = document.getElementById("seekBig");
  const playBtnBig = document.getElementById("playBtnBig");
  const playerElement = document.getElementById("player");
  
  const albumView = document.getElementById("albumView");
  const avCover = document.getElementById("avCover");
  const avTitle = document.getElementById("avTitle");
  const avMeta = document.getElementById("avMeta");
  const avSongs = document.getElementById("avSongs");

  const playlistView = document.getElementById("playlistView");
  const pvCover = document.getElementById("pvCover");
  const pvTitle = document.getElementById("pvTitle");
  const pvMeta = document.getElementById("pvMeta");
  const pvDescription = document.getElementById("pvDescription");
  const pvSongs = document.getElementById("pvSongs");
  const userPanel = document.getElementById("userPanel");
  const userPlaylistsGrid = document.getElementById("userPlaylistsGrid");
  const publicPlaylistsGrid = document.getElementById("publicPlaylistsGrid");
  const publicPlaylistsSection = document.getElementById("publicPlaylistsSection");
  const emptyPlaylists = document.getElementById("emptyPlaylists");
  
  const playlistModal = document.getElementById("playlistModal");
  const playlistModalTitle = document.getElementById("playlistModalTitle");
  const playlistName = document.getElementById("playlistName");
  const playlistDescription = document.getElementById("playlistDescription");
  const playlistPublic = document.getElementById("playlistPublic");
  const playlistDropdown = document.getElementById("playlistDropdown");
  const playlistDropdownContent = document.getElementById("playlistDropdownContent");
  
  // Footer scroll detector
  const scrollFooter = document.getElementById("scrollFooter");
  
  // Detectar scroll para mostrar footer
  window.addEventListener('scroll', () => {
    const scrollTop = window.scrollY;
    const docHeight = document.documentElement.scrollHeight;
    const winHeight = window.innerHeight;
    
    // Mostrar footer cuando llegue al final (con un poco de margen)
    if (scrollTop + winHeight >= docHeight - 50) {
      scrollFooter.style.display = 'block';
    } else {
      scrollFooter.style.display = 'none';
    }
  });
  
  function setActiveNav(activeButton) {
    document.querySelectorAll('#bottomBar button').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`btn-${activeButton}`).classList.add('active');
  }
  
  function showError(msg) {
    const errorEl = document.createElement('div');
    errorEl.className = 'error-msg';
    errorEl.textContent = msg;
    document.body.appendChild(errorEl);
    setTimeout(() => errorEl.remove(), 4000);
  }
  
  function focusSearch(){
    showError('Usa los álbumes y playlists para navegar tu música');
  }
  
  function goHome(){
    window.scrollTo({top:0,behavior:'smooth'});
    closeAlbumView();
    closePlaylistView();
    document.getElementById('userPanel').style.display = 'none';
  }
  
  function showPlaylists(){
    if (!isLoggedIn) {
      showLogin();
      showError('Inicia sesión para gestionar playlists');
      return;
    }
    goHome();
    userPanel.style.display = 'block';
    userPanel.scrollIntoView({behavior:'smooth', block:'start'});
  }
  
  function showAccount(){
    if(isAdmin){
      alert('Cuenta Admin: ' + ADMIN_EMAIL + '\n\nFuncionalidades:\n• Crear álbumes\n• Subir canciones\n• Eliminar álbumes\n• Gestionar playlists');
    } else if (isLoggedIn) {
      alert('Información de Cuenta\n\nUsuario: ' + currentUser.email + '\n\nFuncionalidades:\n• Crear playlists\n• Gestionar tu música');
    } else {
      showLogin();
    }
  }

  function showPlayer(){
    playerElement.classList.add('show');
    document.body.style.paddingBottom = '270px';
  }
  function hidePlayer(){
    playerElement.classList.remove('show');
    document.body.style.paddingBottom = '70px';
  }

  function toggleSoundwave(show){
    const wave = document.getElementById('soundwave');
    if(show) wave.style.display = 'flex';
    else wave.style.display = 'none';
  }

  function showLogin(){ document.getElementById("loginModal").style.display="block"; }
  function hideLogin(){ document.getElementById("loginModal").style.display="none"; }
  
  async function login(){
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;
    
    if (!password) {
      showError('Ingresa tu contraseña');
      return;
    }
    
    let result = await sb.auth.signInWithPassword({ email, password });
    
    if (result.error) {
      result = await sb.auth.signUp({ email, password });
      if (result.error) {
        showError("Error: " + result.error.message);
        return;
      }
      showError('Cuenta creada! Revisa tu email si es necesario.');
    }
    
    currentUser = result.data.user;
    isLoggedIn = !!currentUser;
    isAdmin = (email.toLowerCase() === ADMIN_EMAIL.toLowerCase());
    
    document.getElementById("btn-login").style.display = "none";
    document.getElementById("btn-logout").style.display = "inline-flex";
    
    if(isAdmin){
      document.getElementById("adminPanel").style.display = "block";
      document.getElementById("adminTag").style.display = "inline-block";
    }
    
    if(isLoggedIn){
      document.getElementById("userTag").style.display = "inline-block";
    }
    
    hideLogin();
    await refreshCatalog();
    if (isLoggedIn) await loadPlaylists();
  }
  
  async function logout(){
    await sb.auth.signOut();
    currentUser = null;
    isLoggedIn = false;
    isAdmin = false;
    
    document.getElementById("adminPanel").style.display = "none";
    document.getElementById("adminTag").style.display = "none";
    document.getElementById("userTag").style.display = "none";
    document.getElementById("userPanel").style.display = "none";
    document.getElementById("btn-login").style.display = "inline-flex";
    document.getElementById("btn-logout").style.display = "none";
    
    userPlaylists = [];
    publicPlaylists = [];
    renderPlaylists();
  }

  async function refreshCatalog(){
    console.log('Cargando álbumes...');
    const { data: alb, error: e1 } = await sb.from("albums").select("*").order("created_at",{ascending:false});
    if (e1){ 
      console.error('Error cargando álbumes:', e1); 
      showError('Error cargando álbumes'); 
      return; 
    }
    albums = alb || [];
    console.log('Álbumes cargados:', albums.length);
    emptyAlbums.style.display = albums.length ? "none" : "block";
    
    const adminSel = document.getElementById("albumSelect");
    const delSel = document.getElementById("deleteAlbumSelect");
    if (adminSel) adminSel.innerHTML = "";
    if (delSel) delSel.innerHTML = "";
    
    for (const a of albums){
      if (adminSel){
        const o = document.createElement("option");
        o.value = a.id; o.textContent = a.title;
        adminSel.appendChild(o);
      }
      if (delSel){
        const d = document.createElement("option");
        d.value = a.id; d.textContent = a.title;
        delSel.appendChild(d);
      }
    }
    
    songsByAlbum = {};
    flatSongs = [];
    for (const a of albums){
      const { data: ss, error: e2 } = await sb.from("songs").select("*").eq("album_id", a.id).order("created_at",{ascending:true});
      if (e2){ console.error(e2); continue; }
      songsByAlbum[a.id] = ss || [];
      for (const s of (ss||[])){
        flatSongs.push({...s, album_title: a.title, cover_url: a.cover_url});
      }
    }
    
    renderAlbums();
    
    if (isLoggedIn) {
      await loadPlaylists();
    }
  }
  
  function renderAlbums(list = albums){
    console.log('Renderizando álbumes:', list.length);
    albumsGrid.innerHTML = "";
    list.forEach(a => {
      const count = (songsByAlbum[a.id]?.length||0);
      const card = document.createElement("div");
      card.className = "album-card";
      card.innerHTML = `
        <img class="album-cover" src="${a.cover_url}" alt="${a.title}">
        <div class="album-title">${a.title}</div>
        <div class="album-meta">${count} ${count===1?'canción':'canciones'}</div>
      `;
      card.onclick = () => openAlbum(a);
      albumsGrid.appendChild(card);
    });
  }
  
  function openAlbum(album){
    currentAlbum = album;
    const songs = songsByAlbum[album.id] || [];
    avCover.src = album.cover_url || "";
    avTitle.textContent = album.title;
    avMeta.textContent = `${songs.length} ${songs.length===1?'canción':'canciones'}`;
    avSongs.innerHTML = "";
    if (!songs.length){
      avSongs.innerHTML = `<div class="muted" style="padding:12px 0">Este álbum no tiene canciones todavía.</div>`;
    } else {
      songs.forEach((s,idx) => {
        const row = document.createElement("div");
        row.className = "song-plain-item";
        row.innerHTML = `
          <div class="idx">${idx+1}</div>
          <div class="title">${s.title}</div>
          <div class="more" onclick="event.stopPropagation(); showAddToPlaylistMenu(event, {id: '${s.id}', title: '${s.title.replace(/'/g, "\\'")}', album_title: '${album.title.replace(/'/g, "\\'")}', cover_url: '${album.cover_url}'})">+</div>
        `;
        row.onclick = () => {
          queue = songs.map(t => ({...t, album_title: album.title, cover_url: album.cover_url}));
          qIndex = -1;
          startQueueAt(idx);
        };
        avSongs.appendChild(row);
      });
    }
    albumView.style.display = "block";
    albumView.scrollIntoView({behavior:"smooth",block:"start"});
  }
  
  function closeAlbumView(){
    albumView.style.display = "none";
    currentAlbum = null;
  }
  
  // Continuando con el resto de funciones del script anterior...
  async function loadPlaylists(){
    if (!isLoggedIn) return;
    
    const { data: userPl, error: e1 } = await sb
      .from('playlists')
      .select('*')
      .eq('user_id', currentUser.id)
      .order('created_at', {ascending: false});
    
    if (e1) { console.error('Error cargando playlists:', e1); return; }
    userPlaylists = userPl || [];
    
    const { data: publicPl, error: e2 } = await sb
      .from('playlists')
      .select('*')
      .eq('is_public', true)
      .neq('user_id', currentUser.id)
      .order('created_at', {ascending: false});
    
    if (e2) { console.error('Error cargando playlists públicas:', e2); return; }
    publicPlaylists = publicPl || [];
    
    songsByPlaylist = {};
    const allPlaylists = [...userPlaylists, ...publicPlaylists];
    
    for (const playlist of allPlaylists) {
      const { data: playlistSongs, error: e3 } = await sb
        .from('playlist_songs')
        .select(`
          *,
          songs (
            id, title, song_url,
            albums (title, cover_url)
          )
        `)
        .eq('playlist_id', playlist.id)
        .order('position', {ascending: true});
      
      if (e3) { console.error('Error cargando canciones de playlist:', e3); continue; }
      
      songsByPlaylist[playlist.id] = (playlistSongs || []).map(ps => ({
        ...ps.songs,
        album_title: ps.songs.albums?.title || 'Sin álbum',
        cover_url: ps.songs.albums?.cover_url || '',
        playlist_song_id: ps.id
      }));
    }
    
    renderPlaylists();
  }
  
  function renderPlaylists(){
    userPlaylistsGrid.innerHTML = "";
    emptyPlaylists.style.display = userPlaylists.length ? "none" : "block";
    
    userPlaylists.forEach(playlist => {
      const count = songsByPlaylist[playlist.id]?.length || 0;
      const card = document.createElement("div");
      card.className = "playlist-card";
      card.innerHTML = `
        <div class="playlist-cover">🎵</div>
        <div class="playlist-title">${playlist.name}</div>
        <div class="playlist-meta">${count} ${count===1?'canción':'canciones'}</div>
      `;
      card.onclick = () => openPlaylist(playlist);
      userPlaylistsGrid.appendChild(card);
    });
    
    if (publicPlaylists.length > 0) {
      publicPlaylistsSection.style.display = 'block';
      publicPlaylistsGrid.innerHTML = "";
      
      publicPlaylists.forEach(playlist => {
        const count = songsByPlaylist[playlist.id]?.length || 0;
        const card = document.createElement("div");
        card.className = "playlist-card";
        card.innerHTML = `
          <div class="playlist-cover">🎵</div>
          <div class="playlist-title">${playlist.name}</div>
          <div class="playlist-meta">${count} ${count===1?'canción':'canciones'}</div>
        `;
        card.onclick = () => openPlaylist(playlist);
        publicPlaylistsGrid.appendChild(card);
      });
    } else {
      publicPlaylistsSection.style.display = 'none';
    }
    
    updatePlaylistDropdown();
  }
  
  function updatePlaylistDropdown(){
    playlistDropdownContent.innerHTML = '';
    userPlaylists.forEach(playlist => {
      const item = document.createElement('div');
      item.className = 'dropdown-item';
      item.textContent = playlist.name;
      item.onclick = () => addSongToPlaylist(playlist.id);
      playlistDropdownContent.appendChild(item);
    });
  }
  
  function showCreatePlaylistModal(){
    if (!isLoggedIn) {
      showLogin();
      return;
    }
    editingPlaylistId = null;
    playlistModalTitle.textContent = 'Nueva Playlist';
    playlistName.value = '';
    playlistDescription.value = '';
    playlistPublic.checked = false;
    playlistModal.classList.add('show');
  }
  
  function editPlaylist(){
    if (!currentPlaylist) return;
    editingPlaylistId = currentPlaylist.id;
    playlistModalTitle.textContent = 'Editar Playlist';
    playlistName.value = currentPlaylist.name;
    playlistDescription.value = currentPlaylist.description || '';
    playlistPublic.checked = currentPlaylist.is_public;
    playlistModal.classList.add('show');
  }
  
  function closePlaylistModal(){
    playlistModal.classList.remove('show');
    editingPlaylistId = null;
  }
  
  async function savePlaylist(){
    if (!isLoggedIn) return;
    
    const name = playlistName.value.trim();
    if (!name) {
      showError('Ingresa un nombre para la playlist');
      return;
    }
    
    const data = {
      name,
      description: playlistDescription.value.trim() || null,
      is_public: playlistPublic.checked,
      user_id: currentUser.id
    };
    
    let result;
    if (editingPlaylistId) {
      result = await sb
        .from('playlists')
        .update(data)
        .eq('id', editingPlaylistId);
    } else {
      result = await sb
        .from('playlists')
        .insert([data]);
    }
    
    if (result.error) {
      showError('Error guardando playlist: ' + result.error.message);
      return;
    }
    
    closePlaylistModal();
    await loadPlaylists();
    showError(editingPlaylistId ? 'Playlist actualizada' : 'Playlist creada');
  }
  
  function openPlaylist(playlist){
    currentPlaylist = playlist;
    const songs = songsByPlaylist[playlist.id] || [];
    
    pvTitle.textContent = playlist.name;
    pvMeta.textContent = `${songs.length} ${songs.length===1?'canción':'canciones'}`;
    pvDescription.textContent = playlist.description || '';
    
    const isOwner = isLoggedIn && playlist.user_id === currentUser.id;
    document.getElementById('playlistActions').style.display = isOwner ? 'flex' : 'none';
    
    pvSongs.innerHTML = "";
    if (!songs.length){
      pvSongs.innerHTML = `<div class="muted" style="padding:12px 0">Esta playlist está vacía.</div>`;
    } else {
      songs.forEach((s,idx) => {
        const row = document.createElement("div");
        row.className = "song-plain-item";
        row.innerHTML = `
          <div class="idx">${idx+1}</div>
          <div class="title">${s.title}</div>
          <div class="album">${s.album_title}</div>
          <div class="more" onclick="event.stopPropagation(); ${isOwner ? `removeSongFromPlaylist('${s.playlist_song_id}')` : ''}">
            ${isOwner ? '×' : '⋯'}
          </div>
        `;
        row.onclick = () => {
          queue = songs.map(t => ({...t, album_title: t.album_title, cover_url: t.cover_url}));
          qIndex = -1;
          startQueueAt(idx);
        };
        pvSongs.appendChild(row);
      });
    }
    
    playlistView.style.display = "block";
    playlistView.scrollIntoView({behavior:"smooth",block:"start"});
  }
  
  function closePlaylistView(){
    playlistView.style.display = "none";
    currentPlaylist = null;
  }
  
  function showAddToPlaylistMenu(event, song) {
    if (!isLoggedIn) {
      showLogin();
      return;
    }
    
    event.stopPropagation();
    selectedSongForPlaylist = song;
    
    const rect = event.target.getBoundingClientRect();
    playlistDropdown.style.top = (rect.top - 200) + 'px';
    playlistDropdown.style.left = (rect.left - 150) + 'px';
    playlistDropdown.classList.add('show');
    
    setTimeout(() => {
      document.addEventListener('click', hidePlaylistDropdown, { once: true });
    }, 100);
  }
  
  function hidePlaylistDropdown(){
    playlistDropdown.classList.remove('show');
  }
  
  async function addSongToPlaylist(playlistId) {
    hidePlaylistDropdown();
    
    if (!selectedSongForPlaylist) return;
    
    const existing = await sb
      .from('playlist_songs')
      .select('id')
      .eq('playlist_id', playlistId)
      .eq('song_id', selectedSongForPlaylist.id)
      .single();
    
    if (existing.data) {
      showError('La canción ya está en esta playlist');
      return;
    }
    
    const { data: maxPos } = await sb
      .from('playlist_songs')
      .select('position')
      .eq('playlist_id', playlistId)
      .order('position', {ascending: false})
      .limit(1)
      .single();
    
    const position = (maxPos?.position || 0) + 1;
    
    const { error } = await sb
      .from('playlist_songs')
      .insert([{
        playlist_id: playlistId,
        song_id: selectedSongForPlaylist.id,
        position
      }]);
    
    if (error) {
      showError('Error agregando canción: ' + error.message);
      return;
    }
    
    showError('Canción agregada a la playlist');
    await loadPlaylists();
    
    if (currentPlaylist && currentPlaylist.id === playlistId) {
      openPlaylist(currentPlaylist);
    }
  }
  
  async function removeSongFromPlaylist(playlistSongId) {
    if (!confirm('¿Eliminar esta canción de la playlist?')) return;
    
    const { error } = await sb
      .from('playlist_songs')
      .delete()
      .eq('id', playlistSongId);
    
    if (error) {
      showError('Error eliminando canción: ' + error.message);
      return;
    }
    
    showError('Canción eliminada de la playlist');
    await loadPlaylists();
    
    if (currentPlaylist) {
      openPlaylist(currentPlaylist);
    }
  }
  
  async function deletePlaylistConfirm(){
    if (!currentPlaylist || !confirm('¿Eliminar esta playlist permanentemente?')) return;
    
    const { error } = await sb
      .from('playlists')
      .delete()
      .eq('id', currentPlaylist.id);
    
    if (error) {
      showError('Error eliminando playlist: ' + error.message);
      return;
    }
    
    showError('Playlist eliminada');
    closePlaylistView();
    await loadPlaylists();
  }

  function isValidAudioUrl(url) {
    if (!url || typeof url !== 'string') return false;
    try {
      const urlObj = new URL(url);
      return urlObj.protocol === 'https:' && url.includes('supabase');
    } catch {
      return false;
    }
  }
  
  function startQueueFromList(list, idx){ queue = list; qIndex = -1; startQueueAt(idx); }
  function startQueueAt(idx){ if (!queue.length) return; qIndex = idx; playTrack(queue[qIndex]); }
  
  function playTrack(song){
    console.log('Intentando reproducir:', song.title, song.song_url);
    
    if (!song.song_url || !isValidAudioUrl(song.song_url)) {
      showError(`Error: URL de audio no válida para "${song.title}"`);
      nextTrack();
      return;
    }
    
    audioEl.pause();
    audioEl.currentTime = 0;
    audioEl.src = song.song_url;
    audioEl.load();
    
    npTitle.textContent = song.title;
    npAlbum.textContent = song.album_title || "—";
    npCover.src = song.cover_url || "";
    npBigTitle.textContent = song.title;
    npBigAlbum.textContent = song.album_title || "—";
    npBigCover.src = song.cover_url || "";
    
    showPlayer();
    
    const playPromise = audioEl.play();
    if (playPromise !== undefined) {
      playPromise
        .then(() => {
          console.log('Reproducción exitosa:', song.title);
          playBtn.textContent = "⏸";
          playBtnBig.textContent = "⏸";
          toggleSoundwave(true);
          setTimeout(() => {
            npOverlay.style.display = 'flex';
          }, 500);
        })
        .catch((error) => {
          console.error('Error de reproducción:', error, song.song_url);
          showError(`No se puede reproducir "${song.title}". Formato o archivo inválido.`);
          setTimeout(() => {
            if (queue.length > 1) {
              nextTrack();
            } else {
              hidePlayer();
            }
          }, 2000);
        });
    }
  }
  
  function togglePlay(){
    if (audioEl.paused){ 
      const playPromise = audioEl.play();
      if (playPromise !== undefined) {
        playPromise
          .then(() => {
            playBtn.textContent="⏸"; 
            playBtnBig.textContent="⏸"; 
            toggleSoundwave(true);
          })
          .catch((error) => {
            console.error('Error al reanudar:', error);
            showError('Error al reanudar reproducción');
          });
      }
    }
    else { 
      audioEl.pause(); 
      playBtn.textContent="▶"; 
      playBtnBig.textContent="▶"; 
      toggleSoundwave(false);
    }
  }
  
  function nextTrack(){ 
    if (!queue.length) return; 
    qIndex = (qIndex + 1) % queue.length; 
    playTrack(queue[qIndex]); 
  }
  
  function prevTrack(){ 
    if (!queue.length) return; 
    qIndex = (qIndex - 1 + queue.length) % queue.length; 
    playTrack(queue[qIndex]); 
  }
  
  function setVolume(v){ audioEl.volume = v; }
  function seekAudio(percent){ if (!audioEl.duration || isNaN(audioEl.duration)) return; audioEl.currentTime = (percent/100) * audioEl.duration; }
  function fmt(t){ if(!isFinite(t)) return "0:00"; const m=Math.floor(t/60), s=Math.floor(t%60); return `${m}:${s.toString().padStart(2,"0")}`; }
  
  audioEl.addEventListener('loadstart', () => {
    console.log('Cargando audio...');
    npTitle.textContent = 'Cargando...';
  });
  
  audioEl.addEventListener('canplaythrough', () => {
    console.log('Audio listo para reproducir');
  });
  
  audioEl.addEventListener('error', (e) => {
    console.error('Error de audio:', e);
    const currentSong = queue[qIndex];
    if (currentSong) {
      showError(`Error cargando "${currentSong.title}"`);
      setTimeout(() => nextTrack(), 2000);
    }
  });
  
  audioEl.addEventListener("timeupdate",()=>{
    if (!audioEl.duration) return;
    const p = (audioEl.currentTime / audioEl.duration) * 100;
    seekEl.value = p; curTime.textContent = fmt(audioEl.currentTime); durTime.textContent = fmt(audioEl.duration);
    seekBig.value = p; curTimeBig.textContent = fmt(audioEl.currentTime); durTimeBig.textContent = fmt(audioEl.duration);
  });
  
  audioEl.addEventListener("ended",()=> nextTrack());
  audioEl.addEventListener("pause",()=> toggleSoundwave(false));
  audioEl.addEventListener("play",()=> toggleSoundwave(true));
  
  function openNowPlaying(){
    npOverlay.style.display = "flex";
  }
  function closeNowPlaying(){ 
    npOverlay.style.display = "none"; 
  }

  function safeName(name){ return name.replace(/[^a-zA-Z0-9\_\-.]+/g,"-"); }
  
  async function uploadAlbum(){
    if (!isAdmin) return alert("No autorizado");
    const title = document.getElementById("albumTitle").value.trim();
    const file = document.getElementById("albumCover").files[0];
    if (!title || !file) return alert("Completa título y portada");
    const path = `${Date.now()}-${safeName(file.name)}`;
    const { error: upErr } = await sb.storage.from("covers").upload(path, file);
    if (upErr) return alert("Error subiendo portada: " + upErr.message);
    const { data: pub } = sb.storage.from("covers").getPublicUrl(path);
    const cover_url = pub.publicUrl;
    const { error: insErr } = await sb.from("albums").insert([{ title, cover_url }]);
    if (insErr) return alert("Error guardando álbum: " + insErr.message);
    document.getElementById("albumTitle").value = "";
    document.getElementById("albumCover").value = "";
    alert("Álbum creado");
    await refreshCatalog();
  }
  
  async function uploadSong(){
    if (!isAdmin) return alert("No autorizado");
    const albumId = document.getElementById("albumSelect").value;
    const titleInput = document.getElementById("songTitle").value.trim();
    const files = document.getElementById("songFiles").files;
    if (!albumId || files.length === 0) return alert("Selecciona un álbum y al menos un archivo de audio");
    
    let ok = 0, fail = 0;
    for (const file of files) {
      console.log('Subiendo archivo:', file.name, 'Tipo:', file.type, 'Tamaño:', file.size);
      
      if (!file.type.startsWith('audio/')) {
        console.error('Archivo no es audio:', file.name);
        fail++;
        continue;
      }
      
      const path = `${Date.now()}-${safeName(file.name)}`;
      const { error: upErr } = await sb.storage.from("songs").upload(path, file);
      if (upErr) { 
        console.error('Error subida:', upErr); 
        fail++; 
        continue; 
      }
      const { data: pub } = sb.storage.from("songs").getPublicUrl(path);
      const song_url = pub.publicUrl;
      console.log('URL generada:', song_url);
      
      const title = (files.length === 1 && titleInput) ? titleInput : file.name.replace(/\.[^/.]+$/, "");
      const { error: insErr } = await sb.from("songs").insert([{ album_id: albumId, title, song_url }]);
      if (insErr) { 
        console.error('Error DB:', insErr); 
        fail++; 
      } else { 
        ok++; 
      }
    }
    
    document.getElementById("songTitle").value = "";
    document.getElementById("songFiles").value = "";
    alert(`Subida completa: ${ok} ok, ${fail} error(es)`);
    await refreshCatalog();
  }
  
  async function deleteAlbum(){
    if (!isAdmin) return alert("No autorizado");
    const albumId = document.getElementById("deleteAlbumSelect").value;
    if (!albumId) return alert("Selecciona un álbum");
    if (!confirm("¿Eliminar álbum y todas sus canciones?")) return;
    const { error: delSongsErr } = await sb.from("songs").delete().eq("album_id", albumId);
    if (delSongsErr) { alert("Error borrando canciones: " + delSongsErr.message); return; }
    const { error: delAlbErr } = await sb.from("albums").delete().eq("id", albumId);
    if (delAlbErr) { alert("Error borrando álbum: " + delAlbErr.message); return; }
    alert("Álbum eliminado");
    if (currentAlbum?.id === albumId) closeAlbumView();
    await refreshCatalog();
  }
  
  // Inicialización
  (async () => {
    console.log('Inicializando aplicación...');
    const { data } = await sb.auth.getSession();
    if (data?.session?.user?.email) {
      const email = data.session.user.email;
      currentUser = data.session.user;
      isLoggedIn = true;
      isAdmin = (email.toLowerCase() === ADMIN_EMAIL.toLowerCase());
      document.getElementById("btn-login").style.display = "none";
      document.getElementById("btn-logout").style.display = "inline-flex";
      if(isAdmin){
        document.getElementById("adminPanel").style.display = "block";
        document.getElementById("adminTag").style.display = "inline-block";
      }
      if(isLoggedIn){
        document.getElementById("userTag").style.display = "inline-block";
      }
    }
    await refreshCatalog();
  })();
</script>
</body>
</html>
