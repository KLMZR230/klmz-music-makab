<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KLMZ MUSIC</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{
    --bg:#121212;--panel:#181818;--panel2:#1f1f1f;--text:#fff;--muted:#b3b3b3;--brand:#1db954;--brand-hover:#17a84b;--stroke:#2a2a2a;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;padding-bottom:110px}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#1db954 0%,#1db954 60%,#179b47 100%);padding:14px 18px;font-weight:800;letter-spacing:.3px}
  header .row{display:flex;align-items:center;gap:12px;justify-content:space-between}
  .brand{font-size:20px;display:flex;align-items:center;gap:8px}
  .brand .logo{display:inline-grid;place-items:center;width:28px;height:28px;border-radius:8px;background:#0c5e2f;font-weight:900}
  .tools{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{background:var(--brand);border:none;color:#fff;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:600}
  .btn:hover{background:var(--brand-hover)}
  .btn.ghost{background:transparent;border:1px solid #fff1}
  .icon-btn{width:36px;height:36px;border-radius:10px;border:1px solid #ffffff22;background:#ffffff10;display:grid;place-items:center;cursor:pointer}
  .icon-btn:hover{background:#ffffff18}
  .container{padding:18px;max-width:1100px;margin:auto}
  .card{background:var(--panel);border:1px solid var(--stroke);border-radius:14px;padding:14px}
  .grid{display:grid;gap:16px}
  /* ‚¨áÔ∏è Cuadr√≠cula 4 columnas (responsiva) */
  .grid.albums{grid-template-columns:repeat(4,minmax(0,1fr))}
  @media (max-width:1000px){ .grid.albums{grid-template-columns:repeat(3,1fr)} }
  @media (max-width:700px){ .grid.albums{grid-template-columns:repeat(2,1fr)} }

  .album-card{background:var(--panel2);border:1px solid var(--stroke);border-radius:14px;padding:12px;cursor:pointer;transition:.15s transform ease,.2s background;display:flex;flex-direction:column;align-items:center;text-align:center;position:relative}
  .album-card:hover{transform:translateY(-2px);background:#242424}
  /* ‚¨áÔ∏è Portada redonda y peque√±a (estilo Spotify) */
  .album-cover{width:96px;height:96px;border-radius:50%;object-fit:cover;background:#0b0b0b;border:1px solid var(--stroke);display:block}
  .album-title{margin:10px 2px 0;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;width:100%}
  .album-meta{margin:2px;color:var(--muted);font-size:.85rem}
  .list{display:flex;flex-direction:column;gap:8px}
  .song-row{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;background:var(--panel);border:1px solid var(--stroke)}
  .song-row:hover{background:#222}
  .song-row .play{min-width:36px;min-height:36px;border-radius:50%;border:1px solid var(--stroke);display:grid;place-items:center;background:#2a2a2a;cursor:pointer}
  .song-title{font-weight:600}
  .muted{color:var(--muted)}
  .section-title{margin:6px 2px 12px;font-size:1.1rem;font-weight:800;letter-spacing:.2px}
  .inputs{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  input[type="text"],input[type="email"],input[type="password"],select{
    width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--stroke);background:#101010;color:#fff
  }
  input[type="file"]{width:100%;padding:10px;border-radius:10px;border:1px dashed var(--stroke);background:#0f0f0f;color:#muted}
  .stack{display:grid;gap:10px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .spacer{height:8px}
  .pill{padding:6px 10px;border-radius:999px;background:#ffffff10;border:1px solid var(--stroke);color:#fff}
  .tag{padding:4px 8px;border:1px solid var(--stroke);border-radius:8px;font-size:.8rem;color:var(--muted)}
  .link{color:#9adfff;text-decoration:none}

  /* Player (m√°s grande, botones centrados) */
  .player{position:fixed;left:0;right:0;bottom:0;background:#181818;border-top:1px solid var(--stroke);padding:14px 14px;z-index:20}
  .player .wrap{display:grid;grid-template-columns:1fr 2fr 1fr;gap:10px;align-items:center}
  .np{display:flex;align-items:center;gap:10px;min-width:0}
  .np img{width:64px;height:64px;border-radius:10px;border:1px solid var(--stroke);object-fit:cover;background:#0b0b0b}
  .np .titles{min-width:0}
  .np .titles .t{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .np .titles .a{color:var(--muted);font-size:.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  .controls{display:flex;flex-direction:column;gap:8px}
  .controls .buttons{display:flex;align-items:center;justify-content:center;gap:14px}
  .controls .buttons .btn-ctl{font-size:26px;width:52px;height:52px;border-radius:50%;display:grid;place-items:center;border:1px solid var(--stroke);background:#2a2a2a;cursor:pointer}
  .controls .buttons .btn-ctl.main{font-size:30px;width:64px;height:64px;background:var(--brand);border:none;color:#fff}
  .controls .seek{display:flex;align-items:center;gap:10px}
  .controls input[type="range"]{width:100%}
  .right{display:flex;justify-content:flex-end;gap:10px;align-items:center}
  .vol{display:flex;align-items:center;gap:8px}

  /* Ondas de m√∫sica */
  .wave{display:flex;align-items:flex-end;gap:3px;height:16px}
  .bar{width:3px;background:#58ff9a;opacity:.8;border-radius:2px;animation:wave 1.2s ease-in-out infinite}
  .bar:nth-child(1){height:6px;animation-delay:.0s}
  .bar:nth-child(2){height:12px;animation-delay:.15s}
  .bar:nth-child(3){height:16px;animation-delay:.3s}
  .bar:nth-child(4){height:10px;animation-delay:.45s}
  .bar:nth-child(5){height:14px;animation-delay:.6s}
  @keyframes wave{
    0%,100%{transform:scaleY(0.6)}
    50%{transform:scaleY(1)}
  }

  /* Reproductor expandido */
  .fs-backdrop{position:fixed;inset:0;background:#000a;backdrop-filter:blur(4px);display:none;z-index:40}
  .fs-player{position:fixed;inset:0;display:none;z-index:41;place-items:center}
  .fs-card{background:#121212;border:1px solid var(--stroke);border-radius:16px;padding:16px;max-width:520px;width:92%;display:grid;gap:14px}
  .fs-cover{width:100%;aspect-ratio:1/1;border-radius:12px;object-fit:cover;border:1px solid var(--stroke);background:#0b0b0b}
  .fs-titles .t{font-weight:800;font-size:1.2rem}
  .fs-titles .a{color:var(--muted)}
  .fs-buttons{display:flex;justify-content:center;gap:14px}
  .fs-buttons .btn-ctl{font-size:30px;width:66px;height:66px;border-radius:50%;display:grid;place-items:center;border:1px solid var(--stroke);background:#2a2a2a;cursor:pointer}
  .fs-buttons .btn-ctl.main{font-size:34px;width:78px;height:78px;background:var(--brand);border:none;color:#fff}
  .fs-close{position:absolute;top:14px;right:14px}
  .searchbar{display:grid;grid-template-columns:1fr 220px;gap:10px}

  /* Admin delete chips (discretos) */
  .chip-del{position:absolute;top:8px;right:8px;background:#ff3b3b; border:none;color:#fff;padding:6px 8px;border-radius:8px;font-size:.8rem;display:none}
  .album-card.admin .chip-del{display:inline-block}

  @media (max-width:800px){
    .inputs{grid-template-columns:1fr}
    .player .wrap{grid-template-columns:1fr}
    .searchbar{grid-template-columns:1fr}
  }
</style>
</head>
<body>

<header>
  <div class="row">
    <div class="brand"><span class="logo">‚ô´</span> KLMZ MUSIC</div>
    <div class="tools">
      <!-- üîë Llavesita para abrir login -->
      <button class="icon-btn" id="btn-key" title="Admin" onclick="showLogin()">üîë</button>
      <button class="btn ghost" id="btn-logout" style="display:none" onclick="logout()">Salir</button>
    </div>
  </div>
</header>

<div class="container">
  <!-- Buscador / Filtros -->
  <div class="card stack">
    <div class="searchbar">
      <input id="search" type="text" placeholder="Buscar √°lbum o canci√≥n..." oninput="applyFilters()" />
      <select id="albumFilter" onchange="applyFilters()">
        <option value="">Filtrar por √°lbum</option>
      </select>
    </div>
    <div class="row muted"><span class="tag">Cat√°logo p√∫blico</span><span id="adminTag" class="tag" style="display:none">Admin</span></div>
  </div>

  <!-- Panel Admin -->
  <div id="adminPanel" class="card stack" style="display:none">
    <div class="section-title">Panel Admin</div>
    <div class="inputs">
      <div class="stack">
        <div class="pill">Crear nuevo √°lbum</div>
        <input id="albumTitle" type="text" placeholder="T√≠tulo del √°lbum" />
        <input id="albumCover" type="file" accept="image/*" />
        <button class="btn" onclick="uploadAlbum()">Subir √Ålbum</button>
      </div>
      <div class="stack">
        <div class="pill">Agregar canciones a un √°lbum existente</div>
        <select id="albumSelect"></select>
        <input id="songTitle" type="text" placeholder="T√≠tulo de la canci√≥n (opcional si subes 1)" />
        <input id="songFiles" type="file" accept="audio/*" multiple />
        <button class="btn" onclick="uploadSong()">Subir Canciones</button>
      </div>
    </div>
  </div>

  <!-- Cat√°logo -->
  <div class="spacer"></div>
  <div class="section-title">Albums</div>
  <div id="albumsGrid" class="grid albums"></div>

  <!-- Resultados de b√∫squeda (canciones) -->
  <div id="searchResults" class="stack" style="display:none">
    <div class="section-title">Resultados</div>
    <div id="songsList" class="list"></div>
  </div>
</div>

<!-- Player fijo -->
<div class="player">
  <div class="wrap" id="playerClickZone" onclick="openFs()">
    <div class="np">
      <img id="npCover" alt="cover">
      <div class="titles">
        <div id="npTitle" class="t">Nada reproduci√©ndose</div>
        <div id="npAlbum" class="a">‚Äî</div>
        <div class="wave" aria-hidden="true">
          <span class="bar"></span><span class="bar"></span><span class="bar"></span><span class="bar"></span><span class="bar"></span>
        </div>
      </div>
    </div>

    <div class="controls">
      <div class="buttons">
        <button class="btn-ctl" onclick="event.stopPropagation(); prevTrack()">‚èÆ</button>
        <button class="btn-ctl main" id="playBtn" onclick="event.stopPropagation(); togglePlay()">‚ñ∂</button>
        <button class="btn-ctl" onclick="event.stopPropagation(); nextTrack()">‚è≠</button>
      </div>
      <div class="seek" onclick="event.stopPropagation()">
        <span id="curTime" class="muted">0:00</span>
        <input id="seek" type="range" min="0" max="100" value="0" oninput="seekAudio(this.value)" />
        <span id="durTime" class="muted">0:00</span>
      </div>
    </div>

    <div class="right" onclick="event.stopPropagation()">
      <div class="vol">
        <span class="muted">Vol</span>
        <input id="vol" type="range" min="0" max="1" step="0.01" value="1" oninput="setVolume(this.value)" />
      </div>
      <audio id="audio" preload="none"></audio>
    </div>
  </div>
</div>

<!-- Pantalla completa del reproductor -->
<div id="fsBackdrop" class="fs-backdrop" onclick="closeFs()"></div>
<div id="fsPlayer" class="fs-player">
  <div class="fs-card" onclick="event.stopPropagation()">
    <button class="btn ghost fs-close" onclick="closeFs()">Cerrar ‚úï</button>
    <img id="fsCover" class="fs-cover" alt="cover">
    <div class="fs-titles">
      <div id="fsTitle" class="t">Nada reproduci√©ndose</div>
      <div id="fsAlbum" class="a">‚Äî</div>
    </div>
    <div class="fs-buttons">
      <button class="btn-ctl" onclick="prevTrack()">‚èÆ</button>
      <button class="btn-ctl main" onclick="togglePlay()" id="fsPlay">‚ñ∂</button>
      <button class="btn-ctl" onclick="nextTrack()">‚è≠</button>
    </div>
  </div>
</div>

<!-- Modal Login (simple) -->
<div id="loginModal" class="card" style="display:none;position:fixed;inset:0;margin:auto;max-width:420px;height:max-content;z-index:50">
  <div class="stack">
    <div class="section-title">Iniciar sesi√≥n (Admin)</div>
    <input id="email" type="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Contrase√±a" />
    <div class="row">
      <button class="btn" onclick="login()">Entrar</button>
      <button class="btn ghost" onclick="hideLogin()">Cancelar</button>
    </div>
    <small class="muted">Usa el mismo correo que definiste como admin en Supabase.</small>
  </div>
</div>

<script>
  /* ====== TUS DATOS DE SUPABASE ====== */
  const SUPABASE_URL  = "https://nqbldvpnqhngdtalvzov.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xYmxkdnBucWhuZ2R0YWx2em92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyMjY0NjUsImV4cCI6MjA3MDgwMjQ2NX0.Zzg5D219sW7bhvl0_R5ypX9MF6nRzBSDIeo2Lvebab0";
  const ADMIN_EMAIL = "klmzr@gmail.com";
  /* =================================== */

  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Estado
  let isAdmin = false;
  let albums = [];            // [{id,title,cover_url}]
  let songsByAlbum = {};      // albumId -> [{id,title,song_url}]
  let flatSongs = [];         // [{...albumTitle}]
  let queue = [];             // lista actual
  let qIndex = -1;

  // UI refs
  const albumsGrid = document.getElementById("albumsGrid");
  const albumFilter = document.getElementById("albumFilter");
  const searchInput = document.getElementById("search");
  const searchResults = document.getElementById("searchResults");
  const songsList = document.getElementById("songsList");

  const npCover = document.getElementById("npCover");
  const npTitle = document.getElementById("npTitle");
  const npAlbum = document.getElementById("npAlbum");
  const playBtn  = document.getElementById("playBtn");
  const audioEl  = document.getElementById("audio");
  const seekEl   = document.getElementById("seek");
  const curTime  = document.getElementById("curTime");
  const durTime  = document.getElementById("durTime");

  // FS UI
  const fsBackdrop = document.getElementById("fsBackdrop");
  const fsPlayer   = document.getElementById("fsPlayer");
  const fsCover    = document.getElementById("fsCover");
  const fsTitle    = document.getElementById("fsTitle");
  const fsAlbum    = document.getElementById("fsAlbum");
  const fsPlay     = document.getElementById("fsPlay");

  function openFs(){ fsBackdrop.style.display="block"; fsPlayer.style.display="grid"; }
  function closeFs(){ fsBackdrop.style.display="none"; fsPlayer.style.display="none"; }

  // Login modal
  function showLogin(){ document.getElementById("loginModal").style.display="block"; }
  function hideLogin(){ document.getElementById("loginModal").style.display="none"; }
  async function login(){
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;
    const { error } = await sb.auth.signInWithPassword({ email, password });
    if (error) { alert("Error: " + error.message); return; }
    isAdmin = (email.toLowerCase() === ADMIN_EMAIL.toLowerCase());
    document.getElementById("btn-logout").style.display = "inline-flex";
    if(isAdmin){
      document.getElementById("adminPanel").style.display = "block";
      document.getElementById("adminTag").style.display = "inline-block";
    }
    hideLogin();
    await refreshCatalog();
  }
  async function logout(){
    await sb.auth.signOut();
    isAdmin = false;
    document.getElementById("adminPanel").style.display = "none";
    document.getElementById("adminTag").style.display = "none";
    document.getElementById("btn-logout").style.display = "none";
  }

  // Restaurar sesi√≥n + cargar cat√°logo
  (async () => {
    const { data } = await sb.auth.getSession();
    if (data?.session?.user?.email) {
      const email = data.session.user.email;
      isAdmin = (email.toLowerCase() === ADMIN_EMAIL.toLowerCase());
      document.getElementById("btn-logout").style.display = "inline-flex";
      if(isAdmin){
        document.getElementById("adminPanel").style.display = "block";
        document.getElementById("adminTag").style.display = "inline-block";
      }
    }
    await refreshCatalog();
  })();

  // Helpers
  function safeName(name){ return name.replace(/[^a-zA-Z0-9_\-.]+/g,"-"); }
  function fmt(t){ if(!isFinite(t)) return "0:00"; const m=Math.floor(t/60), s=Math.floor(t%60); return `${m}:${s.toString().padStart(2,"0")}`; }
  function pathFromPublicUrl(url,bucket){
    const key = `/storage/v1/object/public/${bucket}/`;
    const i = url.indexOf(key);
    return i>=0 ? url.slice(i+key.length) : null;
  }

  // Cat√°logo
  async function refreshCatalog(){
    const { data: alb, error: e1 } = await sb.from("albums").select("*").order("created_at",{ascending:false});
    if (e1){ console.error(e1); return; }
    albums = alb || [];

    // Selectores
    const adminSel = document.getElementById("albumSelect");
    if (adminSel) adminSel.innerHTML = "";
    albumFilter.innerHTML = '<option value="">Filtrar por √°lbum</option>';
    for (const a of albums){
      if (adminSel){
        const o = document.createElement("option");
        o.value = a.id; o.textContent = a.title;
        adminSel.appendChild(o);
      }
      const of = document.createElement("option");
      of.value = a.id; of.textContent = a.title;
      albumFilter.appendChild(of);
    }

    // Canciones por √°lbum
    songsByAlbum = {};
    flatSongs = [];
    for (const a of albums){
      const { data: ss, error: e2 } = await sb.from("songs").select("*").eq("album_id", a.id).order("created_at",{ascending:true});
      if (e2){ console.error(e2); continue; }
      songsByAlbum[a.id] = ss || [];
      for (const s of (ss||[])){
        flatSongs.push({...s, album_title: a.title, cover_url: a.cover_url});
      }
    }

    renderAlbums();
  }

  function renderAlbums(list = albums){
    albumsGrid.innerHTML = "";
    list.forEach(a => {
      const count = (songsByAlbum[a.id]?.length||0);
      const card = document.createElement("div");
      card.className = "album-card" + (isAdmin ? " admin" : "");
      card.innerHTML = `
        ${isAdmin ? `<button class="chip-del" onclick="event.stopPropagation(); confirmDeleteAlbum('${a.id}')">Borrar</button>` : ``}
        <img class="album-cover" src="${a.cover_url}" alt="${a.title}">
        <div class="album-title">${a.title}</div>
        <div class="album-meta">${count} ${count===1?'canci√≥n':'canciones'}</div>
      `;
      card.onclick = () => openAlbum(a);
      albumsGrid.appendChild(card);
    });
  }

  function openAlbum(album){
    const songs = songsByAlbum[album.id] || [];
    queue = songs.map(s => ({ ...s, album_title: album.title, cover_url: album.cover_url }));
    qIndex = -1;
    songsList.innerHTML = "";
    if (!songs.length){
      songsList.innerHTML = `<div class="muted">Este √°lbum no tiene canciones todav√≠a.</div>`;
    } else {
      songs.forEach((s,idx) => {
        const row = document.createElement("div");
        row.className = "song-row";
        row.innerHTML = `
          <div class="play">‚ñ∂</div>
          <div class="song-title">${s.title}</div>
          <div class="muted" style="margin-left:auto">${album.title}</div>
          ${isAdmin ? `<button class="btn ghost" style="margin-left:8px" onclick="event.stopPropagation(); confirmDeleteSong('${s.id}','${s.song_url}','${album.id}')">Borrar</button>`:``}
        `;
        row.onclick = () => startQueueAt(idx);
        songsList.appendChild(row);
      });
    }
    searchResults.style.display = "block";
    searchResults.scrollIntoView({behavior:"smooth",block:"start"});
  }

  // B√∫squeda + filtro
  function applyFilters(){
    const term = searchInput.value.trim().toLowerCase();
    const filterAlbumId = albumFilter.value;

    let filteredAlbums = albums;
    if (filterAlbumId){
      filteredAlbums = albums.filter(a => a.id === filterAlbumId);
    }
    if (term){
      filteredAlbums = filteredAlbums.filter(a => a.title.toLowerCase().includes(term));
    }
    renderAlbums(filteredAlbums);

    const songs = flatSongs.filter(s => {
      const okAlbum = filterAlbumId ? s.album_id === filterAlbumId : true;
      const okTerm = term ? (s.title.toLowerCase().includes(term) || s.album_title.toLowerCase().includes(term)) : false;
      return okAlbum && okTerm;
    });
    songsList.innerHTML = "";
    if (songs.length){
      searchResults.style.display = "block";
      songs.forEach((s,idx)=>{
        const row = document.createElement("div");
        row.className = "song-row";
        row.innerHTML = `
          <div class="play">‚ñ∂</div>
          <div class="song-title">${s.title}</div>
          <div class="muted" style="margin-left:auto">${s.album_title}</div>
          ${isAdmin ? `<button class="btn ghost" style="margin-left:8px" onclick="event.stopPropagation(); confirmDeleteSong('${s.id}','${s.song_url}','${s.album_id}')">Borrar</button>`:``}
        `;
        row.onclick = () => startQueueFromList(songs, idx);
        songsList.appendChild(row);
      });
    } else {
      if (term){ searchResults.style.display = "block"; songsList.innerHTML = `<div class="muted">Sin resultados.</div>`; }
      else { searchResults.style.display = "none"; }
    }
  }

  // Reproductor
  function startQueueFromList(list, idx){ queue = list; qIndex = -1; startQueueAt(idx); }
  function startQueueAt(idx){ if (!queue.length) return; qIndex = idx; playTrack(queue[qIndex]); }
  function playTrack(song){
    audioEl.src = song.song_url;
    audioEl.play().catch(()=>{});
    npTitle.textContent = song.title;
    npAlbum.textContent = song.album_title || "‚Äî";
    npCover.src = song.cover_url || "";
    fsCover.src = song.cover_url || "";
    fsTitle.textContent = song.title;
    fsAlbum.textContent = song.album_title || "‚Äî";
    playBtn.textContent = "‚è∏";
    fsPlay.textContent = "‚è∏";
  }
  function togglePlay(){
    if (audioEl.paused){ audioEl.play(); playBtn.textContent="‚è∏"; fsPlay.textContent="‚è∏"; }
    else { audioEl.pause(); playBtn.textContent="‚ñ∂"; fsPlay.textContent="‚ñ∂"; }
  }
  function nextTrack(){ if (!queue.length) return; qIndex = (qIndex + 1) % queue.length; playTrack(queue[qIndex]); }
  function prevTrack(){ if (!queue.length) return; qIndex = (qIndex - 1 + queue.length) % queue.length; playTrack(queue[qIndex]); }
  function setVolume(v){ audioEl.volume = v; }
  function seekAudio(percent){ if (!audioEl.duration || isNaN(audioEl.duration)) return; audioEl.currentTime = (percent/100) * audioEl.duration; }
  audioEl.addEventListener("timeupdate",()=>{ if (!audioEl.duration) return; seekEl.value = (audioEl.currentTime / audioEl.duration) * 100; curTime.textContent = fmt(audioEl.currentTime); durTime.textContent = fmt(audioEl.duration); });
  audioEl.addEventListener("ended",()=> nextTrack());

  // Subidas (Admin)
  async function uploadAlbum(){
    if (!isAdmin) return alert("No autorizado");
    const title = document.getElementById("albumTitle").value.trim();
    const file  = document.getElementById("albumCover").files[0];
    if (!title || !file) return alert("Completa t√≠tulo y portada");
    const path = `${Date.now()}-${safeName(file.name)}`;
    const { error: upErr } = await sb.storage.from("covers").upload(path, file);
    if (upErr) return alert("Error subiendo portada: " + upErr.message);
    const { data: pub } = sb.storage.from("covers").getPublicUrl(path);
    const cover_url = pub.publicUrl;
    const { error: insErr } = await sb.from("albums").insert([{ title, cover_url }]);
    if (insErr) return alert("Error guardando √°lbum: " + insErr.message);
    document.getElementById("albumTitle").value = "";
    document.getElementById("albumCover").value = "";
    alert("√Ålbum creado");
    await refreshCatalog();
  }

  async function uploadSong(){
    if (!isAdmin) return alert("No autorizado");
    const albumId = document.getElementById("albumSelect").value;
    const titleInput = document.getElementById("songTitle").value.trim();
    const files = document.getElementById("songFiles").files;
    if (!albumId || files.length === 0) return alert("Selecciona un √°lbum y al menos un archivo de audio");

    let ok = 0, fail = 0;
    for (const file of files) {
      const path = `${Date.now()}-${safeName(file.name)}`;
      const { error: upErr } = await sb.storage.from("songs").upload(path, file);
      if (upErr) { console.error(upErr); fail++; continue; }

      const { data: pub } = await sb.storage.from("songs").getPublicUrl(path);
      const song_url = pub.publicUrl;
      const title = (files.length === 1 && titleInput) ? titleInput : file.name;

      const { error: insErr } = await sb.from("songs").insert([{ album_id: albumId, title, song_url }]);
      if (insErr) { console.error(insErr); fail++; } else { ok++; }
    }

    document.getElementById("songTitle").value = "";
    document.getElementById("songFiles").value = "";
    alert(`Subida completa: ${ok} ok, ${fail} error(es)`);
    await refreshCatalog();
  }

  // Borrado (Admin)
  function confirmDeleteAlbum(id){ if (confirm("¬øBorrar este √°lbum y todas sus canciones?")) deleteAlbum(id); }
  async function deleteAlbum(albumId){
    if (!isAdmin) return alert("No autorizado");
    // borrar canciones (db + storage)
    const songs = songsByAlbum[albumId] || [];
    for (const s of songs){
      const path = pathFromPublicUrl(s.song_url,"songs");
      if (path) await sb.storage.from("songs").remove([path]);
      await sb.from("songs").delete().eq("id", s.id);
    }
    // borrar portada
    const alb = albums.find(a=>a.id===albumId);
    if (alb?.cover_url){
      const cpath = pathFromPublicUrl(alb.cover_url,"covers");
      if (cpath) await sb.storage.from("covers").remove([cpath]);
    }
    // borrar √°lbum
    await sb.from("albums").delete().eq("id", albumId);
    await refreshCatalog();
  }
  function confirmDeleteSong(songId, songUrl, albumId){ if (confirm("¬øBorrar esta canci√≥n?")) deleteSong(songId, songUrl, albumId); }
  async function deleteSong(songId, songUrl, albumId){
    if (!isAdmin) return alert("No autorizado");
    const path = pathFromPublicUrl(songUrl,"songs");
    if (path) await sb.storage.from("songs").remove([path]);
    await sb.from("songs").delete().eq("id", songId);
    await refreshCatalog();
    // si estamos visualizando el √°lbum, refrescar su lista r√°pidamente
    const album = albums.find(a=>a.id===albumId);
    if (album) openAlbum(album);
  }

  // Exponer funciones
  window.showLogin = showLogin;
  window.hideLogin = hideLogin;
  window.login = login;
  window.logout = logout;
  window.uploadAlbum = uploadAlbum;
  window.uploadSong = uploadSong;
  window.applyFilters = applyFilters;
  window.openAlbum = openAlbum;
  window.togglePlay = togglePlay;
  window.nextTrack = nextTrack;
  window.prevTrack = prevTrack;
  window.seekAudio = seekAudio;
  window.setVolume = setVolume;
  window.openFs = openFs;
  window.closeFs = closeFs;
</script>
</body>
</html>
