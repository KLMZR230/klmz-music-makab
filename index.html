<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>KLMZ MUSIC</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #121212;
    color: white;
  }
  header {
    background: #1db954;
    padding: 10px;
    font-size: 1.5rem;
    font-weight: bold;
    text-align: center;
  }
  .album-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 1rem;
    padding: 1rem;
  }
  .album {
    background: #181818;
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    transition: transform 0.3s ease;
  }
  .album:hover {
    transform: scale(1.05);
  }
  .album img {
    width: 100%;
    height: 150px;
    object-fit: cover;
  }
  .album-title {
    padding: 0.5rem;
    text-align: center;
    font-weight: bold;
  }
  .song-list {
    margin-top: 0.5rem;
    background: #101010;
    border-radius: 6px;
    overflow: hidden;
    max-height: 0;
    opacity: 0;
    transition: max-height 0.4s ease, opacity 0.4s ease;
  }
  .song-list.show {
    padding: 0.5rem;
    max-height: 500px;
    opacity: 1;
  }
  .song-item {
    padding: 0.3rem 0;
    cursor: pointer;
  }
  .song-item:hover {
    color: #1db954;
  }
  #player {
    display: none;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: #282828;
    padding: 1rem;
  }
</style>
</head>
<body>

<header>♫ KLMZ MUSIC</header>

<div id="album-container" class="album-grid"></div>

<div id="player">
  <audio id="audioPlayer" controls style="width:100%"></audio>
</div>

<script>
const supabaseUrl = "https://nqbldvpnqhngdtalvzov.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xYmxkdnBucWhuZ2R0YWx2em92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyMjY0NjUsImV4cCI6MjA3MDgwMjQ2NX0.Zzg5D219sW7bhvl0_R5ypX9MF6nRzBSDIeo2Lvebab0";
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

async function loadAlbums() {
  const { data: albums, error } = await supabaseClient.from('albums').select('*');
  if (error) return console.error(error);
  const container = document.getElementById('album-container');
  container.innerHTML = '';
  albums.forEach(album => {
    const div = document.createElement('div');
    div.className = 'album';
    div.innerHTML = `
      <img src="${album.cover_url}" alt="${album.title}">
      <div class="album-title">${album.title}</div>
      <div class="song-list" id="songs-${album.id}"></div>
    `;
    div.addEventListener('click', () => toggleSongs(album.id));
    container.appendChild(div);
  });
}

async function toggleSongs(albumId) {
  document.querySelectorAll('.song-list').forEach(div => {
    if (div.id !== `songs-${albumId}`) {
      div.classList.remove('show');
      div.innerHTML = '';
    }
  });

  const songsDiv = document.getElementById(`songs-${albumId}`);
  if (songsDiv.classList.contains('show')) {
    songsDiv.classList.remove('show');
    songsDiv.innerHTML = '';
    return;
  }

  const { data: songs } = await supabaseClient.from('songs').select('*').eq('album_id', albumId);
  songsDiv.innerHTML = '';
  songs.forEach(song => {
    const item = document.createElement('div');
    item.className = 'song-item';
    item.textContent = song.title;
    item.addEventListener('click', (e) => {
      e.stopPropagation();
      playSong(song.file_url);
    });
    songsDiv.appendChild(item);
  });

  songsDiv.classList.add('show');
}

function playSong(url) {
  const player = document.getElementById('player');
  const audio = document.getElementById('audioPlayer');
  audio.src = url;
  audio.play();
  player.style.display = 'block';
}

async function uploadSong(albumId, file) {
  const filePath = `${albumId}/${Date.now()}_${file.name}`;
  const { error: uploadError } = await supabaseClient.storage
    .from('songs')
    .upload(filePath, file, { cacheControl: '3600', upsert: false });

  if (uploadError) {
    console.error('Error subiendo canción:', uploadError.message);
    alert('Error subiendo canción');
    return;
  }

  const { data } = supabaseClient.storage.from('songs').getPublicUrl(filePath);
  const publicUrl = data.publicUrl;

  const { error: insertError } = await supabaseClient.from('songs').insert([
    {
      album_id: albumId,
      title: file.name,
      file_url: publicUrl
    }
  ]);

  if (insertError) {
    console.error('Error guardando canción en DB:', insertError.message);
    alert('Error guardando canción');
  } else {
    alert('Canción subida con éxito');
    loadAlbums();
  }
}

loadAlbums();
</script>

</body>
</html>
