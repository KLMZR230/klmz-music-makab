<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KLMZ MUSIC</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-900 text-white flex flex-col min-h-screen">

  <!-- Header -->
  <header class="bg-black p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold">‚ô´ KLMZ MUSIC</h1>
    <button id="adminBtn" class="text-sm bg-gray-800 px-2 py-1 rounded hidden">üîë</button>
  </header>

  <!-- Login admin -->
  <div id="loginContainer" class="hidden flex flex-col items-center justify-center flex-1">
    <h2 class="text-2xl mb-4">Iniciar sesi√≥n</h2>
    <input id="email" type="email" placeholder="Correo" class="mb-2 p-2 text-black rounded">
    <input id="password" type="password" placeholder="Contrase√±a" class="mb-2 p-2 text-black rounded">
    <button id="loginBtn" class="bg-green-500 px-4 py-2 rounded">Entrar</button>
  </div>

  <!-- Contenido principal -->
  <main id="mainContent" class="flex-1 p-4 hidden">
    <!-- Subida admin -->
    <div id="adminPanel" class="hidden mb-6">
      <h2 class="text-lg font-bold mb-2">Subir √Ålbum</h2>
      <input id="albumTitle" type="text" placeholder="Nombre del √°lbum" class="mb-2 p-2 text-black rounded">
      <input id="albumCover" type="file" accept="image/*" class="mb-2">
      <button id="uploadAlbumBtn" class="bg-blue-500 px-4 py-2 rounded mb-4">Subir √Ålbum</button>

      <h2 class="text-lg font-bold mb-2">Subir Canciones</h2>
      <select id="albumSelect" class="mb-2 p-2 text-black rounded"></select>
      <input id="songFiles" type="file" accept="audio/*" multiple class="mb-2">
      <button id="uploadSongsBtn" class="bg-blue-500 px-4 py-2 rounded">Subir Canciones</button>
    </div>

    <!-- √Ålbumes -->
    <div id="albumsContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
  </main>

  <!-- Reproductor -->
  <div id="playerContainer" class="fixed bottom-0 left-0 right-0 bg-black p-4 hidden">
    <p id="playerTitle" class="mb-2">Nada reproduci√©ndose</p>
    <audio id="audioPlayer" controls class="w-full"></audio>
  </div>

  <script>
    const supabaseUrl = "https://nqbldvpnqhngdtalvzov.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xYmxkdnBucWhuZ2R0YWx2em92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyMjY0NjUsImV4cCI6MjA3MDgwMjQ2NX0.Zzg5D219sW7bhvl0_R5ypX9MF6nRzBSDIeo2Lvebab0";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    const adminEmail = "klmzr@gmail.com";
    const adminPassword = "1234"; // contrase√±a admin

    const adminBtn = document.getElementById("adminBtn");
    const loginContainer = document.getElementById("loginContainer");
    const loginBtn = document.getElementById("loginBtn");
    const mainContent = document.getElementById("mainContent");
    const adminPanel = document.getElementById("adminPanel");
    const albumsContainer = document.getElementById("albumsContainer");
    const albumSelect = document.getElementById("albumSelect");

    const uploadAlbumBtn = document.getElementById("uploadAlbumBtn");
    const uploadSongsBtn = document.getElementById("uploadSongsBtn");

    const playerContainer = document.getElementById("playerContainer");
    const playerTitle = document.getElementById("playerTitle");
    const audioPlayer = document.getElementById("audioPlayer");

    let isAdmin = false;

    // Mostrar bot√≥n admin solo al due√±o
    adminBtn.classList.remove("hidden");
    adminBtn.addEventListener("click", () => {
      loginContainer.classList.remove("hidden");
      mainContent.classList.add("hidden");
    });

    // Login admin
    loginBtn.addEventListener("click", () => {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;

      if (email === adminEmail && password === adminPassword) {
        isAdmin = true;
        loginContainer.classList.add("hidden");
        mainContent.classList.remove("hidden");
        adminPanel.classList.remove("hidden");
        loadAlbums();
      } else {
        alert("Acceso denegado");
      }
    });

    // Subir √°lbum
    uploadAlbumBtn.addEventListener("click", async () => {
      const title = document.getElementById("albumTitle").value;
      const cover = document.getElementById("albumCover").files[0];
      if (!title || !cover) return alert("Faltan datos");

      const { data: coverData, error: coverError } = await supabase.storage
        .from("covers")
        .upload(Date.now() + "_" + cover.name, cover);

      if (coverError) return alert("Error subiendo portada: " + coverError.message);

      const coverPath = coverData.path;

      await supabase.from("albums").insert([{ title, cover_url: coverPath }]);

      loadAlbums();
    });

    // Subir canciones
    uploadSongsBtn.addEventListener("click", async () => {
      const files = document.getElementById("songFiles").files;
      const albumId = albumSelect.value;
      if (!albumId || files.length === 0) return alert("Faltan datos");

      for (const file of files) {
        // limpiar caracteres raros
        const safeName = file.name.replace(/[^a-zA-Z0-9.\-_]/g, "_");
        const filePath = Date.now() + "_" + safeName;

        const { data: songData, error: songError } = await supabase.storage
          .from("songs")
          .upload(filePath, file);

        if (songError) {
          console.error(songError);
          alert("Error subiendo canci√≥n: " + songError.message);
          continue;
        }

        await supabase.from("songs").insert([
          { album_id: albumId, title: file.name, song_url: songData.path }
        ]);
      }

      loadAlbums();
    });

    // Cargar √°lbumes
    async function loadAlbums() {
      albumsContainer.innerHTML = "";

      const { data: albums } = await supabase.from("albums").select("*");
      const { data: songs } = await supabase.from("songs").select("*");

      if (isAdmin) {
        albumSelect.innerHTML = "";
        albums.forEach(a => {
          albumSelect.innerHTML += `<option value="${a.id}">${a.title}</option>`;
        });
      }

      albums.forEach(album => {
        const albumDiv = document.createElement("div");
        albumDiv.className = "bg-gray-800 p-2 rounded cursor-pointer";

        const coverUrl = supabase.storage.from("covers").getPublicUrl(album.cover_url).data.publicUrl;

        albumDiv.innerHTML = `
          <img src="${coverUrl}" class="w-full h-32 object-cover rounded mb-2">
          <h3 class="text-sm font-bold">${album.title}</h3>
          <ul id="songs-${album.id}" class="mt-2 space-y-1"></ul>
        `;

        albumsContainer.appendChild(albumDiv);

        const songList = document.getElementById(`songs-${album.id}`);
        songs.filter(s => s.album_id === album.id).forEach(song => {
          const li = document.createElement("li");
          li.className = "text-xs text-gray-300 hover:text-white cursor-pointer";
          li.textContent = song.title;
          li.addEventListener("click", () => playSong(song));
          songList.appendChild(li);
        });
      });
    }

    // Reproducir canci√≥n
    async function playSong(song) {
      let filePath = song.song_url;

      // si guardaste la URL completa, la recortamos
      if (filePath.includes("/storage/v1/object/public/")) {
        filePath = filePath.split("/storage/v1/object/public/")[1];
      }

      const { data, error } = await supabase.storage
        .from("songs")
        .createSignedUrl(filePath, 3600);

      if (error) {
        console.error("Error obteniendo URL:", error.message);
        return;
      }

      audioPlayer.src = data.signedUrl;
      audioPlayer.play();
      playerTitle.textContent = song.title;
      playerContainer.classList.remove("hidden");
    }

    // cargar siempre √°lbumes para p√∫blico
    mainContent.classList.remove("hidden");
    loadAlbums();
  </script>
</body>
</html>
