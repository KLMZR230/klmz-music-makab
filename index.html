<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KLMZ Music</title>

  <!-- ===== CSS (incrustado para mantener todo junto y ordenado) ===== -->
  <style>
    :root {
      --bg: #121212;
      --panel: #181818;
      --text: #fff;
      --muted: #bbb;
      --brand: #1DB954;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    header {
      display: flex; align-items: center; justify-content: space-between;
      gap: 1rem; padding: .8rem 1rem; background: var(--panel);
      position: sticky; top: 0; z-index: 10;
    }
    header h1 { margin: 0; font-size: 1.1rem; }
    .theme-selector select { background: #222; color: #fff; border: 1px solid #333; padding: .3rem .5rem; border-radius: 6px; }
    .user-menu { position: relative; display: flex; align-items: center; gap: .6rem; cursor: pointer; }
    #user-info-section { display: none; }
    #user-dropdown { position: absolute; right: 0; top: 120%; background: #222; border: 1px solid #333; border-radius: 8px; display: none; min-width: 180px; }
    #user-dropdown.show { display: block; }
    #user-dropdown > div { padding: .6rem .8rem; cursor: pointer; border-bottom: 1px solid #333; }
    #user-dropdown > div:last-child { border-bottom: none; }
    #user-dropdown > div:hover { background: #2a2a2a; }

    .content-section { display: none; padding: 1rem; }
    .content-section.active { display: block; }

    .album-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; }
    .album-card { background: var(--panel); padding: 1rem; border-radius: 10px; cursor: pointer; text-align: center; transition: transform .1s; }
    .album-card:hover { transform: translateY(-2px); }
    .album-img { width: 100%; height: 150px; object-fit: cover; border-radius: 8px; }
    .album-title { font-weight: 700; margin-top: .5rem; }
    .album-artist { font-size: .9rem; color: var(--muted); }

    #search-input { width: 100%; padding: .7rem; border-radius: 8px; border: 1px solid #333; background: #1b1b1b; color: #fff; margin-bottom: 1rem; }
    .search-song-item { display: flex; align-items: center; justify-content: space-between; background: var(--panel); padding: .7rem .9rem; border-radius: 8px; margin-bottom: .5rem; }
    .search-song-title { font-weight: 600; }
    .search-song-artist { color: var(--muted); font-size: .9rem; }

    .favorite-item, .download-item { display: flex; align-items: center; justify-content: space-between; background: var(--panel); padding: .8rem 1rem; border-radius: 10px; margin-bottom: .6rem; }
    .favorite-title, .download-title { font-weight: 600; }
    .favorite-artist, .download-artist { color: var(--muted); font-size: .9rem; }
    .song-actions { display: flex; gap: .8rem; align-items: center; }
    .download-icon.downloaded { opacity: .6; }

    #mini-player { position: fixed; bottom: 60px; left: 0; right: 0; background: #282828; display: none; align-items: center; padding: .6rem .8rem; gap: .6rem; cursor: pointer; }
    #mini-player img { width: 40px; height: 40px; border-radius: 6px; }
    .player-controls-inline button { background: #333; color: #fff; border: none; padding: .3rem .6rem; border-radius: 6px; cursor: pointer; }

    #full-player { position: fixed; inset: 0; background: rgba(0,0,0,.92); display: none; flex-direction: column; align-items: center; gap: .6rem; padding: 1rem; }
    #full-player.active { display: flex; }
    #full-player img { width: 240px; height: 240px; object-fit: cover; border-radius: 12px; }
    #full-progress-container { width: 90%; height: 6px; background: #333; border-radius: 4px; cursor: pointer; }
    #full-progress-fill { height: 100%; width: 0%; background: var(--brand); border-radius: 4px; }

    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--panel); display: flex; justify-content: space-around; padding: .5rem; border-top: 1px solid #222; }
    .bottom-nav-item { flex: 1; text-align: center; padding: .5rem; cursor: pointer; }
    .bottom-nav-item.active { color: var(--brand); }

    .modal { position: fixed; inset: 0; background: rgba(0,0,0,.6); display: none; align-items: center; justify-content: center; padding: 1rem; z-index: 50; }
    .modal-content { background: #1d1d1d; border: 1px solid #333; padding: 1rem; border-radius: 12px; max-width: 420px; width: 100%; }
    .btn-primary { background: var(--brand); color: #000; border: none; padding: .6rem .9rem; border-radius: 8px; cursor: pointer; }
    .btn-secondary { background: #2a2a2a; color: #fff; border: none; padding: .6rem .9rem; border-radius: 8px; cursor: pointer; }
    .btn-danger { background: #d33; color: #fff; border: none; padding: .6rem .9rem; border-radius: 8px; cursor: pointer; }

    /* temas r√°pidos */
    body.theme-neon { background: linear-gradient(135deg,#ff00cc,#3333ff); }
    body.theme-minimal { background: #fff; color: #000; }
    body.theme-sunset { background: linear-gradient(135deg,#ff9966,#ff5e62); }
    body.theme-pastel { background: linear-gradient(135deg,#a1c4fd,#c2e9fb); color:#000; }
    body.theme-luxury { background: linear-gradient(135deg,#434343,#000); }
    body.theme-oceanic { background: linear-gradient(135deg,#2193b0,#6dd5ed); }
  </style>

  <!-- ===== CDNs ===== -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
</head>
<body>
  <!-- ===== Header ===== -->
  <header>
    <h1>üéµ KLMZ Music</h1>

    <div class="theme-selector">
      <select onchange="changeTheme(this.value)">
        <option value="default">Tema: Default</option>
        <option value="neon">Ne√≥n</option>
        <option value="minimal">Minimal</option>
        <option value="sunset">Sunset</option>
        <option value="pastel">Pastel</option>
        <option value="luxury">Luxury</option>
        <option value="oceanic">Oceanic</option>
      </select>
    </div>

    <div class="user-menu" onclick="toggleUserMenu()">
      <span id="header-lock-icon">üîí</span>
      <div id="user-info-section"><span id="user-email-display"></span></div>
      <div id="user-dropdown">
        <div id="login-menu-item" onclick="showAuth('login')">Login</div>
        <div id="register-menu-item" onclick="showAuth('register')">Registro</div>
        <div id="admin-menu-item" style="display:none" onclick="showSection('admin')">Panel Admin</div>
        <div id="logout-menu-item" style="display:none" onclick="confirmLogout()">Cerrar sesi√≥n</div>
      </div>
    </div>
  </header>

  <!-- ===== Secciones ===== -->
  <main>
    <!-- Home -->
    <section id="home-section" class="content-section active">
      <div id="albums" class="album-grid"></div>
      <div id="album-detail" style="display:none"></div>
    </section>

    <!-- Buscar -->
    <section id="search-section" class="content-section">
      <input id="search-input" placeholder="Buscar √°lbumes o canciones..." oninput="searchMusic()" />
      <div id="search-results"></div>
    </section>

    <!-- Descargas -->
    <section id="downloads-section" class="content-section">
      <h3>‚¨áÔ∏è Descargas</h3>
      <div id="downloads-content">Cargando...</div>
    </section>

    <!-- Favoritos -->
    <section id="favorites-section" class="content-section">
      <h3>‚ù§Ô∏è Favoritos</h3>
      <div id="favorites-content">Cargando...</div>
    </section>

    <!-- Admin -->
    <section id="admin-section" class="content-section">
      <h3>‚öôÔ∏è Administraci√≥n</h3>
      <div id="admin-content">Cargando...</div>
    </section>
  </main>

  <!-- Mini Player -->
  <div id="mini-player">
    <img id="mini-player-img" src="" alt="" />
    <div style="flex:1">
      <div id="mini-player-title" style="font-weight:600"></div>
      <div id="mini-player-artist" style="color:#b3b3b3; font-size:.9rem;"></div>
    </div>
    <div class="player-controls-inline">
      <button onclick="previousSong()">‚èÆ</button>
      <button id="mini-play-btn" onclick="togglePlay()">‚ñ∂</button>
      <button onclick="nextSong()">‚è≠</button>
    </div>
  </div>

  <!-- Full Player -->
  <div id="full-player">
    <button class="btn-secondary" onclick="closeFullPlayer()" style="align-self:flex-end">Cerrar ‚úï</button>
    <img id="full-player-cover" src="" alt="" />
    <div style="text-align:center">
      <div id="full-player-title" style="font-size:1.3rem; font-weight:700">‚Äî</div>
      <div id="full-player-artist" style="color:#b3b3b3">‚Äî</div>
    </div>

    <div id="full-progress-container" onclick="seekToFull(event)">
      <div id="full-progress-fill"></div>
    </div>
    <div style="display:flex; justify-content:space-between; width:90%; font-size:.9rem; color:#b3b3b3;">
      <span id="full-current-time">0:00</span>
      <span id="full-total-time">0:00</span>
    </div>

    <div style="display:flex; gap:.6rem; align-items:center;">
      <button id="shuffle-btn" class="btn-secondary" onclick="toggleShuffleMode()">üîÄ</button>
      <button class="btn-secondary" onclick="previousSong()">‚èÆ</button>
      <button id="full-play-btn" class="btn-primary" onclick="togglePlay()">‚ñ∂</button>
      <button class="btn-secondary" onclick="nextSong()">‚è≠</button>
      <button id="repeat-btn" class="btn-secondary" onclick="toggleRepeatMode()">üîÅ</button>
    </div>

    <div style="margin-top:.6rem;">
      Volumen: <input id="full-volume" type="range" min="0" max="100" value="80" oninput="setVolume(this.value)" />
    </div>
  </div>

  <!-- Bottom Nav -->
  <nav class="bottom-nav">
    <div id="nav-home" class="bottom-nav-item active" onclick="showSection('home')">üè† Home</div>
    <div id="nav-search" class="bottom-nav-item" onclick="showSection('search')">üîé Buscar</div>
    <div id="nav-downloads" class="bottom-nav-item" onclick="showSection('downloads')">‚¨áÔ∏è Descargas</div>
    <div id="nav-favs" class="bottom-nav-item" onclick="showSection('favorites')">‚ù§Ô∏è Favoritos</div>
    <div id="nav-admin" class="bottom-nav-item" onclick="showSection('admin')">‚öôÔ∏è Admin</div>
  </nav>

  <!-- Audio -->
  <audio id="audio-player" preload="metadata"></audio>

  <!-- ===== JS PRINCIPAL (ordenado por secciones) ===== -->
  <script>
    // ============================================================
    // 0) Helpers de ordenamiento (orden alfab√©tico consistente)
    // ============================================================
    const cmp = (a, b) => (a||'').toString().localeCompare((b||'').toString(), 'es', { sensitivity: 'base' });
    const sortAlbums = (A) => [...A].sort((a,b) => cmp(a.artist,b.artist) || cmp(a.title,b.title));
    const sortSongsByTitle = (S) => [...S].sort((a,b) => cmp(a.title,b.title));
    const sortSongRecords = (S) => [...S].sort((a,b) =>
      cmp(a.albums?.artist, b.albums?.artist) ||
      cmp(a.albums?.title,  b.albums?.title)  ||
      cmp(a.title,          b.title)
    );

    // ============================================================
    // 1) Config y estado global
    // ============================================================
    const SUPABASE_URL = 'https://nqbldvpnqhngdtalvzov.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xYmxkdnBucWhuZ2R0YWx2em92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyMjY0NjUsImV4cCI6MjA3MDgwMjQ2NX0.Zzg5D219sW7bhvl0_R5ypX9MF6nRzBSDIeo2Lvebab0';
    const ADMIN_EMAIL = 'klmzr@gmail.com';

    const APPWRITE_ENDPOINT = 'https://nyc.cloud.appwrite.io/v1';
    const APPWRITE_PROJECT_ID = '68ab0cf2000365979a71';
    const APPWRITE_DATABASE_ID = '68ab0d9b00124af501a5';
    const APPWRITE_SONGS_COLLECTION_ID = '68ab0f0e002d9f334b0d';
    const APPWRITE_SONGS_BUCKET_ID = '68ab1101001cff947e6b';

    let supabase = null;
    let appwriteClient = null, appwriteDatabases = null, appwriteStorage = null;

    let allAlbums = [];
    let allSongs = [];
    let songsWithAlbumInfo = [];

    let currentUser = null;

    let currentSong = null, currentAlbum = null;
    let currentPlaylist = [], originalPlaylist = [];
    let currentIndex = 0, isPlaying = false;
    let repeatMode = 'off', shuffleMode = false;

    // IndexedDB
    let db;

    // ============================================================
    // 2) IndexedDB (descargas)
    // ============================================================
    function initDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open('KLMZMusicDB', 2);
        request.onerror = () => reject('Error al abrir IndexedDB');
        request.onsuccess = (e) => { db = e.target.result; resolve(db); };
        request.onupgradeneeded = (e) => {
          const _db = e.target.result;
          if (!_db.objectStoreNames.contains('songs')) _db.createObjectStore('songs', { keyPath: 'id' });
        };
      });
    }
    const saveSongToDB = (songData) => new Promise((res, rej) => {
      const tx = db.transaction(['songs'], 'readwrite');
      tx.objectStore('songs').put(songData).onsuccess = () => res();
      tx.onerror = (e) => rej('Error al guardar la canci√≥n: ' + e.target.error);
    });
    const getSongFromDB = (id) => new Promise((res, rej) => {
      const tx = db.transaction(['songs'], 'readonly');
      tx.objectStore('songs').get(id).onsuccess = (ev) => res(ev.target.result);
      tx.onerror = (e) => rej('Error al obtener la canci√≥n: ' + e.target.error);
    });
    const getAllDownloadedSongs = () => new Promise((res, rej) => {
      const tx = db.transaction(['songs'], 'readonly');
      tx.objectStore('songs').getAll().onsuccess = (ev) => res(ev.target.result);
      tx.onerror = (e) => rej('Error al obtener todas las canciones: ' + e.target.error);
    });

    // ============================================================
    // 3) Utilidades UI (modales, carga, temas)
    // ============================================================
    function showLoadingIndicator(show) {
      let el = document.getElementById('loading-indicator');
      if (!el) {
        el = document.createElement('div');
        el.id = 'loading-indicator';
        el.style.position = 'fixed';
        el.style.top = '10px';
        el.style.right = '10px';
        el.style.background = '#0008';
        el.style.padding = '.5rem 1rem';
        el.style.borderRadius = '8px';
        el.style.display = 'none';
        el.innerText = 'Cargando...';
        document.body.appendChild(el);
      }
      el.style.display = show ? 'block' : 'none';
    }
    function showInfoModal(message) {
      const existing = document.getElementById('info-modal-backdrop');
      if (existing) return;
      const back = document.createElement('div');
      back.id = 'info-modal-backdrop'; back.className = 'modal'; back.style.display = 'flex';
      back.innerHTML = `<div class="modal-content"><p style="margin-bottom:1.5rem; text-align:center; font-size:1.1rem;">${message}</p><button class="btn-primary" onclick="document.getElementById('info-modal-backdrop').remove()">OK</button></div>`;
      document.body.appendChild(back);
    }
    function showConfirmationModal(message, onConfirm) {
      const existing = document.getElementById('confirm-modal-backdrop');
      if (existing) return;
      const back = document.createElement('div');
      back.id = 'confirm-modal-backdrop'; back.className = 'modal'; back.style.display = 'flex';
      back.innerHTML = `<div class="modal-content"><p style="margin-bottom:1.5rem; text-align:center; font-size:1.1rem;">${message}</p><div style="display:flex; gap:1rem; justify-content:center;"><button class="btn-secondary" onclick="document.getElementById('confirm-modal-backdrop').remove()">Cancelar</button><button class="btn-danger" id="__confirmBtn">Confirmar</button></div></div>`;
      document.body.appendChild(back);
      document.getElementById('__confirmBtn').onclick = () => { try { onConfirm && onConfirm(); } finally { back.remove(); } };
    }
    function showErrorMessage(message) {
      const el = document.getElementById('albums');
      el.innerHTML = `
        <div style="text-align:center; padding:3rem;">
          <h2>${message}</h2>
          <p>Puedes acceder a tu m√∫sica descargada.</p>
          <button onclick="showSection('downloads')" class="btn-primary" style="margin-top:1rem;">Ir a Descargas</button>
        </div>`;
    }

    // Temas
    function changeTheme(theme) {
      const body = document.body;
      body.className = body.className.split(' ').filter(c => !c.startsWith('theme-')).join(' ');
      if (theme && theme !== 'default') body.classList.add('theme-' + theme);
      localStorage.setItem('klmz_theme', theme);
    }
    function loadSavedTheme() {
      const savedTheme = localStorage.getItem('klmz_theme') || 'default';
      document.querySelector('.theme-selector select').value = savedTheme;
      changeTheme(savedTheme);
    }

    // ============================================================
    // 4) Auth (Supabase)
    // ============================================================
    const isAdmin = () => currentUser && currentUser.email === ADMIN_EMAIL;
    function toggleUserMenu() {
      const dropdown = document.getElementById('user-dropdown');
      dropdown.classList.toggle('show');
      if (dropdown.classList.contains('show')) setTimeout(() => document.addEventListener('click', closeUserMenuOutside), 50);
    }
    function closeUserMenuOutside(e) {
      const userMenu = document.querySelector('.user-menu');
      if (userMenu && !userMenu.contains(e.target)) {
        document.getElementById('user-dropdown').classList.remove('show');
        document.removeEventListener('click', closeUserMenuOutside);
      }
    }
    function updateAuthUI() {
      const headerLockIcon = document.getElementById('header-lock-icon');
      const userInfo = document.getElementById('user-info-section');
      const userEmail = document.getElementById('user-email-display');
      const adminMenu = document.getElementById('admin-menu-item');
      const loginMenu = document.getElementById('login-menu-item');
      const registerMenu = document.getElementById('register-menu-item');
      const logoutMenu = document.getElementById('logout-menu-item');

      if (currentUser) {
        userInfo.style.display = 'block';
        userEmail.textContent = currentUser.email;
        loginMenu.style.display = 'none';
        registerMenu.style.display = 'none';
        logoutMenu.style.display = 'flex';
        if (isAdmin()) { headerLockIcon.innerHTML = '‚öôÔ∏è'; adminMenu.style.display = 'flex'; }
        else { headerLockIcon.innerHTML = 'üë§'; adminMenu.style.display = 'none'; }
      } else {
        headerLockIcon.innerHTML = 'üîí';
        userInfo.style.display = 'none';
        adminMenu.style.display = 'none';
        loginMenu.style.display = 'flex';
        registerMenu.style.display = 'flex';
        logoutMenu.style.display = 'none';
      }
    }
    function showAuth(type) {
      document.getElementById('user-dropdown')?.classList.remove('show');
      document.getElementById('auth-modal')?.remove();
      const modal = document.createElement('div');
      modal.id = 'auth-modal'; modal.className = 'modal'; modal.style.display = 'flex';
      modal.innerHTML = `
        <div class="modal-content">
          <div style="display:flex; gap:1rem; margin-bottom:1rem; justify-content:center;">
            <button class="btn-secondary" onclick="document.getElementById('login-form').style.display='block';document.getElementById('register-form').style.display='none';">Login</button>
            <button class="btn-secondary" onclick="document.getElementById('login-form').style.display='none';document.getElementById('register-form').style.display='block';">Registro</button>
          </div>
          <form id="login-form" style="display:${type==='login'?'block':'none'}" onsubmit="login(event)">
            <input id="login-email" type="email" placeholder="Email" required>
            <input id="login-password" type="password" placeholder="Contrase√±a" required>
            <button class="btn-primary" type="submit">Entrar</button>
          </form>
          <form id="register-form" style="display:${type==='register'?'block':'none'}" onsubmit="register(event)">
            <input id="register-email" type="email" placeholder="Email" required>
            <input id="register-password" type="password" placeholder="Contrase√±a" required>
            <input id="register-confirm" type="password" placeholder="Confirmar Contrase√±a" required>
            <button class="btn-primary" type="submit">Crear cuenta</button>
          </form>
          <button class="btn-secondary" style="margin-top:1rem" onclick="closeAuth()">Cerrar</button>
        </div>`;
      document.body.appendChild(modal);
    }
    function closeAuth(){ document.getElementById('auth-modal')?.remove(); }
    async function login(e){
      e.preventDefault();
      try {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) throw error;
        showInfoModal('¬°Bienvenido!'); closeAuth();
      } catch (err) { showInfoModal('Error de login: ' + err.message); }
    }
    async function register(e){
      e.preventDefault();
      try {
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;
        const confirm = document.getElementById('register-confirm').value;
        if (password !== confirm) return showInfoModal('Las contrase√±as no coinciden');
        const { error } = await supabase.auth.signUp({ email, password });
        if (error) throw error;
        showInfoModal('Registro exitoso. Revisa tu correo.'); closeAuth();
      } catch (err) { showInfoModal('Error de registro: ' + err.message); }
    }
    function confirmLogout(){ showConfirmationModal('¬øEst√°s seguro de que quieres cerrar sesi√≥n?', logout); }
    async function logout(){
      try { const { error } = await supabase.auth.signOut(); if (error) throw error; currentUser = null; updateAuthUI(); showInfoModal('Sesi√≥n cerrada correctamente'); }
      catch(e){ showInfoModal('Error cerrando sesi√≥n'); }
    }

    // ============================================================
    // 5) Favoritos (localStorage)
    // ============================================================
    const getLocalFavorites = () => JSON.parse(localStorage.getItem('klmz_favorites') || '[]');
    const saveLocalFavorites = (favs) => localStorage.setItem('klmz_favorites', JSON.stringify(favs));
    function toggleFavorite(songId, el) {
      let favorites = getLocalFavorites();
      const isFavorite = favorites.includes(songId);
      favorites = isFavorite ? favorites.filter(id => id !== songId) : [...favorites, songId];
      saveLocalFavorites(favorites);
      if (el) { el.style.color = isFavorite ? '#666' : '#1DB954'; el.innerHTML = isFavorite ? 'ü§ç' : '‚ù§Ô∏è'; }
      if (document.getElementById('favorites-section').classList.contains('active')) loadFavorites();
    }

    // ============================================================
    // 6) Navegaci√≥n + B√∫squeda (ordenadas)
    // ============================================================
    function showSection(section) {
      document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
      document.getElementById(`${section}-section`).classList.add('active');
      document.querySelectorAll('.bottom-nav-item').forEach(a => a.classList.remove('active'));
      const navIdMap = { home: 'home', search: 'search', downloads: 'downloads', favorites: 'favs', admin: 'admin' };
      const navItem = document.getElementById(`nav-${navIdMap[section]}`); if (navItem) navItem.classList.add('active');
      if (section === 'home') showAlbumsGrid();
      if (section === 'favorites') loadFavorites();
      if (section === 'downloads') loadDownloads();
      if (section === 'admin') {
        if (!isAdmin()) { showInfoModal('Acceso denegado. Solo para administradores.'); showSection('home'); return; }
        renderAdminPanel();
      }
    }
    function searchMusic() {
      const q = document.getElementById('search-input').value.toLowerCase().trim();
      const results = document.getElementById('search-results');
      if (!q) { results.innerHTML = ''; return; }
      const foundAlbums = sortAlbums(allAlbums.filter(a => a.title.toLowerCase().includes(q) || a.artist.toLowerCase().includes(q)));
      const foundSongs = sortSongRecords(songsWithAlbumInfo.filter(s =>
        s.title.toLowerCase().includes(q) || (s.albums && s.albums.artist.toLowerCase().includes(q))
      ));
      let html = '';
      if (foundAlbums.length) {
        html += '<h3>üìÄ √Ålbumes</h3><div class="album-grid">' + foundAlbums.map(album => `
          <div class="album-card" onclick='showAlbumDetail(${JSON.stringify(album).replace(/"/g, '&quot;')})'>
            <img class="album-img" src="${album.cover_url}">
            <div class="album-title">${album.title}</div>
            <div class="album-artist">${album.artist}</div>
          </div>`).join('') + '</div>';
      }
      if (foundSongs.length) {
        html += '<h3>üéµ Canciones</h3>' + foundSongs.map(song => `
          <div class="search-song-item" onclick="playSongFromSearch('${song.$id}')">
            <div class="search-song-info">
              <div class="search-song-title">${song.title}</div>
              <div class="search-song-artist">${song.albums?.artist || 'Desconocido'}</div>
            </div>
            <div>‚ñ∂</div>
          </div>`).join('');
      }
      results.innerHTML = (html || '<h3>No se encontraron resultados</h3>');
    }

    // ============================================================
    // 7) Carga de datos (ordenada)
    // ============================================================
    async function loadAllData() {
      // √Ålbumes
      const { data: albums, error: albumsError } = await supabase.from('albums').select('*');
      if (albumsError) throw albumsError;

      // Canciones
      const { documents: songs } = await appwriteDatabases.listDocuments(
        APPWRITE_DATABASE_ID,
        APPWRITE_SONGS_COLLECTION_ID,
        [Appwrite.Query.limit(200)]
      );

      allAlbums = sortAlbums(albums || []);
      allSongs = sortSongsByTitle(songs || []);
      songsWithAlbumInfo = sortSongRecords(
        allSongs.map(s => ({ ...s, albums: allAlbums.find(a => a.id === s.album_id) }))
      );

      displayAlbums(allAlbums);
    }
    async function loadData() {
      showLoadingIndicator(true);
      try {
        // Supabase
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Appwrite
        appwriteClient = new Appwrite.Client().setEndpoint(APPWRITE_ENDPOINT).setProject(APPWRITE_PROJECT_ID);
        appwriteDatabases = new Appwrite.Databases(appwriteClient);
        appwriteStorage = new Appwrite.Storage(appwriteClient);

        // Auth
        supabase.auth.onAuthStateChange((_event, session) => { currentUser = session?.user || null; updateAuthUI(); });
        const { data: { session } } = await supabase.auth.getSession();
        currentUser = session?.user || null; updateAuthUI();

        await loadAllData();
      } catch (e) {
        console.error(e);
        showErrorMessage('Error de conexi√≥n. Revisa internet o credenciales.');
      } finally {
        showLoadingIndicator(false);
      }
    }

    // ============================================================
    // 8) Render de UI (√°lbumes y detalle) ‚Äì siempre ordenado
    // ============================================================
    function displayAlbums(albums) {
      const container = document.getElementById('albums');
      if (!albums?.length) { container.innerHTML = '<h2>No hay √°lbumes disponibles</h2>'; return; }
      container.innerHTML = sortAlbums(albums).map(album => `
        <div class="album-card" onclick='showAlbumDetail(${JSON.stringify(album).replace(/"/g, '&quot;')})'>
          <img class="album-img" src="${album.cover_url}" alt="${album.title}" loading="lazy">
          <div class="album-title">${album.title}</div>
          <div class="album-artist">${album.artist}</div>
        </div>
      `).join('');
    }
    async function showAlbumDetail(album) {
      currentAlbum = album;
      document.getElementById('albums').style.display = 'none';
      const detail = document.getElementById('album-detail');
      detail.style.display = 'block';
      detail.innerHTML = `
        <button class="back-btn btn-secondary" onclick="showAlbumsGrid()">‚üµ Volver</button>
        <div style="text-align:center; margin-bottom:2rem;">
          <img class="album-img" src="${album.cover_url}" style="width:200px;height:200px;display:block;margin:0 auto 1rem;">
          <div class="album-title" style="font-size:1.5rem;">${album.title}</div>
          <div class="album-artist" style="font-size:1.1rem;color:#b3b3b3;">${album.artist}</div>
        </div>
        <div class="song-list" id="detail-song-list">Cargando...</div>
      `;
      try {
        const { documents: songs } = await appwriteDatabases.listDocuments(
          APPWRITE_DATABASE_ID,
          APPWRITE_SONGS_COLLECTION_ID,
          [Appwrite.Query.equal('album_id', album.id), Appwrite.Query.limit(200)]
        );
        const listDiv = document.getElementById('detail-song-list');
        if (!songs?.length) { listDiv.innerHTML = 'No hay canciones en este √°lbum.'; return; }

        currentPlaylist = sortSongsByTitle(songs);
        originalPlaylist = [...currentPlaylist];

        const favorites = getLocalFavorites();
        const downloaded = await getAllDownloadedSongs();
        const downloadedIds = downloaded.map(s => s.id);

        listDiv.innerHTML = '<ul>' + currentPlaylist.map((song, idx) => `
          <li style="display:flex; align-items:center; justify-content:space-between; gap:.6rem; padding:.4rem 0;">
            <div onclick="playSongFromPlaylist(${idx})" style="flex:1; cursor:pointer;">${song.title}</div>
            <div class="song-actions">
              <span onclick="toggleFavorite('${song.$id}', this); event.stopPropagation();" style="cursor:pointer; color:${favorites.includes(song.$id) ? '#1DB954' : '#666'};">${favorites.includes(song.$id) ? '‚ù§Ô∏è' : 'ü§ç'}</span>
              <span class="download-icon ${downloadedIds.includes(song.$id) ? 'downloaded' : ''}" onclick="event.stopPropagation(); downloadSong('${song.$id}', this)">‚Üì</span>
              <span class="play-icon" onclick="playSongFromPlaylist(${idx})">‚ñ∂</span>
            </div>
          </li>
        `).join('') + '</ul>';
      } catch (e) {
        console.error(e);
        document.getElementById('detail-song-list').innerHTML = 'Error al cargar las canciones.';
      }
    }
    function showAlbumsGrid(){ document.getElementById('album-detail').style.display = 'none'; document.getElementById('albums').style.display = 'grid'; }
    function playSongFromPlaylist(index){ playSong(currentPlaylist[index], currentAlbum, currentPlaylist, index); }

    // ============================================================
    // 9) Descargas (ordenadas)
    // ============================================================
    async function downloadSong(songId, element) {
      if (element.classList.contains('downloaded')) { showInfoModal('Esta canci√≥n ya est√° descargada.'); return; }
      try {
        const song = allSongs.find(s => s.$id === songId);
        if (!song) throw new Error('Canci√≥n no encontrada');
        element.textContent = '...';

        const audioUrl = appwriteStorage.getFileDownload(APPWRITE_SONGS_BUCKET_ID, song.file_id);
        const album = allAlbums.find(a => a.id === song.album_id);
        const coverUrl = album ? album.cover_url : '';

        const audioResp = await fetch(audioUrl); if (!audioResp.ok) throw new Error('Error al descargar audio');
        const audioBlob = await audioResp.blob();

        let coverBlob = null;
        if (coverUrl) { const coverResp = await fetch(coverUrl).catch(() => null); coverBlob = coverResp && coverResp.ok ? await coverResp.blob() : null; }

        await saveSongToDB({ id: song.$id, metadata: { ...song, albums: album }, audio: audioBlob, cover: coverBlob });
        showInfoModal(`${song.title} descargada con √©xito.`);
        element.textContent = '‚Üì'; element.classList.add('downloaded');
      } catch (err) {
        console.error(err);
        showInfoModal('No se pudo descargar la canci√≥n.');
        element.textContent = '‚Üì';
      }
    }
    async function loadDownloads() {
      const content = document.getElementById('downloads-content');
      try {
        const downloaded = await getAllDownloadedSongs();
        if (!downloaded.length) { content.innerHTML = `<div style="text-align:center; padding:2rem;">No tienes canciones descargadas</div>`; return; }
        const ordered = sortSongRecords(downloaded.map(x => x.metadata));
        let html = '<div class="downloads-list">';
        ordered.forEach(song => {
          html += `
            <div class="download-item" onclick="playDownloadedSong('${song.$id}')">
              <div class="download-info">
                <div class="download-title">${song.title}</div>
                <div class="download-artist">${song.albums?.artist || 'Desconocido'} ‚Ä¢ ${song.albums?.title || ''}</div>
              </div>
              <span>‚ñ∂</span>
            </div>`;
        });
        content.innerHTML = html + '</div>';
      } catch (e) {
        console.error(e); content.innerHTML = 'Error al cargar las descargas.';
      }
    }
    async function playDownloadedSong(songId) {
      const songData = await getSongFromDB(songId);
      if (songData) {
        currentPlaylist = [songData.metadata]; currentIndex = 0;
        playSong(songData.metadata, songData.metadata.albums);
      }
    }

    // ============================================================
    // 10) Favoritos (ordenados)
    // ============================================================
    async function loadFavorites() {
      const content = document.getElementById('favorites-content');
      const favorites = getLocalFavorites();
      if (!favorites.length) { content.innerHTML = `<div style="text-align:center; padding:3rem;"><h2>No tienes favoritos</h2></div>`; return; }
      try {
        const songsResponse = await appwriteDatabases.listDocuments(
          APPWRITE_DATABASE_ID, APPWRITE_SONGS_COLLECTION_ID, [Appwrite.Query.equal('$id', favorites), Appwrite.Query.limit(200)]
        );
        const merged = songsResponse.documents.map(song => ({ ...song, albums: allAlbums.find(a => a.id === song.album_id) }));
        const songs = sortSongRecords(merged);

        let html = '<div class="favorites-list">';
        songs.forEach(song => {
          html += `
            <div class="favorite-item" onclick="playSongFromFavorites('${song.$id}')">
              <div class="favorite-info">
                <div class="favorite-title">${song.title}</div>
                <div class="favorite-artist">${song.albums?.artist || 'Desconocido'} ‚Ä¢ ${song.albums?.title || ''}</div>
              </div>
              <div class="song-actions">
                <span onclick="event.stopPropagation(); toggleFavorite('${song.$id}', this);" style="cursor:pointer; color:#1DB954; font-size:1.2rem;">‚ù§Ô∏è</span>
                <span>‚ñ∂</span>
              </div>
            </div>`;
        });
        content.innerHTML = html + '</div>';
      } catch (e) {
        console.error(e); content.innerHTML = `Error cargando favoritos.`;
      }
    }
    function playSongFromFavorites(songId) {
      const song = songsWithAlbumInfo.find(s => s.$id === songId);
      if (song) playSong(song, song.albums, [song], 0);
    }
    function playSongFromSearch(songId) {
      const song = songsWithAlbumInfo.find(s => s.$id === songId);
      if (song) playSong(song, song.albums, [song], 0);
    }

    // ============================================================
    // 11) Reproductor
    // ============================================================
    async function playSong(song, album, playlist = [song], index = 0) {
      currentSong = song; currentAlbum = album; currentPlaylist = playlist; currentIndex = index;
      const audio = document.getElementById('audio-player');
      audio.pause(); updateAllPlayers();

      const onCanPlay = () => { audio.play().catch(err => { if (err.name !== 'AbortError') showInfoModal('No se pudo reproducir la canci√≥n.'); }); audio.removeEventListener('canplay', onCanPlay); };
      audio.addEventListener('canplay', onCanPlay);

      try {
        const downloadedSong = await getSongFromDB(song.$id);
        if (downloadedSong?.audio) audio.src = URL.createObjectURL(downloadedSong.audio);
        else audio.src = appwriteStorage.getFileDownload(APPWRITE_SONGS_BUCKET_ID, song.file_id);
      } catch {
        audio.src = appwriteStorage.getFileDownload(APPWRITE_SONGS_BUCKET_ID, song.file_id);
      }
      audio.load();
    }
    function updateAllPlayers(){ updateMiniPlayer(); updateFullPlayer(); updatePlayButtons(); }
    async function updateMiniPlayer() {
      if (!currentSong) return;
      const mini = document.getElementById('mini-player'); mini.style.display = 'flex';
      let coverUrl = currentAlbum?.cover_url || '';
      try { const d = await getSongFromDB(currentSong.$id).catch(() => null); if (d?.cover) coverUrl = URL.createObjectURL(d.cover); } catch {}
      document.getElementById('mini-player-img').src = coverUrl || '';
      document.getElementById('mini-player-title').textContent = currentSong?.title || 'Sin t√≠tulo';
      document.getElementById('mini-player-artist').textContent = currentAlbum?.artist || 'Desconocido';
    }
    async function updateFullPlayer() {
      if (!currentSong) return;
      let coverUrl = currentAlbum?.cover_url || '';
      try { const d = await getSongFromDB(currentSong.$id).catch(() => null); if (d?.cover) coverUrl = URL.createObjectURL(d.cover); } catch {}
      document.getElementById('full-player-cover').src = coverUrl || '';
      document.getElementById('full-player-title').textContent = currentSong?.title || 'Sin t√≠tulo';
      document.getElementById('full-player-artist').textContent = currentAlbum?.artist || 'Desconocido';
    }
    function updatePlayButtons() {
      const playText = isPlaying ? '‚è∏' : '‚ñ∂';
      ['mini-play-btn', 'full-play-btn'].forEach(id => { const btn = document.getElementById(id); if (btn) btn.textContent = playText; });
    }
    function togglePlay(){ const audio = document.getElementById('audio-player'); if (isPlaying) audio.pause(); else audio.play(); }
    function nextSong(){ if (!currentPlaylist.length) return; currentIndex = (currentIndex + 1) % currentPlaylist.length; playSong(currentPlaylist[currentIndex], currentAlbum, currentPlaylist, currentIndex); }
    function previousSong(){ if (!currentPlaylist.length) return; currentIndex = currentIndex > 0 ? currentIndex - 1 : currentPlaylist.length - 1; playSong(currentPlaylist[currentIndex], currentAlbum, currentPlaylist, currentIndex); }
    function handleSongEnded(){ if (repeatMode === 'all' || currentIndex < currentPlaylist.length - 1) nextSong(); else { isPlaying = false; updatePlayButtons(); } }
    function setVolume(v){ document.getElementById('audio-player').volume = v / 100; }
    function updateProgressBar() {
      const audio = document.getElementById('audio-player'); if (!audio.duration) return;
      const progress = (audio.currentTime / audio.duration) * 100;
      document.getElementById('full-progress-fill').style.width = `${progress}%`;
      document.getElementById('full-current-time').textContent = formatTime(audio.currentTime);
      document.getElementById('full-total-time').textContent = formatTime(audio.duration);
    }
    const formatTime = (s) => `${Math.floor(s/60)}:${Math.floor(s%60).toString().padStart(2,'0')}`;
    function seekToFull(e){ const audio = document.getElementById('audio-player'); const r = e.currentTarget.getBoundingClientRect(); audio.currentTime = ((e.clientX - r.left) / r.width) * audio.duration; }
    function openFullPlayer(){ document.getElementById('full-player').classList.add('active'); }
    function closeFullPlayer(){ document.getElementById('full-player').classList.remove('active'); }
    function toggleRepeatMode(){ repeatMode = (repeatMode === 'all') ? 'off' : 'all'; updateModeButtonsUI(); }
    function toggleShuffleMode(){
      shuffleMode = !shuffleMode;
      if (shuffleMode) { originalPlaylist = [...currentPlaylist]; currentPlaylist = shuffleArray(currentPlaylist); }
      else if (originalPlaylist.length) { currentPlaylist = [...originalPlaylist]; }
      updateModeButtonsUI();
    }
    const shuffleArray = (arr) => { const a = [...arr]; for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; } return a; };
    function updateModeButtonsUI(){ document.getElementById('repeat-btn').classList.toggle('active', repeatMode === 'all'); document.getElementById('shuffle-btn').classList.toggle('active', shuffleMode); }

    // ============================================================
    // 12) Panel de Admin (listas ordenadas)
    // ============================================================
    async function renderAdminPanel() {
      const adminContent = document.getElementById('admin-content');
      adminContent.innerHTML = `
        <div class="admin-section">
          <h4>Gesti√≥n de √Ålbumes (Supabase)</h4>
          <form id="album-form" class="admin-form">
            <input type="hidden" id="album-id">
            <div class="form-group"><label>T√≠tulo:</label><input type="text" id="album-title" required></div>
            <div class="form-group"><label>Artista:</label><input type="text" id="album-artist" required></div>
            <div class="form-group"><label>URL Portada:</label><input type="url" id="album-cover" required></div>
            <button type="submit" class="btn-primary">Guardar √Ålbum</button>
            <button type="button" id="cancel-album-edit" class="btn-secondary" style="display:none; margin-top:.5rem;">Cancelar Edici√≥n</button>
          </form>
          <div id="admin-album-list" class="admin-list">Cargando √°lbumes...</div>
        </div>
        <div class="admin-section">
          <h4>Gesti√≥n de Canciones (Appwrite)</h4>
          <form id="song-form" class="admin-form">
            <input type="hidden" id="song-id">
            <div class="form-group"><label>T√≠tulo:</label><input type="text" id="song-title" required></div>
            <div class="form-group"><label>Archivo de Canci√≥n:</label><input type="file" id="song-file" accept="audio/*"></div>
            <div class="form-group"><label>√Ålbum:</label><select id="song-album-select" required></select></div>
            <button type="submit" class="btn-primary">Subir Canci√≥n</button>
            <button type="button" id="cancel-song-edit" class="btn-secondary" style="display:none; margin-top:.5rem;">Cancelar Edici√≥n</button>
          </form>
          <div id="admin-song-list" class="admin-list">Cargando canciones...</div>
        </div>
      `;
      await renderAdminLists();
      setupAdminForms();
    }
    async function renderAdminLists() {
      const [{ data: albums }, { documents: songs }] = await Promise.all([
        supabase.from('albums').select('*'),
        appwriteDatabases.listDocuments(APPWRITE_DATABASE_ID, APPWRITE_SONGS_COLLECTION_ID, [Appwrite.Query.limit(200)])
      ]);
      allAlbums = sortAlbums(albums || []);
      allSongs = sortSongsByTitle(songs || []);

      const albumList = document.getElementById('admin-album-list');
      albumList.innerHTML = allAlbums.map(album => `
        <div class="admin-item" style="display:flex; align-items:center; justify-content:space-between; padding:.5rem 0;">
          <div class="admin-item-info"><strong>${album.title}</strong><br><small>${album.artist}</small></div>
          <div class="admin-item-actions" style="display:flex; gap:.4rem;">
            <button class="btn-secondary" onclick="editAlbum('${album.id}', '${album.title.replace(/'/g,"\\'")}', '${album.artist.replace(/'/g,"\\'")}', '${(album.cover_url||'').replace(/'/g,"\\'")}')">Editar</button>
            <button class="btn-danger" onclick="deleteAlbum('${album.id}')">Borrar</button>
          </div>
        </div>
      `).join('');

      const songsWithAlbumInfoAdmin = sortSongRecords(allSongs.map(song => ({ ...song, albums: allAlbums.find(a => a.id === song.album_id) })));
      const songList = document.getElementById('admin-song-list');
      songList.innerHTML = songsWithAlbumInfoAdmin.map(song => `
        <div class="admin-item" style="display:flex; align-items:center; justify-content:space-between; padding:.5rem 0;">
          <div class="admin-item-info"><strong>${song.title}</strong><br><small>${song.albums?.title || 'Sin √°lbum'}</small></div>
          <div class="admin-item-actions" style="display:flex; gap:.4rem;">
            <button class="btn-secondary" onclick="editSong('${song.$id}', '${song.title.replace(/'/g,"\\'")}', '${song.album_id||''}')">Editar</button>
            <button class="btn-danger" onclick="deleteSong('${song.$id}', '${song.file_id}')">Borrar</button>
          </div>
        </div>
      `).join('');

      const albumSelect = document.getElementById('song-album-select');
      albumSelect.innerHTML = `<option value="">-- Seleccionar √Ålbum --</option>` + allAlbums.map(a => `<option value="${a.id}">${a.title}</option>`).join('');
    }
    function setupAdminForms() {
      const albumForm = document.getElementById('album-form');
      albumForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('album-id').value;
        const title = document.getElementById('album-title').value;
        const artist = document.getElementById('album-artist').value;
        const cover_url = document.getElementById('album-cover').value;
        showLoadingIndicator(true);
        const { error } = id
          ? await supabase.from('albums').update({ title, artist, cover_url }).eq('id', id)
          : await supabase.from('albums').insert([{ title, artist, cover_url }]);
        showLoadingIndicator(false);
        if (error) showInfoModal('Error guardando √°lbum: ' + error.message);
        else { showInfoModal('√Ålbum guardado con √©xito.'); albumForm.reset(); document.getElementById('album-id').value=''; document.getElementById('cancel-album-edit').style.display='none'; await loadAllData(); await renderAdminLists(); }
      });
      document.getElementById('cancel-album-edit').addEventListener('click', () => {
        albumForm.reset(); document.getElementById('album-id').value=''; document.getElementById('cancel-album-edit').style.display='none';
      });

      const songForm = document.getElementById('song-form');
      songForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const title = document.getElementById('song-title').value;
        const album_id = document.getElementById('song-album-select').value;
        const song_file = document.getElementById('song-file').files[0];
        if (!song_file) return showInfoModal('Por favor, selecciona un archivo de audio.');

        showLoadingIndicator(true);
        try {
          const uploadedFile = await appwriteStorage.createFile(APPWRITE_SONGS_BUCKET_ID, Appwrite.ID.unique(), song_file);
          await appwriteDatabases.createDocument(APPWRITE_DATABASE_ID, APPWRITE_SONGS_COLLECTION_ID, Appwrite.ID.unique(), { title, album_id, file_id: uploadedFile.$id });
          showInfoModal('Canci√≥n subida y guardada con √©xito.'); songForm.reset();
          await loadAllData(); await renderAdminLists();
        } catch (e2) {
          showInfoModal('Error subiendo canci√≥n: ' + e2.message);
        } finally { showLoadingIndicator(false); }
      });
    }
    function editAlbum(id, title, artist, cover_url){
      document.getElementById('album-id').value = id;
      document.getElementById('album-title').value = title;
      document.getElementById('album-artist').value = artist;
      document.getElementById('album-cover').value = cover_url;
      document.getElementById('cancel-album-edit').style.display = 'inline-block';
      document.getElementById('album-form').scrollIntoView({ behavior: 'smooth' });
    }
    function deleteAlbum(id){
      showConfirmationModal('¬øSeguro que quieres borrar este √°lbum? Esto tambi√©n borrar√° las canciones asociadas en Appwrite.', async () => {
        showLoadingIndicator(true);
        try {
          const { documents: songsToDelete } = await appwriteDatabases.listDocuments(APPWRITE_DATABASE_ID, APPWRITE_SONGS_COLLECTION_ID, [Appwrite.Query.equal('album_id', id), Appwrite.Query.limit(200)]);
          await Promise.all(songsToDelete.map(async song => {
            await appwriteDatabases.deleteDocument(APPWRITE_DATABASE_ID, APPWRITE_SONGS_COLLECTION_ID, song.$id);
            await appwriteStorage.deleteFile(APPWRITE_SONGS_BUCKET_ID, song.file_id);
          }));
          const { error } = await supabase.from('albums').delete().eq('id', id);
          if (error) throw error;
          showInfoModal('√Ålbum borrado con √©xito.'); await loadAllData(); await renderAdminLists();
        } catch (e) { showInfoModal('Error borrando √°lbum: ' + e.message); }
        finally { showLoadingIndicator(false); }
      });
    }
    function editSong(id, title, album_id){
      document.getElementById('song-id').value = id;
      document.getElementById('song-title').value = title;
      document.getElementById('song-album-select').value = album_id || '';
      showInfoModal('No se puede editar el archivo de una canci√≥n, solo el t√≠tulo. Si quieres cambiar el audio, b√≥rrala y vuelve a subirla.');
    }
    function deleteSong(songId, fileId){
      showConfirmationModal('¬øSeguro que quieres borrar esta canci√≥n?', async () => {
        showLoadingIndicator(true);
        try {
          await appwriteDatabases.deleteDocument(APPWRITE_DATABASE_ID, APPWRITE_SONGS_COLLECTION_ID, songId);
          await appwriteStorage.deleteFile(APPWRITE_SONGS_BUCKET_ID, fileId);
          showInfoModal('Canci√≥n borrada con √©xito.'); await loadAllData(); await renderAdminLists();
        } catch (e) { showInfoModal('Error borrando canci√≥n: ' + e.message); }
        finally { showLoadingIndicator(false); }
      });
    }

    // ============================================================
    // 13) Inicializaci√≥n (orden correcta de listeners y carga)
    // ============================================================
    document.addEventListener('DOMContentLoaded', () => {
      // Mini player abre full si no clic en controles
      document.getElementById('mini-player').addEventListener('click', (e) => {
        if (!e.target.closest('.player-controls-inline')) openFullPlayer();
      });
      // Audio listeners
      const audio = document.getElementById('audio-player');
      audio.addEventListener('ended', handleSongEnded);
      audio.addEventListener('timeupdate', updateProgressBar);
      audio.addEventListener('play', () => { isPlaying = true; updatePlayButtons(); });
      audio.addEventListener('pause', () => { isPlaying = false; updatePlayButtons(); });

      // Tema y DB local
      loadSavedTheme();
      initDB().catch(err => { console.error('DB local:', err); showInfoModal('La aplicaci√≥n no puede funcionar sin la base de datos local.'); });
    });

    window.onload = function() {
      loadData();
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('SW registrado:', reg.scope))
          .catch(err => console.log('SW error:', err));
      }
    };
  </script>
</body>
</html>
