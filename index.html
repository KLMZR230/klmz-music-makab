<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>üé∂ Mis √Ålbumes</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; padding: 20px; }
    h1 { text-align: center; }
    .album { display: inline-block; margin: 10px; padding: 10px; background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,.2); width: 180px; text-align: center; vertical-align: top; }
    .album img { width: 150px; height: 150px; object-fit: cover; border-radius: 8px; }
    .song-list { margin-top: 10px; text-align: left; font-size: 14px; }
    .delete-btn { background: red; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-top: 5px; }
    .upload-form { background: white; padding: 15px; margin: 20px auto; max-width: 400px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,.2); }
    .upload-form input, .upload-form button, .upload-form select { margin: 5px 0; padding: 8px; width: 100%; }
    audio { width: 100%; margin-top: 5px; }
  </style>
</head>
<body>

<h1>üéµ Mis √Ålbumes</h1>

<div id="albums"></div>

<!-- üìå Formulario para subir nuevo √°lbum -->
<div class="upload-form">
  <h3>üìÄ Subir Nuevo √Ålbum</h3>
  <input type="text" id="albumTitle" placeholder="T√≠tulo del √°lbum">
  <input type="file" id="albumCover" accept="image/*">
  <button onclick="uploadAlbum()">Subir √Ålbum</button>
</div>

<!-- üìå Formulario para subir canciones -->
<div class="upload-form">
  <h3>üé∂ Subir Canci√≥n</h3>
  <select id="albumSelect"></select>
  <input type="text" id="songTitle" placeholder="T√≠tulo de la canci√≥n">
  <input type="file" id="songFile" accept="audio/*">
  <button onclick="uploadSong()">Subir Canci√≥n</button>
</div>

<script>
  // üëá Conecta con tu proyecto Supabase
  const supabase = window.supabase.createClient(
    "https://TU-PROJECT.supabase.co",
    "TU-ANON-KEY" // ‚ö†Ô∏è usa service_role solo en backend
  );

  const isAdmin = true; // ‚ö†Ô∏è c√°mbialo seg√∫n tu login real

  // üìå Cargar √°lbumes con canciones
  async function loadAlbums() {
    let { data: albums, error } = await supabase
      .from("albums")
      .select("id, title, cover_url, songs(id,title,song_url)")
      .order("id");

    if (error) {
      console.error("Error cargando √°lbumes:", error);
      return;
    }

    const container = document.getElementById("albums");
    container.innerHTML = "";
    const select = document.getElementById("albumSelect");
    select.innerHTML = "";

    albums.forEach(album => {
      // Render de √°lbum
      const div = document.createElement("div");
      div.className = "album";
      div.innerHTML = `
        <img src="${album.cover_url}" alt="${album.title}">
        <h3>${album.title}</h3>
        ${isAdmin ? `<button class="delete-btn" onclick="deleteAlbum('${album.id}')">üóë Eliminar √Ålbum</button>` : ""}
        <div class="song-list">
          ${album.songs.map(song => `
            <div>
              üé∂ ${song.title}
              <audio controls src="${song.song_url}"></audio>
              ${isAdmin ? `<button class="delete-btn" onclick="deleteSong('${song.id}')">üóë</button>` : ""}
            </div>
          `).join("")}
        </div>
      `;
      container.appendChild(div);

      // Para formulario de subir canciones
      let opt = document.createElement("option");
      opt.value = album.id;
      opt.textContent = album.title;
      select.appendChild(opt);
    });
  }

  // üìå Subir nuevo √°lbum
  async function uploadAlbum() {
    const title = document.getElementById("albumTitle").value;
    const file = document.getElementById("albumCover").files[0];
    if (!title || !file) return alert("Falta t√≠tulo o portada");

    const fileName = Date.now() + "-" + file.name;
    let { error: uploadError } = await supabase.storage.from("covers").upload(fileName, file);
    if (uploadError) return alert("Error subiendo portada: " + uploadError.message);

    const { data: urlData } = supabase.storage.from("covers").getPublicUrl(fileName);
    const coverUrl = urlData.publicUrl;

    const { error } = await supabase.from("albums").insert({ title, cover_url: coverUrl });
    if (error) alert("Error guardando √°lbum: " + error.message);
    else {
      alert("√Ålbum subido ‚úÖ");
      document.getElementById("albumTitle").value = "";
      document.getElementById("albumCover").value = "";
      loadAlbums();
    }
  }

  // üìå Subir canci√≥n a √°lbum
  async function uploadSong() {
    const albumId = document.getElementById("albumSelect").value;
    const title = document.getElementById("songTitle").value;
    const file = document.getElementById("songFile").files[0];
    if (!albumId || !title || !file) return alert("Falta info para la canci√≥n");

    const fileName = Date.now() + "-" + file.name;
    let { error: uploadError } = await supabase.storage.from("songs").upload(fileName, file);
    if (uploadError) return alert("Error subiendo canci√≥n: " + uploadError.message);

    const { data: urlData } = supabase.storage.from("songs").getPublicUrl(fileName);
    const songUrl = urlData.publicUrl;

    const { error } = await supabase.from("songs").insert({ title, album_id: albumId, song_url: songUrl });
    if (error) alert("Error guardando canci√≥n: " + error.message);
    else {
      alert("Canci√≥n subida ‚úÖ");
      document.getElementById("songTitle").value = "";
      document.getElementById("songFile").value = "";
      loadAlbums();
    }
  }

  // üìå Borrar √°lbum
  async function deleteAlbum(id) {
    if (!confirm("¬øSeguro que quieres eliminar este √°lbum y sus canciones?")) return;
    const { error } = await supabase.from("albums").delete().eq("id", id);
    if (error) alert("Error eliminando √°lbum: " + error.message);
    else loadAlbums();
  }

  // üìå Borrar canci√≥n
  async function deleteSong(id) {
    if (!confirm("¬øSeguro que quieres eliminar esta canci√≥n?")) return;
    const { error } = await supabase.from("songs").delete().eq("id", id);
    if (error) alert("Error eliminando canci√≥n: " + error.message);
    else loadAlbums();
  }

  loadAlbums();
</script>

</body>
</html>
