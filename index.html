<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>KLMZ MUSIC</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  
  <!-- SDK Appwrite con fallback -->
  <script src="https://cdn.jsdelivr.net/npm/appwrite@13/dist/appwrite.umd.js" 
          onerror="loadAppwriteFallback()"></script>
  <script src="https://unpkg.com/appwrite@13/dist/appwrite.umd.js" 
          id="fallback-sdk" style="display:none"></script>
  
  <style>
  *{box-sizing:border-box}
  body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#181818;color:#fff;padding-bottom:2rem}
  header{background:#121212;padding:1rem;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;border-bottom:1px solid #333}
  .logo{font-weight:700;font-size:1.4rem;color:#1DB954}
  .lock-icon{cursor:pointer;font-size:1.4rem;padding:0.5rem;border-radius:8px;transition:background 0.2s}
  .lock-icon:hover{background:#333}
  main{padding:1rem;max-width:1200px;margin:0 auto}
  .section-title{font-size:1.8rem;font-weight:700;margin:1.5rem 0;color:#fff}
  .album-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:1.5rem;margin-top:2rem}
  .status{margin:2rem 0;padding:1.5rem;border-radius:12px;font-family:monospace;font-size:0.95rem;border-left:4px solid #1DB954}
  .status.error{background:#2d1517;color:#ff6b6b;border-left-color:#ff6b6b}
  .status.success{background:#1a2e1a;color:#51cf66;border-left-color:#51cf66}
  .status.info{background:#1e2833;color:#74c0fc;border-left-color:#74c0fc}
  .empty-state{text-align:center;padding:4rem 2rem;color:#666}
  .loading{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.95);color:#fff;padding:2rem 3rem;border-radius:12px;border:2px solid #1DB954;font-size:1.1rem;z-index:1000}
  </style>
</head>

<body>
  <header>
    <span class="logo">üéµ KLMZ MUSIC</span>
    <div class="lock-icon" id="lockIcon">üîí</div>
  </header>

  <main>
    <h1 class="section-title">√Ålbumes</h1>
    <div id="status" class="status info">üîÑ Cargando SDK de Appwrite...</div>
    <div id="albums" class="album-grid"></div>
  </main>

  <div id="loading" class="loading" hidden>üéµ Cargando...</div>

  <script>
    // Funci√≥n para cargar SDK alternativo
    function loadAppwriteFallback() {
      console.log('‚ö†Ô∏è CDN principal fall√≥, probando fallback...');
      const fallback = document.getElementById('fallback-sdk');
      fallback.style.display = 'block';
      fallback.onload = () => initApp();
      fallback.onerror = () => {
        setStatus('Error: No se pudo cargar SDK desde ning√∫n CDN. Verifica tu conexi√≥n.', 'error');
      };
    }

    // üîß CONFIGURACI√ìN
    const CONFIG = {
      endpoint: 'https://nyc.cloud.appwrite.io/v1',
      projectId: '68ab0cf2000365979a71',
      databaseId: '68ab0d9b00124af501a5',
      albumsCollectionId: '68ab0dd00024ddeb51fd',
      songsCollectionId: '68ab0f0e002d9f334b0d',
      bucketId: '68ab1101001cff947e6b'
    };

    // Utilidades
    const $ = id => document.getElementById(id);
    const show = el => el.hidden = false;
    const hide = el => el.hidden = true;

    function setStatus(message, type = 'info') {
      const status = $('status');
      const emoji = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : 'üîÑ';
      status.innerHTML = `${emoji} ${message}`;
      status.className = `status ${type}`;
    }

    // Inicializaci√≥n principal
    function initApp() {
      // Esperar a que DOM est√© listo
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => startApp());
      } else {
        startApp();
      }
    }

    async function startApp() {
      console.log('üéµ Iniciando KLMZ MUSIC...');

      // Verificar SDK con m√°s tiempo
      let retries = 0;
      while (typeof Appwrite === 'undefined' && retries < 10) {
        console.log(`‚è≥ Esperando SDK... intento ${retries + 1}`);
        await new Promise(resolve => setTimeout(resolve, 500));
        retries++;
      }

      if (typeof Appwrite === 'undefined') {
        setStatus('SDK no disponible despu√©s de 5 segundos. Recarga la p√°gina.', 'error');
        return;
      }

      console.log('‚úÖ SDK cargado correctamente');
      setStatus('SDK de Appwrite cargado correctamente');

      // Configurar Appwrite
      const { Client, Databases, Storage, Account } = Appwrite;
      
      const client = new Client()
        .setEndpoint(CONFIG.endpoint)
        .setProject(CONFIG.projectId);
      
      const databases = new Databases(client);
      const storage = new Storage(client);
      const account = new Account(client);

      // Probar conexi√≥n
      setStatus('Verificando conexi√≥n con Appwrite...');
      
      try {
        await account.get();
        setStatus('Conectado con sesi√≥n activa', 'success');
        $('lockIcon').textContent = 'üë§';
      } catch (error) {
        if (error.code === 401) {
          setStatus('Conectado como visitante - CORS OK', 'success');
        } else {
          setStatus(`Error de conexi√≥n: ${error.message}`, 'error');
          return;
        }
      }

      // Cargar √°lbumes
      await loadAlbums();

      async function loadAlbums() {
        setStatus('Cargando √°lbumes...');
        show($('loading'));
        
        try {
          const response = await databases.listDocuments(
            CONFIG.databaseId, 
            CONFIG.albumsCollectionId
          );
          
          if (response.documents.length === 0) {
            $('albums').innerHTML = `
              <div class="empty-state">
                <h2>üéµ No hay √°lbumes</h2>
                <p>La base de datos est√° lista pero vac√≠a</p>
              </div>`;
            setStatus('Conexi√≥n exitosa - Base de datos vac√≠a', 'success');
          } else {
            displayAlbums(response.documents);
            setStatus(`${response.documents.length} √°lbum(es) cargados`, 'success');
          }
          
        } catch (error) {
          console.error('Error:', error);
          setStatus(`Error: ${error.message}`, 'error');
          $('albums').innerHTML = `<div class="empty-state"><h2>‚ùå Error al cargar</h2></div>`;
        }
        
        hide($('loading'));
      }

      function displayAlbums(albums) {
        $('albums').innerHTML = albums.map(album => `
          <div style="text-align:center;padding:1rem;background:#282828;border-radius:8px;">
            <div style="width:120px;height:120px;background:#444;border-radius:8px;margin:0 auto 1rem;display:flex;align-items:center;justify-content:center;font-size:2rem;">üéµ</div>
            <div style="font-weight:600;">${album.name}</div>
            <div style="color:#999;font-size:0.9rem;">${album.artistName}</div>
          </div>
        `).join('');
      }
    }

    // Auto-iniciar cuando el script se carga
    if (typeof Appwrite !== 'undefined') {
      initApp();
    } else {
      // Esperar a que se cargue
      setTimeout(() => {
        if (typeof Appwrite !== 'undefined') {
          initApp();
        } else {
          loadAppwriteFallback();
        }
      }, 2000);
    }
  </script>
</body>
</html>
