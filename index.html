<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>KLMZ MUSIC</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1DB954">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; background: #181818; color: #fff; padding-bottom: 84px; transition: all 0.3s ease; }
        header { background: #121212; padding: 1rem 1.5rem; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
        .logo { font-weight: bold; font-size: 1.4rem; letter-spacing: 1px; transition: all 0.3s ease; }
        .user-actions { display:flex; align-items: center; gap:.5rem; }
        .lock-icon { cursor:pointer; font-size:1.4rem; color:#fff; user-select:none; transition: all 0.3s ease; }
        .theme-selector { display: flex; align-items: center; gap: 0.3rem; margin-right: 0.5rem; }
        .theme-selector select { background: #333; color: #fff; border: 1px solid #555; border-radius: 4px; padding: 0.2rem; cursor: pointer; transition: all 0.3s ease; }
        main { flex:1; padding:1rem; max-width:900px; margin:0 auto;}
        .section-title { font-size:1.8rem; font-weight:bold; margin-bottom:1.5rem; transition: all 0.3s ease; }
        .album-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(140px,1fr)); gap:1.5rem;}
        .album-card { background:none; padding:0; cursor:pointer; display:flex; flex-direction:column; align-items:center; text-align:center; border: 2px solid transparent; border-radius: 12px; transition: all 0.3s ease; }
        .album-card:hover { transform:scale(1.05); }
        .album-img { border-radius:50%; width:100px; height:100px; object-fit:cover; margin-bottom:.7rem; background:#333; transition: all 0.3s ease; }
        .album-title { font-size:.98rem; font-weight: bold; margin-bottom: 0.4rem; transition: all 0.3s ease; }
        .album-artist { font-size: .9rem; color: #b3b3b3; transition: all 0.3s ease; }
        .song-list ul { list-style:none; padding:0; margin:0;}
        .song-list li { padding:.7rem; cursor:pointer; color:#1db954; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center; transition: all 0.3s ease;}
        .song-list li:hover { color:#fff; background: rgba(255,255,255,.05);}
        .player { position: fixed; bottom: 84px; left: 0; right: 0; background: #212121; border-top: 1px solid #282828; z-index: 300; display: none; align-items: center; padding: 0.8rem 1.2rem; transition: all 0.3s ease;}
        .player-img-mini { width:44px; height:44px; border-radius:50%; object-fit:cover; margin-right:1rem;}
        .player-info-mini { flex:1; overflow:hidden;}
        .player-title-mini { font-weight:bold; font-size:1rem; }
        .player-artist-mini { color:#b3b3b3; font-size:0.9rem; }
        .player-controls-inline { display:flex; align-items:center; gap:.5rem;}
        .play-btn-inline { background: #1DB954; color:#fff; border:none; border-radius:50%; width:36px; height:36px; cursor:pointer; transition: all 0.3s ease; }
        .modal { position: fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,.80); display:none; align-items:center; justify-content:center; z-index:2000; transition: all 0.3s ease;}
        .modal-content { background:#282828; padding:2rem; border-radius:8px; width:95%; max-width:430px; position: relative; transition: all 0.3s ease; }
        .form-group { margin-bottom:1rem;}
        .form-group input, .form-group select { width:100%; padding:.7rem; background:#404040; border:1px solid #555; border-radius:4px; color:#fff; transition: all 0.3s ease;}
        .btn-primary { background:#1DB954; color:#fff; border:none; padding:.7rem 1.5rem; border-radius:999px; cursor:pointer; width:100%; margin-top:.7rem; transition: all 0.3s ease; }
        .btn-primary:hover { background:#1ed760; }
        .btn-danger { background:#e22134; color:#fff; border:none; padding:.5rem 1rem; border-radius:4px; cursor:pointer; transition: all 0.3s ease; }
        .btn-danger:hover { background:#ff4757; }
        .close-modal { position:absolute; top:1rem; right:1rem; background:none; border:none; color:#fff; font-size:1.2rem; cursor:pointer;}
        .user-menu { position: relative; display: inline-block; }
        .user-dropdown { display: none; position: absolute; right: 0; top: calc(100% + 10px); background: #282828; min-width: 200px; border-radius: 8px; z-index: 1000; transition: all 0.3s ease; }
        .user-dropdown.show { display: block; }
        .user-dropdown-item { padding: 0.8rem 1rem; cursor: pointer; border-bottom: 1px solid #404040; transition: all 0.3s ease; }
        .user-dropdown-item:hover { background: #404040; }
        .bottom-nav { position: fixed; left: 0; right: 0; bottom: 20px; background: #181818; border-top: 1px solid #272727; display: flex; height: 64px; z-index: 5000; transition: all 0.3s ease; }
        .bottom-nav-item { color: #b3b3b3; text-align: center; flex: 1; padding: 4px 0; cursor: pointer; display: flex; flex-direction: column; align-items: center; transition: all 0.3s ease;}
        .bottom-nav-item.active { color: #1DB954; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .back-btn { margin-bottom: 1.2rem; background: #222; color: #fff; border: none; padding: 0.5rem 1.5rem; border-radius: 99px; cursor: pointer; transition: all 0.3s ease; }
        .back-btn:hover { background: #333; }
        .loading-indicator { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.9); color: #fff; padding: 1.5rem 2.5rem; border-radius: 12px; z-index: 2000; display: none; }
        .admin-section { margin-bottom: 2rem; background: #242424; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #1DB954; }
        .admin-form input[type="file"] { background: #333; border: 2px dashed #1DB954; padding: 1rem; border-radius: 8px; cursor: pointer; }
        .upload-progress { background: #333; border: 1px solid #1DB954; border-radius: 8px; padding: 1rem; margin: 1rem 0; }
        .upload-progress.success { background: #1a4a2e; border-color: #1DB954; }
        .upload-progress.error { background: #4a1a1a; border-color: #ff4757; }
        .copyright { position: fixed; bottom: 0; left: 0; width: 100%; height: 20px; background: #0a0a0a; color: #666; font-size: 0.7rem; text-align: center; padding: 2px 0; z-index: 10000; }
        
        /* ‚úÖ 6 TEMAS VISUALES COMPLETOS */
        /* üé® TEMA 1: NEON CYBERPUNK */
        body.theme-neon { background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 30%, #16213e 60%, #0f0f23 100%) !important; }
        body.theme-neon .logo { color: #00ff88 !important; text-shadow: 0 0 20px #00ff88 !important; animation: neonPulse 2s ease-in-out infinite alternate !important; }
        body.theme-neon header { background: linear-gradient(135deg, #0f0f23, #1a1a2e) !important; border-bottom: 1px solid #00ff88; }
        body.theme-neon .btn-primary { background: linear-gradient(45deg, #00ff88, #00cc6a) !important; color: #000 !important; }
        body.theme-neon .song-list li { color: #00ff88 !important; }
        body.theme-neon .play-btn-inline { background: #00ff88 !important; color: #000 !important; }
        body.theme-neon .bottom-nav-item.active { color: #00ff88 !important; }
        body.theme-neon .admin-section { border-left-color: #00ff88 !important; background: linear-gradient(135deg, #16213e, #0f0f23) !important; }
        
        /* üé® TEMA 2: ELEGANCIA MINIMAL */
        body.theme-minimal { background: linear-gradient(135deg, #0f0f0f 0%, #1c1c1c 40%, #2a2a2a 80%, #1a1a1a 100%) !important; }
        body.theme-minimal .logo { color: #f5f5f5 !important; font-weight: 300; letter-spacing: 2px; }
        body.theme-minimal header { background: linear-gradient(135deg, #0f0f0f, #1c1c1c) !important; border-bottom: 1px solid #333; }
        body.theme-minimal .btn-primary { background: linear-gradient(45deg, #f5f5f5, #e0e0e0) !important; color: #0f0f0f !important; }
        body.theme-minimal .song-list li { color: #f5f5f5 !important; }
        body.theme-minimal .play-btn-inline { background: #f5f5f5 !important; color: #0f0f0f !important; }
        body.theme-minimal .bottom-nav-item.active { color: #f5f5f5 !important; }
        body.theme-minimal .admin-section { border-left-color: #f5f5f5 !important; background: linear-gradient(135deg, #2a2a2a, #1c1c1c) !important; }
        
        /* üé® TEMA 3: SUNSET VIBES */
        body.theme-sunset { background: linear-gradient(135deg, #2c1810 0%, #4a2c2a 25%, #6d4c41 50%, #8d5524 75%) !important; }
        body.theme-sunset .logo { color: #ff7043 !important; text-shadow: 0 0 15px #ff7043 !important; }
        body.theme-sunset header { background: linear-gradient(135deg, #2c1810, #4a2c2a) !important; border-bottom: 1px solid #ff7043; }
        body.theme-sunset .btn-primary { background: linear-gradient(45deg, #ff7043, #ff5722) !important; }
        body.theme-sunset .song-list li { color: #ff7043 !important; }
        body.theme-sunset .play-btn-inline { background: #ff7043 !important; }
        body.theme-sunset .bottom-nav-item.active { color: #ff7043 !important; }
        body.theme-sunset .admin-section { border-left-color: #ff7043 !important; background: linear-gradient(135deg, #4a2c2a, #6d4c41) !important; }
        
        /* üé® TEMA 4: PASTEL DREAMS */
        body.theme-pastel { background: linear-gradient(135deg, #1a1625 0%, #2d2438 30%, #3d2f47 60%, #4a3b5c 100%) !important; }
        body.theme-pastel .logo { color: #bb86fc !important; text-shadow: 0 0 15px #bb86fc !important; }
        body.theme-pastel header { background: linear-gradient(135deg, #1a1625, #2d2438) !important; border-bottom: 1px solid #bb86fc; }
        body.theme-pastel .btn-primary { background: linear-gradient(45deg, #bb86fc, #9c64f4) !important; color: #1a1625 !important; }
        body.theme-pastel .song-list li { color: #bb86fc !important; }
        body.theme-pastel .play-btn-inline { background: #bb86fc !important; color: #1a1625 !important; }
        body.theme-pastel .bottom-nav-item.active { color: #bb86fc !important; }
        body.theme-pastel .admin-section { border-left-color: #bb86fc !important; background: linear-gradient(135deg, #2d2438, #3d2f47) !important; }
        
        /* üé® TEMA 5: LUXURY JEWELS */
        body.theme-luxury { background: linear-gradient(135deg, #0f1419 0%, #1a252f 30%, #2c3e50 60%, #34495e 100%) !important; }
        body.theme-luxury .logo { color: #3498db !important; text-shadow: 0 0 20px #3498db !important; }
        body.theme-luxury header { background: linear-gradient(135deg, #0f1419, #1a252f) !important; border-bottom: 1px solid #3498db; }
        body.theme-luxury .btn-primary { background: linear-gradient(45deg, #3498db, #2980b9) !important; }
        body.theme-luxury .song-list li { color: #3498db !important; }
        body.theme-luxury .play-btn-inline { background: #3498db !important; }
        body.theme-luxury .bottom-nav-item.active { color: #3498db !important; }
        body.theme-luxury .admin-section { border-left-color: #3498db !important; background: linear-gradient(135deg, #1a252f, #2c3e50) !important; }
        
        /* üé® TEMA 6: OCEANIC SERENITY */
        body.theme-oceanic { background: linear-gradient(135deg, #0a192f 0%, #173a5e 30%, #3b6978 60%, #84a9ac 100%) !important; }
        body.theme-oceanic .logo { color: #17a2b8 !important; text-shadow: 0 0 15px #17a2b8 !important; }
        body.theme-oceanic header { background: linear-gradient(135deg, #0a192f, #173a5e) !important; border-bottom: 1px solid #17a2b8; }
        body.theme-oceanic .btn-primary { background: linear-gradient(45deg, #17a2b8, #138496) !important; }
        body.theme-oceanic .song-list li { color: #17a2b8 !important; }
        body.theme-oceanic .play-btn-inline { background: #17a2b8 !important; }
        body.theme-oceanic .bottom-nav-item.active { color: #17a2b8 !important; }
        body.theme-oceanic .admin-section { border-left-color: #17a2b8 !important; background: linear-gradient(135deg, #173a5e, #3b6978) !important; }
        
        @keyframes neonPulse { 0% { text-shadow: 0 0 15px #00ff88, 0 0 30px #00ff88; } 100% { text-shadow: 0 0 25px #00ff88, 0 0 40px #00ff88, 0 0 60px #00ff88; } }
    </style>
</head>
<body>
    <div class="loading-indicator" id="loading">üéµ Cargando...</div>
    
    <header>
        <span class="logo">KLMZ MUSIC</span>
        <div class="user-actions">
            <div class="theme-selector">
                <select id="theme-select" onchange="changeTheme(this.value)">
                    <option value="default">üéµ Default</option>
                    <option value="neon">‚ö° Neon Cyberpunk</option>
                    <option value="minimal">‚ú® Elegancia Minimal</option>
                    <option value="sunset">üåÖ Sunset Vibes</option>
                    <option value="pastel">üå∏ Pastel Dreams</option>
                    <option value="luxury">üíé Luxury Jewels</option>
                    <option value="oceanic">üåä Oceanic Serenity</option>
                </select>
            </div>
            <div class="user-menu">
                <div class="lock-icon" onclick="toggleUserMenu()">üîí</div>
                <div class="user-dropdown" id="userDropdown">
                    <div class="user-dropdown-item" onclick="showAuth('login')">üîê Iniciar Sesi√≥n</div>
                    <div class="user-dropdown-item" onclick="showAuth('register')">üìù Registrarse</div>
                    <div class="user-dropdown-item" id="adminBtn" onclick="showSection('admin')" style="display:none;">‚öôÔ∏è Panel Admin</div>
                    <div class="user-dropdown-item" id="logoutBtn" onclick="logout()" style="display:none;">üö™ Cerrar Sesi√≥n</div>
                </div>
            </div>
        </div>
    </header>

    <main>
        <section class="content-section active" id="home-section">
            <div class="section-title">Albums</div>
            <div class="album-grid" id="albums">
                <div style="text-align: center; padding: 2rem; color: #666;">
                    <h3>Cargando √°lbumes...</h3>
                </div>
            </div>
            <div id="album-detail" style="display:none;"></div>
        </section>

        <section class="content-section" id="search-section">
            <div class="section-title">üîç Buscar M√∫sica</div>
            <input type="text" placeholder="¬øQu√© quieres escuchar?" id="search-input" style="width:100%; padding:1rem; background:#242424; border:none; border-radius:4px; color:#fff; margin-bottom:2rem;" onkeyup="searchMusic()">
            <div id="search-results"></div>
        </section>

        <section class="content-section" id="favorites-section">
            <div class="section-title">‚ù§Ô∏è Mis Favoritos</div>
            <div id="favorites-content">
                <div style="text-align: center; padding: 2rem; color: #666;">
                    <h3>No tienes favoritos a√∫n</h3>
                    <p>Marca canciones como favoritas desde cualquier √°lbum</p>
                </div>
            </div>
        </section>

        <section class="content-section" id="downloads-section">
            <div class="section-title">üì• Mis Descargas</div>
            <div id="downloads-content">
                <div style="text-align: center; padding: 2rem; color: #666;">
                    <h3>Cargando descargas...</h3>
                </div>
            </div>
        </section>

        <section class="content-section" id="admin-section">
            <div class="section-title">‚öôÔ∏è Panel de Administraci√≥n</div>
            <div id="admin-content"></div>
        </section>
    </main>

    <nav class="bottom-nav">
        <div class="bottom-nav-item active" onclick="showSection('home')">
            <div style="font-size: 1.2rem;">‚åÇ</div>
            <small>Inicio</small>
        </div>
        <div class="bottom-nav-item" onclick="showSection('search')">
            <div style="font-size: 1.2rem;">üîç</div>
            <small>Buscar</small>
        </div>
        <div class="bottom-nav-item" onclick="showSection('downloads')">
            <div style="font-size: 1.2rem;">‚Üì</div>
            <small>Descargas</small>
        </div>
        <div class="bottom-nav-item" onclick="showSection('favorites')">
            <div style="font-size: 1.2rem;">‚ô°</div>
            <small>Favoritos</small>
        </div>
    </nav>

    <div class="player" id="mini-player">
        <img class="player-img-mini" id="player-img" alt="cover">
        <div class="player-info-mini">
            <div class="player-title-mini" id="player-title"></div>
            <div class="player-artist-mini" id="player-artist"></div>
        </div>
        <div class="player-controls-inline">
            <button class="play-btn-inline" id="play-btn" onclick="togglePlay()">‚ñ∂</button>
        </div>
    </div>

    <div class="modal" id="auth-modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal()">&times;</button>
            <div id="login-form">
                <h2>Iniciar Sesi√≥n</h2>
                <form onsubmit="login(event)">
                    <div class="form-group">
                        <input type="email" id="login-email" placeholder="Email" required>
                    </div>
                    <div class="form-group">
                        <input type="password" id="login-password" placeholder="Contrase√±a" required>
                    </div>
                    <button type="submit" class="btn-primary">Iniciar Sesi√≥n</button>
                </form>
            </div>
            <div id="register-form" style="display: none;">
                <h2>Registrarse</h2>
                <form onsubmit="register(event)">
                    <div class="form-group">
                        <input type="email" id="register-email" placeholder="Email" required>
                    </div>
                    <div class="form-group">
                        <input type="password" id="register-password" placeholder="Contrase√±a" required>
                    </div>
                    <div class="form-group">
                        <input type="password" id="register-confirm" placeholder="Confirmar Contrase√±a" required>
                    </div>
                    <button type="submit" class="btn-primary">Registrarse</button>
                </form>
            </div>
        </div>
    </div>

    <div class="copyright">¬© 2025 KLMZ MUSIC - Desarrollado por Freddy Granados</div>
    <audio id="audio-player" preload="metadata"></audio>

## üéØ **PARTE 2: JavaScript B√ÅSICO (Variables + Inicializaci√≥n + Supabase)**

<script>
    // ‚úÖ VARIABLES GLOBALES - SIN BUCLES INFINITOS
    let supabase;
    let currentUser = null;
    let allAlbums = [];
    let allSongs = [];
    let currentSong = null;
    let currentAlbum = null;
    let currentPlaylist = [];
    let currentIndex = 0;
    let isPlaying = false;
    let isCordova = false;
    
    const CONFIG = {
        supabaseUrl: 'https://nqbldvpnqhngdtalvzov.supabase.co',
        supabaseKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xYmxkdnBucWhuZ2R0YWx2em92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyMjY0NjUsImV4cCI6MjA3MDgwMjQ2NX0.Zzg5D219sW7bhvl0_R5ypX9MF6nRzBSDIeo2Lvebab0',
        adminEmail: 'klmzr@gmail.com'
    };
    
    console.log('üöÄ KLMZ MUSIC - Iniciando aplicaci√≥n...');
    
    // ‚úÖ DETECCI√ìN DE ENTORNO
    function detectEnvironment() {
        isCordova = !!(window.cordova || window.phonegap);
        console.log('üì± Entorno:', isCordova ? 'Cordova APK' : 'Navegador Web');
        return isCordova;
    }
    
    // ‚úÖ SISTEMA DE TEMAS FUNCIONAL
    function changeTheme(theme) {
        console.log('üé® Cambiando tema:', theme);
        const body = document.body;
        
        ['theme-neon', 'theme-minimal', 'theme-sunset', 'theme-pastel', 'theme-luxury', 'theme-oceanic']
            .forEach(t => body.classList.remove(t));
        
        if (theme !== 'default') {
            body.classList.add('theme-' + theme);
        }
        
        localStorage.setItem('klmz_theme', theme);
    }
    
    function loadTheme() {
        const saved = localStorage.getItem('klmz_theme') || 'default';
        document.getElementById('theme-select').value = saved;
        changeTheme(saved);
    }
    
    // ‚úÖ INICIALIZAR SUPABASE - SIN BUCLES
    async function initSupabase() {
        try {
            console.log('üîÑ Inicializando Supabase...');
            supabase = window.supabase.createClient(CONFIG.supabaseUrl, CONFIG.supabaseKey);
            
            supabase.auth.onAuthStateChange((event, session) => {
                currentUser = session?.user || null;
                updateAuthUI();
                console.log('üîê Auth:', event, currentUser?.email || 'Sin usuario');
            });
            
            const { data: { session } } = await supabase.auth.getSession();
            currentUser = session?.user || null;
            updateAuthUI();
            console.log('‚úÖ Supabase inicializado');
            return true;
        } catch (error) {
            console.error('‚ùå Error Supabase:', error);
            return false;
        }
    }
    
    // ‚úÖ CARGAR DATOS - SIN BUCLES INFINITOS
    async function loadData() {
        try {
            showLoading(true);
            console.log('üìä Cargando datos...');
            
            if (!supabase) {
                throw new Error('Supabase no inicializado');
            }
            
            const { data: albums, error: albumError } = await supabase
                .from('albums')
                .select('*')
                .order('created_at', { ascending: false });
            
            if (albumError) throw albumError;
            
            const { data: songs, error: songError } = await supabase
                .from('songs')
                .select('*, albums:album_id(*)')
                .order('created_at', { ascending: false });
            
            if (songError) throw songError;
            
            allAlbums = albums || [];
            allSongs = songs || [];
            
            console.log(`‚úÖ Cargados: ${allAlbums.length} √°lbumes, ${allSongs.length} canciones`);
            displayAlbums();
            
        } catch (error) {
            console.error('‚ùå Error cargando datos:', error);
            document.getElementById('albums').innerHTML = `
                <div style="text-align: center; padding: 2rem; color: #ff4757;">
                    <h3>‚ùå Error de conexi√≥n</h3>
                    <p>${error.message}</p>
                    <button onclick="loadData()" class="btn-primary" style="width: auto; margin-top: 1rem;">üîÑ Reintentar</button>
                </div>
            `;
        } finally {
            showLoading(false);
        }
    }
    
    // ‚úÖ MOSTRAR √ÅLBUMES
    function displayAlbums() {
        const container = document.getElementById('albums');
        
        if (allAlbums.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 2rem; color: #666;">
                    <h3>üìÄ No hay √°lbumes</h3>
                    <p>Inicia sesi√≥n como admin para subir m√∫sica</p>
                    ${currentUser?.email === CONFIG.adminEmail ? '<button onclick="showSection(\'admin\')" class="btn-primary" style="width: auto; margin-top: 1rem;">‚öôÔ∏è Ir al Panel Admin</button>' : ''}
                </div>
            `;
            return;
        }
        
        container.innerHTML = allAlbums.map(album => `
            <div class="album-card" onclick="showAlbum('${album.id}')">
                <img class="album-img" src="${album.cover_url}" alt="${album.title}" 
                     onerror="this.style.background='#333'; this.alt='üéµ';">
                <div class="album-title">${album.title}</div>
                <div class="album-artist">${album.artist}</div>
            </div>
        `).join('');
    }
    
    // ‚úÖ MOSTRAR DETALLES DEL √ÅLBUM
    async function showAlbum(albumId) {
        try {
            console.log('üîç Mostrando √°lbum:', albumId);
            
            const album = allAlbums.find(a => a.id === albumId);
            if (!album) return;
            
            currentAlbum = album;
            
            document.getElementById('albums').style.display = 'none';
            const detail = document.getElementById('album-detail');
            detail.style.display = 'block';
            
            detail.innerHTML = `
                <button class="back-btn" onclick="backToAlbums()">‚üµ Volver</button>
                <div style="text-align: center; margin-bottom: 2rem;">
                    <img src="${album.cover_url}" style="width: 200px; height: 200px; border-radius: 12px;" 
                         onerror="this.style.background='#333';">
                    <h2>${album.title}</h2>
                    <p style="color: #b3b3b3;">${album.artist}</p>
                </div>
                <div id="song-list">üîÑ Cargando canciones...</div>
            `;
            
            const { data: songs } = await supabase
                .from('songs')
                .select('*')
                .eq('album_id', albumId);
            
            const songList = document.getElementById('song-list');
            
            if (!songs || songs.length === 0) {
                songList.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 2rem;">
                        <h3>üì≠ No hay canciones</h3>
                        <p>Este √°lbum a√∫n no tiene canciones</p>
                        ${currentUser?.email === CONFIG.adminEmail ? '<button onclick="showSection(\'admin\')" class="btn-primary" style="width: auto; margin-top: 1rem;">‚öôÔ∏è Subir Canciones</button>' : ''}
                    </div>
                `;
                return;
            }
            
            currentPlaylist = songs;
            
            // Obtener canciones descargadas
            const offlineSongs = await getOfflineSongs();
            const downloadedIds = offlineSongs.map(s => s.id);
            
            songList.innerHTML = `
                <div class="song-list">
                    <ul>
                        ${songs.map((song, idx) => `
                            <li>
                                <span onclick="playSong(${idx})" style="flex: 1; cursor: pointer;">${song.title}</span>
                                <div style="display: flex; gap: 1rem; align-items: center;">
                                    <span class="download-btn ${downloadedIds.includes(song.id) ? 'downloaded' : ''}" 
                                          onclick="downloadSong(${JSON.stringify(song).replace(/"/g, '&quot;')}, ${JSON.stringify(currentAlbum).replace(/"/g, '&quot;')}, this)" 
                                          style="cursor: pointer; color: ${downloadedIds.includes(song.id) ? '#1DB954' : '#666'}; font-size: 1.2rem;" 
                                          title="${downloadedIds.includes(song.id) ? 'Ya descargada' : 'Descargar para offline'}">
                                        ${downloadedIds.includes(song.id) ? '‚úì' : '‚Üì'}
                                    </span>
                                    <span onclick="playSong(${idx})" style="cursor: pointer; color: #1DB954; font-size: 1.2rem;">‚ñ∂</span>
                                </div>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
            
        } catch (error) {
            console.error('‚ùå Error mostrando √°lbum:', error);
        }
    }
    
    // ‚úÖ REPRODUCCI√ìN B√ÅSICA
    function playSong(index) {
        if (!currentPlaylist[index]) return;
        
        const song = currentPlaylist[index];
        currentSong = song;
        currentIndex = index;
        
        console.log('üéµ Reproduciendo:', song.title);
        
        const audio = document.getElementById('audio-player');
        audio.src = song.song_url;
        audio.play();
        
        updatePlayer();
    }
    
    function updatePlayer() {
        const player = document.getElementById('mini-player');
        if (currentSong && currentAlbum) {
            player.style.display = 'flex';
            document.getElementById('player-img').src = currentAlbum.cover_url;
            document.getElementById('player-title').textContent = currentSong.title;
            document.getElementById('player-artist').textContent = currentAlbum.artist;
        }
    }
    
    function togglePlay() {
        const audio = document.getElementById('audio-player');
        const btn = document.getElementById('play-btn');
        
        if (audio.paused) {
            audio.play();
            btn.textContent = '‚è∏';
            isPlaying = true;
        } else {
            audio.pause();
            btn.textContent = '‚ñ∂';
            isPlaying = false;
        }
    }
    
    function backToAlbums() {
        document.getElementById('album-detail').style.display = 'none';
        document.getElementById('albums').style.display = 'grid';
    }
        
        // ‚úÖ SISTEMA DE DESCARGAS COMPLETAMENTE FUNCIONAL
        async function downloadSong(song, album, element) {
            console.log('üì• === INICIANDO DESCARGA ===');
            console.log('Canci√≥n:', song.title);
            console.log('Entorno:', isCordova ? 'Cordova APK' : 'Navegador Web');
            
            if (!song || !song.song_url || !album || !element) {
                alert('‚ùå Error: Datos inv√°lidos para descarga');
                return;
            }
            
            if (element.classList.contains('downloaded')) {
                console.log('‚ö†Ô∏è Canci√≥n ya descargada');
                return;
            }
            
            const originalText = element.textContent;
            const originalColor = element.style.color;
            
            try {
                element.textContent = '‚è≥';
                element.style.color = '#ff9800';
                
                if (isCordova) {
                    await downloadForCordova(song, album);
                } else {
                    await downloadForWeb(song, album);
                }
                
                element.classList.add('downloaded');
                element.textContent = '‚úì';
                element.style.color = '#1DB954';
                
                console.log('‚úÖ Descarga completada exitosamente');
                alert(`‚úÖ "${song.title}" descargada para offline`);
                
            } catch (error) {
                console.error('‚ùå Error en descarga:', error);
                element.textContent = originalText;
                element.style.color = originalColor;
                alert(`‚ùå Error descargando: ${error.message}`);
            }
        }
        
        // ‚úÖ DESCARGA PARA WEB (IndexedDB)
        async function downloadForWeb(song, album) {
            console.log('üåê === DESCARGA WEB INICIADA ===');
            
            try {
                if (!window.indexedDB) {
                    throw new Error('IndexedDB no soportado en este navegador');
                }
                
                console.log('üíæ Abriendo/creando base de datos IndexedDB...');
                
                const db = await new Promise((resolve, reject) => {
                    const request = indexedDB.open('KLMZMusicOfflineDB', 1);
                    
                    request.onerror = () => reject(new Error('Error abriendo IndexedDB'));
                    request.onsuccess = (event) => {
                        console.log('‚úÖ IndexedDB abierta correctamente');
                        resolve(event.target.result);
                    };
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('offline_songs')) {
                            db.createObjectStore('offline_songs', { keyPath: 'id' });
                            console.log('‚úÖ Store de canciones offline creado');
                        }
                    };
                });
                
                console.log('üì• Descargando audio desde:', song.song_url);
                const audioResponse = await fetch(song.song_url);
                if (!audioResponse.ok) {
                    throw new Error(`Error descargando audio: ${audioResponse.status} ${audioResponse.statusText}`);
                }
                const audioBlob = await audioResponse.blob();
                console.log('‚úÖ Audio descargado, tama√±o:', audioBlob.size, 'bytes');
                
                console.log('üì• Descargando portada desde:', album.cover_url);
                const coverResponse = await fetch(album.cover_url);
                const coverBlob = coverResponse.ok ? await coverResponse.blob() : null;
                console.log('‚úÖ Portada descargada');
                
                const offlineData = {
                    id: song.id,
                    title: song.title,
                    artist: album.artist,
                    album: album.title,
                    audioBlob: audioBlob,
                    coverBlob: coverBlob,
                    audioUrl: song.song_url,
                    coverUrl: album.cover_url,
                    downloadedAt: new Date().toISOString(),
                    platform: 'web'
                };
                
                await new Promise((resolve, reject) => {
                    const transaction = db.transaction(['offline_songs'], 'readwrite');
                    const store = transaction.objectStore('offline_songs');
                    const request = store.put(offlineData);
                    
                    request.onsuccess = () => {
                        console.log('‚úÖ Canci√≥n guardada en IndexedDB');
                        resolve();
                    };
                    request.onerror = () => reject(new Error('Error guardando en IndexedDB'));
                });
                
                console.log('‚úÖ === DESCARGA WEB COMPLETADA ===');
                
            } catch (error) {
                console.error('‚ùå Error en downloadForWeb:', error);
                throw error;
            }
        }
        
        // ‚úÖ DESCARGA PARA CORDOVA (Sistema de Archivos)
        async function downloadForCordova(song, album) {
            console.log('üì± === DESCARGA CORDOVA INICIADA ===');
            
            try {
                if (!window.cordova || !window.cordova.file) {
                    throw new Error('cordova-plugin-file no disponible. Instalar: cordova plugin add cordova-plugin-file');
                }
                
                console.log('üìÅ Directorio de datos:', window.cordova.file.dataDirectory);
                
                const safeTitle = song.title.replace(/[^a-zA-Z0-9\-_\s]/g, '').trim();
                const fileName = `${safeTitle}_${song.id}.mp3`;
                
                console.log('üì• Descargando audio...');
                const response = await fetch(song.song_url);
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status} ${response.statusText}`);
                }
                
                const audioBlob = await response.blob();
                console.log('‚úÖ Audio descargado, tama√±o:', audioBlob.size, 'bytes');
                
                await new Promise((resolve, reject) => {
                    window.resolveLocalFileSystemURL(
                        window.cordova.file.dataDirectory,
                        (dirEntry) => {
                            console.log('üìÅ Directorio resuelto:', dirEntry.nativeURL);
                            
                            dirEntry.getFile(fileName, { create: true, exclusive: false }, (fileEntry) => {
                                console.log('üìÑ Archivo creado:', fileEntry.nativeURL);
                                
                                fileEntry.createWriter((fileWriter) => {
                                    fileWriter.onwriteend = () => {
                                        console.log('‚úÖ Archivo guardado exitosamente');
                                        
                                        try {
                                            let offlineSongs = JSON.parse(localStorage.getItem('cordova_offline_songs') || '[]');
                                            
                                            const songData = {
                                                id: song.id,
                                                title: song.title,
                                                artist: album.artist,
                                                album: album.title,
                                                fileName: fileName,
                                                filePath: fileEntry.nativeURL,
                                                originalUrl: song.song_url,
                                                coverUrl: album.cover_url,
                                                downloadedAt: new Date().toISOString(),
                                                platform: 'cordova'
                                            };
                                            
                                            const existingIndex = offlineSongs.findIndex(s => s.id === song.id);
                                            if (existingIndex >= 0) {
                                                offlineSongs[existingIndex] = songData;
                                            } else {
                                                offlineSongs.push(songData);
                                            }
                                            
                                            localStorage.setItem('cordova_offline_songs', JSON.stringify(offlineSongs));
                                            console.log('‚úÖ Metadata guardada');
                                            resolve();
                                            
                                        } catch (metaError) {
                                            console.error('‚ùå Error guardando metadata:', metaError);
                                            reject(metaError);
                                        }
                                    };
                                    
                                    fileWriter.onerror = (error) => {
                                        console.error('‚ùå Error escribiendo archivo:', error);
                                        reject(error);
                                    };
                                    
                                    console.log('üìù Escribiendo datos al archivo...');
                                    fileWriter.write(audioBlob);
                                    
                                }, reject);
                            }, reject);
                        },
                        reject
                    );
                });
                
                console.log('‚úÖ === DESCARGA CORDOVA COMPLETADA ===');
                
            } catch (error) {
                console.error('‚ùå Error en downloadForCordova:', error);
                throw error;
            }
        }
        
        // ‚úÖ OBTENER CANCIONES DESCARGADAS
        async function getOfflineSongs() {
            try {
                if (isCordova) {
                    const stored = localStorage.getItem('cordova_offline_songs');
                    return stored ? JSON.parse(stored) : [];
                } else {
                    if (!window.indexedDB) return [];
                    
                    const db = await new Promise((resolve) => {
                        const request = indexedDB.open('KLMZMusicOfflineDB', 1);
                        request.onerror = () => resolve(null);
                        request.onsuccess = (event) => resolve(event.target.result);
                        request.onupgradeneeded = (event) => {
                            const db = event.target.result;
                            if (!db.objectStoreNames.contains('offline_songs')) {
                                db.createObjectStore('offline_songs', { keyPath: 'id' });
                            }
                            resolve(db);
                        };
                    });
                    
                    if (!db) return [];
                    
                    return await new Promise((resolve) => {
                        const transaction = db.transaction(['offline_songs'], 'readonly');
                        const store = transaction.objectStore('offline_songs');
                        const request = store.getAll();
                        request.onsuccess = () => resolve(request.result || []);
                        request.onerror = () => resolve([]);
                    });
                }
            } catch (error) {
                console.error('‚ùå Error obteniendo canciones offline:', error);
                return [];
            }
        }
        
        // ‚úÖ CARGAR SECCI√ìN DE DESCARGAS
        async function loadDownloads() {
            console.log('üì• Cargando secci√≥n de descargas...');
            
            try {
                showLoading(true);
                const offlineSongs = await getOfflineSongs();
                const content = document.getElementById('downloads-content');
                
                if (offlineSongs.length === 0) {
                    content.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #666;">
                            <h3>üì• No tienes canciones offline</h3>
                            <p>Descarga canciones desde cualquier √°lbum presionando el bot√≥n ‚Üì</p>
                            <p style="font-size: 0.9rem; margin-top: 1rem;">
                                <strong>Entorno:</strong> ${isCordova ? 'üì± Android APK' : 'üåê Navegador Web'}
                            </p>
                        </div>
                    `;
                    return;
                }
                
                console.log(`üì± Encontradas ${offlineSongs.length} canciones offline`);
                
                content.innerHTML = `
                    <div style="margin-bottom: 1rem; text-align: center; color: #1DB954;">
                        <strong>${offlineSongs.length} canciones offline ‚Ä¢ ${isCordova ? 'üì± APK' : 'üåê Web'}</strong>
                    </div>
                    <div class="downloads-list">
                        ${offlineSongs.map(song => `
                            <div onclick="playOfflineSong('${song.id}')" style="background: #242424; padding: 1rem; margin-bottom: 0.8rem; border-radius: 8px; cursor: pointer; border-left: 3px solid #1DB954;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: bold; margin-bottom: 0.3rem;">${song.title}</div>
                                        <div style="font-size: 0.9rem; color: #b3b3b3;">${song.artist} ‚Ä¢ ${song.album}</div>
                                        <small style="color: #666; font-size: 0.8rem;">
                                            üìÖ ${new Date(song.downloadedAt).toLocaleDateString()} 
                                            üì± ${song.platform}
                                        </small>
                                    </div>
                                    <div style="color: #1DB954; font-size: 1.5rem;">‚úì</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
            } catch (error) {
                console.error('‚ùå Error cargando descargas:', error);
                document.getElementById('downloads-content').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #ff4757;">
                        <h3>‚ùå Error cargando descargas</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            } finally {
                showLoading(false);
            }
        }
        
        // ‚úÖ REPRODUCIR CANCI√ìN OFFLINE
        async function playOfflineSong(songId) {
            try {
                console.log('üéµ Reproduciendo canci√≥n offline:', songId);
                
                const offlineSongs = await getOfflineSongs();
                const song = offlineSongs.find(s => s.id === songId);
                
                if (!song) {
                    alert('‚ùå Canci√≥n offline no encontrada');
                    return;
                }
                
                let audioSrc;
                
                if (isCordova) {
                    audioSrc = song.filePath;
                } else {
                    audioSrc = URL.createObjectURL(song.audioBlob);
                }
                
                const songData = {
                    id: song.id,
                    title: song.title,
                    song_url: audioSrc
                };
                
                const albumData = {
                    title: song.album,
                    artist: song.artist,
                    cover_url: song.coverUrl
                };
                
                console.log('üéµ Iniciando reproducci√≥n offline:', song.title);
                
                currentSong = songData;
                currentAlbum = albumData;
                
                const audio = document.getElementById('audio-player');
                audio.src = audioSrc;
                audio.play();
                updatePlayer();
                
                console.log('‚úÖ Reproducci√≥n offline iniciada');
                
            } catch (error) {
                console.error('‚ùå Error reproduciendo canci√≥n offline:', error);
                alert('‚ùå Error reproduciendo canci√≥n offline: ' + error.message);
            }
        }
        
        // ‚úÖ PANEL ADMIN FUNCIONAL
        function loadAdminPanel() {
            const content = document.getElementById('admin-content');
            content.innerHTML = `
                <div style="margin-bottom: 1rem; text-align: center; color: #1DB954;">
                    <strong>Panel de Administraci√≥n ‚Ä¢ Usuario: ${currentUser?.email}</strong>
                </div>
                
                <div class="admin-section">
                    <h3>üìÄ Crear √Ålbum</h3>
                    <form onsubmit="createAlbum(event)">
                        <div class="form-group">
                            <input type="text" id="album-title" placeholder="T√≠tulo del √°lbum" required>
                        </div>
                        <div class="form-group">
                            <input type="text" id="album-artist" placeholder="Artista" required>
                        </div>
                        <div class="form-group">
                            <input type="file" id="album-cover" accept="image/*" required>
                        </div>
                        <button type="submit" class="btn-primary">üì§ Crear √Ålbum</button>
                    </form>
                </div>
                
                <div class="admin-section">
                    <h3>üéµ Subir Canciones</h3>
                    <form onsubmit="uploadSongs(event)">
                        <div class="form-group">
                            <select id="song-album" required>
                                <option value="">Seleccionar √°lbum...</option>
                                ${allAlbums.map(a => `<option value="${a.id}">${a.title} - ${a.artist}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <input type="file" id="song-files" accept="audio/*" multiple required>
                        </div>
                        <button type="submit" class="btn-primary">üì§ Subir Canciones</button>
                    </form>
                    <div id="upload-progress"></div>
                </div>
                
                <div class="admin-section">
                    <h3>üìä Estad√≠sticas</h3>
                    <p><strong>√Ålbumes:</strong> ${allAlbums.length}</p>
                    <p><strong>Canciones:</strong> ${allSongs.length}</p>
                    <p><strong>Entorno:</strong> ${isCordova ? 'üì± APK' : 'üåê Web'}</p>
                    <button onclick="loadData()" class="btn-primary">üîÑ Recargar Datos</button>
                </div>
            `;
        }
        
        async function createAlbum(event) {
            event.preventDefault();
            
            try {
                showLoading(true);
                
                const title = document.getElementById('album-title').value;
                const artist = document.getElementById('album-artist').value;
                const coverFile = document.getElementById('album-cover').files[0];
                
                if (!coverFile) {
                    alert('‚ùå Selecciona una portada');
                    return;
                }
                
                const coverUrl = await uploadToAppwrite(coverFile);
                
                const { data, error } = await supabase
                    .from('albums')
                    .insert([{ title, artist, cover_url: coverUrl }]);
                
                if (error) throw error;
                
                alert('‚úÖ √Ålbum creado exitosamente');
                document.getElementById('album-title').value = '';
                document.getElementById('album-artist').value = '';
                document.getElementById('album-cover').value = '';
                
                await loadData();
                loadAdminPanel();
                
            } catch (error) {
                console.error('‚ùå Error creando √°lbum:', error);
                alert('‚ùå Error: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        async function uploadSongs(event) {
            event.preventDefault();
            
            try {
                const albumId = document.getElementById('song-album').value;
                const files = document.getElementById('song-files').files;
                
                if (!albumId || files.length === 0) {
                    alert('‚ùå Selecciona √°lbum y archivos');
                    return;
                }
                
                const progress = document.getElementById('upload-progress');
                let uploaded = 0;
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    progress.innerHTML = `<div class="upload-progress">üì§ Subiendo ${file.name}... (${i + 1}/${files.length})</div>`;
                    
                    try {
                        const songUrl = await uploadToAppwrite(file);
                        const title = file.name.replace(/\.[^/.]+$/, '');
                        
                        const { error } = await supabase
                            .from('songs')
                            .insert([{ title, album_id: albumId, song_url: songUrl }]);
                        
                        if (error) throw error;
                        uploaded++;
                        
                        progress.innerHTML = `<div class="upload-progress success">‚úÖ ${file.name} subido</div>`;
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                    } catch (err) {
                        console.error('Error subiendo', file.name, err);
                        progress.innerHTML = `<div class="upload-progress error">‚ùå Error con ${file.name}</div>`;
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
                
                alert(`‚úÖ ${uploaded}/${files.length} canciones subidas exitosamente`);
                document.getElementById('song-files').value = '';
                progress.innerHTML = '';
                
                await loadData();
                loadAdminPanel();
                
            } catch (error) {
                console.error('‚ùå Error subiendo canciones:', error);
                alert('‚ùå Error: ' + error.message);
            }
        }
        
        async function uploadToAppwrite(file) {
            try {
                const client = new window.Appwrite.Client()
                    .setEndpoint('https://nyc.cloud.appwrite.io/v1')
                    .setProject('68ab0cf2000365979a71');
                
                const storage = new window.Appwrite.Storage(client);
                const response = await storage.createFile('68ad019f00207b1df467', window.Appwrite.ID.unique(), file);
                
                return `https://nyc.cloud.appwrite.io/v1/storage/buckets/68ad019f00207b1df467/files/${response.$id}/view?project=68ab0cf2000365979a71`;
                
            } catch (error) {
                console.error('‚ùå Error Appwrite:', error);
                throw error;
            }
        }
        
        // ‚úÖ AUTENTICACI√ìN
        function updateAuthUI() {
            const adminBtn = document.getElementById('adminBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const lockIcon = document.querySelector('.lock-icon');
            
            if (currentUser) {
                lockIcon.textContent = 'üë§';
                logoutBtn.style.display = 'block';
                
                if (currentUser.email === CONFIG.adminEmail) {
                    adminBtn.style.display = 'block';
                    lockIcon.textContent = '‚öôÔ∏è';
                }
            } else {
                lockIcon.textContent = 'üîí';
                adminBtn.style.display = 'none';
                logoutBtn.style.display = 'none';
            }
        }
        
        async function login(event) {
            event.preventDefault();
            
            try {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                
                const { error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;
                
                alert('‚úÖ ¬°Bienvenido!');
                closeModal();
                
            } catch (error) {
                console.error('‚ùå Error login:', error);
                alert('‚ùå Error: ' + error.message);
            }
        }
        
        async function register(event) {
            event.preventDefault();
            
            try {
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const confirm = document.getElementById('register-confirm').value;
                
                if (password !== confirm) {
                    alert('‚ùå Las contrase√±as no coinciden');
                    return;
                }
                
                const { error } = await supabase.auth.signUp({ email, password });
                if (error) throw error;
                
                alert('‚úÖ Registro exitoso. Revisa tu email.');
                closeModal();
                
            } catch (error) {
                console.error('‚ùå Error registro:', error);
                alert('‚ùå Error: ' + error.message);
            }
        }
        
        async function logout() {
            try {
                await supabase.auth.signOut();
                alert('‚úÖ Sesi√≥n cerrada');
                showSection('home');
            } catch (error) {
                console.error('‚ùå Error logout:', error);
            }
        }
        
        // ‚úÖ NAVEGACI√ìN
        function showSection(sectionName) {
            console.log('üß≠ Navegando a:', sectionName);
            
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.bottom-nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById(sectionName + '-section').classList.add('active');
            event.target.closest('.bottom-nav-item')?.classList.add('active');
            
            if (sectionName === 'admin') {
                if (!currentUser || currentUser.email !== CONFIG.adminEmail) {
                    alert('üîí Solo el administrador puede acceder');
                    showSection('home');
                    return;
                }
                loadAdminPanel();
            }
            
            if (sectionName === 'downloads') {
                loadDownloads();
            }
        }
        
        // ‚úÖ B√öSQUEDA
        function searchMusic() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const results = document.getElementById('search-results');
            
            if (!query) {
                results.innerHTML = '';
                return;
            }
            
            const found = allSongs.filter(s => 
                s.title.toLowerCase().includes(query) || 
                s.albums?.artist?.toLowerCase().includes(query)
            );
            
            if (found.length === 0) {
                results.innerHTML = '<p style="color: #666;">No se encontraron resultados</p>';
                return;
            }
            
            results.innerHTML = found.map(song => `
                <div style="padding: 1rem; background: #242424; margin: 0.5rem 0; border-radius: 8px; cursor: pointer;" 
                     onclick="playSongById('${song.id}')">
                    <strong>${song.title}</strong><br>
                    <small style="color: #b3b3b3;">${song.albums?.artist || 'Desconocido'}</small>
                </div>
            `).join('');
        }
        
        function playSongById(songId) {
            const song = allSongs.find(s => s.id === songId);
            if (song) {
                currentSong = song;
                currentAlbum = allAlbums.find(a => a.id === song.album_id);
                
                const audio = document.getElementById('audio-player');
                audio.src = song.song_url;
                audio.play();
                updatePlayer();
            }
        }
        
        // ‚úÖ FUNCIONES DE INTERFAZ
        function toggleUserMenu() {
            document.getElementById('userDropdown').classList.toggle('show');
        }
        
        function showAuth(type) {
            document.getElementById('userDropdown').classList.remove('show');
            document.getElementById('login-form').style.display = type === 'login' ? 'block' : 'none';
            document.getElementById('register-form').style.display = type === 'register' ? 'block' : 'none';
            document.getElementById('auth-modal').style.display = 'flex';
        }
        
        function closeModal() {
            document.getElementById('auth-modal').style.display = 'none';
        }
        
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        // ‚úÖ INICIALIZACI√ìN FINAL - SIN BUCLES
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ === INICIALIZANDO KLMZ MUSIC ===');
            
            try {
                loadTheme();
                detectEnvironment();
                
                const supabaseOk = await initSupabase();
                
                if (supabaseOk) {
                    await loadData();
                    console.log('‚úÖ === APLICACI√ìN INICIADA CORRECTAMENTE ===');
                } else {
                    console.error('‚ùå Error inicializando aplicaci√≥n');
                }
                
                const audio = document.getElementById('audio-player');
                audio.addEventListener('ended', () => {
                    isPlaying = false;
                    document.getElementById('play-btn').textContent = '‚ñ∂';
                });
                
            } catch (error) {
                console.error('‚ùå Error cr√≠tico:', error);
                showLoading(false);
            }
        });
        
        // Para Cordova
        document.addEventListener('deviceready', () => {
            console.log('üì± === CORDOVA DEVICE READY ===');
            detectEnvironment();
        }, false);
        
        // ‚úÖ ASEGURAR FUNCIONES GLOBALES
        window.downloadSong = downloadSong;
        window.playOfflineSong = playOfflineSong;
        window.getOfflineSongs = getOfflineSongs;
        
        console.log('‚úÖ === SCRIPT CARGADO COMPLETAMENTE ===');
    </script>
</body>
</html>
