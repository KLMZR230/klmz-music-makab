<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KLMZ MUSIC</title>
    
    <!-- Enlace al manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Meta tags para PWA -->
    <meta name="theme-color" content="#000000">
    <meta name="description" content="Aplicaci√≥n de m√∫sica desarrollada por Freddy Granados">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .loading {
            text-align: center;
            color: white;
            font-size: 18px;
            margin: 50px 0;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .albums-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .album-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: transform 0.3s ease;
            cursor: pointer;
        }

        .album-card:hover {
            transform: translateY(-5px);
        }

        .album-cover {
            width: 100%;
            height: 150px;
            background: #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
            background-size: cover;
            background-position: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .music-player {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .player-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
            margin: 15px 0;
            cursor: pointer;
        }

        .progress {
            height: 100%;
            background: #667eea;
            border-radius: 3px;
            width: 0%;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }

        .close {
            position: absolute;
            right: 20px;
            top: 15px;
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }

        .close:hover {
            color: #333;
        }

        .tab-buttons {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .tab-button {
            background: none;
            border: none;
            padding: 15px 25px;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .bottom-nav {
            position: fixed;
            bottom: 80px;
            left: 0;
            right: 0;
            background: white;
            padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 999;
        }

        .nav-items {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .nav-item {
            text-align: center;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            transition: background 0.3s ease;
        }

        .nav-item:hover {
            background: #f0f0f0;
        }

        .nav-item.active {
            color: #667eea;
        }

        .upload-progress {
            width: 100%;
            height: 4px;
            background: #eee;
            border-radius: 2px;
            margin: 10px 0;
            overflow: hidden;
        }

        .upload-progress-bar {
            height: 100%;
            background: #667eea;
            width: 0%;
            transition: width 0.3s ease;
        }

        .error-message {
            background: #ff6b6b;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }

        .success-message {
            background: #4ecdc4;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .albums-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 15px;
            }
            
            .modal-content {
                width: 95%;
                margin: 10% auto;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéµ KLMZ MUSIC</h1>
            <p>Tu plataforma musical favorita</p>
        </div>

        <!-- Secci√≥n de Albums -->
        <div class="section" id="albums-section">
            <h2>Albums</h2>
            <div id="albums-container">
                <div class="loading">Cargando √°lbumes...</div>
                <div class="albums-grid" id="albums-grid" style="display: none;"></div>
            </div>
        </div>

        <!-- Secci√≥n de B√∫squeda -->
        <div class="section" id="search-section" style="display: none;">
            <h2>Buscar m√∫sica</h2>
            <div class="form-group">
                <input type="text" id="search-input" placeholder="Buscar canciones, artistas, √°lbumes...">
            </div>
            <div id="search-results"></div>
        </div>

        <!-- Secci√≥n de Favoritos -->
        <div class="section" id="favorites-section" style="display: none;">
            <h2>‚ù§Ô∏è Mis Favoritos</h2>
            <div id="favorites-list">
                <p>No tienes favoritos</p>
            </div>
        </div>

        <!-- Secci√≥n de Descargas -->
        <div class="section" id="downloads-section" style="display: none;">
            <h2>‚Üì Mis Descargas</h2>
            <div id="downloads-list">
                <p>No tienes canciones descargadas</p>
            </div>
        </div>

        <!-- Secci√≥n de Administraci√≥n -->
        <div class="section" id="admin-section" style="display: none;">
            <h2>‚öôÔ∏è Panel de Administraci√≥n</h2>
            
            <!-- Formulario de subida de √°lbum CORREGIDO -->
            <h3>Subir Nuevo √Ålbum</h3>
            <form id="album-upload-form" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="album-title">T√≠tulo del √Ålbum:</label>
                    <input type="text" id="album-title" name="titulo" required>
                </div>
                <div class="form-group">
                    <label for="album-artist">Artista:</label>
                    <input type="text" id="album-artist" name="artista" required>
                </div>
                <div class="form-group">
                    <label for="album-cover">Portada del √Ålbum:</label>
                    <input type="file" id="album-cover" name="portada" accept="image/*">
                </div>
                <div class="upload-progress" style="display: none;">
                    <div class="upload-progress-bar"></div>
                </div>
                <button type="submit" class="btn">Crear √Ålbum</button>
            </form>

            <hr style="margin: 30px 0;">

            <!-- Formulario de subida de canci√≥n CORREGIDO -->
            <h3>Subir Nueva Canci√≥n</h3>
            <form id="song-upload-form" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="song-album">√Ålbum:</label>
                    <select id="song-album" name="album_id" required>
                        <option value="">Selecciona un √°lbum</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="song-title">T√≠tulo de la Canci√≥n:</label>
                    <input type="text" id="song-title" name="titulo" required>
                </div>
                <div class="form-group">
                    <label for="song-file">Archivo de Audio:</label>
                    <input type="file" id="song-file" name="audio" accept="audio/*" required>
                </div>
                <div class="upload-progress" style="display: none;">
                    <div class="upload-progress-bar"></div>
                </div>
                <button type="submit" class="btn">Subir Canci√≥n</button>
            </form>
        </div>
    </div>

    <!-- Navegaci√≥n inferior -->
    <div class="bottom-nav">
        <div class="nav-items">
            <div class="nav-item active" data-section="albums">
                <div>üè†</div>
                <small>Inicio</small>
            </div>
            <div class="nav-item" data-section="search">
                <div>üîç</div>
                <small>Buscar</small>
            </div>
            <div class="nav-item" data-section="downloads">
                <div>‚¨áÔ∏è</div>
                <small>Descargas</small>
            </div>
            <div class="nav-item" data-section="favorites">
                <div>‚ù§Ô∏è</div>
                <small>Favoritos</small>
            </div>
        </div>
    </div>

    <!-- Reproductor de m√∫sica -->
    <div class="music-player">
        <div class="progress-bar">
            <div class="progress"></div>
        </div>
        <div class="player-controls">
            <button id="prev-btn">‚èÆÔ∏è</button>
            <button id="play-btn">‚ñ∂Ô∏è</button>
            <button id="next-btn">‚è≠Ô∏è</button>
            <span id="current-time">0:00</span>
            <span>/</span>
            <span id="duration">0:00</span>
        </div>
        <div style="text-align: center; margin-top: 10px;">
            <strong id="current-song">Selecciona una canci√≥n</strong>
        </div>
    </div>

    <!-- Modal de Login/Registro -->
    <div id="auth-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            
            <div class="tab-buttons">
                <button class="tab-button active" data-tab="login">Iniciar sesi√≥n</button>
                <button class="tab-button" data-tab="register">Registrarse</button>
            </div>

            <!-- Login Tab -->
            <div id="login-tab" class="tab-content active">
                <h2>Iniciar sesi√≥n</h2>
                <form id="login-form" enctype="application/x-www-form-urlencoded">
                    <div class="form-group">
                        <label for="login-email">Email:</label>
                        <input type="email" id="login-email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">Contrase√±a:</label>
                        <input type="password" id="login-password" name="password" required>
                    </div>
                    <button type="submit" class="btn">Iniciar sesi√≥n</button>
                </form>
                <p style="text-align: center; margin-top: 15px;">
                    ¬øNo tienes cuenta? <a href="#" id="show-register">Reg√≠strate</a>
                </p>
            </div>

            <!-- Register Tab -->
            <div id="register-tab" class="tab-content">
                <h2>Registrarse</h2>
                <form id="register-form" enctype="application/x-www-form-urlencoded">
                    <div class="form-group">
                        <label for="register-email">Email:</label>
                        <input type="email" id="register-email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="register-password">Contrase√±a:</label>
                        <input type="password" id="register-password" name="password" required>
                    </div>
                    <div class="form-group">
                        <label for="register-confirm">Confirmar contrase√±a:</label>
                        <input type="password" id="register-confirm" name="confirmPassword" required>
                    </div>
                    <button type="submit" class="btn">Registrarse</button>
                </form>
                <p style="text-align: center; margin-top: 15px;">
                    ¬øYa tienes cuenta? <a href="#" id="show-login">Inicia sesi√≥n</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Modal de Edici√≥n de √Ålbum -->
    <div id="edit-album-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>‚úèÔ∏è Editar √Ålbum</h2>
            <form id="edit-album-form" enctype="multipart/form-data">
                <input type="hidden" id="edit-album-id" name="album_id">
                <div class="form-group">
                    <label for="edit-album-title">T√≠tulo del √Ålbum:</label>
                    <input type="text" id="edit-album-title" name="titulo" required>
                </div>
                <div class="form-group">
                    <label for="edit-album-artist">Artista:</label>
                    <input type="text" id="edit-album-artist" name="artista" required>
                </div>
                <div class="form-group">
                    <label for="edit-album-cover">Nueva Portada (Opcional):</label>
                    <input type="file" id="edit-album-cover" name="portada" accept="image/*">
                </div>
                <button type="submit" class="btn">üíæ Guardar Cambios</button>
            </form>
        </div>
    </div>

    <!-- Modal de Edici√≥n de Canci√≥n -->
    <div id="edit-song-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>‚úèÔ∏è Editar Canci√≥n</h2>
            <form id="edit-song-form" enctype="application/x-www-form-urlencoded">
                <input type="hidden" id="edit-song-id" name="song_id">
                <div class="form-group">
                    <label for="edit-song-title">T√≠tulo de la Canci√≥n:</label>
                    <input type="text" id="edit-song-title" name="titulo" required>
                </div>
                <button type="submit" class="btn">üíæ Guardar Cambios</button>
            </form>
        </div>
    </div>

    <!-- Mensajes -->
    <div class="error-message" id="error-message"></div>
    <div class="success-message" id="success-message"></div>

    <footer style="text-align: center; padding: 40px 20px 120px; color: white;">
        <p>¬© 2025 KLMZ MUSIC - Desarrollado por Freddy Granados</p>
    </footer>

    <script>
        // Configuraci√≥n de Supabase
        const SUPABASE_URL = 'https://nqbldvpnqhngdtalvzov.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xYmxkdnBucWhuZ2R0YWx2em92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU3ODMwMzQsImV4cCI6MjA1MTM1OTAzNH0.PYM3M2_fBCBYkKnNS1TE0tsqPoSVU1fB8DN2utGLhCs'; // Reemplaza con tu key real

        // Variables globales
        let currentUser = null;
        let albums = [];
        let songs = [];
        let currentPlaylist = [];
        let currentSongIndex = 0;
        let audioPlayer = null;
        let isPlaying = false;

        // Funci√≥n de subida CORREGIDA con mejor manejo de errores
        async function uploadFile(file, endpoint = 'generate-upload-url') {
            try {
                console.log('Iniciando subida de archivo:', file.name);
                showMessage(`Subiendo ${file.name}...`, 'info');
                
                // Mostrar barra de progreso
                const progressBar = document.querySelector('.upload-progress');
                const progressFill = document.querySelector('.upload-progress-bar');
                if (progressBar) {
                    progressBar.style.display = 'block';
                    progressFill.style.width = '10%';
                }
                
                // Obtener URL de subida
                const uploadUrlResponse = await fetch(
                    `${SUPABASE_URL}/functions/v1/${endpoint}`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'apikey': SUPABASE_KEY
                        },
                        body: JSON.stringify({
                            filename: file.name,
                            contentType: file.type,
                            size: file.size
                        })
                    }
                );

                if (progressFill) progressFill.style.width = '30%';

                // Verificar respuesta
                if (!uploadUrlResponse.ok) {
                    const errorText = await uploadUrlResponse.text();
                    throw new Error(`Error ${uploadUrlResponse.status}: ${errorText}`);
                }

                const uploadData = await uploadUrlResponse.json();
                
                if (!uploadData.uploadUrl) {
                    throw new Error('No se recibi√≥ URL de subida v√°lida');
                }

                console.log('URL de subida obtenida:', uploadData.uploadUrl);
                if (progressFill) progressFill.style.width = '50%';

                // Subir archivo
                const uploadResponse = await fetch(uploadData.uploadUrl, {
                    method: 'PUT',
                    body: file,
                    headers: {
                        'Content-Type': file.type
                    }
                });

                if (progressFill) progressFill.style.width = '90%';

                if (!uploadResponse.ok) {
                    throw new Error(`Error al subir archivo: ${uploadResponse.status} ${uploadResponse.statusText}`);
                }

                if (progressFill) progressFill.style.width = '100%';
                
                setTimeout(() => {
                    if (progressBar) progressBar.style.display = 'none';
                    if (progressFill) progressFill.style.width = '0%';
                }, 1000);

                console.log('Archivo subido exitosamente');
                return {
                    success: true,
                    url: uploadData.publicUrl || uploadData.uploadUrl,
                    filename: file.name
                };

            } catch (error) {
                console.error('Error detallado en la subida:', error);
                
                // Ocultar barra de progreso en caso de error
                const progressBar = document.querySelector('.upload-progress');
                if (progressBar) progressBar.style.display = 'none';
                
                // Manejo espec√≠fico de errores CORS
                if (error.message.includes('CORS') || error.message.includes('Failed to fetch')) {
                    throw new Error('Error de conexi√≥n. Verifica la configuraci√≥n CORS del servidor.');
                }
                
                throw error;
            }
        }

        // Funci√≥n para mostrar mensajes
        function showMessage(message, type = 'info') {
            const errorDiv = document.getElementById('error-message');
            const successDiv = document.getElementById('success-message');
            
            // Ocultar mensajes existentes
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';
            
            if (type === 'error') {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                setTimeout(() => errorDiv.style.display = 'none', 5000);
            } else if (type === 'success') {
                successDiv.textContent = message;
                successDiv.style.display = 'block';
                setTimeout(() => successDiv.style.display = 'none', 3000);
            } else {
                console.log(message);
            }
        }

        // Navegaci√≥n entre secciones
        function showSection(sectionName) {
            // Ocultar todas las secciones
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Mostrar secci√≥n seleccionada
            const targetSection = document.getElementById(`${sectionName}-section`);
            if (targetSection) {
                targetSection.style.display = 'block';
            }
            
            // Actualizar navegaci√≥n activa
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const activeNav = document.querySelector(`[data-section="${sectionName}"]`);
            if (activeNav) {
                activeNav.classList.add('active');
            }
        }

        // Manejo de tabs en modales
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(`${tabName}-tab`).classList.add('active');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        }

        // Event listeners principales
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Inicializando aplicaci√≥n...');
            
            // Navegaci√≥n
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    showSection(section);
                });
            });

            // Tabs en modales
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    const tab = this.getAttribute('data-tab');
                    switchTab(tab);
                });
            });

            // Cerrar modales
            document.querySelectorAll('.close').forEach(closeBtn => {
                closeBtn.addEventListener('click', function() {
                    this.closest('.modal').style.display = 'none';
                });
            });

            // Cerrar modal al hacer clic fuera
            window.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });

            // Enlaces de cambio entre login y registro
            document.getElementById('show-register').addEventListener('click', function(e) {
                e.preventDefault();
                switchTab('register');
            });

            document.getElementById('show-login').addEventListener('click', function(e) {
                e.preventDefault();
                switchTab('login');
            });

            // Formulario de √°lbum
            const albumForm = document.getElementById('album-upload-form');
            if (albumForm) {
                albumForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const formData = new FormData(this);
                    const portadaFile = formData.get('portada');
                    
                    try {
                        let portadaUrl = null;
                        
                        if (portadaFile && portadaFile.size > 0) {
                            console.log('Subiendo portada...');
                            const uploadResult = await uploadFile(portadaFile, 'upload-image');
                            portadaUrl = uploadResult.url;
                        }
                        
                        // Aqu√≠ enviar√≠as los datos del √°lbum a tu base de datos
                        const albumData = {
                            titulo: formData.get('titulo'),
                            artista: formData.get('artista'),
                            portada: portadaUrl
                        };
                        
                        console.log('√Ålbum creado:', albumData);
                        showMessage('√Ålbum subido exitosamente', 'success');
                        this.reset();
                        
                    } catch (error) {
                        console.error('Error al subir √°lbum:', error);
                        showMessage(`Error: ${error.message}`, 'error');
                    }
                });
            }

            // Formulario de canci√≥n
            const songForm = document.getElementById('song-upload-form');
            if (songForm) {
                songForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const formData = new FormData(this);
                    const audioFile = formData.get('audio');
                    
                    if (!audioFile || audioFile.size === 0) {
                        showMessage('Por favor selecciona un archivo de audio', 'error');
                        return;
                    }
                    
                    try {
                        console.log('Subiendo canci√≥n...');
                        const uploadResult = await uploadFile(audioFile, 'upload-audio');
                        
                        const songData = {
                            titulo: formData.get('titulo'),
                            album_id: formData.get('album_id'),
                            audio_url: uploadResult.url,
                            filename: uploadResult.filename
                        };
                        
                        console.log('Canci√≥n subida:', songData);
                        showMessage('Canci√≥n subida exitosamente', 'success');
                        this.reset();
                        
                    } catch (error) {
                        console.error('Error al subir canci√≥n:', error);
                        showMessage(`Error: ${error.message}`, 'error');
                    }
                });
            }

            // Formulario de login
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const formData = new FormData(this);
                    
                    try {
                        const response = await fetch(`${SUPABASE_URL}/auth/v1/token?grant_type=password`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'apikey': SUPABASE_KEY
                            },
                            body: JSON.stringify({
                                email: formData.get('email'),
                                password: formData.get('password')
                            })
                        });

                        if (!response.ok) {
                            throw new Error('Credenciales incorrectas');
                        }

                        const data = await response.json();
                        console.log('Login exitoso:', data);
                        currentUser = data.user;
                        
                        showMessage('Sesi√≥n iniciada exitosamente', 'success');
                        document.getElementById('auth-modal').style.display = 'none';
                        
                        // Mostrar secci√≥n de administraci√≥n si es admin
                        if (data.user.role === 'admin') {
                            document.getElementById('admin-section').style.display = 'block';
                        }
                        
                    } catch (error) {
                        console.error('Error en login:', error);
                        showMessage(`Error: ${error.message}`, 'error');
                    }
                });
            }

            // Formulario de registro
            const registerForm = document.getElementById('register-form');
            if (registerForm) {
                registerForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const formData = new FormData(this);
                    const password = formData.get('password');
                    const confirmPassword = formData.get('confirmPassword');
                    
                    if (password !== confirmPassword) {
                        showMessage('Las contrase√±as no coinciden', 'error');
                        return;
                    }
                    
                    try {
                        const response = await fetch(`${SUPABASE_URL}/auth/v1/signup`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'apikey': SUPABASE_KEY
                            },
                            body: JSON.stringify({
                                email: formData.get('email'),
                                password: password
                            })
                        });

                        if (!response.ok) {
                            throw new Error('Error al crear cuenta');
                        }

                        const data = await response.json();
                        console.log('Registro exitoso:', data);
                        
                        showMessage('Cuenta creada exitosamente', 'success');
                        switchTab('login');
                        
                    } catch (error) {
                        console.error('Error en registro:', error);
                        showMessage(`Error: ${error.message}`, 'error');
                    }
                });
            }

            // Controles de reproductor
            const playBtn = document.getElementById('play-btn');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');

            if (playBtn) {
                playBtn.addEventListener('click', togglePlay);
            }
            
            if (prevBtn) {
                prevBtn.addEventListener('click', previousSong);
            }
            
            if (nextBtn) {
                nextBtn.addEventListener('click', nextSong);
            }

            // Inicializar aplicaci√≥n
            loadAlbums();
            
            // Mostrar modal de login si no hay usuario
            if (!currentUser) {
                setTimeout(() => {
                    document.getElementById('auth-modal').style.display = 'block';
                }, 1000);
            }
        });

        // Funciones del reproductor
        function togglePlay() {
            if (audioPlayer && currentPlaylist.length > 0) {
                if (isPlaying) {
                    audioPlayer.pause();
                    document.getElementById('play-btn').textContent = '‚ñ∂Ô∏è';
                    isPlaying = false;
                } else {
                    audioPlayer.play();
                    document.getElementById('play-btn').textContent = '‚è∏Ô∏è';
                    isPlaying = true;
                }
            }
        }

        function previousSong() {
            if (currentPlaylist.length > 0) {
                currentSongIndex = (currentSongIndex - 1 + currentPlaylist.length) % currentPlaylist.length;
                loadCurrentSong();
            }
        }

        function nextSong() {
            if (currentPlaylist.length > 0) {
                currentSongIndex = (currentSongIndex + 1) % currentPlaylist.length;
                loadCurrentSong();
            }
        }

        function loadCurrentSong() {
            if (currentPlaylist.length > 0 && currentPlaylist[currentSongIndex]) {
                const song = currentPlaylist[currentSongIndex];
                
                if (audioPlayer) {
                    audioPlayer.pause();
                }
                
                audioPlayer = new Audio(song.audio_url);
                document.getElementById('current-song').textContent = song.titulo;
                
                audioPlayer.addEventListener('loadedmetadata', function() {
                    document.getElementById('duration').textContent = formatTime(audioPlayer.duration);
                });
                
                audioPlayer.addEventListener('timeupdate', function() {
                    const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                    document.querySelector('.progress').style.width = progress + '%';
                    document.getElementById('current-time').textContent = formatTime(audioPlayer.currentTime);
                });
                
                audioPlayer.addEventListener('ended', function() {
                    nextSong();
                });
                
                if (isPlaying) {
                    audioPlayer.play();
                }
            }
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Funci√≥n para cargar √°lbumes
        async function loadAlbums() {
            try {
                // Simular carga de √°lbumes - aqu√≠ har√≠as la petici√≥n real a tu API
                setTimeout(() => {
                    const albumsContainer = document.getElementById('albums-grid');
                    const loadingDiv = document.querySelector('#albums-container .loading');
                    
                    if (loadingDiv) loadingDiv.style.display = 'none';
                    if (albumsContainer) albumsContainer.style.display = 'grid';
                    
                    // √Ålbumes de ejemplo
                    albums = [
                        { id: 1, titulo: '√Ålbum Demo 1', artista: 'Artista 1', portada: null },
                        { id: 2, titulo: '√Ålbum Demo 2', artista: 'Artista 2', portada: null }
                    ];
                    
                    displayAlbums(albums);
                }, 2000);
                
            } catch (error) {
                console.error('Error al cargar √°lbumes:', error);
                showMessage('Error al cargar √°lbumes', 'error');
            }
        }

        function displayAlbums(albumList) {
            const container = document.getElementById('albums-grid');
            if (!container) return;
            
            container.innerHTML = '';
            
            albumList.forEach(album => {
                const albumCard = document.createElement('div');
                albumCard.className = 'album-card';
                albumCard.innerHTML = `
                    <div class="album-cover" style="background-image: url('${album.portada || '/placeholder-album.jpg'}')"></div>
                    <h3>${album.titulo}</h3>
                    <p>${album.artista}</p>
                    <button class="btn" onclick="loadAlbumSongs(${album.id})">Ver Canciones</button>
                `;
                container.appendChild(albumCard);
            });
        }

        function loadAlbumSongs(albumId) {
            console.log('Cargando canciones del √°lbum:', albumId);
            // Aqu√≠ cargar√≠as las canciones del √°lbum espec√≠fico
        }

        // Funci√≥n auxiliar para verificar conexi√≥n
        async function testConnection() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/`, {
                    headers: {
                        'apikey': SUPABASE_KEY
                    }
                });
                console.log('Conexi√≥n con Supabase:', response.ok ? 'OK' : 'Error');
            } catch (error) {
                console.error('Error de conexi√≥n:', error);
            }
        }

        // Verificar conexi√≥n al cargar
        testConnection();
    </script>
</body>
</html>

