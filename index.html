<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>KLMZ MUSIC</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-900 text-white flex flex-col min-h-screen">

  <!-- HEADER -->
  <header class="bg-black p-4 flex justify-between items-center shadow-md">
    <h1 class="text-2xl font-bold text-green-500">‚ô´ KLMZ MUSIC</h1>
    <div id="auth-section" class="space-x-4"></div>
  </header>

  <!-- MAIN -->
  <main class="flex-1 p-6">
    <!-- Login -->
    <div id="login-section" class="max-w-sm mx-auto bg-gray-800 p-6 rounded-xl shadow-lg hidden">
      <h2 class="text-xl font-bold mb-4">Iniciar sesi√≥n</h2>
      <input id="email" type="email" placeholder="Correo" class="w-full mb-2 p-2 rounded text-black">
      <input id="password" type="password" placeholder="Contrase√±a" class="w-full mb-2 p-2 rounded text-black">
      <button onclick="login()" class="w-full bg-green-500 p-2 rounded hover:bg-green-600">Entrar</button>
    </div>

    <!-- Panel Admin -->
    <div id="admin-panel" class="hidden">
      <h2 class="text-lg font-bold mb-2">Subir √Ålbum</h2>
      <input id="album-title" type="text" placeholder="Nombre del √°lbum" class="w-full mb-2 p-2 rounded text-black">
      <input id="album-cover" type="file" accept="image/*" class="mb-2">
      <button onclick="uploadAlbum()" class="bg-blue-500 px-3 py-1 rounded">Subir √Ålbum</button>

      <h2 class="text-lg font-bold mt-6 mb-2">Subir Canciones</h2>
      <select id="album-select" class="w-full mb-2 p-2 rounded text-black"></select>
      <input id="song-files" type="file" accept="audio/*" multiple class="mb-2">
      <button onclick="uploadSongs()" class="bg-blue-500 px-3 py-1 rounded">Subir Canciones</button>
    </div>

    <!-- Listado de √Ålbumes -->
    <h2 class="text-xl font-bold mt-6">√Ålbumes</h2>
    <div id="albums" class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4"></div>
  </main>

  <!-- PLAYER -->
  <footer id="player" class="bg-gray-800 p-4 fixed bottom-0 left-0 w-full hidden">
    <div class="flex items-center space-x-4">
      <img id="player-cover" src="" class="w-12 h-12 rounded shadow">
      <div class="flex-1">
        <div id="player-title" class="font-bold">Nada reproduci√©ndose</div>
        <input id="progress" type="range" value="0" min="0" max="100" class="w-full">
      </div>
      <button onclick="prevSong()">‚èÆ</button>
      <button id="play-btn" onclick="togglePlay()">‚ñ∂Ô∏è</button>
      <button onclick="nextSong()">‚è≠</button>
      <input id="volume" type="range" min="0" max="1" step="0.01" value="1">
    </div>
    <audio id="audio"></audio>
  </footer>

  <script>
    const supabaseUrl = "https://nqbldvpnqhngdtalvzov.supabase.co";
    const supabaseKey = "TU_KEY_AQUI"; // ‚ö†Ô∏è pon tu anon/public key aqu√≠
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    let isAdmin = false;
    let currentAlbum = null;
    let currentSongs = [];
    let currentIndex = 0;

    const loginSection = document.getElementById("login-section");
    const adminPanel = document.getElementById("admin-panel");
    const albumsDiv = document.getElementById("albums");
    const player = document.getElementById("player");
    const audio = document.getElementById("audio");
    const playBtn = document.getElementById("play-btn");
    const progress = document.getElementById("progress");
    const volume = document.getElementById("volume");

    function init() {
      loginSection.classList.remove("hidden");
      loadAlbums();
    }

    async function login() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      if (email === "klmzr@gmail.com" && password === "1234") {
        isAdmin = true;
        adminPanel.classList.remove("hidden");
        loginSection.classList.add("hidden");
        loadAlbums();
      } else {
        alert("Bienvenido como p√∫blico üé∂");
        loginSection.classList.add("hidden");
        loadAlbums();
      }
    }

    async function loadAlbums() {
      albumsDiv.innerHTML = "";
      const { data: albums } = await supabaseClient.from("albums").select("*").order("created_at", { ascending: false });
      if (!albums || albums.length === 0) {
        albumsDiv.innerHTML = "<p>No hay √°lbumes todav√≠a.</p>";
        return;
      }
      albums.forEach(album => {
        const div = document.createElement("div");
        div.className = "bg-gray-800 rounded-lg p-2 shadow hover:bg-gray-700 cursor-pointer text-center";
        div.innerHTML = `
          <img src="${album.cover_url}" class="w-full h-24 object-cover rounded">
          <p class="mt-2 font-bold">${album.title}</p>
          ${isAdmin ? `<button onclick="deleteAlbum('${album.id}')" class="mt-2 bg-red-600 px-2 py-1 rounded text-sm">üóë Eliminar</button>` : ""}
        `;
        div.onclick = (e) => {
          if (!e.target.closest("button")) openAlbum(album);
        };
        albumsDiv.appendChild(div);
      });

      if (isAdmin) {
        const albumSelect = document.getElementById("album-select");
        albumSelect.innerHTML = "";
        albums.forEach(a => {
          const opt = document.createElement("option");
          opt.value = a.id;
          opt.textContent = a.title;
          albumSelect.appendChild(opt);
        });
      }
    }

    async function openAlbum(album) {
      currentAlbum = album;
      const { data: songs } = await supabaseClient.from("songs").select("*").eq("album_id", album.id);
      currentSongs = songs || [];
      albumsDiv.innerHTML = `
        <button onclick="loadAlbums()" class="mb-4 bg-gray-700 px-2 py-1 rounded">‚¨Ö Volver</button>
        <h2 class="text-2xl font-bold mb-4">${album.title}</h2>
        <div class="space-y-2">
          ${currentSongs.map((s, i) => `
            <div class="p-2 bg-gray-700 rounded flex justify-between items-center hover:bg-gray-600">
              <span onclick="playSong(${i})" class="cursor-pointer">üéµ ${s.title}</span>
              ${isAdmin ? `<button onclick="deleteSong('${s.id}')" class="bg-red-600 px-2 py-1 rounded text-sm">üóë</button>` : ""}
            </div>
          `).join("")}
        </div>
      `;
    }

    async function uploadAlbum() {
      const title = document.getElementById("album-title").value.trim();
      const file = document.getElementById("album-cover").files[0];
      if (!title || !file) return alert("Falta t√≠tulo o portada");

      const safeName = Date.now() + "_" + file.name.replace(/[^a-zA-Z0-9.]/g, "_");
      const { error: storageError } = await supabaseClient.storage.from("covers").upload(safeName, file);
      if (storageError) return alert("Error subiendo portada: " + storageError.message);

      const coverUrl = `${supabaseUrl}/storage/v1/object/public/covers/${safeName}`;
      await supabaseClient.from("albums").insert([{ title, cover_url: coverUrl }]);
      loadAlbums();
    }

    async function uploadSongs() {
      const albumId = document.getElementById("album-select").value;
      const files = document.getElementById("song-files").files;
      if (!albumId || files.length === 0) return alert("Selecciona √°lbum y canciones");

      for (let file of files) {
        const safeName = Date.now() + "_" + file.name.replace(/[^a-zA-Z0-9.]/g, "_");
        const { error: uploadError } = await supabaseClient.storage.from("songs").upload(safeName, file);
        if (uploadError) {
          alert("Error subiendo canci√≥n: " + uploadError.message);
          continue;
        }
        const songUrl = `${supabaseUrl}/storage/v1/object/public/songs/${safeName}`;
        await supabaseClient.from("songs").insert([{ album_id: albumId, title: file.name, song_url: songUrl }]);
      }
      alert("Canciones subidas!");
      loadAlbums();
    }

    async function deleteAlbum(albumId) {
      if (!confirm("¬øSeguro que quieres borrar este √°lbum y sus canciones?")) return;
      await supabaseClient.from("albums").delete().eq("id", albumId);
      loadAlbums();
    }

    async function deleteSong(songId) {
      if (!confirm("¬øSeguro que quieres borrar esta canci√≥n?")) return;
      await supabaseClient.from("songs").delete().eq("id", songId);
      openAlbum(currentAlbum);
    }

    function playSong(index) {
      currentIndex = index;
      const song = currentSongs[index];
      document.getElementById("player-title").textContent = song.title;
      document.getElementById("player-cover").src = currentAlbum.cover_url;
      audio.src = song.song_url;
      audio.play();
      player.classList.remove("hidden");
      playBtn.textContent = "‚è∏";
    }

    function togglePlay() {
      if (audio.paused) {
        audio.play();
        playBtn.textContent = "‚è∏";
      } else {
        audio.pause();
        playBtn.textContent = "‚ñ∂Ô∏è";
      }
    }

    function prevSong() {
      if (currentIndex > 0) playSong(currentIndex - 1);
    }

    function nextSong() {
      if (currentIndex < currentSongs.length - 1) playSong(currentIndex + 1);
    }

    audio.ontimeupdate = () => {
      progress.value = (audio.currentTime / audio.duration) * 100 || 0;
    };
    progress.oninput = () => {
      audio.currentTime = (progress.value / 100) * audio.duration;
    };
    volume.oninput = () => {
      audio.volume = volume.value;
    };

    init();
  </script>
</body>
</html>
