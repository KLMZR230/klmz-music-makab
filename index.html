<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>KLMZ MUSIC</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1DB954">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Metal+Mania&display=swap');
        * { box-sizing: border-box; }
        body { margin: 0; font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; background: #181818; color: #fff; padding-bottom: 84px; transition: all 0.3s ease; }
        header { background: #121212; padding: 1rem 1.5rem; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; transition: all 0.3s ease; }
        .logo { font-weight: bold; font-size: 1.4rem; letter-spacing: 1px; transition: all 0.3s ease; }
        .user-actions { display:flex; align-items: center; gap:.5rem; }
        .lock-icon { cursor:pointer; font-size:1.4rem; color:#fff; user-select:none; transition: all 0.3s ease; }
        .lock-icon:hover { opacity:.7;}
        .theme-selector { display: flex; align-items: center; gap: 0.3rem; margin-right: 0.5rem; }
        .theme-selector label { font-size: 0.7rem; color: #b3b3b3; }
        .theme-selector select { background: #333; color: #fff; border: 1px solid #555; border-radius: 4px; padding: 0.1rem 0.2rem; font-size: 0.7rem; cursor: pointer; transition: all 0.3s ease; }
        .app-container { display: flex; min-height: calc(100vh - 60px);}
        main { flex:1; padding:1rem; max-width:900px; margin:0 auto;}
        #search-input { width: 100%; padding: 1rem; background: #242424; border: none; border-radius: 4px; color: #fff; margin-bottom: 2rem; transition: all 0.3s ease; }
        .section-title { font-size:1.8rem; font-weight:bold; margin-bottom:1.5rem; transition: all 0.3s ease; }
        .album-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(140px,1fr)); gap:1.5rem;}
        .album-card { background:none; padding:1rem; cursor:pointer; display:flex; flex-direction:column; align-items:center; text-align:center; transition: all 0.3s ease; border-radius: 12px; }
        .album-card:hover { transform:scale(1.05); box-shadow: 0 0 15px rgba(29, 185, 84, 0.4); }
        .album-img { border-radius:50%; width:100px; height:100px; object-fit:cover; margin-bottom:.7rem; background:#333; transition: all 0.3s ease; border: 3px solid #444; }
        .album-title { font-size:.98rem; font-weight: bold; margin-bottom: 0.4rem; transition: all 0.3s ease; }
        .album-artist { font-size: .9rem; color: #b3b3b3; transition: all 0.3s ease; }
        .album-detail-img { width: 200px; height: 200px; border-radius: 50%; object-fit: cover; margin: 0 auto 1.5rem; display: block; border: 4px solid #444; transition: all 0.3s ease; }
        .song-list { width:100%; margin-top:1rem; padding-bottom: 120px; }
        .song-list ul { list-style:none; padding:0; margin:0;}
        .song-list li { padding:.7rem; cursor:pointer; color:#1db954; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center; transition: all 0.3s ease; gap: 1rem;}
        .song-list li:hover { color:#fff; background: rgba(255,255,255,.05); transform: translateX(2px);}
        .song-list .song-info { flex-grow: 1; min-width: 0; }
        .song-list .song-title { font-weight: 500; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .song-list .song-artist { color:#b3b3b3; font-size: 0.85rem; }
        .song-list li:hover .song-title { color: #1DB954; font-weight: 600; }
        .song-meta { display: flex; align-items: center; gap: 1.5rem; flex-shrink: 0;}
        .song-actions { display: flex; gap: 0.8rem; align-items: center; }
        .song-actions span { font-size: 1.2rem; cursor: pointer; color: #666; transition: all 0.3s ease; }
        .song-actions span:hover { color: #fff; transform: scale(1.1); }
        .play-icon { font-size: 1.1rem !important; }
        .playlist-item { background: #242424; padding: 1rem; margin-bottom: 0.8rem; border-radius: 8px; cursor: pointer; border-left: 3px solid #1DB954; transition: all 0.3s ease; display: flex; justify-content: space-between; align-items: center;}
        .playlist-item:hover { background: #333; border-left-color: #1ed760; }
        .playlist-info strong { font-size: 1.1rem; }
        .playlist-info small { font-size: 0.8rem; color: #b3b3b3; display: block; }
        .playlist-actions .delete-playlist { font-size: 1.2rem; color: #555; }
        .playlist-actions .delete-playlist:hover { color: #ff4757; }
        #add-to-playlist-modal ul { list-style: none; padding: 0; max-height: 40vh; overflow-y: auto; }
        #add-to-playlist-modal li { padding: 1rem; border-bottom: 1px solid #444; cursor: pointer; }
        #add-to-playlist-modal li:hover { background: #404040; color: #1DB954; }
        #add-to-playlist-modal li:last-child { border-bottom: none; }
        .modal-header { font-size: 1.2rem; font-weight: bold; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #444; }
        .player { position: fixed; bottom: 84px; left: 0; right: 0; background: #212121cc; border-top: 1px solid #282828; z-index: 300; display: flex; align-items: center; padding: 0.8rem 1.2rem; min-height: 56px; cursor: pointer; box-shadow: 0 -2px 10px #0002; transition: all 0.3s ease;}
        .player-img-mini { width:44px; height:44px; border-radius:100%; object-fit:cover; margin-right:1rem;}
        .player-info-mini { flex:1; overflow:hidden;}
        .player-title-mini { font-weight:bold; font-size:1rem; line-height:1.2;}
        .player-artist-mini { color:#b3b3b3; font-size:0.9rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
        .player-controls-inline { display:flex; align-items:center; gap:.5rem;}
        .play-btn-inline { background: none; color:#fff; border:none; font-size:1.8rem; cursor:pointer; transition: all 0.3s ease; padding: 0; }
        .play-btn-inline:hover { opacity: 0.7; }
        .full-player-backdrop { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.97); z-index:9999; align-items:center; justify-content:center; flex-direction:column; transition: all 0.3s ease;}
        .full-player-backdrop.active { display: flex;}
        .full-player-cover { width: 200px; height: 200px; border-radius: 12px; object-fit:cover; margin: 0 auto 2rem; display: block; transition: all 0.3s ease;}
        .full-player-title { font-size: 1.8rem; font-weight: bold; margin: 1rem 0 .5rem 0; text-align: center;}
        .full-player-artist { color: #b3b3b3; font-size: 1.1rem; margin-bottom: 2rem; text-align: center;}
        .full-player-controls { display: flex; flex-direction: column; align-items: center; gap: 1.5rem; width: 100%; }
        .full-control-buttons { display: flex; gap: 3rem; align-items: center; }
        .full-control-btn { background: none; border: none; color: #fff; font-size: 2.2rem; padding: 0; cursor: pointer; transition: all 0.3s ease; }
        .full-control-btn:hover { color: #1DB954; }
        .full-play-btn { font-size: 3.5rem; }
        .full-play-btn:hover { transform: scale(1.1); color: #1DB954; }
        .mode-controls { display: flex; gap: 1rem; margin-top: 1rem; justify-content: center; }
        .mode-btn { background: none; border: 1px solid #444; color: #b3b3b3; padding: 0.5rem; border-radius: 50%; cursor: pointer; font-size: 1.2rem; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; }
        .mode-btn:hover { color: #fff; border-color: #666; }
        .mode-btn.active { color: #1DB954; border-color: #1DB954; background: rgba(29,185,84,0.1); }
        .full-progress-bar { flex: 1; height: 8px; background: #4f4f4f; border-radius: 4px; cursor: pointer; position: relative;}
        .full-progress-fill { height: 100%; background: #1DB954; border-radius: 4px; width: 0%; position: absolute; top: 0; left: 0; transition: all 0.3s ease;}
        .full-progress-container { width: 90%; max-width: 400px; display: flex; align-items: center; gap: 1rem;}
        .full-progress-time { font-size: 1rem; color: #b3b3b3; min-width: 50px;}
        .full-player-volume { margin-top: 1rem;}
        .full-volume-slider { width: 150px; }
        .full-player-close { position: absolute; top: 30px; right: 40px; background: none; border: none; font-size: 2.5rem; color: #fff; cursor: pointer; transition: all 0.3s ease; }
        .full-player-close:hover { color: #ff4757; }
        .modal { position: fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,.80); display:none; align-items:center; justify-content:center; z-index:2000; transition: all 0.3s ease;}
        .modal-content { background:#282828; padding:2rem; border-radius:8px; width:95%; max-width:430px; max-height:90vh; overflow-y:auto; transition: all 0.3s ease; }
        .modal-content p a { color: #1DB954; text-decoration: none; }
        .modal-content p { text-align: center; margin-top: 1rem; }
        .form-group { margin-bottom:1rem;}
        .form-group label { display:block; margin-bottom:0.5rem;}
        .form-group input, .form-group select { width:100%; padding:.7rem; background:#404040; border:1px solid #555; border-radius:4px; color:#fff; transition: all 0.3s ease;}
        .btn-primary { background:#1DB954; color:#fff; border:none; padding:.7rem 1.5rem; border-radius:999px; cursor:pointer; width:100%; margin-top:.7rem; transition: all 0.3s ease; }
        .btn-primary:hover { background:#1ed760; }
        .btn-danger { background:#e22134; color:#fff; border:none; padding:.5rem 1rem; border-radius:4px; cursor:pointer; transition: all 0.3s ease; }
        .btn-danger:hover { background:#ff4757; }
        .close-modal { position:absolute; top:1rem; right:1rem; background:none; border:none; color:#fff; font-size:1.2rem; cursor:pointer;}
        .user-menu { position: relative; display: inline-block; }
        .user-dropdown { display: none; position: absolute; right: 0; top: calc(100% + 10px); background: #282828; min-width: 200px; border-radius: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); z-index: 1000; border: 1px solid #404040; transition: all 0.3s ease; }
        .user-dropdown.show { display: block; animation: dropdownFadeIn 0.2s ease; }
        .user-dropdown-item { padding: 0.8rem 1rem; cursor: pointer; border-bottom: 1px solid #404040; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; transition: all 0.3s ease; }
        .user-dropdown-item:last-child { border-bottom: none; }
        .user-dropdown-item:hover { background: #404040; }
        .user-dropdown-item.logout { color: #ff4757; border-top: 1px solid #404040; margin-top: 0.3rem; }
        .user-info { padding: 0.8rem 1rem; border-bottom: 2px solid #404040; font-size: 0.85rem; color: #b3b3b3; }
        .user-info strong { color: #fff; font-size: 0.9rem; }
        .bottom-nav { position: fixed; left: 0; right: 0; bottom: 20px; background: #181818; border-top: 1px solid #272727; display: flex; height: 64px; z-index: 5000; transition: all 0.3s ease; }
        .bottom-nav-item { color: #b3b3b3; text-align: center; flex: 1; font-size: 1.14rem; padding: 4px 0 0 0; border-radius: 7px; cursor: pointer; display: flex; flex-direction: column; align-items: center; transition: all 0.3s ease;}
        .bottom-nav-item.active { color: #1DB954; background: rgba(29,185,84,.09);}
        .bottom-nav-item:hover {background:rgba(255,255,255,0.05);}
        .bottom-nav-item .icon { font-size: 1.12rem; }
        .bottom-nav-item small { font-size: 0.67rem;}
        .content-section { display: none; }
        .content-section.active { display: block; }
        .back-btn { margin-bottom: 1.2rem; background: #222; color: #fff; border: none; padding: 0.5rem 1.5rem; border-radius: 999px; cursor: pointer; transition: all 0.3s ease; }
        .back-btn:hover { background: #333; }
        .copyright { position: fixed; bottom: 0; left: 0; width: 100%; height: 20px; background: #0a0a0a; color: #666; font-size: 0.7rem; text-align: center; padding: 2px 0; z-index: 10000; border-top: 1px solid #222; }
        .loading-indicator { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.9); color: #fff; padding: 1.5rem 2.5rem; border-radius: 12px; font-size: 1rem; z-index: 2000; border: 2px solid #1DB954; }
        
        /* --- ESTILOS DE BÚSQUEDA --- */
        .search-song-item, .search-album-item { background: #242424; padding: 0.8rem; margin-bottom: 0.8rem; border-radius: 8px; cursor: pointer; display: flex; align-items: center; transition: all 0.3s ease; }
        .search-song-item:hover, .search-album-item:hover { background: #333; }
        .search-song-info, .search-album-info { flex: 1; }
        .search-song-title, .search-album-title { font-weight: bold; margin-bottom: 0.2rem; }
        .search-song-artist, .search-album-artist { font-size: 0.9rem; color: #b3b3b3; }
        .search-album-img { width: 50px; height: 50px; border-radius: 8px; margin-right: 1rem; object-fit: cover; background: #333; }
        #search-results h3 { margin-top: 1.5rem; margin-bottom: 1rem; border-bottom: 1px solid #444; padding-bottom: 0.5rem; }
        
        .favorites-list, .downloads-list { margin-top: 1rem; }
        .favorite-item, .download-item { background: #242424; padding: 1rem; margin-bottom: 0.8rem; border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid #1DB954; transition: all 0.3s ease; }
        .favorite-item:hover, .download-item:hover { background: #333; }
        .favorite-info, .download-info { flex: 1; }
        .favorite-title, .download-title { font-weight: bold; margin-bottom: 0.3rem; color: #fff; }
        .favorite-artist, .download-artist { font-size: 0.9rem; color: #b3b3b3; }
        .download-item-actions { display: flex; gap: 0.5rem; align-items: center; }
        .delete-download { cursor: pointer; color: #ff4757; font-size: 1rem; transition: all 0.3s ease; }
        .delete-download:hover { transform: scale(1.2); }
        #album-detail, #playlist-detail { padding-bottom: 120px; }
        .admin-section { margin-bottom: 2.5rem; background: #242424; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #1DB954; }
        .admin-section h3 { margin-top: 0; border-bottom: 2px solid #1DB954; padding-bottom: 0.8rem; margin-bottom: 1.5rem; color: #1DB954; display: flex; align-items: center; gap: 0.5rem; }
        .admin-form { margin-bottom: 2rem; }
        .admin-form input[type="file"] { background: #333; border: 2px dashed #1DB954; padding: 1rem; border-radius: 8px; text-align: center; cursor: pointer; }
        .admin-form input[type="file"]:hover { background: #404040; }
        .btn-secondary { background: #555; color: #fff; border: none; padding: .7rem 1.5rem; border-radius: 999px; cursor: pointer; transition: all 0.3s ease; margin-right: 0.5rem; }
        .btn-secondary:hover { background: #666; }
        .admin-album-item { background: #2c2c2c; border-radius: 8px; margin-bottom: 1.5rem; border-left: 3px solid #1DB954; overflow: hidden; }
        .admin-album-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #333; }
        .admin-item-info { flex: 1; }
        .admin-item-info strong { color: #1DB954; font-size: 1.1rem; }
        .admin-item-info small { color: #b3b3b3; display: block; margin-top: 0.3rem; }
        .admin-item-actions button { margin-left: 0.5rem; padding: 0.4rem 0.8rem; font-size: 0.85rem; }
        .admin-song-list { padding: 0.5rem 1rem 1rem; }
        .admin-song-item { display: flex; justify-content: space-between; align-items: center; padding: 0.8rem; border-bottom: 1px solid #404040; }
        .admin-song-item:last-child { border-bottom: none; }
        .admin-song-actions button { margin-left: 0.5rem; padding: 0.3rem 0.6rem; font-size: 0.8rem; }
        .no-songs { color: #888; padding: 1rem; text-align: center; font-style: italic; }
        .admin-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { background: #333; padding: 1.5rem; border-radius: 8px; text-align: center; border-left: 4px solid #1DB954; }
        .stat-number { font-size: 2rem; font-weight: bold; color: #1DB954; }
        .stat-label { color: #b3b3b3; margin-top: 0.5rem; }
        .offline-indicator { background: #ff4757; color: white; padding: 0.3rem 0.8rem; border-radius: 12px; font-size: 0.8rem; margin-left: 0.5rem; }
        .multi-upload-section { background: rgba(29,185,84,0.1); border: 2px dashed #1DB954; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem; text-align: center; }
        .multi-upload-section h4 { color: #1DB954; margin-top: 0; }
        .file-queue { margin-top: 1rem; max-height: 200px; overflow-y: auto; }
        .file-queue-item { background: #333; padding: 0.8rem; margin-bottom: 0.5rem; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; }
        .file-queue-item.uploading { border-left: 3px solid #ff9800; }
        .file-queue-item.success { border-left: 3px solid #4caf50; }
        .file-queue-item.error { border-left: 3px solid #f44336; }
        .file-remove { color: #ff4757; cursor: pointer; font-size: 1.2rem; }
        .file-remove:hover { transform: scale(1.2); }
        .upload-progress-container { margin-top: 0.5rem; }
        .upload-progress-bar { background-color: #555; border-radius: 4px; height: 6px; overflow: hidden; }
        .upload-progress-fill { background-color: #1DB954; height: 100%; width: 0%; transition: width 0.2s ease-in-out; }
        .batch-upload-progress { margin-top: 1rem; }
        .batch-progress-bar { background: #444; height: 8px; border-radius: 4px; overflow: hidden; }
        .batch-progress-fill { background: #1DB954; height: 100%; width: 0%; transition: width 0.3s ease; }
        .hidden-badge { background: #555; color: #ccc; font-size: 0.7rem; padding: 2px 6px; border-radius: 8px; margin-left: 0.5rem; vertical-align: middle; font-weight: normal; }
        body.offline-mode { background: linear-gradient(135deg, #1a3d1a 0%, #0d2d0d 100%) !important; }
        body.offline-mode .section-title { color: #90ee90 !important; }
        body.offline-mode .download-item { background: #1a4d1a !important; border-left-color: #90ee90 !important; }
        body.offline-mode .bottom-nav { background: #0d2d0d !important; }
        body.offline-mode .offline-indicator { background: #ff9800 !important; animation: pulse 2s infinite; }

        /* TEMAS COMPLETOS */
        body.theme-default .album-img, body.theme-default .album-detail-img { border-color: #1DB954; }
        body.theme-fire .album-img, body.theme-fire .album-detail-img { border-color: #ff4500; }
        body.theme-fire { background: radial-gradient(ellipse at center, #3d0303 0%, #1a0000 70%) !important; color: #ffcc80 !important; }
        body.theme-fire .logo { font-family: 'Metal Mania', cursive !important; font-size: 1.8rem !important; color: #ff4500 !important; text-shadow: 0 0 5px #ff4500, 0 0 10px #ff4500, 0 0 20px #ff8c00, 0 0 40px #ff0000 !important; animation: logo-flicker 2s infinite linear alternate; }
        body.theme-fire .section-title { font-family: 'Metal Mania', cursive !important; color: #ff8c00 !important; }
        body.theme-fire header { background: rgba(10,0,0,0.8) !important; border-bottom: 2px solid #ff4500; }
        body.theme-fire .album-card:hover { animation: fire-glow 1.5s ease-in-out infinite alternate; }
        body.theme-fire .btn-primary { background: #ff4500 !important; color: #fff !important; }
        body.theme-fire .song-list li { color: #ff8c00 !important; }
        body.theme-fire .bottom-nav-item.active { color: #ff4500 !important; background: rgba(255, 69, 0, 0.2); }
        body.theme-neon .album-img, body.theme-neon .album-detail-img { border-color: #00ff88; }
        body.theme-neon { background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 70%, #0f0f23 100%) !important; color: #00ff88 !important; }
        body.theme-neon .logo { color: #00ff88 !important; text-shadow: 0 0 15px #00ff88, 0 0 30px #00ff88 !important; animation: neonPulse 2s ease-in-out infinite alternate !important; }
        body.theme-neon header { background: #0f0f23 !important; border-bottom: 1px solid #00ff88; }
        body.theme-neon .album-card:hover { box-shadow: 0 0 25px rgba(0,255,136,0.6) !important; }
        body.theme-neon .btn-primary { background: #00ff88 !important; color: #000 !important; }
        body.theme-neon .song-list li { color: #00ff88 !important; }
        body.theme-neon .bottom-nav-item.active { color: #00ff88 !important; }
        body.theme-minimal .album-img, body.theme-minimal .album-detail-img { border-color: #f5f5f5; }
        body.theme-minimal { background: linear-gradient(135deg, #0f0f0f 0%, #1c1c1c 50%, #2a2a2a 70%, #1a1a1a 100%) !important; color: #f5f5f5 !important; }
        body.theme-minimal header { background: #0f0f0f !important; border-bottom: 1px solid #333; }
        body.theme-minimal .album-card:hover { box-shadow: 0 0 20px rgba(245,245,245,0.4) !important; }
        body.theme-minimal .btn-primary { background: #f5f5f5 !important; color: #0f0f0f !important; }
        body.theme-minimal .song-list li { color: #f5f5f5 !important; }
        body.theme-minimal .bottom-nav-item.active { color: #f5f5f5 !important; }
        body.theme-sunset .album-img, body.theme-sunset .album-detail-img { border-color: #ff7043; }
        body.theme-sunset { background: linear-gradient(135deg, #2c1810 0%, #4a2c2a 30%, #6d4c41 60%, #1a1a1a 100%) !important; color: #ffab91 !important; }
        body.theme-sunset .logo { color: #ff7043 !important; text-shadow: 0 0 10px #ff7043; }
        body.theme-sunset .album-card:hover { box-shadow: 0 0 20px rgba(255, 112, 67, 0.6); }
        body.theme-sunset .btn-primary { background: #ff7043 !important; color: #fff !important; }
        body.theme-sunset .bottom-nav-item.active { color: #ff7043 !important; }
        body.theme-pastel .album-img, body.theme-pastel .album-detail-img { border-color: #bb86fc; }
        body.theme-pastel { background: linear-gradient(135deg, #1a1625 0%, #2d2438 50%, #3d2f47 70%, #4a3b5c 100%) !important; color: #d4c5f9 !important; }
        body.theme-pastel .logo { color: #bb86fc !important; text-shadow: 0 0 10px #bb86fc; }
        body.theme-pastel .album-card:hover { box-shadow: 0 0 20px rgba(187, 134, 252, 0.6); }
        body.theme-pastel .btn-primary { background: #bb86fc !important; color: #1a1625 !important; }
        body.theme-pastel .bottom-nav-item.active { color: #bb86fc !important; }
        body.theme-luxury .album-img, body.theme-luxury .album-detail-img { border-color: #3498db; }
        body.theme-luxury { background: linear-gradient(135deg, #0f1419 0%, #1a252f 50%, #2c3e50 70%, #34495e 100%) !important; color: #f0f8ff !important; }
        body.theme-luxury .logo { color: #3498db !important; text-shadow: 0 0 10px #3498db; }
        body.theme-luxury .album-card:hover { box-shadow: 0 0 20px rgba(52, 152, 219, 0.6); }
        body.theme-luxury .btn-primary { background: linear-gradient(45deg, #3498db, #2980b9) !important; color: #fff !important; }
        body.theme-luxury .bottom-nav-item.active { color: #3498db !important; }
        body.theme-oceanic .album-img, body.theme-oceanic .album-detail-img { border-color: #17a2b8; }
        body.theme-oceanic { background: linear-gradient(135deg, #0a192f 0%, #173a5e 50%, #3b6978 70%, #84a9ac 100%) !important; color: #e0e0e0 !important; }
        body.theme-oceanic .logo { color: #17a2b8 !important; text-shadow: 0 0 10px #17a2b8; }
        body.theme-oceanic .album-card:hover { box-shadow: 0 0 20px rgba(23, 162, 184, 0.6); }
        body.theme-oceanic .btn-primary { background: #17a2b8 !important; color: #fff !important; }
        body.theme-oceanic .bottom-nav-item.active { color: #17a2b8 !important; }
        body.theme-hacker .album-img, body.theme-hacker .album-detail-img { border-color: #39ff14; }
        body.theme-hacker { background: #000 !important; color: #39ff14 !important; font-family: 'Courier New', Courier, monospace !important; }
        body.theme-hacker .logo, body.theme-hacker .section-title { color: #39ff14 !important; text-shadow: 0 0 5px #39ff14, 0 0 10px #39ff14; }
        body.theme-hacker header { background: #050505 !important; border-bottom: 1px solid #39ff14; }
        body.theme-hacker .album-card:hover { box-shadow: 0 0 20px rgba(57, 255, 20, 0.7) !important; }
        body.theme-hacker .btn-primary { background: #39ff14 !important; color: #000 !important; font-weight: bold; }
        body.theme-hacker .song-list li { color: #39ff14 !important; }
        body.theme-hacker .bottom-nav-item.active { color: #39ff14 !important; background: rgba(57, 255, 20, 0.1); }
        body.theme-cyber .album-img, body.theme-cyber .album-detail-img { border-color: #ff00ff; }
        body.theme-cyber { background: linear-gradient(135deg, #0b0213 0%, #1d0f2b 100%) !important; color: #e0e0e0 !important; font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif !important; }
        body.theme-cyber .logo { color: #ff00ff !important; text-shadow: 0 0 8px #ff00ff; }
        body.theme-cyber header { background: rgba(11, 2, 19, 0.8) !important; backdrop-filter: blur(5px); border-bottom: 1px solid #ff00ff; }
        body.theme-cyber .album-card:hover { box-shadow: 0 0 18px rgba(255, 0, 255, 0.6) !important; }
        body.theme-cyber .btn-primary { background: #ff00ff !important; color: #fff !important; }
        body.theme-cyber .song-list li { color: #ff00ff !important; }
        body.theme-cyber .bottom-nav-item.active { color: #ff00ff !important; background: rgba(255, 0, 255, 0.1); }
        body.theme-floral .album-img, body.theme-floral .album-detail-img { border-color: #ff85a2; }
        body.theme-floral { background: linear-gradient(135deg, #3d1c2b 0%, #4a2c3a 100%) !important; color: #ffe0e9 !important; }
        body.theme-floral .logo { color: #ff85a2 !important; text-shadow: 0 0 8px #ff85a2; }
        body.theme-floral header { background: rgba(45, 20, 35, 0.8) !important; backdrop-filter: blur(5px); border-bottom: 1px solid #ff85a2; }
        body.theme-floral .album-card:hover { box-shadow: 0 0 18px rgba(255, 133, 162, 0.6) !important; }
        body.theme-floral .btn-primary { background: #ff85a2 !important; color: #3d1c2b !important; font-weight: bold; }
        body.theme-floral .song-list li { color: #ff85a2 !important; }
        body.theme-floral .bottom-nav-item.active { color: #ff85a2 !important; background: rgba(255, 133, 162, 0.1); }

        @keyframes fire-glow { from { box-shadow: 0 0 10px #ff8c00, 0 0 20px #ff8c00, 0 0 30px #ff4500, 0 0 40px #ff0000; } to { box-shadow: 0 0 15px #ff8c00, 0 0 25px #ff8c00, 0 0 40px #ff4500, 0 0 55px #ff0000; } }
        @keyframes logo-flicker { 0%, 100% { text-shadow: 0 0 5px #ff4500, 0 0 10px #ff4500, 0 0 20px #ff8c00, 0 0 40px #ff0000; opacity: 1; } 50% { text-shadow: 0 0 8px #ff4500, 0 0 15px #ff4500, 0 0 25px #ff8c00, 0 0 45px #ff0000; opacity: 0.95; } }
        @keyframes neonPulse { 0% { text-shadow: 0 0 15px #00ff88, 0 0 30px #00ff88; } 100% { text-shadow: 0 0 25px #00ff88, 0 0 40px #00ff88, 0 0 60px #00ff88; } }
        @keyframes dropdownFadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* --- ADAPTACIONES MÓVILES (Optimización para max-width: 600px) --- */
        @media (max-width: 600px) {
            /* Contenedor principal: usa todo el ancho disponible */
            main {
                padding: 0.5rem; /* Menos padding en los bordes */
                max-width: 100%;
                margin: 0; 
            }

            /* Cuadrícula de álbumes: 2 o 3 columnas para mejor visualización */
            .album-grid {
                /* Permite que quepan 2 o 3 tarjetas de al menos 120px */
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); 
                gap: 0.8rem;
            }

            /* Tarjetas de álbum: reducir el tamaño de las imágenes */
            .album-card {
                padding: 0.5rem;
            }

            .album-img {
                width: 80px;
                height: 80px;
            }

            /* Ocultar el selector de tema en móviles para ahorrar espacio en el header */
            .theme-selector {
                display: none; 
            }
            
            /* Reproductor Mini (Bottom Player) */
            .player {
                padding: 0.5rem 0.8rem;
            }
            
            /* Reproductor Fullscreen: ajustes de tamaño */
            .full-player-cover {
                width: 150px;
                height: 150px;
                margin: 0 auto 1.5rem;
            }

            .full-player-close {
                top: 15px;
                right: 15px;
                font-size: 1.8rem;
            }

            .full-progress-container {
                width: 100%;
                max-width: 300px;
            }
            
            /* Lista de Canciones */
            .song-list li {
                flex-direction: column; /* Apila título/artista y acciones */
                align-items: flex-start;
                padding: 0.5rem;
            }
            
            .song-list .song-title {
                font-size: 0.95rem;
            }
            
            .song-list .song-meta {
                margin-top: 0.5rem;
                width: 100%;
                justify-content: space-between;
            }
            
            .song-list .song-actions {
                order: -1; /* Mueve las acciones arriba o al final */
            }
        }
    </style>
    <script type='text/javascript' src='https://cdn.jsdelivr.net/npm/sweetalert2@11'></script>
    <script src="https://kit.fontawesome.com/6c6c21e6be.js" crossorigin="anonymous"></script>
</head>
<body>
    <header>
        <div class="logo">KLMZ MUSIC</div>
        <div class="user-actions">
            <div class="theme-selector">
                <label for="theme-selector">Tema:</label>
                <select id="theme-selector">
                    <option value="theme-default">Default</option>
                    <option value="theme-fire">Fuego</option>
                    <option value="theme-neon">Neon</option>
                    <option value="theme-minimal">Minimal</option>
                    <option value="theme-sunset">Atardecer</option>
                    <option value="theme-pastel">Pastel</option>
                    <option value="theme-luxury">Luxury</option>
                    <option value="theme-oceanic">Oceánico</option>
                    <option value="theme-hacker">Hacker</option>
                    <option value="theme-cyber">Cyber</option>
                    <option value="theme-floral">Floral</option>
                </select>
            </div>
            <i id="lock-icon" class="fa-solid fa-lock lock-icon" title="Modo Solo Descargas"></i>
            <div id="auth-buttons" style="display: none;">
                <button id="login-btn-header" class="btn-primary" style="padding: 0.5rem 1rem; width: auto; margin: 0;">Login</button>
            </div>
            <div id="user-menu-btn" class="user-menu" style="display: none;">
                <i class="fa-solid fa-user" style="font-size: 1.4rem; cursor: pointer;"></i>
                <div id="user-menu-dropdown" class="user-dropdown">
                    <div class="user-info">
                        <strong><span id="user-info-username"></span></strong><br>
                        <small>Rol: <span id="user-info-role"></span></small>
                    </div>
                    <div id="admin-link-dropdown" class="user-dropdown-item" data-section="admin-section" style="display:none;"><i class="fa-solid fa-screwdriver-wrench"></i> Admin</div>
                    <div id="login-btn-dropdown" class="user-dropdown-item"><i class="fa-solid fa-arrow-right-to-bracket"></i> Cambiar Cuenta</div>
                    <div id="logout-link" class="user-dropdown-item logout"><i class="fa-solid fa-right-from-bracket"></i> Cerrar Sesión</div>
                </div>
            </div>
        </div>
    </header>

    <div class="app-container">
        <main id="main-content">
            <section id="home-section" class="content-section active">
                <h2 class="section-title">Explorar Música</h2>
                <div id="album-grid" class="album-grid">
                    </div>
            </section>

            <section id="search-section" class="content-section">
                <h2 class="section-title">Buscar</h2>
                <input type="text" id="search-input" placeholder="Busca canciones, artistas o álbumes...">
                <div id="search-results">
                    </div>
            </section>

            <section id="library-section" class="content-section">
                <h2 class="section-title">Mi Biblioteca</h2>

                <h3 style="display: flex; justify-content: space-between; align-items: center;">
                    Playlists
                    <button id="create-playlist-btn" class="btn-primary" style="width: auto; padding: 0.4rem 1rem; font-size: 0.9rem;">Crear Playlist</button>
                </h3>
                <div id="playlist-list">
                    </div>

                <h3>Favoritos</h3>
                <div id="favorites-list" class="favorites-list">
                    </div>

                <h3>Descargas</h3>
                <div id="downloads-list" class="downloads-list">
                    </div>
            </section>

            <section id="admin-section" class="content-section">
                <h2 class="section-title"><i class="fa-solid fa-screwdriver-wrench"></i> Administración</h2>
                
                <div class="admin-stats">
                    <div class="stat-card"><div id="stat-albums" class="stat-number">0</div><div class="stat-label">Álbumes</div></div>
                    <div class="stat-card"><div id="stat-songs" class="stat-number">0</div><div class="stat-label">Canciones</div></div>
                    <div class="stat-card"><div id="stat-playlists" class="stat-number">0</div><div class="stat-label">Playlists</div></div>
                </div>

                <div class="admin-section">
                    <h3>Gestión de Álbumes <button id="create-album-btn-admin" class="btn-primary" style="width: auto; padding: 0.4rem 1rem; font-size: 0.9rem;">+ Crear Álbum</button></h3>
                    <div id="admin-album-list">
                        </div>
                </div>
            </section>
            
            <section id="album-detail" class="content-section">
                <button class="back-btn"><i class="fa-solid fa-arrow-left"></i> Volver</button>
                <img id="album-detail-img" class="album-detail-img" src="" alt="Album Cover">
                <h1 id="album-detail-title" style="text-align: center; margin-bottom: 0;">Título del Álbum</h1>
                <h2 id="album-detail-artist" style="text-align: center; color: #b3b3b3; margin-top: 0.5rem;">Artista</h2>

                <div class="song-list">
                    <h3>Lista de Canciones</h3>
                    <ul id="album-song-list-ul">
                        </ul>
                </div>
            </section>

            <section id="playlist-detail" class="content-section">
                <button class="back-btn"><i class="fa-solid fa-arrow-left"></i> Volver</button>
                <h1 id="playlist-detail-title">Nombre de Playlist</h1>
                <p id="playlist-detail-count" style="color: #b3b3b3;"></p>

                <div class="song-list">
                    <h3>Canciones</h3>
                    <ul id="playlist-song-list-ul">
                        </ul>
                </div>
            </section>
        </main>
    </div>

    <div id="mini-player" class="player" style="display: none;">
        <img id="player-img-mini" class="player-img-mini" src="placeholder-album.png" alt="Cover">
        <div class="player-info-mini">
            <div id="player-title-mini" class="player-title-mini">Título de Canción</div>
            <div id="player-artist-mini" class="player-artist-mini">Artista</div>
        </div>
        <div class="player-controls-inline">
            <button id="play-btn-inline" class="fa-solid fa-play play-btn-inline"></button>
        </div>
    </div>

    <div id="full-player-backdrop" class="full-player-backdrop">
        <button id="full-player-close" class="fa-solid fa-chevron-down full-player-close"></button>
        
        <img id="full-player-cover" class="full-player-cover" src="placeholder-album.png" alt="Cover">
        <h1 id="full-player-title" class="full-player-title">Título de Canción</h1>
        <h2 id="full-player-artist" class="full-player-artist">Artista</h2>

        <div class="full-player-controls">
            <div class="full-progress-container">
                <span id="full-progress-time" class="full-progress-time">0:00</span>
                <div id="full-progress-bar" class="full-progress-bar">
                    <div id="full-progress-fill" class="full-progress-fill"></div>
                </div>
                <span id="full-progress-duration" class="full-progress-time">0:00</span>
            </div>

            <div class="full-control-buttons">
                <button id="prev-btn" class="fa-solid fa-backward-step full-control-btn"></button>
                <button id="full-play-btn" class="fa-solid fa-play full-play-btn"></button>
                <button id="next-btn" class="fa-solid fa-forward-step full-control-btn"></button>
            </div>

            <div class="mode-controls">
                <button id="shuffle-btn" class="mode-btn"><i class="fa-solid fa-shuffle"></i></button>
                <button id="repeat-btn" class="mode-btn"><i class="fa-solid fa-repeat"></i></button>
            </div>
            
            <div class="full-player-volume">
                <i class="fa-solid fa-volume-low" style="margin-right: 0.5rem; color: #b3b3b3;"></i>
                <input type="range" id="full-volume-slider" class="full-volume-slider" min="0" max="1" step="0.01" value="1">
                <i class="fa-solid fa-volume-high" style="margin-left: 0.5rem; color: #b3b3b3;"></i>
            </div>
        </div>
    </div>
    
    <nav class="bottom-nav">
        <div class="copyright">
            KLMZ Music © 2024
        </div>
        <div class="bottom-nav" style="bottom: 0; height: 64px; border-top: none;">
            <div class="bottom-nav-item active" data-section="home-section">
                <i class="fa-solid fa-house icon"></i>
                <small>Inicio</small>
            </div>
            <div class="bottom-nav-item" data-section="search-section">
                <i class="fa-solid fa-magnifying-glass icon"></i>
                <small>Buscar</small>
            </div>
            <div class="bottom-nav-item" data-section="library-section" id="library-nav-item" style="display:none;">
                <i class="fa-solid fa-book icon"></i>
                <small>Biblioteca</small>
            </div>
            <div class="bottom-nav-item" data-section="admin-section" id="admin-nav-item" style="display:none;">
                <i class="fa-solid fa-wrench icon"></i>
                <small>Admin</small>
            </div>
        </div>
    </nav>
    
    <div id="login-modal" class="modal">
        <div class="modal-content">
            <button class="close-modal">&times;</button>
            <h2 class="modal-header">Iniciar Sesión</h2>
            <form id="login-form">
                <div class="form-group">
                    <label for="login-username">Usuario (admin o user):</label>
                    <input type="text" id="login-username" required value="user">
                </div>
                <div class="form-group">
                    <label for="login-password">Contraseña (Cualquiera):</label>
                    <input type="password" id="login-password" required value="1234">
                </div>
                <button type="submit" class="btn-primary">Entrar</button>
            </form>
            <p>¿No tienes cuenta? <a href="#" id="register-btn-modal">Regístrate aquí</a></p>
        </div>
    </div>

    <div id="register-modal" class="modal">
        <div class="modal-content">
            <button class="close-modal">&times;</button>
            <h2 class="modal-header">Crear Cuenta</h2>
            <form id="register-form">
                <div class="form-group">
                    <label for="register-username">Usuario:</label>
                    <input type="text" id="register-username" required>
                </div>
                <div class="form-group">
                    <label for="register-email">Email:</label>
                    <input type="email" id="register-email" required>
                </div>
                <div class="form-group">
                    <label for="register-password">Contraseña:</label>
                    <input type="password" id="register-password" required>
                </div>
                <button type="submit" class="btn-primary">Registrarse</button>
            </form>
            <p><a href="#" id="login-btn-modal">Volver a Iniciar Sesión</a></p>
        </div>
    </div>
    
    <div id="create-playlist-modal" class="modal">
        <div class="modal-content">
            <button class="close-modal">&times;</button>
            <h2 class="modal-header">Crear Nueva Playlist</h2>
            <form id="create-playlist-form">
                <div class="form-group">
                    <label for="playlist-name-input">Nombre de la Playlist:</label>
                    <input type="text" id="playlist-name-input" required>
                </div>
                <button type="submit" class="btn-primary">Crear</button>
            </form>
        </div>
    </div>

    <div id="add-to-playlist-modal" class="modal">
        <div class="modal-content">
            <button class="close-modal">&times;</button>
            <h2 class="modal-header">Añadir a Playlist</h2>
            <input type="hidden" id="add-to-playlist-song-id">
            <ul id="add-to-playlist-list">
                </ul>
        </div>
    </div>

    <div id="create-album-modal" class="modal">
        <div class="modal-content">
            <button class="close-modal">&times;</button>
            <h2 class="modal-header">Crear Nuevo Álbum</h2>
            <form id="create-album-form">
                <div class="form-group">
                    <label for="album-title-input">Título:</label>
                    <input type="text" id="album-title-input" required>
                </div>
                <div class="form-group">
                    <label for="album-artist-input">Artista:</label>
                    <input type="text" id="album-artist-input" required>
                </div>
                <div class="form-group">
                    <label for="album-year-input">Año:</label>
                    <input type="number" id="album-year-input" value="2024">
                </div>
                <div class="form-group">
                    <label for="album-cover-input">URL de la Portada:</label>
                    <input type="url" id="album-cover-input">
                </div>
                <button type="submit" class="btn-primary">Crear Álbum</button>
            </form>
        </div>
    </div>

    <div id="create-song-modal" class="modal">
        <div class="modal-content">
            <button class="close-modal">&times;</button>
            <h2 id="add-song-modal-title" class="modal-header">Añadir Canción</h2>
            <form id="create-song-form">
                <input type="hidden" id="song-album-id-input">
                <div class="form-group">
                    <label for="song-title-input">Título de la Canción:</label>
                    <input type="text" id="song-title-input" required>
                </div>
                <div class="form-group">
                    <label for="song-url-input">URL del Archivo MP3:</label>
                    <input type="url" id="song-url-input" required>
                </div>
                <div class="form-group">
                    <label for="song-duration-input">Duración (ej: 3:45):</label>
                    <input type="text" id="song-duration-input" required>
                </div>
                <button type="submit" class="btn-primary">Añadir Canción</button>
            </form>
        </div>
    </div>

    <div id="loading-indicator" class="loading-indicator" style="display:none;">
        Cargando datos...
    </div>

    <script>
        // Declaración de variables globales
        let currentSong = null;
        let isPlaying = false;
        let currentPlaylist = [];
        let currentPlaylistIndex = 0;
        let shuffleMode = false;
        let repeatMode = 'none'; // 'none', 'one', 'all'
        let songsWithAlbumInfo = [];
        let userPlaylists = [];
        let isAuthenticated = false;
        let isAdmin = false;

        // Elementos del DOM
        const audio = new Audio();
        const mainContent = document.getElementById('main-content');
        const homeSection = document.getElementById('home-section');
        const searchSection = document.getElementById('search-section');
        const librarySection = document.getElementById('library-section');
        const adminSection = document.getElementById('admin-section');
        const albumDetailSection = document.getElementById('album-detail');
        const playlistDetailSection = document.getElementById('playlist-detail');
        const miniPlayer = document.getElementById('mini-player');
        const fullPlayer = document.getElementById('full-player-backdrop');
        const fullProgressTime = document.getElementById('full-progress-time');
        const fullProgressDuration = document.getElementById('full-progress-duration');
        const fullProgressFill = document.getElementById('full-progress-fill');
        const fullProgressBar = document.getElementById('full-progress-bar');
        const volumeSlider = document.getElementById('full-volume-slider');
        const fullPlayBtn = document.getElementById('full-play-btn');
        const themeSelector = document.getElementById('theme-selector');
        const loginModal = document.getElementById('login-modal');
        const registerModal = document.getElementById('register-modal');
        const createAlbumModal = document.getElementById('create-album-modal');
        const createSongModal = document.getElementById('create-song-modal');
        const createPlaylistModal = document.getElementById('create-playlist-modal');
        const addToPlaylistModal = document.getElementById('add-to-playlist-modal');
        const userMenuDropdown = document.getElementById('user-menu-dropdown');
        const loadingIndicator = document.getElementById('loading-indicator');
        const lockIcon = document.getElementById('lock-icon');

        // --- FUNCIONES DE NAVEGACIÓN Y VISTAS ---

        /** Muestra una sección específica de la aplicación y oculta las demás. */
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            
            // Ocultar detalles al navegar
            albumDetailSection.classList.remove('active');
            playlistDetailSection.classList.remove('active');

            // Actualizar botones de navegación
            document.querySelectorAll('.bottom-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            const navItem = document.querySelector(`.bottom-nav-item[data-section="${sectionId}"]`);
            if (navItem) navItem.classList.add('active');

            // Si es la biblioteca, refrescar las listas
            if (sectionId === 'library-section') {
                renderPlaylists();
                renderFavorites();
                renderDownloads();
            }

            // Si es el admin, refrescar los datos
            if (sectionId === 'admin-section' && isAdmin) {
                renderAdminDashboard();
            }
        }

        /** Abre una modal específica. */
        function openModal(modal) {
            modal.style.display = 'flex';
        }

        /** Cierra una modal específica. */
        function closeModal(modal) {
            modal.style.display = 'none';
        }

        /** Muestra la pantalla de detalle del álbum. */
        function showAlbumDetail(album) {
            document.getElementById('album-detail-img').src = album.cover || 'placeholder-album.png';
            document.getElementById('album-detail-title').textContent = album.title;
            document.getElementById('album-detail-artist').textContent = album.artist;

            const songListUl = document.getElementById('album-song-list-ul');
            songListUl.innerHTML = '';
            
            // Obtener las canciones de ese álbum con sus datos completos
            const albumSongs = songsWithAlbumInfo.filter(song => song.albums.some(a => a.id === album.id));

            albumSongs.forEach((song, index) => {
                const li = createSongListItem(song, index, 'album-detail');
                songListUl.appendChild(li);
            });
            
            // Mostrar la sección de detalle
            document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
            albumDetailSection.classList.add('active');
            albumDetailSection.dataset.albumId = album.id;
        }

        /** Muestra la pantalla de detalle de la playlist. */
        function showPlaylistDetail(playlist) {
            document.getElementById('playlist-detail-title').textContent = playlist.name;
            document.getElementById('playlist-detail-count').textContent = `${playlist.songs.length} canciones`;

            const songListUl = document.getElementById('playlist-song-list-ul');
            songListUl.innerHTML = '';

            const playlistSongs = playlist.songs;
            
            // Reconstruir la lista de canciones para el detalle
            playlistSongs.forEach((song, index) => {
                const fullSongData = songsWithAlbumInfo.find(s => s.id === song.id);
                if (fullSongData) {
                    const li = createSongListItem(fullSongData, index, 'playlist-detail');
                    li.dataset.playlistId = playlist.id;
                    songListUl.appendChild(li);
                }
            });

            // Asignar datos a la sección
            document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
            playlistDetailSection.classList.add('active');
            playlistDetailSection.dataset.playlistId = playlist.id;
        }

        /** Vuelve a la sección principal de la que venía. */
        function goBack() {
            // Lógica simple: si estás en detalle de álbum/playlist, vuelve a la Home/Library.
            if (albumDetailSection.classList.contains('active')) {
                showSection('home-section');
            } else if (playlistDetailSection.classList.contains('active')) {
                showSection('library-section');
            }
        }
        
        // --- FUNCIÓN DE UTILIDAD: RENDERIZAR LISTA DE CANCIONES ---

        /** Crea el elemento <li> para una canción en una lista. */
        function createSongListItem(song, index, context) {
            const li = document.createElement('li');
            li.dataset.songId = song.id;
            li.dataset.songIndex = index;
            li.dataset.context = context;

            const songInfoDiv = document.createElement('div');
            songInfoDiv.className = 'song-info';
            
            const titleSpan = document.createElement('span');
            titleSpan.className = 'song-title';
            titleSpan.textContent = song.title;

            const artistSpan = document.createElement('span');
            artistSpan.className = 'song-artist';
            artistSpan.textContent = song.albums.map(a => a.artist).join(' / ');
            
            songInfoDiv.appendChild(titleSpan);
            songInfoDiv.appendChild(artistSpan);
            li.appendChild(songInfoDiv);

            const metaDiv = document.createElement('div');
            metaDiv.className = 'song-meta';

            // Duración (simulada)
            const durationSpan = document.createElement('span');
            durationSpan.textContent = song.duration || '0:00'; // Usa duración real si existe

            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'song-actions';

            // Icono de Play (para el detalle de playlist/album)
            const playIcon = document.createElement('span');
            playIcon.className = 'fa-solid fa-play play-icon';
            playIcon.dataset.songIndex = index;
            actionsDiv.appendChild(playIcon);

            // Icono de Favorito
            const favIcon = document.createElement('span');
            favIcon.className = 'fa-solid fa-heart fav-icon';
            favIcon.dataset.songId = song.id;
            if (isSongFavorite(song.id)) {
                favIcon.classList.add('active'); // Estilo activo si es favorito
            }
            actionsDiv.appendChild(favIcon);

            // Icono de Add to Playlist
            if (isAuthenticated) {
                const addIcon = document.createElement('span');
                addIcon.className = 'fa-solid fa-plus add-to-playlist-icon';
                addIcon.dataset.songId = song.id;
                actionsDiv.appendChild(addIcon);
            }

            // Icono de Download (si tiene URL y no está descargada)
            if (song.url) {
                const downloadIcon = document.createElement('span');
                if (isSongDownloaded(song.id)) {
                    downloadIcon.className = 'fa-solid fa-cloud-arrow-down download-icon active';
                    downloadIcon.title = 'Descargado';
                } else {
                    downloadIcon.className = 'fa-solid fa-cloud-arrow-down download-icon';
                    downloadIcon.title = 'Descargar';
                }
                downloadIcon.dataset.songId = song.id;
                actionsDiv.appendChild(downloadIcon);
            }

            // Icono de delete (solo en detalle de Playlist)
            if (context === 'playlist-detail') {
                 const deleteIcon = document.createElement('span');
                 deleteIcon.className = 'fa-solid fa-trash delete-from-playlist-icon';
                 deleteIcon.dataset.songId = song.id;
                 actionsDiv.appendChild(deleteIcon);
            }

            metaDiv.appendChild(durationSpan);
            metaDiv.appendChild(actionsDiv);
            li.appendChild(metaDiv);
            
            return li;
        }

        // --- FUNCIÓN DE UTILIDAD: RENDERIZAR VISTAS ---

        /** Renderiza la cuadrícula de álbumes en la vista principal. */
        function renderAlbums(albums) {
            const albumGrid = document.getElementById('album-grid');
            albumGrid.innerHTML = '';
            albums.forEach(album => {
                const card = document.createElement('div');
                card.className = 'album-card';
                card.dataset.albumId = album.id;
                
                const img = document.createElement('img');
                img.className = 'album-img';
                img.src = album.cover || 'placeholder-album.png';
                img.alt = album.title;

                const title = document.createElement('div');
                title.className = 'album-title';
                title.textContent = album.title;

                const artist = document.createElement('div');
                artist.className = 'album-artist';
                artist.textContent = album.artist;

                card.appendChild(img);
                card.appendChild(title);
                card.appendChild(artist);
                albumGrid.appendChild(card);
            });
        }

        /** Renderiza las playlists en la vista de Biblioteca. */
        function renderPlaylists() {
            const playlistList = document.getElementById('playlist-list');
            playlistList.innerHTML = '';
            
            if (userPlaylists.length === 0) {
                 playlistList.innerHTML = '<p style="text-align:center; color:#888;">No tienes playlists. ¡Crea una!</p>';
                 return;
            }

            userPlaylists.forEach(playlist => {
                const item = document.createElement('div');
                item.className = 'playlist-item';
                item.dataset.playlistId = playlist.id;

                const infoDiv = document.createElement('div');
                infoDiv.className = 'playlist-info';
                
                const strongName = document.createElement('strong');
                strongName.textContent = playlist.name;
                infoDiv.appendChild(strongName);

                const smallCount = document.createElement('small');
                smallCount.textContent = `${playlist.songs.length} canciones`;
                infoDiv.appendChild(smallCount);
                item.appendChild(infoDiv);

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'playlist-actions';

                const deleteBtn = document.createElement('span');
                deleteBtn.className = 'fa-solid fa-trash delete-playlist';
                deleteBtn.dataset.playlistId = playlist.id;
                actionsDiv.appendChild(deleteBtn);
                item.appendChild(actionsDiv);
                
                playlistList.appendChild(item);
            });
        }

        /** Renderiza la lista de Favoritos. */
        function renderFavorites() {
            const favoritesList = document.getElementById('favorites-list');
            favoritesList.innerHTML = '';
            const favorites = getFavorites();

            if (favorites.length === 0) {
                favoritesList.innerHTML = '<p style="text-align:center; color:#888;">Aún no tienes canciones favoritas.</p>';
                return;
            }

            favorites.forEach(songId => {
                const song = songsWithAlbumInfo.find(s => s.id === songId);
                if (song) {
                    const item = document.createElement('div');
                    item.className = 'favorite-item';
                    item.dataset.song = JSON.stringify(song); // Almacenar datos completos para reproducir

                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'favorite-info';

                    const titleSpan = document.createElement('span');
                    titleSpan.className = 'favorite-title';
                    titleSpan.textContent = song.title;

                    const artistSpan = document.createElement('span');
                    artistSpan.className = 'favorite-artist';
                    artistSpan.textContent = song.albums.map(a => a.artist).join(' / ');
                    
                    infoDiv.appendChild(titleSpan);
                    infoDiv.appendChild(artistSpan);
                    item.appendChild(infoDiv);

                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'song-actions';

                    const favIcon = document.createElement('span');
                    favIcon.className = 'fa-solid fa-heart fav-icon active'; // Siempre activo en esta vista
                    favIcon.dataset.songId = song.id;
                    actionsDiv.appendChild(favIcon);
                    
                    item.appendChild(actionsDiv);
                    favoritesList.appendChild(item);
                }
            });
        }

        /** Renderiza la lista de Descargas (simuladas). */
        function renderDownloads() {
             const downloadsList = document.getElementById('downloads-list');
             downloadsList.innerHTML = '';
             const downloads = getDownloads();

             if (downloads.length === 0) {
                 downloadsList.innerHTML = '<p style="text-align:center; color:#888;">No tienes canciones descargadas.</p>';
                 return;
             }

             downloads.forEach(songId => {
                 const song = songsWithAlbumInfo.find(s => s.id === songId);
                 if (song) {
                     const item = document.createElement('div');
                     item.className = 'download-item';
                     item.dataset.song = JSON.stringify(song); 

                     const infoDiv = document.createElement('div');
                     infoDiv.className = 'download-info';

                     const titleSpan = document.createElement('span');
                     titleSpan.className = 'download-title';
                     titleSpan.textContent = song.title;

                     const artistSpan = document.createElement('span');
                     artistSpan.className = 'download-artist';
                     artistSpan.textContent = song.albums.map(a => a.artist).join(' / ');
                    
                     infoDiv.appendChild(titleSpan);
                     infoDiv.appendChild(artistSpan);
                     item.appendChild(infoDiv);

                     const actionsDiv = document.createElement('div');
                     actionsDiv.className = 'download-item-actions';
                     
                     // Icono de play (para reproducir)
                     const playIcon = document.createElement('span');
                     playIcon.className = 'fa-solid fa-play play-icon';
                     playIcon.dataset.songId = song.id;
                     actionsDiv.appendChild(playIcon);
                     
                     // Icono de eliminar descarga
                     const deleteIcon = document.createElement('span');
                     deleteIcon.className = 'fa-solid fa-xmark delete-download';
                     deleteIcon.dataset.songId = song.id;
                     actionsDiv.appendChild(deleteIcon);
                    
                     item.appendChild(actionsDiv);
                     downloadsList.appendChild(item);
                 }
             });
        }

        /** Renderiza la vista de administrador. */
        function renderAdminDashboard() {
            const adminAlbumList = document.getElementById('admin-album-list');
            adminAlbumList.innerHTML = '';
            
            // 1. Renderizar Estadísticas
            document.getElementById('stat-albums').textContent = globalAlbums.length;
            document.getElementById('stat-songs').textContent = globalSongs.length;
            document.getElementById('stat-playlists').textContent = userPlaylists.length;
            
            // 2. Renderizar lista de álbumes para administración
            globalAlbums.forEach(album => {
                const item = document.createElement('div');
                item.className = 'admin-album-item';
                item.dataset.albumId = album.id;
                
                const header = document.createElement('div');
                header.className = 'admin-album-header';
                
                const info = document.createElement('div');
                info.className = 'admin-item-info';
                info.innerHTML = `<strong>${album.title}</strong> <small>${album.artist} - ${album.year || 'N/A'} ${album.isHidden ? '<span class="hidden-badge">Oculto</span>' : ''}</small>`;
                header.appendChild(info);

                const actions = document.createElement('div');
                actions.className = 'admin-item-actions';
                
                const addSongBtn = document.createElement('button');
                addSongBtn.className = 'btn-secondary add-song-btn';
                addSongBtn.textContent = 'Añadir Canción';
                addSongBtn.dataset.albumId = album.id;
                actions.appendChild(addSongBtn);
                
                const toggleHiddenBtn = document.createElement('button');
                toggleHiddenBtn.className = album.isHidden ? 'btn-primary' : 'btn-danger';
                toggleHiddenBtn.textContent = album.isHidden ? 'Mostrar' : 'Ocultar';
                toggleHiddenBtn.dataset.albumId = album.id;
                toggleHiddenBtn.dataset.action = album.isHidden ? 'show' : 'hide';
                actions.appendChild(toggleHiddenBtn);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn-danger delete-album-btn';
                deleteBtn.textContent = 'Eliminar Álbum';
                deleteBtn.dataset.albumId = album.id;
                actions.appendChild(deleteBtn);
                
                header.appendChild(actions);
                item.appendChild(header);

                // Lista de Canciones del álbum
                const songListDiv = document.createElement('div');
                songListDiv.className = 'admin-song-list';
                
                const songs = globalSongs.filter(s => s.albums.includes(album.id));
                
                if (songs.length === 0) {
                    songListDiv.innerHTML = '<p class="no-songs">No hay canciones en este álbum.</p>';
                } else {
                    songs.forEach(song => {
                        const songItem = document.createElement('div');
                        songItem.className = 'admin-song-item';
                        songItem.dataset.songId = song.id;

                        const songInfo = document.createElement('span');
                        songInfo.textContent = song.title;
                        songItem.appendChild(songInfo);

                        const songActions = document.createElement('div');
                        songActions.className = 'admin-song-actions';

                        const deleteSongBtn = document.createElement('button');
                        deleteSongBtn.className = 'btn-danger delete-song-btn';
                        deleteSongBtn.textContent = 'Eliminar';
                        deleteSongBtn.dataset.songId = song.id;
                        deleteSongBtn.dataset.albumId = album.id; // Para la lógica de actualización
                        songActions.appendChild(deleteSongBtn);

                        songItem.appendChild(songActions);
                        songListDiv.appendChild(songItem);
                    });
                }

                item.appendChild(songListDiv);
                adminAlbumList.appendChild(item);
            });
        }

        // --- FUNCIONES DE REPRODUCCIÓN ---

        /** Reproduce una canción. */
        function playSong(song, albumInfo, currentQueue, queueIndex) {
            if (!song || !song.url) {
                Swal.fire('Error', 'No se pudo encontrar la URL de la canción.', 'error');
                return;
            }

            // 1. Actualizar estado y cola
            currentSong = song;
            currentPlaylist = currentQueue;
            currentPlaylistIndex = queueIndex;

            // 2. Configurar y reproducir
            audio.src = song.url;
            audio.play().then(() => {
                isPlaying = true;
                updatePlayerUI(song, albumInfo);
            }).catch(error => {
                console.error("Error al intentar reproducir el audio:", error);
                Swal.fire('Error de Reproducción', 'El navegador bloqueó la reproducción automática o no se pudo cargar el archivo.', 'error');
                isPlaying = false;
                updatePlayerUI(song, albumInfo); // Actualiza la UI a pesar del error
            });
        }

        /** Reproduce la siguiente canción en la lista. */
        function playNextSong() {
            if (currentPlaylist.length === 0) return;

            let nextIndex = currentPlaylistIndex;

            if (repeatMode === 'one') {
                // Reproducir la misma canción
                nextIndex = currentPlaylistIndex;
            } else if (shuffleMode) {
                // Modo aleatorio
                let newIndex;
                do {
                    newIndex = Math.floor(Math.random() * currentPlaylist.length);
                } while (newIndex === currentPlaylistIndex && currentPlaylist.length > 1); // Evitar la misma si es posible
                nextIndex = newIndex;
            } else {
                // Modo normal/repetir lista
                nextIndex = (currentPlaylistIndex + 1) % currentPlaylist.length;
            }

            // Si es la última y no está en modo repetir lista ('all'), detener
            if (nextIndex === 0 && currentPlaylistIndex === currentPlaylist.length - 1 && repeatMode !== 'all') {
                audio.pause();
                isPlaying = false;
                updatePlayerControls();
                return;
            }

            const nextSong = currentPlaylist[nextIndex];
            const albumInfo = nextSong.albums; // Ya son los datos de álbum completos
            playSong(nextSong, albumInfo, currentPlaylist, nextIndex);
        }

        /** Actualiza la interfaz de usuario del reproductor mini y full. */
        function updatePlayerUI(song, albumInfo) {
            const album = albumInfo[0] || { cover: 'placeholder-album.png', artist: 'Artista Desconocido' };
            
            // Mini Player
            document.getElementById('player-img-mini').src = album.cover;
            document.getElementById('player-title-mini').textContent = song.title;
            document.getElementById('player-artist-mini').textContent = album.artist;
            miniPlayer.style.display = 'flex'; // Asegura que se muestre el mini reproductor

            // Full Player
            document.getElementById('full-player-cover').src = album.cover;
            document.getElementById('full-player-title').textContent = song.title;
            document.getElementById('full-player-artist').textContent = album.artist;

            updatePlayerControls();
        }

        /** Actualiza los iconos de Play/Pause. */
        function updatePlayerControls() {
            const iconClass = isPlaying ? 'fa-pause' : 'fa-play';
            document.getElementById('play-btn-inline').className = `fa-solid ${iconClass} play-btn-inline`;
            fullPlayBtn.className = `fa-solid ${iconClass} full-play-btn`;
        }

        /** Abre el reproductor en pantalla completa. */
        function openFullPlayer() {
            if (currentSong) {
                fullPlayer.classList.add('active');
            }
        }

        /** Cierra el reproductor en pantalla completa. */
        function closeFullPlayer() {
            fullPlayer.classList.remove('active');
        }

        // --- MANEJO DE ESTADO DE SESIÓN Y DATOS ---

        /** Carga los datos iniciales de la aplicación. */
        function loadInitialData() {
            showLoading();
            // Simulación de carga de datos desde un "servidor"
            setTimeout(() => {
                // Cargar álbumes y canciones (datos globales)
                const { songs, albums } = getGlobalMusicData();
                globalAlbums = albums;
                globalSongs = songs;

                // Combinar info de álbum en las canciones para facilitar el uso
                songsWithAlbumInfo = globalSongs.map(song => ({
                    ...song,
                    albums: song.albums.map(albumId => globalAlbums.find(a => a.id === albumId)).filter(a => a)
                }));
                
                // Filtrar los álbumes no ocultos para la vista de inicio
                const visibleAlbums = globalAlbums.filter(a => !a.isHidden);
                renderAlbums(visibleAlbums);
                
                // Cargar estado de sesión
                checkAuthStatus();
                
                hideLoading();
            }, 500);
        }

        /** Verifica el estado de autenticación del usuario. */
        function checkAuthStatus() {
            const storedAuth = localStorage.getItem('klmz_auth');
            if (storedAuth) {
                const userData = JSON.parse(storedAuth);
                isAuthenticated = true;
                isAdmin = userData.role === 'admin';
                document.getElementById('user-menu-btn').innerHTML = `<i class="fa-solid fa-user"></i>`;
                document.getElementById('user-menu-btn').style.display = 'block';
                document.getElementById('auth-buttons').style.display = 'none';

                // Actualizar menú
                document.getElementById('user-info-username').textContent = userData.username;
                document.getElementById('user-info-role').textContent = isAdmin ? 'Administrador' : 'Usuario';

                // Mostrar/Ocultar secciones
                document.getElementById('library-nav-item').style.display = 'flex';
                document.getElementById('admin-nav-item').style.display = isAdmin ? 'flex' : 'none';
                document.getElementById('admin-link-dropdown').style.display = isAdmin ? 'block' : 'none';
                
                // Cargar datos de usuario (playlists)
                userPlaylists = getStoredPlaylists(userData.username);
                renderPlaylists(); // Solo renderiza si está autenticado
            } else {
                isAuthenticated = false;
                isAdmin = false;
                document.getElementById('user-menu-btn').style.display = 'none';
                document.getElementById('auth-buttons').style.display = 'flex';
                document.getElementById('library-nav-item').style.display = 'none';
                document.getElementById('admin-nav-item').style.display = 'none';
            }
        }

        /** Muestra el indicador de carga. */
        function showLoading() {
            loadingIndicator.style.display = 'flex';
        }

        /** Oculta el indicador de carga. */
        function hideLoading() {
            loadingIndicator.style.display = 'none';
        }

        // --- LOCAL STORAGE Y PERSISTENCIA ---

        /** Obtiene los datos de música global (simulados). */
        function getGlobalMusicData() {
            // Cargar o inicializar datos si no existen
            const storedAlbums = JSON.parse(localStorage.getItem('klmz_albums')) || initialData.albums;
            const storedSongs = JSON.parse(localStorage.getItem('klmz_songs')) || initialData.songs;
            
            // Si es la primera carga, guardar los datos iniciales
            if (!localStorage.getItem('klmz_albums')) {
                localStorage.setItem('klmz_albums', JSON.stringify(initialData.albums));
                localStorage.setItem('klmz_songs', JSON.stringify(initialData.songs));
            }

            return { albums: storedAlbums, songs: storedSongs };
        }

        /** Obtiene las playlists del usuario actual. */
        function getStoredPlaylists(username) {
            const allPlaylists = JSON.parse(localStorage.getItem('klmz_playlists')) || {};
            return allPlaylists[username] || [];
        }

        /** Guarda las playlists del usuario actual. */
        function savePlaylists() {
            const storedAuth = JSON.parse(localStorage.getItem('klmz_auth'));
            if (!storedAuth) return;

            const allPlaylists = JSON.parse(localStorage.getItem('klmz_playlists')) || {};
            allPlaylists[storedAuth.username] = userPlaylists;
            localStorage.setItem('klmz_playlists', JSON.stringify(allPlaylists));
        }

        /** Obtiene la lista de favoritos del usuario. */
        function getFavorites() {
            const storedAuth = JSON.parse(localStorage.getItem('klmz_auth'));
            if (!storedAuth) return [];
            return JSON.parse(localStorage.getItem(`klmz_favorites_${storedAuth.username}`)) || [];
        }

        /** Guarda la lista de favoritos del usuario. */
        function saveFavorites(favorites) {
            const storedAuth = JSON.parse(localStorage.getItem('klmz_auth'));
            if (!storedAuth) return;
            localStorage.setItem(`klmz_favorites_${storedAuth.username}`, JSON.stringify(favorites));
        }

        /** Verifica si una canción es favorita. */
        function isSongFavorite(songId) {
            return getFavorites().includes(songId);
        }

        /** Obtiene la lista de descargas del usuario. */
        function getDownloads() {
            const storedAuth = JSON.parse(localStorage.getItem('klmz_auth'));
            if (!storedAuth) return [];
            return JSON.parse(localStorage.getItem(`klmz_downloads_${storedAuth.username}`)) || [];
        }

        /** Guarda la lista de descargas del usuario. */
        function saveDownloads(downloads) {
            const storedAuth = JSON.parse(localStorage.getItem('klmz_auth'));
            if (!storedAuth) return;
            localStorage.setItem(`klmz_downloads_${storedAuth.username}`, JSON.stringify(downloads));
        }

        /** Verifica si una canción está descargada. */
        function isSongDownloaded(songId) {
            return getDownloads().includes(songId);
        }

        // --- ADMINISTRACIÓN DE DATOS ---

        /** Crea un nuevo álbum (Admin). */
        function createAlbum(title, artist, year, cover) {
            const newAlbum = {
                id: Date.now().toString(),
                title: title,
                artist: artist,
                year: year,
                cover: cover || 'placeholder-album.png',
                songs: [],
                isHidden: false
            };
            globalAlbums.push(newAlbum);
            localStorage.setItem('klmz_albums', JSON.stringify(globalAlbums));
            loadInitialData(); // Refrescar vistas
            renderAdminDashboard();
            Swal.fire('Éxito', 'Álbum creado correctamente.', 'success');
        }

        /** Añade una nueva canción a un álbum (Admin). */
        function addSongToAlbum(title, url, duration, albumId) {
            const newSong = {
                id: Date.now().toString(),
                title: title,
                url: url,
                duration: duration,
                albums: [albumId]
            };
            globalSongs.push(newSong);
            localStorage.setItem('klmz_songs', JSON.stringify(globalSongs));
            loadInitialData(); // Refrescar todo
            renderAdminDashboard();
            Swal.fire('Éxito', 'Canción añadida correctamente.', 'success');
        }

        /** Elimina una canción (Admin). */
        function deleteSong(songId) {
            globalSongs = globalSongs.filter(s => s.id !== songId);
            // También eliminar referencias de álbumes
            globalAlbums.forEach(album => {
                const index = album.songs.indexOf(songId);
                if (index > -1) {
                    album.songs.splice(index, 1);
                }
            });

            localStorage.setItem('klmz_songs', JSON.stringify(globalSongs));
            localStorage.setItem('klmz_albums', JSON.stringify(globalAlbums));
            
            // También eliminar de todas las playlists de todos los usuarios
            const allPlaylists = JSON.parse(localStorage.getItem('klmz_playlists')) || {};
            for (const username in allPlaylists) {
                allPlaylists[username].forEach(playlist => {
                    playlist.songs = playlist.songs.filter(s => s.id !== songId);
                });
            }
            localStorage.setItem('klmz_playlists', JSON.stringify(allPlaylists));

            loadInitialData();
            renderAdminDashboard();
        }

        // --- DATOS DE MÚSICA SIMULADOS ---
        let globalAlbums = [];
        let globalSongs = [];
        
        const initialData = {
            albums: [
                { id: 'a1', title: 'The Wall', artist: 'Pink Floyd', year: 1979, cover: 'https://i.ebayimg.com/images/g/e9IAAOSwR4hV3jE6/s-l1600.jpg', isHidden: false },
                { id: 'a2', title: 'Thriller', artist: 'Michael Jackson', year: 1982, cover: 'https://cdn.shopify.com/s/files/1/0530/2324/9181/products/Thriller.jpg?v=1647413554', isHidden: false },
                { id: 'a3', title: 'The Dark Side of the Moon', artist: 'Pink Floyd', year: 1973, cover: 'https://i.ebayimg.com/images/g/o00AAOSw20pYg2oU/s-l1600.jpg', isHidden: false },
                { id: 'a4', title: 'Back in Black', artist: 'AC/DC', year: 1980, cover: 'https://i.ebayimg.com/images/g/m4gAAOSwW-xY~T7o/s-l1600.jpg', isHidden: false },
                { id: 'a5', title: 'Rumours', artist: 'Fleetwood Mac', year: 1977, cover: 'https://i.ebayimg.com/images/g/p4MAAOSwJj5j0i6V/s-l1600.jpg', isHidden: false },
                { id: 'a6', title: 'The Bends', artist: 'Radiohead', year: 1995, cover: 'https://i.ebayimg.com/images/g/VlAAAOSwXUleP6p0/s-l1600.jpg', isHidden: false },
                { id: 'a7', title: 'Hybrid Theory', artist: 'Linkin Park', year: 2000, cover: 'https://i.ebayimg.com/images/g/e9IAAOSw06BfC6t~/s-l1600.jpg', isHidden: true },
                { id: 'a8', title: 'Abbey Road', artist: 'The Beatles', year: 1969, cover: 'https://i.ebayimg.com/images/g/e7AAAOSw4eRja6Vf/s-l1600.jpg', isHidden: false },
            ],
            songs: [
                { id: 's1', title: 'Another Brick in the Wall, Pt. 2', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3', duration: '3:59', albums: ['a1'] },
                { id: 's2', title: 'Comfortably Numb', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3', duration: '6:23', albums: ['a1'] },
                { id: 's3', title: 'Thriller', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3', duration: '5:57', albums: ['a2'] },
                { id: 's4', title: 'Billie Jean', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3', duration: '4:54', albums: ['a2'] },
                { id: 's5', title: 'Money', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3', duration: '6:22', albums: ['a3'] },
                { id: 's6', title: 'Back in Black', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-6.mp3', duration: '4:15', albums: ['a4'] },
                { id: 's7', title: 'Go Your Own Way', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-7.mp3', duration: '3:38', albums: ['a5'] },
                { id: 's8', title: 'High and Dry', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3', duration: '4:17', albums: ['a6'] },
                { id: 's9', title: 'One Step Closer', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-9.mp3', duration: '2:35', albums: ['a7'] },
                { id: 's10', title: 'Come Together', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-10.mp3', duration: '4:20', albums: ['a8'] },
                { id: 's11', title: 'Lateralus (Tool)', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-11.mp3', duration: '9:24', albums: ['a2'] }, // Canción extra en álbum existente
            ]
        };

        // --- EVENTOS DEL REPRODUCTOR (AUDIO) ---

        audio.addEventListener('timeupdate', () => {
            if (currentSong) {
                const percentage = (audio.currentTime / audio.duration) * 100;
                fullProgressFill.style.width = `${percentage}%`;
                
                const formatTime = (seconds) => {
                    const min = Math.floor(seconds / 60);
                    const sec = Math.floor(seconds % 60);
                    return `${min}:${sec.toString().padStart(2, '0')}`;
                };

                fullProgressTime.textContent = formatTime(audio.currentTime);
                if (!isNaN(audio.duration)) {
                    fullProgressDuration.textContent = formatTime(audio.duration);
                }
            }
        });

        audio.addEventListener('ended', () => {
            if (repeatMode === 'one') {
                audio.currentTime = 0;
                audio.play();
            } else {
                playNextSong();
            }
        });

        fullProgressBar.addEventListener('click', (e) => {
            const width = fullProgressBar.clientWidth;
            const clickX = e.offsetX;
            const percentage = (clickX / width);
            
            if (!isNaN(audio.duration)) {
                audio.currentTime = audio.duration * percentage;
            }
        });

        volumeSlider.addEventListener('input', (e) => {
            audio.volume = e.target.value;
        });
        
        // --- LISTENERS DE INTERFAZ ---
        
        document.addEventListener('DOMContentLoaded', () => {
            loadInitialData();
            showSection('home-section'); // Iniciar en la home
            
            // Establecer tema
            const savedTheme = localStorage.getItem('klmz_theme') || 'theme-default';
            document.body.className = savedTheme;
            themeSelector.value = savedTheme;
            
            // Listener de temas
            themeSelector.addEventListener('change', (e) => {
                const newTheme = e.target.value;
                document.body.className = newTheme;
                localStorage.setItem('klmz_theme', newTheme);
            });

            // Navegación (Bottom Nav)
            document.querySelectorAll('.bottom-nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    const sectionId = item.dataset.section;
                    if (sectionId) {
                        showSection(sectionId);
                    }
                });
            });

            // Botón de Volver
            document.querySelectorAll('.back-btn').forEach(btn => {
                btn.addEventListener('click', goBack);
            });

            // Control de Play/Pause en mini y full player
            document.getElementById('play-btn-inline').addEventListener('click', (e) => {
                e.stopPropagation(); // Evita que se abra el full player
                if (currentSong) {
                    if (isPlaying) {
                        audio.pause();
                    } else {
                        audio.play();
                    }
                    isPlaying = !isPlaying;
                    updatePlayerControls();
                }
            });

            fullPlayBtn.addEventListener('click', () => {
                if (currentSong) {
                    if (isPlaying) {
                        audio.pause();
                    } else {
                        audio.play();
                    }
                    isPlaying = !isPlaying;
                    updatePlayerControls();
                }
            });

            document.getElementById('full-player-close').addEventListener('click', closeFullPlayer);

            // Controles de modo de reproducción
            document.getElementById('shuffle-btn').addEventListener('click', (e) => {
                shuffleMode = !shuffleMode;
                e.currentTarget.classList.toggle('active', shuffleMode);
                Swal.fire({ toast: true, position: 'bottom-end', showConfirmButton: false, timer: 1500, icon: 'info', title: shuffleMode ? 'Modo Aleatorio ON' : 'Modo Aleatorio OFF' });
            });

            document.getElementById('repeat-btn').addEventListener('click', (e) => {
                const btn = e.currentTarget;
                if (repeatMode === 'none') {
                    repeatMode = 'all';
                    btn.classList.add('active');
                    btn.querySelector('.fa-solid').className = 'fa-solid fa-repeat';
                    Swal.fire({ toast: true, position: 'bottom-end', showConfirmButton: false, timer: 1500, icon: 'info', title: 'Repetir Lista' });
                } else if (repeatMode === 'all') {
                    repeatMode = 'one';
                    btn.querySelector('.fa-solid').className = 'fa-solid fa-repeat fa-sm'; // Icono pequeño
                    Swal.fire({ toast: true, position: 'bottom-end', showConfirmButton: false, timer: 1500, icon: 'info', title: 'Repetir Canción' });
                } else {
                    repeatMode = 'none';
                    btn.classList.remove('active');
                    btn.querySelector('.fa-solid').className = 'fa-solid fa-repeat';
                    Swal.fire({ toast: true, position: 'bottom-end', showConfirmButton: false, timer: 1500, icon: 'info', title: 'Repetir OFF' });
                }
            });

            document.getElementById('prev-btn').addEventListener('click', () => {
                 if (currentPlaylist.length === 0) return;
                 let prevIndex = currentPlaylistIndex - 1;
                 if (prevIndex < 0) {
                     prevIndex = currentPlaylist.length - 1;
                 }
                 const prevSong = currentPlaylist[prevIndex];
                 playSong(prevSong, prevSong.albums, currentPlaylist, prevIndex);
            });

            document.getElementById('next-btn').addEventListener('click', playNextSong);
            
            // Búsqueda
            document.getElementById('search-input').addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                const searchResults = document.getElementById('search-results');
                searchResults.innerHTML = '';

                if (query.length < 2) {
                    searchResults.style.display = 'none';
                    return;
                }

                searchResults.style.display = 'block';

                // 1. Buscar Canciones
                const matchingSongs = songsWithAlbumInfo.filter(song => 
                    song.title.toLowerCase().includes(query) || 
                    song.albums.some(a => a.artist.toLowerCase().includes(query))
                ).slice(0, 10);

                if (matchingSongs.length > 0) {
                    searchResults.innerHTML += '<h3>Canciones</h3>';
                    matchingSongs.forEach(song => {
                        const item = document.createElement('div');
                        item.className = 'search-song-item';
                        item.dataset.songId = song.id;

                        const infoDiv = document.createElement('div');
                        infoDiv.className = 'search-song-info';
                        infoDiv.innerHTML = `<div class="search-song-title">${song.title}</div><div class="search-song-artist">${song.albums.map(a => a.artist).join(' / ')}</div>`;
                        item.appendChild(infoDiv);

                        const actionsDiv = document.createElement('div');
                        actionsDiv.className = 'song-actions';

                        // Icono de Play
                        const playIcon = document.createElement('span');
                        playIcon.className = 'fa-solid fa-play play-icon';
                        playIcon.dataset.songId = song.id;
                        actionsDiv.appendChild(playIcon);

                        item.appendChild(actionsDiv);
                        searchResults.appendChild(item);
                    });
                }
                
                // 2. Buscar Álbumes
                const matchingAlbums = globalAlbums.filter(album => 
                    album.title.toLowerCase().includes(query) || 
                    album.artist.toLowerCase().includes(query)
                ).filter(a => !a.isHidden).slice(0, 5);

                if (matchingAlbums.length > 0) {
                    searchResults.innerHTML += '<h3>Álbumes</h3>';
                    matchingAlbums.forEach(album => {
                        const item = document.createElement('div');
                        item.className = 'search-album-item';
                        item.dataset.albumId = album.id;
                        
                        const img = document.createElement('img');
                        img.className = 'search-album-img';
                        img.src = album.cover || 'placeholder-album.png';
                        item.appendChild(img);

                        const infoDiv = document.createElement('div');
                        infoDiv.className = 'search-album-info';
                        infoDiv.innerHTML = `<div class="search-album-title">${album.title}</div><div class="search-album-artist">${album.artist}</div>`;
                        item.appendChild(infoDiv);
                        searchResults.appendChild(item);
                    });
                }

                if (matchingSongs.length === 0 && matchingAlbums.length === 0) {
                    searchResults.innerHTML = '<p style="text-align:center; color:#888;">No se encontraron resultados.</p>';
                }
            });

            // --- LÓGICA DE EVENTOS DE CLICKS DE TODA LA APP ---
            
            document.addEventListener('click', (e) => {
                // Navegación a detalle de álbum
                const albumCard = e.target.closest('.album-card');
                if (albumCard) {
                    const albumId = albumCard.dataset.albumId;
                    const album = globalAlbums.find(a => a.id === albumId);
                    if (album) {
                        showAlbumDetail(album);
                    }
                    return;
                }

                // Navegación a detalle de playlist
                const playlistItem = e.target.closest('.playlist-item');
                if (playlistItem && !e.target.matches('.delete-playlist')) {
                    const playlistId = playlistItem.dataset.playlistId;
                    const playlist = userPlaylists.find(p => p.id === playlistId);
                    if (playlist) {
                        showPlaylistDetail(playlist);
                    }
                    return;
                }
                
                // Reproducir desde búsqueda (Álbum)
                const searchAlbumItem = e.target.closest('.search-album-item');
                if (searchAlbumItem) {
                    const albumId = searchAlbumItem.dataset.albumId;
                    const album = globalAlbums.find(a => a.id === albumId);
                    if (album) {
                        showAlbumDetail(album); // Abrir detalle del álbum
                    }
                    return;
                }

                // Reproducir desde la lista de canciones de Album/Playlist
                const songLi = e.target.closest('#album-song-list-ul li, #playlist-song-list-ul li');
                if (songLi && !e.target.closest('.song-actions')) {
                    const songId = songLi.dataset.songId;
                    const song = songsWithAlbumInfo.find(s => s.id === songId);
                    
                    if (song) {
                        let queue = [];
                        let index = 0;
                        
                        if (songLi.dataset.context === 'album-detail') {
                            // Obtener todas las canciones del álbum como cola
                            const albumId = albumDetailSection.dataset.albumId;
                            const albumSongs = songsWithAlbumInfo.filter(s => s.albums.some(a => a.id === albumId));
                            queue = albumSongs;
                            index = queue.findIndex(s => s.id === songId);
                        } else if (songLi.dataset.context === 'playlist-detail') {
                            // Obtener todas las canciones de la playlist como cola
                            const playlistId = playlistDetailSection.dataset.playlistId;
                            const playlist = userPlaylists.find(p => p.id === playlistId);
                            if (playlist) {
                                // Obtener los datos completos de las canciones de la playlist
                                queue = playlist.songs.map(ps => songsWithAlbumInfo.find(s => s.id === ps.id)).filter(s => s);
                                index = queue.findIndex(s => s.id === songId);
                            }
                        }
                        
                        // Si la canción está en una lista de reproducción/álbum, se reproduce con esa cola
                        if (queue.length > 0 && index >= 0) {
                             playSong(song, song.albums, queue, index);
                        } else {
                            // Si falla la cola, reproducir solo la canción
                            playSong(song, song.albums, [song], 0);
                        }
                    }
                    return;
                }
                
                // Reproducir desde el icono de Play en la lista de canciones
                if (e.target.matches('.play-icon:not(.play-btn-inline)')) {
                    const songId = e.target.closest('[data-song-id]').dataset.songId;
                    const song = songsWithAlbumInfo.find(s => s.id === songId);

                    if (song) {
                        const songElement = e.target.closest('[data-song-id]');
                        const context = songElement.dataset.context;
                        let queue = [];
                        let index = 0;

                        if (context === 'album-detail') {
                            const albumId = albumDetailSection.dataset.albumId;
                            const albumSongs = songsWithAlbumInfo.filter(s => s.albums.some(a => a.id === albumId));
                            queue = albumSongs;
                            index = queue.findIndex(s => s.id === songId);
                        } else if (context === 'playlist-detail') {
                            const playlistId = playlistDetailSection.dataset.playlistId;
                            const playlist = userPlaylists.find(p => p.id === playlistId);
                            if (playlist) {
                                queue = playlist.songs.map(ps => songsWithAlbumInfo.find(s => s.id === ps.id)).filter(s => s);
                                index = queue.findIndex(s => s.id === songId);
                            }
                        } else if (e.target.closest('.search-song-item')) {
                            // Si es en búsqueda, la cola es solo la canción
                            queue = [song];
                            index = 0;
                        } else if (e.target.closest('.download-item')) {
                            // Si es en descargas, la cola es solo la canción
                            queue = [song];
                            index = 0;
                        }

                        if (queue.length > 0 && index >= 0) {
                             playSong(song, song.albums, queue, index);
                        } else {
                            playSong(song, song.albums, [song], 0);
                        }
                    }
                    return;
                }

                // Abrir Full Player al hacer clic en Mini Player
                if (e.target.closest('#mini-player') && !e.target.closest('.player-controls-inline')) { 
                    openFullPlayer(); 
                    return;
                }
                
                // --- LÓGICA DE ACCIONES DE USUARIO ---

                // Toggle Favorito
                if (isAuthenticated && e.target.matches('.fav-icon')) {
                    const songId = e.target.dataset.songId;
                    let favorites = getFavorites();

                    if (favorites.includes(songId)) {
                        favorites = favorites.filter(id => id !== songId);
                        e.target.classList.remove('active');
                        Swal.fire({ toast: true, position: 'bottom-end', showConfirmButton: false, timer: 1500, icon: 'info', title: 'Eliminado de Favoritos' });
                    } else {
                        favorites.push(songId);
                        e.target.classList.add('active');
                        Swal.fire({ toast: true, position: 'bottom-end', showConfirmButton: false, timer: 1500, icon: 'success', title: 'Añadido a Favoritos' });
                    }
                    
                    saveFavorites(favorites);
                    // Si estamos en la vista de Favoritos, refrescar
                    if (librarySection.classList.contains('active')) {
                        renderFavorites();
                    }
                    // Si estamos en detalle de playlist/album, refrescar solo los iconos
                    if (albumDetailSection.classList.contains('active') || playlistDetailSection.classList.contains('active')) {
                        document.querySelectorAll(`.fav-icon[data-song-id="${songId}"]`).forEach(icon => {
                            icon.classList.toggle('active', favorites.includes(songId));
                        });
                    }
                    return;
                }

                // Eliminar canción de Playlist (desde detalle)
                if (isAuthenticated && e.target.matches('.delete-from-playlist-icon')) {
                    const songId = e.target.dataset.songId;
                    const playlistId = playlistDetailSection.dataset.playlistId;
                    const playlist = userPlaylists.find(p => p.id === playlistId);
                    
                    if (playlist) {
                        playlist.songs = playlist.songs.filter(s => s.id !== songId);
                        savePlaylists();
                        Swal.fire('Éxito', 'Canción eliminada de la playlist.', 'success');
                        showPlaylistDetail(playlist); // Refrescar la vista
                    }
                    return;
                }

                // Abrir modal de Añadir a Playlist
                if (isAuthenticated && e.target.matches('.add-to-playlist-icon')) {
                    const songId = e.target.dataset.songId;
                    document.getElementById('add-to-playlist-song-id').value = songId;
                    
                    const listUl = document.getElementById('add-to-playlist-list');
                    listUl.innerHTML = '';
                    
                    userPlaylists.forEach(playlist => {
                        const li = document.createElement('li');
                        li.textContent = playlist.name;
                        li.dataset.playlistId = playlist.id;
                        listUl.appendChild(li);
                    });
                    
                    openModal(addToPlaylistModal);
                    return;
                }

                // Añadir canción a Playlist (desde modal)
                if (e.target.closest('#add-to-playlist-modal') && e.target.matches('li')) {
                    const playlistId = e.target.dataset.playlistId;
                    const songId = document.getElementById('add-to-playlist-song-id').value;
                    
                    const playlist = userPlaylists.find(p => p.id === playlistId);
                    const song = songsWithAlbumInfo.find(s => s.id === songId);

                    if (playlist && song) {
                        // Verifica si la canción ya existe en la playlist para evitar duplicados
                        if (!playlist.songs.some(s => s.id === songId)) {
                            // Solo guardar ID, no el objeto completo para ligereza
                            playlist.songs.push({ id: song.id, title: song.title }); 
                            savePlaylists();
                            Swal.fire({ toast: true, position: 'bottom-end', showConfirmButton: false, timer: 1500, icon: 'success', title: `Añadido a ${playlist.name}` });
                        } else {
                            Swal.fire({ toast: true, position: 'bottom-end', showConfirmButton: false, timer: 1500, icon: 'warning', title: 'La canción ya está en esta playlist' });
                        }
                    }
                    closeModal(addToPlaylistModal);
                    return;
                }
                
                // Descargar/Eliminar Descarga
                if (isAuthenticated && e.target.matches('.download-icon')) {
                    const songId = e.target.dataset.songId;
                    let downloads = getDownloads();

                    if (downloads.includes(songId)) {
                        // Es un icono activo: eliminar descarga
                        downloads = downloads.filter(id => id !== songId);
                        e.target.classList.remove('active');
                        Swal.fire({ toast: true, position: 'bottom-end', showConfirmButton: false, timer: 1500, icon: 'info', title: 'Descarga Eliminada' });
                    } else {
                        // Es un icono inactivo: descargar (simulación)
                        downloads.push(songId);
                        e.target.classList.add('active');
                        Swal.fire({ toast: true, position: 'bottom-end', showConfirmButton: false, timer: 1500, icon: 'success', title: 'Descargando (Simulación)' });
                    }
                    
                    saveDownloads(downloads);
                    // Si estamos en la vista de Descargas, refrescar
                    if (librarySection.classList.contains('active')) {
                        renderDownloads();
                    }
                    return;
                }
                
                // Eliminar descarga desde la lista de Descargas
                 if (isAuthenticated && e.target.matches('.delete-download')) {
                    const songId = e.target.dataset.songId;
                    let downloads = getDownloads();
                    downloads = downloads.filter(id => id !== songId);
                    saveDownloads(downloads);
                    Swal.fire({ toast: true, position: 'bottom-end', showConfirmButton: false, timer: 1500, icon: 'info', title: 'Descarga Eliminada' });
                    renderDownloads();
                    return;
                 }


                // --- LÓGICA DE AUTENTICACIÓN Y MENÚ ---
                
                // Abrir Dropdown
                if (e.target.closest('#user-menu-btn')) {
                    userMenuDropdown.classList.toggle('show');
                    return;
                }

                // Cerrar Dropdown al hacer clic fuera
                if (!e.target.closest('.user-menu')) {
                    userMenuDropdown.classList.remove('show');
                }

                // Abrir Modals
                if (e.target.id === 'login-btn-header' || e.target.id === 'login-btn-dropdown') {
                    openModal(loginModal);
                    closeModal(registerModal);
                    userMenuDropdown.classList.remove('show');
                    return;
                }
                if (e.target.id === 'register-btn-header' || e.target.id === 'register-btn-modal') {
                    openModal(registerModal);
                    closeModal(loginModal);
                    return;
                }

                // Cerrar Modals (botón X)
                if (e.target.matches('.close-modal')) {
                    closeModal(e.target.closest('.modal'));
                    return;
                }
                
                // Cerrar Modals (clic fuera)
                if (e.target.matches('.modal')) {
                    closeModal(e.target);
                    return;
                }
                
                // Lógica de Login
                if (e.target.id === 'login-form') {
                    e.preventDefault();
                    const username = document.getElementById('login-username').value;
                    const role = username === 'admin' ? 'admin' : 'user';
                    
                    localStorage.setItem('klmz_auth', JSON.stringify({ username, role }));
                    checkAuthStatus();
                    closeModal(loginModal);
                    Swal.fire('Bienvenido', `Hola de nuevo, ${username}`, 'success');
                    return;
                }
                
                // Lógica de Registro (simulada)
                if (e.target.id === 'register-form') {
                    e.preventDefault();
                    const username = document.getElementById('register-username').value;
                    // Simulación de registro exitoso y login
                    localStorage.setItem('klmz_auth', JSON.stringify({ username, role: 'user' }));
                    checkAuthStatus();
                    closeModal(registerModal);
                    Swal.fire('Registro Exitoso', `Bienvenido, ${username}!`, 'success');
                    return;
                }

                // Lógica de Logout
                if (e.target.id === 'logout-link') {
                    localStorage.removeItem('klmz_auth');
                    checkAuthStatus();
                    userMenuDropdown.classList.remove('show');
                    showSection('home-section');
                    Swal.fire({ toast: true, position: 'bottom-end', showConfirmButton: false, timer: 1500, icon: 'info', title: 'Sesión Cerrada' });
                    return;
                }
                
                // --- LÓGICA DE ADMINISTRACIÓN ---
                
                // Eliminar Playlist
                if (isAdmin && e.target.matches('.delete-playlist')) {
                    const playlistId = e.target.dataset.playlistId;
                    userPlaylists = userPlaylists.filter(p => p.id !== playlistId);
                    savePlaylists();
                    Swal.fire('Éxito', 'Playlist eliminada.', 'success');
                    renderPlaylists();
                    return;
                }

                // Abrir Modal Crear Álbum (Admin)
                if (e.target.id === 'create-album-btn-admin') {
                    openModal(createAlbumModal);
                    return;
                }

                // Lógica de Crear Álbum (Form)
                if (e.target.id === 'create-album-form') {
                    e.preventDefault();
                    const title = document.getElementById('album-title-input').value;
                    const artist = document.getElementById('album-artist-input').value;
                    const year = document.getElementById('album-year-input').value;
                    const cover = document.getElementById('album-cover-input').value;
                    
                    if (title && artist) {
                        createAlbum(title, artist, year, cover);
                        closeModal(createAlbumModal);
                        e.target.reset();
                    } else {
                        Swal.fire('Error', 'Título y Artista son obligatorios.', 'error');
                    }
                    return;
                }
                
                // Abrir Modal Añadir Canción (Admin)
                if (e.target.matches('.add-song-btn')) {
                    const albumId = e.target.dataset.albumId;
                    document.getElementById('song-album-id-input').value = albumId;
                    const album = globalAlbums.find(a => a.id === albumId);
                    document.getElementById('add-song-modal-title').textContent = `Añadir Canción a: ${album.title}`;
                    openModal(createSongModal);
                    return;
                }
                
                // Lógica de Crear Canción (Form)
                if (e.target.id === 'create-song-form') {
                    e.preventDefault();
                    const title = document.getElementById('song-title-input').value;
                    const url = document.getElementById('song-url-input').value;
                    const duration = document.getElementById('song-duration-input').value;
                    const albumId = document.getElementById('song-album-id-input').value;

                    if (title && url && albumId) {
                        addSongToAlbum(title, url, duration, albumId);
                        closeModal(createSongModal);
                        e.target.reset();
                    } else {
                        Swal.fire('Error', 'Todos los campos son obligatorios.', 'error');
                    }
                    return;
                }
                
                // Eliminar Álbum (Admin)
                if (e.target.matches('.delete-album-btn')) {
                    const albumId = e.target.dataset.albumId;
                    Swal.fire({
                        title: '¿Estás seguro?',
                        text: "Esto eliminará el álbum y todas sus canciones.",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#ff4757',
                        cancelButtonColor: '#555',
                        confirmButtonText: 'Sí, eliminar!'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            const album = globalAlbums.find(a => a.id === albumId);
                            if (album) {
                                // Eliminar canciones asociadas
                                globalSongs = globalSongs.filter(s => !s.albums.includes(albumId));
                                localStorage.setItem('klmz_songs', JSON.stringify(globalSongs));
                                
                                // Eliminar el álbum
                                globalAlbums = globalAlbums.filter(a => a.id !== albumId);
                                localStorage.setItem('klmz_albums', JSON.stringify(globalAlbums));
                                
                                loadInitialData();
                                renderAdminDashboard();
                                Swal.fire('Eliminado!', 'El álbum ha sido eliminado.', 'success');
                            }
                        }
                    });
                    return;
                }
                
                // Ocultar/Mostrar Álbum (Admin)
                if (e.target.matches('[data-action="show"], [data-action="hide"]')) {
                    const albumId = e.target.dataset.albumId;
                    const action = e.target.dataset.action;
                    const album = globalAlbums.find(a => a.id === albumId);
                    
                    if (album) {
                        album.isHidden = (action === 'hide');
                        localStorage.setItem('klmz_albums', JSON.stringify(globalAlbums));
                        loadInitialData();
                        renderAdminDashboard();
                        Swal.fire({ toast: true, position: 'bottom-end', showConfirmButton: false, timer: 1500, icon: 'info', title: `Álbum ${action === 'hide' ? 'Ocultado' : 'Mostrado'}` });
                    }
                    return;
                }
                
                // Eliminar Canción individual (Admin)
                 if (e.target.matches('.delete-song-btn')) {
                    const songId = e.target.dataset.songId;
                    deleteSong(songId); // La función se encarga de refrescar las vistas
                    Swal.fire({ toast: true, position: 'bottom-end', showConfirmButton: false, timer: 1500, icon: 'info', title: 'Canción Eliminada' });
                    return;
                }

                // Abrir Modal Crear Playlist
                if (e.target.id === 'create-playlist-btn') {
                    openModal(createPlaylistModal);
                    return;
                }

                // Lógica de Crear Playlist (Form)
                if (e.target.id === 'create-playlist-form') {
                    e.preventDefault();
                    const name = document.getElementById('playlist-name-input').value;
                    
                    if (name) {
                        const newPlaylist = {
                            id: Date.now().toString(),
                            name: name,
                            songs: []
                        };
                        userPlaylists.push(newPlaylist);
                        savePlaylists();
                        renderPlaylists();
                        closeModal(createPlaylistModal);
                        e.target.reset();
                        Swal.fire('Éxito', 'Playlist creada correctamente.', 'success');
                    } else {
                        Swal.fire('Error', 'El nombre es obligatorio.', 'error');
                    }
                    return;
                }

                // Bloquear/Desbloquear Contenido
                if (e.target.id === 'lock-icon') {
                    const isLocked = document.body.classList.toggle('offline-mode');
                    localStorage.setItem('klmz_offline_mode', isLocked);
                    e.target.classList.toggle('fa-lock-open', !isLocked);
                    e.target.classList.toggle('fa-lock', isLocked);
                    Swal.fire({ toast: true, position: 'bottom-end', showConfirmButton: false, timer: 1500, icon: 'info', title: isLocked ? 'Modo Solo Descargas ON' : 'Modo Solo Descargas OFF' });
                    // Si se activa, ir a la sección de descargas
                    if (isLocked) {
                        showSection('library-section');
                    }
                    return;
                }
            });
            
            // Cargar estado de modo offline
            if (localStorage.getItem('klmz_offline_mode') === 'true') {
                 document.body.classList.add('offline-mode');
                 lockIcon.classList.remove('fa-lock');
                 lockIcon.classList.add('fa-lock-open');
            } else {
                 document.body.classList.remove('offline-mode');
                 lockIcon.classList.remove('fa-lock-open');
                 lockIcon.classList.add('fa-lock');
            }
        });
    </script>
    <script async="async" data-cfasync="false" src="//pl27638112.revenuecpmgate.com/2f9b36b527e21b2d6323dcdd425f8509/invoke.js"></script>
</body>
</html>
