<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>KLMZ MUSIC</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  
  <style>
  *{box-sizing:border-box}
  body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#181818;color:#fff;padding:2rem}
  header{background:#121212;padding:1rem;display:flex;align-items:center;justify-content:space-between;border-radius:12px;margin-bottom:2rem}
  .logo{font-weight:700;font-size:1.4rem;color:#1DB954}
  .status{padding:1.5rem;border-radius:12px;font-family:monospace;margin:2rem 0;border-left:4px solid #1DB954}
  .status.success{background:#1a2e1a;color:#51cf66;border-left-color:#51cf66}
  .status.error{background:#2d1517;color:#ff6b6b;border-left-color:#ff6b6b}
  .status.info{background:#1e2833;color:#74c0fc;border-left-color:#74c0fc}
  .album-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:2rem;margin-top:2rem}
  .album-card{text-align:center;padding:2rem;background:#282828;border-radius:12px;transition:transform 0.3s}
  .album-card:hover{transform:scale(1.05)}
  .test-buttons{display:flex;gap:1rem;margin-top:2rem;flex-wrap:wrap}
  .btn{padding:0.75rem 1.5rem;background:#1DB954;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:0.9rem;transition:background 0.2s}
  .btn:hover{background:#1ed760}
  .btn.secondary{background:#333;color:#fff}
  .btn.secondary:hover{background:#444}
  .empty-state{text-align:center;padding:3rem;color:#666;grid-column:1/-1;background:#222;border-radius:12px}
  </style>
</head>

<body>
  <header>
    <span class="logo">üéµ KLMZ MUSIC</span>
    <div>üîí</div>
  </header>

  <main>
    <h1>√Ålbumes</h1>
    <div id="status" class="status info">üîÑ Inicializando conexi√≥n directa...</div>
    
    <div class="test-buttons">
      <button class="btn" onclick="testConnection()">üîç Probar Conexi√≥n</button>
      <button class="btn secondary" onclick="addTestAlbum()">‚ûï Agregar √Ålbum de Prueba</button>
      <button class="btn secondary" onclick="loadAlbums()">üìÄ Cargar √Ålbumes</button>
    </div>
    
    <div id="albums" class="album-grid"></div>
  </main>

  <script>
    // Configuraci√≥n
    const CONFIG = {
      endpoint: 'https://nyc.cloud.appwrite.io/v1',
      projectId: '68ab0cf2000365979a71',
      databaseId: '68ab0d9b00124af501a5',
      albumsCollectionId: '68ab0dd00024ddeb51fd',
      songsCollectionId: '68ab0f0e002d9f334b0d',
      bucketId: '68ab1101001cff947e6b'
    };

    const $ = id => document.getElementById(id);

    function setStatus(message, type = 'info') {
      const emoji = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : 'üîÑ';
      $('status').innerHTML = `${emoji} ${message}`;
      $('status').className = `status ${type}`;
    }

    // Cliente Appwrite b√°sico sin SDK
    class SimpleAppwriteClient {
      constructor(endpoint, projectId) {
        this.endpoint = endpoint;
        this.projectId = projectId;
        this.headers = {
          'X-Appwrite-Project': projectId,
          'Content-Type': 'application/json'
        };
      }

      async request(method, path, params = {}) {
        let url = `${this.endpoint}${path}`;
        const options = {
          method,
          headers: { ...this.headers }
        };

        if (method === 'GET' && Object.keys(params).length > 0) {
          const queryString = new URLSearchParams(params).toString();
          url = `${url}?${queryString}`;
        } else if (method !== 'GET') {
          options.body = JSON.stringify(params);
        }

        const response = await fetch(url, options);
        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.message || `HTTP ${response.status}`);
        }

        return data;
      }

      async getAccount() {
        return this.request('GET', '/account');
      }

      async listDocuments(databaseId, collectionId) {
        return this.request('GET', `/databases/${databaseId}/collections/${collectionId}/documents`);
      }

      async createDocument(databaseId, collectionId, documentId, data) {
        return this.request('POST', `/databases/${databaseId}/collections/${collectionId}/documents`, {
          documentId,
          data
        });
      }
    }

    // Cliente inicializado
    const client = new SimpleAppwriteClient(CONFIG.endpoint, CONFIG.projectId);

    // Funciones de prueba
    async function testConnection() {
      setStatus('Probando conexi√≥n...');
      
      try {
        await client.getAccount();
        setStatus('‚úÖ Conectado con sesi√≥n activa', 'success');
      } catch (error) {
        if (error.message.includes('401') || 
            error.message.includes('missing scope') || 
            error.message.includes('guests') ||
            error.message.includes('Unauthorized')) {
          setStatus('‚úÖ Conectado como visitante - CORS OK', 'success');
        } else {
          setStatus(`‚ùå Error: ${error.message}`, 'error');
        }
      }
    }

    async function loadAlbums() {
      setStatus('Cargando √°lbumes...');
      
      try {
        const response = await client.listDocuments(CONFIG.databaseId, CONFIG.albumsCollectionId);
        
        if (response.documents.length === 0) {
          $('albums').innerHTML = `
            <div class="empty-state">
              <h2>üéµ Conexi√≥n exitosa</h2>
              <p>No hay √°lbumes en la base de datos.<br>Usa el bot√≥n "Agregar √Ålbum de Prueba".</p>
            </div>
          `;
          setStatus('‚úÖ Conexi√≥n exitosa - Base de datos vac√≠a', 'success');
        } else {
          displayAlbums(response.documents);
          setStatus(`‚úÖ ${response.documents.length} √°lbum(es) cargados`, 'success');
        }
        
      } catch (error) {
        console.error('Error:', error);
        let errorMsg = error.message;
        
        if (error.message.includes('401')) {
          errorMsg = 'Sin permisos de lectura. Configura permisos p√∫blicos en la Collection.';
        } else if (error.message.includes('404')) {
          errorMsg = 'Collection no encontrada. Verifica los IDs de configuraci√≥n.';
        }
        
        setStatus(`‚ùå ${errorMsg}`, 'error');
        $('albums').innerHTML = `
          <div class="empty-state">
            <h2>‚ùå Error al cargar √°lbumes</h2>
            <p>${errorMsg}</p>
          </div>
        `;
      }
    }

    async function addTestAlbum() {
      setStatus('Agregando √°lbum de prueba...');
      
      try {
        const albumData = {
          name: '√Ålbum de Prueba ' + new Date().getHours() + ':' + new Date().getMinutes(),
          artistName: 'Artista Demo',
          coverStorageId: 'test-cover-id-' + Date.now()
        };

        await client.createDocument(
          CONFIG.databaseId,
          CONFIG.albumsCollectionId,
          'test-album-' + Date.now(),
          albumData
        );

        setStatus('‚úÖ √Ålbum de prueba agregado correctamente', 'success');
        setTimeout(loadAlbums, 1000);
        
      } catch (error) {
        console.error('Error:', error);
        let errorMsg = error.message;
        
        if (error.message.includes('401')) {
          errorMsg = 'Sin permisos de escritura. Agrega permisos de "create" para role:users.';
        }
        
        setStatus(`‚ùå ${errorMsg}`, 'error');
      }
    }

    function displayAlbums(albums) {
      $('albums').innerHTML = albums.map((album, index) => `
        <div class="album-card">
          <div style="width:140px;height:140px;background:linear-gradient(135deg, #1DB954, #1ed760);border-radius:12px;margin:0 auto 1rem;display:flex;align-items:center;justify-content:center;font-size:3rem;color:white;text-shadow:0 2px 4px rgba(0,0,0,0.3);">üéµ</div>
          <h3 style="margin:0.5rem 0;font-size:1.1rem;">${album.name}</h3>
          <p style="color:#999;margin:0;font-size:0.9rem;">${album.artistName}</p>
          <p style="color:#666;font-size:0.8rem;margin-top:0.5rem;">ID: ${album.$id.slice(-8)}</p>
        </div>
      `).join('');
    }

    // Auto-test al cargar
    document.addEventListener('DOMContentLoaded', () => {
      setStatus('P√°gina cargada - Probando conexi√≥n autom√°ticamente...');
      setTimeout(testConnection, 500);
    });
  </script>
</body>
</html>
