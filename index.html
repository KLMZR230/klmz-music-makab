<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KLMZ MUSIC</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
</head>
<body class="bg-gray-900 text-white">

  <!-- Pantalla de Login -->
  <section id="loginSection" class="flex flex-col items-center justify-center h-screen">
    <h1 class="text-4xl font-bold mb-6">🎵 KLMZ MUSIC</h1>
    <form id="loginForm" class="bg-gray-800 p-6 rounded-lg shadow-lg w-80">
      <input type="email" id="loginEmail" placeholder="Correo electrónico" class="w-full p-2 mb-4 text-black rounded" required />
      <input type="password" id="loginPassword" placeholder="Contraseña" class="w-full p-2 mb-4 text-black rounded" required />
      <button type="submit" class="bg-green-500 w-full py-2 rounded font-bold">Iniciar sesión</button>
    </form>
    <p class="mt-4">¿No tienes cuenta? <a id="goToRegister" href="#" class="text-blue-400">Regístrate</a></p>
  </section>

  <!-- Pantalla de Registro -->
  <section id="registerSection" class="hidden flex-col items-center justify-center h-screen">
    <h1 class="text-4xl font-bold mb-6">Crear cuenta</h1>
    <form id="registerForm" class="bg-gray-800 p-6 rounded-lg shadow-lg w-80">
      <input type="email" id="registerEmail" placeholder="Correo electrónico" class="w-full p-2 mb-4 text-black rounded" required />
      <input type="password" id="registerPassword" placeholder="Contraseña" class="w-full p-2 mb-4 text-black rounded" required />
      <button type="submit" class="bg-blue-500 w-full py-2 rounded font-bold">Registrarse</button>
    </form>
    <p class="mt-4">¿Ya tienes cuenta? <a id="goToLogin" href="#" class="text-green-400">Inicia sesión</a></p>
  </section>

  <!-- Pantalla Principal -->
  <section id="mainSection" class="hidden p-6">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold">Bienvenido a 🎶 KLMZ MUSIC</h1>
      <button id="logoutBtn" class="bg-red-500 px-4 py-2 rounded">Cerrar sesión</button>
    </div>

    <h2 class="text-2xl mb-4">Subir nueva canción</h2>
    <form id="uploadForm" class="bg-gray-800 p-4 rounded-lg mb-6">
      <input type="text" id="songTitle" placeholder="Título de la canción" class="w-full p-2 mb-2 text-black rounded" required />
      <input type="file" id="songFile" accept="audio/*" class="w-full p-2 mb-2 text-black rounded" required />
      <button type="submit" class="bg-green-500 w-full py-2 rounded font-bold">Subir canción</button>
    </form>

    <h2 class="text-2xl mb-4">Lista de canciones</h2>
    <ul id="songList" class="space-y-2"></ul>
    <audio id="player" controls class="w-full mt-6"></audio>
  </section>

  <script>
    // ===== CONFIGURA AQUÍ TUS DATOS DE SUPABASE =====
    const SUPABASE_URL = "https://lvrkifepqhxxmdcasncf.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2cmtpZmVwcWh4eG1kY2FzbmNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMjU3NTMsImV4cCI6MjA3MDcwMTc1M30.I-jHvTMEHHrUMM1-2YQrb-58YU4KmTrJuc95GJcjzhk";
    const supabaseClient = supabase.createClient(https://lvrkifepqhxxmdcasncf.supabase.co, eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2cmtpZmVwcWh4eG1kY2FzbmNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMjU3NTMsImV4cCI6MjA3MDcwMTc1M30.I-jHvTMEHHrUMM1-2YQrb-58YU4KmTrJuc95GJcjzhk);

    // Referencias a elementos
    const loginSection = document.getElementById("loginSection");
    const registerSection = document.getElementById("registerSection");
    const mainSection = document.getElementById("mainSection");

    const loginForm = document.getElementById("loginForm");
    const registerForm = document.getElementById("registerForm");
    const uploadForm = document.getElementById("uploadForm");

    const songList = document.getElementById("songList");
    const player = document.getElementById("player");

    // Navegación entre pantallas
    document.getElementById("goToRegister").addEventListener("click", () => {
      loginSection.classList.add("hidden");
      registerSection.classList.remove("hidden");
    });

    document.getElementById("goToLogin").addEventListener("click", () => {
      registerSection.classList.add("hidden");
      loginSection.classList.remove("hidden");
    });

    // Registro
    registerForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("registerEmail").value;
      const password = document.getElementById("registerPassword").value;
      const { error } = await supabaseClient.auth.signUp({ email, password });
      if (error) {
        alert("Error al registrarse: " + error.message);
      } else {
        alert("Registro exitoso, revisa tu correo para confirmar.");
        registerSection.classList.add("hidden");
        loginSection.classList.remove("hidden");
      }
    });

    // Login
    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;
      const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
      if (error) {
        alert("Error al iniciar sesión: " + error.message);
      } else {
        loginSection.classList.add("hidden");
        mainSection.classList.remove("hidden");
        cargarCanciones();
      }
    });

    // Logout
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await supabaseClient.auth.signOut();
      mainSection.classList.add("hidden");
      loginSection.classList.remove("hidden");
    });

    // Subir canción
    uploadForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const title = document.getElementById("songTitle").value;
      const file = document.getElementById("songFile").files[0];
      const fileName = Date.now() + "_" + file.name;

      // Subir archivo
      const { error: uploadError } = await supabaseClient.storage
        .from("songs")
        .upload(fileName, file);

      if (uploadError) {
        alert("Error al subir canción: " + uploadError.message);
        return;
      }

      // Guardar metadata en la base de datos
      const { error: dbError } = await supabaseClient
        .from("songs")
        .insert([{ title, file_name: fileName }]);

      if (dbError) {
        alert("Error al guardar en la base de datos: " + dbError.message);
      } else {
        alert("Canción subida con éxito");
        cargarCanciones();
      }
    });

    // Cargar canciones
    async function cargarCanciones() {
      songList.innerHTML = "";
      const { data, error } = await supabaseClient
        .from("songs")
        .select("*")
        .order("id", { ascending: false });

      if (error) {
        alert("Error al cargar canciones: " + error.message);
        return;
      }

      data.forEach(async (song) => {
        const { data: urlData } = await supabaseClient
          .storage
          .from("songs")
          .getPublicUrl(song.file_name);

        const li = document.createElement("li");
        li.className = "bg-gray-800 p-3 rounded flex justify-between items-center";
        li.innerHTML = `
          <span>${song.title}</span>
          <button class="bg-blue-500 px-3 py-1 rounded">▶</button>
        `;
        li.querySelector("button").addEventListener("click", () => {
          player.src = urlData.publicUrl;
          player.play();
        });
        songList.appendChild(li);
      });
    }
  </script>
</body>
</html>
