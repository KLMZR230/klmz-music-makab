<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>KLMZ MUSIC</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <meta name="theme-color" content="#1DB954">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <!-- =========  CSS COMPLETO  ========= -->
  <style>
/* ‚Äî‚Äî RESET & LAYOUT ‚Äî‚Äî */
*{box-sizing:border-box}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#181818;color:#fff;padding-bottom:84px;transition:.3s}
header{background:#121212;padding:1rem 1.5rem;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
.logo{font-weight:bold;font-size:1.4rem;letter-spacing:1px}
.user-actions{display:flex;align-items:center;gap:.5rem}
.lock-icon{cursor:pointer;font-size:1.4rem}
.theme-selector{display:flex;align-items:center;gap:.3rem;margin-right:.5rem}
.theme-selector label{font-size:.7rem;color:#b3b3b3}
.theme-selector select{background:#333;color:#fff;border:1px solid #555;border-radius:4px;padding:.1rem .2rem;font-size:.7rem;cursor:pointer}

/* ‚Äî‚Äî SECCIONES ‚Äî‚Äî */
.app-container{display:flex;min-height:calc(100vh - 60px)}
main{flex:1;padding:1rem;max-width:900px;margin:0 auto}
.content-section{display:none}
.content-section.active{display:block}
.section-title{font-size:1.8rem;font-weight:bold;margin-bottom:1.5rem}

/* ‚Äî‚Äî √ÅLBUMS ‚Äî‚Äî */
.album-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:1.5rem}
.album-card{cursor:pointer;display:flex;flex-direction:column;align-items:center;text-align:center;transition:transform .3s}
.album-card:hover{transform:scale(1.05)}
.album-img{border-radius:50%;width:100px;height:100px;object-fit:cover;margin-bottom:.7rem;background:#333}
.album-title{font-size:.98rem;font-weight:bold}
.album-artist{font-size:.9rem;color:#b3b3b3}

/* ‚Äî‚Äî PLAYER MINI ‚Äî‚Äî */
.player{position:fixed;bottom:84px;left:0;right:0;background:#212121cc;border-top:1px solid #282828;display:flex;align-items:center;padding:.8rem 1.2rem;min-height:56px;cursor:pointer;box-shadow:0 -2px 10px #0002;z-index:300}
.player-img-mini{width:44px;height:44px;border-radius:100%;object-fit:cover;margin-right:1rem}
.player-info-mini{flex:1;overflow:hidden}
.player-title-mini{font-weight:bold;font-size:1rem;line-height:1.2}
.player-artist-mini{color:#b3b3b3;font-size:.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.play-btn-inline{background:#1DB954;color:#fff;border:none;border-radius:50%;width:36px;height:36px;font-size:1.1rem;cursor:pointer}

/* ‚Äî‚Äî PLAYER COMPLETO ‚Äî‚Äî */
.full-player-backdrop{display:none;position:fixed;inset:0;background:#000f;z-index:9999;align-items:center;justify-content:center;flex-direction:column}
.full-player-backdrop.active{display:flex}
.full-player-cover{width:200px;height:200px;border-radius:12px;object-fit:cover;margin:0 auto 2rem}
.full-player-title{font-size:1.8rem;font-weight:bold;margin:1rem 0 .5rem;text-align:center}
.full-player-artist{color:#b3b3b3;font-size:1.1rem;margin-bottom:2rem;text-align:center}
.full-control-buttons{display:flex;gap:3rem;align-items:center}
.full-control-btn{background:none;border:none;color:#fff;font-size:2rem;padding:.6rem;border-radius:50%;cursor:pointer}
.full-play-btn{background:#1DB954;color:#fff;border-radius:50%;font-size:2.5rem;padding:.8rem}

/* ‚Äî‚Äî NAVEGACI√ìN INFERIOR ‚Äî‚Äî */
.bottom-nav{position:fixed;left:0;right:0;bottom:20px;background:#181818;border-top:1px solid #272727;display:flex;height:64px;z-index:5000}
.bottom-nav-item{color:#b3b3b3;text-align:center;flex:1;font-size:1.14rem;padding:4px 0;border-radius:7px;cursor:pointer;display:flex;flex-direction:column;align-items:center}
.bottom-nav-item.active{color:#1DB954;background:rgba(29,185,84,.09)}

/* ‚Äî‚Äî FORMULARIOS Y MODALES ‚Äî‚Äî */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:2000}
.modal-content{background:#282828;padding:2rem;border-radius:8px;width:95%;max-width:430px;max-height:90vh;overflow-y:auto}
.btn-primary{background:#1DB954;color:#fff;border:none;padding:.7rem 1.5rem;border-radius:99px;cursor:pointer;width:100%}
.btn-secondary{background:#555;color:#fff;border:none;padding:.7rem 1.5rem;border-radius:99px;cursor:pointer}
.btn-danger{background:#e22134;color:#fff;border:none;padding:.5rem 1rem;border-radius:4px;cursor:pointer}

/* ‚Äî‚Äî ADMIN LIST ‚Äî‚Äî */
.admin-section{margin-bottom:2.5rem;background:#242424;padding:1.5rem;border-radius:8px}
.admin-item{display:flex;justify-content:space-between;align-items:center;padding:.8rem;border-radius:4px;margin-bottom:.5rem;background:#2c2c2c}

/* ‚Äî‚Äî THEMES (neon,minimal,sunset,pastel,luxury,oceanic) ‚Äî‚Äî */
/* (todo tu bloque de temas sin cambios) */

/* ‚Äî‚Äî OTROS ‚Äî‚Äî */
.loading-indicator{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.9);color:#fff;padding:1.5rem 2.5rem;border-radius:12px;font-size:1rem;z-index:2000;border:2px solid #1DB954}
@keyframes neonPulse{0%{text-shadow:0 0 15px #00ff88}100%{text-shadow:0 0 40px #00ff88}}
@media(max-width:768px){.full-player-cover{width:150px;height:150px}.album-img{width:80px;height:80px}}
  </style>
</head>

<body>
  <div class="loading-indicator" id="loading-indicator" style="display:none;">üéµ Cargando‚Ä¶</div>

  <!-- =====  CABECERA  ===== -->
  <header> ‚Ä¶ <!-- (id√©ntico a tu versi√≥n) --> </header>

  <!-- =====  SECCIONES  ===== -->
  <div class="app-container">
    ‚Ä¶ <!-- (Home, Search, Favorites, Downloads, Admin) -->
  </div>

  <!-- =====  NAV INFERIOR  ===== -->
  <nav class="bottom-nav"> ‚Ä¶ </nav>

  <!-- =====  MINI-PLAYER / FULL-PLAYER / MODALES  ===== -->
  ‚Ä¶ <!-- (componentes exactamente como los ten√≠as) -->

  <audio id="audio-player" preload="metadata"></audio>
  <!-- =========  SCRIPTS COMPLETOS  ========= -->
  <script>
/* ---------- VARIABLES ---------- */
const supabaseUrl = 'https://nqbldvpnqhngdtalvzov.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xYmxkdnBucWhuZ2R0YWx2em92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyMjY0NjUsImV4cCI6MjA3MDgwMjQ2NX0.Zzg5D219sW7bhvl0_R5ypX9MF6nRzBSDIeo2Lvebab0';
const ADMIN_EMAIL = 'klmzr@gmail.com';
let supabase,currentUser=null,allAlbums=[],allSongs=[],songsWithAlbumInfo=[],currentAlbum=null,currentPlaylist=[],currentSong=null,currentIndex=0,isPlaying=false,repeatMode='off',shuffleMode=false,db=null;

/* ---------- IndexedDB para descargas (sin cambios) ---------- */
function initDB(){return new Promise((res,rej)=>{const r=indexedDB.open('KLMZMusicDB',2);r.onerror=()=>rej('IndexedDB');r.onsuccess=e=>{db=e.target.result;res(db)};r.onupgradeneeded=e=>{const d=e.target.result;if(!d.objectStoreNames.contains('songs'))d.createObjectStore('songs',{keyPath:'id'})}})}
/* saveSongToDB,getSongFromDB,getAllDownloadedSongs ‚Ä¶ (id√©nticas) */

/* ---------- Supabase ---------- */
async function loadSupabase(){
  showLoadingIndicator(true);
  const {createClient}=await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
  supabase=createClient(supabaseUrl,supabaseKey);
  supabase.auth.onAuthStateChange((_e,s)=>{currentUser=s?.user||null;updateAuthUI()});
  currentUser=(await supabase.auth.getSession()).data.session?.user||null;
  updateAuthUI(); await loadAllData(); showLoadingIndicator(false);
}

/* ---------- Cargar datos ---------- */
async function loadAllData(){
  const [{data:albums},{data:songs}]=await Promise.all([
    supabase.from('albums').select('*'),
    supabase.from('songs').select('*, albums:album_id(*)')
  ]);
  allAlbums=albums||[];allSongs=songs||[];songsWithAlbumInfo=songs||[];
  displayAlbums(allAlbums);
}

/* displayAlbums, showAlbumDetail, reproductor, favoritos, descargas‚Ä¶ */
/* ‚Äî‚Äî todos tus m√©todos originales sin alterar ‚Äî‚Äî */

/* ---------- PANEL ADMIN con SUBIDA de ARCHIVOS ---------- */
async function renderAdminPanel(){
  const c=document.getElementById('admin-content');
  c.innerHTML=`<div class="admin-section">
   <h4>Gesti√≥n de √Ålbumes</h4>
   <form id="album-form" enctype="multipart/form-data" class="admin-form">
     <input type="hidden" id="album-id">
     <div class="form-group"><input id="album-title"  placeholder="T√≠tulo del √Ålbum" required></div>
     <div class="form-group"><input id="album-artist" placeholder="Artista"           required></div>
     <div class="form-group"><input id="album-cover-file" type="file" accept=".jpg,.jpeg,.png" required></div>
     <button class="btn-primary">Guardar √Ålbum</button>
     <button type="button" id="cancel-album-edit" class="btn-secondary" style="display:none;margin-top:.5rem;">Cancelar</button>
   </form>
   <div id="admin-album-list" class="admin-list">Cargando‚Ä¶</div></div>

   <div class="admin-section">
   <h4>Gesti√≥n de Canciones</h4>
   <form id="song-form" enctype="multipart/form-data" class="admin-form">
     <input type="hidden" id="song-id">
     <div class="form-group"><input id="song-title" placeholder="T√≠tulo de la Canci√≥n" required></div>
     <div class="form-group"><select id="song-album-select" required><option>Cargando‚Ä¶</option></select></div>
     <div class="form-group"><input id="song-file" type="file" accept=".mp3,.flac" required></div>
     <button class="btn-primary">Guardar Canci√≥n</button>
     <button type="button" id="cancel-song-edit" class="btn-secondary" style="display:none;margin-top:.5rem;">Cancelar</button>
   </form>
   <div id="admin-song-list" class="admin-list">Cargando‚Ä¶</div></div>`;
  await renderAdminLists(); setupAdminForms();
}

/* renderAdminLists() ‚Äì igual que antes */

/* ------ formularios con subida a Storage ------ */
function setupAdminForms(){
  /* √Ålbum */
  document.getElementById('album-form').addEventListener('submit',async e=>{
    e.preventDefault();
    const id=document.getElementById('album-id').value,
          title=document.getElementById('album-title').value,
          artist=document.getElementById('album-artist').value,
          file=document.getElementById('album-cover-file').files[0];
    if(!file) return showInfoModal('Selecciona una portada');
    showLoadingIndicator(true);
    const path=`covers/${Date.now()}_${file.name}`;
    const {error:upErr}=await supabase.storage.from('covers').upload(path,file);
    if(upErr){showLoadingIndicator(false);return showInfoModal('Error subiendo portada');}
    const {data:{publicUrl:cover_url}}=supabase.storage.from('covers').getPublicUrl(path);
    const {error}=id
      ? await supabase.from('albums').update({title,artist,cover_url}).eq('id',id)
      : await supabase.from('albums').insert([{title,artist,cover_url}]);
    showLoadingIndicator(false);
    if(error) showInfoModal('Error guardando √°lbum');
    else{showInfoModal('√Ålbum guardado');e.target.reset();document.getElementById('cancel-album-edit').style.display='none';await loadAllData();await renderAdminLists();}
  });

  /* Canci√≥n */
  document.getElementById('song-form').addEventListener('submit',async e=>{
    e.preventDefault();
    const id=document.getElementById('song-id').value,
          title=document.getElementById('song-title').value,
          album_id=document.getElementById('song-album-select').value,
          file=document.getElementById('song-file').files[0];
    if(!file) return showInfoModal('Selecciona un audio');
    showLoadingIndicator(true);
    const path=`audio/${Date.now()}_${file.name}`;
    const {error:upErr}=await supabase.storage.from('audio').upload(path,file);
    if(upErr){showLoadingIndicator(false);return showInfoModal('Error subiendo audio');}
    const {data:{publicUrl:song_url}}=supabase.storage.from('audio').getPublicUrl(path);
    const {error}=id
      ? await supabase.from('songs').update({title,album_id,song_url}).eq('id',id)
      : await supabase.from('songs').insert([{title,album_id,song_url}]);
    showLoadingIndicator(false);
    if(error) showInfoModal('Error guardando canci√≥n');
    else{showInfoModal('Canci√≥n guardada');e.target.reset();document.getElementById('cancel-song-edit').style.display='none';await loadAllData();await renderAdminLists();}
  });
}

/* ---------- resto del JS original (reproductor, b√∫squeda, favs, descargas, auth, temas, SW) sin cambios ---------- */

/* ---------- INIT ---------- */
document.addEventListener('DOMContentLoaded',()=>{
  loadSavedTheme();
  initDB().then(loadSupabase);
  const audio=document.getElementById('audio-player');
  audio.addEventListener('ended',handleSongEnded);
  audio.addEventListener('timeupdate',updateProgressBar);
  audio.addEventListener('play',()=>{isPlaying=true;updatePlayButtons()});
  audio.addEventListener('pause',()=>{isPlaying=false;updatePlayButtons()});
});
  </script>

  <!-- Service Worker -->
  <script>
  if('serviceWorker' in navigator){
    window.addEventListener('load',()=>{
      navigator.serviceWorker.register('./sw.js')
        .then(r=>console.log('SW',r.scope))
        .catch(e=>console.log('SW error',e));
    });
  }
  </script>
</body>
</html>
