<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>KLMZ MUSIC</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1DB954">
    <link rel="manifest" href="./manifest.json">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Metal+Mania&display=swap');
        * { box-sizing: border-box; }
        body { margin: 0; font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; background: #181818; color: #fff; padding-bottom: 84px; transition: all 0.3s ease; }
        header { background: #121212; padding: 1rem 1.5rem; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; transition: all 0.3s ease; }
        .logo { font-weight: bold; font-size: 1.4rem; letter-spacing: 1px; transition: all 0.3s ease; }
        .user-actions { display:flex; align-items: center; gap:.5rem; }
        .lock-icon { cursor:pointer; font-size:1.4rem; color:#fff; user-select:none; transition: all 0.3s ease; }
        .lock-icon:hover { opacity:.7;}
        .theme-selector { display: flex; align-items: center; gap: 0.3rem; margin-right: 0.5rem; }
        .theme-selector label { font-size: 0.7rem; color: #b3b3b3; }
        .theme-selector select { background: #333; color: #fff; border: 1px solid #555; border-radius: 4px; padding: 0.1rem 0.2rem; font-size: 0.7rem; cursor: pointer; transition: all 0.3s ease; }
        .app-container { display: flex; min-height: calc(100vh - 60px);}
        main { flex:1; padding:1rem; max-width:900px; margin:0 auto;}
        #search-input { width: 100%; padding: 1rem; background: #242424; border: none; border-radius: 4px; color: #fff; margin-bottom: 2rem; transition: all 0.3s ease; }
        .section-title { font-size:1.8rem; font-weight:bold; margin-bottom:1.5rem; transition: all 0.3s ease; }
        .album-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(140px,1fr)); gap:1.5rem;}
        .album-card { background:none; padding:0; cursor:pointer; display:flex; flex-direction:column; align-items:center; text-align:center; transition: all 0.3s ease; border: 2px solid transparent; border-radius: 12px; }
        .album-card:hover { transform:scale(1.05); }
        .album-img { border-radius:50%; width:100px; height:100px; object-fit:cover; margin-bottom:.7rem; background:#333; transition: all 0.3s ease; }
        .album-title { font-size:.98rem; font-weight: bold; margin-bottom: 0.4rem; transition: all 0.3s ease; }
        .album-artist { font-size: .9rem; color: #b3b3b3; transition: all 0.3s ease; }
        .song-list { width:100%; margin-top:1rem; padding-bottom: 120px; }
        .song-list ul { list-style:none; padding:0; margin:0;}
        .song-list li { padding:.7rem; cursor:pointer; color:#1db954; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center; transition: all 0.3s ease;}
        .song-list li:hover { color:#fff; background: rgba(255,255,255,.05);}
        .play-icon { font-size: 1.1rem; }
        /* Resto del CSS igual... */
    </style>
</head>
<body>
    <!-- HTML igual... -->
    <div class="loading-indicator" id="loading-indicator" style="display:none;">üéµ Cargando...</div>
    <header>
        <span class="logo">KLMZ MUSIC</span>
        <div class="user-actions">
            <div class="theme-selector">
                <label for="theme-select">Tema:</label>
                <select id="theme-select" onchange="changeTheme(this.value)">
                    <option value="default">üéµ Default</option>
                    <option value="neon">‚ö° Neon Cyberpunk</option>
                    <option value="fire">üî• Fuego Infernal</option>
                </select>
            </div>
            <div class="user-menu">
                <div class="lock-icon" id="header-lock-icon" onclick="toggleUserMenu()">üë§</div>
                <div class="user-dropdown" id="user-dropdown">
                    <div class="user-info" id="user-info-section" style="display: none;">
                        <div><strong id="user-email-display"></strong></div>
                        <div id="user-role-display">Usuario</div>
                    </div>
                    <div class="user-dropdown-item" onclick="showAuth('login')" id="login-menu-item"><span>üîê</span><span>Iniciar Sesi√≥n</span></div>
                    <div class="user-dropdown-item logout" onclick="confirmLogout()" id="logout-menu-item" style="display: none;"><span>üö™</span><span>Cerrar Sesi√≥n</span></div>
                </div>
            </div>
        </div>
    </header>

    <div class="app-container">
        <main>
            <section class="content-section active" id="home-section">
                <div class="section-title">Albums</div>
                <div class="album-grid" id="albums"><div style="text-align: center; padding: 2rem;">Cargando √°lbumes...</div></div>
            </section>
        </main>
    </div>

    <nav class="bottom-nav">
        <div class="bottom-nav-item active" onclick="showSection('home')" id="nav-home"><span class="icon">‚åÇ</span><small>Inicio</small></div>
    </nav>

    <div class="copyright">¬© 2025 KLMZ MUSIC - Desarrollado por Freddy Granados</div>
    <audio id="audio-player" preload="metadata"></audio>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ‚úÖ VARIABLES GLOBALES
        let allAlbums = [];
        let allSongs = [];
        let currentUser = null;
        let supabase = null;
        
        const supabaseUrl = 'https://nqbldvpnqhngdtalvzov.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xYmxkdnBucWhuZ2R0YWx2em92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyMjY0NjUsImV4cCI6MjA3MDgwMjQ2NX0.Zzg5D219sW7bhvl0_R5ypX9MF6nRzBSDIeo2Lvebab0';
        const ADMIN_EMAIL = 'klmzr@gmail.com';

        // ‚úÖ FUNCI√ìN UPLOADFILE CORREGIDA PARA R2
        async function uploadFile(file, onProgress) {
            try {
                console.log('üöÄ Iniciando subida a R2:', file.name);
                
                // Paso 1: Obtener URL firmada de la Edge Function
                const functionUrl = 'https://nqbldvpnqhngdtalvzov.supabase.co/functions/v1/generate-upload-url';
                
                const response = await fetch(functionUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${supabaseKey}`,
                        'apikey': supabaseKey
                    },
                    body: JSON.stringify({ 
                        fileName: file.name, 
                        contentType: file.type,
                        fileSize: file.size 
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Error del servidor: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                if (!data.signedUrl) {
                    throw new Error('No se recibi√≥ URL firmada del servidor');
                }
                
                console.log('‚úÖ URL firmada obtenida, subiendo a R2...');
                
                // Paso 2: Subir archivo directo a R2 - SIN mode: 'no-cors'
                const uploadResponse = await fetch(data.signedUrl, {
                    method: 'PUT',
                    body: file,
                    headers: {
                        'Content-Type': file.type
                    }
                });

                // Verificar si la subida fue exitosa
                if (!uploadResponse.ok) {
                    throw new Error(`Error subiendo a R2: ${uploadResponse.status} ${uploadResponse.statusText}`);
                }
                
                console.log('‚úÖ Archivo subido exitosamente a R2');
                
                // URL p√∫blica de R2
                const publicUrl = data.publicUrl || `https://pub-943d9fd3a7704f19a27dd4b375e3f126.r2.dev/${data.fileName}`;
                
                console.log('‚úÖ URL p√∫blica:', publicUrl);
                return publicUrl;
                
            } catch (error) {
                console.error("üí• Error detallado en la subida:", error);
                throw new Error(error.message || 'Error desconocido al subir el archivo.');
            }
        }

        // ‚úÖ INICIALIZACI√ìN CORREGIDA
        async function loadSupabase() { 
            console.log('üîÑ Iniciando loadSupabase...');
            showLoadingIndicator(true); 
            
            try { 
                if (!window.supabase || !window.supabase.createClient) {
                    throw new Error('Supabase SDK no est√° disponible');
                }
                
                supabase = window.supabase.createClient(supabaseUrl, supabaseKey); 
                console.log('‚úÖ Cliente Supabase creado');
                
                await loadAllData(); 
                console.log('‚úÖ loadSupabase completado');
                
            } catch (error) { 
                console.error('üí• Error en loadSupabase:', error);
                document.getElementById('albums').innerHTML = `
                    <div style="text-align: center; padding: 3rem;">
                        <h2>‚ùå Error de conexi√≥n</h2>
                        <p>Error: ${error.message}</p>
                        <button onclick="location.reload()" style="background:#1DB954;color:#fff;border:none;padding:0.7rem;border-radius:4px;cursor:pointer;">üîÑ Recargar</button>
                    </div>`; 
            } finally { 
                showLoadingIndicator(false); 
            } 
        }

        async function loadAllData() { 
            console.log('üîÑ Cargando datos...');
            try { 
                const { data: albums, error: albumsError } = await supabase
                    .from('albums')
                    .select('*')
                    .order('created_at', { ascending: false }); 
                    
                if (albumsError) throw albumsError;
                
                console.log('‚úÖ √Ålbumes obtenidos:', albums?.length || 0);
                allAlbums = albums || []; 
                displayAlbums(allAlbums); 
                
            } catch (error) { 
                console.error('üí• Error cargando datos:', error);
                document.getElementById('albums').innerHTML = `
                    <div style="text-align: center; padding: 3rem;">
                        <h2>‚ùå Error cargando datos</h2>
                        <p>${error.message}</p>
                    </div>`; 
            }
        }
        
        function displayAlbums(albums) { 
            const container = document.getElementById('albums'); 
            if (!albums || albums.length === 0) { 
                container.innerHTML = '<div style="text-align: center; padding: 3rem;"><h2>üìÄ No hay √°lbumes</h2></div>'; 
                return; 
            } 
            container.innerHTML = albums.map(album => 
                `<div class="album-card">
                    <img class="album-img" src="${album.cover_url}" alt="${album.title}" loading="lazy">
                    <div class="album-title">${album.title}</div>
                    <div class="album-artist">${album.artist}</div>
                </div>`
            ).join(''); 
        }

        function showLoadingIndicator(show) { 
            const indicator = document.getElementById('loading-indicator'); 
            if (indicator) indicator.style.display = show ? 'block' : 'none'; 
        }

        window.showSection = function(section) {
            console.log('Mostrando secci√≥n:', section);
        }

        window.changeTheme = function(theme) {
            document.body.className = '';
            if (theme && theme !== 'default') {
                document.body.classList.add('theme-' + theme);
            }
        }

        window.toggleUserMenu = function() {
            document.getElementById('user-dropdown').classList.toggle('show');
        }

        window.showAuth = function(type) {
            console.log('Mostrar auth:', type);
        }

        window.confirmLogout = function() {
            console.log('Logout');
        }
        
        // ‚úÖ INICIALIZAR AL CARGAR LA P√ÅGINA
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ P√°gina cargada, iniciando...');
            loadSupabase().catch(console.error);
        });
    </script>
</body>
</html>
