<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>KLMZ MUSIC</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  
  <!-- SDK con m√∫ltiples fallbacks -->
  <script src="https://unpkg.com/appwrite@15.0.0/dist/appwrite.umd.js"></script>
  
  <style>
  *{box-sizing:border-box}
  body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#181818;color:#fff;padding:2rem}
  header{background:#121212;padding:1rem;display:flex;align-items:center;justify-content:space-between;border-radius:12px;margin-bottom:2rem}
  .logo{font-weight:700;font-size:1.4rem;color:#1DB954}
  .lock-icon{cursor:pointer;font-size:1.4rem;padding:0.5rem;border-radius:8px;background:#333}
  .section-title{font-size:1.8rem;font-weight:700;margin:1.5rem 0}
  .status{padding:1.5rem;border-radius:12px;font-family:monospace;font-size:1rem;margin:2rem 0;border-left:4px solid #1DB954}
  .status.error{background:#2d1517;color:#ff6b6b;border-left-color:#ff6b6b}
  .status.success{background:#1a2e1a;color:#51cf66;border-left-color:#51cf66}
  .status.info{background:#1e2833;color:#74c0fc;border-left-color:#74c0fc}
  .album-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:2rem;margin-top:2rem}
  .album-card{text-align:center;padding:2rem;background:#282828;border-radius:12px;transition:transform 0.3s}
  .album-card:hover{transform:scale(1.05)}
  </style>
</head>

<body>
  <header>
    <span class="logo">üéµ KLMZ MUSIC</span>
    <div class="lock-icon">üîí</div>
  </header>

  <main>
    <h1 class="section-title">√Ålbumes</h1>
    <div id="status" class="status info">‚è≥ Inicializando...</div>
    <div id="albums" class="album-grid"></div>
  </main>

  <script>
    // Configuraci√≥n
    const CONFIG = {
      endpoint: 'https://nyc.cloud.appwrite.io/v1',
      projectId: '68ab0cf2000365979a71',
      databaseId: '68ab0d9b00124af501a5',
      albumsCollectionId: '68ab0dd00024ddeb51fd',
      songsCollectionId: '68ab0f0e002d9f334b0d',
      bucketId: '68ab1101001cff947e6b'
    };

    const $ = id => document.getElementById(id);

    function setStatus(message, type = 'info') {
      const emoji = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : 'üîÑ';
      $('status').innerHTML = `${emoji} ${message}`;
      $('status').className = `status ${type}`;
    }

    // Funci√≥n principal
    async function startApp() {
      setStatus('Verificando SDK...');
      
      // Verificaci√≥n simple y directa
      if (typeof Appwrite === 'undefined') {
        setStatus('SDK no disponible - Reintentando con CDN alternativo...', 'error');
        
        // Cargar SDK alternativo
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/appwrite@15.0.0/dist/appwrite.umd.js';
        script.onload = () => {
          setTimeout(startApp, 500);
        };
        script.onerror = () => {
          setStatus('Error: No se pudo cargar el SDK. Verifica tu conexi√≥n a internet.', 'error');
        };
        document.head.appendChild(script);
        return;
      }

      setStatus('SDK cargado - Configurando cliente...');

      try {
        // Configurar Appwrite
        const { Client, Databases, Account } = Appwrite;
        
        const client = new Client()
          .setEndpoint(CONFIG.endpoint)
          .setProject(CONFIG.projectId);
        
        const databases = new Databases(client);
        const account = new Account(client);

        setStatus('Probando conexi√≥n con Appwrite...');

        // Test de conexi√≥n
        try {
          await account.get();
          setStatus('‚úÖ Conectado con sesi√≥n activa', 'success');
        } catch (error) {
          if (error.code === 401) {
            setStatus('‚úÖ Conectado como visitante - CORS funcionando', 'success');
          } else {
            throw error;
          }
        }

        // Cargar datos
        setStatus('Cargando √°lbumes...');
        
        const response = await databases.listDocuments(
          CONFIG.databaseId, 
          CONFIG.albumsCollectionId
        );

        if (response.documents.length === 0) {
          $('albums').innerHTML = `
            <div style="text-align:center;padding:3rem;color:#666;grid-column:1/-1">
              <h2>üéµ Todo listo</h2>
              <p>La conexi√≥n funciona correctamente.<br>Agrega √°lbumes desde el panel admin.</p>
            </div>
          `;
          setStatus('‚úÖ Conexi√≥n exitosa - Base de datos vac√≠a', 'success');
        } else {
          displayAlbums(response.documents);
          setStatus(`‚úÖ ${response.documents.length} √°lbum(es) cargados`, 'success');
        }

      } catch (error) {
        console.error('Error:', error);
        let errorMsg = error.message || 'Error desconocido';
        
        if (error.code === 401) {
          errorMsg = 'Sin permisos. Configura permisos p√∫blicos de lectura.';
        } else if (error.code === 404) {
          errorMsg = 'Base de datos no encontrada. Verifica los IDs.';
        }
        
        setStatus(`‚ùå ${errorMsg}`, 'error');
      }
    }

    function displayAlbums(albums) {
      $('albums').innerHTML = albums.map(album => `
        <div class="album-card">
          <div style="width:120px;height:120px;background:#444;border-radius:8px;margin:0 auto 1rem;display:flex;align-items:center;justify-content:center;font-size:3rem;">üéµ</div>
          <h3>${album.name}</h3>
          <p style="color:#999;">${album.artistName}</p>
        </div>
      `).join('');
    }

    // Iniciar cuando la p√°gina est√© lista
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', startApp);
    } else {
      startApp();
    }
  </script>
</body>
</html>
