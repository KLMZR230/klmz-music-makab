<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KLMZ MUSIC</title>
<meta name="description" content="KLMZ MUSIC - Tu plataforma de m√∫sica personal" />
<meta name="theme-color" content="#1db954" />
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{--bg:#121212;--panel:#181818;--panel2:#1f1f1f;--text:#fff;--muted:#b3b3b3;--brand:#1db954;--brand-hover:#17a84b;--stroke:#2a2a2a;--accent:#ff6b35;--error:#ff4444;--warning:#ffab00;--success:#4caf50;}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;padding-bottom:70px;overflow-x:hidden}
  @keyframes fadeIn{from{opacity:0}to{opacity:1}}
  @keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
  @keyframes slideDown{from{transform:translateY(-20px);opacity:0}to{transform:translateY(0);opacity:1}}
  @keyframes slideLeft{from{transform:translateX(20px);opacity:0}to{transform:translateX(0);opacity:1}}
  @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
  @keyframes glow{0%,100%{box-shadow:0 0 5px var(--brand)}50%{box-shadow:0 0 20px var(--brand),0 0 30px var(--brand)}}
  @keyframes bounce{0%,20%,50%,80%,100%{transform:translateY(0)}40%{transform:translateY(-10px)}60%{transform:translateY(-5px)}}
  @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
  @keyframes wave{0%,40%,100%{height:15px;background:linear-gradient(to top,var(--brand),var(--accent))}20%{height:35px;background:linear-gradient(to top,var(--accent),#ffab00)}}
  .fade-in{animation:fadeIn 0.5s ease}
  .slide-up{animation:slideUp 0.3s ease}
  .slide-down{animation:slideDown 0.3s ease}
  .slide-left{animation:slideLeft 0.3s ease}
  .pulse{animation:pulse 2s infinite}
  .glow{animation:glow 2s infinite}
  .bounce{animation:bounce 1s}
  .loading{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;flex-direction:column;z-index:9999;transition:opacity 0.3s ease}
  .loading .spinner{width:50px;height:50px;border:3px solid var(--stroke);border-top:3px solid var(--brand);border-radius:50%;animation:spin 1s linear infinite}
  .loading .text{margin-top:20px;color:var(--muted);font-weight:600}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#1db954 0%,#1db954 60%,#179b47 100%);padding:14px 18px;font-weight:800;letter-spacing:.3px;backdrop-filter:blur(10px)}
  header .row{display:flex;align-items:center;gap:12px;justify-content:space-between}
  .brand{font-size:20px;display:flex;align-items:center;gap:8px;transition:transform 0.3s ease}
  .brand:hover{transform:scale(1.05)}
  .brand .logo{display:inline-grid;place-items:center;width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,#ff6b35,#ff4500);font-weight:900;color:#fff;font-size:16px;transition:all 0.3s ease}
  .brand .logo:hover{transform:rotate(360deg)}
  .tools{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{background:var(--brand);border:none;color:#fff;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:600;transition:all 0.3s ease;position:relative;overflow:hidden}
  .btn:hover{background:var(--brand-hover);transform:translateY(-2px);box-shadow:0 4px 8px rgba(29,185,84,0.3)}
  .btn:active{transform:translateY(0)}
  .btn.ghost{background:transparent;border:1px solid #fff1}
  .btn.small{padding:6px 10px;font-size:12px}
  .btn.accent{background:var(--accent)}
  .btn.success{background:var(--success)}
  .btn.warning{background:var(--warning);color:#000}
  .icon-btn{background:transparent;border:1px solid #ffffff22;color:#fff;padding:8px 10px;border-radius:10px;cursor:pointer;font-size:18px;line-height:1;transition:all 0.3s ease}
  .icon-btn:hover{background:#ffffff14;transform:scale(1.1)}
  .container{padding:18px;max-width:1100px;margin:auto}
  .card{background:var(--panel);border:1px solid var(--stroke);border-radius:14px;padding:14px;transition:all 0.3s ease}
  .card:hover{transform:translateY(-2px);box-shadow:0 8px 16px rgba(0,0,0,0.3)}
  .grid{display:grid;gap:16px}
  .grid.albums{grid-template-columns:repeat(auto-fill,minmax(90px,1fr))}
  .grid.playlists{grid-template-columns:repeat(auto-fill,minmax(120px,1fr))}
  .album-card,.playlist-card{background:transparent;border:none;padding:8px;cursor:pointer;text-align:center;transition:.3s all ease;border-radius:12px}
  .album-card:hover,.playlist-card:hover{transform:translateY(-4px) scale(1.02);background:var(--panel)}
  .album-cover,.playlist-cover{width:100%;aspect-ratio:1/1;object-fit:cover;background:#0b0b0b;border:1px solid var(--stroke);transition:all 0.3s ease}
  .album-cover{border-radius:50%}
  .playlist-cover{border-radius:12px;background:linear-gradient(135deg,var(--brand),#2e7d32);display:flex;align-items:center;justify-content:center;font-size:2rem}
  .album-cover:hover,.playlist-cover:hover{transform:scale(1.05);box-shadow:0 4px 12px rgba(29,185,84,0.3)}
  .album-title,.playlist-title{margin:8px 2px 0;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:.92rem}
  .album-meta,.playlist-meta{margin:0;color:var(--muted);font-size:.78rem}
  .list{display:flex;flex-direction:column;gap:8px}
  .muted{color:var(--muted)}
  .section-title{margin:6px 2px 12px;font-size:1.1rem;font-weight:800;letter-spacing:.2px;position:relative}
  .section-title::before{content:'';position:absolute;bottom:-4px;left:0;width:30px;height:2px;background:var(--brand);border-radius:2px}
  .inputs{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  input[type="text"],input[type="email"],input[type="password"],select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--stroke);background:#101010;color:#fff;transition:all 0.3s ease}
  input:focus,select:focus,textarea:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 2px rgba(29,185,84,0.2)}
  textarea{min-height:60px;resize:vertical}
  input[type="file"]{width:100%;padding:10px;border-radius:10px;border:1px dashed var(--stroke);background:#0f0f0f;color:var(--muted);transition:all 0.3s ease}
  input[type="file"]:hover{border-color:var(--brand)}
  .stack{display:grid;gap:10px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .spacer{height:8px}
  .pill{padding:6px 10px;border-radius:999px;background:#ffffff10;border:1px solid var(--stroke);font-size:.8rem;color:#fff;transition:all 0.3s ease}
  .pill:hover{background:#ffffff20;transform:scale(1.05)}
  .music-controls{display:flex;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap}
  .control-btn{background:var(--panel);border:1px solid var(--stroke);color:var(--muted);padding:8px 12px;border-radius:20px;cursor:pointer;font-size:12px;transition:all 0.3s ease;display:flex;align-items:center;gap:6px}
  .control-btn:hover{background:var(--brand);color:white;transform:scale(1.05)}
  .control-btn.active{background:var(--brand);color:white}
  .favorite-btn{background:none;border:none;color:var(--muted);cursor:pointer;font-size:18px;transition:all 0.3s ease;padding:4px;border-radius:50%}
  .favorite-btn:hover{color:#ff4444;transform:scale(1.2)}
  .favorite-btn.active{color:#ff4444}
  .download-btn{background:var(--success);border:none;color:white;padding:6px 10px;border-radius:15px;cursor:pointer;font-size:11px;transition:all 0.3s ease;display:flex;align-items:center;gap:4px}
  .download-btn:hover{background:#45a049;transform:scale(1.05)}
  .download-btn.downloaded{background:var(--muted);cursor:default}
  .download-progress{width:100%;height:4px;background:var(--stroke);border-radius:2px;overflow:hidden;margin-top:4px}
  .download-progress-bar{height:100%;background:var(--success);transition:width 0.3s ease;border-radius:2px}
  .search-bar{position:relative;margin-bottom:20px}
  .search-input{width:100%;padding:12px 48px 12px 16px;border-radius:25px;border:1px solid var(--stroke);background:var(--panel);color:var(--text);font-size:16px;transition:all 0.3s ease}
  .search-input:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 3px rgba(29,185,84,0.2);transform:scale(1.02)}
  .search-input::placeholder{color:var(--muted)}
  .search-icon{position:absolute;right:16px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:18px;pointer-events:none;transition:all 0.3s ease}
  .search-clear{position:absolute;right:16px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--muted);cursor:pointer;font-size:18px;padding:4px;border-radius:50%;display:none;transition:all 0.3s ease}
  .search-clear:hover{background:var(--stroke);color:var(--text);transform:translateY(-50%) scale(1.2)}
  .search-results{display:none}
  .search-section{margin-bottom:24px}
  .search-section:last-child{margin-bottom:0}
  .search-section-title{font-size:1.1rem;font-weight:800;margin-bottom:12px;color:var(--text);display:flex;align-items:center;gap:8px}
  .search-section-count{background:var(--stroke);color:var(--muted);padding:2px 8px;border-radius:12px;font-size:12px;font-weight:500}
  .search-albums-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:16px;margin-bottom:16px}
  .search-album-card{background:transparent;border:none;padding:8px;cursor:pointer;text-align:center;transition:all 0.3s ease;border-radius:8px}
  .search-album-card:hover{transform:translateY(-2px);background:var(--panel)}
  .search-album-cover{width:100%;aspect-ratio:1/1;border-radius:50%;object-fit:cover;background:#0b0b0b;border:1px solid var(--stroke);margin-bottom:8px;transition:all 0.3s ease}
  .search-album-cover:hover{transform:scale(1.05)}
  .search-album-title{font-weight:700;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:4px}
  .search-album-meta{color:var(--muted);font-size:12px}
  .search-songs-list{display:flex;flex-direction:column;gap:8px}
  .search-song-item{display:flex;align-items:center;gap:12px;padding:8px 12px;border-radius:8px;cursor:pointer;transition:all 0.3s ease}
  .search-song-item:hover{background:var(--panel);transform:translateX(4px)}
  .search-song-cover{width:48px;height:48px;border-radius:8px;object-fit:cover;background:#0b0b0b;border:1px solid var(--stroke);transition:all 0.3s ease}
  .search-song-info{flex:1;min-width:0}
  .search-song-title{font-weight:600;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:2px}
  .search-song-artist{color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .search-song-actions{display:flex;gap:8px;align-items:center}
  .search-song-play{background:var(--brand);border:none;color:white;width:32px;height:32px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;transition:all 0.3s ease}
  .search-song-play:hover{background:var(--brand-hover);transform:scale(1.1)}
  .search-song-more{background:none;border:none;color:var(--muted);width:32px;height:32px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;transition:all 0.3s ease}
  .search-song-more:hover{background:var(--stroke);color:var(--text);transform:scale(1.1)}
  .no-results{text-align:center;color:var(--muted);padding:40px 20px;font-size:16px}
  .no-results-icon{font-size:48px;margin-bottom:16px}
  #albumView,#playlistView,#favoritesView,#downloadsView{display:none}
  .album-hero,.playlist-hero{display:flex;gap:14px;align-items:center;margin-bottom:20px}
  .album-hero img,.playlist-hero .cover{width:96px;height:96px;border-radius:12px;border:1px solid var(--stroke);object-fit:cover;background:#0b0b0b;transition:all 0.3s ease}
  .album-hero img:hover,.playlist-hero .cover:hover{transform:scale(1.05)}
  .playlist-hero .cover{background:linear-gradient(135deg,var(--brand),#2e7d32);display:flex;align-items:center;justify-content:center;font-size:2rem;color:#fff}
  .album-hero .info,.playlist-hero .info{min-width:0;flex:1}
  .album-hero .title,.playlist-hero .title{font-size:1.2rem;font-weight:900}
  .album-hero .meta,.playlist-hero .meta{color:var(--muted);font-size:.9rem}
  .song-plain-list{margin-top:8px}
  .song-plain-item{padding:12px 8px;border-bottom:1px solid #1f1f1f;display:flex;align-items:center;gap:12px;transition:all 0.3s ease;border-radius:8px;margin-bottom:2px}
  .song-plain-item:last-child{border-bottom:none}
  .song-plain-item:hover{background:var(--panel);transform:translateX(4px)}
  .song-plain-item .idx{min-width:20px;text-align:right;color:var(--muted)}
  .song-plain-item .title{flex:1;font-weight:600}
  .song-plain-item .album{color:var(--muted);font-size:.9rem;min-width:120px}
  .song-plain-item .more{font-size:18px;color:var(--muted);cursor:pointer;padding:6px;border-radius:50%;transition:all 0.3s ease}
  .song-plain-item .more:hover{background:#ffffff14;transform:scale(1.2)}
  .song-plain-item.error{color:#ff6b6b}
  .backline{display:flex;align-items:center;gap:10px;margin-bottom:20px}
  .back-btn{background:transparent;border:1px solid #ffffff22;color:#fff;width:36px;height:36px;border-radius:10px;font-size:18px;display:grid;place-items:center;cursor:pointer;transition:all 0.3s ease}
  .back-btn:hover{background:#ffffff14;transform:scale(1.1)}
  .player{position:fixed;left:0;right:0;bottom:70px;background:linear-gradient(135deg,#181818,#1f1f1f);border-top:1px solid var(--stroke);padding:14px 16px;z-index:20;display:none;animation:slideUp 0.4s ease;backdrop-filter:blur(20px)}
  .player.show{display:block}
  .player .wrap{display:grid;grid-template-columns:1fr;gap:12px;align-items:center}
  .np{display:flex;align-items:center;gap:12px;min-width:0}
  .np img{width:68px;height:68px;border-radius:12px;border:1px solid var(--stroke);object-fit:cover;background:#0b0b0b;transition:all 0.3s ease}
  .np img:hover{transform:scale(1.05)}
  .np .titles{min-width:0}
  .np .titles .t{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:1rem}
  .np .titles .a{color:var(--muted);font-size:.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .controls{display:flex;flex-direction:column;gap:10px}
  .controls .buttons{display:flex;align-items:center;justify-content:center;gap:18px}
  .controls .buttons .circle{width:64px;height:64px;border-radius:50%;display:grid;place-items:center;border:1px solid var(--stroke);background:linear-gradient(135deg,#222,#333);font-size:26px;font-weight:900;cursor:pointer;transition:all 0.3s ease;position:relative;overflow:hidden}
  .controls .buttons .circle::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,var(--brand),var(--accent));opacity:0;transition:opacity 0.3s ease;border-radius:50%}
  .controls .buttons .circle:hover{transform:scale(1.1)}
  .controls .buttons .circle:hover::before{opacity:0.1}
  .controls .buttons .circle:active{transform:scale(0.95)}
  .controls .buttons .sm{width:52px;height:52px;font-size:22px}
  .controls .seek{display:flex;align-items:center;gap:10px}
  .controls input[type="range"]{width:100%;transition:all 0.3s ease}
  .controls input[type="range"]:hover{transform:scaleY(1.2)}
  .right{display:flex;justify-content:space-between;gap:10px;align-items:center}
  .vol{display:flex;align-items:center;gap:8px}
  .tag{padding:4px 8px;border:1px solid var(--stroke);border-radius:8px;font-size:.8rem;color:var(--muted)}
  .link{color:#9adfff;text-decoration:none}
  #npOverlay{position:fixed;inset:0;background:rgba(0,0,0,0.9);backdrop-filter:blur(20px);display:none;align-items:center;justify-content:center;z-index:40;animation:fadeIn 0.4s ease}
  #npCard{background:linear-gradient(135deg,#111,#222);border:1px solid var(--stroke);border-radius:18px;width:min(520px,92vw);padding:24px;display:grid;gap:16px;justify-items:center;animation:slideUp 0.4s ease}
  #npCard img{width:min(420px,82vw);height:min(420px,82vw);border-radius:14px;object-fit:cover;border:1px solid var(--stroke);background:#0b0b0b;transition:all 0.5s ease}
  #npCard img:hover{transform:scale(1.02)}
  #npCard .t{font-size:1.2rem;font-weight:900;text-align:center}
  #npCard .a{color:var(--muted);text-align:center}
  #bottomBar{position:fixed;bottom:0;left:0;width:100%;height:70px;background:linear-gradient(135deg,var(--panel2),#252525);border-top:1px solid var(--stroke);display:grid;grid-template-columns:1fr 1fr 1fr 1fr;place-items:center;padding:8px 20px 4px;box-shadow:0 -4px 20px rgba(0,0,0,0.5);z-index:40;backdrop-filter:blur(20px)}
  #bottomBar button{background:transparent;border:none;color:var(--muted);cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:4px;font-size:10px;font-weight:500;text-transform:uppercase;letter-spacing:0.5px;user-select:none;transition:all 0.3s ease;padding:8px;border-radius:12px;position:relative}
  #bottomBar button.active,#bottomBar button:hover{color:var(--brand);transform:translateY(-2px)}
  #bottomBar button.active::before{content:'';position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:4px;height:4px;background:var(--brand);border-radius:50%}
  #bottomBar .icon{width:28px;height:28px;stroke:currentColor;stroke-width:2;fill:none;transition:all 0.3s ease}
  #bottomBar button:hover .icon{transform:scale(1.1)}
  #bottomBar .label{font-size:10px;font-weight:600;margin-top:2px}
  .scroll-footer{display:none;position:fixed;bottom:70px;left:0;width:100%;background:var(--bg);border-top:1px solid var(--stroke);padding:12px 0;text-align:center;color:var(--muted);font-size:12px;font-weight:500;z-index:30;animation:slideUp 0.3s ease}
  .soundwave{width:100px;height:40px;display:flex;align-items:center;gap:4px}
  .bar{width:6px;height:15px;background:linear-gradient(to top,var(--brand),var(--accent));border-radius:3px;animation:wave 1.2s infinite ease-in-out;animation-fill-mode:both;box-shadow:0 0 10px rgba(29,185,84,0.3)}
  .bar:nth-child(1){animation-delay:-1.1s}
  .bar:nth-child(2){animation-delay:-0.9s}
  .bar:nth-child(3){animation-delay:-0.7s}
  .bar:nth-child(4){animation-delay:-0.5s}
  .bar:nth-child(5){animation-delay:-0.3s}
  .status-indicator{position:fixed;top:80px;right:20px;z-index:100;animation:slideLeft 0.3s ease}
  .error-msg{background:linear-gradient(135deg,var(--error),#cc0000);color:white;padding:12px 16px;border-radius:8px;font-size:12px;font-weight:600;box-shadow:0 4px 12px rgba(255,68,68,0.3);animation:slideLeft 0.3s ease}
  .success-msg{background:linear-gradient(135deg,var(--success),#2e7d32);color:white;padding:12px 16px;border-radius:8px;font-size:12px;font-weight:600;box-shadow:0 4px 12px rgba(76,175,80,0.3);animation:slideLeft 0.3s ease}
  .warning-msg{background:linear-gradient(135deg,var(--warning),#f57f17);color:black;padding:12px 16px;border-radius:8px;font-size:12px;font-weight:600;box-shadow:0 4px 12px rgba(255,171,0,0.3);animation:slideLeft 0.3s ease}
  .dropdown{position:absolute;background:var(--panel);border:1px solid var(--stroke);border-radius:12px;min-width:200px;box-shadow:0 8px 32px rgba(0,0,0,0.8);z-index:1000;display:none;backdrop-filter:blur(20px);animation:slideUp 0.2s ease}
  .dropdown.show{display:block}
  .dropdown-item{padding:12px 16px;cursor:pointer;border-bottom:1px solid var(--stroke);font-size:13px;transition:all 0.2s ease}
  .dropdown-item:last-child{border-bottom:none}
  .dropdown-item:hover{background:var(--panel2);transform:translateX(4px)}
  .dropdown-item.create-new{color:var(--brand);font-weight:600}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:60;backdrop-filter:blur(10px);animation:fadeIn 0.3s ease}
  .modal.show{display:flex}
  .modal-content{background:var(--panel);border:1px solid var(--stroke);border-radius:16px;padding:24px;max-width:450px;width:90%;animation:slideUp 0.3s ease}
  @media (max-width:800px){.inputs{grid-template-columns:1fr}.player .wrap{grid-template-columns:1fr}.np img{width:72px;height:72px}.controls .buttons .circle{width:76px;height:76px;font-size:30px}.controls .buttons .sm{width:60px;height:60px;font-size:24px}body{padding-bottom:70px}.player{bottom:70px}.player.show{bottom:70px}#bottomBar{padding:6px 10px 2px;height:70px}#bottomBar button{font-size:9px;gap:3px}#bottomBar .icon{width:24px;height:24px}#bottomBar .label{font-size:9px}.scroll-footer{bottom:70px}.search-albums-grid{grid-template-columns:repeat(auto-fill,minmax(80px,1fr))}.music-controls{flex-wrap:wrap}}
</style>
</head>
<body>
<div id="loadingScreen" class="loading">
  <div class="spinner"></div>
  <div class="text">Cargando KLMZ MUSIC...</div>
</div>

<header class="slide-down">
  <div class="row">
    <div class="brand">
      <span class="logo">üî•</span> 
      KLMZ MUSIC
    </div>
    <div class="tools">
      <span class="muted" id="albumsTitle">Tu m√∫sica</span>
      <button class="icon-btn" id="btn-login" title="Admin" onclick="showLogin()">üîë</button>
      <button class="btn ghost" id="btn-logout" style="display:none" onclick="logout()">Salir</button>
    </div>
  </div>
</header>

<div class="container">
  <div class="row muted fade-in" style="margin-bottom:20px;">
    <span class="tag">Cat√°logo p√∫blico</span>
    <span id="adminTag" class="tag" style="display:none">Admin</span>
    <span id="userTag" class="tag" style="display:none">Usuario</span>
    <span id="offlineTag" class="tag" style="display:none;background:var(--success)">Offline</span>
  </div>

  <div id="musicControls" class="music-controls fade-in" style="display:none;">
    <button class="control-btn" id="shuffleBtn" onclick="toggleShuffle()" title="Aleatorio">
      <span>üîÄ</span> Shuffle
    </button>
    <button class="control-btn" id="repeatBtn" onclick="toggleRepeat()" title="Repetir">
      <span>üîÅ</span> Repeat
    </button>
    <button class="control-btn" onclick="showFavorites()" title="Favoritos">
      <span>‚ù§Ô∏è</span> Favoritos
    </button>
    <button class="control-btn" onclick="showDownloads()" title="Descargas">
      <span>üì•</span> Offline
    </button>
  </div>

  <div id="searchSection" class="search-bar slide-up" style="display:none;">
    <input type="text" id="searchInput" class="search-input" placeholder="Buscar √°lbumes, canciones o playlists..." oninput="performSearch(this.value)" />
    <span id="searchIcon" class="search-icon">üîç</span>
    <button id="searchClear" class="search-clear" onclick="clearSearch()" style="display:none;">√ó</button>
  </div>

  <div id="searchResults" class="search-results">
    <div id="searchAlbumsSection" class="search-section" style="display:none;">
      <div class="search-section-title">üìÄ √Ålbumes <span id="albumsCount" class="search-section-count">0</span></div>
      <div id="searchAlbumsGrid" class="search-albums-grid"></div>
    </div>
    <div id="searchSongsSection" class="search-section" style="display:none;">
      <div class="search-section-title">üéµ Canciones <span id="songsCount" class="search-section-count">0</span></div>
      <div id="searchSongsList" class="search-songs-list"></div>
    </div>
    <div id="searchPlaylistsSection" class="search-section" style="display:none;">
      <div class="search-section-title">üìã Playlists <span id="playlistsCount" class="search-section-count">0</span></div>
      <div id="searchPlaylistsList" class="search-songs-list"></div>
    </div>
    <div id="noResults" class="no-results" style="display:none;">
      <div class="no-results-icon">üîç</div>
      <div>No se encontraron resultados</div>
      <div style="color: var(--muted); font-size: 14px; margin-top: 8px;">Intenta con t√©rminos diferentes</div>
    </div>
  </div>

  <div id="favoritesView" style="display:none;">
    <div class="backline">
      <button class="back-btn" onclick="closeFavoritesView()" title="Volver">‚Üê</button>
      <span class="muted">Volver</span>
    </div>
    <div class="section-title">‚ù§Ô∏è Mis Favoritos</div>
    <div id="favoritesList" class="search-songs-list"></div>
    <div id="emptyFavorites" class="no-results" style="display:none;">
      <div class="no-results-icon">‚ù§Ô∏è</div>
      <div>No tienes favoritos a√∫n</div>
      <div style="color: var(--muted); font-size: 14px; margin-top: 8px;">Marca canciones como favoritas para verlas aqu√≠</div>
    </div>
  </div>

  <div id="downloadsView" style="display:none;">
    <div class="backline">
      <button class="back-btn" onclick="closeDownloadsView()" title="Volver">‚Üê</button>
      <span class="muted">Volver</span>
    </div>
    <div class="section-title">üì• M√∫sica Offline</div>
    <div id="downloadsList" class="search-songs-list"></div>
    <div id="emptyDownloads" class="no-results" style="display:none;">
      <div class="no-results-icon">üì•</div>
      <div>No tienes m√∫sica offline</div>
      <div style="color: var(--muted); font-size: 14px; margin-top: 8px;">Descarga canciones para escuchar sin conexi√≥n</div>
    </div>
  </div>
  
  <div id="adminPanel" class="card stack slide-up" style="display:none">
    <div class="section-title">Panel Admin</div>
    <div class="inputs">
      <div class="stack">
        <div class="pill">Crear nuevo √°lbum</div>
        <input id="albumTitle" type="text" placeholder="T√≠tulo del √°lbum" />
        <input id="albumCover" type="file" accept="image/*" />
        <button class="btn" onclick="uploadAlbum()">Subir √Ålbum</button>
      </div>
      <div class="stack">
        <div class="pill">Agregar canciones a un √°lbum existente</div>
        <select id="albumSelect"></select>
        <input id="songTitle" type="text" placeholder="T√≠tulo de la canci√≥n (opcional si subes 1)" />
        <input id="songFiles" type="file" accept="audio/*" multiple />
        <button class="btn" onclick="uploadSong()">Subir Canciones</button>
      </div>
      <div class="stack">
        <div class="pill">Borrar</div>
        <select id="deleteAlbumSelect"></select>
        <button class="btn ghost" onclick="deleteAlbum()">Eliminar √Ålbum</button>
      </div>
    </div>
  </div>

  <div id="userPanel" class="card stack slide-up" style="display:none">
    <div class="row">
      <div class="section-title">Mis Playlists</div>
      <button class="btn small" onclick="showCreatePlaylistModal()">+ Nueva Playlist</button>
    </div>
    <div id="userPlaylistsGrid" class="grid playlists"></div>
    <div id="emptyPlaylists" class="muted" style="display:none">No tienes playlists todav√≠a. ¬°Crea tu primera playlist!</div>
  </div>
  
  <div id="homeContent" class="fade-in">
    <div class="section-title">Albums</div>
    <div id="albumsGrid" class="grid albums"></div>
    <div id="emptyAlbums" class="muted" style="display:none">No hay √°lbumes todav√≠a.</div>
    <div id="publicPlaylistsSection" style="display:none">
      <div class="spacer"></div>
      <div class="section-title">Playlists P√∫blicas</div>
      <div id="publicPlaylistsGrid" class="grid playlists"></div>
    </div>
  </div>
  
  <div id="albumView" class="card stack slide-up">
    <div class="backline">
      <button class="back-btn" onclick="closeAlbumView()" title="Volver">‚Üê</button>
      <span class="muted">Volver</span>
    </div>
    <div class="album-hero">
      <img id="avCover" alt="cover">
      <div class="info">
        <div id="avTitle" class="title">‚Äî</div>
        <div id="avMeta" class="meta">‚Äî</div>
      </div>
    </div>
    <div id="avSongs" class="song-plain-list"></div>
  </div>

  <div id="playlistView" class="card stack slide-up">
    <div class="backline">
      <button class="back-btn" onclick="closePlaylistView()" title="Volver">‚Üê</button>
      <span class="muted">Volver</span>
    </div>
    <div class="playlist-hero">
      <div class="cover" id="pvCover">üéµ</div>
      <div class="info">
        <div id="pvTitle" class="title">‚Äî</div>
        <div id="pvMeta" class="meta">‚Äî</div>
        <div id="pvDescription" class="muted" style="margin-top:8px;font-size:14px"></div>
      </div>
      <div id="playlistActions" style="display:none">
        <button class="btn small" onclick="editPlaylist()">Editar</button>
        <button class="btn ghost small" onclick="deletePlaylistConfirm()">Eliminar</button>
      </div>
    </div>
    <div id="pvSongs" class="song-plain-list"></div>
  </div>
</div>

<div class="player" id="player" onclick="openNowPlaying()">
  <div class="wrap">
    <div class="np">
      <img id="npCover" alt="cover">
      <div class="titles">
        <div id="npTitle" class="t">Cargando...</div>
        <div id="npAlbum" class="a">‚Äî</div>
      </div>
    </div>
    <div class="controls">
      <div class="buttons">
        <button class="circle sm" onclick="event.stopPropagation(); prevTrack()">‚èÆ</button>
        <button class="circle" id="playBtn" onclick="event.stopPropagation(); togglePlay()">‚ñ∂</button>
        <button class="circle sm" onclick="event.stopPropagation(); nextTrack()">‚è≠</button>
      </div>
      <div class="seek">
        <span id="curTime" class="muted">0:00</span>
        <input id="seek" type="range" min="0" max="100" value="0" oninput="seekAudio(this.value)" onclick="event.stopPropagation()" />
        <span id="durTime" class="muted">0:00</span>
      </div>
    </div>
    <div class="right">
      <div class="vol">
        <span class="muted">Vol</span>
        <input id="vol" type="range" min="0" max="1" step="0.01" value="1" oninput="setVolume(this.value)" onclick="event.stopPropagation()" />
      </div>
      <div class="soundwave" id="soundwave" style="display:none">
        <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
      </div>
      <audio id="audio" preload="none" crossorigin="anonymous"></audio>
    </div>
  </div>
</div>

<div id="npOverlay" onclick="closeNowPlaying()">
  <div id="npCard" onclick="event.stopPropagation()">
    <img id="npBigCover" alt="cover">
    <div class="t" id="npBigTitle">‚Äî</div>
    <div class="a" id="npBigAlbum">‚Äî</div>
    <div class="row" style="margin:16px 0">
      <button class="favorite-btn" id="npFavoriteBtn" onclick="toggleCurrentFavorite()" title="Favorito">ü§ç</button>
      <button class="download-btn" id="npDownloadBtn" onclick="downloadCurrentSong()" title="Descargar">üì• Offline</button>
    </div>
    <div class="soundwave" style="margin:20px 0;">
      <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
    </div>
    <div class="controls" style="width:100%;max-width:520px">
      <div class="buttons">
        <button class="circle sm" onclick="prevTrack()">‚èÆ</button>
        <button class="circle" onclick="togglePlay()" id="playBtnBig">‚ñ∂</button>
        <button class="circle sm" onclick="nextTrack()">‚è≠</button>
      </div>
      <div class="seek">
        <span id="curTimeBig" class="muted">0:00</span>
        <input id="seekBig" type="range" min="0" max="100" value="0" oninput="seekAudio(this.value)" />
        <span id="durTimeBig" class="muted">0:00</span>
      </div>
    </div>
  </div>
</div>

<div id="bottomBar">
  <button id="btn-home" title="Inicio" onclick="goHome(); setActiveNav('home')" class="active" aria-label="Inicio">
    <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path d="M3 11L12 2l9 9v9a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2v-5H9v5a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-9z"/>
    </svg>
    <span class="label">Inicio</span>
  </button>
  <button id="btn-search" title="Buscar" onclick="showSearch(); setActiveNav('search')" aria-label="Buscar">
    <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <circle cx="11" cy="11" r="7"/>
      <line x1="16.5" y1="16.5" x2="21" y2="21"/>
    </svg>
    <span class="label">Buscar</span>
  </button>
  <button id="btn-playlists" title="Playlists" onclick="showPlaylists(); setActiveNav('playlists')" aria-label="Playlists">
    <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/>
    </svg>
    <span class="label">Playlists</span>
  </button>
  <button id="btn-account" title="Cuenta" onclick="showAccount(); setActiveNav('account')" aria-label="Cuenta">
    <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <circle cx="12" cy="7" r="4"/>
      <path d="M5.5 21a7.5 7.5 0 0 1 13 0"/>
    </svg>
    <span class="label">Cuenta</span>
  </button>
</div>

<div id="scrollFooter" class="scroll-footer">
  &copy; <script>document.write(new Date().getFullYear())</script> Freddy Granados. Todos los derechos reservados.
</div>

<div id="playlistModal" class="modal">
  <div class="modal-content">
    <div class="stack">
      <div class="section-title" id="playlistModalTitle">Nueva Playlist</div>
      <input id="playlistName" type="text" placeholder="Nombre de la playlist" />
      <textarea id="playlistDescription" placeholder="Descripci√≥n (opcional)"></textarea>
      <label style="display:flex;align-items:center;gap:8px;">
        <input type="checkbox" id="playlistPublic"> Hacer p√∫blica
      </label>
      <div class="row">
        <button class="btn" onclick="savePlaylist()">Guardar</button>
        <button class="btn ghost" onclick="closePlaylistModal()">Cancelar</button>
      </div>
    </div>
  </div>
</div>

<div id="playlistDropdown" class="dropdown">
  <div class="dropdown-item create-new" onclick="showCreatePlaylistModal()">+ Nueva Playlist</div>
  <div id="playlistDropdownContent"></div>
</div>

<div id="loginModal" class="card" style="display:none;position:fixed;inset:0;margin:auto;max-width:420px;height:max-content;z-index:50">
  <div class="stack">
    <div class="section-title">Iniciar sesi√≥n</div>
    <input id="email" type="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Contrase√±a" />
    <div class="row">
      <button class="btn" onclick="login()">Entrar</button>
      <button class="btn ghost" onclick="hideLogin()">Cancelar</button>
    </div>
    <small class="muted">Crea una cuenta o inicia sesi√≥n para gestionar playlists.</small>
  </div>
</div>

<script>
const SUPABASE_URL = "https://nqbldvpnqhngdtalvzov.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xYmxkdnBucWhuZ2R0YWx2em92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyMjY0NjUsImV4cCI6MjA3MDgwMjQ2NX0.Zzg5D219sW7bhvl0_R5ypX9MF6nRzBSDIeo2Lvebab0";
const ADMIN_EMAIL = "klmzr@gmail.com";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let isAdmin = false, isLoggedIn = false, currentUser = null;
let albums = [], userPlaylists = [], publicPlaylists = [];
let songsByAlbum = {}, songsByPlaylist = {}, flatSongs = [];
let queue = [], qIndex = -1, currentAlbum = null, currentPlaylist = null;
let editingPlaylistId = null, selectedSongForPlaylist = null;
let isSearchMode = false, searchSongsCache = [];
let isShuffleMode = false, repeatMode = 0;
let favorites = new Set(), downloads = new Map();
let originalQueue = [];

const albumsGrid = document.getElementById("albumsGrid");
const emptyAlbums = document.getElementById("emptyAlbums");
const npCover = document.getElementById("npCover");
const npTitle = document.getElementById("npTitle");
const npAlbum = document.getElementById("npAlbum");
const playBtn = document.getElementById("playBtn");
const audioEl = document.getElementById("audio");
const seekEl = document.getElementById("seek");
const curTime = document.getElementById("curTime");
const durTime = document.getElementById("durTime");
const npOverlay = document.getElementById("npOverlay");
const npBigCover = document.getElementById("npBigCover");
const npBigTitle = document.getElementById("npBigTitle");
const npBigAlbum = document.getElementById("npBigAlbum");
const curTimeBig = document.getElementById("curTimeBig");
const durTimeBig = document.getElementById("durTimeBig");
const seekBig = document.getElementById("seekBig");
const playBtnBig = document.getElementById("playBtnBig");
const playerElement = document.getElementById("player");
const loadingScreen = document.getElementById("loadingScreen");
const shuffleBtn = document.getElementById("shuffleBtn");
const repeatBtn = document.getElementById("repeatBtn");
const musicControls = document.getElementById("musicControls");
const favoritesView = document.getElementById("favoritesView");
const downloadsView = document.getElementById("downloadsView");
const favoritesList = document.getElementById("favoritesList");
const downloadsList = document.getElementById("downloadsList");
const npFavoriteBtn = document.getElementById("npFavoriteBtn");
const npDownloadBtn = document.getElementById("npDownloadBtn");
const albumView = document.getElementById("albumView");
const avCover = document.getElementById("avCover");
const avTitle = document.getElementById("avTitle");
const avMeta = document.getElementById("avMeta");
const avSongs = document.getElementById("avSongs");
const playlistView = document.getElementById("playlistView");
const pvCover = document.getElementById("pvCover");
const pvTitle = document.getElementById("pvTitle");
const pvMeta = document.getElementById("pvMeta");
const pvDescription = document.getElementById("pvDescription");
const pvSongs = document.getElementById("pvSongs");
const userPanel = document.getElementById("userPanel");
const userPlaylistsGrid = document.getElementById("userPlaylistsGrid");
const publicPlaylistsGrid = document.getElementById("publicPlaylistsGrid");
const publicPlaylistsSection = document.getElementById("publicPlaylistsSection");
const emptyPlaylists = document.getElementById("emptyPlaylists");
const playlistModal = document.getElementById("playlistModal");
const playlistModalTitle = document.getElementById("playlistModalTitle");
const playlistName = document.getElementById("playlistName");
const playlistDescription = document.getElementById("playlistDescription");
const playlistPublic = document.getElementById("playlistPublic");
const playlistDropdown = document.getElementById("playlistDropdown");
const playlistDropdownContent = document.getElementById("playlistDropdownContent");
const searchSection = document.getElementById("searchSection");
const searchInput = document.getElementById("searchInput");
const searchIcon = document.getElementById("searchIcon");
const searchClear = document.getElementById("searchClear");
const searchResults = document.getElementById("searchResults");
const homeContent = document.getElementById("homeContent");
const searchAlbumsSection = document.getElementById("searchAlbumsSection");
const searchSongsSection = document.getElementById("searchSongsSection");
const searchPlaylistsSection = document.getElementById("searchPlaylistsSection");
const searchAlbumsGrid = document.getElementById("searchAlbumsGrid");
const searchSongsList = document.getElementById("searchSongsList");
const searchPlaylistsList = document.getElementById("searchPlaylistsList");
const noResults = document.getElementById("noResults");
const albumsCount = document.getElementById("albumsCount");
const songsCount = document.getElementById("songsCount");
const playlistsCount = document.getElementById("playlistsCount");
const scrollFooter = document.getElementById("scrollFooter");
function showCreatePlaylistModal(){
  if (!isLoggedIn) {
    showLogin();
    return;
  }
  editingPlaylistId = null;
  playlistModalTitle.textContent = 'Nueva Playlist';
  playlistName.value = '';
  playlistDescription.value = '';
  playlistPublic.checked = false;
  playlistModal.classList.add('show');
}

function editPlaylist(){
  if (!currentPlaylist) return;
  editingPlaylistId = currentPlaylist.id;
  playlistModalTitle.textContent = 'Editar Playlist';
  playlistName.value = currentPlaylist.name;
  playlistDescription.value = currentPlaylist.description || '';
  playlistPublic.checked = currentPlaylist.is_public;
  playlistModal.classList.add('show');
}

function closePlaylistModal(){
  playlistModal.classList.remove('show');
  editingPlaylistId = null;
}

async function savePlaylist(){
  if (!isLoggedIn) return;
  
  const name = playlistName.value.trim();
  if (!name) {
    showMessage('Ingresa un nombre para la playlist', 'warning');
    return;
  }
  
  const data = {
    name,
    description: playlistDescription.value.trim() || null,
    is_public: playlistPublic.checked,
    user_id: currentUser.id
  };
  
  let result;
  if (editingPlaylistId) {
    result = await sb
      .from('playlists')
      .update(data)
      .eq('id', editingPlaylistId);
  } else {
    result = await sb
      .from('playlists')
      .insert([data]);
  }
  
  if (result.error) {
    showMessage('Error guardando playlist: ' + result.error.message, 'error');
    return;
  }
  
  closePlaylistModal();
  await loadPlaylists();
  showMessage(editingPlaylistId ? 'Playlist actualizada' : 'Playlist creada', 'success');
}

function openPlaylist(playlist){
  currentPlaylist = playlist;
  const songs = songsByPlaylist[playlist.id] || [];
  
  pvTitle.textContent = playlist.name;
  pvMeta.textContent = `${songs.length} ${songs.length===1?'canci√≥n':'canciones'}`;
  pvDescription.textContent = playlist.description || '';
  
  const isOwner = isLoggedIn && playlist.user_id === currentUser.id;
  document.getElementById('playlistActions').style.display = isOwner ? 'flex' : 'none';
  
  pvSongs.innerHTML = "";
  if (!songs.length){
    pvSongs.innerHTML = `<div class="muted" style="padding:12px 0">Esta playlist est√° vac√≠a.</div>`;
  } else {
    songs.forEach((s,idx) => {
      const isFavorite = favorites.has(s.id);
      const isDownloaded = downloads.has(s.id);
      const row = document.createElement("div");
      row.className = "song-plain-item";
      row.innerHTML = `
        <div class="idx">${idx+1}</div>
        <div class="title">${s.title}</div>
        <div class="album">${s.album_title}</div>
        <button class="favorite-btn ${isFavorite ? 'active' : ''}" onclick="event.stopPropagation(); toggleFavorite('${s.id}', this)" title="Favorito">${isFavorite ? '‚ù§Ô∏è' : 'ü§ç'}</button>
        <button class="download-btn ${isDownloaded ? 'downloaded' : ''}" onclick="event.stopPropagation(); downloadSong('${s.id}', '${s.song_url}', '${s.title.replace(/'/g, "\\'")}', this)" title="Descargar">${isDownloaded ? '‚úì' : 'üì•'}</button>
        <div class="more" onclick="event.stopPropagation(); ${isOwner ? `removeSongFromPlaylist('${s.playlist_song_id}')` : ''}">
          ${isOwner ? '√ó' : '‚ãØ'}
        </div>
      `;
      row.onclick = () => {
        queue = songs.map(t => ({...t, album_title: t.album_title, cover_url: t.cover_url}));
        qIndex = -1;
        startQueueAt(idx);
      };
      pvSongs.appendChild(row);
    });
  }
  
  playlistView.style.display = "block";
  playlistView.scrollIntoView({behavior:"smooth",block:"start"});
}

function closePlaylistView(){
  playlistView.style.display = "none";
  currentPlaylist = null;
}

function showAddToPlaylistMenu(event, song) {
  if (!isLoggedIn) {
    showLogin();
    return;
  }
  
  event.stopPropagation();
  selectedSongForPlaylist = song;
  
  const rect = event.target.getBoundingClientRect();
  playlistDropdown.style.top = (rect.top - 200) + 'px';
  playlistDropdown.style.left = (rect.left - 150) + 'px';
  playlistDropdown.classList.add('show');
  
  setTimeout(() => {
    document.addEventListener('click', hidePlaylistDropdown, { once: true });
  }, 100);
}

function hidePlaylistDropdown(){
  playlistDropdown.classList.remove('show');
}

async function addSongToPlaylist(playlistId) {
  hidePlaylistDropdown();
  
  if (!selectedSongForPlaylist) return;
  
  const existing = await sb
    .from('playlist_songs')
    .select('id')
    .eq('playlist_id', playlistId)
    .eq('song_id', selectedSongForPlaylist.id)
    .single();
  
  if (existing.data) {
    showMessage('La canci√≥n ya est√° en esta playlist', 'warning');
    return;
  }
  
  const { data: maxPos } = await sb
    .from('playlist_songs')
    .select('position')
    .eq('playlist_id', playlistId)
    .order('position', {ascending: false})
    .limit(1)
    .single();
  
  const position = (maxPos?.position || 0) + 1;
  
  const { error } = await sb
    .from('playlist_songs')
    .insert([{
      playlist_id: playlistId,
      song_id: selectedSongForPlaylist.id,
      position
    }]);
  
  if (error) {
    showMessage('Error agregando canci√≥n: ' + error.message, 'error');
    return;
  }
  
  showMessage('Canci√≥n agregada a la playlist', 'success');
  await loadPlaylists();
  
  if (currentPlaylist && currentPlaylist.id === playlistId) {
    openPlaylist(currentPlaylist);
  }
}

async function removeSongFromPlaylist(playlistSongId) {
  if (!confirm('¬øEliminar esta canci√≥n de la playlist?')) return;
  
  const { error } = await sb
    .from('playlist_songs')
    .delete()
    .eq('id', playlistSongId);
  
  if (error) {
    showMessage('Error eliminando canci√≥n: ' + error.message, 'error');
    return;
  }
  
  showMessage('Canci√≥n eliminada de la playlist', 'success');
  await loadPlaylists();
  
  if (currentPlaylist) {
    openPlaylist(currentPlaylist);
  }
}

async function deletePlaylistConfirm(){
  if (!currentPlaylist || !confirm('¬øEliminar esta playlist permanentemente?')) return;
  
  const { error } = await sb
    .from('playlists')
    .delete()
    .eq('id', currentPlaylist.id);
  
  if (error) {
    showMessage('Error eliminando playlist: ' + error.message, 'error');
    return;
  }
  
  showMessage('Playlist eliminada', 'success');
  closePlaylistView();
  await loadPlaylists();
}

function isValidAudioUrl(url) {
  if (!url || typeof url !== 'string') return false;
  try {
    const urlObj = new URL(url);
    return urlObj.protocol === 'https:' && url.includes('supabase');
  } catch {
    return false;
  }
}

function startQueueFromList(list, idx){ queue = list; qIndex = -1; startQueueAt(idx); }
function startQueueAt(idx){ if (!queue.length) return; qIndex = idx; playTrack(queue[qIndex]); }

function playTrack(song){
  console.log('Intentando reproducir:', song.title, song.song_url);
  
  if (!song.song_url || !isValidAudioUrl(song.song_url)) {
    showMessage(`Error: URL de audio no v√°lida para "${song.title}"`, 'error');
    nextTrack();
    return;
  }
  
  audioEl.pause();
  audioEl.currentTime = 0;
  audioEl.src = song.song_url;
  audioEl.load();
  
  npTitle.textContent = song.title;
  npAlbum.textContent = song.album_title || "‚Äî";
  npCover.src = song.cover_url || "";
  npBigTitle.textContent = song.title;
  npBigAlbum.textContent = song.album_title || "‚Äî";
  npBigCover.src = song.cover_url || "";
  
  updateCurrentFavoriteButton();
  updateCurrentDownloadButton();
  
  showPlayer();
  
  const playPromise = audioEl.play();
  if (playPromise !== undefined) {
    playPromise
      .then(() => {
        console.log('Reproducci√≥n exitosa:', song.title);
        playBtn.textContent = "‚è∏";
        playBtnBig.textContent = "‚è∏";
        toggleSoundwave(true);
        setTimeout(() => {
          npOverlay.style.display = 'flex';
        }, 500);
      })
      .catch((error) => {
        console.error('Error de reproducci√≥n:', error, song.song_url);
        showMessage(`No se puede reproducir "${song.title}". Formato o archivo inv√°lido.`, 'error');
        setTimeout(() => {
          if (queue.length > 1) {
            nextTrack();
          } else {
            hidePlayer();
          }
        }, 2000);
      });
  }
}

function updateCurrentDownloadButton() {
  const currentSong = queue[qIndex];
  if (currentSong && npDownloadBtn) {
    const isDownloaded = downloads.has(currentSong.id);
    npDownloadBtn.innerHTML = isDownloaded ? '‚úì Descargado' : 'üì• Offline';
    npDownloadBtn.classList.toggle('downloaded', isDownloaded);
  }
}

function togglePlay(){
  if (audioEl.paused){ 
    const playPromise = audioEl.play();
    if (playPromise !== undefined) {
      playPromise
        .then(() => {
          playBtn.textContent="‚è∏"; 
          playBtnBig.textContent="‚è∏"; 
          toggleSoundwave(true);
        })
        .catch((error) => {
          console.error('Error al reanudar:', error);
          showMessage('Error al reanudar reproducci√≥n', 'error');
        });
    }
  }
  else { 
    audioEl.pause(); 
    playBtn.textContent="‚ñ∂"; 
    playBtnBig.textContent="‚ñ∂"; 
    toggleSoundwave(false);
  }
}

function setVolume(v){ audioEl.volume = v; }
function seekAudio(percent){ if (!audioEl.duration || isNaN(audioEl.duration)) return; audioEl.currentTime = (percent/100) * audioEl.duration; }
function fmt(t){ if(!isFinite(t)) return "0:00"; const m=Math.floor(t/60), s=Math.floor(t%60); return `${m}:${s.toString().padStart(2,"0")}`; }

audioEl.addEventListener('loadstart', () => {
  console.log('Cargando audio...');
  npTitle.textContent = 'Cargando...';
});

audioEl.addEventListener('canplaythrough', () => {
  console.log('Audio listo para reproducir');
});

audioEl.addEventListener('error', (e) => {
  console.error('Error de audio:', e);
  const currentSong = queue[qIndex];
  if (currentSong) {
    showMessage(`Error cargando "${currentSong.title}"`, 'error');
    setTimeout(() => nextTrack(), 2000);
  }
});

audioEl.addEventListener("timeupdate",()=>{
  if (!audioEl.duration) return;
  const p = (audioEl.currentTime / audioEl.duration) * 100;
  seekEl.value = p; curTime.textContent = fmt(audioEl.currentTime); durTime.textContent = fmt(audioEl.duration);
  seekBig.value = p; curTimeBig.textContent = fmt(audioEl.currentTime); durTimeBig.textContent = fmt(audioEl.duration);
});

audioEl.addEventListener("ended",()=> nextTrack());
audioEl.addEventListener("pause",()=> toggleSoundwave(false));
audioEl.addEventListener("play",()=> toggleSoundwave(true));

function openNowPlaying(){
  npOverlay.style.display = "flex";
}
function closeNowPlaying(){ 
  npOverlay.style.display = "none"; 
}

function safeName(name){ return name.replace(/[^a-zA-Z0-9\_\-.]+/g,"-"); }

async function uploadAlbum(){
  if (!isAdmin) return alert("No autorizado");
  const title = document.getElementById("albumTitle").value.trim();
  const file = document.getElementById("albumCover").files[0];
  if (!title || !file) return alert("Completa t√≠tulo y portada");
  const path = `${Date.now()}-${safeName(file.name)}`;
  const { error: upErr } = await sb.storage.from("covers").upload(path, file);
  if (upErr) return alert("Error subiendo portada: " + upErr.message);
  const { data: pub } = sb.storage.from("covers").getPublicUrl(path);
  const cover_url = pub.publicUrl;
  const { error: insErr } = await sb.from("albums").insert([{ title, cover_url }]);
  if (insErr) return alert("Error guardando √°lbum: " + insErr.message);
  document.getElementById("albumTitle").value = "";
  document.getElementById("albumCover").value = "";
  showMessage("√Ålbum creado exitosamente", "success");
  await refreshCatalog();
}

async function uploadSong(){
  if (!isAdmin) return alert("No autorizado");
  const albumId = document.getElementById("albumSelect").value;
  const titleInput = document.getElementById("songTitle").value.trim();
  const files = document.getElementById("songFiles").files;
  if (!albumId || files.length === 0) return alert("Selecciona un √°lbum y al menos un archivo de audio");
  
  let ok = 0, fail = 0;
  for (const file of files) {
    console.log('Subiendo archivo:', file.name, 'Tipo:', file.type, 'Tama√±o:', file.size);
    
    if (!file.type.startsWith('audio/')) {
      console.error('Archivo no es audio:', file.name);
      fail++;
      continue;
    }
    
    const path = `${Date.now()}-${safeName(file.name)}`;
    const { error: upErr } = await sb.storage.from("songs").upload(path, file);
    if (upErr) { 
      console.error('Error subida:', upErr); 
      fail++; 
      continue; 
    }
    const { data: pub } = sb.storage.from("songs").getPublicUrl(path);
    const song_url = pub.publicUrl;
    console.log('URL generada:', song_url);
    
    const title = (files.length === 1 && titleInput) ? titleInput : file.name.replace(/\.[^/.]+$/, "");
    const { error: insErr } = await sb.from("songs").insert([{ album_id: albumId, title, song_url }]);
    if (insErr) { 
      console.error('Error DB:', insErr); 
      fail++; 
    } else { 
      ok++; 
    }
  }
  
  document.getElementById("songTitle").value = "";
  document.getElementById("songFiles").value = "";
  showMessage(`Subida completa: ${ok} exitosas, ${fail} error(es)`, ok > 0 ? "success" : "error");
  await refreshCatalog();
}

async function deleteAlbum(){
  if (!isAdmin) return alert("No autorizado");
  const albumId = document.getElementById("deleteAlbumSelect").value;
  if (!albumId) return alert("Selecciona un √°lbum");
  if (!confirm("¬øEliminar √°lbum y todas sus canciones?")) return;
  const { error: delSongsErr } = await sb.from("songs").delete().eq("album_id", albumId);
  if (delSongsErr) { alert("Error borrando canciones: " + delSongsErr.message); return; }
  const { error: delAlbErr } = await sb.from("albums").delete().eq("id", albumId);
  if (delAlbErr) { alert("Error borrando √°lbum: " + delAlbErr.message); return; }
  showMessage("√Ålbum eliminado exitosamente", "success");
  if (currentAlbum?.id === albumId) closeAlbumView();
  await refreshCatalog();
}
</script>
</body>
</html>
