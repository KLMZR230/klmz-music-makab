<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KLMZ Music</title>

  <!-- Appwrite SDK -->
  <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>

  <style>
    :root{
      --bg:#0e0f13; --fg:#eaeaea; --muted:#b3b3b3; --brand:#1DB954; --card:#151822; --card2:#1a1f2e; --danger:#e84545;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Arial}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:linear-gradient(180deg,#0f1117,#0d0f14 60%,transparent);position:sticky;top:0;z-index:10;border-bottom:1px solid #1e2230}
    .logo{font-weight:700}
    .user-info-section{display:flex;align-items:center;gap:8px}
    .user-menu{position:relative}
    .user-menu>button{background:transparent;color:var(--fg);border:1px solid #2a2e3d;border-radius:10px;padding:6px 10px;cursor:pointer}
    .dropdown{position:absolute;right:0;top:40px;background:var(--card);border:1px solid #2a2e3d;border-radius:12px;display:none;min-width:180px;overflow:hidden}
    .dropdown.show{display:block}
    .dropdown>div{padding:10px 12px;cursor:pointer;border-bottom:1px solid #22283a}
    .dropdown>div:last-child{border-bottom:none}
    .dropdown>div:hover{background:var(--card2)}
    main{padding:16px 16px 96px}
    .album-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:16px}
    .album-card{background:var(--card);border:1px solid #202433;border-radius:16px;padding:10px;cursor:pointer;transition:transform .12s ease, box-shadow .12s ease}
    .album-card:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .album-img{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:12px;background:#111}
    .album-title{margin-top:8px;font-weight:600}
    .album-artist{color:var(--muted);font-size:.9rem}
    .album-detail{background:var(--card);border:1px solid #202433;border-radius:16px;padding:16px}
    .song-list ul{list-style:none;margin:0;padding:0}
    .song-list li{display:flex;align-items:center;gap:12px;justify-content:space-between;padding:10px 8px;border-bottom:1px solid #1c2130}
    .song-actions{display:flex;align-items:center;gap:10px}
    .download-icon{cursor:pointer;font-size:1.1rem}
    .download-icon.downloaded{opacity:.65}
    .search-song-item,.favorite-item,.download-item{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px;border-radius:12px;background:var(--card);border:1px solid #202433;margin-bottom:8px;cursor:pointer}
    .search-song-info,.favorite-info,.download-info{display:flex;flex-direction:column}
    .search-song-title,.favorite-title,.download-title{font-weight:600}
    .search-song-artist,.favorite-artist,.download-artist{color:var(--muted);font-size:.9rem}
    .content-section{display:none}
    .content-section.active{display:block}
    .bottom-nav{position:fixed;left:0;right:0;bottom:0;background:#0c0f15;border-top:1px solid #1e2230;display:flex}
    .bottom-nav-item{flex:1;text-align:center;padding:12px 10px;cursor:pointer}
    .bottom-nav-item.active{color:var(--brand)}
    .mini-player{position:fixed;left:12px;right:12px;bottom:64px;background:var(--card);border:1px solid #202433;border-radius:16px;padding:8px;display:none;align-items:center;gap:10px}
    .mini-cover{width:44px;height:44px;border-radius:8px;object-fit:cover;background:#111}
    .player-controls-inline button{background:var(--brand);border:none;color:#000;border-radius:999px;padding:8px 12px;cursor:pointer}
    .full-player{position:fixed;inset:0;background:rgba(10,12,18,.98);backdrop-filter:blur(6px);display:none;flex-direction:column;align-items:center;padding:20px;gap:12px}
    .full-player.active{display:flex}
    .full-player img{width:260px;height:260px;border-radius:18px;object-fit:cover;background:#111;border:1px solid #22283a}
    .controls button{background:#23293c;border:1px solid #2d3650;color:var(--fg);border-radius:12px;padding:8px 12px;margin:0 6px;cursor:pointer}
    .progress-bar{width:90%;height:8px;background:#1a1f2e;border-radius:999px;overflow:hidden;cursor:pointer}
    #full-progress-fill{height:100%;width:0;background:var(--brand)}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
    .modal .modal-content{background:var(--card);border:1px solid #202433;border-radius:16px;padding:16px;min-width:280px;max-width:420px}
    .btn-primary{background:var(--brand);border:none;color:#021; padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn-secondary{background:#23293c;border:1px solid #2d3650;color:var(--fg); padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn-danger{background:var(--danger);border:none;color:#fff; padding:8px 12px;border-radius:10px;cursor:pointer}
    /* Temas */
    .theme-selector{position:fixed;right:12px;bottom:120px;background:var(--card);border:1px solid #202433;border-radius:12px;padding:8px}
    body.theme-neon{--brand:#00ffd0;--card:#101226;--card2:#14173a}
    body.theme-sunset{--brand:#ff7a59;--card:#19141a;--card2:#261b22}
    body.theme-oceanic{--brand:#34b3ff;--card:#0f151e;--card2:#122032}
    body.theme-luxury{--brand:#f0c674;--card:#12100f;--card2:#191614}
    body.theme-pastel{--brand:#b084f5;--card:#17151f;--card2:#201c2b}
    body.theme-minimal{--brand:#9ad98d;--card:#121416;--card2:#161a1d}
    input,select,button{font:inherit}
    input[type="text"],input[type="email"],input[type="password"],input[type="url"],select{width:100%;padding:10px;border-radius:10px;border:1px solid #2a3042;background:#0e121b;color:var(--fg)}
    form{display:grid;gap:10px}
    .admin-section{background:var(--card);border:1px solid #202433;border-radius:16px;padding:16px;margin-bottom:16px}
    .admin-list .admin-item{display:flex;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px solid #1c2130}
    .admin-item-actions button{margin-left:8px}
    #loading-indicator{position:fixed;right:12px;top:12px;background:var(--card);padding:8px 12px;border-radius:999px;border:1px solid #202433}
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="logo">üé∂ KLMZ Music</div>
    <div id="header-lock-icon">üîí</div>
    <div class="user-info-section" id="user-info-section" style="display:none;">
      <span id="user-email-display"></span>
      <div class="user-menu">
        <button onclick="toggleUserMenu()">‚ò∞</button>
        <div id="user-dropdown" class="dropdown">
          <div id="admin-menu-item" style="display:none;" onclick="showSection('admin')">‚öôÔ∏è Admin</div>
          <div id="login-menu-item" onclick="showAuth('login')">Iniciar Sesi√≥n</div>
          <div id="register-menu-item" onclick="showAuth('register')">Registrarse</div>
          <div id="logout-menu-item" style="display:none;" onclick="confirmLogout()">Cerrar Sesi√≥n</div>
        </div>
      </div>
    </div>
  </header>

  <!-- Seletor de tema -->
  <div class="theme-selector">
    <label style="font-size:.9rem; color:var(--muted);">Tema</label>
    <select onchange="changeTheme(this.value)">
      <option value="default">Default</option>
      <option value="neon">Ne√≥n</option>
      <option value="minimal">Minimal</option>
      <option value="sunset">Sunset</option>
      <option value="pastel">Pastel</option>
      <option value="luxury">Luxury</option>
      <option value="oceanic">Oceanic</option>
    </select>
  </div>

  <!-- Contenido principal -->
  <main>
    <!-- Home -->
    <section id="home-section" class="content-section active">
      <div id="albums" class="album-grid"></div>
      <div id="album-detail" class="album-detail" style="display:none;"></div>
    </section>

    <!-- Search -->
    <section id="search-section" class="content-section">
      <input id="search-input" type="text" placeholder="Buscar..." oninput="searchMusic()"/>
      <div id="search-results"></div>
    </section>

    <!-- Downloads -->
    <section id="downloads-section" class="content-section">
      <h2>Descargas</h2>
      <div id="downloads-content"></div>
    </section>

    <!-- Favorites -->
    <section id="favorites-section" class="content-section">
      <h2>Favoritos</h2>
      <div id="favorites-content"></div>
    </section>

    <!-- Admin -->
    <section id="admin-section" class="content-section">
      <h2>Panel de Administraci√≥n</h2>
      <div id="admin-content"></div>
    </section>
  </main>

  <!-- Player -->
  <audio id="audio-player" preload="auto"></audio>

  <div id="mini-player" class="mini-player">
    <img id="mini-player-img" class="mini-cover" src="">
    <div class="mini-info">
      <div id="mini-player-title"></div>
      <div id="mini-player-artist"></div>
    </div>
    <div class="player-controls-inline">
      <button id="mini-play-btn" onclick="togglePlay()">‚ñ∂</button>
    </div>
  </div>

  <div id="full-player" class="full-player">
    <button onclick="closeFullPlayer()">‚úñ</button>
    <img id="full-player-cover" src="">
    <div id="full-player-title"></div>
    <div id="full-player-artist"></div>
    <div class="controls">
      <button onclick="previousSong()">‚èÆ</button>
      <button id="full-play-btn" onclick="togglePlay()">‚ñ∂</button>
      <button onclick="nextSong()">‚è≠</button>
    </div>
    <div class="progress-bar" onclick="seekToFull(event)">
      <div id="full-progress-fill"></div>
    </div>
    <div>
      <span id="full-current-time">0:00</span> /
      <span id="full-total-time">0:00</span>
    </div>
    <div>
      <button id="repeat-btn" onclick="toggleRepeatMode()">üîÅ</button>
      <button id="shuffle-btn" onclick="toggleShuffleMode()">üîÄ</button>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <div id="nav-home" class="bottom-nav-item active" onclick="showSection('home')">üè†</div>
    <div id="nav-search" class="bottom-nav-item" onclick="showSection('search')">üîç</div>
    <div id="nav-downloads" class="bottom-nav-item" onclick="showSection('downloads')">‚¨á</div>
    <div id="nav-favs" class="bottom-nav-item" onclick="showSection('favorites')">‚ù§Ô∏è</div>
  </nav>

  <!-- Auth Modal -->
  <div id="auth-modal" class="modal">
    <div class="modal-content">
      <div id="login-form">
        <h3>Iniciar Sesi√≥n</h3>
        <form onsubmit="login(event)">
          <input id="login-email" type="email" placeholder="Email" required>
          <input id="login-password" type="password" placeholder="Contrase√±a" required>
          <button type="submit" class="btn-primary">Entrar</button>
        </form>
      </div>
      <div id="register-form" style="display:none;">
        <h3>Registro</h3>
        <form onsubmit="register(event)">
          <input id="register-email" type="email" placeholder="Email" required>
          <input id="register-password" type="password" placeholder="Contrase√±a" required>
          <input id="register-confirm" type="password" placeholder="Repite contrase√±a" required>
          <button type="submit" class="btn-primary">Registrar</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div id="loading-indicator" style="display:none;">Cargando...</div>

  <!-- =========================  APP SCRIPT (ONE FILE)  ========================= -->
  <script type="module">
    // ============================
    // 0) ESTADO GLOBAL / CONFIG
    // ============================
    let supabase = null;
    let appwriteClient = null;
    let appwriteDatabases = null;
    let appwriteStorage = null;

    let currentSong = null;
    let currentAlbum = null;
    let currentPlaylist = [];
    let currentIndex = 0;
    let isPlaying = false;
    let allAlbums = [];
    let allSongs = []; // canciones (metadatos) desde Supabase
    let currentUser = null;
    let songsWithAlbumInfo = [];
    let repeatMode = 'off';
    let shuffleMode = false;
    let originalPlaylist = [];

    // IndexedDB para descargas
    let db;

    // --- Supabase ---
    const SUPABASE_URL = 'https://nqbldvpnqhngdtalvzov.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xYmxkdnBucWhuZ2R0YWx2em92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyMjY0NjUsImV4cCI6MjA3MDgwMjQ2NX0.Zzg5D219sW7bhvl0_R5ypX9MF6nRzBSDIeo2Lvebab0';
    const ADMIN_EMAIL = 'klmzr@gmail.com';

    // --- Appwrite ---
    const APPWRITE_ENDPOINT = 'https://nyc.cloud.appwrite.io/v1';
    const APPWRITE_PROJECT_ID = '68ab0cf2000365979a71';
    const APPWRITE_SONGS_BUCKET_ID = '68ab1101001cff947e6b';

    // ============================
    // 1) INDEXEDDB (Descargas)
    // ============================
    function initDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open('KLMZMusicDB', 2);
        request.onerror = () => reject('Error al abrir IndexedDB');
        request.onsuccess = (event) => { db = event.target.result; resolve(db); };
        request.onupgradeneeded = (event) => {
          const _db = event.target.result;
          if (!_db.objectStoreNames.contains('songs')) {
            _db.createObjectStore('songs', { keyPath: 'id' });
          }
        };
      });
    }
    function saveSongToDB(songData) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(['songs'], 'readwrite');
        tx.objectStore('songs').put(songData).onsuccess = () => resolve();
        tx.onerror = (e) => reject('Error al guardar la canci√≥n: ' + e.target.error);
      });
    }
    function getSongFromDB(songId) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(['songs'], 'readonly');
        tx.objectStore('songs').get(songId).onsuccess = (e) => resolve(e.target.result);
        tx.onerror = (e) => reject('Error al obtener la canci√≥n: ' + e.target.error);
      });
    }
    function getAllDownloadedSongs() {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(['songs'], 'readonly');
        tx.objectStore('songs').getAll().onsuccess = (e) => resolve(e.target.result);
        tx.onerror = (e) => reject('Error al obtener todas las canciones: ' + e.target.error);
      });
    }

    // ============================
    // 2) THEMES
    // ============================
    window.changeTheme = function(theme) {
      const body = document.body;
      body.classList.remove('theme-neon', 'theme-minimal', 'theme-sunset', 'theme-pastel', 'theme-luxury', 'theme-oceanic');
      if (theme && theme !== 'default') body.classList.add('theme-' + theme);
      localStorage.setItem('klmz_theme', theme);
    }
    function loadSavedTheme() {
      const savedTheme = localStorage.getItem('klmz_theme') || 'default';
      document.querySelector('.theme-selector select').value = savedTheme;
      changeTheme(savedTheme);
    }

    // ============================
    // 3) FAVORITOS (localStorage)
    // ============================
    const getLocalFavorites = () => JSON.parse(localStorage.getItem('klmz_favorites') || '[]');
    const saveLocalFavorites = (favs) => localStorage.setItem('klmz_favorites', JSON.stringify(favs));
    window.toggleFavorite = function(songId, el) {
      let favorites = getLocalFavorites();
      const isFavorite = favorites.includes(songId);
      if (isFavorite) favorites = favorites.filter(id => id !== songId);
      else favorites.push(songId);
      saveLocalFavorites(favorites);
      if (el) {
        el.style.color = isFavorite ? '#666' : '#1DB954';
        el.innerHTML = isFavorite ? 'ü§ç' : '‚ù§Ô∏è';
      }
      if (document.getElementById('favorites-section').classList.contains('active')) loadFavorites();
    }
    async function loadFavorites() {
      const content = document.getElementById('favorites-content');
      const favorites = getLocalFavorites();
      if (favorites.length === 0) {
        content.innerHTML = `<div style="text-align:center;padding:3rem;"><h2>No tienes favoritos</h2></div>`;
        return;
      }
      try {
        // songs est√°n en Supabase
        let { data: songs, error } = await supabase.from('songs').select('*').in('id', favorites);
        if (error) throw error;

        const withAlbum = songs.map(song => {
          const album = allAlbums.find(a => a.id === song.album_id);
          return { ...song, albums: album };
        });
        let html = '<div class="favorites-list">';
        withAlbum.forEach(song => {
          html += `
            <div class="favorite-item" onclick="playSongFromFavorites('${song.id}')">
              <div class="favorite-info">
                <div class="favorite-title">${song.title}</div>
                <div class="favorite-artist">${song.albums?.artist || 'Desconocido'} ‚Ä¢ ${song.albums?.title || ''}</div>
              </div>
              <div class="song-actions">
                <span onclick="event.stopPropagation(); toggleFavorite('${song.id}', this);" style="cursor:pointer;color:#1DB954;font-size:1.2rem;">‚ù§Ô∏è</span>
                <span style="font-size:1.1rem;">‚ñ∂</span>
              </div>
            </div>`;
        });
        content.innerHTML = html + '</div>';
      } catch (err) {
        console.error('Error cargando favoritos:', err);
        content.innerHTML = `Error cargando favoritos.`;
      }
    }
    window.playSongFromFavorites = function(songId) {
      const song = songsWithAlbumInfo.find(s => s.id === songId);
      if (song) playSong(song, song.albums, [song], 0);
    }

    // ============================
    // 4) NAVEGACI√ìN / B√öSQUEDA
    // ============================
    window.showSection = function(section) {
      document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
      document.getElementById(`${section}-section`).classList.add('active');
      document.querySelectorAll('.bottom-nav-item').forEach(a => a.classList.remove('active'));
      const navIdMap = { home:'home', search:'search', downloads:'downloads', favorites:'favs', admin: 'home' };
      const navItem = document.getElementById(`nav-${navIdMap[section]}`);
      if (navItem) navItem.classList.add('active');

      if (section === 'home') showAlbumsGrid();
      if (section === 'favorites') loadFavorites();
      if (section === 'downloads') loadDownloads();
      if (section === 'admin') {
        if (!isAdmin()) {
          showInfoModal('Acceso denegado. Solo para administradores.');
          showSection('home');
          return;
        }
        renderAdminPanel();
      }
    }
    window.showAlbumsGrid = function() {
      document.getElementById('album-detail').style.display = 'none';
      document.getElementById('albums').style.display = 'grid';
    }
    window.searchMusic = function() {
      const q = document.getElementById('search-input').value.toLowerCase().trim();
      const results = document.getElementById('search-results');
      if (!q) { results.innerHTML = ''; return; }
      const foundAlbums = allAlbums.filter(a => a.title.toLowerCase().includes(q) || a.artist.toLowerCase().includes(q));
      const foundSongs  = songsWithAlbumInfo.filter(s => s.title.toLowerCase().includes(q) || (s.albums && s.albums.artist.toLowerCase().includes(q)));
      let html = '';
      if (foundAlbums.length) {
        html += '<h3>üìÄ √Ålbumes</h3><div class="album-grid">' + foundAlbums.map(album => `
          <div class="album-card" onclick='showAlbumDetail(${JSON.stringify(album).replace(/"/g,'&quot;')})'>
            <img class="album-img" src="${album.cover_url}"><div class="album-title">${album.title}</div><div class="album-artist">${album.artist}</div>
          </div>`).join('') + '</div>';
      }
      if (foundSongs.length) {
        html += '<h3>üéµ Canciones</h3>' + foundSongs.map(song => `
          <div class="search-song-item" onclick="playSongFromSearch('${song.id}')">
            <div class="search-song-info">
              <div class="search-song-title">${song.title}</div>
              <div class="search-song-artist">${song.albums?.artist || 'Desconocido'}</div>
            </div>
            <div style="font-size:1.1rem;">‚ñ∂</div>
          </div>`).join('');
      }
      results.innerHTML = (html || '<h3>No se encontraron resultados</h3>');
    }
    window.playSongFromSearch = function(songId) {
      const song = songsWithAlbumInfo.find(s => s.id === songId);
      if (song) playSong(song, song.albums, [song], 0);
    }

    // ============================
    // 5) UI Helpers / Modales
    // ============================
    function showLoadingIndicator(show){ document.getElementById('loading-indicator').style.display = show ? 'block' : 'none'; }
    function showErrorMessage(message){
      document.getElementById('albums').innerHTML = `
        <div style="text-align:center;padding:3rem;">
          <h2>${message}</h2>
          <p>Puedes acceder a tu m√∫sica descargada.</p>
          <button onclick="showSection('downloads')" class="btn-primary" style="margin-top:1rem;">Ir a Descargas</button>
        </div>`;
    }
    function showInfoModal(message) {
      const existing = document.getElementById('info-modal-backdrop');
      if (existing) return;
      const modalBackdrop = document.createElement('div'); modalBackdrop.id='info-modal-backdrop'; modalBackdrop.className='modal'; modalBackdrop.style.display='flex';
      const modalContent = document.createElement('div'); modalContent.className='modal-content';
      const p = document.createElement('p'); p.textContent = message; p.style.marginBottom='1.5rem'; p.style.textAlign='center'; p.style.fontSize='1.1rem';
      const ok = document.createElement('button'); ok.textContent='OK'; ok.className='btn-primary'; ok.onclick = ()=>document.body.removeChild(modalBackdrop);
      modalContent.appendChild(p); modalContent.appendChild(ok); modalBackdrop.appendChild(modalContent); document.body.appendChild(modalBackdrop);
    }
    function showConfirmationModal(message, onConfirm){
      const existing = document.getElementById('confirm-modal-backdrop'); if (existing) return;
      const m = document.createElement('div'); m.id='confirm-modal-backdrop'; m.className='modal'; m.style.display='flex';
      const c = document.createElement('div'); c.className='modal-content';
      const p = document.createElement('p'); p.textContent = message; p.style.marginBottom='1.5rem'; p.style.textAlign='center'; p.style.fontSize='1.1rem';
      const row = document.createElement('div'); row.style.display='flex'; row.style.gap='1rem'; row.style.justifyContent='center';
      const yes = document.createElement('button'); yes.textContent='Confirmar'; yes.className='btn-danger'; yes.style.width='auto';
      yes.onclick = ()=>{ onConfirm(); document.body.removeChild(m); };
      const no = document.createElement('button'); no.textContent='Cancelar'; no.className='btn-secondary'; no.style.width='auto';
      no.onclick = ()=>document.body.removeChild(m);
      row.appendChild(no); row.appendChild(yes); c.appendChild(p); c.appendChild(row); m.appendChild(c); document.body.appendChild(m);
    }

    // ============================
    // 6) SUPABASE + APPWRITE INIT
    // ============================
    async function initServices(){
      // Supabase (ESM)
      const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
      supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

      // Appwrite
      appwriteClient = new Appwrite.Client();
      appwriteClient.setEndpoint(APPWRITE_ENDPOINT).setProject(APPWRITE_PROJECT_ID);
      appwriteStorage = new Appwrite.Storage(appwriteClient);

      // Sesi√≥n / auth
      supabase.auth.onAuthStateChange((event, session) => {
        currentUser = session?.user || null; updateAuthUI();
      });
      const { data:{ session } } = await supabase.auth.getSession();
      currentUser = session?.user || null; updateAuthUI();
    }

    // ============================
    // 7) CARGA DE DATOS (Supabase)
    // ============================
    async function loadAllData(){
      try{
        showLoadingIndicator(true);
        const [{ data: albums, error: albumsError }, { data: songs, error: songsError }] = await Promise.all([
          supabase.from('albums').select('*').order('title', { ascending: true }),
          supabase.from('songs').select('*').order('title', { ascending: true })
        ]);
        if (albumsError) throw albumsError;
        if (songsError) throw songsError;

        allAlbums = albums || [];
        allSongs  = songs  || [];

        songsWithAlbumInfo = allSongs.map(song => {
          const album = allAlbums.find(a => a.id === song.album_id);
          return { ...song, albums: album };
        });

        displayAlbums(allAlbums);
      } catch(err){
        console.error('Error cargando datos:', err);
        showErrorMessage('No se pudieron cargar los √°lbumes');
      } finally { showLoadingIndicator(false); }
    }

    function displayAlbums(albums){
      const container = document.getElementById('albums');
      if (!albums || albums.length === 0) {
        container.innerHTML = '<h2>No hay √°lbumes disponibles</h2>'; return;
      }
      container.innerHTML = albums.map(album => `
        <div class="album-card" onclick='showAlbumDetail(${JSON.stringify(album).replace(/"/g,'&quot;')})'>
          <img class="album-img" src="${album.cover_url}" alt="${album.title}" loading="lazy">
          <div class="album-title">${album.title}</div>
          <div class="album-artist">${album.artist}</div>
        </div>`).join('');
    }

    // ============================
    // 8) DETALLE DE √ÅLBUM (Canciones Supabase + audio Appwrite)
    // ============================
    async function showAlbumDetail(album){
      currentAlbum = album;
      document.getElementById('albums').style.display = 'none';
      const detailView = document.getElementById('album-detail');
      detailView.style.display = 'block';
      detailView.innerHTML = `
        <button class="btn-secondary" onclick="showAlbumsGrid()">‚üµ Volver</button>
        <div style="text-align:center;margin:1rem 0 2rem;">
          <img class="album-img" src="${album.cover_url}" style="width:200px;height:200px;display:block;margin:0 auto 1rem;">
          <div class="album-title" style="font-size:1.5rem;">${album.title}</div>
          <div class="album-artist" style="font-size:1.1rem;color:#b3b3b3;">${album.artist}</div>
        </div>
        <div class="song-list" id="detail-song-list">Cargando...</div>
      `;

      try{
        const { data: songs, error } = await supabase.from('songs').select('*').eq('album_id', album.id).order('title');
        if (error) throw error;

        const listDiv = document.getElementById('detail-song-list');
        if (!songs || songs.length === 0) { listDiv.innerHTML = 'No hay canciones en este √°lbum.'; return; }

        currentPlaylist = songs;
        originalPlaylist = [...songs];

        const favorites = getLocalFavorites();
        const downloaded = await getAllDownloadedSongs();
        const downloadedIds = downloaded.map(s => s.id);

        listDiv.innerHTML = '<ul>' + songs.map((song, idx) => `
          <li>
            <div onclick="playSongFromPlaylist(${idx})" style="flex:1;">${song.title}</div>
            <div class="song-actions">
              <span onclick="toggleFavorite('${song.id}', this); event.stopPropagation();" style="cursor:pointer;color:${favorites.includes(song.id)?'#1DB954':'#666'};">${favorites.includes(song.id)?'‚ù§Ô∏è':'ü§ç'}</span>
              <span class="download-icon ${downloadedIds.includes(song.id)?'downloaded':''}" onclick="event.stopPropagation(); downloadSong('${song.id}', this)">‚Üì</span>
              <span class="play-icon" onclick="playSongFromPlaylist(${idx})">‚ñ∂</span>
            </div>
          </li>`).join('') + '</ul>';
      }catch(err){
        console.error('Error al cargar canciones del √°lbum:', err);
        const listDiv = document.getElementById('detail-song-list');
        listDiv.innerHTML = 'Error al cargar las canciones.';
      }
    }
    window.showAlbumDetail = showAlbumDetail;

    // ============================
    // 9) REPRODUCTOR
    // ============================
    window.playSongFromPlaylist = function(index){
      playSong(currentPlaylist[index], currentAlbum, currentPlaylist, index);
    }
    window.playSongFromSearch = function(id){
      const song = songsWithAlbumInfo.find(s => s.id === id);
      if (song) playSong(song, song.albums, [song], 0);
    }
    async function updateMiniPlayer(){
      if (!currentSong) return;
      document.getElementById('mini-player').style.display = 'flex';
      const downloadedSong = await getSongFromDB(currentSong.id).catch(()=>null);
      let coverUrl = currentAlbum?.cover_url || '';
      if (downloadedSong && downloadedSong.cover) coverUrl = URL.createObjectURL(downloadedSong.cover);
      document.getElementById('mini-player-img').src = coverUrl;
      document.getElementById('mini-player-title').textContent = currentSong?.title || 'Sin t√≠tulo';
      document.getElementById('mini-player-artist').textContent = currentAlbum?.artist || 'Desconocido';
    }
    async function updateFullPlayer(){
      if (!currentSong) return;
      const downloadedSong = await getSongFromDB(currentSong.id).catch(()=>null);
      let coverUrl = currentAlbum?.cover_url || '';
      if (downloadedSong && downloadedSong.cover) coverUrl = URL.createObjectURL(downloadedSong.cover);
      document.getElementById('full-player-cover').src = coverUrl;
      document.getElementById('full-player-title').textContent = currentSong?.title || 'Sin t√≠tulo';
      document.getElementById('full-player-artist').textContent = currentAlbum?.artist || 'Desconocido';
    }
    function updatePlayButtons(){
      const text = isPlaying ? '‚è∏' : '‚ñ∂';
      ['mini-play-btn','full-play-btn'].forEach(id => { const b=document.getElementById(id); if (b) b.textContent=text; });
    }
    function updateAllPlayers(){ updateMiniPlayer(); updateFullPlayer(); updatePlayButtons(); }

    window.togglePlay = function(){
      const audio = document.getElementById('audio-player');
      if (isPlaying) audio.pause(); else audio.play();
    }
    window.nextSong = function(){
      if (currentPlaylist.length === 0) return;
      currentIndex = (currentIndex + 1) % currentPlaylist.length;
      playSong(currentPlaylist[currentIndex], currentAlbum, currentPlaylist, currentIndex);
    }
    window.previousSong = function(){
      if (currentPlaylist.length === 0) return;
      currentIndex = (currentIndex > 0) ? currentIndex - 1 : currentPlaylist.length - 1;
      playSong(currentPlaylist[currentIndex], currentAlbum, currentPlaylist, currentIndex);
    }
    function handleSongEnded(){
      if (repeatMode === 'all' || currentIndex < currentPlaylist.length - 1) nextSong();
      else { isPlaying=false; updatePlayButtons(); }
    }
    window.setVolume = (value)=>{ document.getElementById('audio-player').volume = value/100; }
    function updateProgressBar(){
      const audio = document.getElementById('audio-player');
      if (!audio.duration) return;
      const progress = (audio.currentTime / audio.duration) * 100;
      document.getElementById('full-progress-fill').style.width = `${progress}%`;
      document.getElementById('full-current-time').textContent = formatTime(audio.currentTime);
      document.getElementById('full-total-time').textContent = formatTime(audio.duration);
    }
    function formatTime(seconds){
      const min = Math.floor(seconds/60);
      const sec = Math.floor(seconds%60).toString().padStart(2,'0');
      return `${min}:${sec}`;
    }
    window.seekToFull = (event)=>{
      const audio = document.getElementById('audio-player');
      const rect = event.currentTarget.getBoundingClientRect();
      audio.currentTime = ((event.clientX - rect.left) / rect.width) * (audio.duration || 0);
    }
    function openFullPlayer(){ document.getElementById('full-player').classList.add('active'); }
    window.closeFullPlayer = function(){ document.getElementById('full-player').classList.remove('active'); }
    window.toggleRepeatMode = function(){
      repeatMode = (repeatMode === 'all') ? 'off' : 'all';
      updateModeButtonsUI();
    }
    window.toggleShuffleMode = function(){
      shuffleMode = !shuffleMode;
      updateModeButtonsUI();
    }
    function updateModeButtonsUI(){
      document.getElementById('repeat-btn').classList.toggle('active', repeatMode==='all');
      document.getElementById('shuffle-btn').classList.toggle('active', shuffleMode);
    }

    // Core: reproducir (preferir descargada -> si no, Appwrite)
    window.playSong = async function(song, album, playlist=[song], index=0){
      currentSong = song; currentAlbum = album; currentPlaylist = playlist; currentIndex = index;
      const audio = document.getElementById('audio-player');
      audio.pause(); updateAllPlayers();

      const onCanPlay = () => {
        audio.play().catch(err => {
          console.error('Error al reproducir:', err);
          if (err.name !== 'AbortError') showInfoModal('No se pudo reproducir la canci√≥n.');
        });
        audio.removeEventListener('canplay', onCanPlay);
      };
      audio.addEventListener('canplay', onCanPlay);

      try{
        const cached = await getSongFromDB(song.id);
        if (cached && cached.audio) {
          const audioURL = URL.createObjectURL(cached.audio);
          audio.src = audioURL;
        } else {
          // archivo en Appwrite Storage (file_id en Supabase.songs)
          const fileUrl = appwriteStorage.getFileDownload(APPWRITE_SONGS_BUCKET_ID, song.file_id);
          audio.src = fileUrl;
        }
      }catch(e){
        console.error('Fallo DB local, cargando desde red:', e);
        const fileUrl = appwriteStorage.getFileDownload(APPWRITE_SONGS_BUCKET_ID, song.file_id);
        audio.src = fileUrl;
      }
      audio.load();
    }

    // ============================
    // 10) DESCARGAS (guardar audio Appwrite + cover Supabase en IndexedDB)
    // ============================
    window.downloadSong = async function(songId, element){
      if (element.classList.contains('downloaded')) { showInfoModal('Esta canci√≥n ya est√° descargada.'); return; }
      try{
        const song = allSongs.find(s => s.id === songId);
        if (!song) throw new Error('Canci√≥n no encontrada');

        element.textContent = '...';

        // URL de audio (Appwrite)
        const audioUrl = appwriteStorage.getFileDownload(APPWRITE_SONGS_BUCKET_ID, song.file_id);
        // Portada (desde √°lbum en Supabase)
        const album = allAlbums.find(a => a.id === song.album_id);
        const coverUrl = album ? album.cover_url : '';

        const audioResponse = await fetch(audioUrl);
        if (!audioResponse.ok) throw new Error('Error en la red al descargar audio');
        const audioBlob = await audioResponse.blob();

        let coverBlob = null;
        if (coverUrl) {
          const coverResponse = await fetch(coverUrl);
          coverBlob = await coverResponse.blob();
        }

        const songData = {
          id: song.id,
          metadata: { ...song, albums: album },
          audio: audioBlob,
          cover: coverBlob
        };

        await saveSongToDB(songData);
        showInfoModal(`${song.title} descargada con √©xito.`);
        element.textContent = '‚Üì';
        element.classList.add('downloaded');
      }catch(err){
        console.error('Error al descargar:', err);
        showInfoModal('No se pudo descargar la canci√≥n.');
        element.textContent = '‚Üì';
      }
    }
    async function loadDownloads(){
      const content = document.getElementById('downloads-content');
      try{
        const downloadedSongs = await getAllDownloadedSongs();
        if (!downloadedSongs.length) {
          content.innerHTML = `<div style="text-align:center;padding:2rem;">No tienes canciones descargadas</div>`; return;
        }
        let html = '<div class="downloads-list">';
        downloadedSongs.forEach(item => {
          const song = item.metadata;
          html += `
            <div class="download-item" onclick="playDownloadedSong('${song.id}')">
              <div class="download-info">
                <div class="download-title">${song.title}</div>
                <div class="download-artist">${song.albums?.artist || ''} ‚Ä¢ ${song.albums?.title || ''}</div>
              </div>
              <span style="font-size:1.1rem;">‚ñ∂</span>
            </div>`;
        });
        html += '</div>'; content.innerHTML = html;
      }catch(err){
        console.error(err);
        content.innerHTML = 'Error al cargar las descargas.';
      }
    }
    window.playDownloadedSong = async (songId)=>{
      const songData = await getSongFromDB(songId);
      if (songData) {
        currentPlaylist = [songData.metadata];
        currentIndex = 0;
        playSong(songData.metadata, songData.metadata.albums);
      }
    }

    // ============================
    // 11) USER MENU / AUTH (Supabase)
    // ============================
    window.toggleUserMenu = function(){
      const dropdown = document.getElementById('user-dropdown');
      dropdown.classList.toggle('show');
      if (dropdown.classList.contains('show')) setTimeout(()=>document.addEventListener('click', closeUserMenuOutside), 100);
    }
    function closeUserMenuOutside(e){
      const userMenu = document.querySelector('.user-menu');
      if (!userMenu.contains(e.target)) {
        document.getElementById('user-dropdown').classList.remove('show');
        document.removeEventListener('click', closeUserMenuOutside);
      }
    }
    function updateAuthUI(){
      const [headerLockIcon, userInfo, userEmail, adminMenu, loginMenu, registerMenu, logoutMenu] = [
        'header-lock-icon', 'user-info-section', 'user-email-display', 'admin-menu-item',
        'login-menu-item', 'register-menu-item', 'logout-menu-item'
      ].map(id => document.getElementById(id));
      if (currentUser) {
        userInfo.style.display = 'flex';
        userEmail.textContent = currentUser.email;
        loginMenu.style.display = 'none';
        registerMenu.style.display = 'none';
        logoutMenu.style.display = 'block';
        if (isAdmin()) { headerLockIcon.innerHTML='‚öôÔ∏è'; adminMenu.style.display='block'; }
        else { headerLockIcon.innerHTML='üë§'; adminMenu.style.display='none'; }
      } else {
        headerLockIcon.innerHTML='üîí';
        userInfo.style.display='none';
        adminMenu.style.display='none';
        loginMenu.style.display = 'block';
        registerMenu.style.display = 'block';
        logoutMenu.style.display = 'none';
      }
    }
    function isAdmin(){ return currentUser && currentUser.email === ADMIN_EMAIL; }
    window.showAuth = function(type){
      document.getElementById('user-dropdown').classList.remove('show');
      document.getElementById('login-form').style.display = (type === 'login') ? 'block' : 'none';
      document.getElementById('register-form').style.display = (type === 'register') ? 'block' : 'none';
      document.getElementById('auth-modal').style.display = 'flex';
    }
    window.closeAuth = function(){ document.getElementById('auth-modal').style.display = 'none'; }
    window.login = async function(e){
      e.preventDefault();
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      try{
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) throw error;
        showInfoModal('¬°Bienvenido!');
        closeAuth();
      }catch(err){ showInfoModal('Error de login: ' + err.message); }
    }
    window.register = async function(e){
      e.preventDefault();
      const email = document.getElementById('register-email').value;
      const password = document.getElementById('register-password').value;
      if (password !== document.getElementById('register-confirm').value) return showInfoModal('Las contrase√±as no coinciden');
      try{
        const { error } = await supabase.auth.signUp({ email, password });
        if (error) throw error;
        showInfoModal('Registro exitoso. Revisa tu correo.');
        closeAuth();
      }catch(err){ showInfoModal('Error de registro: ' + err.message); }
    }
    function confirmLogout(){ showConfirmationModal('¬øEst√°s seguro de que quieres cerrar sesi√≥n?', logout); }
    async function logout(){
      try{
        const { error } = await supabase.auth.signOut();
        if (error) throw error;
        currentUser = null; updateAuthUI();
        showInfoModal('Sesi√≥n cerrada correctamente');
      }catch(err){
        console.error('Error logout:', err);
        showInfoModal('Error cerrando sesi√≥n');
      }
    }

    // ============================
    // 12) ADMIN PANEL (√Ålbumes: Supabase | Canciones: archivo Appwrite + fila Supabase)
    // ============================
    async function renderAdminPanel(){
      const adminContent = document.getElementById('admin-content');
      adminContent.innerHTML = `
        <div class="admin-section">
          <h4>Gesti√≥n de √Ålbumes (Supabase)</h4>
          <form id="album-form" class="admin-form">
            <input type="hidden" id="album-id">
            <div class="form-group"><label>T√≠tulo:</label><input type="text" id="album-title" required></div>
            <div class="form-group"><label>Artista:</label><input type="text" id="album-artist" required></div>
            <div class="form-group"><label>URL Portada:</label><input type="url" id="album-cover" required></div>
            <button type="submit" class="btn-primary">Guardar √Ålbum</button>
            <button type="button" id="cancel-album-edit" class="btn-secondary" style="display:none;margin-top:.5rem;">Cancelar Edici√≥n</button>
          </form>
          <div id="admin-album-list" class="admin-list">Cargando √°lbumes...</div>
        </div>

        <div class="admin-section">
          <h4>Gesti√≥n de Canciones (Archivo: Appwrite | Metadatos: Supabase)</h4>
          <form id="song-form" class="admin-form">
            <input type="hidden" id="song-id">
            <div class="form-group"><label>T√≠tulo:</label><input type="text" id="song-title" required></div>
            <div class="form-group"><label>Archivo de Canci√≥n:</label><input type="file" id="song-file" accept="audio/*"></div>
            <div class="form-group"><label>√Ålbum:</label><select id="song-album-select" required></select></div>
            <button type="submit" class="btn-primary">Subir/Guardar Canci√≥n</button>
            <button type="button" id="cancel-song-edit" class="btn-secondary" style="display:none;margin-top:.5rem;">Cancelar Edici√≥n</button>
          </form>
          <div id="admin-song-list" class="admin-list">Cargando canciones...</div>
        </div>
      `;
      await renderAdminLists();
      setupAdminForms();
    }

    async function renderAdminLists(){
      const [{ data: albums }, { data: songs }] = await Promise.all([
        supabase.from('albums').select('*').order('title'),
        supabase.from('songs').select('*').order('title')
      ]);

      allAlbums = albums || [];
      allSongs = songs || [];

      const albumList = document.getElementById('admin-album-list');
      albumList.innerHTML = allAlbums.map(album => `
        <div class="admin-item">
          <div class="admin-item-info"><strong>${album.title}</strong><br><small>${album.artist}</small></div>
          <div class="admin-item-actions">
            <button class="btn-secondary" onclick="editAlbum('${album.id}', '${album.title.replace(/'/g,"\\'")}', '${album.artist.replace(/'/g,"\\'")}', '${(album.cover_url||'').replace(/'/g,"\\'")}')">Editar</button>
            <button class="btn-danger" onclick="deleteAlbum('${album.id}')">Borrar</button>
          </div>
        </div>`).join('');

      const songList = document.getElementById('admin-song-list');
      const songsWithAlbumInfoAdmin = allSongs.map(song => {
        const album = allAlbums.find(a => a.id === song.album_id);
        return { ...song, albums: album };
      });
      songList.innerHTML = songsWithAlbumInfoAdmin.map(song => `
        <div class="admin-item">
          <div class="admin-item-info"><strong>${song.title}</strong><br><small>${song.albums?.title || 'Sin √°lbum'}</small></div>
          <div class="admin-item-actions">
            <button class="btn-secondary" onclick="editSong('${song.id}','${song.title.replace(/'/g,"\\'")}','${song.album_id}','${song.file_id||''}')">Editar</button>
            <button class="btn-danger" onclick="deleteSong('${song.id}')">Borrar</button>
          </div>
        </div>`).join('');

      const albumSelect = document.getElementById('song-album-select');
      albumSelect.innerHTML = `<option value="">-- Seleccionar √Ålbum --</option>` + allAlbums.map(a => `<option value="${a.id}">${a.title}</option>`).join('');
    }

    function setupAdminForms(){
      const albumForm = document.getElementById('album-form');
      albumForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const id = document.getElementById('album-id').value;
        const title = document.getElementById('album-title').value;
        const artist = document.getElementById('album-artist').value;
        const cover_url = document.getElementById('album-cover').value;

        showLoadingIndicator(true);
        const { error } = id
          ? await supabase.from('albums').update({ title, artist, cover_url }).eq('id', id)
          : await supabase.from('albums').insert([{ title, artist, cover_url }]);
        showLoadingIndicator(false);
        if (error) showInfoModal('Error guardando √°lbum: ' + error.message);
        else {
          showInfoModal('√Ålbum guardado con √©xito.');
          albumForm.reset(); document.getElementById('album-id').value=''; document.getElementById('cancel-album-edit').style.display='none';
          await loadAllData(); await renderAdminLists();
        }
      });
      document.getElementById('cancel-album-edit').addEventListener('click', ()=>{
        albumForm.reset(); document.getElementById('album-id').value=''; document.getElementById('cancel-album-edit').style.display='none';
      });

      const songForm = document.getElementById('song-form');
      songForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const id = document.getElementById('song-id').value;
        const title = document.getElementById('song-title').value;
        const album_id = document.getElementById('song-album-select').value;
        const song_file = document.getElementById('song-file').files[0];

        if (!album_id) { showInfoModal('Selecciona un √°lbum.'); return; }

        showLoadingIndicator(true);
        try{
          let file_id = null;

          if (song_file) {
            // 1) Subir archivo a Appwrite
            const uploadedFile = await appwriteStorage.createFile(
              APPWRITE_SONGS_BUCKET_ID,
              Appwrite.ID.unique(),
              song_file
            );
            file_id = uploadedFile.$id;
          }

          if (id) {
            // Update metadatos en Supabase
            const payload = { title, album_id };
            if (file_id) payload.file_id = file_id;
            const { error } = await supabase.from('songs').update(payload).eq('id', id);
            if (error) throw error;
          } else {
            if (!file_id) { showInfoModal('Selecciona un archivo de audio.'); showLoadingIndicator(false); return; }
            // 2) Insert en Supabase (metadatos + file_id)
            const { error } = await supabase.from('songs').insert([{ title, album_id, file_id }]);
            if (error) throw error;
          }

          showInfoModal('Canci√≥n guardada con √©xito.');
          songForm.reset(); document.getElementById('song-id').value=''; document.getElementById('cancel-song-edit').style.display='none';
          await loadAllData(); await renderAdminLists();
        }catch(err){
          console.error(err);
          showInfoModal('Error guardando canci√≥n: ' + err.message);
        }finally{ showLoadingIndicator(false); }
      });
      document.getElementById('cancel-song-edit').addEventListener('click', ()=>{
        songForm.reset(); document.getElementById('song-id').value=''; document.getElementById('cancel-song-edit').style.display='none';
      });
    }

    window.editAlbum = (id,title,artist,cover_url)=>{
      document.getElementById('album-id').value = id;
      document.getElementById('album-title').value = title;
      document.getElementById('album-artist').value = artist;
      document.getElementById('album-cover').value = cover_url;
      document.getElementById('cancel-album-edit').style.display = 'inline-block';
      document.getElementById('album-form').scrollIntoView({behavior:'smooth'});
    }

    window.deleteAlbum = (id)=>{
      showConfirmationModal(
        '¬øSeguro que quieres borrar este √°lbum? Esto tambi√©n borrar√° sus canciones (metadatos) en Supabase.',
        async ()=>{
          showLoadingIndicator(true);
          try{
            // Borrar canciones (metadatos) vinculadas
            const { data: songsToDelete } = await supabase.from('songs').select('id,file_id').eq('album_id', id);
            // (Opcional) Si quieres tambi√©n borrar archivos de Appwrite:
            // await Promise.all((songsToDelete||[]).map(s => appwriteStorage.deleteFile(APPWRITE_SONGS_BUCKET_ID, s.file_id).catch(()=>{})));
            const { error } = await supabase.from('albums').delete().eq('id', id);
            if (error) throw error;
            showInfoModal('√Ålbum borrado con √©xito.');
            await loadAllData(); await renderAdminLists();
          }catch(err){
            showInfoModal('Error borrando √°lbum: ' + err.message);
          }finally{ showLoadingIndicator(false); }
        }
      );
    }

    window.editSong = (id,title,album_id,file_id)=>{
      document.getElementById('song-id').value = id;
      document.getElementById('song-title').value = title;
      document.getElementById('song-album-select').value = album_id;
      document.getElementById('cancel-song-edit').style.display = 'inline-block';
      showInfoModal("Puedes cambiar t√≠tulo/√°lbum. Para reemplazar audio, selecciona un nuevo archivo y guarda.");
    }

    window.deleteSong = (songId)=>{
      showConfirmationModal(
        '¬øSeguro que quieres borrar esta canci√≥n?',
        async ()=>{
          showLoadingIndicator(true);
          try{
            // Obtener file_id para borrar archivo si quieres
            const { data, error } = await supabase.from('songs').select('file_id').eq('id', songId).single();
            if (error) throw error;

            // (Opcional) borrar el archivo del bucket:
            // await appwriteStorage.deleteFile(APPWRITE_SONGS_BUCKET_ID, data.file_id).catch(()=>{});

            const { error: delErr } = await supabase.from('songs').delete().eq('id', songId);
            if (delErr) throw delErr;

            showInfoModal('Canci√≥n borrada con √©xito.');
            await loadAllData(); await renderAdminLists();
          }catch(err){
            showInfoModal('Error borrando canci√≥n: ' + err.message);
          }finally{ showLoadingIndicator(false); }
        }
      );
    }

    // ============================
    // 13) APP BOOT
    // ============================
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üöÄ KLMZ MUSIC iniciando...');
      const audio = document.getElementById('audio-player');
      audio.addEventListener('ended', handleSongEnded);
      audio.addEventListener('timeupdate', updateProgressBar);
      audio.addEventListener('play', () => { isPlaying = true; updatePlayButtons(); });
      audio.addEventListener('pause', () => { isPlaying = false; updatePlayButtons(); });

      document.getElementById('mini-player').addEventListener('click', (e)=>{
        if (!e.target.closest('.player-controls-inline')) openFullPlayer();
      });

      loadSavedTheme();

      initDB().then(()=>console.log('‚úÖ Base de datos local inicializada.'))
        .catch(err => { console.error('‚ùå Error fatal de DB:', err); showInfoModal('La aplicaci√≥n no puede funcionar sin la base de datos local.'); });
    });

    window.onload = async function(){
      try{
        await initServices();
        await loadAllData();
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('./sw.js').then(reg=>console.log('‚úÖ Service Worker registrado:', reg.scope)).catch(e=>console.log('‚ùå SW:', e));
        }
      }catch(e){
        console.error('Error conectando a servicios:', e);
        showErrorMessage('Error de conexi√≥n. Revisa tu internet o las credenciales.');
      }
    }
  </script>
</body>
</html>
