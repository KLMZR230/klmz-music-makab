<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tienda de Accesorios (HTML + Supabase)</title>
  <style>
    :root{font-family:Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;}
    body{background:#f3f4f6;margin:0;padding:24px;color:#111}
    .container{max-width:1100px;margin:0 auto}
    header h1{margin:0 0 6px 0}
    .card{background:#fff;padding:16px;border-radius:8px;box-shadow:0 1px 4px rgba(2,6,23,0.08)}
    form{display:flex;gap:12px;flex-wrap:wrap}
    input[type=text], input[type=number]{padding:8px;border:1px solid #d1d5db;border-radius:6px}
    button{padding:8px 12px;border-radius:6px;border:0;background:#2563eb;color:#fff;cursor:pointer}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px;margin-top:16px}
    .product{display:flex;flex-direction:column}
    .thumb{height:160px;background:#e5e7eb;border-radius:6px;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .thumb img{width:100%;height:100%;object-fit:contain}
    .meta{padding:8px 0;display:flex;justify-content:space-between;align-items:center}
    .qty-controls button{background:#f3f4f6;color:#111;padding:6px 8px;border-radius:6px;border:1px solid #d1d5db}
    .danger{background:#ef4444}
    .muted{color:#6b7280;font-size:13px}
    .small{font-size:13px}
  </style>
</head>
<body>
  <div class="container">
    <header class="card" style="margin-bottom:16px">
      <h1>Tienda de Accesorios — Panel HTML</h1>
      <p class="muted">Agrega productos, sube imagen, controla cantidades. Conectado a Supabase.</p>
    </header>

    <section class="card" style="margin-bottom:16px">
      <form id="product-form">
        <div style="flex:1;min-width:220px">
          <label class="small">Nombre</label><br>
          <input id="name" type="text" required placeholder="Ej: Funda iPhone 13" />
        </div>

        <div style="width:140px">
          <label class="small">Precio (USD)</label><br>
          <input id="price" type="number" step="0.01" min="0" required placeholder="12.50" />
        </div>

        <div style="width:120px">
          <label class="small">Cantidad</label><br>
          <input id="quantity" type="number" min="0" value="1" required />
        </div>

        <div style="width:220px">
          <label class="small">Imagen</label><br>
          <input id="image" type="file" accept="image/*" />
        </div>

        <div style="align-self:flex-end">
          <button id="submit">Agregar producto</button>
        </div>
      </form>
      <p id="status" class="muted small" style="margin-top:8px"></p>
    </section>

    <section>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h2 style="margin:0">Inventario</h2>
        <div class="muted" id="total-count">Cargando...</div>
      </div>

      <div id="products" class="grid"></div>
    </section>

    <footer style="margin-top:18px" class="muted small">SQL esperado: tabla <code>products(id uuid primary key, name text, price numeric, quantity int, image_url text, created_at timestamptz)</code> y bucket <code>product-images</code></footer>
  </div>

  <script type="module">
    // IMPORT supabase-js desde CDN (módulo ESM)
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // --- CONFIG: pega aquí tu URL y ANON KEY ---
    const SUPABASE_URL = 'https://ftcjaadsjpnzbckxevxq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ0Y2phYWRzanBuemJja3hldnhxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNDgwMTksImV4cCI6MjA3NDgyNDAxOX0.gYDhzM46oQRgly9FyVbdDCvVBaXzd3lmQJaNOVd1g3M';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const BUCKET = 'product-images'; // crea este bucket en Supabase Storage

    const form = document.getElementById('product-form');
    const nameIn = document.getElementById('name');
    const priceIn = document.getElementById('price');
    const qtyIn = document.getElementById('quantity');
    const imageIn = document.getElementById('image');
    const status = document.getElementById('status');
    const productsEl = document.getElementById('products');
    const totalCount = document.getElementById('total-count');

    async function fetchProducts(){
      status.textContent = 'Cargando productos...';
      const { data, error } = await supabase
        .from('products')
        .select('*')
        .order('created_at', { ascending: false });
      if (error) {
        console.error(error);
        status.textContent = 'Error al obtener productos: ' + error.message;
        return;
      }
      renderProducts(data || []);
      status.textContent = '';
    }

    function renderProducts(items){
      productsEl.innerHTML = '';
      totalCount.textContent = items.length + ' productos';
      if (items.length === 0) {
        productsEl.innerHTML = '<div class="muted">No hay productos todavía.</div>';
        return;
      }
      for (const p of items){
        const card = document.createElement('div');
        card.className = 'card product';
        card.style.padding = '8px';

        const thumb = document.createElement('div');
        thumb.className = 'thumb';
        if (p.image_url){
          const img = document.createElement('img');
          img.src = p.image_url;
          img.alt = p.name;
          thumb.appendChild(img);
        } else {
          thumb.textContent = 'Sin imagen';
        }

        const meta = document.createElement('div');
        meta.className = 'meta small';
        const left = document.createElement('div');
        left.innerHTML = `<strong>${escapeHtml(p.name)}</strong><div class="muted">$${Number(p.price||0).toFixed(2)}</div>`;

        const right = document.createElement('div');
        right.innerHTML = `<div class="muted">Cant: <strong>${p.quantity||0}</strong></div>`;

        meta.appendChild(left);
        meta.appendChild(right);

        const actions = document.createElement('div');
        actions.style.display = 'flex';
        actions.style.gap = '8px';
        actions.style.marginTop = '8px';

        const dec = document.createElement('button'); dec.textContent = '-'; dec.className = 'qty-controls';
        dec.onclick = () => changeQty(p.id, -1);
        const inc = document.createElement('button'); inc.textContent = '+'; inc.onclick = () => changeQty(p.id, +1);
        inc.className = 'qty-controls';

        const del = document.createElement('button'); del.textContent = 'Eliminar'; del.className = 'danger';
        del.onclick = () => deleteProduct(p.id);

        actions.appendChild(dec); actions.appendChild(inc); actions.appendChild(del);

        card.appendChild(thumb);
        card.appendChild(meta);
        card.appendChild(actions);

        productsEl.appendChild(card);
      }
    }

    async function uploadImage(file){
      if (!file) return null;
      const ext = file.name.split('.').pop();
      const path = `${Date.now()}_${Math.random().toString(36).slice(2,8)}.${ext}`;
      const { data, error } = await supabase.storage.from(BUCKET).upload(path, file, { cacheControl: '3600', upsert: false });
      if (error){ console.error('Upload error', error); throw error; }
      const { data: publicData } = supabase.storage.from(BUCKET).getPublicUrl(path);
      return publicData?.publicUrl || null;
    }

    form.addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      const name = nameIn.value.trim();
      const price = parseFloat(priceIn.value) || 0;
      const quantity = parseInt(qtyIn.value) || 0;
      const file = imageIn.files[0] || null;
      try{
        status.textContent = 'Subiendo...';
        let imageUrl = null;
        if (file) imageUrl = await uploadImage(file);
        const { data, error } = await supabase.from('products').insert([{ name, price, quantity, image_url: imageUrl }]).select().single();
        if (error) throw error;
        nameIn.value = ''; priceIn.value = ''; qtyIn.value = '1'; imageIn.value = '';
        status.textContent = 'Producto agregado.';
        fetchProducts();
      }catch(err){
        console.error(err);
        status.textContent = 'Error: ' + (err.message || JSON.stringify(err));
      }finally{
        setTimeout(()=>{ status.textContent = '' }, 3000);
      }
    });

    async function changeQty(id, delta){
      try{
        // obtener producto actual (simple approach: fetch single row)
        const { data: rows, error } = await supabase.from('products').select('*').eq('id', id).limit(1).single();
        if (error) throw error;
        const newQty = Math.max(0, (rows.quantity||0) + delta);
        const { error: upErr } = await supabase.from('products').update({ quantity: newQty }).eq('id', id);
        if (upErr) throw upErr;
        fetchProducts();
      }catch(err){ console.error(err); alert('Error actualizando cantidad: ' + (err.message||err)); }
    }

    async function deleteProduct(id){
      if (!confirm('¿Eliminar este producto?')) return;
      const { error } = await supabase.from('products').delete().eq('id', id);
      if (error){ console.error(error); alert('Error al eliminar'); }
      else fetchProducts();
    }

    // small helper
    function escapeHtml(str){ return String(str||'').replace(/[&<>\"]/g, (m)=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }

    // Inicial
    fetchProducts();

    // Opcional: suscribirse a cambios en la tabla (realtime)
    try{
      const channel = supabase.channel('public:products')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'products' }, () => fetchProducts())
        .subscribe();
    }catch(e){ console.warn('Realtime no disponible', e); }
  </script>
</body>
</html>
