<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>KLMZ MUSIC</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1DB954">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; background: #181818; color: #fff; padding-bottom: 84px; transition: all 0.3s ease; }
        header { background: #121212; padding: 1rem 1.5rem; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
        .logo { font-weight: bold; font-size: 1.4rem; letter-spacing: 1px; }
        .user-actions { display:flex; align-items: center; gap:.5rem; }
        .lock-icon { cursor:pointer; font-size:1.4rem; color:#fff; user-select:none; }
        .theme-selector { display: flex; align-items: center; gap: 0.3rem; margin-right: 0.5rem; }
        .theme-selector select { background: #333; color: #fff; border: 1px solid #555; border-radius: 4px; padding: 0.2rem; cursor: pointer; }
        main { flex:1; padding:1rem; max-width:900px; margin:0 auto;}
        .section-title { font-size:1.8rem; font-weight:bold; margin-bottom:1.5rem; }
        .album-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(140px,1fr)); gap:1.5rem;}
        .album-card { background:none; padding:0; cursor:pointer; display:flex; flex-direction:column; align-items:center; text-align:center; border: 2px solid transparent; border-radius: 12px; transition: transform 0.3s; }
        .album-card:hover { transform:scale(1.05); }
        .album-img { border-radius:50%; width:100px; height:100px; object-fit:cover; margin-bottom:.7rem; background:#333; }
        .album-title { font-size:.98rem; font-weight: bold; margin-bottom: 0.4rem; }
        .album-artist { font-size: .9rem; color: #b3b3b3; }
        .song-list ul { list-style:none; padding:0; margin:0;}
        .song-list li { padding:.7rem; cursor:pointer; color:#1db954; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center; }
        .song-list li:hover { color:#fff; background: rgba(255,255,255,.05);}
        .player { position: fixed; bottom: 84px; left: 0; right: 0; background: #212121; border-top: 1px solid #282828; z-index: 300; display: none; align-items: center; padding: 0.8rem 1.2rem; }
        .player-img-mini { width:44px; height:44px; border-radius:50%; object-fit:cover; margin-right:1rem;}
        .player-info-mini { flex:1; overflow:hidden;}
        .player-title-mini { font-weight:bold; font-size:1rem; }
        .player-artist-mini { color:#b3b3b3; font-size:0.9rem; }
        .player-controls-inline { display:flex; align-items:center; gap:.5rem;}
        .play-btn-inline { background: #1DB954; color:#fff; border:none; border-radius:50%; width:36px; height:36px; cursor:pointer; }
        .modal { position: fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,.80); display:none; align-items:center; justify-content:center; z-index:2000; }
        .modal-content { background:#282828; padding:2rem; border-radius:8px; width:95%; max-width:430px; position: relative; }
        .form-group { margin-bottom:1rem;}
        .form-group input { width:100%; padding:.7rem; background:#404040; border:1px solid #555; border-radius:4px; color:#fff; }
        .btn-primary { background:#1DB954; color:#fff; border:none; padding:.7rem 1.5rem; border-radius:999px; cursor:pointer; width:100%; margin-top:.7rem; }
        .close-modal { position:absolute; top:1rem; right:1rem; background:none; border:none; color:#fff; font-size:1.2rem; cursor:pointer;}
        .user-menu { position: relative; display: inline-block; }
        .user-dropdown { display: none; position: absolute; right: 0; top: calc(100% + 10px); background: #282828; min-width: 200px; border-radius: 8px; z-index: 1000; }
        .user-dropdown.show { display: block; }
        .user-dropdown-item { padding: 0.8rem 1rem; cursor: pointer; border-bottom: 1px solid #404040; }
        .user-dropdown-item:hover { background: #404040; }
        .bottom-nav { position: fixed; left: 0; right: 0; bottom: 20px; background: #181818; border-top: 1px solid #272727; display: flex; height: 64px; z-index: 5000; }
        .bottom-nav-item { color: #b3b3b3; text-align: center; flex: 1; padding: 4px 0; cursor: pointer; display: flex; flex-direction: column; align-items: center; }
        .bottom-nav-item.active { color: #1DB954; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .back-btn { margin-bottom: 1.2rem; background: #222; color: #fff; border: none; padding: 0.5rem 1.5rem; border-radius: 99px; cursor: pointer; }
        .loading-indicator { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.9); color: #fff; padding: 1.5rem 2.5rem; border-radius: 12px; z-index: 2000; display: none; }
        .admin-section { margin-bottom: 2rem; background: #242424; padding: 1.5rem; border-radius: 8px; }
        .admin-form input[type="file"] { background: #333; border: 2px dashed #1DB954; padding: 1rem; border-radius: 8px; cursor: pointer; }
        .btn-danger { background:#e22134; color:#fff; border:none; padding:.5rem 1rem; border-radius:4px; cursor:pointer; }
        .upload-progress { background: #333; border: 1px solid #1DB954; border-radius: 8px; padding: 1rem; margin: 1rem 0; }
        .copyright { position: fixed; bottom: 0; left: 0; width: 100%; height: 20px; background: #0a0a0a; color: #666; font-size: 0.7rem; text-align: center; padding: 2px 0; z-index: 10000; }
        
        /* Temas */
        body.theme-neon { background: linear-gradient(135deg, #0a0a0a, #1a1a2e, #16213e) !important; }
        body.theme-neon .logo { color: #00ff88 !important; text-shadow: 0 0 20px #00ff88; }
        body.theme-minimal { background: linear-gradient(135deg, #0f0f0f, #1c1c1c, #2a2a2a) !important; }
        body.theme-sunset { background: linear-gradient(135deg, #2c1810, #4a2c2a, #6d4c41) !important; }
        body.theme-pastel { background: linear-gradient(135deg, #1a1625, #2d2438, #3d2f47) !important; }
        body.theme-luxury { background: linear-gradient(135deg, #0f1419, #1a252f, #2c3e50) !important; }
        body.theme-oceanic { background: linear-gradient(135deg, #0a192f, #173a5e, #3b6978) !important; }
    </style>
</head>
<body>
    <div class="loading-indicator" id="loading">üéµ Cargando...</div>
    
    <header>
        <span class="logo">KLMZ MUSIC</span>
        <div class="user-actions">
            <div class="theme-selector">
                <select id="theme-select" onchange="changeTheme(this.value)">
                    <option value="default">üéµ Default</option>
                    <option value="neon">‚ö° Neon</option>
                    <option value="minimal">‚ú® Minimal</option>
                    <option value="sunset">üåÖ Sunset</option>
                    <option value="pastel">üå∏ Pastel</option>
                    <option value="luxury">üíé Luxury</option>
                    <option value="oceanic">üåä Oceanic</option>
                </select>
            </div>
            <div class="user-menu">
                <div class="lock-icon" onclick="toggleUserMenu()">üîí</div>
                <div class="user-dropdown" id="userDropdown">
                    <div class="user-dropdown-item" onclick="showAuth('login')">üîê Iniciar Sesi√≥n</div>
                    <div class="user-dropdown-item" onclick="showAuth('register')">üìù Registrarse</div>
                    <div class="user-dropdown-item" id="adminBtn" onclick="showSection('admin')" style="display:none;">‚öôÔ∏è Admin</div>
                    <div class="user-dropdown-item" id="logoutBtn" onclick="logout()" style="display:none;">üö™ Cerrar Sesi√≥n</div>
                </div>
            </div>
        </div>
    </header>

    <main>
        <section class="content-section active" id="home-section">
            <div class="section-title">Albums</div>
            <div class="album-grid" id="albums">
                <div style="text-align: center; padding: 2rem; color: #666;">
                    <h3>Cargando √°lbumes...</h3>
                </div>
            </div>
            <div id="album-detail" style="display:none;"></div>
        </section>

        <section class="content-section" id="search-section">
            <div class="section-title">Buscar</div>
            <input type="text" placeholder="¬øQu√© quieres escuchar?" id="search-input" style="width:100%; padding:1rem; background:#242424; border:none; border-radius:4px; color:#fff; margin-bottom:2rem;" onkeyup="searchMusic()">
            <div id="search-results"></div>
        </section>

        <section class="content-section" id="favorites-section">
            <div class="section-title">‚ù§Ô∏è Favoritos</div>
            <div id="favorites-content">
                <div style="text-align: center; padding: 2rem; color: #666;">
                    <h3>No tienes favoritos</h3>
                </div>
            </div>
        </section>

        <section class="content-section" id="downloads-section">
            <div class="section-title">‚Üì Descargas</div>
            <div id="downloads-content">
                <div style="text-align: center; padding: 2rem; color: #666;">
                    <h3>No tienes descargas</h3>
                </div>
            </div>
        </section>

        <section class="content-section" id="admin-section">
            <div class="section-title">‚öôÔ∏è Panel Admin</div>
            <div id="admin-content"></div>
        </section>
    </main>

    <nav class="bottom-nav">
        <div class="bottom-nav-item active" onclick="showSection('home')">
            <div style="font-size: 1.2rem;">‚åÇ</div>
            <small>Inicio</small>
        </div>
        <div class="bottom-nav-item" onclick="showSection('search')">
            <div style="font-size: 1.2rem;">üîç</div>
            <small>Buscar</small>
        </div>
        <div class="bottom-nav-item" onclick="showSection('downloads')">
            <div style="font-size: 1.2rem;">‚Üì</div>
            <small>Descargas</small>
        </div>
        <div class="bottom-nav-item" onclick="showSection('favorites')">
            <div style="font-size: 1.2rem;">‚ô°</div>
            <small>Favoritos</small>
        </div>
    </nav>

    <div class="player" id="mini-player">
        <img class="player-img-mini" id="player-img" alt="cover">
        <div class="player-info-mini">
            <div class="player-title-mini" id="player-title"></div>
            <div class="player-artist-mini" id="player-artist"></div>
        </div>
        <div class="player-controls-inline">
            <button class="play-btn-inline" id="play-btn" onclick="togglePlay()">‚ñ∂</button>
        </div>
    </div>

    <div class="modal" id="auth-modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal()">&times;</button>
            <div id="login-form">
                <h2>Iniciar Sesi√≥n</h2>
                <form onsubmit="login(event)">
                    <div class="form-group">
                        <input type="email" id="login-email" placeholder="Email" required>
                    </div>
                    <div class="form-group">
                        <input type="password" id="login-password" placeholder="Contrase√±a" required>
                    </div>
                    <button type="submit" class="btn-primary">Iniciar Sesi√≥n</button>
                </form>
            </div>
            <div id="register-form" style="display: none;">
                <h2>Registrarse</h2>
                <form onsubmit="register(event)">
                    <div class="form-group">
                        <input type="email" id="register-email" placeholder="Email" required>
                    </div>
                    <div class="form-group">
                        <input type="password" id="register-password" placeholder="Contrase√±a" required>
                    </div>
                    <div class="form-group">
                        <input type="password" id="register-confirm" placeholder="Confirmar Contrase√±a" required>
                    </div>
                    <button type="submit" class="btn-primary">Registrarse</button>
                </form>
            </div>
        </div>
    </div>

    <div class="copyright">¬© 2025 KLMZ MUSIC - Desarrollado por Freddy Granados</div>
    <audio id="audio-player" preload="metadata"></audio>

## üéØ **PARTE 2: JavaScript B√ÅSICO (Sin bucles infinitos)**

<script>
    // ‚úÖ VARIABLES GLOBALES - SIN PROBLEMAS DE INICIALIZACI√ìN
    let supabase;
    let currentUser = null;
    let allAlbums = [];
    let allSongs = [];
    let currentSong = null;
    let currentAlbum = null;
    let currentPlaylist = [];
    let currentIndex = 0;
    let isPlaying = false;
    let isCordova = false;
    
    const CONFIG = {
        supabaseUrl: 'https://nqbldvpnqhngdtalvzov.supabase.co',
        supabaseKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xYmxkdnBucWhuZ2R0YWx2em92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyMjY0NjUsImV4cCI6MjA3MDgwMjQ2NX0.Zzg5D219sW7bhvl0_R5ypX9MF6nRzBSDIeo2Lvebab0',
        adminEmail: 'klmzr@gmail.com'
    };
    
    console.log('üöÄ KLMZ MUSIC - Iniciando aplicaci√≥n...');
    
    // ‚úÖ DETECCI√ìN DE ENTORNO
    function detectEnvironment() {
        isCordova = !!(window.cordova || window.phonegap);
        console.log('üì± Entorno:', isCordova ? 'Cordova APK' : 'Navegador Web');
        return isCordova;
    }
    
    // ‚úÖ SISTEMA DE TEMAS FUNCIONAL
    function changeTheme(theme) {
        console.log('üé® Cambiando tema:', theme);
        const body = document.body;
        
        // Remover temas anteriores
        ['theme-neon', 'theme-minimal', 'theme-sunset', 'theme-pastel', 'theme-luxury', 'theme-oceanic']
            .forEach(t => body.classList.remove(t));
        
        // Aplicar nuevo tema
        if (theme !== 'default') {
            body.classList.add('theme-' + theme);
        }
        
        localStorage.setItem('klmz_theme', theme);
    }
    
    function loadTheme() {
        const saved = localStorage.getItem('klmz_theme') || 'default';
        document.getElementById('theme-select').value = saved;
        changeTheme(saved);
    }
    
    // ‚úÖ INICIALIZAR SUPABASE - SIN BUCLES
    async function initSupabase() {
        try {
            console.log('üîÑ Inicializando Supabase...');
            supabase = window.supabase.createClient(CONFIG.supabaseUrl, CONFIG.supabaseKey);
            
            // Auth listener
            supabase.auth.onAuthStateChange((event, session) => {
                currentUser = session?.user || null;
                updateAuthUI();
                console.log('üîê Auth:', event, currentUser?.email || 'Sin usuario');
            });
            
            // Obtener sesi√≥n actual
            const { data: { session } } = await supabase.auth.getSession();
            currentUser = session?.user || null;
            
            updateAuthUI();
            console.log('‚úÖ Supabase inicializado');
            return true;
        } catch (error) {
            console.error('‚ùå Error Supabase:', error);
            return false;
        }
    }
    
    // ‚úÖ CARGAR DATOS - SIN BUCLES INFINITOS
    async function loadData() {
        try {
            showLoading(true);
            console.log('üìä Cargando datos...');
            
            if (!supabase) {
                throw new Error('Supabase no inicializado');
            }
            
            // Cargar √°lbumes
            const { data: albums, error: albumError } = await supabase
                .from('albums')
                .select('*')
                .order('created_at', { ascending: false });
            
            if (albumError) throw albumError;
            
            // Cargar canciones
            const { data: songs, error: songError } = await supabase
                .from('songs')
                .select('*, albums:album_id(*)')
                .order('created_at', { ascending: false });
            
            if (songError) throw songError;
            
            allAlbums = albums || [];
            allSongs = songs || [];
            
            console.log(`‚úÖ Cargados: ${allAlbums.length} √°lbumes, ${allSongs.length} canciones`);
            displayAlbums();
            
        } catch (error) {
            console.error('‚ùå Error cargando datos:', error);
            document.getElementById('albums').innerHTML = `
                <div style="text-align: center; padding: 2rem; color: #ff4757;">
                    <h3>‚ùå Error de conexi√≥n</h3>
                    <p>${error.message}</p>
                    <button onclick="loadData()" class="btn-primary" style="width: auto; margin-top: 1rem;">üîÑ Reintentar</button>
                </div>
            `;
        } finally {
            showLoading(false);
        }
    }
    
    // ‚úÖ MOSTRAR √ÅLBUMES
    function displayAlbums() {
        const container = document.getElementById('albums');
        
        if (allAlbums.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 2rem; color: #666;">
                    <h3>üìÄ No hay √°lbumes</h3>
                    <p>Inicia sesi√≥n como admin para subir m√∫sica</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = allAlbums.map(album => `
            <div class="album-card" onclick="showAlbum('${album.id}')">
                <img class="album-img" src="${album.cover_url}" alt="${album.title}" 
                     onerror="this.style.background='#333'; this.alt='üéµ';">
                <div class="album-title">${album.title}</div>
                <div class="album-artist">${album.artist}</div>
            </div>
        `).join('');
    }
    
    // ‚úÖ MOSTRAR DETALLES DEL √ÅLBUM
    async function showAlbum(albumId) {
        try {
            console.log('üîç Mostrando √°lbum:', albumId);
            
            const album = allAlbums.find(a => a.id === albumId);
            if (!album) return;
            
            currentAlbum = album;
            
            document.getElementById('albums').style.display = 'none';
            const detail = document.getElementById('album-detail');
            detail.style.display = 'block';
            
            detail.innerHTML = `
                <button class="back-btn" onclick="backToAlbums()">‚üµ Volver</button>
                <div style="text-align: center; margin-bottom: 2rem;">
                    <img src="${album.cover_url}" style="width: 200px; height: 200px; border-radius: 12px;">
                    <h2>${album.title}</h2>
                    <p style="color: #b3b3b3;">${album.artist}</p>
                </div>
                <div id="song-list">Cargando canciones...</div>
            `;
            
            // Cargar canciones del √°lbum
            const { data: songs } = await supabase
                .from('songs')
                .select('*')
                .eq('album_id', albumId);
            
            const songList = document.getElementById('song-list');
            
            if (!songs || songs.length === 0) {
                songList.innerHTML = '<p style="text-align: center; color: #666;">No hay canciones en este √°lbum</p>';
                return;
            }
            
            currentPlaylist = songs;
            
            songList.innerHTML = `
                <div class="song-list">
                    <ul>
                        ${songs.map((song, idx) => `
                            <li onclick="playSong(${idx})">
                                <span>${song.title}</span>
                                <span style="cursor: pointer; color: #1DB954;">‚ñ∂</span>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
            
        } catch (error) {
            console.error('‚ùå Error mostrando √°lbum:', error);
        }
    }
    
    // ‚úÖ REPRODUCCI√ìN - SIN COMPLEJIDAD EXCESIVA
    function playSong(index) {
        if (!currentPlaylist[index]) return;
        
        const song = currentPlaylist[index];
        currentSong = song;
        currentIndex = index;
        
        console.log('üéµ Reproduciendo:', song.title);
        
        const audio = document.getElementById('audio-player');
        audio.src = song.song_url;
        audio.play();
        
        // Actualizar mini player
        updatePlayer();
    }
    
    function updatePlayer() {
        const player = document.getElementById('mini-player');
        if (currentSong && currentAlbum) {
            player.style.display = 'flex';
            document.getElementById('player-img').src = currentAlbum.cover_url;
            document.getElementById('player-title').textContent = currentSong.title;
            document.getElementById('player-artist').textContent = currentAlbum.artist;
        }
    }
    
    function togglePlay() {
        const audio = document.getElementById('audio-player');
        const btn = document.getElementById('play-btn');
        
        if (audio.paused) {
            audio.play();
            btn.textContent = '‚è∏';
            isPlaying = true;
        } else {
            audio.pause();
            btn.textContent = '‚ñ∂';
            isPlaying = false;
        }
    }
    
    // ‚úÖ NAVEGACI√ìN SIMPLE
    function showSection(sectionName) {
        console.log('üß≠ Navegando a:', sectionName);
        
        // Remover active de todas las secciones
        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.bottom-nav-item').forEach(n => n.classList.remove('active'));
        
        // Activar secci√≥n actual
        document.getElementById(sectionName + '-section').classList.add('active');
        event.target.classList.add('active');
        
        // Cargar contenido espec√≠fico
        if (sectionName === 'admin') {
            if (!currentUser || currentUser.email !== CONFIG.adminEmail) {
                alert('üîí Solo el administrador puede acceder');
                showSection('home');
                return;
            }
            loadAdminPanel();
        }
        
        if (sectionName === 'favorites') {
            loadFavorites();
        }
        
        if (sectionName === 'downloads') {
            loadDownloads();
        }
    }
    
    function backToAlbums() {
        document.getElementById('album-detail').style.display = 'none';
        document.getElementById('albums').style.display = 'grid';
    }
        
        // ‚úÖ PANEL ADMIN SIMPLE PERO FUNCIONAL
        function loadAdminPanel() {
            const content = document.getElementById('admin-content');
            content.innerHTML = `
                <div class="admin-section">
                    <h3>üìÄ Crear √Ålbum</h3>
                    <form onsubmit="createAlbum(event)">
                        <div class="form-group">
                            <input type="text" id="album-title" placeholder="T√≠tulo del √°lbum" required>
                        </div>
                        <div class="form-group">
                            <input type="text" id="album-artist" placeholder="Artista" required>
                        </div>
                        <div class="form-group">
                            <input type="file" id="album-cover" accept="image/*" required>
                        </div>
                        <button type="submit" class="btn-primary">Crear √Ålbum</button>
                    </form>
                </div>
                
                <div class="admin-section">
                    <h3>üéµ Subir Canciones</h3>
                    <form onsubmit="uploadSongs(event)">
                        <div class="form-group">
                            <select id="song-album" required>
                                <option value="">Seleccionar √°lbum...</option>
                                ${allAlbums.map(a => `<option value="${a.id}">${a.title}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <input type="file" id="song-files" accept="audio/*" multiple required>
                        </div>
                        <button type="submit" class="btn-primary">Subir Canciones</button>
                    </form>
                    <div id="upload-progress"></div>
                </div>
                
                <div class="admin-section">
                    <h3>üìä Gesti√≥n</h3>
                    <p>√Ålbumes: ${allAlbums.length}</p>
                    <p>Canciones: ${allSongs.length}</p>
                    <button onclick="loadData()" class="btn-primary">üîÑ Recargar Datos</button>
                </div>
            `;
        }
        
        // ‚úÖ CREAR √ÅLBUM
        async function createAlbum(event) {
            event.preventDefault();
            
            try {
                showLoading(true);
                
                const title = document.getElementById('album-title').value;
                const artist = document.getElementById('album-artist').value;
                const coverFile = document.getElementById('album-cover').files[0];
                
                if (!coverFile) {
                    alert('‚ùå Selecciona una portada');
                    return;
                }
                
                // Subir portada a Appwrite
                const coverUrl = await uploadToAppwrite(coverFile);
                
                // Crear √°lbum en Supabase
                const { data, error } = await supabase
                    .from('albums')
                    .insert([{ title, artist, cover_url: coverUrl }]);
                
                if (error) throw error;
                
                alert('‚úÖ √Ålbum creado exitosamente');
                document.getElementById('album-title').value = '';
                document.getElementById('album-artist').value = '';
                document.getElementById('album-cover').value = '';
                
                await loadData();
                loadAdminPanel();
                
            } catch (error) {
                console.error('‚ùå Error creando √°lbum:', error);
                alert('‚ùå Error: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        // ‚úÖ SUBIR CANCIONES
        async function uploadSongs(event) {
            event.preventDefault();
            
            try {
                const albumId = document.getElementById('song-album').value;
                const files = document.getElementById('song-files').files;
                
                if (!albumId || files.length === 0) {
                    alert('‚ùå Selecciona √°lbum y archivos');
                    return;
                }
                
                const progress = document.getElementById('upload-progress');
                let uploaded = 0;
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    progress.innerHTML = `<div class="upload-progress">Subiendo ${file.name}... (${i + 1}/${files.length})</div>`;
                    
                    try {
                        const songUrl = await uploadToAppwrite(file);
                        const title = file.name.replace(/\.[^/.]+$/, '');
                        
                        const { error } = await supabase
                            .from('songs')
                            .insert([{ title, album_id: albumId, song_url: songUrl }]);
                        
                        if (error) throw error;
                        uploaded++;
                        
                    } catch (err) {
                        console.error('Error subiendo', file.name, err);
                    }
                }
                
                alert(`‚úÖ ${uploaded}/${files.length} canciones subidas`);
                document.getElementById('song-files').value = '';
                progress.innerHTML = '';
                
                await loadData();
                
            } catch (error) {
                console.error('‚ùå Error subiendo canciones:', error);
                alert('‚ùå Error: ' + error.message);
            }
        }
        
        // ‚úÖ UPLOAD A APPWRITE
        async function uploadToAppwrite(file) {
            try {
                const client = new window.Appwrite.Client()
                    .setEndpoint('https://nyc.cloud.appwrite.io/v1')
                    .setProject('68ab0cf2000365979a71');
                
                const storage = new window.Appwrite.Storage(client);
                const response = await storage.createFile('68ad019f00207b1df467', window.Appwrite.ID.unique(), file);
                
                return `https://nyc.cloud.appwrite.io/v1/storage/buckets/68ad019f00207b1df467/files/${response.$id}/view?project=68ab0cf2000365979a71`;
                
            } catch (error) {
                console.error('‚ùå Error Appwrite:', error);
                throw error;
            }
        }
        
        // ‚úÖ AUTENTICACI√ìN SIMPLE
        function updateAuthUI() {
            const adminBtn = document.getElementById('adminBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const lockIcon = document.querySelector('.lock-icon');
            
            if (currentUser) {
                lockIcon.textContent = 'üë§';
                logoutBtn.style.display = 'block';
                
                if (currentUser.email === CONFIG.adminEmail) {
                    adminBtn.style.display = 'block';
                    lockIcon.textContent = '‚öôÔ∏è';
                }
            } else {
                lockIcon.textContent = 'üîí';
                adminBtn.style.display = 'none';
                logoutBtn.style.display = 'none';
            }
        }
        
        async function login(event) {
            event.preventDefault();
            
            try {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                
                const { error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;
                
                alert('‚úÖ ¬°Bienvenido!');
                closeModal();
                
            } catch (error) {
                console.error('‚ùå Error login:', error);
                alert('‚ùå Error: ' + error.message);
            }
        }
        
        async function register(event) {
            event.preventDefault();
            
            try {
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const confirm = document.getElementById('register-confirm').value;
                
                if (password !== confirm) {
                    alert('‚ùå Las contrase√±as no coinciden');
                    return;
                }
                
                const { error } = await supabase.auth.signUp({ email, password });
                if (error) throw error;
                
                alert('‚úÖ Registro exitoso. Revisa tu email.');
                closeModal();
                
            } catch (error) {
                console.error('‚ùå Error registro:', error);
                alert('‚ùå Error: ' + error.message);
            }
        }
        
        async function logout() {
            try {
                await supabase.auth.signOut();
                alert('‚úÖ Sesi√≥n cerrada');
                showSection('home');
            } catch (error) {
                console.error('‚ùå Error logout:', error);
            }
        }
        
        // ‚úÖ FUNCIONES DE INTERFAZ
        function toggleUserMenu() {
            document.getElementById('userDropdown').classList.toggle('show');
        }
        
        function showAuth(type) {
            document.getElementById('userDropdown').classList.remove('show');
            document.getElementById('login-form').style.display = type === 'login' ? 'block' : 'none';
            document.getElementById('register-form').style.display = type === 'register' ? 'block' : 'none';
            document.getElementById('auth-modal').style.display = 'flex';
        }
        
        function closeModal() {
            document.getElementById('auth-modal').style.display = 'none';
        }
        
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        // ‚úÖ B√öSQUEDA SIMPLE
        function searchMusic() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const results = document.getElementById('search-results');
            
            if (!query) {
                results.innerHTML = '';
                return;
            }
            
            const found = allSongs.filter(s => 
                s.title.toLowerCase().includes(query) || 
                s.albums?.artist?.toLowerCase().includes(query)
            );
            
            if (found.length === 0) {
                results.innerHTML = '<p style="color: #666;">No se encontraron resultados</p>';
                return;
            }
            
            results.innerHTML = found.map(song => `
                <div style="padding: 1rem; background: #242424; margin: 0.5rem 0; border-radius: 8px; cursor: pointer;" 
                     onclick="playSongById('${song.id}')">
                    <strong>${song.title}</strong><br>
                    <small style="color: #b3b3b3;">${song.albums?.artist || 'Desconocido'}</small>
                </div>
            `).join('');
        }
        
        function playSongById(songId) {
            const song = allSongs.find(s => s.id === songId);
            if (song) {
                currentSong = song;
                currentAlbum = allAlbums.find(a => a.id === song.album_id);
                
                const audio = document.getElementById('audio-player');
                audio.src = song.song_url;
                audio.play();
                updatePlayer();
            }
        }
        
        // ‚úÖ FAVORITOS Y DESCARGAS B√ÅSICOS
        function loadFavorites() {
            document.getElementById('favorites-content').innerHTML = `
                <div style="text-align: center; padding: 2rem; color: #666;">
                    <h3>‚ù§Ô∏è Favoritos</h3>
                    <p>Funci√≥n en desarrollo</p>
                </div>
            `;
        }
        
        function loadDownloads() {
            document.getElementById('downloads-content').innerHTML = `
                <div style="text-align: center; padding: 2rem; color: #666;">
                    <h3>üì• Descargas Offline</h3>
                    <p>Entorno: ${isCordova ? 'üì± APK' : 'üåê Web'}</p>
                    <p>Funci√≥n en desarrollo</p>
                </div>
            `;
        }
        
        // ‚úÖ INICIALIZACI√ìN FINAL - SIN BUCLES
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Iniciando KLMZ MUSIC...');
            
            try {
                // 1. Cargar tema
                loadTheme();
                
                // 2. Detectar entorno
                detectEnvironment();
                
                // 3. Inicializar Supabase
                const supabaseOk = await initSupabase();
                
                if (supabaseOk) {
                    // 4. Cargar datos
                    await loadData();
                    console.log('‚úÖ Aplicaci√≥n iniciada correctamente');
                } else {
                    console.error('‚ùå Error inicializando aplicaci√≥n');
                }
                
                // 5. Configurar audio
                const audio = document.getElementById('audio-player');
                audio.addEventListener('ended', () => {
                    isPlaying = false;
                    document.getElementById('play-btn').textContent = '‚ñ∂';
                });
                
            } catch (error) {
                console.error('‚ùå Error cr√≠tico:', error);
                showLoading(false);
            }
        });
        
        // Para Cordova
        document.addEventListener('deviceready', () => {
            console.log('üì± Cordova listo');
            detectEnvironment();
        }, false);
        
        console.log('‚úÖ Script cargado - esperando DOM...');
    </script>
</body>
</html>
