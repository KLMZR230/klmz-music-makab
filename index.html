<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KLMZ MUSIC</title>
<meta name="description" content="KLMZ MUSIC - Tu plataforma de m√∫sica personal" />
<meta name="theme-color" content="#1db954" />
<link rel="manifest" href="manifest.json">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js')
      .then(registration => {
        console.log('‚úÖ Service Worker registrado:', registration);
      })
      .catch(error => {
        console.log('‚ùå Error registrando Service Worker:', error);
      });
  });
}
</script>
<style>
  /* Tus estilos completos tal como enviaste */
</style>
</head>
<body>
<div id="loadingScreen" class="loading">
  <div class="spinner"></div>
  <div class="text">Cargando KLMZ MUSIC...</div>
</div>
<div id="gestureHint" class="gesture-hint"></div>
<header>
  <div class="row">
    <div class="brand">
      <span class="logo">üî•</span> 
      KLMZ MUSIC
    </div>
    <div class="tools">
      <span class="muted" id="albumsTitle">Tu m√∫sica</span>
      <button class="icon-btn" id="btn-login" title="Admin" onclick="showLogin()">üîë</button>
      <button class="btn ghost" id="btn-logout" style="display:none" onclick="logout()">Salir</button>
    </div>
  </div>
</header>
<div class="container">
  <div class="row muted" style="margin-bottom:20px;">
    <span class="tag">Cat√°logo p√∫blico</span>
    <span id="adminTag" class="tag" style="display:none">Admin</span>
    <span id="userTag" class="tag" style="display:none">Usuario</span>
    <span id="offlineTag" class="tag" style="display:none;background:var(--success)">Offline</span>
  </div>
  <div id="musicControls" class="music-controls" style="display:none;">
    <button class="control-btn" id="shuffleBtn" onclick="toggleShuffle()" title="Aleatorio">
      <span>üîÄ</span> Shuffle
    </button>
    <button class="control-btn" id="repeatBtn" onclick="toggleRepeat()" title="Repetir">
      <span>üîÅ</span> Repeat
    </button>
    <button class="control-btn" onclick="showFavorites()" title="Favoritos">
      <span>‚ù§Ô∏è</span> Favoritos
    </button>
    <button class="control-btn" onclick="showDownloads()" title="Descargas">
      <span>‚¨á</span> Offline
    </button>
  </div>
  <!-- ... Todas las vistas (searchView, playlistsView, etc.) no cambia nada ... -->
  <div id="adminPanel" class="card stack" style="display:none">
    <div class="section-title">Panel Admin</div>
    <div class="inputs">
      <div class="stack">
        <div class="pill">Crear nuevo √°lbum</div>
        <input id="albumTitle" type="text" placeholder="T√≠tulo del √°lbum" />
        <input id="albumArtist" type="text" placeholder="Artista del √°lbum" />
        <input id="albumCover" type="file" accept="image/*" />
        <button class="btn" onclick="uploadAlbum()">Subir √Ålbum</button>
      </div>
      <div class="stack">
        <div class="pill">Agregar canciones a un √°lbum existente</div>
        <select id="albumSelect"></select>
        <input id="songTitle" type="text" placeholder="T√≠tulo de la canci√≥n (opcional si subes 1)" />
        <input id="songFiles" type="file" accept="audio/*" multiple />
        <button class="btn" onclick="uploadSong()">Subir Canciones</button>
      </div>
      <div class="stack">
        <div class="pill">Eliminar canciones individuales</div>
        <select id="deleteSongAlbumSelect" onchange="loadSongsForDeletion()">
          <option value="">Selecciona un √°lbum</option>
        </select>
        <select id="deleteSongSelect" style="display:none">
          <option value="">Selecciona una canci√≥n</option>
        </select>
        <button class="btn danger" onclick="deleteSong()" id="deleteSongBtn" style="display:none">üóëÔ∏è Eliminar Canci√≥n</button>
      </div>
      <div class="stack">
        <div class="pill">Eliminar √°lbumes completos</div>
        <select id="deleteAlbumSelect"></select>
        <button class="btn ghost" onclick="deleteAlbum()">Eliminar √Ålbum Completo</button>
      </div>
    </div>
  </div>
  <div id="homeContent">
    <div class="section-title">Albums</div>
    <div id="albumsGrid" class="grid albums"></div>
    <div id="emptyAlbums" class="muted" style="display:none">No hay √°lbumes todav√≠a.</div>
  </div>
  <div id="albumView" class="card stack">
    <div class="backline">
      <button class="back-btn" onclick="closeAlbumView()" title="Volver">‚Üê</button>
      <span class="muted">Volver</span>
    </div>
    <div class="album-hero">
      <img id="avCover" alt="cover">
      <div class="info">
        <div id="avTitle" class="title">‚Äî</div>
        <div id="avMeta" class="meta">‚Äî</div>
      </div>
    </div>
    <div id="avSongs" class="song-plain-list"></div>
  </div>
  <!-- ... Resto de tus divs: reproductor, overlays, etc ... -->
</div><!-- Cierra .container -->
<div class="player" id="player" onclick="openNowPlaying()">
  <div class="np">
    <img id="npCover" alt="cover">
    <div class="titles">
      <div id="npTitle" class="t">Cargando...</div>
      <div id="npAlbum" class="a">‚Äî</div>
    </div>
  </div>
  <div class="player-controls">
    <button class="circle sm" onclick="event.stopPropagation(); prevTrack()">‚èÆ</button>
    <button class="circle" id="playBtn" onclick="event.stopPropagation(); togglePlay()">‚ñ∂</button>
    <button class="circle sm" onclick="event.stopPropagation(); nextTrack()">‚è≠</button>
  </div>
  <div class="player-seek">
    <span id="curTime" class="time">0:00</span>
    <input id="seek" type="range" min="0" max="100" value="0" oninput="seekAudio(this.value)" onclick="event.stopPropagation()" />
    <span id="durTime" class="time">0:00</span>
  </div>
  <div class="vol">
    <span>Vol</span>
    <input id="vol" type="range" min="0" max="1" step="0.01" value="1" oninput="setVolume(this.value)" onclick="event.stopPropagation()" />
  </div>
  <div class="soundwave" id="soundwave" style="display:none">
    <div class="bar"></div><div class="bar"></div><div class="bar"></div>
  </div>
  <audio id="audio" preload="none" crossorigin="anonymous"></audio>
</div>
<!-- Aqu√≠ siguen tus overlays/modales: npOverlay, bottomBar, playlistModal, loginModal, etc. (como ya tienes) -->

<script>
const SUPABASE_URL = "https://nqbldvpnqhngdtalvzov.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xYmxkdnBucWhuZ2R0YWx2em92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyMjY0NjUsImV4cCI6MjA3MDgwMjQ2NX0.Zzg5D219sW7bhvl0_R5ypX9MF6nRzBSDIeo2Lvebab0";
const ADMIN_EMAIL = "klmzr@gmail.com";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
/* ... Todas tus variables y referencias ... */

// ------- FUNCIONES MODIFICADAS PARA SOPORTE DE ARTISTA Y AGRUPACI√ìN -------

async function uploadAlbum() {
  if (!isAdmin) return alert("No autorizado");
  const title = document.getElementById("albumTitle").value.trim();
  const artist = document.getElementById("albumArtist").value.trim();
  const file = document.getElementById("albumCover").files[0];
  if (!title || !artist || !file) return alert("Completa t√≠tulo, artista y portada");
  const path = `${Date.now()}-${safeName(file.name)}`;
  const { error: upErr } = await sb.storage.from("covers").upload(path, file);
  if (upErr) return alert("Error subiendo portada: " + upErr.message);
  const { data: pub } = sb.storage.from("covers").getPublicUrl(path);
  const cover_url = pub.publicUrl;
  const { error: insErr } = await sb.from("albums").insert([{ title, artist, cover_url }]);
  if (insErr) return alert("Error guardando √°lbum: " + insErr.message);
  document.getElementById("albumTitle").value = "";
  document.getElementById("albumArtist").value = "";
  document.getElementById("albumCover").value = "";
  showMessage("√Ålbum creado exitosamente", "success");
  await refreshCatalogOptimized();
}

function renderAlbums() {
  albumsGrid.innerHTML = "";

  // Agrupa √°lbumes por artista (usa "Sin artista" si falta)
  const albumsByArtist = {};
  albums.forEach(album => {
    const artist = album.artist || "Sin artista";
    if (!albumsByArtist[artist]) albumsByArtist[artist] = [];
    albumsByArtist[artist].push(album);
  });

  Object.keys(albumsByArtist).sort().forEach(artist => {
    // Encabezado
    const artistHeader = document.createElement("div");
    artistHeader.className = "section-title";
    artistHeader.textContent = artist;
    albumsGrid.appendChild(artistHeader);

    // Grid de √°lbumes de ese artista
    const artistGrid = document.createElement("div");
    artistGrid.className = "grid albums";
    albumsByArtist[artist].forEach(album => {
      const songCount = songsByAlbum[album.id] ? songsByAlbum[album.id].length : 0;
      const card = document.createElement("div");
      card.className = "album-card";
      card.innerHTML = `
        <img class="album-cover" src="${album.cover_url}" alt="${album.title}">
        <div class="album-title">${album.title}</div>
        <div class="album-meta">${songCount} ${songCount === 1 ? 'canci√≥n' : 'canciones'}</div>
      `;
      card.addEventListener('click', () => {
        openAlbum(album);
      });
      artistGrid.appendChild(card);
    });
    albumsGrid.appendChild(artistGrid);
  });
}

// ------------ EL RESTO DE TUS FUNCIONES PRINCIPALES SIGUE IGUAL ------------
// (auth, favoritos, reproductor, playlists, overlays, etc. igual como lo ten√≠as)

</script>
</body>
</html>
