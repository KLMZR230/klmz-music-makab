<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KLMZ MUSIC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <meta name="theme-color" content="#ec4899">
    <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIktMTVogTVVTSUMiLAogICJzaG9ydF9uYW1lIjogIktMTVogTVVTSUMiLAogICJkZXNjcmlwdGlvbiI6ICJUdSBwbGF0YWZvcm1hIGRlIG3DunNpY2EgcGVyc29uYWwuIiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMxMTE4MjciLAogICJ0aGVtZV9jb2xvciI6ICIlZWM0ODk5IiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiaHR0cHM6Ly9wbGFjZWhvbGQuY28vMTkyeDE5Mi9lYzQ4OTkvd2hpdGU/dGV4dD1LTExaIiwKICAgICAgInNpemVzIjogIjE5MngxOTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciCiAgICB9LAogICAgewogICAgICAic3JjIjogImh0dHBzOi8vcGxhY2Vob2xkLmNvLzUxMng1MTIvZWM0ODk5L3doaXRlP3RleHQ9S0xNWiIsCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIiwKICAgICAgInR5cGUiOiAiaW1hZ2UvcG5nIgogICAgfQogIF0KfQ==">

    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-image: linear-gradient(rgba(15, 23, 42, 0.85), rgba(15, 23, 42, 0.85)), url('https://i.imgur.com/your-image-id.jpeg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        .hidden { display: none; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
            background: #ec4899; cursor: pointer; margin-top: -6px;
        }
        #fullscreen-player-bg {
            background-size: cover;
            background-position: center;
            filter: blur(20px) brightness(0.5);
            transform: scale(1.1);
        }
    </style>
</head>
<body class="text-white">

    <div id="global-loader" class="fixed inset-0 bg-gray-900 flex items-center justify-center z-[100]">
        <div class="w-16 h-16 border-4 border-t-pink-500 border-gray-600 rounded-full animate-spin"></div>
    </div>

    <!-- MAIN APP STRUCTURE -->
    <div id="app-container" class="opacity-0 transition-opacity duration-500">
        <!-- Header -->
        <header class="bg-white/10 backdrop-blur-lg sticky top-0 z-40 shadow-md">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <svg class="w-8 h-8 text-pink-500" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20Z" fill="currentColor"/><path d="M12 18C15.31 18 18 15.31 18 12H16C16 14.21 14.21 16 12 16V18Z" fill="currentColor"/><path d="M10 12.5C10 13.33 9.33 14 8.5 14C7.67 14 7 13.33 7 12.5C7 11.67 7.67 11 8.5 11C9.33 11 10 11.67 10 12.5Z" fill="currentColor"/><path d="M17 12.5C17 13.33 16.33 14 15.5 14C14.67 14 14 13.33 14 12.5C14 11.67 14.67 11 15.5 11C16.33 11 17 11.67 17 12.5Z" fill="currentColor"/></svg>
                    <h1 class="text-2xl font-bold tracking-tight">KLMZ MUSIC</h1>
                </div>
                <div class="flex items-center gap-4">
                     <div id="user-session" class="hidden items-center gap-4">
                        <span id="user-email" class="text-sm text-gray-300 hidden md:block"></span>
                        <button id="logout-btn" class="bg-pink-500 text-white font-semibold px-3 py-1.5 rounded-lg text-sm hover:bg-pink-600 transition-colors">Salir</button>
                    </div>
                    <button id="login-btn" class="bg-gray-200/20 text-white font-semibold px-3 py-1.5 rounded-lg text-sm hover:bg-gray-300/30 transition-colors">Admin Login</button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main id="app-view" class="container mx-auto p-4 md:p-8">
             <!-- All other content will be dynamically generated here -->
        </main>
    </div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module">
        // --- CONFIGURACIÓN DE SUPABASE Y ADMIN ---
        const SUPABASE_URL = 'https://lvrkifepqhxxmdcasncf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2cmtpZmVwcWh4eG1kY2FzbmNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMjU3NTMsImV4cCI6MjA3MDcwMTc1M30.I-jHvTMEHHrUMM1-2YQrb-58YU4KmTrJuc95GJcjzhk';
        const ADMIN_UID = 'df543cda-21d7-42a5-ae86-3b895482a171';
        // -----------------------------------------

        const { createClient } = supabase;
        let _supabase;
        
        let state = {
            albums: [],
            currentAlbum: null,
            currentUser: null,
        };

        // This function runs when the entire page is loaded and ready
        document.addEventListener('DOMContentLoaded', async () => {
            const globalLoader = document.getElementById('global-loader');
            const appContainer = document.getElementById('app-container');

            if (SUPABASE_URL.includes('TU_PROJECT_URL') || SUPABASE_ANON_KEY.includes('TU_PROJECT_API_KEY') || ADMIN_UID.includes('TU_USER_ID_AQUÍ')) {
                alert('ERROR: Debes pegar tus claves de Supabase y tu Admin UID en el archivo HTML.');
                globalLoader.classList.add('hidden');
                return;
            }

            try {
                _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                // Fetch initial session and albums
                const { data: { session } } = await _supabase.auth.getSession();
                updateUserStatus(session?.user);
                await fetchAlbums();

                // Listen for auth changes
                _supabase.auth.onAuthStateChange(async (event, session) => {
                    updateUserStatus(session?.user);
                    if (event === 'SIGNED_IN' || event === 'SIGNED_OUT') {
                        await fetchAlbums();
                    }
                });

                // Show the app and hide the loader
                appContainer.classList.remove('opacity-0');
                globalLoader.classList.add('hidden');

            } catch (error) {
                console.error("Error fatal en la inicialización:", error);
                alert("No se pudo conectar con el servidor. Revisa tu conexión o las claves de Supabase.");
                globalLoader.classList.add('hidden');
            }
        });

        function updateUserStatus(user) {
            state.currentUser = user;
            const isAdmin = user && user.id === ADMIN_UID;
            
            const loginBtn = document.getElementById('login-btn');
            const userSession = document.getElementById('user-session');
            const userEmail = document.getElementById('user-email');
            
            if (loginBtn) loginBtn.classList.toggle('hidden', isAdmin);
            if (userSession) userSession.classList.toggle('hidden', !isAdmin);
            if (isAdmin && userEmail) userEmail.textContent = user.email;
        }

        async function fetchAlbums() {
            const albumGridView = document.getElementById('album-grid-view');
            if (albumGridView) {
                albumGridView.innerHTML = `<div class="col-span-full flex flex-col items-center justify-center py-12"><div class="w-12 h-12 border-4 border-t-pink-500 border-gray-600 rounded-full animate-spin"></div><p class="mt-4 text-gray-300">Cargando álbumes...</p></div>`;
            }
            
            try {
                const { data, error } = await _supabase.from('albums').select('*, songs(count)').order('created_at', { ascending: false });
                if (error) throw error;
                state.albums = data;
                renderAlbumGrid();
            } catch (error) {
                console.error("Error fetching albums:", error);
                if (albumGridView) {
                    albumGridView.innerHTML = `<p class="col-span-full text-center text-red-500">No se pudieron cargar los álbumes.</p>`;
                }
            }
        }

        function renderAlbumGrid() {
            const mainView = document.getElementById('app-view');
            mainView.innerHTML = `
                <div id="album-grid-view">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold">Álbumes</h2>
                        <button id="add-album-btn" class="bg-pink-500 font-semibold px-4 py-2 rounded-lg shadow-md hover:bg-pink-600 ${state.currentUser && state.currentUser.id === ADMIN_UID ? '' : 'hidden'}">+ Añadir Álbum</button>
                    </div>
                    <div id="album-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 md:gap-6"></div>
                    <p id="no-albums-msg" class="col-span-full text-center text-gray-400 mt-12 text-lg ${state.albums.length === 0 ? '' : 'hidden'}">No hay álbumes todavía.</p>
                </div>`;

            const albumGrid = document.getElementById('album-grid');
            state.albums.forEach(album => {
                const songCount = album.songs[0]?.count || 0;
                const el = document.createElement('div');
                el.className = 'group cursor-pointer';
                el.innerHTML = `<div class="aspect-square rounded-lg overflow-hidden shadow-lg transform group-hover:scale-105 transition-transform duration-300"><img src="${album.cover_url}" alt="${album.title}" class="w-full h-full object-cover" loading="lazy"></div><p class="mt-2 font-semibold truncate">${album.title}</p><p class="text-sm text-gray-400">${songCount} canci${songCount === 1 ? 'ón' : 'ones'}</p>`;
                el.addEventListener('click', () => showAlbumDetail(album.id));
                albumGrid.appendChild(el);
            });
            
            document.getElementById('add-album-btn').addEventListener('click', () => {
                // Future implementation for adding albums
            });
        }
        
        async function showAlbumDetail(albumId) {
            const mainView = document.getElementById('app-view');
            mainView.innerHTML = `<div class="col-span-full flex flex-col items-center justify-center py-12"><div class="w-12 h-12 border-4 border-t-pink-500 border-gray-600 rounded-full animate-spin"></div><p class="mt-4 text-gray-300">Cargando detalle...</p></div>`;

            try {
                const { data: album, error: albumError } = await _supabase.from('albums').select('*').eq('id', albumId).single();
                if (albumError) throw albumError;
                const { data: songs, error: songsError } = await _supabase.from('songs').select('*').eq('album_id', albumId).order('created_at');
                if (songsError) throw songsError;
                
                state.currentAlbum = { ...album, songs };
                
                mainView.innerHTML = `
                    <div id="album-detail-view">
                        <button id="back-to-grid-btn" class="mb-6 flex items-center gap-2 text-gray-300 hover:text-pink-400"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>Volver</button>
                        <div class="flex flex-col md:flex-row gap-8">
                            <div class="md:w-1/3 flex-shrink-0">
                                <img src="${album.cover_url}" alt="Album Cover" class="w-full aspect-square rounded-xl shadow-2xl object-cover">
                                <h2 class="text-3xl font-bold mt-4">${album.title}</h2>
                                <p class="text-gray-400 mt-1">${songs.length} canci${songs.length === 1 ? 'ón' : 'ones'}</p>
                            </div>
                            <div class="md:w-2/3">
                                <h3 class="text-2xl font-semibold mb-4">Canciones</h3>
                                <ul id="song-list" class="space-y-2"></ul>
                            </div>
                        </div>
                    </div>`;

                const songList = document.getElementById('song-list');
                songs.forEach((song, index) => {
                    const el = document.createElement('li');
                    el.className = 'flex items-center justify-between p-3 rounded-lg hover:bg-white/10 cursor-pointer transition-colors';
                    el.innerHTML = `<div class="flex items-center gap-4"><div class="w-8 text-center text-gray-400">${index + 1}</div><span class="font-medium">${song.title}</span></div>`;
                    songList.appendChild(el);
                });

                document.getElementById('back-to-grid-btn').addEventListener('click', renderAlbumGrid);

            } catch (error) {
                console.error("Error showing album detail:", error);
                mainView.innerHTML = `<p class="col-span-full text-center text-red-500">No se pudo cargar el detalle del álbum.</p>`;
            }
        }
        
        // Add other functions like player logic, modals, etc. here as needed.
        // For now, this focuses on the core loading and display logic.

    </script>
</body>
</html>
