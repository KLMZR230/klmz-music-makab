<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>KLMZ MUSIC</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1DB954">
    <link rel="manifest" href="./manifest.json">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Metal+Mania&display=swap');
        * { box-sizing: border-box; }
        body { margin: 0; font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; background: #181818; color: #fff; padding-bottom: 84px; transition: all 0.3s ease; }
        header { background: #121212; padding: 1rem 1.5rem; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; transition: all 0.3s ease; }
        .logo { font-weight: bold; font-size: 1.4rem; letter-spacing: 1px; transition: all 0.3s ease; }
        .user-actions { display:flex; align-items: center; gap:.5rem; }
        .lock-icon { cursor:pointer; font-size:1.4rem; color:#fff; user-select:none; transition: all 0.3s ease; }
        .lock-icon:hover { opacity:.7;}
        .theme-selector { display: flex; align-items: center; gap: 0.3rem; margin-right: 0.5rem; }
        .theme-selector label { font-size: 0.7rem; color: #b3b3b3; }
        .theme-selector select { background: #333; color: #fff; border: 1px solid #555; border-radius: 4px; padding: 0.1rem 0.2rem; font-size: 0.7rem; cursor: pointer; transition: all 0.3s ease; }
        .app-container { display: flex; min-height: calc(100vh - 60px);}
        main { flex:1; padding:1rem; max-width:900px; margin:0 auto;}
        #search-input { width: 100%; padding: 1rem; background: #242424; border: none; border-radius: 4px; color: #fff; margin-bottom: 2rem; transition: all 0.3s ease; }
        .section-title { font-size:1.8rem; font-weight:bold; margin-bottom:1.5rem; transition: all 0.3s ease; }
        .album-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(140px,1fr)); gap:1.5rem;}
        .album-card { background:none; padding:0; cursor:pointer; display:flex; flex-direction:column; align-items:center; text-align:center; transition: all 0.3s ease; border: 2px solid transparent; border-radius: 12px; }
        .album-card:hover { transform:scale(1.05); }
        .album-img { border-radius:50%; width:100px; height:100px; object-fit:cover; margin-bottom:.7rem; background:#333; transition: all 0.3s ease; }
        .album-title { font-size:.98rem; font-weight: bold; margin-bottom: 0.4rem; transition: all 0.3s ease; }
        .album-artist { font-size: .9rem; color: #b3b3b3; transition: all 0.3s ease; }
        .song-list { width:100%; margin-top:1rem; padding-bottom: 120px; }
        .song-list ul { list-style:none; padding:0; margin:0;}
        .song-list li { padding:.7rem; cursor:pointer; color:#1db954; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center; transition: all 0.3s ease;}
        .song-list li:hover { color:#fff; background: rgba(255,255,255,.05);}
        .play-icon { font-size: 1.1rem; }
        .bottom-nav { position: fixed; left: 0; right: 0; bottom: 20px; background: #181818; border-top: 1px solid #272727; display: flex; height: 64px; z-index: 5000; transition: all 0.3s ease; }
        .bottom-nav-item { color: #b3b3b3; text-align: center; flex: 1; font-size: 1.14rem; padding: 4px 0 0 0; border-radius: 7px; cursor: pointer; display: flex; flex-direction: column; align-items: center; transition: all 0.3s ease;}
        .bottom-nav-item.active { color: #1DB954; background: rgba(29,185,84,.09);}
        .bottom-nav-item:hover {background:rgba(255,255,255,0.05);}
        .bottom-nav-item .icon { font-size: 1.12rem; }
        .bottom-nav-item small { font-size: 0.67rem;}
        .content-section { display: none; }
        .content-section.active { display: block; }
        .copyright { position: fixed; bottom: 0; left: 0; width: 100%; height: 20px; background: #0a0a0a; color: #666; font-size: 0.7rem; text-align: center; padding: 2px 0; z-index: 10000; border-top: 1px solid #222; }
        .loading-indicator { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.9); color: #fff; padding: 1.5rem 2.5rem; border-radius: 12px; font-size: 1rem; z-index: 2000; border: 2px solid #1DB954; }
        .modal { position: fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,.80); display:none; align-items:center; justify-content:center; z-index:2000; transition: all 0.3s ease;}
        .modal-content { background:#282828; padding:2rem; border-radius:8px; width:95%; max-width:430px; max-height:90vh; overflow-y:auto; transition: all 0.3s ease; }
        .form-group { margin-bottom:1rem;}
        .form-group label { display:block; margin-bottom:0.5rem;}
        .form-group input, .form-group select { width:100%; padding:.7rem; background:#404040; border:1px solid #555; border-radius:4px; color:#fff; transition: all 0.3s ease;}
        .btn-primary { background:#1DB954; color:#fff; border:none; padding:.7rem 1.5rem; border-radius:999px; cursor:pointer; width:100%; margin-top:.7rem; transition: all 0.3s ease; }
        .btn-primary:hover { background:#1ed760; }
        .close-modal { position:absolute; top:1rem; right:1rem; background:none; border:none; color:#fff; font-size:1.2rem; cursor:pointer;}
        .user-menu { position: relative; display: inline-block; }
        .user-dropdown { display: none; position: absolute; right: 0; top: calc(100% + 10px); background: #282828; min-width: 200px; border-radius: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); z-index: 1000; border: 1px solid #404040; transition: all 0.3s ease; }
        .user-dropdown.show { display: block; animation: dropdownFadeIn 0.2s ease; }
        .user-dropdown-item { padding: 0.8rem 1rem; cursor: pointer; border-bottom: 1px solid #404040; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; transition: all 0.3s ease; }
        .user-dropdown-item:last-child { border-bottom: none; }
        .user-dropdown-item:hover { background: #404040; }
        .user-dropdown-item.logout { color: #ff4757; border-top: 1px solid #404040; margin-top: 0.3rem; }
        .user-info { padding: 0.8rem 1rem; border-bottom: 2px solid #404040; font-size: 0.85rem; color: #b3b3b3; }
        .user-info strong { color: #fff; font-size: 0.9rem; }
        @keyframes dropdownFadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div class="loading-indicator" id="loading-indicator" style="display:none;">üéµ Cargando...</div>
    <header>
        <span class="logo">KLMZ MUSIC</span>
        <div class="user-actions">
            <div class="theme-selector">
                <label for="theme-select">Tema:</label>
                <select id="theme-select" onchange="changeTheme(this.value)">
                    <option value="default">üéµ Default</option>
                    <option value="neon">‚ö° Neon Cyberpunk</option>
                    <option value="fire">üî• Fuego Infernal</option>
                </select>
            </div>
            <div class="user-menu">
                <div class="lock-icon" id="header-lock-icon" onclick="toggleUserMenu()">üë§</div>
                <div class="user-dropdown" id="user-dropdown">
                    <div class="user-info" id="user-info-section" style="display: none;">
                        <div><strong id="user-email-display"></strong></div>
                        <div id="user-role-display">Usuario</div>
                    </div>
                    <div class="user-dropdown-item" onclick="showAuth('login')" id="login-menu-item"><span>üîê</span><span>Iniciar Sesi√≥n</span></div>
                    <div class="user-dropdown-item logout" onclick="confirmLogout()" id="logout-menu-item" style="display: none;"><span>üö™</span><span>Cerrar Sesi√≥n</span></div>
                </div>
            </div>
        </div>
    </header>
    <div class="app-container">
        <main>
            <section class="content-section active" id="home-section">
                <div class="section-title">Albums</div>
                <div class="album-grid" id="albums"><div style="text-align: center; padding: 2rem;">Cargando √°lbumes...</div></div>
            </section>
            <section class="content-section" id="search-section">
                <div class="section-title">Buscar m√∫sica</div>
                <input type="text" placeholder="¬øQu√© quieres escuchar?" id="search-input" onkeyup="searchMusic()">
                <div id="search-results"></div>
            </section>
            <section class="content-section" id="favorites-section">
                <div class="section-title">‚ù§Ô∏è Mis Favoritos</div>
                <div id="favorites-content"><div style="text-align: center; padding: 2rem;">No tienes favoritos</div></div>
            </section>
        </main>
    </div>
    <nav class="bottom-nav">
        <div class="bottom-nav-item active" onclick="showSection('home')" id="nav-home"><span class="icon">‚åÇ</span><small>Inicio</small></div>
        <div class="bottom-nav-item" onclick="showSection('search')" id="nav-search"><span class="icon">‚åï</span><small>Buscar</small></div>
        <div class="bottom-nav-item" onclick="showSection('favorites')" id="nav-favs"><span class="icon">‚ô°</span><small>Favoritos</small></div>
    </nav>
    <div class="modal" id="auth-modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeAuth()">&times;</button>
            <div id="login-form">
                <h2>Iniciar sesi√≥n</h2>
                <form onsubmit="login(event)" enctype="application/x-www-form-urlencoded">
                    <div class="form-group"><label>Email:</label><input type="email" id="login-email" required></div>
                    <div class="form-group"><label>Contrase√±a:</label><input type="password" id="login-password" required></div>
                    <button type="submit" class="btn-primary">Iniciar sesi√≥n</button>
                </form>
            </div>
        </div>
    </div>
    <div class="copyright">¬© 2025 KLMZ MUSIC - Desarrollado por Freddy Granados</div>
    <audio id="audio-player" preload="metadata"></audio>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ‚úÖ VARIABLES GLOBALES CORRECTAS
        let allAlbums = [];
        let allSongs = [];
        let currentUser = null;
        let supabase = null;
        
        // ‚úÖ CONSTANTES
        const supabaseUrl = 'https://nqbldvpnqhngdtalvzov.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xYmxkdnBucWhuZ2R0YWx2em92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyMjY0NjUsImV4cCI6MjA3MDgwMjQ2NX0.Zzg5D219sW7bhvl0_R5ypX9MF6nRzBSDIeo2Lvebab0';
        const ADMIN_EMAIL = 'klmzr@gmail.com';

        // ‚úÖ FUNCI√ìN UPLOADFILE CORREGIDA - SIN mode: 'no-cors'
        async function uploadFile(file, onProgress) {
            try {
                console.log('üöÄ Iniciando subida a R2:', file.name);
                
                const functionUrl = 'https://nqbldvpnqhngdtalvzov.supabase.co/functions/v1/generate-upload-url';
                
                const response = await fetch(functionUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${supabaseKey}`,
                        'apikey': supabaseKey
                    },
                    body: JSON.stringify({ 
                        fileName: file.name, 
                        contentType: file.type,
                        fileSize: file.size 
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Error del servidor: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                if (!data.signedUrl) {
                    throw new Error('No se recibi√≥ URL firmada del servidor');
                }
                
                console.log('‚úÖ URL firmada obtenida, subiendo a R2...');
                
                // ‚úÖ SIN mode: 'no-cors' - ESTO CAUSABA EL ERROR
                const uploadResponse = await fetch(data.signedUrl, {
                    method: 'PUT',
                    body: file,
                    headers: {
                        'Content-Type': file.type
                    }
                });

                if (!uploadResponse.ok) {
                    throw new Error(`Error al subir a R2: ${uploadResponse.status} ${uploadResponse.statusText}`);
                }
                
                console.log('‚úÖ Archivo subido exitosamente a R2');
                
                const publicUrl = data.publicUrl || `https://pub-943d9fd3a7704f19a27dd4b375e3f126.r2.dev/${data.fileName}`;
                
                console.log('‚úÖ URL p√∫blica:', publicUrl);
                return publicUrl;
                
            } catch (error) {
                console.error("üí• Error detallado en la subida:", error);
                throw new Error(error.message || 'Error desconocido al subir el archivo.');
            }
        }

        // ‚úÖ INICIALIZACI√ìN CORREGIDA
        async function loadSupabase() { 
            console.log('üîÑ Iniciando loadSupabase...');
            showLoadingIndicator(true); 
            
            try { 
                if (!window.supabase || !window.supabase.createClient) {
                    throw new Error('Supabase SDK no est√° disponible');
                }
                
                supabase = window.supabase.createClient(supabaseUrl, supabaseKey); 
                console.log('‚úÖ Cliente Supabase creado');
                
                await loadAllData(); 
                console.log('‚úÖ loadSupabase completado');
                
            } catch (error) { 
                console.error('üí• Error en loadSupabase:', error);
                document.getElementById('albums').innerHTML = `
                    <div style="text-align: center; padding: 3rem;">
                        <h2>‚ùå Error de conexi√≥n</h2>
                        <p>Error: ${error.message}</p>
                        <button onclick="location.reload()" style="background:#1DB954;color:#fff;border:none;padding:0.7rem;border-radius:4px;cursor:pointer;">üîÑ Recargar</button>
                    </div>`; 
            } finally { 
                showLoadingIndicator(false); 
            } 
        }

        async function loadAllData() { 
            console.log('üîÑ Cargando datos...');
            try { 
                const { data: albums, error: albumsError } = await supabase
                    .from('albums')
                    .select('*')
                    .order('created_at', { ascending: false }); 
                    
                if (albumsError) throw albumsError;
                
                console.log('‚úÖ √Ålbumes obtenidos:', albums?.length || 0);
                allAlbums = albums || []; 
                displayAlbums(allAlbums); 
                
            } catch (error) { 
                console.error('üí• Error cargando datos:', error);
                document.getElementById('albums').innerHTML = `
                    <div style="text-align: center; padding: 3rem;">
                        <h2>‚ùå Error cargando datos</h2>
                        <p>${error.message}</p>
                    </div>`; 
            }
        }
        
        function displayAlbums(albums) { 
            const container = document.getElementById('albums'); 
            if (!albums || albums.length === 0) { 
                container.innerHTML = '<div style="text-align: center; padding: 3rem;"><h2>üìÄ No hay √°lbumes</h2></div>'; 
                return; 
            } 
            container.innerHTML = albums.map(album => 
                `<div class="album-card">
                    <img class="album-img" src="${album.cover_url}" alt="${album.title}" loading="lazy">
                    <div class="album-title">${album.title}</div>
                    <div class="album-artist">${album.artist}</div>
                </div>`
            ).join(''); 
        }

        function showLoadingIndicator(show) { 
            const indicator = document.getElementById('loading-indicator'); 
            if (indicator) indicator.style.display = show ? 'block' : 'none'; 
        }

        window.showSection = function(section) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active')); 
            document.getElementById(`${section}-section`).classList.add('active'); 
            document.querySelectorAll('.bottom-nav-item').forEach(a => a.classList.remove('active')); 
            const navItem = document.getElementById(`nav-${section === 'home' ? 'home' : section === 'search' ? 'search' : 'favs'}`); 
            if(navItem) navItem.classList.add('active'); 
        }

        window.changeTheme = function(theme) {
            document.body.className = '';
            if (theme && theme !== 'default') {
                document.body.classList.add('theme-' + theme);
            }
        }

        window.toggleUserMenu = function() {
            document.getElementById('user-dropdown').classList.toggle('show');
        }

        window.showAuth = function(type) {
            document.getElementById('auth-modal').style.display = 'flex';
        }

        window.closeAuth = function() {
            document.getElementById('auth-modal').style.display = 'none';
        }

        window.confirmLogout = function() {
            console.log('Logout');
        }

        window.login = async function(event) {
            event.preventDefault();
            console.log('Login attempt');
        }

        window.searchMusic = function() {
            const query = document.getElementById('search-input').value.toLowerCase().trim(); 
            const results = document.getElementById('search-results'); 
            if (!query) { 
                results.innerHTML = ''; 
                return; 
            } 
            results.innerHTML = '<h3>üîç Buscando...</h3>';
        }
        
        // ‚úÖ INICIALIZAR AL CARGAR LA P√ÅGINA
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ P√°gina cargada, iniciando...');
            loadSupabase().catch(console.error);
        });
    </script>
</body>
</html>
