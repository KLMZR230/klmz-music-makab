<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KLMZ MUSIC</title>
<meta name="description" content="KLMZ MUSIC - Tu plataforma de m√∫sica personal" />
<meta name="theme-color" content="#1db954" />
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{--bg:#121212;--panel:#181818;--panel2:#1f1f1f;--text:#fff;--muted:#b3b3b3;--brand:#1db954;--brand-hover:#17a84b;--stroke:#2a2a2a;--accent:#ff6b35;--error:#ff4444;--warning:#ffab00;--success:#4caf50;}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;padding-bottom:70px;overflow-x:hidden}
  @keyframes fadeIn{from{opacity:0}to{opacity:1}}
  @keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
  @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
  @keyframes wave{0%,40%,100%{height:15px;background:linear-gradient(to top,var(--brand),var(--accent))}20%{height:35px;background:linear-gradient(to top,var(--accent),#ffab00)}}
  @keyframes bounce{0%,20%,50%,80%,100%{transform:translateY(0)}40%{transform:translateY(-10px)}60%{transform:translateY(-5px)}}
  .fade-in{animation:fadeIn 0.5s ease}
  .slide-up{animation:slideUp 0.3s ease}
  .bounce{animation:bounce 1s}
  .loading{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;flex-direction:column;z-index:9999;transition:opacity 0.3s ease}
  .loading .spinner{width:50px;height:50px;border:3px solid var(--stroke);border-top:3px solid var(--brand);border-radius:50%;animation:spin 1s linear infinite}
  .loading .text{margin-top:20px;color:var(--muted);font-weight:600}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#1db954 0%,#1db954 60%,#179b47 100%);padding:14px 18px;font-weight:800;letter-spacing:.3px;backdrop-filter:blur(10px)}
  header .row{display:flex;align-items:center;gap:12px;justify-content:space-between}
  .brand{font-size:20px;display:flex;align-items:center;gap:8px;transition:transform 0.3s ease}
  .brand:hover{transform:scale(1.05)}
  .brand .logo{display:inline-grid;place-items:center;width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,#ff6b35,#ff4500);font-weight:900;color:#fff;font-size:16px;transition:all 0.3s ease}
  .brand .logo:hover{transform:rotate(360deg)}
  .tools{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{background:var(--brand);border:none;color:#fff;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:600;transition:all 0.3s ease}
  .btn:hover{background:var(--brand-hover);transform:translateY(-2px);box-shadow:0 4px 8px rgba(29,185,84,0.3)}
  .btn.ghost{background:transparent;border:1px solid #fff1}
  .btn.small{padding:6px 10px;font-size:12px}
  .icon-btn{background:transparent;border:1px solid #ffffff22;color:#fff;padding:8px 10px;border-radius:10px;cursor:pointer;font-size:18px;line-height:1;transition:all 0.3s ease}
  .icon-btn:hover{background:#ffffff14;transform:scale(1.1)}
  .container{padding:18px;max-width:1100px;margin:auto}
  .card{background:var(--panel);border:1px solid var(--stroke);border-radius:14px;padding:14px;transition:all 0.3s ease}
  .grid{display:grid;gap:16px}
  .grid.albums{grid-template-columns:repeat(auto-fill,minmax(90px,1fr))}
  .grid.playlists{grid-template-columns:repeat(auto-fill,minmax(120px,1fr))}
  .album-card,.playlist-card{background:transparent;border:none;padding:8px;cursor:pointer;text-align:center;transition:.3s all ease;border-radius:12px}
  .album-card:hover,.playlist-card:hover{transform:translateY(-4px) scale(1.02);background:var(--panel)}
  .album-cover,.playlist-cover{width:100%;aspect-ratio:1/1;object-fit:cover;background:#0b0b0b;border:1px solid var(--stroke);transition:all 0.3s ease}
  .album-cover{border-radius:50%}
  .playlist-cover{border-radius:12px;background:linear-gradient(135deg,var(--brand),#2e7d32);display:flex;align-items:center;justify-content:center;font-size:2rem}
  .album-title,.playlist-title{margin:8px 2px 0;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:.92rem}
  .album-meta,.playlist-meta{margin:0;color:var(--muted);font-size:.78rem}
  .muted{color:var(--muted)}
  .section-title{margin:6px 2px 12px;font-size:1.1rem;font-weight:800;letter-spacing:.2px;position:relative}
  .section-title::before{content:'';position:absolute;bottom:-4px;left:0;width:30px;height:2px;background:var(--brand);border-radius:2px}
  .inputs{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  input[type="text"],input[type="email"],input[type="password"],select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--stroke);background:#101010;color:#fff;transition:all 0.3s ease}
  input:focus,select:focus,textarea:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 2px rgba(29,185,84,0.2)}
  textarea{min-height:60px;resize:vertical}
  input[type="file"]{width:100%;padding:10px;border-radius:10px;border:1px dashed var(--stroke);background:#0f0f0f;color:var(--muted)}
  .stack{display:grid;gap:10px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .pill{padding:6px 10px;border-radius:999px;background:#ffffff10;border:1px solid var(--stroke);font-size:.8rem;color:#fff}
  .music-controls{display:flex;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap}
  .control-btn{background:var(--panel);border:1px solid var(--stroke);color:var(--muted);padding:8px 12px;border-radius:20px;cursor:pointer;font-size:12px;transition:all 0.3s ease;display:flex;align-items:center;gap:6px}
  .control-btn:hover{background:var(--brand);color:white;transform:scale(1.05)}
  .control-btn.active{background:var(--brand);color:white}
  .favorite-btn{background:none;border:none;color:var(--muted);cursor:pointer;font-size:18px;transition:all 0.3s ease;padding:4px;border-radius:50%}
  .favorite-btn:hover{color:#ff4444;transform:scale(1.2)}
  .favorite-btn.active{color:#ff4444}
  .download-btn{background:var(--success);border:none;color:white;padding:6px 10px;border-radius:15px;cursor:pointer;font-size:11px;transition:all 0.3s ease;display:flex;align-items:center;gap:4px}
  .download-btn:hover{background:#45a049;transform:scale(1.05)}
  .download-btn.downloaded{background:var(--muted);cursor:default}
  .search-bar{position:relative;margin-bottom:20px}
  .search-input{width:100%;padding:12px 48px 12px 16px;border-radius:25px;border:1px solid var(--stroke);background:var(--panel);color:var(--text);font-size:16px;transition:all 0.3s ease}
  .search-input:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 3px rgba(29,185,84,0.2)}
  .search-input::placeholder{color:var(--muted)}
  .search-icon{position:absolute;right:16px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:18px;pointer-events:none}
  .search-clear{position:absolute;right:16px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--muted);cursor:pointer;font-size:18px;padding:4px;border-radius:50%;display:none}
  .search-results{display:none}
  .search-songs-list{display:flex;flex-direction:column;gap:8px}
  .search-song-item{display:flex;align-items:center;gap:12px;padding:8px 12px;border-radius:8px;cursor:pointer;transition:all 0.3s ease}
  .search-song-item:hover{background:var(--panel);transform:translateX(4px)}
  .search-song-cover{width:48px;height:48px;border-radius:8px;object-fit:cover;background:#0b0b0b;border:1px solid var(--stroke)}
  .search-song-info{flex:1;min-width:0}
  .search-song-title{font-weight:600;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:2px}
  .search-song-artist{color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .search-song-actions{display:flex;gap:8px;align-items:center}
  .search-song-play{background:var(--brand);border:none;color:white;width:32px;height:32px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;transition:all 0.3s ease}
  .search-song-play:hover{background:var(--brand-hover);transform:scale(1.1)}
  .no-results{text-align:center;color:var(--muted);padding:40px 20px;font-size:16px}
  #albumView,#playlistView,#favoritesView,#downloadsView{display:none}
  .album-hero{display:flex;gap:14px;align-items:center;margin-bottom:20px}
  .album-hero img{width:96px;height:96px;border-radius:12px;border:1px solid var(--stroke);object-fit:cover;background:#0b0b0b}
  .album-hero .info{min-width:0;flex:1}
  .album-hero .title{font-size:1.2rem;font-weight:900}
  .album-hero .meta{color:var(--muted);font-size:.9rem}
  .song-plain-list{margin-top:8px}
  .song-plain-item{padding:12px 8px;border-bottom:1px solid #1f1f1f;display:flex;align-items:center;gap:12px;transition:all 0.3s ease;border-radius:8px;margin-bottom:2px}
  .song-plain-item:last-child{border-bottom:none}
  .song-plain-item:hover{background:var(--panel);transform:translateX(4px)}
  .song-plain-item .idx{min-width:20px;text-align:right;color:var(--muted)}
  .song-plain-item .title{flex:1;font-weight:600}
  .song-plain-item .more{font-size:18px;color:var(--muted);cursor:pointer;padding:6px;border-radius:50%;transition:all 0.3s ease}
  .song-plain-item .more:hover{background:#ffffff14;transform:scale(1.2)}
  .backline{display:flex;align-items:center;gap:10px;margin-bottom:20px}
  .back-btn{background:transparent;border:1px solid #ffffff22;color:#fff;width:36px;height:36px;border-radius:10px;font-size:18px;display:grid;place-items:center;cursor:pointer;transition:all 0.3s ease}
  .back-btn:hover{background:#ffffff14;transform:scale(1.1)}
  .player{position:fixed;left:0;right:0;bottom:70px;background:linear-gradient(135deg,#181818,#1f1f1f);border-top:1px solid var(--stroke);padding:14px 16px;z-index:20;display:none}
  .player.show{display:block}
  .player .wrap{display:grid;grid-template-columns:1fr;gap:12px;align-items:center}
  .np{display:flex;align-items:center;gap:12px;min-width:0}
  .np img{width:68px;height:68px;border-radius:12px;border:1px solid var(--stroke);object-fit:cover;background:#0b0b0b}
  .np .titles{min-width:0}
  .np .titles .t{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:1rem}
  .np .titles .a{color:var(--muted);font-size:.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .controls{display:flex;flex-direction:column;gap:10px}
  .controls .buttons{display:flex;align-items:center;justify-content:center;gap:18px}
  .controls .buttons .circle{width:64px;height:64px;border-radius:50%;display:grid;place-items:center;border:1px solid var(--stroke);background:linear-gradient(135deg,#222,#333);font-size:26px;font-weight:900;cursor:pointer;transition:all 0.3s ease}
  .controls .buttons .circle:hover{transform:scale(1.1)}
  .controls .buttons .sm{width:52px;height:52px;font-size:22px}
  .controls .seek{display:flex;align-items:center;gap:10px}
  .controls input[type="range"]{width:100%}
  .right{display:flex;justify-content:space-between;gap:10px;align-items:center}
  .vol{display:flex;align-items:center;gap:8px}
  .tag{padding:4px 8px;border:1px solid var(--stroke);border-radius:8px;font-size:.8rem;color:var(--muted)}
  #bottomBar{position:fixed;bottom:0;left:0;width:100%;height:70px;background:linear-gradient(135deg,var(--panel2),#252525);border-top:1px solid var(--stroke);display:grid;grid-template-columns:1fr 1fr 1fr 1fr;place-items:center;padding:8px 20px 4px;z-index:40}
  #bottomBar button{background:transparent;border:none;color:var(--muted);cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:4px;font-size:10px;font-weight:500;text-transform:uppercase;letter-spacing:0.5px;user-select:none;transition:all 0.3s ease;padding:8px;border-radius:12px;position:relative}
  #bottomBar button.active,#bottomBar button:hover{color:var(--brand);transform:translateY(-2px)}
  #bottomBar .icon{width:28px;height:28px;stroke:currentColor;stroke-width:2;fill:none}
  #bottomBar .label{font-size:10px;font-weight:600;margin-top:2px}
  .soundwave{width:100px;height:40px;display:flex;align-items:center;gap:4px}
  .bar{width:6px;height:15px;background:linear-gradient(to top,var(--brand),var(--accent));border-radius:3px;animation:wave 1.2s infinite ease-in-out;animation-fill-mode:both}
  .bar:nth-child(1){animation-delay:-1.1s}
  .bar:nth-child(2){animation-delay:-0.9s}
  .bar:nth-child(3){animation-delay:-0.7s}
  .bar:nth-child(4){animation-delay:-0.5s}
  .bar:nth-child(5){animation-delay:-0.3s}
  .status-indicator{position:fixed;top:80px;right:20px;z-index:100}
  .error-msg{background:linear-gradient(135deg,var(--error),#cc0000);color:white;padding:12px 16px;border-radius:8px;font-size:12px;font-weight:600}
  .success-msg{background:linear-gradient(135deg,var(--success),#2e7d32);color:white;padding:12px 16px;border-radius:8px;font-size:12px;font-weight:600}
  .warning-msg{background:linear-gradient(135deg,var(--warning),#f57f17);color:black;padding:12px 16px;border-radius:8px;font-size:12px;font-weight:600}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:60}
  .modal.show{display:flex}
  .modal-content{background:var(--panel);border:1px solid var(--stroke);border-radius:16px;padding:24px;max-width:450px;width:90%}
  .dropdown{position:absolute;background:var(--panel);border:1px solid var(--stroke);border-radius:12px;min-width:200px;box-shadow:0 8px 32px rgba(0,0,0,0.8);z-index:1000;display:none}
  .dropdown.show{display:block}
  .dropdown-item{padding:12px 16px;cursor:pointer;border-bottom:1px solid var(--stroke);font-size:13px}
  .dropdown-item:last-child{border-bottom:none}
  .dropdown-item:hover{background:var(--panel2)}
  .dropdown-item.create-new{color:var(--brand);font-weight:600}
  @media (max-width:800px){.inputs{grid-template-columns:1fr}.np img{width:72px;height:72px}.controls .buttons .circle{width:76px;height:76px;font-size:30px}.controls .buttons .sm{width:60px;height:60px;font-size:24px}}
</style>
</head>
<body>
<div id="loadingScreen" class="loading">
  <div class="spinner"></div>
  <div class="text">Cargando KLMZ MUSIC...</div>
</div>

<header>
  <div class="row">
    <div class="brand">
      <span class="logo">üî•</span> 
      KLMZ MUSIC
    </div>
    <div class="tools">
      <span class="muted" id="albumsTitle">Tu m√∫sica</span>
      <button class="icon-btn" id="btn-login" title="Admin" onclick="showLogin()">üîë</button>
      <button class="btn ghost" id="btn-logout" style="display:none" onclick="logout()">Salir</button>
    </div>
  </div>
</header>

<div class="container">
  <div class="row muted" style="margin-bottom:20px;">
    <span class="tag">Cat√°logo p√∫blico</span>
    <span id="adminTag" class="tag" style="display:none">Admin</span>
    <span id="userTag" class="tag" style="display:none">Usuario</span>
    <span id="offlineTag" class="tag" style="display:none;background:var(--success)">Offline</span>
  </div>

  <div id="musicControls" class="music-controls" style="display:none;">
    <button class="control-btn" id="shuffleBtn" onclick="toggleShuffle()" title="Aleatorio">
      <span>üîÄ</span> Shuffle
    </button>
    <button class="control-btn" id="repeatBtn" onclick="toggleRepeat()" title="Repetir">
      <span>üîÅ</span> Repeat
    </button>
    <button class="control-btn" onclick="showFavorites()" title="Favoritos">
      <span>‚ù§Ô∏è</span> Favoritos
    </button>
    <button class="control-btn" onclick="showDownloads()" title="Descargas">
      <span>üì•</span> Offline
    </button>
  </div>

  <div id="searchSection" class="search-bar" style="display:none;">
    <input type="text" id="searchInput" class="search-input" placeholder="Buscar √°lbumes, canciones o playlists..." oninput="performSearch(this.value)" />
    <span id="searchIcon" class="search-icon">üîç</span>
    <button id="searchClear" class="search-clear" onclick="clearSearch()" style="display:none;">√ó</button>
  </div>

  <div id="searchResults" class="search-results">
    <div id="searchSongsSection" style="display:none;">
      <div class="section-title">üéµ Canciones <span id="songsCount" style="background:var(--stroke);color:var(--muted);padding:2px 8px;border-radius:12px;font-size:12px">0</span></div>
      <div id="searchSongsList" class="search-songs-list"></div>
    </div>
    <div id="noResults" class="no-results" style="display:none;">
      <div style="font-size:48px;margin-bottom:16px">üîç</div>
      <div>No se encontraron resultados</div>
    </div>
  </div>

  <div id="favoritesView" style="display:none;">
    <div class="backline">
      <button class="back-btn" onclick="closeFavoritesView()" title="Volver">‚Üê</button>
      <span class="muted">Volver</span>
    </div>
    <div class="section-title">‚ù§Ô∏è Mis Favoritos</div>
    <div id="favoritesList" class="search-songs-list"></div>
    <div id="emptyFavorites" class="no-results" style="display:none;">
      <div style="font-size:48px;margin-bottom:16px">‚ù§Ô∏è</div>
      <div>No tienes favoritos a√∫n</div>
    </div>
  </div>

  <div id="downloadsView" style="display:none;">
    <div class="backline">
      <button class="back-btn" onclick="closeDownloadsView()" title="Volver">‚Üê</button>
      <span class="muted">Volver</span>
    </div>
    <div class="section-title">üì• M√∫sica Offline</div>
    <div id="downloadsList" class="search-songs-list"></div>
    <div id="emptyDownloads" class="no-results" style="display:none;">
      <div style="font-size:48px;margin-bottom:16px">üì•</div>
      <div>No tienes m√∫sica offline</div>
    </div>
  </div>
  
  <div id="adminPanel" class="card stack" style="display:none">
    <div class="section-title">Panel Admin</div>
    <div class="inputs">
      <div class="stack">
        <div class="pill">Crear nuevo √°lbum</div>
        <input id="albumTitle" type="text" placeholder="T√≠tulo del √°lbum" />
        <input id="albumCover" type="file" accept="image/*" />
        <button class="btn" onclick="uploadAlbum()">Subir √Ålbum</button>
      </div>
      <div class="stack">
        <div class="pill">Agregar canciones a un √°lbum existente</div>
        <select id="albumSelect"></select>
        <input id="songTitle" type="text" placeholder="T√≠tulo de la canci√≥n (opcional si subes 1)" />
        <input id="songFiles" type="file" accept="audio/*" multiple />
        <button class="btn" onclick="uploadSong()">Subir Canciones</button>
      </div>
      <div class="stack">
        <div class="pill">Borrar</div>
        <select id="deleteAlbumSelect"></select>
        <button class="btn ghost" onclick="deleteAlbum()">Eliminar √Ålbum</button>
      </div>
    </div>
  </div>
  
  <div id="homeContent">
    <div class="section-title">Albums</div>
    <div id="albumsGrid" class="grid albums"></div>
    <div id="emptyAlbums" class="muted" style="display:none">No hay √°lbumes todav√≠a.</div>
  </div>
  
  <div id="albumView" class="card stack">
    <div class="backline">
      <button class="back-btn" onclick="closeAlbumView()" title="Volver">‚Üê</button>
      <span class="muted">Volver</span>
    </div>
    <div class="album-hero">
      <img id="avCover" alt="cover">
      <div class="info">
        <div id="avTitle" class="title">‚Äî</div>
        <div id="avMeta" class="meta">‚Äî</div>
      </div>
    </div>
    <div id="avSongs" class="song-plain-list"></div>
  </div>
</div>

<div class="player" id="player" onclick="openNowPlaying()">
  <div class="wrap">
    <div class="np">
      <img id="npCover" alt="cover">
      <div class="titles">
        <div id="npTitle" class="t">Cargando...</div>
        <div id="npAlbum" class="a">‚Äî</div>
      </div>
    </div>
    <div class="controls">
      <div class="buttons">
        <button class="circle sm" onclick="event.stopPropagation(); prevTrack()">‚èÆ</button>
        <button class="circle" id="playBtn" onclick="event.stopPropagation(); togglePlay()">‚ñ∂</button>
        <button class="circle sm" onclick="event.stopPropagation(); nextTrack()">‚è≠</button>
      </div>
      <div class="seek">
        <span id="curTime" class="muted">0:00</span>
        <input id="seek" type="range" min="0" max="100" value="0" oninput="seekAudio(this.value)" onclick="event.stopPropagation()" />
        <span id="durTime" class="muted">0:00</span>
      </div>
    </div>
    <div class="right">
      <div class="vol">
        <span class="muted">Vol</span>
        <input id="vol" type="range" min="0" max="1" step="0.01" value="1" oninput="setVolume(this.value)" onclick="event.stopPropagation()" />
      </div>
      <div class="soundwave" id="soundwave" style="display:none">
        <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
      </div>
      <audio id="audio" preload="none" crossorigin="anonymous"></audio>
    </div>
  </div>
</div>

<div id="bottomBar">
  <button id="btn-home" title="Inicio" onclick="goHome(); setActiveNav('home')" class="active" aria-label="Inicio">
    <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path d="M3 11L12 2l9 9v9a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2v-5H9v5a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-9z"/>
    </svg>
    <span class="label">Inicio</span>
  </button>
  <button id="btn-search" title="Buscar" onclick="showSearch(); setActiveNav('search')" aria-label="Buscar">
    <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <circle cx="11" cy="11" r="7"/>
      <line x1="16.5" y1="16.5" x2="21" y2="21"/>
    </svg>
    <span class="label">Buscar</span>
  </button>
  <button id="btn-playlists" title="Playlists" onclick="showPlaylists(); setActiveNav('playlists')" aria-label="Playlists">
    <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/>
    </svg>
    <span class="label">Playlists</span>
  </button>
  <button id="btn-account" title="Cuenta" onclick="showAccount(); setActiveNav('account')" aria-label="Cuenta">
    <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <circle cx="12" cy="7" r="4"/>
      <path d="M5.5 21a7.5 7.5 0 0 1 13 0"/>
    </svg>
    <span class="label">Cuenta</span>
  </button>
</div>

<div id="loginModal" class="card" style="display:none;position:fixed;inset:0;margin:auto;max-width:420px;height:max-content;z-index:50">
  <div class="stack">
    <div class="section-title">Iniciar sesi√≥n</div>
    <input id="email" type="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Contrase√±a" />
    <div class="row">
      <button class="btn" onclick="login()">Entrar</button>
      <button class="btn ghost" onclick="hideLogin()">Cancelar</button>
    </div>
    <small class="muted">Crea una cuenta o inicia sesi√≥n para gestionar playlists.</small>
  </div>
</div>

<script>
const SUPABASE_URL = "https://nqbldvpnqhngdtalvzov.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xYmxkdnBucWhuZ2R0YWx2em92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyMjY0NjUsImV4cCI6MjA3MDgwMjQ2NX0.Zzg5D219sW7bhvl0_R5ypX9MF6nRzBSDIeo2Lvebab0";
const ADMIN_EMAIL = "klmzr@gmail.com";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let isAdmin = false, isLoggedIn = false, currentUser = null;
let albums = [], userPlaylists = [], publicPlaylists = [];
let songsByAlbum = {}, songsByPlaylist = {}, flatSongs = [];
let queue = [], qIndex = -1, currentAlbum = null, currentPlaylist = null;
let isSearchMode = false, searchSongsCache = [];
let isShuffleMode = false, repeatMode = 0;
let favorites = new Set(), downloads = new Map();
let originalQueue = [];

const albumsGrid = document.getElementById("albumsGrid");
const emptyAlbums = document.getElementById("emptyAlbums");
const npCover = document.getElementById("npCover");
const npTitle = document.getElementById("npTitle");
const npAlbum = document.getElementById("npAlbum");
const playBtn = document.getElementById("playBtn");
const audioEl = document.getElementById("audio");
const seekEl = document.getElementById("seek");
const curTime = document.getElementById("curTime");
const durTime = document.getElementById("durTime");
const playerElement = document.getElementById("player");
const loadingScreen = document.getElementById("loadingScreen");
const shuffleBtn = document.getElementById("shuffleBtn");
const repeatBtn = document.getElementById("repeatBtn");
const musicControls = document.getElementById("musicControls");
const favoritesView = document.getElementById("favoritesView");
const downloadsView = document.getElementById("downloadsView");
const favoritesList = document.getElementById("favoritesList");
const downloadsList = document.getElementById("downloadsList");
const albumView = document.getElementById("albumView");
const avCover = document.getElementById("avCover");
const avTitle = document.getElementById("avTitle");
const avMeta = document.getElementById("avMeta");
const avSongs = document.getElementById("avSongs");
const searchSection = document.getElementById("searchSection");
const searchInput = document.getElementById("searchInput");
const searchIcon = document.getElementById("searchIcon");
const searchClear = document.getElementById("searchClear");
const searchResults = document.getElementById("searchResults");
const homeContent = document.getElementById("homeContent");
const searchSongsSection = document.getElementById("searchSongsSection");
const searchSongsList = document.getElementById("searchSongsList");
const noResults = document.getElementById("noResults");
const songsCount = document.getElementById("songsCount");

(async () => {
  console.log('üöÄ Inicializando KLMZ MUSIC...');
  try {
    loadAppSettings();
    const { data } = await sb.auth.getSession();
    if (data?.session?.user?.email) {
      const email = data.session.user.email;
      currentUser = data.session.user;
      isLoggedIn = true;
      isAdmin = (email.toLowerCase() === ADMIN_EMAIL.toLowerCase());
      updateUIForUser();
    }
    await refreshCatalog();
    if (albums.length > 0 || flatSongs.length > 0) {
      musicControls.style.display = 'flex';
    }
    setTimeout(() => {
      loadingScreen.style.opacity = '0';
      setTimeout(() => { loadingScreen.style.display = 'none'; }, 300);
    }, 1500);
    showMessage('¬°KLMZ MUSIC cargado exitosamente!', 'success');
  } catch (error) {
    console.error('Error inicializando:', error);
    showMessage('Error cargando la aplicaci√≥n', 'error');
    loadingScreen.style.display = 'none';
  }
})();

function loadAppSettings() {
  const savedFavorites = localStorage.getItem('klmz-favorites');
  if (savedFavorites) { favorites = new Set(JSON.parse(savedFavorites)); }
  
  isShuffleMode = localStorage.getItem('klmz-shuffle') === 'true';
  repeatMode = parseInt(localStorage.getItem('klmz-repeat') || '0');
  
  const savedDownloads = localStorage.getItem('klmz-downloads');
  if (savedDownloads) { downloads = new Map(JSON.parse(savedDownloads)); }
  
  updateControlsUI();
}

function saveAppSettings() {
  localStorage.setItem('klmz-favorites', JSON.stringify([...favorites]));
  localStorage.setItem('klmz-shuffle', isShuffleMode.toString());
  localStorage.setItem('klmz-repeat', repeatMode.toString());
  localStorage.setItem('klmz-downloads', JSON.stringify([...downloads]));
}

function updateControlsUI() {
  if (shuffleBtn) { shuffleBtn.classList.toggle('active', isShuffleMode); }
  if (repeatBtn) {
    const icons = ['üîÅ', 'üîÇ', 'üîÇ'];
    const texts = ['Repeat', 'Repeat All', 'Repeat One'];
    repeatBtn.innerHTML = `<span>${icons[repeatMode]}</span> ${texts[repeatMode]}`;
    repeatBtn.classList.toggle('active', repeatMode > 0);
  }
}

function updateUIForUser() {
  document.getElementById("btn-login").style.display = "none";
  document.getElementById("btn-logout").style.display = "inline-flex";
  
  if (isAdmin) {
    document.getElementById("adminPanel").style.display = "block";
    document.getElementById("adminTag").style.display = "inline-block";
  }
  
  if (isLoggedIn) {
    document.getElementById("userTag").style.display = "inline-block";
  }
}

function showMessage(msg, type = 'info') {
  const existingMsg = document.querySelector('.status-indicator');
  if (existingMsg) existingMsg.remove();
  
  const className = type === 'error' ? 'error-msg' : type === 'success' ? 'success-msg' : type === 'warning' ? 'warning-msg' : 'error-msg';
  const errorEl = document.createElement('div');
  errorEl.className = `status-indicator ${className}`;
  errorEl.textContent = msg;
  document.body.appendChild(errorEl);
  setTimeout(() => errorEl.remove(), 4000);
}

function toggleShuffle() {
  isShuffleMode = !isShuffleMode;
  updateControlsUI();
  saveAppSettings();
  showMessage(`Shuffle ${isShuffleMode ? 'activado' : 'desactivado'}`, 'success');
}

function toggleRepeat() {
  repeatMode = (repeatMode + 1) % 3;
  updateControlsUI();
  saveAppSettings();
  
  const messages = ['Repetir desactivado', 'Repetir todo activado', 'Repetir canci√≥n activado'];
  showMessage(messages[repeatMode], 'success');
}

function toggleFavorite(songId, element) {
  if (favorites.has(songId)) {
    favorites.delete(songId);
    element.textContent = 'ü§ç';
    element.classList.remove('active');
    showMessage('Eliminado de favoritos', 'info');
  } else {
    favorites.add(songId);
    element.textContent = '‚ù§Ô∏è';
    element.classList.add('active');
    element.classList.add('bounce');
    setTimeout(() => element.classList.remove('bounce'), 1000);
    showMessage('Agregado a favoritos', 'success');
  }
  saveAppSettings();
}

function showFavorites() {
  hideAllViews();
  favoritesView.style.display = 'block';
  setActiveNav('search');
  renderFavorites();
}

function renderFavorites() {
  favoritesList.innerHTML = '';
  const favoriteSongs = flatSongs.filter(song => favorites.has(song.id));
  
  if (favoriteSongs.length === 0) {
    document.getElementById('emptyFavorites').style.display = 'block';
    return;
  }
  
  document.getElementById('emptyFavorites').style.display = 'none';
  
  favoriteSongs.forEach((song, index) => {
    const item = document.createElement('div');
    item.className = 'search-song-item';
    item.innerHTML = `
      <img class="search-song-cover" src="${song.cover_url}" alt="${song.album_title}">
      <div class="search-song-info">
        <div class="search-song-title">${song.title}</div>
        <div class="search-song-artist">${song.album_title}</div>
      </div>
      <div class="search-song-actions">
        <button class="search-song-play" onclick="playFavoriteSong(${index})" title="Reproducir">‚ñ∂</button>
        <button class="favorite-btn active" onclick="toggleFavorite('${song.id}', this)" title="Quitar de favoritos">‚ù§Ô∏è</button>
      </div>
    `;
    favoritesList.appendChild(item);
  });
}

function playFavoriteSong(index) {
  const favoriteSongs = flatSongs.filter(song => favorites.has(song.id));
  if (favoriteSongs[index]) {
    queue = favoriteSongs;
    qIndex = -1;
    startQueueAt(index);
  }
}

function closeFavoritesView() {
  favoritesView.style.display = 'none';
  goHome();
}

async function downloadSong(songId, songUrl, title, element) {
  if (downloads.has(songId)) {
    showMessage('Esta canci√≥n ya est√° descargada', 'info');
    return;
  }
  
  try {
    element.innerHTML = 'Descargando...';
    element.disabled = true;
    
    const response = await fetch(songUrl);
    if (!response.ok) throw new Error('Error descargando');
    
    const blob = await response.blob();
    const objectUrl = URL.createObjectURL(blob);
    
    downloads.set(songId, {
      url: objectUrl,
      title,
      blob,
      downloadedAt: Date.now()
    });
    
    saveAppSettings();
    element.innerHTML = '‚úì Descargado';
    element.classList.add('downloaded');
    showMessage(`${title} descargado para offline`, 'success');
    updateOfflineStatus();
    
  } catch (error) {
    console.error('Error descargando:', error);
    showMessage('Error descargando la canci√≥n', 'error');
    element.innerHTML = 'üì• Offline';
    element.disabled = false;
  }
}

function updateOfflineStatus() {
  const offlineTag = document.getElementById('offlineTag');
  if (downloads.size > 0) {
    offlineTag.style.display = 'inline-block';
    offlineTag.textContent = `Offline (${downloads.size})`;
  } else {
    offlineTag.style.display = 'none';
  }
}

function showDownloads() {
  hideAllViews();
  downloadsView.style.display = 'block';
  setActiveNav('search');
  renderDownloads();
}

function renderDownloads() {
  downloadsList.innerHTML = '';
  
  if (downloads.size === 0) {
    document.getElementById('emptyDownloads').style.display = 'block';
    return;
  }
  
  document.getElementById('emptyDownloads').style.display = 'none';
  
  const downloadedSongs = [];
  for (const [songId, downloadData] of downloads) {
    const song = flatSongs.find(s => s.id === songId);
    if (song) { downloadedSongs.push({ ...song, downloadData }); }
  }
  
  downloadedSongs.forEach((song, index) => {
    const item = document.createElement('div');
    item.className = 'search-song-item';
    const downloadDate = new Date(song.downloadData.downloadedAt).toLocaleDateString();
    item.innerHTML = `
      <img class="search-song-cover" src="${song.cover_url}" alt="${song.album_title}">
      <div class="search-song-info">
        <div class="search-song-title">${song.title}</div>
        <div class="search-song-artist">${song.album_title} ‚Ä¢ Descargado: ${downloadDate}</div>
      </div>
      <div class="search-song-actions">
        <button class="search-song-play" onclick="playDownloadedSong(${index})" title="Reproducir">‚ñ∂</button>
        <button class="btn small ghost" onclick="removeDownload('${song.id}')" title="Eliminar descarga">üóëÔ∏è</button>
      </div>
    `;
    downloadsList.appendChild(item);
  });
}

function playDownloadedSong(index) {
  const downloadedSongs = [];
  for (const [songId, downloadData] of downloads) {
    const song = flatSongs.find(s => s.id === songId);
    if (song) { downloadedSongs.push({ ...song, downloadData, song_url: downloadData.url }); }
  }
  
  if (downloadedSongs[index]) {
    queue = downloadedSongs;
    qIndex = -1;
    startQueueAt(index);
  }
}

function removeDownload(songId) {
  if (downloads.has(songId)) {
    const downloadData = downloads.get(songId);
    if (downloadData.url) { URL.revokeObjectURL(downloadData.url); }
    downloads.delete(songId);
    saveAppSettings();
    updateOfflineStatus();
    renderDownloads();
    showMessage('Descarga eliminada', 'info');
  }
}

function closeDownloadsView() {
  downloadsView.style.display = 'none';
  goHome();
}

function hideAllViews() {
  albumView.style.display = 'none';
  favoritesView.style.display = 'none';
  downloadsView.style.display = 'none';
  searchSection.style.display = 'none';
  searchResults.style.display = 'none';
  homeContent.style.display = 'none';
}

function setActiveNav(activeButton) {
  document.querySelectorAll('#bottomBar button').forEach(btn => {
    btn.classList.remove('active');
  });
  document.getElementById(`btn-${activeButton}`).classList.add('active');
}

function showSearch() {
  isSearchMode = true;
  hideAllViews();
  searchSection.style.display = 'block';
  setActiveNav('search');
  searchInput.focus();
}

function goHome(){
  isSearchMode = false;
  hideAllViews();
  homeContent.style.display = 'block';
  setActiveNav('home');
  clearSearch();
}

function showPlaylists(){
  showMessage('Sistema de playlists en desarrollo', 'info');
}

function showAccount(){
  if(isAdmin){
    alert('Cuenta Admin: ' + ADMIN_EMAIL + '\n\nFuncionalidades:\n‚Ä¢ Crear √°lbumes\n‚Ä¢ Subir canciones\n‚Ä¢ Eliminar √°lbumes');
  } else if (isLoggedIn) {
    alert('Usuario: ' + currentUser.email);
  } else {
    showLogin();
  }
}

function nextTrack() {
  if (!queue.length) return;
  
  if (repeatMode === 2) {
    playTrack(queue[qIndex]);
    return;
  }
  
  qIndex = (qIndex + 1) % queue.length;
  
  if (qIndex === 0 && repeatMode === 0 && queue.length > 1) {
    audioEl.pause();
    hidePlayer();
    return;
  }
  
  playTrack(queue[qIndex]);
}

function prevTrack() {
  if (!queue.length) return;
  qIndex = (qIndex - 1 + queue.length) % queue.length;
  playTrack(queue[qIndex]);
}

function performSearch(query) {
  const term = query.trim().toLowerCase();
  
  if (term.length === 0) {
    clearSearch();
    return;
  }
  
  searchClear.style.display = 'block';
  searchIcon.style.display = 'none';
  
  const foundSongs = flatSongs.filter(song => 
    song.title.toLowerCase().includes(term) || 
    song.album_title.toLowerCase().includes(term)
  );
  
  searchSongsCache = foundSongs;
  showSearchResults(foundSongs);
}

function showSearchResults(songs) {
  searchResults.style.display = 'block';
  
  if (songs.length === 0) {
    searchSongsSection.style.display = 'none';
    noResults.style.display = 'block';
    return;
  }
  
  noResults.style.display = 'none';
  searchSongsSection.style.display = 'block';
  songsCount.textContent = songs.length;
  renderSearchSongs(songs);
}

function renderSearchSongs(songs) {
  searchSongsList.innerHTML = '';
  songs.forEach((song, index) => {
    const item = document.createElement('div');
    item.className = 'search-song-item';
    const isFavorite = favorites.has(song.id);
    const isDownloaded = downloads.has(song.id);
    item.innerHTML = `
      <img class="search-song-cover" src="${song.cover_url}" alt="${song.album_title}">
      <div class="search-song-info">
        <div class="search-song-title">${song.title}</div>
        <div class="search-song-artist">${song.album_title}</div>
      </div>
      <div class="search-song-actions">
        <button class="search-song-play" onclick="playSearchSong(${index})" title="Reproducir">‚ñ∂</button>
        <button class="favorite-btn ${isFavorite ? 'active' : ''}" onclick="toggleFavorite('${song.id}', this)" title="Favorito">${isFavorite ? '‚ù§Ô∏è' : 'ü§ç'}</button>
        <button class="download-btn ${isDownloaded ? 'downloaded' : ''}" onclick="downloadSong('${song.id}', '${song.song_url}', '${song.title.replace(/'/g, "\\'")}', this)" title="Descargar">${isDownloaded ? '‚úì' : 'üì•'}</button>
      </div>
    `;
    searchSongsList.appendChild(item);
  });
}

function playSearchSong(index) {
  if (searchSongsCache && searchSongsCache[index]) {
    queue = searchSongsCache;
    qIndex = -1;
    startQueueAt(index);
  }
}

function clearSearch() {
  searchInput.value = '';
  searchClear.style.display = 'none';
  searchIcon.style.display = 'block';
  searchResults.style.display = 'none';
  searchSongsCache = [];
}

function showPlayer(){
  playerElement.classList.add('show');
}

function hidePlayer(){
  playerElement.classList.remove('show');
}

function toggleSoundwave(show){
  const wave = document.getElementById('soundwave');
  if(show) wave.style.display = 'flex';
  else wave.style.display = 'none';
}

function showLogin(){ document.getElementById("loginModal").style.display="block"; }
function hideLogin(){ document.getElementById("loginModal").style.display="none"; }

async function login(){
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;
  
  if (!password) {
    showMessage('Ingresa tu contrase√±a', 'warning');
    return;
  }
  
  let result = await sb.auth.signInWithPassword({ email, password });
  
  if (result.error) {
    result = await sb.auth.signUp({ email, password });
    if (result.error) {
      showMessage("Error: " + result.error.message, 'error');
      return;
    }
    showMessage('Cuenta creada!', 'success');
  }
  
  currentUser = result.data.user;
  isLoggedIn = !!currentUser;
  isAdmin = (email.toLowerCase() === ADMIN_EMAIL.toLowerCase());
  
  updateUIForUser();
  hideLogin();
  await refreshCatalog();
}

async function logout(){
  await sb.auth.signOut();
  currentUser = null;
  isLoggedIn = false;
  isAdmin = false;
  
  document.getElementById("adminPanel").style.display = "none";
  document.getElementById("adminTag").style.display = "none";
  document.getElementById("userTag").style.display = "none";
  document.getElementById("btn-login").style.display = "inline-flex";
  document.getElementById("btn-logout").style.display = "none";
}

async function refreshCatalog(){
  console.log('Cargando √°lbumes...');
  const { data: alb, error: e1 } = await sb.from("albums").select("*").order("created_at",{ascending:false});
  if (e1){ 
    console.error('Error cargando √°lbumes:', e1); 
    showMessage('Error cargando √°lbumes', 'error'); 
    return; 
  }
  albums = alb || [];
  console.log('√Ålbumes cargados:', albums.length);
  emptyAlbums.style.display = albums.length ? "none" : "block";
  
  const adminSel = document.getElementById("albumSelect");
  const delSel = document.getElementById("deleteAlbumSelect");
  if (adminSel) adminSel.innerHTML = "";
  if (delSel) delSel.innerHTML = "";
  
  for (const a of albums){
    if (adminSel){
      const o = document.createElement("option");
      o.value = a.id; o.textContent = a.title;
      adminSel.appendChild(o);
    }
    if (delSel){
      const d = document.createElement("option");
      d.value = a.id; d.textContent = a.title;
      delSel.appendChild(d);
    }
  }
  
  songsByAlbum = {};
  flatSongs = [];
  for (const a of albums){
    const { data: ss, error: e2 } = await sb.from("songs").select("*").eq("album_id", a.id).order("created_at",{ascending:true});
    if (e2){ console.error(e2); continue; }
    songsByAlbum[a.id] = ss || [];
    for (const s of (ss||[])){
      flatSongs.push({...s, album_title: a.title, cover_url: a.cover_url});
    }
  }
  
  renderAlbums();
}

function renderAlbums(list = albums){
  albumsGrid.innerHTML = "";
  list.forEach(a => {
    const count = (songsByAlbum[a.id]?.length||0);
    const card = document.createElement("div");
    card.className = "album-card";
    card.innerHTML = `
      <img class="album-cover" src="${a.cover_url}" alt="${a.title}">
      <div class="album-title">${a.title}</div>
      <div class="album-meta">${count} ${count===1?'canci√≥n':'canciones'}</div>
    `;
    card.onclick = () => openAlbum(a);
    albumsGrid.appendChild(card);
  });
}

function openAlbum(album){
  currentAlbum = album;
  const songs = songsByAlbum[album.id] || [];
  avCover.src = album.cover_url || "";
  avTitle.textContent = album.title;
  avMeta.textContent = `${songs.length} ${songs.length===1?'canci√≥n':'canciones'}`;
  avSongs.innerHTML = "";
  if (!songs.length){
    avSongs.innerHTML = `<div class="muted" style="padding:12px 0">Este √°lbum no tiene canciones todav√≠a.</div>`;
  } else {
    songs.forEach((s,idx) => {
      const isFavorite = favorites.has(s.id);
      const isDownloaded = downloads.has(s.id);
      const row = document.createElement("div");
      row.className = "song-plain-item";
      row.innerHTML = `
        <div class="idx">${idx+1}</div>
        <div class="title">${s.title}</div>
        <button class="favorite-btn ${isFavorite ? 'active' : ''}" onclick="event.stopPropagation(); toggleFavorite('${s.id}', this)" title="Favorito">${isFavorite ? '‚ù§Ô∏è' : 'ü§ç'}</button>
        <button class="download-btn ${isDownloaded ? 'downloaded' : ''}" onclick="event.stopPropagation(); downloadSong('${s.id}', '${s.song_url}', '${s.title.replace(/'/g, "\\'")}', this)" title="Descargar">${isDownloaded ? '‚úì' : 'üì•'}</button>
      `;
      row.onclick = () => {
        const albumSongs = songs.map(t => ({...t, album_title: album.title, cover_url: album.cover_url}));
        queue = albumSongs;
        qIndex = -1;
        startQueueAt(idx);
      };
      avSongs.appendChild(row);
    });
  }
  albumView.style.display = "block";
}

function closeAlbumView(){
  albumView.style.display = "none";
  currentAlbum = null;
}

function startQueueAt(idx){ if (!queue.length) return; qIndex = idx; playTrack(queue[qIndex]); }

function playTrack(song){
  console.log('Intentando reproducir:', song.title);
  
  if (!song.song_url) {
    showMessage(`Error: No hay URL para "${song.title}"`, 'error');
    nextTrack();
    return;
  }
  
  audioEl.pause();
  audioEl.currentTime = 0;
  audioEl.src = song.song_url;
  audioEl.load();
  
  npTitle.textContent = song.title;
  npAlbum.textContent = song.album_title || "‚Äî";
  npCover.src = song.cover_url || "";
  
  showPlayer();
  
  const playPromise = audioEl.play();
  if (playPromise !== undefined) {
    playPromise
      .then(() => {
        playBtn.textContent = "‚è∏";
        toggleSoundwave(true);
      })
      .catch((error) => {
        console.error('Error de reproducci√≥n:', error);
        showMessage(`No se puede reproducir "${song.title}"`, 'error');
        setTimeout(() => nextTrack(), 2000);
      });
  }
}

function togglePlay(){
  if (audioEl.paused){ 
    audioEl.play().then(() => {
      playBtn.textContent="‚è∏"; 
      toggleSoundwave(true);
    });
  }
  else { 
    audioEl.pause(); 
    playBtn.textContent="‚ñ∂"; 
    toggleSoundwave(false);
  }
}

function setVolume(v){ audioEl.volume = v; }
function seekAudio(percent){ if (!audioEl.duration) return; audioEl.currentTime = (percent/100) * audioEl.duration; }
function fmt(t){ if(!isFinite(t)) return "0:00"; const m=Math.floor(t/60), s=Math.floor(t%60); return `${m}:${s.toString().padStart(2,"0")}`; }

audioEl.addEventListener("timeupdate",()=>{
  if (!audioEl.duration) return;
  const p = (audioEl.currentTime / audioEl.duration) * 100;
  seekEl.value = p; 
  curTime.textContent = fmt(audioEl.currentTime); 
  durTime.textContent = fmt(audioEl.duration);
});

audioEl.addEventListener("ended",()=> nextTrack());
audioEl.addEventListener("pause",()=> toggleSoundwave(false));
audioEl.addEventListener("play",()=> toggleSoundwave(true));

function openNowPlaying(){
  showMessage('Pantalla completa en desarrollo', 'info');
}

function safeName(name){ return name.replace(/[^a-zA-Z0-9\_\-.]+/g,"-"); }

async function uploadAlbum(){
  if (!isAdmin) return alert("No autorizado");
  const title = document.getElementById("albumTitle").value.trim();
  const file = document.getElementById("albumCover").files[0];
  if (!title || !file) return alert("Completa t√≠tulo y portada");
  
  const path = `${Date.now()}-${safeName(file.name)}`;
  const { error: upErr } = await sb.storage.from("covers").upload(path, file);
  if (upErr) return alert("Error subiendo portada: " + upErr.message);
  
  const { data: pub } = sb.storage.from("covers").getPublicUrl(path);
  const cover_url = pub.publicUrl;
  
  const { error: insErr } = await sb.from("albums").insert([{ title, cover_url }]);
  if (insErr) return alert("Error guardando √°lbum: " + insErr.message);
  
  document.getElementById("albumTitle").value = "";
  document.getElementById("albumCover").value = "";
  showMessage("√Ålbum creado exitosamente", "success");
  await refreshCatalog();
}

async function uploadSong(){
  if (!isAdmin) return alert("No autorizado");
  const albumId = document.getElementById("albumSelect").value;
  const titleInput = document.getElementById("songTitle").value.trim();
  const files = document.getElementById("songFiles").files;
  if (!albumId || files.length === 0) return alert("Selecciona un √°lbum y al menos un archivo de audio");
  
  let ok = 0, fail = 0;
  for (const file of files) {
    if (!file.type.startsWith('audio/')) {
      fail++;
      continue;
    }
    
    const path = `${Date.now()}-${safeName(file.name)}`;
    const { error: upErr } = await sb.storage.from("songs").upload(path, file);
    if (upErr) { 
      fail++; 
      continue; 
    }
    
    const { data: pub } = sb.storage.from("songs").getPublicUrl(path);
    const song_url = pub.publicUrl;
    
    const title = (files.length === 1 && titleInput) ? titleInput : file.name.replace(/\.[^/.]+$/, "");
    const { error: insErr } = await sb.from("songs").insert([{ album_id: albumId, title, song_url }]);
    if (insErr) { 
      fail++; 
    } else { 
      ok++; 
    }
  }
  
  document.getElementById("songTitle").value = "";
  document.getElementById("songFiles").value = "";
  showMessage(`Subida completa: ${ok} exitosas, ${fail} error(es)`, ok > 0 ? "success" : "error");
  await refreshCatalog();
}

async function deleteAlbum(){
  if (!isAdmin) return alert("No autorizado");
  const albumId = document.getElementById("deleteAlbumSelect").value;
  if (!albumId) return alert("Selecciona un √°lbum");
  if (!confirm("¬øEliminar √°lbum y todas sus canciones?")) return;
  
  await sb.from("songs").delete().eq("album_id", albumId);
  await sb.from("albums").delete().eq("id", albumId);
  
  showMessage("√Ålbum eliminado exitosamente", "success");
  if (currentAlbum?.id === albumId) closeAlbumView();
  await refreshCatalog();
}
</script>
</body>
</html>
