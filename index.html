<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KLMZ MUSIC</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-purple-700 p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold">🎵 KLMZ MUSIC</h1>
    <button id="logout-btn" class="bg-red-500 px-4 py-2 rounded hidden">Cerrar sesión</button>
  </header>

  <!-- Login / Registro -->
  <section id="auth-section" class="flex-grow flex flex-col items-center justify-center p-4">
    <div class="bg-gray-800 p-6 rounded shadow-md w-full max-w-sm">
      <h2 class="text-lg font-bold mb-4">Iniciar Sesión / Registrarse</h2>
      <input id="email" type="email" placeholder="Correo" class="w-full mb-3 p-2 rounded bg-gray-700 border border-gray-600" />
      <input id="password" type="password" placeholder="Contraseña" class="w-full mb-3 p-2 rounded bg-gray-700 border border-gray-600" />
      <button id="login-btn" class="w-full bg-purple-500 hover:bg-purple-600 p-2 rounded mb-2">Iniciar Sesión</button>
      <button id="signup-btn" class="w-full bg-green-500 hover:bg-green-600 p-2 rounded">Registrarse</button>
    </div>
  </section>

  <!-- App -->
  <section id="app-section" class="hidden flex-grow p-4">
    <div class="mb-6">
      <h2 class="text-2xl font-bold mb-2">Álbumes</h2>
      <div id="albums-container" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
    </div>

    <!-- Subida de Álbum -->
    <div id="upload-album-section" class="hidden mb-6">
      <h3 class="text-xl font-bold mb-2">Subir nuevo álbum</h3>
      <input id="album-title" type="text" placeholder="Título del álbum" class="w-full mb-2 p-2 rounded bg-gray-700 border border-gray-600" />
      <input id="album-cover" type="file" class="w-full mb-2" />
      <button id="upload-album-btn" class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded">Subir Álbum</button>
    </div>

    <!-- Subida de Canción -->
    <div id="upload-song-section" class="hidden mb-6">
      <h3 class="text-xl font-bold mb-2">Subir nueva canción</h3>
      <input id="song-title" type="text" placeholder="Título de la canción" class="w-full mb-2 p-2 rounded bg-gray-700 border border-gray-600" />
      <input id="song-file" type="file" class="w-full mb-2" />
      <select id="album-select" class="w-full mb-2 p-2 rounded bg-gray-700 border border-gray-600"></select>
      <button id="upload-song-btn" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded">Subir Canción</button>
    </div>

    <!-- Reproductor -->
    <div>
      <h3 class="text-xl font-bold mb-2">Reproductor</h3>
      <audio id="audio-player" controls class="w-full"></audio>
    </div>
  </section>

  <script>
    // Configuración Supabase
    const supabaseUrl = "https://lvrkifepqhxxmdcasncf.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2cmtpZmVwcWh4eG1kY2FzbmNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMjU3NTMsImV4cCI6MjA3MDcwMTc1M30.I-jHvTMEHHrUMM1-2YQrb-58YU4KmTrJuc95GJcjzhk";
    const supabaseClient = supabase.createClient(df543cda-21d7-42a5-ae86-3b895482a171);

    const authSection = document.getElementById("auth-section");
    const appSection = document.getElementById("app-section");
    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const loginBtn = document.getElementById("login-btn");
    const signupBtn = document.getElementById("signup-btn");
    const logoutBtn = document.getElementById("logout-btn");
    const albumsContainer = document.getElementById("albums-container");
    const uploadAlbumSection = document.getElementById("upload-album-section");
    const uploadSongSection = document.getElementById("upload-song-section");
    const albumTitleInput = document.getElementById("album-title");
    const albumCoverInput = document.getElementById("album-cover");
    const uploadAlbumBtn = document.getElementById("upload-album-btn");
    const songTitleInput = document.getElementById("song-title");
    const songFileInput = document.getElementById("song-file");
    const albumSelect = document.getElementById("album-select");
    const uploadSongBtn = document.getElementById("upload-song-btn");
    const audioPlayer = document.getElementById("audio-player");

    // Sesión
    async function checkSession() {
      const { data } = await supabaseClient.auth.getSession();
      if (data.session) {
        authSection.classList.add("hidden");
        appSection.classList.remove("hidden");
        logoutBtn.classList.remove("hidden");
        loadAlbums();
      }
    }
    checkSession();

    // Login
    loginBtn.addEventListener("click", async () => {
      const { error } = await supabaseClient.auth.signInWithPassword({
        email: emailInput.value,
        password: passwordInput.value
      });
      if (error) alert(error.message);
      else checkSession();
    });

    // Registro
    signupBtn.addEventListener("click", async () => {
      const { error } = await supabaseClient.auth.signUp({
        email: emailInput.value,
        password: passwordInput.value
      });
      if (error) alert(error.message);
      else alert("Registrado correctamente, ahora inicia sesión.");
    });

    // Logout
    logoutBtn.addEventListener("click", async () => {
      await supabaseClient.auth.signOut();
      authSection.classList.remove("hidden");
      appSection.classList.add("hidden");
      logoutBtn.classList.add("hidden");
    });

    // Cargar álbumes
    async function loadAlbums() {
      albumsContainer.innerHTML = "";
      albumSelect.innerHTML = "";
      const { data, error } = await supabaseClient.from("albums").select("*");
      if (error) return console.error(error);
      data.forEach(album => {
        const div = document.createElement("div");
        div.className = "bg-gray-800 p-2 rounded shadow cursor-pointer";
        div.innerHTML = `
          <img src="${album.cover_url}" alt="${album.title}" class="w-full h-32 object-cover rounded mb-2">
          <h4 class="text-sm font-bold">${album.title}</h4>
        `;
        div.addEventListener("click", () => loadSongs(album.id));
        albumsContainer.appendChild(div);

        const opt = document.createElement("option");
        opt.value = album.id;
        opt.textContent = album.title;
        albumSelect.appendChild(opt);
      });
    }

    // Cargar canciones de álbum
    async function loadSongs(albumId) {
      const { data, error } = await supabaseClient.from("songs").select("*").eq("album_id", albumId);
      if (error) return console.error(error);
      if (data.length > 0) {
        audioPlayer.src = data[0].file_url;
        audioPlayer.play();
      }
    }

    // Subir álbum
    uploadAlbumBtn.addEventListener("click", async () => {
      const file = albumCoverInput.files[0];
      if (!file) return alert("Selecciona una portada");
      const { data: fileData, error: uploadError } = await supabaseClient.storage.from("covers").upload(`${Date.now()}_${file.name}`, file);
      if (uploadError) return alert(uploadError.message);

      const coverUrl = `${supabaseUrl}/storage/v1/object/public/covers/${fileData.path}`;
      await supabaseClient.from("albums").insert([{ title: albumTitleInput.value, cover_url: coverUrl }]);
      loadAlbums();
    });

    // Subir canción
    uploadSongBtn.addEventListener("click", async () => {
      const file = songFileInput.files[0];
      if (!file) return alert("Selecciona una canción");
      const { data: fileData, error: uploadError } = await supabaseClient.storage.from("songs").upload(`${Date.now()}_${file.name}`, file);
      if (uploadError) return alert(uploadError.message);

      const songUrl = `${supabaseUrl}/storage/v1/object/public/songs/${fileData.path}`;
      await supabaseClient.from("songs").insert([{ title: songTitleInput.value, file_url: songUrl, album_id: albumSelect.value }]);
      alert("Canción subida correctamente");
    });
  </script>
</body>
</html>
