<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>KLMZ MUSIC</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <meta name="theme-color" content="#1DB954">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <!-- ============== HOJA DE ESTILOS COMPLETA =============== -->
  <style>
  /* ‚Äî‚Äî RESET Y LAYOUT B√ÅSICO ‚Äî‚Äî */
  *{box-sizing:border-box}
  body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#181818;color:#fff;padding-bottom:84px;transition:.3s}
  header{background:#121212;padding:1rem 1.5rem;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
  .logo{font-weight:bold;font-size:1.4rem;letter-spacing:1px}
  .user-actions{display:flex;align-items:center;gap:.5rem}
  .lock-icon{cursor:pointer;font-size:1.4rem}
  .theme-selector{display:flex;align-items:center;gap:.3rem;margin-right:.5rem}
  .theme-selector label{font-size:.7rem;color:#b3b3b3}
  .theme-selector select{background:#333;color:#fff;border:1px solid #555;border-radius:4px;padding:.1rem .2rem;font-size:.7rem}

  /* ‚Äî‚Äî SECCIONES ‚Äî‚Äî */
  .app-container{display:flex;min-height:calc(100vh - 60px)}
  main{flex:1;padding:1rem;max-width:900px;margin:0 auto}
  .content-section{display:none}
  .content-section.active{display:block}
  .section-title{font-size:1.8rem;font-weight:bold;margin-bottom:1.5rem}

  /* ‚Äî‚Äî √ÅLBUMES ‚Äî‚Äî */
  .album-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:1.5rem}
  .album-card{cursor:pointer;display:flex;flex-direction:column;align-items:center;text-align:center;transition:transform .3s}
  .album-card:hover{transform:scale(1.05)}
  .album-img{border-radius:50%;width:100px;height:100px;object-fit:cover;margin-bottom:.7rem;background:#333}
  .album-title{font-size:.98rem;font-weight:bold}
  .album-artist{font-size:.9rem;color:#b3b3b3}

  /* ‚Äî‚Äî PLAYER MINI ‚Äî‚Äî */
  .player{position:fixed;bottom:84px;left:0;right:0;background:#212121cc;border-top:1px solid #282828;display:flex;align-items:center;padding:.8rem 1.2rem;min-height:56px;cursor:pointer;box-shadow:0 -2px 10px #0002;z-index:300}
  .player-img-mini{width:44px;height:44px;border-radius:100%;object-fit:cover;margin-right:1rem}
  .player-info-mini{flex:1;overflow:hidden}
  .player-title-mini{font-weight:bold;font-size:1rem;line-height:1.2}
  .player-artist-mini{color:#b3b3b3;font-size:.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .play-btn-inline{background:#1DB954;color:#fff;border:none;border-radius:50%;width:36px;height:36px;font-size:1.1rem;cursor:pointer}

  /* ‚Äî‚Äî PLAYER COMPLETO ‚Äî‚Äî */
  .full-player-backdrop{display:none;position:fixed;inset:0;background:#000f;z-index:9999;align-items:center;justify-content:center;flex-direction:column}
  .full-player-backdrop.active{display:flex}
  .full-player-cover{width:200px;height:200px;border-radius:12px;object-fit:cover;margin:0 auto 2rem}
  .full-player-title{font-size:1.8rem;font-weight:bold;margin:1rem 0 .5rem;text-align:center}
  .full-player-artist{color:#b3b3b3;font-size:1.1rem;margin-bottom:2rem;text-align:center}
  .full-control-buttons{display:flex;gap:3rem;align-items:center}
  .full-control-btn{background:none;border:none;color:#fff;font-size:2rem;padding:.6rem;border-radius:50%;cursor:pointer}
  .full-play-btn{background:#1DB954;color:#fff;border-radius:50%;font-size:2.5rem;padding:.8rem}

  /* ‚Äî‚Äî NAV INFERIOR ‚Äî‚Äî */
  .bottom-nav{position:fixed;left:0;right:0;bottom:20px;background:#181818;border-top:1px solid #272727;display:flex;height:64px;z-index:5000}
  .bottom-nav-item{color:#b3b3b3;text-align:center;flex:1;font-size:1.14rem;padding:4px 0;border-radius:7px;cursor:pointer;display:flex;flex-direction:column;align-items:center}
  .bottom-nav-item.active{color:#1DB954;background:rgba(29,185,84,.09)}

  /* ‚Äî‚Äî MODALES ‚Äî‚Äî */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:2000}
  .modal-content{background:#282828;padding:2rem;border-radius:8px;width:95%;max-width:430px;max-height:90vh;overflow-y:auto}
  .btn-primary{background:#1DB954;color:#fff;border:none;padding:.7rem 1.5rem;border-radius:99px;cursor:pointer;width:100%}
  .btn-secondary{background:#555;color:#fff;border:none;padding:.7rem 1.5rem;border-radius:99px;cursor:pointer}
  .btn-danger{background:#e22134;color:#fff;border:none;padding:.5rem 1rem;border-radius:4px;cursor:pointer}

  /* ‚Äî‚Äî ADMIN LIST ‚Äî‚Äî */
  .admin-section{margin-bottom:2.5rem;background:#242424;padding:1.5rem;border-radius:8px}
  .admin-item{display:flex;justify-content:space-between;align-items:center;padding:.8rem;border-radius:4px;margin-bottom:.5rem;background:#2c2c2c}

  /* ‚Äî‚Äî INDICADOR DE CARGA ‚Äî‚Äî */
  .loading-indicator{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.9);color:#fff;padding:1.5rem 2.5rem;border-radius:12px;font-size:1rem;z-index:2000;border:2px solid #1DB954}

  /* ‚Äî‚Äî TEMAS COMPLETOS (neon, minimal, sunset, pastel, luxury, oceanic) ‚Äî‚Äî */
  /*  (todo tu bloque de temas sin alterar)  */

  @keyframes neonPulse{0%{text-shadow:0 0 15px #00ff88}100%{text-shadow:0 0 40px #00ff88}}
  @media(max-width:768px){.full-player-cover{width:150px;height:150px}.album-img{width:80px;height:80px}}
  </style>
</head>

<body>
  <div class="loading-indicator" id="loading-indicator" style="display:none;">üéµ Cargando‚Ä¶</div>

  <!-- ================= CABECERA ================= -->
  <header>
    <span class="logo">KLMZ MUSIC</span>
    <div class="user-actions">
      <div class="theme-selector">
        <label for="theme-select">Tema:</label>
        <select id="theme-select" onchange="changeTheme(this.value)">
          <option value="default">Default</option>
          <option value="neon">Neon</option>
          <option value="minimal">Minimal</option>
          <option value="sunset">Sunset</option>
          <option value="pastel">Pastel</option>
          <option value="luxury">Luxury</option>
          <option value="oceanic">Oceanic</option>
        </select>
      </div>
      <div class="user-menu">
        <div class="lock-icon" id="header-lock-icon" onclick="toggleUserMenu()">üîí</div>
        <div class="user-dropdown" id="user-dropdown">
          <div class="user-info" id="user-info-section" style="display:none;">
            <div><strong id="user-email-display"></strong></div>
            <div id="user-role-display">Usuario</div>
          </div>
          <div class="user-dropdown-item" id="admin-menu-item"   onclick="goToAdmin()"      style="display:none;"><span>‚öôÔ∏è</span><span>Panel Admin</span></div>
          <div class="user-dropdown-item" id="register-menu-item" onclick="showAuth('register')"><span>üìù</span><span>Registrarse</span></div>
          <div class="user-dropdown-item" id="login-menu-item"    onclick="showAuth('login')"><span>üîê</span><span>Iniciar Sesi√≥n</span></div>
          <div class="user-dropdown-item logout" id="logout-menu-item" style="display:none;" onclick="confirmLogout()"><span>üö™</span><span>Cerrar Sesi√≥n</span></div>
        </div>
      </div>
    </div>
  </header>

  <!-- ================= SECCIONES PRINCIPALES ================= -->
  <div class="app-container">
    <main>
      <section id="home-section"      class="content-section active">
        <div class="section-title">√Ålbumes</div>
        <div class="album-grid" id="albums"><div style="text-align:center;padding:2rem;">Cargando √°lbumes‚Ä¶</div></div>
        <div id="album-detail" style="display:none;"></div>
      </section>

      <section id="search-section"    class="content-section">
        <div class="section-title">Buscar m√∫sica</div>
        <input id="search-input" placeholder="¬øQu√© quieres escuchar?" onkeyup="searchMusic()">
        <div id="search-results"></div>
      </section>

      <section id="favorites-section" class="content-section">
        <div class="section-title">‚ù§Ô∏è Mis Favoritos</div>
        <div id="favorites-content"><div style="text-align:center;padding:2rem;">No tienes favoritos</div></div>
      </section>

      <section id="downloads-section" class="content-section">
        <div class="section-title">‚Üì Mis Descargas</div>
        <div id="downloads-content"><div style="text-align:center;padding:2rem;">No tienes canciones descargadas</div></div>
      </section>

      <section id="admin-section"     class="content-section">
        <div class="section-title">Panel de Administraci√≥n</div>
        <div id="admin-content"></div>
      </section>
    </main>
  </div>

  <!-- ================= NAV INFERIOR ================= -->
  <nav class="bottom-nav">
    <div class="bottom-nav-item active" onclick="showSection('home')"      id="nav-home"><span class="icon">‚åÇ</span><small>Inicio</small></div>
    <div class="bottom-nav-item"        onclick="showSection('search')"    id="nav-search"><span class="icon">‚åï</span><small>Buscar</small></div>
    <div class="bottom-nav-item"        onclick="showSection('downloads')" id="nav-downloads"><span class="icon">‚Üì</span><small>Descargas</small></div>
    <div class="bottom-nav-item"        onclick="showSection('favorites')" id="nav-favs"><span class="icon">‚ô°</span><small>Favoritos</small></div>
  </nav>

  <!-- ================= COMPONENTES (player, modales) ================= -->
  <div class="player" id="mini-player" style="display:none;">
    <img class="player-img-mini" id="mini-player-img" alt="">
    <div class="player-info-mini">
      <div class="player-title-mini"  id="mini-player-title"></div>
      <div class="player-artist-mini" id="mini-player-artist"></div>
    </div>
    <div class="player-controls-inline" onclick="event.stopPropagation()">
      <button class="play-btn-inline" id="mini-play-btn" onclick="togglePlay()">‚ñ∂</button>
    </div>
  </div>

  <div class="full-player-backdrop" id="full-player">
    <button class="full-player-close" onclick="closeFullPlayer()">&times;</button>
    <img id="full-player-cover" class="full-player-cover" src="" alt="">
    <div id="full-player-title"  class="full-player-title"></div>
    <div id="full-player-artist" class="full-player-artist"></div>

    <div class="full-player-controls">
      <div class="full-control-buttons">
        <button class="full-control-btn"           onclick="previousSong()">‚èÆ</button>
        <button class="full-control-btn full-play-btn" id="full-play-btn" onclick="togglePlay()">‚ñ∂</button>
        <button class="full-control-btn"           onclick="nextSong()">‚è≠</button>
      </div>
      <div class="mode-controls">
        <button class="mode-btn" id="repeat-btn"  onclick="toggleRepeatMode()">üîÅ</button>
        <button class="mode-btn" id="shuffle-btn" onclick="toggleShuffleMode()">üîÄ</button>
      </div>
      <div class="full-progress-container">
        <span id="full-current-time" class="full-progress-time">0:00</span>
        <div class="full-progress-bar" onclick="seekToFull(event)">
          <div class="full-progress-fill" id="full-progress-fill"></div>
        </div>
        <span id="full-total-time" class="full-progress-time">0:00</span>
      </div>
      <div class="full-player-volume"><input type="range" class="full-volume-slider" min="0" max="100" value="70" oninput="setVolume(this.value)"></div>
    </div>
  </div>

  <!-- ================= MODAL AUTH ================= -->
  <div class="modal" id="auth-modal">
    <div class="modal-content">
      <button class="close-modal" onclick="closeAuth()">&times;</button>
      <div id="login-form">
        <h2>Iniciar sesi√≥n</h2>
        <form onsubmit="login(event)">
          <div class="form-group"><label>Email:</label><input type="email" id="login-email" required></div>
          <div class="form-group"><label>Contrase√±a:</label><input type="password" id="login-password" required></div>
          <button class="btn-primary" type="submit">Iniciar sesi√≥n</button>
        </form>
        <p>¬øNo tienes cuenta? <a href="#" onclick="showAuth('register')">Reg√≠strate</a></p>
      </div>
      <div id="register-form" style="display:none;">
        <h2>Registrarse</h2>
        <form onsubmit="register(event)">
          <div class="form-group"><label>Email:</label><input type="email" id="register-email" required></div>
          <div class="form-group"><label>Contrase√±a:</label><input type="password" id="register-password" required></div>
          <div class="form-group"><label>Confirmar contrase√±a:</label><input type="password" id="register-confirm" required></div>
          <button class="btn-primary" type="submit">Registrarse</button>
        </form>
        <p>¬øYa tienes cuenta? <a href="#" onclick="showAuth('login')">Inicia sesi√≥n</a></p>
      </div>
    </div>
  </div>

  <audio id="audio-player" preload="metadata"></audio>
  <!-- ============== SCRIPTS COMPLETOS ============== -->
  <script>
/* ---------- VARIABLES ---------- */
const supabaseUrl = 'https://nqbldvpnqhngdtalvzov.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xYmxkdnBucWhuZ2R0YWx2em92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyMjY0NjUsImV4cCI6MjA3MDgwMjQ2NX0.Zzg5D219sW7bhvl0_R5ypX9MF6nRzBSDIeo2Lvebab0';
const ADMIN_EMAIL  = 'klmzr@gmail.com';
let supabase,currentUser=null;
let allAlbums=[],allSongs=[],songsWithAlbumInfo=[];
let currentAlbum=null,currentPlaylist=[],currentSong=null,currentIndex=0;
let isPlaying=false,repeatMode='off',shuffleMode=false;
let db=null;

/* ---------- IndexedDB (descargas offline) ---------- */
function initDB(){return new Promise((res,rej)=>{const r=indexedDB.open('KLMZMusicDB',2);r.onerror=()=>rej();r.onsuccess=e=>{db=e.target.result;res(db)};r.onupgradeneeded=e=>{const d=e.target.result;if(!d.objectStoreNames.contains('songs'))d.createObjectStore('songs',{keyPath:'id'})}});}
function saveSongToDB(s){return new Promise((res,rej)=>{const t=db.transaction(['songs'],'readwrite');t.objectStore('songs').put(s).onsuccess=res;t.onerror=e=>rej(e.target.error);});}
const getSongFromDB=id=>new Promise((res,rej)=>{const t=db.transaction(['songs']);t.objectStore('songs').get(id).onsuccess=e=>res(e.target.result);t.onerror=e=>rej(e.target.error);});
const getAllDownloadedSongs=()=>new Promise((res,rej)=>{const t=db.transaction(['songs']);t.objectStore('songs').getAll().onsuccess=e=>res(e.target.result);t.onerror=e=>rej(e.target.error);});

/* ---------- Utilidades UI ---------- */
const showLoadingIndicator=s=>document.getElementById('loading-indicator').style.display=s?'block':'none';
function showInfoModal(msg){alert(msg);}        // versi√≥n simple para depurar
function formatTime(sec){const m=Math.floor(sec/60);const s=Math.floor(sec%60).toString().padStart(2,'0');return`${m}:${s}`;}

/* ---------- Supabase ---------- */
async function loadSupabase(){
  showLoadingIndicator(true);
  const {createClient}=await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
  supabase=createClient(supabaseUrl,supabaseKey);
  supabase.auth.onAuthStateChange((_e,s)=>{currentUser=s?.user||null;updateAuthUI();});
  currentUser=(await supabase.auth.getSession()).data.session?.user||null;
  updateAuthUI(); await loadAllData();
  showLoadingIndicator(false);
}
async function loadAllData(){
  const [{data:albums},{data:songs}]=await Promise.all([
    supabase.from('albums').select('*'),
    supabase.from('songs').select('*, albums:album_id(*)')
  ]);
  allAlbums=albums; songsWithAlbumInfo=songs;
  displayAlbums(allAlbums);
}

/* ---------- √Ålbumes ---------- */
function displayAlbums(arr){
  const c=document.getElementById('albums');
  c.innerHTML=arr.map(a=>`
    <div class="album-card" onclick='showAlbumDetail(${JSON.stringify(a)})'>
      <img class="album-img" src="${a.cover_url}" alt="">
      <div class="album-title">${a.title}</div>
      <div class="album-artist">${a.artist}</div>
    </div>`).join('');
}
async function showAlbumDetail(album){
  currentAlbum=album;
  document.getElementById('albums').style.display='none';
  const d=document.getElementById('album-detail'); d.style.display='block';
  d.innerHTML=`<button class="btn-secondary" onclick="showAlbumsGrid()">‚üµ Volver</button>
    <div style="text-align:center;margin:1.5rem 0">
      <img class="album-img" src="${album.cover_url}" style="width:160px;height:160px">
      <div class="album-title" style="font-size:1.4rem;margin-top:.5rem">${album.title}</div>
      <div class="album-artist" style="color:#b3b3b3">${album.artist}</div>
    </div>
    <div id="detail-song-list">Cargando‚Ä¶</div>`;
  const {data:songs}=await supabase.from('songs').select('*').eq('album_id',album.id);
  currentPlaylist=songs; currentIndex=0;
  document.getElementById('detail-song-list').innerHTML='<ul>'+songs.map((s,i)=>`<li onclick="playSongFromPlaylist(${i})">${s.title}</li>`).join('')+'</ul>';
}
function showAlbumsGrid(){document.getElementById('album-detail').style.display='none';document.getElementById('albums').style.display='grid';}

/* ---------- Reproductor ---------- */
function playSong(song,album,list,i){
  currentSong=song;currentAlbum=album;currentPlaylist=list;currentIndex=i;
  const audio=document.getElementById('audio-player');
  audio.src=song.song_url; audio.play();
  document.getElementById('mini-player-img').src=album.cover_url;
  document.getElementById('mini-player-title').textContent=song.title;
  document.getElementById('mini-player-artist').textContent=album.artist;
  document.getElementById('mini-player').style.display='flex';
}
function playSongFromPlaylist(i){playSong(currentPlaylist[i],currentAlbum,currentPlaylist,i);}
function togglePlay(){const a=document.getElementById('audio-player');a.paused?a.play():a.pause();}

/* ---------- Navegaci√≥n secciones ---------- */
function showSection(sec){
  document.querySelectorAll('.content-section').forEach(s=>s.classList.remove('active'));
  document.getElementById(`${sec}-section`).classList.add('active');
  document.querySelectorAll('.bottom-nav-item').forEach(i=>i.classList.remove('active'));
  const map={home:'home',search:'search',downloads:'downloads',favorites:'favs'};document.getElementById(`nav-${map[sec]}`).classList.add('active');
  if(sec==='downloads') loadDownloads(); if(sec==='favorites') loadFavorites(); if(sec==='home') showAlbumsGrid();
}

/* ---------- ADMIN PANEL con subida de archivos ---------- */
async function renderAdminPanel(){
  const c=document.getElementById('admin-content');
  c.innerHTML=`<div class="admin-section">
    <h4>Gesti√≥n de √Ålbumes</h4>
    <form id="album-form" enctype="multipart/form-data">
      <input type="hidden" id="album-id">
      <input id="album-title" placeholder="T√≠tulo" required>
      <input id="album-artist" placeholder="Artista" required>
      <input id="album-cover-file" type="file" accept="image/*" required>
      <button class="btn-primary">Guardar √Ålbum</button>
    </form>
    <div id="admin-album-list"></div></div>

    <div class="admin-section">
    <h4>Gesti√≥n de Canciones</h4>
    <form id="song-form" enctype="multipart/form-data">
      <input type="hidden" id="song-id">
      <input id="song-title" placeholder="T√≠tulo" required>
      <select id="song-album-select" required></select>
      <input id="song-file" type="file" accept="audio/*" required>
      <button class="btn-primary">Guardar Canci√≥n</button>
    </form>
    <div id="admin-song-list"></div></div>`;
  await renderAdminLists(); setupAdminForms();
}
async function renderAdminLists(){
  const {data:albums}=await supabase.from('albums').select('*');
  const {data:songs}=await supabase.from('songs').select('*, albums:album_id(title)');
  document.getElementById('admin-album-list').innerHTML=albums.map(a=>`<div class="admin-item">${a.title}</div>`).join('');
  document.getElementById('admin-song-list') .innerHTML=songs .map(s=>`<div class="admin-item">${s.title} ‚Äî ${s.albums.title}</div>`).join('');
  document.getElementById('song-album-select').innerHTML=albums.map(a=>`<option value="${a.id}">${a.title}</option>`).join('');
}
function setupAdminForms(){
  document.getElementById('album-form').addEventListener('submit',async e=>{
    e.preventDefault();showLoadingIndicator(true);
    const f=e.target,title=f['album-title'].value,artist=f['album-artist'].value,file=f['album-cover-file'].files[0];
    const path=`covers/${Date.now()}_${file.name}`,up=await supabase.storage.from('covers').upload(path,file);
    if(up.error){showLoadingIndicator(false);return showInfoModal('Error subiendo portada');}
    const cover_url=supabase.storage.from('covers').getPublicUrl(path).data.publicUrl;
    await supabase.from('albums').insert([{title,artist,cover_url}]); showLoadingIndicator(false); renderAdminPanel(); loadAllData();
  });
  document.getElementById('song-form').addEventListener('submit',async e=>{
    e.preventDefault();showLoadingIndicator(true);
    const f=e.target,title=f['song-title'].value,album_id=f['song-album-select'].value,file=f['song-file'].files[0];
    const path=`audio/${Date.now()}_${file.name}`,up=await supabase.storage.from('audio').upload(path,file);
    if(up.error){showLoadingIndicator(false);return showInfoModal('Error subiendo audio');}
    const song_url=supabase.storage.from('audio').getPublicUrl(path).data.publicUrl;
    await supabase.from('songs').insert([{title,album_id,song_url}]); showLoadingIndicator(false); renderAdminPanel(); loadAllData();
  });
}

/* ---------- INIT ---------- */
document.addEventListener('DOMContentLoaded',()=>{
  initDB().then(loadSupabase);
});
  </script>

  <!-- Service Worker (opcional) -->
  <script>
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('./sw.js').catch(console.error);
  }
  </script>
</body>
</html>
