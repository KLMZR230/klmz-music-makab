<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>KLMZ MUSIC</title>
<style>
    body { background: #121212; color: #fff; font-family: Arial, sans-serif; margin:0; }
    header { padding: 15px; background: #181818; display:flex; align-items:center; justify-content:space-between; }
    h1 { margin:0; font-size: 22px; }
    .albums { display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; padding:20px; }
    .album { background:#181818; padding:10px; border-radius:8px; text-align:center; cursor:pointer; }
    .album img { width:100%; border-radius:6px; }
    .songs { padding: 10px; }
    .player { position: fixed; bottom: 0; left: 0; right: 0; background: #181818; display: flex; align-items: center; padding: 10px; }
    audio { flex: 1; }
    button { background:#1db954; border:none; padding:8px 15px; border-radius:20px; cursor:pointer; }
    button:hover { background:#1ed760; }
    input, select { padding:6px; border-radius:4px; border:none; }
</style>
</head>
<body>

<header>
  <h1>♫ KLMZ MUSIC</h1>
  <div id="auth-section">
    <input type="email" id="email" placeholder="Correo">
    <input type="password" id="password" placeholder="Contraseña">
    <button id="login-btn">Entrar</button>
    <button id="logout-btn" style="display:none;">Salir</button>
  </div>
</header>

<section id="admin-panel" style="display:none; padding:20px;">
  <h2>Subir Álbum</h2>
  <input type="text" id="album-title" placeholder="Título del álbum">
  <input type="file" id="album-cover" accept="image/*">
  <button id="upload-album-btn">Subir Álbum</button>

  <h2>Agregar Canciones a Álbum</h2>
  <select id="album-select"></select>
  <input type="file" id="song-files" accept="audio/*" multiple>
  <button id="upload-songs-btn">Subir Canciones</button>
</section>

<section style="padding:20px;">
  <input type="text" id="search" placeholder="Buscar álbum o canción..." style="width:100%; margin-bottom:15px;">
  <div class="albums" id="albums-list"></div>
</section>

<div class="player">
  <audio id="audio-player" controls></audio>
  <button id="fullscreen-btn">Pantalla completa</button>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = '<https://nqbldvpnqhngdtalvzov.supabase.co>';
const SUPABASE_KEY = '<eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xYmxkdnBucWhuZ2R0YWx2em92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyMjY0NjUsImV4cCI6MjA3MDgwMjQ2NX0.Zzg5D219sW7bhvl0_R5ypX9MF6nRzBSDIeo2Lvebab0>';
const ADMIN_EMAIL = 'klmzr@gmail.com';
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null;
let albums = [];

document.getElementById('login-btn').addEventListener('click', async () => {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) return alert(error.message);
    currentUser = data.user;
    updateUI();
});

document.getElementById('logout-btn').addEventListener('click', async () => {
    await supabase.auth.signOut();
    currentUser = null;
    updateUI();
});

async function updateUI() {
    document.getElementById('login-btn').style.display = currentUser ? 'none' : 'inline-block';
    document.getElementById('logout-btn').style.display = currentUser ? 'inline-block' : 'none';
    document.getElementById('email').style.display = currentUser ? 'none' : 'inline-block';
    document.getElementById('password').style.display = currentUser ? 'none' : 'inline-block';
    document.getElementById('admin-panel').style.display = currentUser && currentUser.email === ADMIN_EMAIL ? 'block' : 'none';
    loadAlbums();
}

document.getElementById('upload-album-btn').addEventListener('click', async () => {
    const title = document.getElementById('album-title').value;
    const coverFile = document.getElementById('album-cover').files[0];
    if (!title || !coverFile) return alert('Falta título o portada');

    const coverPath = `${crypto.randomUUID()}-${coverFile.name}`;
    let { error } = await supabase.storage.from('covers').upload(coverPath, coverFile);
    if (error) return alert(error.message);
    const { data: coverURL } = supabase.storage.from('covers').getPublicUrl(coverPath);

    await supabase.from('albums').insert([{ title, cover_url: coverURL.publicUrl }]);
    alert('Álbum subido');
    loadAlbums();
});

document.getElementById('upload-songs-btn').addEventListener('click', async () => {
    const albumId = document.getElementById('album-select').value;
    const files = document.getElementById('song-files').files;
    if (!albumId || files.length === 0) return alert('Selecciona un álbum y archivos');

    for (const file of files) {
        const filePath = `${crypto.randomUUID()}-${file.name}`;
        let { error } = await supabase.storage.from('songs').upload(filePath, file);
        if (error) { alert(`Error en ${file.name}`); continue; }
        const { data: songURL } = supabase.storage.from('songs').getPublicUrl(filePath);
        await supabase.from('songs').insert([{ album_id: albumId, title: file.name, file_url: songURL.publicUrl }]);
    }
    alert('Canciones subidas');
    loadAlbums();
});

async function loadAlbums() {
    const { data: albumData } = await supabase.from('albums').select('*');
    const { data: songsData } = await supabase.from('songs').select('*');
    albums = albumData.map(a => ({ ...a, songs: songsData.filter(s => s.album_id === a.id) }));
    renderAlbums(albums);
    populateAlbumSelect(albumData);
}

function renderAlbums(list) {
    const search = document.getElementById('search').value.toLowerCase();
    const filtered = list.filter(a => a.title.toLowerCase().includes(search) || a.songs.some(s => s.title.toLowerCase().includes(search)));
    const container = document.getElementById('albums-list');
    container.innerHTML = '';
    filtered.forEach(album => {
        const div = document.createElement('div');
        div.className = 'album';
        div.innerHTML = `<img src="${album.cover_url}"><h3>${album.title}</h3>`;
        div.onclick = () => showSongs(album);
        container.appendChild(div);
    });
}

function populateAlbumSelect(albums) {
    const select = document.getElementById('album-select');
    select.innerHTML = '';
    albums.forEach(a => {
        const opt = document.createElement('option');
        opt.value = a.id;
        opt.textContent = a.title;
        select.appendChild(opt);
    });
}

function showSongs(album) {
    const container = document.getElementById('albums-list');
    container.innerHTML = `<div class="songs">
        <button onclick="loadAlbums()">⬅ Volver</button>
        <h2>${album.title}</h2>
        ${album.songs.map(s => `<div><button onclick="playSong('${s.file_url}')">▶</button> ${s.title}</div>`).join('')}
    </div>`;
}

function playSong(url) {
    const audio = document.getElementById('audio-player');
    audio.src = url;
    audio.play();
}

document.getElementById('fullscreen-btn').addEventListener('click', () => {
    const player = document.querySelector('.player');
    if (document.fullscreenElement) {
        document.exitFullscreen();
    } else {
        player.requestFullscreen();
    }
});

document.getElementById('search').addEventListener('input', () => renderAlbums(albums));

updateUI();
</script>
</body>
</html>
