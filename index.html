<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>KLMZ MUSIC</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
    body {
        font-family: Arial, sans-serif;
        background: #121212;
        color: white;
        margin: 0;
        padding-bottom: 100px; /* espacio para el reproductor */
    }
    header {
        background: #1db954;
        padding: 15px;
        text-align: center;
        font-size: 24px;
        font-weight: bold;
    }
    .albums {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 20px;
        padding: 20px;
    }
    .album {
        background: #181818;
        padding: 15px;
        border-radius: 10px;
        text-align: center;
        transition: transform 0.2s;
        cursor: pointer;
    }
    .album:hover {
        transform: scale(1.05);
        background: #282828;
    }
    .album img {
        width: 100%;
        border-radius: 8px;
        margin-bottom: 10px;
    }
    .songs {
        padding: 20px;
    }
    #admin-panel, #login-panel {
        background: #181818;
        padding: 20px;
        margin: 20px;
        border-radius: 10px;
    }
    input, select {
        padding: 8px;
        margin: 5px 0;
        width: 100%;
        border: none;
        border-radius: 5px;
    }
    button {
        background: #1db954;
        color: white;
        border: none;
        padding: 10px 15px;
        cursor: pointer;
        border-radius: 5px;
        margin-top: 5px;
    }
    button:hover {
        background: #17a74a;
    }
    /* Reproductor */
    #player-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: #181818;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 20px;
        border-top: 1px solid #333;
    }
    #player-info {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    #player-controls {
        display: flex;
        align-items: center;
        gap: 10px;
    }
</style>
</head>
<body>

<header>KLMZ MUSIC</header>

<div id="login-panel">
    <h3>Iniciar sesión (admin)</h3>
    <input type="email" id="email" placeholder="Correo">
    <input type="password" id="password" placeholder="Contraseña">
    <button onclick="login()">Entrar</button>
</div>

<div id="admin-panel" style="display:none;">
    <h3>Subir Álbum</h3>
    <input type="text" id="album-name" placeholder="Nombre del álbum">
    <input type="file" id="album-cover">
    <button onclick="uploadAlbum()">Subir Álbum</button>

    <h3>Subir Canción</h3>
    <select id="album-select"></select>
    <input type="text" id="song-name" placeholder="Nombre de la canción">
    <input type="file" id="song-file">
    <button onclick="uploadSong()">Subir Canción</button>
</div>

<h2 style="padding:20px;">Álbumes</h2>
<div class="albums" id="albums"></div>

<div class="songs" id="songs"></div>

<!-- Reproductor fijo -->
<div id="player-bar">
    <div id="player-info">
        <span id="current-song">Nada reproduciéndose</span>
    </div>
    <div id="player-controls">
        <audio id="audio-player" controls style="height:30px;"></audio>
        <button onclick="fullscreenPlayer()">Pantalla completa</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://nqbldvpnqhngdtalvzov.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xYmxkdnBucWhuZ2R0YWx2em92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyMjY0NjUsImV4cCI6MjA3MDgwMjQ2NX0.Zzg5D219sW7bhvl0_R5ypX9MF6nRzBSDIeo2Lvebab0";
const ADMIN_EMAIL = "klmzr@gmail.com";

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
let session = null;

async function login() {
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;

    const { data, error } = await supabaseClient.auth.signInWithPassword({
        email,
        password
    });

    if (error) {
        alert("Error al iniciar sesión: " + error.message);
    } else {
        session = data.session;
        const userEmail = data.user.email;
        if (userEmail.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
            document.getElementById("admin-panel").style.display = "block";
            loadAlbumsSelect();
        }
        document.getElementById("login-panel").style.display = "none";
    }
}

async function loadAlbums() {
    const { data, error } = await supabaseClient.from("albums").select("*").order("id");
    if (!error) {
        const container = document.getElementById("albums");
        container.innerHTML = "";
        data.forEach(album => {
            const div = document.createElement("div");
            div.className = "album";
            div.innerHTML = `<img src="${album.cover}" alt="${album.name}">
                             <p>${album.name}</p>`;
            div.onclick = () => loadSongs(album.id);
            container.appendChild(div);
        });
    }
}

async function loadAlbumsSelect() {
    const { data } = await supabaseClient.from("albums").select("*").order("id");
    const sel = document.getElementById("album-select");
    sel.innerHTML = "";
    data.forEach(album => {
        const opt = document.createElement("option");
        opt.value = album.id;
        opt.textContent = album.name;
        sel.appendChild(opt);
    });
}

async function loadSongs(albumId) {
    const { data, error } = await supabaseClient.from("songs").select("*").eq("album_id", albumId);
    const container = document.getElementById("songs");
    container.innerHTML = "<h2>Canciones</h2>";
    if (!error) {
        data.forEach(song => {
            const div = document.createElement("div");
            div.innerHTML = `<p>${song.name}</p>
                             <button onclick="playSong('${song.file}','${song.name}')">Reproducir</button>`;
            container.appendChild(div);
        });
    }
}

function playSong(url, name) {
    const player = document.getElementById("audio-player");
    player.src = url;
    player.play();
    document.getElementById("current-song").innerText = name;
}

function fullscreenPlayer() {
    const player = document.getElementById("audio-player");
    if (player.requestFullscreen) player.requestFullscreen();
}

async function uploadAlbum() {
    const name = document.getElementById("album-name").value;
    const file = document.getElementById("album-cover").files[0];
    if (!name || !file) return alert("Faltan datos");

    const { data: fileData, error: fileError } = await supabaseClient.storage
        .from("covers")
        .upload(`covers/${Date.now()}_${file.name}`, file);
    if (fileError) return alert("Error subiendo portada");

    const { data: publicUrl } = supabaseClient.storage
        .from("covers")
        .getPublicUrl(fileData.path);

    await supabaseClient.from("albums").insert({ name, cover: publicUrl.publicUrl });
    alert("Álbum subido");
    loadAlbums();
    loadAlbumsSelect();
}

async function uploadSong() {
    const albumId = document.getElementById("album-select").value;
    const name = document.getElementById("song-name").value;
    const file = document.getElementById("song-file").files[0];
    if (!albumId || !name || !file) return alert("Faltan datos");

    const { data: fileData, error: fileError } = await supabaseClient.storage
        .from("songs")
        .upload(`songs/${Date.now()}_${file.name}`, file);
    if (fileError) return alert("Error subiendo canción");

    const { data: publicUrl } = supabaseClient.storage
        .from("songs")
        .getPublicUrl(fileData.path);

    await supabaseClient.from("songs").insert({ album_id: albumId, name, file: publicUrl.publicUrl });
    alert("Canción subida");
}
loadAlbums();
</script>

</body>
</html>
