<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KLMZ MUSIC</title>
<meta name="description" content="KLMZ MUSIC - Tu plataforma de m√∫sica personal" />
<meta name="theme-color" content="#1db954" />
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{--bg:#121212;--panel:#181818;--panel2:#1f1f1f;--text:#fff;--muted:#b3b3b3;--brand:#1db954;--brand-hover:#17a84b;--stroke:#2a2a2a;--accent:#ff6b35;--error:#ff4444;--warning:#ffab00;--success:#4caf50;}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;padding-bottom:55px;overflow-x:hidden}
  @keyframes fadeIn{from{opacity:0}to{opacity:1}}
  @keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
  @keyframes slideDown{from{transform:translateY(0);opacity:1}to{transform:translateY(100px);opacity:0}}
  @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
  @keyframes wave{0%,40%,100%{height:15px;background:linear-gradient(to top,var(--brand),var(--accent))}20%{height:35px;background:linear-gradient(to top,var(--accent),#ffab00)}}
  @keyframes bounce{0%,20%,50%,80%,100%{transform:translateY(0)}40%{transform:translateY(-10px)}60%{transform:translateY(-5px)}}
  .fade-in{animation:fadeIn 0.5s ease}
  .slide-up{animation:slideUp 0.3s ease}
  .slide-down{animation:slideDown 0.3s ease}
  .bounce{animation:bounce 1s}
  .loading{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;flex-direction:column;z-index:9999;transition:opacity 0.3s ease}
  .loading .spinner{width:50px;height:50px;border:3px solid var(--stroke);border-top:3px solid var(--brand);border-radius:50%;animation:spin 1s linear infinite}
  .loading .text{margin-top:20px;color:var(--muted);font-weight:600}
  .gesture-hint{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.8);color:white;padding:12px 20px;border-radius:25px;font-size:14px;z-index:1000;opacity:0;pointer-events:none;transition:opacity 0.3s ease}
  .gesture-hint.show{opacity:1}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#1db954 0%,#1db954 60%,#179b47 100%);padding:14px 18px;font-weight:800;letter-spacing:.3px;backdrop-filter:blur(10px)}
  header .row{display:flex;align-items:center;gap:12px;justify-content:space-between}
  .brand{font-size:20px;display:flex;align-items:center;gap:8px;transition:transform 0.3s ease}
  .brand:hover{transform:scale(1.05)}
  .brand .logo{display:inline-grid;place-items:center;width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,#ff6b35,#ff4500);font-weight:900;color:#fff;font-size:16px;transition:all 0.3s ease}
  .brand .logo:hover{transform:rotate(360deg)}
  .tools{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{background:var(--brand);border:none;color:#fff;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:600;transition:all 0.3s ease}
  .btn:hover{background:var(--brand-hover);transform:translateY(-2px);box-shadow:0 4px 8px rgba(29,185,84,0.3)}
  .btn.ghost{background:transparent;border:1px solid #fff1}
  .btn.small{padding:6px 10px;font-size:12px}
  .btn.danger{background:var(--error)}
  .btn.danger:hover{background:#cc0000}
  .icon-btn{background:transparent;border:1px solid #ffffff22;color:#fff;padding:8px 10px;border-radius:10px;cursor:pointer;font-size:18px;line-height:1;transition:all 0.3s ease}
  .icon-btn:hover{background:#ffffff14;transform:scale(1.1)}
  .container{padding:18px;max-width:1100px;margin:auto}
  .card{background:var(--panel);border:1px solid var(--stroke);border-radius:14px;padding:14px;transition:all 0.3s ease}
  .grid{display:grid;gap:16px}
  .grid.albums{grid-template-columns:repeat(auto-fill,minmax(90px,1fr))}
  .grid.playlists{grid-template-columns:repeat(auto-fill,minmax(90px,1fr))}
  .album-card,.playlist-card{background:transparent;border:none;padding:8px;cursor:pointer;text-align:center;transition:.3s all ease;border-radius:12px}
  .album-card:hover,.playlist-card:hover{transform:translateY(-4px) scale(1.02);background:var(--panel)}
  .album-cover{width:100%;aspect-ratio:1/1;object-fit:cover;background:#0b0b0b;border:1px solid var(--stroke);transition:all 0.3s ease;border-radius:50%}
  .album-cover:hover{transform:scale(1.05);box-shadow:0 4px 12px rgba(29,185,84,0.3)}
  .playlist-cover{width:100%;aspect-ratio:1/1;object-fit:cover;background:linear-gradient(135deg,var(--brand),var(--accent));border:1px solid var(--stroke);transition:all 0.3s ease;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:2rem}
  .playlist-cover:hover{transform:scale(1.05);box-shadow:0 4px 12px rgba(29,185,84,0.3)}
  .album-title,.playlist-title{margin:8px 2px 0;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:.92rem}
  .album-meta,.playlist-meta{margin:0;color:var(--muted);font-size:.78rem}
  .muted{color:var(--muted)}
  .section-title{margin:6px 2px 12px;font-size:1.1rem;font-weight:800;letter-spacing:.2px;position:relative}
  .section-title::before{content:'';position:absolute;bottom:-4px;left:0;width:30px;height:2px;background:var(--brand);border-radius:2px}
  .inputs{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  input[type="text"],input[type="email"],input[type="password"],select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--stroke);background:#101010;color:#fff;transition:all 0.3s ease}
  input:focus,select:focus,textarea:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 2px rgba(29,185,84,0.2)}
  input[type="file"]{width:100%;padding:10px;border-radius:10px;border:1px dashed var(--stroke);background:#0f0f0f;color:var(--muted)}
  .stack{display:grid;gap:10px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .pill{padding:6px 10px;border-radius:999px;background:#ffffff10;border:1px solid var(--stroke);font-size:.8rem;color:#fff}
  .music-controls{display:flex;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap}
  .control-btn{background:var(--panel);border:1px solid var(--stroke);color:var(--muted);padding:8px 12px;border-radius:20px;cursor:pointer;font-size:12px;transition:all 0.3s ease;display:flex;align-items:center;gap:6px}
  .control-btn:hover{background:var(--brand);color:white;transform:scale(1.05)}
  .control-btn.active{background:var(--brand);color:white}
  .favorite-btn{background:none;border:none;color:var(--muted);cursor:pointer;font-size:18px;transition:all 0.3s ease;padding:4px;border-radius:50%}
  .favorite-btn:hover{color:#ff4444;transform:scale(1.2)}
  .favorite-btn.active{color:#ff4444}
  .download-btn{background:var(--success);border:none;color:white;padding:6px 10px;border-radius:15px;cursor:pointer;font-size:11px;transition:all 0.3s ease;display:flex;align-items:center;gap:4px}
  .download-btn:hover{background:#45a049;transform:scale(1.05)}
  .download-btn.downloaded{background:var(--muted);cursor:default}
  .delete-song-btn{background:var(--error);border:none;color:white;padding:6px 10px;border-radius:15px;cursor:pointer;font-size:11px;transition:all 0.3s ease;display:flex;align-items:center;gap:4px}
  .delete-song-btn:hover{background:#cc0000;transform:scale(1.05)}
  .playlist-btn{background:var(--accent);border:none;color:white;padding:6px 10px;border-radius:15px;cursor:pointer;font-size:11px;transition:all 0.3s ease;display:flex;align-items:center;gap:4px}
  .playlist-btn:hover{background:#e55722;transform:scale(1.05)}
  .download-progress{width:100%;height:4px;background:var(--stroke);border-radius:2px;overflow:hidden;margin-top:4px}
  .download-progress-bar{height:100%;background:var(--success);transition:width 0.3s ease;border-radius:2px}
  #albumView,#favoritesView,#downloadsView,#playlistsView,#playlistView{display:none}
  .album-hero,.playlist-hero{display:flex;gap:14px;align-items:center;margin-bottom:20px}
  .album-hero img,.playlist-hero img{width:96px;height:96px;border-radius:12px;border:1px solid var(--stroke);object-fit:cover;background:#0b0b0b}
  .album-hero .info,.playlist-hero .info{min-width:0;flex:1}
  .album-hero .title,.playlist-hero .title{font-size:1.2rem;font-weight:900}
  .album-hero .meta,.playlist-hero .meta{color:var(--muted);font-size:.9rem}
  .playlist-hero img{background:linear-gradient(135deg,var(--brand),var(--accent));display:flex;align-items:center;justify-content:center;font-size:3rem}
  .song-plain-list{margin-top:8px}
  .song-plain-item{padding:12px 8px;border-bottom:1px solid #1f1f1f;display:flex;align-items:center;gap:12px;transition:all 0.3s ease;border-radius:8px;margin-bottom:2px;cursor:pointer;position:relative}
  .song-plain-item:last-child{border-bottom:none}
  .song-plain-item:hover{background:var(--panel);transform:translateX(4px)}
  .song-plain-item .idx{min-width:20px;text-align:right;color:var(--muted)}
  .song-plain-item .title{flex:1;font-weight:600}
  .song-plain-item .actions{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
  .song-plain-item .more{font-size:18px;color:var(--muted);cursor:pointer;padding:6px;border-radius:50%;transition:all 0.3s ease}
  .song-plain-item .more:hover{background:#ffffff14;transform:scale(1.2)}
  .backline{display:flex;align-items:center;gap:10px;margin-bottom:20px}
  .back-btn{background:transparent;border:1px solid #ffffff22;color:#fff;width:36px;height:36px;border-radius:10px;font-size:18px;display:grid;place-items:center;cursor:pointer;transition:all 0.3s ease}
  .back-btn:hover{background:#ffffff14;transform:scale(1.1)}
  .player{position:fixed;left:0;right:0;bottom:55px;background:linear-gradient(135deg,#181818,#1f1f1f);border-top:1px solid var(--stroke);padding:8px 12px;z-index:20;display:none;height:60px;cursor:pointer;transition:all 0.3s ease}
  .player.show{display:flex;align-items:center;gap:12px}
  .player:hover{background:linear-gradient(135deg,#222,#2a2a2a)}
  .np{display:flex;align-items:center;gap:8px;min-width:0;flex:1;padding:4px;border-radius:8px;transition:all 0.3s ease}
  .np img{width:44px;height:44px;border-radius:8px;border:1px solid var(--stroke);object-fit:cover;background:#0b0b0b}
  .np .titles{min-width:0;flex:1}
  .np .titles .t{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:.9rem;line-height:1.2}
  .np .titles .a{color:var(--muted);font-size:.75rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.1;margin-top:2px}
  .player-controls{display:flex;align-items:center;gap:8px}
  .player-controls .circle{width:36px;height:36px;border-radius:50%;display:grid;place-items:center;border:1px solid var(--stroke);background:linear-gradient(135deg,#222,#333);font-size:16px;font-weight:900;cursor:pointer;transition:all 0.3s ease}
  .player-controls .circle:hover{transform:scale(1.1);background:var(--brand)}
  .player-controls .sm{width:32px;height:32px;font-size:14px}
  .player-seek{display:flex;align-items:center;gap:6px;min-width:120px}
  .player-seek input[type="range"]{width:100px;height:4px}
  .player-seek .time{font-size:.7rem;color:var(--muted);min-width:32px;text-align:center}
  .vol{display:flex;align-items:center;gap:6px;min-width:80px}
  .vol span{font-size:.7rem;color:var(--muted)}
  .vol input[type="range"]{width:60px;height:4px}
  .tag{padding:4px 8px;border:1px solid var(--stroke);border-radius:8px;font-size:.8rem;color:var(--muted)}
  .search-songs-list{display:flex;flex-direction:column;gap:8px}
  .search-song-item{display:flex;align-items:center;gap:12px;padding:8px 12px;border-radius:8px;cursor:pointer;transition:all 0.3s ease}
  .search-song-item:hover{background:var(--panel);transform:translateX(4px)}
  .search-song-cover{width:48px;height:48px;border-radius:8px;object-fit:cover;background:#0b0b0b;border:1px solid var(--stroke)}
  .search-song-info{flex:1;min-width:0}
  .search-song-title{font-weight:600;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:2px}
  .search-song-artist{color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .search-song-actions{display:flex;gap:8px;align-items:center}
  .search-song-play{background:var(--brand);border:none;color:white;width:32px;height:32px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;transition:all 0.3s ease}
  .search-song-play:hover{background:var(--brand-hover);transform:scale(1.1)}
  .no-results{text-align:center;color:var(--muted);padding:40px 20px;font-size:16px}
  #bottomBar{position:fixed;bottom:0;left:0;width:100%;height:55px;background:linear-gradient(135deg,var(--panel2),#252525);border-top:1px solid var(--stroke);display:grid;grid-template-columns:1fr 1fr 1fr 1fr;place-items:center;padding:4px 12px 2px;z-index:40}
  #bottomBar button{background:transparent;border:none;color:var(--muted);cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:2px;font-size:9px;font-weight:500;text-transform:uppercase;letter-spacing:0.3px;user-select:none;transition:all 0.3s ease;padding:6px;border-radius:8px;position:relative}
  #bottomBar button.active,#bottomBar button:hover{color:var(--brand);transform:translateY(-2px)}
  #bottomBar .icon{width:22px;height:22px;stroke:currentColor;stroke-width:2;fill:none}
  #bottomBar .label{font-size:9px;font-weight:600;margin-top:1px}
  .soundwave{width:80px;height:30px;display:flex;align-items:center;gap:3px}
  .bar{width:4px;height:12px;background:linear-gradient(to top,var(--brand),var(--accent));border-radius:2px;animation:wave 1.2s infinite ease-in-out;animation-fill-mode:both}
  .bar:nth-child(1){animation-delay:-1.1s}
  .bar:nth-child(2){animation-delay:-0.9s}
  .bar:nth-child(3){animation-delay:-0.7s}
  .bar:nth-child(4){animation-delay:-0.5s}
  .bar:nth-child(5){animation-delay:-0.3s}
  .status-indicator{position:fixed;top:80px;right:20px;z-index:100}
  .error-msg{background:linear-gradient(135deg,var(--error),#cc0000);color:white;padding:12px 16px;border-radius:8px;font-size:12px;font-weight:600}
  .success-msg{background:linear-gradient(135deg,var(--success),#2e7d32);color:white;padding:12px 16px;border-radius:8px;font-size:12px;font-weight:600}
  .warning-msg{background:linear-gradient(135deg,var(--warning),#f57f17);color:black;padding:12px 16px;border-radius:8px;font-size:12px;font-weight:600}
  #npOverlay{position:fixed;inset:0;background:rgba(0,0,0,0.9);backdrop-filter:blur(20px);display:none;align-items:center;justify-content:center;z-index:40;animation:fadeIn 0.4s ease;transition:opacity 0.3s ease}
  #npCard{background:linear-gradient(135deg,#111,#222);border:1px solid var(--stroke);border-radius:18px;width:min(520px,92vw);padding:24px;display:grid;gap:16px;justify-items:center;animation:slideUp 0.4s ease}
  #npCard img{width:min(420px,82vw);height:min(420px,82vw);border-radius:14px;object-fit:cover;border:1px solid var(--stroke);background:#0b0b0b;transition:all 0.5s ease;cursor:pointer;touch-action:manipulation}
  #npCard img:hover{transform:scale(1.02)}
  #npCard .t{font-size:1.2rem;font-weight:900;text-align:center}
  #npCard .a{color:var(--muted);text-align:center}
  .controls{display:flex;flex-direction:column;gap:10px}
  .controls .buttons{display:flex;align-items:center;justify-content:center;gap:18px}
  .controls .buttons .circle{width:64px;height:64px;border-radius:50%;display:grid;place-items:center;border:1px solid var(--stroke);background:linear-gradient(135deg,#222,#333);font-size:26px;font-weight:900;cursor:pointer;transition:all 0.3s ease}
  .controls .buttons .circle:hover{transform:scale(1.1)}
  .controls .buttons .sm{width:52px;height:52px;font-size:22px}
  .controls .seek{display:flex;align-items:center;gap:10px}
  .controls input[type="range"]{width:100%}
  .playlist-modal{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:50;animation:fadeIn 0.3s ease}
  .playlist-modal-content{background:var(--panel);border-radius:16px;padding:20px;width:min(400px,90vw);max-height:80vh;overflow-y:auto}
  .playlist-grid{display:grid;gap:8px;margin-top:12px;max-height:300px;overflow-y:auto}
  .playlist-item{display:flex;align-items:center;gap:12px;padding:8px;border-radius:8px;cursor:pointer;transition:all 0.3s ease}
  .playlist-item:hover{background:var(--panel2)}
  .playlist-item img{width:40px;height:40px;border-radius:6px;background:linear-gradient(135deg,var(--brand),var(--accent));display:flex;align-items:center;justify-content:center;color:white;font-size:16px}
  .playlist-item .info{flex:1}
  .playlist-item .name{font-weight:600;font-size:14px}
  .playlist-item .count{color:var(--muted);font-size:12px}
  @media (max-width:600px){
    .player{padding:6px 8px;height:56px}
    .np img{width:40px;height:40px}
    .np .titles .t{font-size:.8rem}
    .np .titles .a{font-size:.7rem}
    .player-controls .circle{width:32px;height:32px;font-size:14px}
    .player-controls .sm{width:28px;height:28px;font-size:12px}
    .player-seek{min-width:100px}
    .player-seek input[type="range"]{width:80px}
    .vol{min-width:60px}
    .vol input[type="range"]{width:40px}
    .player-seek .time{font-size:.65rem;min-width:28px}
    .vol span{font-size:.65rem}
    .inputs{grid-template-columns:1fr}
    .controls .buttons .circle{width:76px;height:76px;font-size:30px}
    .controls .buttons .sm{width:60px;height:60px;font-size:24px}
    .song-plain-item .actions{flex-direction:column;gap:4px}
    .grid.playlists{grid-template-columns:repeat(auto-fill,minmax(80px,1fr))}
    #bottomBar{height:50px;padding:3px 10px 2px}
    #bottomBar .icon{width:20px;height:20px}
    #bottomBar .label{font-size:8px}
    #bottomBar button{padding:5px;gap:1px}
  }
  @media (max-width:400px){
    .player{flex-wrap:wrap;height:auto;padding:6px}
    .np{order:1;width:100%;margin-bottom:4px}
    .player-controls{order:2}
    .player-seek{order:3;flex:1}
    .vol{order:4}
    #bottomBar{height:48px;padding:2px 8px 1px}
    #bottomBar .icon{width:18px;height:18px}
    #bottomBar .label{font-size:7px}
    #bottomBar button{padding:4px;gap:1px}
  }
</style>
</head>
<body>
<div id="loadingScreen" class="loading">
  <div class="spinner"></div>
  <div class="text">Cargando KLMZ MUSIC...</div>
</div>

<div id="gestureHint" class="gesture-hint"></div>

<header>
  <div class="row">
    <div class="brand">
      <span class="logo">üî•</span> 
      KLMZ MUSIC
    </div>
    <div class="tools">
      <span class="muted" id="albumsTitle">Tu m√∫sica</span>
      <button class="icon-btn" id="btn-login" title="Admin" onclick="showLogin()">üîë</button>
      <button class="btn ghost" id="btn-logout" style="display:none" onclick="logout()">Salir</button>
    </div>
  </div>
</header>

<div class="container">
  <div class="row muted" style="margin-bottom:20px;">
    <span class="tag">Cat√°logo p√∫blico</span>
    <span id="adminTag" class="tag" style="display:none">Admin</span>
    <span id="userTag" class="tag" style="display:none">Usuario</span>
    <span id="offlineTag" class="tag" style="display:none;background:var(--success)">Offline</span>
  </div>

  <div id="musicControls" class="music-controls" style="display:none;">
    <button class="control-btn" id="shuffleBtn" onclick="toggleShuffle()" title="Aleatorio">
      <span>üîÄ</span> Shuffle
    </button>
    <button class="control-btn" id="repeatBtn" onclick="toggleRepeat()" title="Repetir">
      <span>üîÅ</span> Repeat
    </button>
    <button class="control-btn" onclick="showFavorites()" title="Favoritos">
      <span>‚ù§Ô∏è</span> Favoritos
    </button>
    <button class="control-btn" onclick="showDownloads()" title="Descargas">
      <span>üì•</span> Offline
    </button>
  </div>

  <div id="favoritesView" style="display:none;">
    <div class="backline">
      <button class="back-btn" onclick="closeFavoritesView()" title="Volver">‚Üê</button>
      <span class="muted">Volver</span>
    </div>
    <div class="section-title">‚ù§Ô∏è Mis Favoritos</div>
    <div id="favoritesList" class="search-songs-list"></div>
    <div id="emptyFavorites" class="no-results" style="display:none;">
      <div style="font-size:48px;margin-bottom:16px">‚ù§Ô∏è</div>
      <div>No tienes favoritos a√∫n</div>
    </div>
  </div>

  <div id="downloadsView" style="display:none;">
    <div class="backline">
      <button class="back-btn" onclick="closeDownloadsView()" title="Volver">‚Üê</button>
      <span class="muted">Volver</span>
    </div>
    <div class="section-title">üì• M√∫sica Offline</div>
    <div id="downloadsList" class="search-songs-list"></div>
    <div id="emptyDownloads" class="no-results" style="display:none;">
      <div style="font-size:48px;margin-bottom:16px">üì•</div>
      <div>No tienes m√∫sica offline</div>
    </div>
  </div>

  <div id="playlistsView" style="display:none;">
    <div class="backline">
      <button class="back-btn" onclick="closePlaylistsView()" title="Volver">‚Üê</button>
      <span class="muted">Volver</span>
    </div>
    <div class="row" style="align-items:center;justify-content:space-between;margin-bottom:12px">
      <div class="section-title" style="margin:0">üì± Mis Playlists</div>
      <button class="btn small" onclick="createNewPlaylist()">+ Nueva</button>
    </div>
    <div id="playlistsGrid" class="grid playlists"></div>
    <div id="emptyPlaylists" class="no-results" style="display:none;">
      <div style="font-size:48px;margin-bottom:16px">üì±</div>
      <div>No tienes playlists a√∫n</div>
      <button class="btn" onclick="createNewPlaylist()" style="margin-top:16px">Crear mi primera playlist</button>
    </div>
  </div>

  <div id="playlistView" class="card stack">
    <div class="backline">
      <button class="back-btn" onclick="closePlaylistView()" title="Volver">‚Üê</button>
      <span class="muted">Volver</span>
    </div>
    <div class="playlist-hero">
      <div id="pvCover">üì±</div>
      <div class="info">
        <div id="pvTitle" class="title">‚Äî</div>
        <div id="pvMeta" class="meta">‚Äî</div>
        <div class="row" style="margin-top:8px;gap:8px">
          <button class="btn small" id="pvPlayBtn" onclick="playPlaylist()">‚ñ∂ Reproducir</button>
          <button class="btn small ghost" id="pvDeleteBtn" onclick="deletePlaylist()">üóëÔ∏è Eliminar</button>
        </div>
      </div>
    </div>
    <div id="pvSongs" class="song-plain-list"></div>
  </div>
  
  <div id="adminPanel" class="card stack" style="display:none">
    <div class="section-title">Panel Admin</div>
    <div class="inputs">
      <div class="stack">
        <div class="pill">Crear nuevo √°lbum</div>
        <input id="albumTitle" type="text" placeholder="T√≠tulo del √°lbum" />
        <input id="albumCover" type="file" accept="image/*" />
        <button class="btn" onclick="uploadAlbum()">Subir √Ålbum</button>
      </div>
      <div class="stack">
        <div class="pill">Agregar canciones a un √°lbum existente</div>
        <select id="albumSelect"></select>
        <input id="songTitle" type="text" placeholder="T√≠tulo de la canci√≥n (opcional si subes 1)" />
        <input id="songFiles" type="file" accept="audio/*" multiple />
        <button class="btn" onclick="uploadSong()">Subir Canciones</button>
      </div>
      <div class="stack">
        <div class="pill">Eliminar canciones individuales</div>
        <select id="deleteSongAlbumSelect" onchange="loadSongsForDeletion()">
          <option value="">Selecciona un √°lbum</option>
        </select>
        <select id="deleteSongSelect" style="display:none">
          <option value="">Selecciona una canci√≥n</option>
        </select>
        <button class="btn danger" onclick="deleteSong()" id="deleteSongBtn" style="display:none">üóëÔ∏è Eliminar Canci√≥n</button>
      </div>
      <div class="stack">
        <div class="pill">Eliminar √°lbumes completos</div>
        <select id="deleteAlbumSelect"></select>
        <button class="btn ghost" onclick="deleteAlbum()">Eliminar √Ålbum Completo</button>
      </div>
    </div>
  </div>
  
  <div id="homeContent">
    <div class="section-title">Albums</div>
    <div id="albumsGrid" class="grid albums"></div>
    <div id="emptyAlbums" class="muted" style="display:none">No hay √°lbumes todav√≠a.</div>
  </div>
  
  <div id="albumView" class="card stack">
    <div class="backline">
      <button class="back-btn" onclick="closeAlbumView()" title="Volver">‚Üê</button>
      <span class="muted">Volver</span>
    </div>
    <div class="album-hero">
      <img id="avCover" alt="cover">
      <div class="info">
        <div id="avTitle" class="title">‚Äî</div>
        <div id="avMeta" class="meta">‚Äî</div>
      </div>
    </div>
    <div id="avSongs" class="song-plain-list"></div>
  </div>
</div>

<div class="player" id="player" onclick="openNowPlaying()">
  <div class="np">
    <img id="npCover" alt="cover">
    <div class="titles">
      <div id="npTitle" class="t">Cargando...</div>
      <div id="npAlbum" class="a">‚Äî</div>
    </div>
  </div>
  
  <div class="player-controls">
    <button class="circle sm" onclick="event.stopPropagation(); prevTrack()">‚èÆ</button>
    <button class="circle" id="playBtn" onclick="event.stopPropagation(); togglePlay()">‚ñ∂</button>
    <button class="circle sm" onclick="event.stopPropagation(); nextTrack()">‚è≠</button>
  </div>
  
  <div class="player-seek">
    <span id="curTime" class="time">0:00</span>
    <input id="seek" type="range" min="0" max="100" value="0" oninput="seekAudio(this.value)" onclick="event.stopPropagation()" />
    <span id="durTime" class="time">0:00</span>
  </div>
  
  <div class="vol">
    <span>Vol</span>
    <input id="vol" type="range" min="0" max="1" step="0.01" value="1" oninput="setVolume(this.value)" onclick="event.stopPropagation()" />
  </div>
  
  <div class="soundwave" id="soundwave" style="display:none">
    <div class="bar"></div><div class="bar"></div><div class="bar"></div>
  </div>
  <audio id="audio" preload="none" crossorigin="anonymous"></audio>
</div>

<div id="npOverlay" onclick="closeNowPlaying()">
  <div id="npCard" onclick="event.stopPropagation()">
    <img id="npBigCover" alt="cover">
    <div class="t" id="npBigTitle">‚Äî</div>
    <div class="a" id="npBigAlbum">‚Äî</div>
    
    <div class="row" style="margin:16px 0">
      <button class="favorite-btn" id="npFavoriteBtn" onclick="toggleCurrentFavorite()" title="Favorito">ü§ç</button>
      <button class="download-btn" id="npDownloadBtn" onclick="downloadCurrentSong()" title="Descargar">üì• Offline</button>
    </div>
    
    <div class="soundwave" style="margin:20px 0;">
      <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
    </div>
    
    <div class="controls" style="width:100%;max-width:520px">
      <div class="buttons">
        <button class="circle sm" onclick="prevTrack()">‚èÆ</button>
        <button class="circle" onclick="togglePlay()" id="playBtnBig">‚ñ∂</button>
        <button class="circle sm" onclick="nextTrack()">‚è≠</button>
      </div>
      <div class="seek">
        <span id="curTimeBig" class="muted">0:00</span>
        <input id="seekBig" type="range" min="0" max="100" value="0" oninput="seekAudio(this.value)" />
        <span id="durTimeBig" class="muted">0:00</span>
      </div>
    </div>
  </div>
</div>

<div id="bottomBar">
  <button id="btn-home" title="Inicio" onclick="goHome(); setActiveNav('home')" class="active">
    <svg class="icon" viewBox="0 0 24 24"><path d="M3 11L12 2l9 9v9a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2v-5H9v5a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-9z"/></svg>
    <span class="label">Inicio</span>
  </button>
  <button id="btn-search" title="Favoritos" onclick="showFavorites()">
    <svg class="icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="7"/><line x1="16.5" y1="16.5" x2="21" y2="21"/></svg>
    <span class="label">Favoritos</span>
  </button>
  <button id="btn-playlists" title="Playlists" onclick="showPlaylists()">
    <svg class="icon" viewBox="0 0 24 24"><path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/></svg>
    <span class="label">Playlists</span>
  </button>
  <button id="btn-account" title="Cuenta" onclick="showAccount()">
    <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="7" r="4"/><path d="M5.5 21a7.5 7.5 0 0 1 13 0"/></svg>
    <span class="label">Cuenta</span>
  </button>
</div>

<div id="playlistModal" class="playlist-modal">
  <div class="playlist-modal-content">
    <div class="section-title">Agregar a Playlist</div>
    <div class="playlist-grid" id="playlistModalGrid"></div>
    <div class="row" style="margin-top:16px;gap:8px">
      <button class="btn small" onclick="createPlaylistFromModal()">+ Nueva Playlist</button>
      <button class="btn small ghost" onclick="closePlaylistModal()">Cancelar</button>
    </div>
  </div>
</div>

<div id="loginModal" class="card" style="display:none;position:fixed;inset:0;margin:auto;max-width:420px;height:max-content;z-index:50">
  <div class="stack">
    <div class="section-title">Iniciar sesi√≥n</div>
    <input id="email" type="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Contrase√±a" />
    <div class="row">
      <button class="btn" onclick="login()">Entrar</button>
      <button class="btn ghost" onclick="hideLogin()">Cancelar</button>
    </div>
    <small class="muted">Crea una cuenta o inicia sesi√≥n para gestionar playlists.</small>
  </div>
</div>

<script>
const SUPABASE_URL = "https://nqbldvpnqhngdtalvzov.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xYmxkdnBucWhuZ2R0YWx2em92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyMjY0NjUsImV4cCI6MjA3MDgwMjQ2NX0.Zzg5D219sW7bhvl0_R5ypX9MF6nRzBSDIeo2Lvebab0";
const ADMIN_EMAIL = "klmzr@gmail.com";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let isAdmin = false, isLoggedIn = false, currentUser = null;
let albums = [], songsByAlbum = {}, flatSongs = [], playlists = [];
let queue = [], qIndex = -1, currentAlbum = null, currentPlaylist = null;
let isShuffleMode = false, repeatMode = 0;
let favorites = new Set(), downloads = new Map();
let touchStartY = 0, touchEndY = 0;
let currentSongForPlaylist = null;

const albumsGrid = document.getElementById("albumsGrid");
const emptyAlbums = document.getElementById("emptyAlbums");
const npCover = document.getElementById("npCover");
const npTitle = document.getElementById("npTitle");
const npAlbum = document.getElementById("npAlbum");
const playBtn = document.getElementById("playBtn");
const audioEl = document.getElementById("audio");
const seekEl = document.getElementById("seek");
const curTime = document.getElementById("curTime");
const durTime = document.getElementById("durTime");
const playerElement = document.getElementById("player");
const loadingScreen = document.getElementById("loadingScreen");
const shuffleBtn = document.getElementById("shuffleBtn");
const repeatBtn = document.getElementById("repeatBtn");
const musicControls = document.getElementById("musicControls");
const albumView = document.getElementById("albumView");
const avCover = document.getElementById("avCover");
const avTitle = document.getElementById("avTitle");
const avMeta = document.getElementById("avMeta");
const avSongs = document.getElementById("avSongs");
const homeContent = document.getElementById("homeContent");
const npOverlay = document.getElementById("npOverlay");
const npBigCover = document.getElementById("npBigCover");
const npBigTitle = document.getElementById("npBigTitle");
const npBigAlbum = document.getElementById("npBigAlbum");
const curTimeBig = document.getElementById("curTimeBig");
const durTimeBig = document.getElementById("durTimeBig");
const seekBig = document.getElementById("seekBig");
const playBtnBig = document.getElementById("playBtnBig");
const npFavoriteBtn = document.getElementById("npFavoriteBtn");
const npDownloadBtn = document.getElementById("npDownloadBtn");
const favoritesView = document.getElementById("favoritesView");
const downloadsView = document.getElementById("downloadsView");
const favoritesList = document.getElementById("favoritesList");
const downloadsList = document.getElementById("downloadsList");
const playlistsView = document.getElementById("playlistsView");
const playlistsGrid = document.getElementById("playlistsGrid");
const playlistView = document.getElementById("playlistView");
const gestureHint = document.getElementById("gestureHint");
const playlistModal = document.getElementById("playlistModal");

// ===== INICIALIZACI√ìN =====
(async () => {
  console.log('üöÄ Inicializando KLMZ MUSIC...');
  try {
    loadAppSettings();
    initializeCoverGesture();
    
    const { data } = await sb.auth.getSession();
    if (data?.session?.user?.email) {
      const email = data.session.user.email;
      currentUser = data.session.user;
      isLoggedIn = true;
      isAdmin = (email.toLowerCase() === ADMIN_EMAIL.toLowerCase());
      updateUIForUser();
    }
    
    await refreshCatalogOptimized();
    await loadPlaylists();
    
    if (albums.length > 0 || flatSongs.length > 0) {
      musicControls.style.display = 'flex';
    }
    
    setTimeout(() => {
      loadingScreen.style.opacity = '0';
      setTimeout(() => { loadingScreen.style.display = 'none'; }, 300);
    }, 800);
    
    showMessage('¬°KLMZ MUSIC cargado!', 'success');
  } catch (error) {
    console.error('Error inicializando:', error);
    showMessage('Error cargando la aplicaci√≥n', 'error');
    loadingScreen.style.display = 'none';
  }
})();

// ===== GESTO SIMPLE SOLO EN LA PORTADA =====
function initializeCoverGesture() {
  console.log('üñºÔ∏è Inicializando gesto simple en portada...');
  
  // Solo agregar gesto a la portada de pantalla completa
  const npBigCover = document.getElementById('npBigCover');
  if (npBigCover) {
    npBigCover.addEventListener('touchstart', handleCoverTouchStart, {passive: false});
    npBigCover.addEventListener('touchmove', handleCoverTouchMove, {passive: false});
    npBigCover.addEventListener('touchend', handleCoverTouchEnd, {passive: false});
  }
  
  showGestureHint('Desliza la portada hacia abajo para cerrar', 2000);
}

function handleCoverTouchStart(e) {
  touchStartY = e.touches[0].clientY;
}

function handleCoverTouchMove(e) {
  e.preventDefault();
  const currentY = e.touches.clientY;
  const deltaY = currentY - touchStartY;
  
  // Solo permitir deslizar hacia abajo
  if (deltaY > 0) {
    const cover = document.getElementById('npBigCover');
    const overlay = document.getElementById('npOverlay');
    
    // Aplicar transformaci√≥n visual
    cover.style.transform = `translateY(${deltaY * 0.3}px) scale(${1 - deltaY * 0.0005})`;
    overlay.style.opacity = 1 - (deltaY * 0.003);
  }
}

function handleCoverTouchEnd(e) {
  touchEndY = e.changedTouches[0].clientY;
  
  const cover = document.getElementById('npBigCover');
  const overlay = document.getElementById('npOverlay');
  
  // Resetear transformaciones
  cover.style.transform = '';
  overlay.style.opacity = '';
  
  const deltaY = touchEndY - touchStartY;
  const minSwipeDistance = 100;
  
  // Si desliz√≥ hacia abajo lo suficiente, cerrar SIN notificaci√≥n
  if (deltaY > minSwipeDistance) {
    closeNowPlaying();
  }
}

function showGestureHint(text, duration = 2000) {
  gestureHint.textContent = text;
  gestureHint.classList.add('show');
  
  setTimeout(() => {
    gestureHint.classList.remove('show');
  }, duration);
}

// ===== SISTEMA DE PLAYLISTS =====
async function loadPlaylists() {
  if (!currentUser) {
    playlists = getLocalPlaylists();
    return;
  }
  
  try {
    const { data, error } = await sb
      .from('playlists')
      .select('*')
      .eq('user_id', currentUser.id)
      .order('created_at', { ascending: false });
    
    if (error) {
      console.error('Error cargando playlists:', error);
      playlists = getLocalPlaylists();
      return;
    }
    
    playlists = data || [];
    console.log(`üì± Playlists cargadas: ${playlists.length}`);
  } catch (error) {
    console.error('Error cargando playlists:', error);
    playlists = getLocalPlaylists();
  }
}

function getLocalPlaylists() {
  const saved = localStorage.getItem('klmz-playlists');
  return saved ? JSON.parse(saved) : [];
}

function saveLocalPlaylists() {
  localStorage.setItem('klmz-playlists', JSON.stringify(playlists));
}

async function createNewPlaylist() {
  const name = prompt('Nombre de la nueva playlist:');
  if (!name || !name.trim()) return;
  
  const newPlaylist = {
    id: Date.now().toString(),
    name: name.trim(),
    songs: [],
    created_at: new Date().toISOString(),
    user_id: currentUser?.id || 'local'
  };
  
  if (currentUser) {
    try {
      const { data, error } = await sb
        .from('playlists')
        .insert([{
          name: newPlaylist.name,
          songs: [],
          user_id: currentUser.id
        }])
        .select()
        .single();
      
      if (error) throw error;
      
      newPlaylist.id = data.id;
      playlists.unshift(newPlaylist);
    } catch (error) {
      console.error('Error creando playlist:', error);
      playlists.unshift(newPlaylist);
      saveLocalPlaylists();
    }
  } else {
    playlists.unshift(newPlaylist);
    saveLocalPlaylists();
  }
  
  showMessage(`‚úÖ Playlist "${name}" creada`, 'success');
  
  if (document.getElementById('playlistsView').style.display !== 'none') {
    renderPlaylists();
  }
}

async function deletePlaylist() {
  if (!currentPlaylist || !confirm(`¬øEliminar playlist "${currentPlaylist.name}"?`)) return;
  
  if (currentUser && currentPlaylist.user_id !== 'local') {
    try {
      const { error } = await sb
        .from('playlists')
        .delete()
        .eq('id', currentPlaylist.id);
      
      if (error) throw error;
    } catch (error) {
      console.error('Error eliminando playlist:', error);
    }
  }
  
  playlists = playlists.filter(p => p.id !== currentPlaylist.id);
  saveLocalPlaylists();
  
  showMessage(`üóëÔ∏è Playlist eliminada`, 'info');
  closePlaylistView();
}

function showPlaylists() {
  hideAllViews();
  playlistsView.style.display = 'block';
  setActiveNav('playlists');
  renderPlaylists();
}

function renderPlaylists() {
  playlistsGrid.innerHTML = '';
  
  if (playlists.length === 0) {
    document.getElementById('emptyPlaylists').style.display = 'block';
    return;
  }
  
  document.getElementById('emptyPlaylists').style.display = 'none';
  
  playlists.forEach(playlist => {
    const songCount = playlist.songs ? playlist.songs.length : 0;
    const card = document.createElement('div');
    card.className = 'playlist-card';
    card.innerHTML = `
      <div class="playlist-cover">üì±</div>
      <div class="playlist-title">${playlist.name}</div>
      <div class="playlist-meta">${songCount} ${songCount === 1 ? 'canci√≥n' : 'canciones'}</div>
    `;
    
    card.addEventListener('click', () => {
      openPlaylist(playlist);
    });
    
    playlistsGrid.appendChild(card);
  });
}

function openPlaylist(playlist) {
  console.log('üì± Abriendo playlist:', playlist.name);
  currentPlaylist = playlist;
  const songs = playlist.songs || [];
  
  document.getElementById('pvCover').textContent = 'üì±';
  document.getElementById('pvTitle').textContent = playlist.name;
  document.getElementById('pvMeta').textContent = `${songs.length} ${songs.length === 1 ? 'canci√≥n' : 'canciones'}`;
  
  const pvSongs = document.getElementById('pvSongs');
  pvSongs.innerHTML = '';
  
  if (!songs.length) {
    pvSongs.innerHTML = `
      <div class="muted" style="padding:20px;text-align:center">
        <div style="font-size:48px;margin-bottom:16px">üì±</div>
        <div>Esta playlist est√° vac√≠a</div>
        <div style="margin-top:8px;font-size:14px">Agrega canciones desde los √°lbumes</div>
      </div>
    `;
  } else {
    songs.forEach((songId, idx) => {
      const song = flatSongs.find(s => s.id === songId);
      if (!song) return;
      
      const isFavorite = favorites.has(song.id);
      const row = document.createElement('div');
      row.className = 'song-plain-item';
      
      row.innerHTML = `
        <div class="idx">${idx + 1}</div>
        <div class="title">${song.title}</div>
        <div class="actions">
          <button class="favorite-btn ${isFavorite ? 'active' : ''}" onclick="event.stopPropagation(); toggleFavorite('${song.id}', this)" title="Favorito">${isFavorite ? '‚ù§Ô∏è' : 'ü§ç'}</button>
          <button class="btn small ghost" onclick="event.stopPropagation(); removeFromPlaylist('${song.id}')" title="Quitar de playlist">‚ùå</button>
        </div>
      `;
      
      row.onclick = function(e) {
        if (e.target.closest('.actions')) return;
        
        console.log('üéµ Reproduciendo desde playlist:', song.title);
        
        const playlistSongs = songs.map(id => flatSongs.find(s => s.id === id)).filter(Boolean);
        queue = playlistSongs;
        qIndex = idx;
        playTrackDirectly(queue[qIndex]);
      };
      
      pvSongs.appendChild(row);
    });
  }
  
  hideAllViews();
  playlistView.style.display = 'block';
  playlistView.scrollIntoView({ behavior: "smooth", block: "start" });
}

function playPlaylist() {
  if (!currentPlaylist || !currentPlaylist.songs.length) {
    showMessage('La playlist est√° vac√≠a', 'warning');
    return;
  }
  
  const playlistSongs = currentPlaylist.songs.map(id => flatSongs.find(s => s.id === id)).filter(Boolean);
  if (!playlistSongs.length) {
    showMessage('No se encontraron canciones v√°lidas', 'error');
    return;
  }
  
  queue = playlistSongs;
  qIndex = 0;
  playTrackDirectly(queue[qIndex]);
  
  showMessage(`‚ñ∂ Reproduciendo "${currentPlaylist.name}"`, 'success');
}

async function removeFromPlaylist(songId) {
  if (!currentPlaylist) return;
  
  currentPlaylist.songs = currentPlaylist.songs.filter(id => id !== songId);
  
  if (currentUser && currentPlaylist.user_id !== 'local') {
    try {
      await sb
        .from('playlists')
        .update({ songs: currentPlaylist.songs })
        .eq('id', currentPlaylist.id);
    } catch (error) {
      console.error('Error actualizando playlist:', error);
    }
  }
  
  saveLocalPlaylists();
  showMessage('Canci√≥n eliminada de la playlist', 'info');
  openPlaylist(currentPlaylist);
}

function closePlaylistView() {
  playlistView.style.display = 'none';
  showPlaylists();
  currentPlaylist = null;
}

function closePlaylistsView() {
  playlistsView.style.display = 'none';
  goHome();
}

function openPlaylistModal(songId) {
  currentSongForPlaylist = songId;
  const grid = document.getElementById('playlistModalGrid');
  grid.innerHTML = '';
  
  if (playlists.length === 0) {
    grid.innerHTML = '<div class="muted" style="padding:20px;text-align:center">No tienes playlists a√∫n</div>';
  } else {
    playlists.forEach(playlist => {
      const item = document.createElement('div');
      item.className = 'playlist-item';
      const songCount = playlist.songs ? playlist.songs.length : 0;
      const isAdded = playlist.songs && playlist.songs.includes(songId);
      
      item.innerHTML = `
        <div>üì±</div>
        <div class="info">
          <div class="name">${playlist.name} ${isAdded ? '‚úì' : ''}</div>
          <div class="count">${songCount} canciones</div>
        </div>
      `;
      
      if (!isAdded) {
        item.onclick = () => addToPlaylist(playlist.id, songId);
      }
      
      grid.appendChild(item);
    });
  }
  
  playlistModal.style.display = 'flex';
}

async function addToPlaylist(playlistId, songId) {
  const playlist = playlists.find(p => p.id === playlistId);
  if (!playlist) return;
  
  if (!playlist.songs) playlist.songs = [];
  if (playlist.songs.includes(songId)) {
    showMessage('La canci√≥n ya est√° en la playlist', 'warning');
    return;
  }
  
  playlist.songs.push(songId);
  
  if (currentUser && playlist.user_id !== 'local') {
    try {
      await sb
        .from('playlists')
        .update({ songs: playlist.songs })
        .eq('id', playlistId);
    } catch (error) {
      console.error('Error actualizando playlist:', error);
    }
  }
  
  saveLocalPlaylists();
  
  const song = flatSongs.find(s => s.id === songId);
  showMessage(`‚úÖ "${song?.title}" agregada a "${playlist.name}"`, 'success');
  
  closePlaylistModal();
}

function createPlaylistFromModal() {
  closePlaylistModal();
  createNewPlaylist();
}

function closePlaylistModal() {
  playlistModal.style.display = 'none';
  currentSongForPlaylist = null;
}

// ===== CAT√ÅLOGO Y √ÅLBUMES =====
async function refreshCatalogOptimized() {
  console.log('üéµ Cargando cat√°logo completo...');
  
  const { data: alb, error: e1 } = await sb.from("albums").select("*").order("created_at", { ascending: false });
  if (e1) { 
    console.error('Error cargando √°lbumes:', e1); 
    showMessage('Error cargando √°lbumes', 'error'); 
    return; 
  }
  
  albums = alb || [];
  emptyAlbums.style.display = albums.length ? "none" : "block";
  
  updateAdminSelects();
  
  songsByAlbum = {};
  flatSongs = [];
  
  for (const album of albums) {
    console.log(`üéµ Cargando canciones del √°lbum: ${album.title}`);
    
    const { data: songs, error } = await sb
      .from("songs")
      .select("*")
      .eq("album_id", album.id)
      .order("created_at", { ascending: true });
    
    if (!error && songs) {
      songsByAlbum[album.id] = songs;
      console.log(`‚úÖ Cargadas ${songs.length} canciones para "${album.title}"`);
      
      songs.forEach(song => {
        flatSongs.push({
          ...song,
          album_title: album.title,
          cover_url: album.cover_url
        });
      });
    } else {
      console.log(`‚ö†Ô∏è Sin canciones para "${album.title}"`);
      songsByAlbum[album.id] = [];
    }
  }
  
  renderAlbums();
  
  console.log(`üéâ Cat√°logo cargado: ${albums.length} √°lbumes, ${flatSongs.length} canciones totales`);
}

function updateAdminSelects() {
  const adminSel = document.getElementById("albumSelect");
  const delSel = document.getElementById("deleteAlbumSelect");
  const delSongAlbumSel = document.getElementById("deleteSongAlbumSelect");
  
  if (adminSel) {
    adminSel.innerHTML = "";
    albums.forEach(a => {
      const o = document.createElement("option");
      o.value = a.id; 
      o.textContent = a.title;
      adminSel.appendChild(o);
    });
  }
  
  if (delSel) {
    delSel.innerHTML = "";
    albums.forEach(a => {
      const d = document.createElement("option");
      d.value = a.id; 
      d.textContent = a.title;
      delSel.appendChild(d);
    });
  }
  
  if (delSongAlbumSel) {
    delSongAlbumSel.innerHTML = '<option value="">Selecciona un √°lbum</option>';
    albums.forEach(a => {
      const o = document.createElement("option");
      o.value = a.id;
      o.textContent = a.title;
      delSongAlbumSel.appendChild(o);
    });
  }
}

function loadSongsForDeletion() {
  const albumId = document.getElementById("deleteSongAlbumSelect").value;
  const songSelect = document.getElementById("deleteSongSelect");
  const deleteBtn = document.getElementById("deleteSongBtn");
  
  if (!albumId) {
    songSelect.style.display = 'none';
    deleteBtn.style.display = 'none';
    return;
  }
  
  const songs = songsByAlbum[albumId] || [];
  songSelect.innerHTML = '<option value="">Selecciona una canci√≥n</option>';
  
  songs.forEach(song => {
    const option = document.createElement("option");
    option.value = song.id;
    option.textContent = song.title;
    songSelect.appendChild(option);
  });
  
  songSelect.style.display = 'block';
  deleteBtn.style.display = 'block';
}

function renderAlbums() {
  albumsGrid.innerHTML = "";
  albums.forEach(album => {
    const songCount = songsByAlbum[album.id] ? songsByAlbum[album.id].length : 0;
    const card = document.createElement("div");
    card.className = "album-card";
    card.innerHTML = `
      <img class="album-cover" src="${album.cover_url}" alt="${album.title}">
      <div class="album-title">${album.title}</div>
      <div class="album-meta">${songCount} ${songCount === 1 ? 'canci√≥n' : 'canciones'}</div>
    `;
    
    card.addEventListener('click', () => {
      openAlbum(album);
    });
    
    albumsGrid.appendChild(card);
  });
}

function openAlbum(album) {
  console.log('üéµ Abriendo √°lbum:', album.title);
  currentAlbum = album;
  
  const songs = songsByAlbum[album.id] || [];
  console.log(`üéµ Canciones encontradas: ${songs.length}`);
  
  avCover.src = album.cover_url || "";
  avTitle.textContent = album.title;
  avMeta.textContent = `${songs.length} ${songs.length === 1 ? 'canci√≥n' : 'canciones'}`;
  
  avSongs.innerHTML = "";
  
  if (!songs.length) {
    avSongs.innerHTML = `
      <div class="muted" style="padding:20px;text-align:center">
        <div style="font-size:48px;margin-bottom:16px">üéµ</div>
        <div>Este √°lbum no tiene canciones todav√≠a</div>
        ${isAdmin ? '<div style="margin-top:8px;font-size:14px">Ve al panel admin para agregar canciones</div>' : ''}
      </div>
    `;
  } else {
    console.log(`üéµ Renderizando ${songs.length} canciones`);
    
    songs.forEach((song, idx) => {
      const isFavorite = favorites.has(song.id);
      const isDownloaded = downloads.has(song.id);
      const row = document.createElement("div");
      row.className = "song-plain-item";
      
      row.innerHTML = `
        <div class="idx">${idx + 1}</div>
        <div class="title">${song.title}</div>
        <div class="actions">
          <button class="favorite-btn ${isFavorite ? 'active' : ''}" onclick="event.stopPropagation(); toggleFavorite('${song.id}', this)" title="Favorito">${isFavorite ? '‚ù§Ô∏è' : 'ü§ç'}</button>
          <button class="download-btn ${isDownloaded ? 'downloaded' : ''}" onclick="event.stopPropagation(); downloadSong('${song.id}', '${song.song_url}', '${song.title.replace(/'/g, "\\'")}', this)" title="Descargar">${isDownloaded ? '‚úì' : 'üì•'}</button>
          <button class="playlist-btn" onclick="event.stopPropagation(); openPlaylistModal('${song.id}')" title="Agregar a playlist">üì±</button>
          ${isAdmin ? `<button class="delete-song-btn" onclick="event.stopPropagation(); deleteSongFromAlbum('${song.id}', '${song.title.replace(/'/g, "\\'")}', '${album.id}')" title="Eliminar canci√≥n">üóëÔ∏è</button>` : ''}
        </div>
      `;
      
      row.onclick = function(e) {
        if (e.target.closest('.actions')) return;
        
        console.log('üéµ Reproduciendo:', song.title);
        
        queue = songs.map(s => ({
          id: s.id,
          title: s.title,
          song_url: s.song_url,
          album_title: album.title,
          cover_url: album.cover_url
        }));
        
        qIndex = idx;
        playTrackDirectly(queue[qIndex]);
      };
      
      avSongs.appendChild(row);
    });
  }
  
  hideAllViews();
  albumView.style.display = "block";
  albumView.scrollIntoView({ behavior: "smooth", block: "start" });
}

async function deleteSongFromAlbum(songId, songTitle, albumId) {
  if (!isAdmin) {
    showMessage('No autorizado', 'error');
    return;
  }
  
  if (!confirm(`¬øEliminar "${songTitle}" permanentemente?`)) return;
  
  try {
    const { error } = await sb.from("songs").delete().eq("id", songId);
    
    if (error) {
      showMessage('Error eliminando canci√≥n: ' + error.message, 'error');
      return;
    }
    
    showMessage(`"${songTitle}" eliminada exitosamente`, 'success');
    
    await refreshCatalogOptimized();
    const album = albums.find(a => a.id === albumId);
    if (album) {
      openAlbum(album);
    }
    
  } catch (error) {
    console.error('Error eliminando canci√≥n:', error);
    showMessage('Error eliminando canci√≥n', 'error');
  }
}

async function deleteSong() {
  if (!isAdmin) return alert("No autorizado");
  
  const songId = document.getElementById("deleteSongSelect").value;
  if (!songId) return alert("Selecciona una canci√≥n");
  
  const songSelect = document.getElementById("deleteSongSelect");
  const selectedOption = songSelect.options[songSelect.selectedIndex];
  const songTitle = selectedOption.textContent;
  
  if (!confirm(`¬øEliminar "${songTitle}" permanentemente?`)) return;
  
  try {
    const { error } = await sb.from("songs").delete().eq("id", songId);
    
    if (error) {
      alert("Error eliminando canci√≥n: " + error.message);
      return;
    }
    
    showMessage(`"${songTitle}" eliminada exitosamente`, "success");
    
    document.getElementById("deleteSongAlbumSelect").value = "";
    document.getElementById("deleteSongSelect").style.display = 'none';
    document.getElementById("deleteSongBtn").style.display = 'none';
    
    await refreshCatalogOptimized();
    
  } catch (error) {
    console.error('Error eliminando canci√≥n:', error);
    alert('Error eliminando canci√≥n');
  }
}

function playTrackDirectly(song) {
  console.log('üéµ Reproduciendo directamente:', song.title);
  console.log('üéµ URL:', song.song_url);
  
  if (!song || !song.song_url) {
    console.error('‚ùå Error: canci√≥n o URL no v√°lida');
    showMessage('Error: no se puede reproducir esta canci√≥n', 'error');
    return;
  }
  
  audioEl.pause();
  audioEl.currentTime = 0;
  audioEl.src = song.song_url;
  
  npTitle.textContent = song.title;
  npAlbum.textContent = song.album_title || "‚Äî";
  npCover.src = song.cover_url || "";
  
  npBigTitle.textContent = song.title;
  npBigAlbum.textContent = song.album_title || "‚Äî";
  npBigCover.src = song.cover_url || "";
  
  updateCurrentFavoriteButton();
  updateCurrentDownloadButton();
  
  showPlayer();
  
  audioEl.play()
    .then(() => {
      console.log('‚úÖ Reproducci√≥n exitosa');
      playBtn.textContent = "‚è∏";
      playBtnBig.textContent = "‚è∏";
      toggleSoundwave(true);
    })
    .catch((error) => {
      console.error('‚ùå Error reproduciendo:', error);
      showMessage(`Error reproduciendo "${song.title}": ${error.message}`, 'error');
    });
}

function closeAlbumView() {
  albumView.style.display = "none";
  homeContent.style.display = "block";
  currentAlbum = null;
}

function hideAllViews() {
  homeContent.style.display = "none";
  albumView.style.display = "none";
  favoritesView.style.display = "none";
  downloadsView.style.display = "none";
  playlistsView.style.display = "none";
  playlistView.style.display = "none";
}

function loadAppSettings() {
  const savedFavorites = localStorage.getItem('klmz-favorites');
  if (savedFavorites) { 
    favorites = new Set(JSON.parse(savedFavorites)); 
  }
  
  isShuffleMode = localStorage.getItem('klmz-shuffle') === 'true';
  repeatMode = parseInt(localStorage.getItem('klmz-repeat') || '0');
  
  const savedDownloads = localStorage.getItem('klmz-downloads');
  if (savedDownloads) { downloads = new Map(JSON.parse(savedDownloads)); }
  
  updateControlsUI();
  updateOfflineStatus();
}

function saveAppSettings() {
  localStorage.setItem('klmz-favorites', JSON.stringify([...favorites]));
  localStorage.setItem('klmz-shuffle', isShuffleMode.toString());
  localStorage.setItem('klmz-repeat', repeatMode.toString());
  localStorage.setItem('klmz-downloads', JSON.stringify([...downloads]));
}

function updateControlsUI() {
  if (shuffleBtn) { 
    shuffleBtn.classList.toggle('active', isShuffleMode); 
  }
  if (repeatBtn) {
    const icons = ['üîÅ', 'üîÇ', 'üîÇ'];
    const texts = ['Repeat', 'Repeat All', 'Repeat One'];
    repeatBtn.innerHTML = `<span>${icons[repeatMode]}</span> ${texts[repeatMode]}`;
    repeatBtn.classList.toggle('active', repeatMode > 0);
  }
}

function updateUIForUser() {
  document.getElementById("btn-login").style.display = "none";
  document.getElementById("btn-logout").style.display = "inline-flex";
  
  if (isAdmin) {
    document.getElementById("adminPanel").style.display = "block";
    document.getElementById("adminTag").style.display = "inline-block";
  }
  
  if (isLoggedIn) {
    document.getElementById("userTag").style.display = "inline-block";
  }
}

function showMessage(msg, type = 'info') {
  const existingMsg = document.querySelector('.status-indicator');
  if (existingMsg) existingMsg.remove();
  
  const className = type === 'error' ? 'error-msg' : type === 'success' ? 'success-msg' : type === 'warning' ? 'warning-msg' : 'error-msg';
  const errorEl = document.createElement('div');
  errorEl.className = `status-indicator ${className}`;
  errorEl.textContent = msg;
  document.body.appendChild(errorEl);
  setTimeout(() => errorEl.remove(), 3000);
}

async function uploadSong() {
  if (!isAdmin) {
    alert("No autorizado");
    return;
  }
  
  const albumId = document.getElementById("albumSelect").value;
  const titleInput = document.getElementById("songTitle").value.trim();
  const files = document.getElementById("songFiles").files;
  
  if (!albumId) {
    alert("Selecciona un √°lbum");
    return;
  }
  
  if (files.length === 0) {
    alert("Selecciona al menos un archivo de audio");
    return;
  }
  
  console.log('üéµ Iniciando subida de canciones...');
  console.log('üìÅ √Ålbum ID:', albumId);
  console.log('üéº Archivos seleccionados:', files.length);
  
  let ok = 0, fail = 0;
  
  for (let i = 0; i < files.length; i++) {
    const file = files[i];
    console.log(`üéµ Procesando archivo ${i + 1}/${files.length}:`, file.name);
    console.log('üìä Tipo:', file.type, '| Tama√±o:', (file.size / 1024 / 1024).toFixed(2), 'MB');
    
    if (!file.type.startsWith('audio/')) {
      console.error('‚ùå No es archivo de audio:', file.name);
      fail++;
      continue;
    }
    
    try {
      const timestamp = Date.now();
      const randomSuffix = Math.random().toString(36).substring(2, 8);
      const safeName = file.name.replace(/[^a-zA-Z0-9\.\-_]/g, "-");
      const path = `${timestamp}-${randomSuffix}-${safeName}`;
      
      console.log('üì§ Subiendo a storage con path:', path);
      
      const { data: uploadData, error: upErr } = await sb.storage
        .from("songs")
        .upload(path, file, {
          cacheControl: '3600',
          upsert: false
        });
      
      if (upErr) {
        console.error('‚ùå Error subiendo archivo:', upErr);
        showMessage(`Error subiendo ${file.name}: ${upErr.message}`, 'error');
        fail++;
        continue;
      }
      
      console.log('‚úÖ Archivo subido exitosamente:', uploadData);
      
      const { data: pub } = sb.storage.from("songs").getPublicUrl(path);
      const song_url = pub.publicUrl;
      console.log('üîó URL generada:', song_url);
      
      let title;
      if (files.length === 1 && titleInput) {
        title = titleInput;
      } else {
        title = file.name.replace(/\.[^/.]+$/, "");
      }
      
      console.log('üéµ T√≠tulo de canci√≥n:', title);
      
      const { data: songData, error: insErr } = await sb
        .from("songs")
        .insert([{
          album_id: albumId,
          title: title,
          song_url: song_url
        }])
        .select();
      
      if (insErr) {
        console.error('‚ùå Error guardando en DB:', insErr);
        showMessage(`Error guardando ${title}: ${insErr.message}`, 'error');
        fail++;
        
        try {
          await sb.storage.from("songs").remove([path]);
        } catch (cleanupErr) {
          console.error('Error limpiando archivo:', cleanupErr);
        }
      } else {
        console.log('‚úÖ Canci√≥n guardada en DB:', songData);
        ok++;
        showMessage(`‚úÖ "${title}" subida exitosamente`, 'success');
      }
      
    } catch (error) {
      console.error('‚ùå Error procesando archivo:', file.name, error);
      showMessage(`Error procesando ${file.name}: ${error.message}`, 'error');
      fail++;
    }
  }
  
  document.getElementById("songTitle").value = "";
  document.getElementById("songFiles").value = "";
  
  if (ok > 0) {
    showMessage(`üéâ Proceso completado: ${ok} exitosas, ${fail} errores`, "success");
    console.log(`‚úÖ Proceso completado: ${ok} exitosas, ${fail} errores`);
    
    await refreshCatalogOptimized();
    
    if (currentAlbum) {
      const updatedAlbum = albums.find(a => a.id === albumId);
      if (updatedAlbum) {
        openAlbum(updatedAlbum);
      }
    }
  } else {
    showMessage(`‚ùå Error: No se pudo subir ninguna canci√≥n (${fail} errores)`, "error");
    console.log(`‚ùå Todas las subidas fallaron: ${fail} errores`);
  }
}

function toggleShuffle() {
  isShuffleMode = !isShuffleMode;
  updateControlsUI();
  saveAppSettings();
  showMessage(`Shuffle ${isShuffleMode ? 'activado' : 'desactivado'}`, 'success');
}

function toggleRepeat() {
  repeatMode = (repeatMode + 1) % 3;
  updateControlsUI();
  saveAppSettings();
  
  const messages = ['Repetir desactivado', 'Repetir todo activado', 'Repetir canci√≥n activado'];
  showMessage(messages[repeatMode], 'success');
}

function toggleFavorite(songId, element) {
  if (favorites.has(songId)) {
    favorites.delete(songId);
    element.textContent = 'ü§ç';
    element.classList.remove('active');
    showMessage('Eliminado de favoritos', 'info');
  } else {
    favorites.add(songId);
    element.textContent = '‚ù§Ô∏è';
    element.classList.add('active');
    element.classList.add('bounce');
    setTimeout(() => element.classList.remove('bounce'), 1000);
    showMessage('Agregado a favoritos', 'success');
  }
  saveAppSettings();
  updateCurrentFavoriteButton();
}

function toggleCurrentFavorite() {
  const currentSong = queue[qIndex];
  if (currentSong) { toggleFavorite(currentSong.id, npFavoriteBtn); }
}

function updateCurrentFavoriteButton() {
  const currentSong = queue[qIndex];
  if (currentSong && npFavoriteBtn) {
    const isFavorite = favorites.has(currentSong.id);
    npFavoriteBtn.textContent = isFavorite ? '‚ù§Ô∏è' : 'ü§ç';
    npFavoriteBtn.classList.toggle('active', isFavorite);
  }
}

async function downloadSong(songId, songUrl, title, element) {
  if (downloads.has(songId)) {
    showMessage('Esta canci√≥n ya est√° descargada', 'info');
    return;
  }
  
  try {
    element.innerHTML = '<div class="download-progress"><div class="download-progress-bar" style="width: 0%"></div></div>';
    element.disabled = true;
    
    const response = await fetch(songUrl);
    if (!response.ok) throw new Error('Error descargando');
    
    const blob = await response.blob();
    const objectUrl = URL.createObjectURL(blob);
    
    downloads.set(songId, {
      url: objectUrl,
      title,
      blob,
      downloadedAt: Date.now()
    });
    
    saveAppSettings();
    element.innerHTML = '‚úì Descargado';
    element.classList.add('downloaded');
    showMessage(`${title} descargado para offline`, 'success');
    updateOfflineStatus();
    
  } catch (error) {
    console.error('Error descargando:', error);
    showMessage('Error descargando la canci√≥n', 'error');
    element.innerHTML = 'üì• Offline';
    element.disabled = false;
  }
}

async function downloadCurrentSong() {
  const currentSong = queue[qIndex];
  if (currentSong) {
    await downloadSong(currentSong.id, currentSong.song_url, currentSong.title, npDownloadBtn);
  }
}

function updateCurrentDownloadButton() {
  const currentSong = queue[qIndex];
  if (currentSong && npDownloadBtn) {
    const isDownloaded = downloads.has(currentSong.id);
    npDownloadBtn.innerHTML = isDownloaded ? '‚úì Descargado' : 'üì• Offline';
    npDownloadBtn.classList.toggle('downloaded', isDownloaded);
  }
}

function updateOfflineStatus() {
  const offlineTag = document.getElementById('offlineTag');
  if (downloads.size > 0) {
    offlineTag.style.display = 'inline-block';
    offlineTag.textContent = `Offline (${downloads.size})`;
  } else {
    offlineTag.style.display = 'none';
  }
}

function showFavorites() {
  hideAllViews();
  favoritesView.style.display = 'block';
  setActiveNav('search');
  renderFavorites();
}

function renderFavorites() {
  favoritesList.innerHTML = '';
  const favoriteSongs = flatSongs.filter(song => favorites.has(song.id));
  
  if (favoriteSongs.length === 0) {
    document.getElementById('emptyFavorites').style.display = 'block';
    return;
  }
  
  document.getElementById('emptyFavorites').style.display = 'none';
  
  favoriteSongs.forEach((song, index) => {
    const item = document.createElement('div');
    item.className = 'search-song-item';
    item.innerHTML = `
      <img class="search-song-cover" src="${song.cover_url}" alt="${song.album_title}">
      <div class="search-song-info">
        <div class="search-song-title">${song.title}</div>
        <div class="search-song-artist">${song.album_title}</div>
      </div>
      <div class="search-song-actions">
        <button class="search-song-play" onclick="playFavoriteSong(${index})" title="Reproducir">‚ñ∂</button>
        <button class="favorite-btn active" onclick="toggleFavorite('${song.id}', this)" title="Quitar de favoritos">‚ù§Ô∏è</button>
      </div>
    `;
    favoritesList.appendChild(item);
  });
}

function playFavoriteSong(index) {
  const favoriteSongs = flatSongs.filter(song => favorites.has(song.id));
  if (favoriteSongs[index]) {
    queue = favoriteSongs;
    qIndex = index;
    playTrackDirectly(queue[qIndex]);
  }
}

function closeFavoritesView() {
  favoritesView.style.display = 'none';
  goHome();
}

function showDownloads() {
  hideAllViews();
  downloadsView.style.display = 'block';
  setActiveNav('search');
  renderDownloads();
}

function renderDownloads() {
  downloadsList.innerHTML = '';
  
  if (downloads.size === 0) {
    document.getElementById('emptyDownloads').style.display = 'block';
    return;
  }
  
  document.getElementById('emptyDownloads').style.display = 'none';
  
  const downloadedSongs = [];
  for (const [songId, downloadData] of downloads) {
    const song = flatSongs.find(s => s.id === songId);
    if (song) { downloadedSongs.push({ ...song, downloadData }); }
  }
  
  downloadedSongs.forEach((song, index) => {
    const item = document.createElement('div');
    item.className = 'search-song-item';
    const downloadDate = new Date(song.downloadData.downloadedAt).toLocaleDateString();
    item.innerHTML = `
      <img class="search-song-cover" src="${song.cover_url}" alt="${song.album_title}">
      <div class="search-song-info">
        <div class="search-song-title">${song.title}</div>
        <div class="search-song-artist">${song.album_title} ‚Ä¢ Descargado: ${downloadDate}</div>
      </div>
      <div class="search-song-actions">
        <button class="search-song-play" onclick="playDownloadedSong(${index})" title="Reproducir">‚ñ∂</button>
        <button class="btn small ghost" onclick="removeDownload('${song.id}')" title="Eliminar descarga">üóëÔ∏è</button>
      </div>
    `;
    downloadsList.appendChild(item);
  });
}

function playDownloadedSong(index) {
  const downloadedSongs = [];
  for (const [songId, downloadData] of downloads) {
    const song = flatSongs.find(s => s.id === songId);
    if (song) { downloadedSongs.push({ ...song, downloadData, song_url: downloadData.url }); }
  }
  
  if (downloadedSongs[index]) {
    queue = downloadedSongs;
    qIndex = index;
    playTrackDirectly(queue[qIndex]);
  }
}

function removeDownload(songId) {
  if (downloads.has(songId)) {
    const downloadData = downloads.get(songId);
    if (downloadData.url) { URL.revokeObjectURL(downloadData.url); }
    downloads.delete(songId);
    saveAppSettings();
    updateOfflineStatus();
    renderDownloads();
    showMessage('Descarga eliminada', 'info');
  }
}

function closeDownloadsView() {
  downloadsView.style.display = 'none';
  goHome();
}

function setActiveNav(activeButton) {
  document.querySelectorAll('#bottomBar button').forEach(btn => {
    btn.classList.remove('active');
  });
  document.getElementById(`btn-${activeButton}`).classList.add('active');
}

function goHome() {
  hideAllViews();
  homeContent.style.display = 'block';
  setActiveNav('home');
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function showAccount() {
  if (isAdmin) {
    alert('Cuenta Admin: ' + ADMIN_EMAIL + '\n\nFuncionalidades:\n‚Ä¢ Crear √°lbumes\n‚Ä¢ Subir canciones\n‚Ä¢ Eliminar canciones individuales\n‚Ä¢ Eliminar √°lbumes completos');
  } else if (isLoggedIn) {
    alert('Usuario: ' + currentUser.email);
  } else {
    showLogin();
  }
}

function togglePlay() {
  if (audioEl.paused) { 
    audioEl.play().then(() => {
      playBtn.textContent = "‚è∏"; 
      playBtnBig.textContent = "‚è∏";
      toggleSoundwave(true);
    });
  } else { 
    audioEl.pause(); 
    playBtn.textContent = "‚ñ∂"; 
    playBtnBig.textContent = "‚ñ∂";
    toggleSoundwave(false);
  }
}

function nextTrack() {
  if (!queue.length) return;
  
  if (repeatMode === 2) {
    playTrackDirectly(queue[qIndex]);
    return;
  }
  
  qIndex = (qIndex + 1) % queue.length;
  
  if (qIndex === 0 && repeatMode === 0 && queue.length > 1) {
    audioEl.pause();
    hidePlayer();
    return;
  }
  
  playTrackDirectly(queue[qIndex]);
}

function prevTrack() {
  if (!queue.length) return;
  qIndex = (qIndex - 1 + queue.length) % queue.length;
  playTrackDirectly(queue[qIndex]);
}

function showPlayer() {
  playerElement.classList.add('show');
}

function hidePlayer() {
  playerElement.classList.remove('show');
}

function toggleSoundwave(show) {
  const wave = document.getElementById('soundwave');
  if (show) wave.style.display = 'flex';
  else wave.style.display = 'none';
}

function openNowPlaying() {
  npOverlay.style.display = "flex";
}

function closeNowPlaying() { 
  npOverlay.style.display = "none"; 
}

function setVolume(v) { 
  audioEl.volume = v; 
}

function seekAudio(percent) { 
  if (!audioEl.duration || isNaN(audioEl.duration)) return; 
  audioEl.currentTime = (percent / 100) * audioEl.duration; 
}

function fmt(t) { 
  if (!isFinite(t)) return "0:00"; 
  const m = Math.floor(t / 60), s = Math.floor(t % 60); 
  return `${m}:${s.toString().padStart(2, "0")}`; 
}

audioEl.addEventListener("timeupdate", () => {
  if (!audioEl.duration) return;
  const p = (audioEl.currentTime / audioEl.duration) * 100;
  seekEl.value = p; 
  curTime.textContent = fmt(audioEl.currentTime); 
  durTime.textContent = fmt(audioEl.duration);
  
  if (seekBig) seekBig.value = p;
  if (curTimeBig) curTimeBig.textContent = fmt(audioEl.currentTime);
  if (durTimeBig) durTimeBig.textContent = fmt(audioEl.duration);
});

audioEl.addEventListener("ended", () => nextTrack());
audioEl.addEventListener("pause", () => toggleSoundwave(false));
audioEl.addEventListener("play", () => toggleSoundwave(true));

audioEl.addEventListener('error', (e) => {
  console.error('Error de audio:', e);
  const currentSong = queue[qIndex];
  if (currentSong) {
    showMessage(`Error cargando "${currentSong.title}"`, 'error');
    setTimeout(() => nextTrack(), 2000);
  }
});

function showLogin() { 
  document.getElementById("loginModal").style.display = "block"; 
}

function hideLogin() { 
  document.getElementById("loginModal").style.display = "none"; 
}

async function login() {
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;
  
  if (!password) {
    showMessage('Ingresa tu contrase√±a', 'warning');
    return;
  }
  
  let result = await sb.auth.signInWithPassword({ email, password });
  
  if (result.error) {
    result = await sb.auth.signUp({ email, password });
    if (result.error) {
      showMessage("Error: " + result.error.message, 'error');
      return;
    }
    showMessage('Cuenta creada!', 'success');
  }
  
  currentUser = result.data.user;
  isLoggedIn = !!currentUser;
  isAdmin = (email.toLowerCase() === ADMIN_EMAIL.toLowerCase());
  
  updateUIForUser();
  hideLogin();
  await refreshCatalogOptimized();
  await loadPlaylists();
}

async function logout() {
  await sb.auth.signOut();
  currentUser = null;
  isLoggedIn = false;
  isAdmin = false;
  
  document.getElementById("adminPanel").style.display = "none";
  document.getElementById("adminTag").style.display = "none";
  document.getElementById("userTag").style.display = "none";
  document.getElementById("btn-login").style.display = "inline-flex";
  document.getElementById("btn-logout").style.display = "none";
  
  await loadPlaylists();
}

function safeName(name) { 
  return name.replace(/[^a-zA-Z0-9\_\-.]+/g, "-"); 
}

async function uploadAlbum() {
  if (!isAdmin) return alert("No autorizado");
  const title = document.getElementById("albumTitle").value.trim();
  const file = document.getElementById("albumCover").files[0];
  if (!title || !file) return alert("Completa t√≠tulo y portada");
  
  const path = `${Date.now()}-${safeName(file.name)}`;
  const { error: upErr } = await sb.storage.from("covers").upload(path, file);
  if (upErr) return alert("Error subiendo portada: " + upErr.message);
  
  const { data: pub } = sb.storage.from("covers").getPublicUrl(path);
  const cover_url = pub.publicUrl;
  
  const { error: insErr } = await sb.from("albums").insert([{ title, cover_url }]);
  if (insErr) return alert("Error guardando √°lbum: " + insErr.message);
  
  document.getElementById("albumTitle").value = "";
  document.getElementById("albumCover").value = "";
  showMessage("√Ålbum creado exitosamente", "success");
  await refreshCatalogOptimized();
}

async function deleteAlbum() {
  if (!isAdmin) return alert("No autorizado");
  const albumId = document.getElementById("deleteAlbumSelect").value;
  if (!albumId) return alert("Selecciona un √°lbum");
  if (!confirm("¬øEliminar √°lbum y todas sus canciones?")) return;
  
  await sb.from("songs").delete().eq("album_id", albumId);
  await sb.from("albums").delete().eq("id", albumId);
  
  showMessage("√Ålbum eliminado exitosamente", "success");
  if (currentAlbum?.id === albumId) closeAlbumView();
  await refreshCatalogOptimized();
}
</script>
</body>
</html>
