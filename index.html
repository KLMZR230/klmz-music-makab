<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KLMZ MUSIC</title>
<meta name="description" content="KLMZ MUSIC - Tu plataforma de música personal" />
<meta name="theme-color" content="#1db954" />
<link rel="manifest" href="manifest.json">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js')
      .then(registration => {
        console.log('✅ Service Worker registrado:', registration);
      })
      .catch(error => {
        console.log('❌ Error registrando Service Worker:', error);
      });
  });
}
</script>
<style>
  :root{
    --bg:#0a0a0a;
    --panel:#181818;
    --panel2:#1f1f1f;
    --text:#fff;
    --muted:#b3b3b3;
    --brand:#1db954;
    --brand-hover:#1ed760;
    --stroke:#2a2a2a;
    --accent:#ff6b35;
    --error:#ff4444;
    --warning:#ffab00;
    --success:#4caf50;
    
    /* Efectos profesionales */
    --glass-bg: rgba(255, 255, 255, 0.05);
    --glass-border: rgba(255, 255, 255, 0.1);
    --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    --neo-raised: linear-gradient(145deg, #1f1f23, #16161a);
    --neo-pressed: linear-gradient(145deg, #232327, #1a1a1e);
    --premium-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
    
    /* Variables móviles */
    --mobile-header-height: 50px;
    --mobile-player-height: 55px;
    --mobile-bottom-bar-height: 45px;
    --mobile-padding: 12px;
    --mobile-gap: 8px;
  }
  
  *{box-sizing:border-box;-webkit-tap-highlight-color: transparent;}
  
  body{
    margin:0;
    background: radial-gradient(ellipse at center, #0f0f0f 0%, var(--bg) 100%);
    color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
    padding-bottom:55px;
    overflow-x:hidden;
    line-height:1.6;
    overflow: auto;
    -webkit-overflow-scrolling: touch;
  }
  
  /* Animaciones profesionales mejoradas */
  @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
  @keyframes slideUp{from{transform:translateY(30px);opacity:0}to{transform:translateY(0);opacity:1}}
  @keyframes slideDown{from{transform:translateY(0);opacity:1}to{transform:translateY(100px);opacity:0}}
  @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
  @keyframes wave{0%,40%,100%{height:15px;background:linear-gradient(to top,var(--brand),var(--accent))}20%{height:35px;background:linear-gradient(to top,var(--accent),#ffab00)}}
  @keyframes bounce{0%,20%,50%,80%,100%{transform:translateY(0)}40%{transform:translateY(-10px)}60%{transform:translateY(-5px)}}
  @keyframes glow{0%,100%{box-shadow:0 0 20px rgba(29,185,84,0.3)}50%{box-shadow:0 0 30px rgba(29,185,84,0.6)}}
  @keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
  @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
  @keyframes glow-pulse{0%,100%{opacity:0.5;transform:scale(1)}50%{opacity:1;transform:scale(1.05)}}
  @keyframes skeleton-loading{0%{background-position:200% 0}100%{background-position:-200% 0}}
  
  .fade-in{animation:fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1)}
  .slide-up{animation:slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1)}
  .slide-down{animation:slideDown 0.4s cubic-bezier(0.4, 0, 0.2, 1)}
  .bounce{animation:bounce 1s ease}
  
  .loading{
    position:fixed;
    inset:0;
    background:linear-gradient(135deg, var(--bg), #0f0f0f);
    display:flex;
    align-items:center;
    justify-content:center;
    flex-direction:column;
    z-index:9999;
    transition:opacity 0.4s ease;
  }
  
  .loading .spinner{
    width:60px;
    height:60px;
    border:4px solid transparent;
    border-top:4px solid var(--brand);
    border-radius:50%;
    animation:spin 1s linear infinite;
    filter:drop-shadow(0 0 10px var(--brand));
  }
  
  .loading .text{
    margin-top:24px;
    color:var(--muted);
    font-weight:600;
    font-size:18px;
    letter-spacing:0.5px;
  }
  
  /* Skeleton loading para álbumes */
  .album-skeleton {
    background: linear-gradient(90deg, #2a2a2a 25%, #3a3a3a 50%, #2a2a2a 75%);
    background-size: 200% 100%;
    animation: skeleton-loading 1.5s infinite;
    border-radius: 50%;
    aspect-ratio: 1/1;
  }
  
  /* Toast notifications mejoradas */
  .toast-notification {
    position: fixed;
    bottom: 90px;
    right: 20px;
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: 16px;
    padding: 16px 20px;
    color: white;
    font-weight: 600;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    transform: translateX(400px);
    transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    z-index: 1000;
    max-width: 300px;
  }
  
  .toast-notification.show {
    transform: translateX(0);
  }
  
  .toast-notification.success {
    border-left: 4px solid var(--success);
  }
  
  .toast-notification.error {
    border-left: 4px solid var(--error);
  }
  
  .toast-notification.info {
    border-left: 4px solid var(--brand);
  }
  
  .gesture-hint{
    position:fixed;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    background:rgba(0,0,0,0.9);
    color:white;
    padding:16px 24px;
    border-radius:30px;
    font-size:14px;
    z-index:1000;
    opacity:0;
    pointer-events:none;
    transition:all 0.3s ease;
    backdrop-filter:blur(20px);
    border:1px solid var(--glass-border);
  }
  
  .gesture-hint.show{opacity:1}
  
  /* Header Premium */
  header{
    position:sticky;
    top:0;
    z-index:10;
    background:linear-gradient(135deg, #1db954 0%, #1ed760 50%, #1aa34a 100%);
    padding:20px 24px;
    font-weight:800;
    letter-spacing:0.5px;
    backdrop-filter:blur(20px);
    box-shadow:0 4px 20px rgba(29, 185, 84, 0.3);
    border-bottom:1px solid rgba(255,255,255,0.1);
  }
  
  header .row{
    display:flex;
    align-items:center;
    gap:16px;
    justify-content:space-between;
    max-width:1200px;
    margin:0 auto;
  }
  
  .brand{
    font-size:24px;
    display:flex;
    align-items:center;
    gap:12px;
    transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    cursor:pointer;
  }
  
  .brand:hover{
    transform:scale(1.05);
    filter:drop-shadow(0 0 10px rgba(255,255,255,0.3));
  }
  
  .brand .logo{
    display:inline-grid;
    place-items:center;
    width:36px;
    height:36px;
    border-radius:12px;
    background:linear-gradient(135deg,#ff6b35,#ff4500);
    font-weight:900;
    color:#fff;
    font-size:20px;
    transition:all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    position:relative;
    overflow:hidden;
  }
  
  .brand .logo:hover{
    transform:rotate(360deg) scale(1.1);
    box-shadow:0 0 20px rgba(255,107,53,0.6);
  }
  
  .brand .logo::before{
    content:'';
    position:absolute;
    inset:0;
    background:linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
    transform:translateX(-100%);
    transition:transform 0.6s;
  }
  
  .brand .logo:hover::before{
    transform:translateX(100%);
  }
  
  .tools{
    display:flex;
    gap:12px;
    flex-wrap:wrap;
    align-items:center;
  }
  
  /* Botones Premium con Ripple Effect */
  .btn{
    background:linear-gradient(135deg, #1db954, #1ed760);
    border:none;
    color:#fff;
    padding:12px 18px;
    border-radius:12px;
    cursor:pointer;
    font-weight:600;
    transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    text-transform:uppercase;
    letter-spacing:0.5px;
    font-size:13px;
    position:relative;
    overflow:hidden;
    box-shadow:0 4px 15px rgba(29, 185, 84, 0.4);
  }
  
  .btn::before{
    content:'';
    position:absolute;
    inset:0;
    background:linear-gradient(45deg, transparent, rgba(255,255,255,0.2), transparent);
    transform:translateX(-100%);
    transition:transform 0.6s;
  }
  
  .btn::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    transform: translate(-50%, -50%);
    transition: width 0.6s, height 0.6s;
  }
  
  .btn:active::after {
    width: 300px;
    height: 300px;
  }
  
  .btn:hover{
    background:linear-gradient(135deg, #1ed760, #17c653);
    transform:translateY(-2px);
    box-shadow:0 8px 25px rgba(29, 185, 84, 0.6);
  }
  
  .btn:hover::before{
    transform:translateX(100%);
  }
  
  .btn.ghost{
    background:rgba(255,255,255,0.1);
    border:2px solid rgba(255,255,255,0.2);
    backdrop-filter:blur(10px);
  }
  
  .btn.ghost:hover{
    background:rgba(255,255,255,0.2);
    border-color:rgba(255,255,255,0.4);
    transform:translateY(-2px);
  }
  
  .btn.small{padding:8px 14px;font-size:11px;border-radius:8px}
  .btn.danger{background:linear-gradient(135deg, var(--error), #cc0000)}
  .btn.danger:hover{background:linear-gradient(135deg, #cc0000, #990000)}
  .btn.warning{background:linear-gradient(135deg, var(--warning), #f57f17);color:#000;font-weight:700}
  .btn.warning:hover{background:linear-gradient(135deg, #f57f17, #e65100)}
  
  .icon-btn{
    background:rgba(255,255,255,0.1);
    border:1px solid rgba(255,255,255,0.2);
    color:#fff;
    padding:12px 14px;
    border-radius:12px;
    cursor:pointer;
    font-size:16px;
    line-height:1;
    transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    backdrop-filter:blur(10px);
  }
  
  .icon-btn:hover{
    background:rgba(255,255,255,0.2);
    transform:scale(1.1);
    box-shadow:0 4px 15px rgba(255,255,255,0.2);
  }
  
  .container{
    padding:24px;
    max-width:1200px;
    margin:auto;
    animation:fadeIn 0.6s ease;
  }
  
  /* Tarjetas Premium con Glassmorphism */
  .card{
    background:var(--glass-bg);
    backdrop-filter:blur(20px);
    border:1px solid var(--glass-border);
    border-radius:20px;
    padding:24px;
    transition:all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow:var(--glass-shadow);
    position:relative;
    overflow:hidden;
  }
  
  .card:hover{
    transform:translateY(-4px);
    box-shadow:0 20px 40px rgba(0, 0, 0, 0.4);
    border-color:rgba(29, 185, 84, 0.3);
  }
  
  .grid{display:grid;gap:20px}
  .grid.albums{grid-template-columns:repeat(auto-fill,minmax(100px,1fr))}
  .grid.playlists{grid-template-columns:repeat(auto-fill,minmax(120px,1fr))}
  
  /* Álbumes Premium REDONDOS COMO SPOTIFY */
  .album-card,.playlist-card{
    background:var(--neo-raised);
    border:1px solid rgba(255, 255, 255, 0.05);
    padding:20px;
    cursor:pointer;
    text-align:center;
    transition:all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    border-radius:20px;
    position:relative;
    overflow:hidden;
  }
  
  .album-card::before,.playlist-card::before{
    content:'';
    position:absolute;
    inset:0;
    background:linear-gradient(45deg, transparent, rgba(29,185,84,0.1), transparent);
    opacity:0;
    transition:opacity 0.3s;
  }
  
  .album-card:hover,.playlist-card:hover{
    transform:translateY(-12px) scale(1.02);
    background:var(--neo-pressed);
    box-shadow:var(--premium-shadow), 0 0 0 1px rgba(29, 185, 84, 0.5);
    border-color:rgba(29, 185, 84, 0.3);
  }
  
  .album-card:hover::before,.playlist-card:hover::before{
    opacity:1;
  }
  
  /* ÁLBUMES REDONDOS Y PEQUEÑOS COMO SPOTIFY */
  .album-cover{
    width:100%;
    aspect-ratio:1/1;
    object-fit:cover;
    background:#0b0b0b;
    border:2px solid rgba(255,255,255,0.1);
    transition:all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius:50%;
    box-shadow:0 8px 25px rgba(0, 0, 0, 0.3);
  }
  
  .album-cover:hover{
    transform:scale(1.05);
    box-shadow:0 15px 35px rgba(29, 185, 84, 0.4);
    border-color:rgba(29, 185, 84, 0.5);
  }
  
  /* EXPANSIÓN DE ÁLBUM INTEGRADA */
  .album-expansion {
    animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    transform-origin: top;
    grid-column: 1 / -1;
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    padding: 24px;
    margin: 20px 0;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  }
  
  .album-expansion.slide-down {
    animation: slideDown 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  /* PLAYLISTS SIGUEN CUADRADAS */
  .playlist-cover{
    width:100%;
    aspect-ratio:1/1;
    object-fit:cover;
    background:linear-gradient(135deg,var(--brand),var(--accent));
    border:2px solid rgba(255,255,255,0.1);
    transition:all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius:12px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:2.5rem;
    box-shadow:0 8px 25px rgba(0, 0, 0, 0.3);
  }
  
  .playlist-cover:hover{
    transform:scale(1.05);
    box-shadow:0 15px 35px rgba(29, 185, 84, 0.4);
  }
  
  /* Búsqueda Inteligente */
  .smart-search-container {
    position: relative;
    max-width: 600px;
    margin: 0 auto 24px;
  }
  
  .search-input-wrapper {
    position: relative;
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    border: 2px solid rgba(29, 185, 84, 0.3);
    border-radius: 50px;
    padding: 12px 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: all 0.3s ease;
  }
  
  .search-input-wrapper:focus-within {
    border-color: var(--brand);
    box-shadow: 0 0 0 4px rgba(29, 185, 84, 0.2);
  }
  
  .search-icon {
    width: 20px;
    height: 20px;
    stroke: var(--muted);
    fill: none;
    stroke-width: 2;
  }
  
  .search-clear-btn {
    background: none;
    border: none;
    color: var(--muted);
    font-size: 16px;
    cursor: pointer;
    padding: 4px;
    border-radius: 50%;
    transition: all 0.2s ease;
  }
  
  .search-clear-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    color: white;
  }
  
  #smartSearchInput {
    flex: 1;
    background: transparent;
    border: none;
    color: white;
    font-size: 16px;
    outline: none;
  }
  
  #smartSearchInput::placeholder {
    color: var(--muted);
  }
  
  .search-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: 16px;
    margin-top: 8px;
    max-height: 300px;
    overflow-y: auto;
    z-index: 100;
    display: none;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  }
  
  .suggestion-item {
    padding: 12px 20px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 12px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
  }
  
  .suggestion-item:hover {
    background: rgba(29, 185, 84, 0.1);
  }
  
  .suggestion-item:last-child {
    border-bottom: none;
  }
  
  .search-filters {
    display: flex;
    gap: 8px;
    margin-top: 16px;
    justify-content: center;
    flex-wrap: wrap;
  }
  
  .filter-btn {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: var(--muted);
    padding: 8px 16px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.3s ease;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .filter-btn:hover,
  .filter-btn.active {
    background: var(--brand);
    color: white;
    border-color: var(--brand);
    transform: scale(1.05);
  }
  
  /* Waveform Visual */
  .waveform-container {
    position: relative;
    width: 100%;
    height: 40px;
    margin: 10px 0;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 20px;
    overflow: hidden;
  }
  
  .waveform-canvas {
    width: 100%;
    height: 100%;
    opacity: 0.6;
  }
  
  .waveform-progress {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    background: linear-gradient(90deg, var(--brand), var(--accent));
    width: 0%;
    transition: width 0.1s ease;
    border-radius: 20px;
  }
  
  /* Audio Visualizer */
  .audio-visualizer {
    position: relative;
    margin: 20px 0;
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    border-radius: 16px;
    padding: 20px;
    border: 1px solid var(--glass-border);
  }
  
  .visualizer-canvas {
    width: 100%;
    height: 150px;
    border-radius: 12px;
    background: rgba(0, 0, 0, 0.3);
  }
  
  .visualizer-controls {
    display: flex;
    gap: 12px;
    margin-top: 12px;
    align-items: center;
    justify-content: center;
  }
  
  .viz-btn {
    background: var(--brand);
    border: none;
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    transition: all 0.3s ease;
  }
  
  .viz-btn:hover {
    background: var(--brand-hover);
    transform: scale(1.05);
  }
  
  #vizType {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: white;
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 12px;
  }
  
  /* Modo Inmersivo */
  .immersive-overlay {
    position: fixed;
    inset: 0;
    z-index: 200;
    display: none;
    background: #000;
    overflow: hidden;
  }
  
  .immersive-background {
    position: absolute;
    inset: 0;
    background-size: cover;
    background-position: center;
    filter: blur(20px) brightness(0.3);
    transform: scale(1.1);
  }
  
  .immersive-content {
    position: relative;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px;
    text-align: center;
  }
  
  .immersive-artwork {
    position: relative;
    margin-bottom: 40px;
  }
  
  .immersive-artwork img {
    width: min(400px, 80vw);
    height: min(400px, 80vw);
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
    animation: float 6s ease-in-out infinite;
  }
  
  .artwork-glow {
    position: absolute;
    inset: -20px;
    background: radial-gradient(circle, rgba(29, 185, 84, 0.4) 0%, transparent 70%);
    border-radius: 50px;
    animation: glow-pulse 4s ease-in-out infinite;
  }
  
  .immersive-info {
    margin-bottom: 40px;
  }
  
  .immersive-title {
    font-size: 2.5rem;
    font-weight: 900;
    margin-bottom: 16px;
    background: linear-gradient(135deg, var(--brand), var(--accent));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  
  .immersive-artist {
    font-size: 1.2rem;
    color: var(--muted);
    font-weight: 500;
  }
  
  .immersive-controls {
    margin-bottom: 40px;
  }
  
  .immersive-btn {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: white;
    padding: 12px 24px;
    border-radius: 25px;
    cursor: pointer;
    font-weight: 600;
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
  }
  
  .immersive-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: scale(1.05);
  }
  
  .gesture-hints {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    font-size: 12px;
    color: rgba(255, 255, 255, 0.6);
  }
  
  .hint {
    background: rgba(255, 255, 255, 0.1);
    padding: 8px 12px;
    border-radius: 20px;
    backdrop-filter: blur(10px);
  }
  
  .album-title,.playlist-title{
    margin:12px 0 4px;
    font-weight:700;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    font-size:16px;
    letter-spacing:0.3px;
  }
  
  .album-meta,.playlist-meta{
    margin:0;
    color:var(--muted);
    font-size:13px;
    font-weight:500;
  }
  
  .muted{color:var(--muted)}
  
  .section-title{
    margin:8px 0 16px;
    font-size:28px;
    font-weight:900;
    letter-spacing:0.5px;
    position:relative;
    background:linear-gradient(135deg, var(--brand), var(--accent));
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    background-clip:text;
  }
  
  .section-title::before{
    content:'';
    position:absolute;
    bottom:-8px;
    left:0;
    width:60px;
    height:4px;
    background:linear-gradient(135deg, var(--brand), var(--accent));
    border-radius:4px;
    box-shadow:0 2px 10px rgba(29, 185, 84, 0.5);
  }
  
  .inputs{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  
  input[type="text"],input[type="email"],input[type="password"],select,textarea{
    width:100%;
    padding:14px 18px;
    border-radius:12px;
    border:2px solid rgba(255,255,255,0.1);
    background:rgba(255,255,255,0.05);
    color:#fff;
    transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    font-size:14px;
    backdrop-filter:blur(10px);
  }
  
  input:focus,select:focus,textarea:focus{
    outline:none;
    border-color:var(--brand);
    box-shadow:0 0 0 3px rgba(29, 185, 84, 0.2);
    background:rgba(255,255,255,0.1);
  }
  
  input[type="file"]{
    width:100%;
    padding:14px 18px;
    border-radius:12px;
    border:2px dashed rgba(29, 185, 84, 0.5);
    background:rgba(29, 185, 84, 0.1);
    color:var(--brand);
    font-weight:600;
    cursor:pointer;
    transition:all 0.3s ease;
  }
  
  input[type="file"]:hover{
    border-color:var(--brand);
    background:rgba(29, 185, 84, 0.2);
  }
  
  .stack{display:grid;gap:16px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  
  .pill{
    padding:10px 16px;
    border-radius:25px;
    background:linear-gradient(135deg, rgba(29, 185, 84, 0.2), rgba(255, 107, 53, 0.2));
    border:1px solid rgba(29, 185, 84, 0.3);
    font-size:14px;
    color:var(--brand);
    font-weight:600;
    backdrop-filter:blur(10px);
  }
  
  .music-controls{
    display:flex;
    align-items:center;
    gap:16px;
    margin-bottom:20px;
    flex-wrap:wrap;
  }
  
  .control-btn{
    background:rgba(255,255,255,0.1);
    border:1px solid rgba(255,255,255,0.2);
    color:var(--muted);
    padding:12px 16px;
    border-radius:25px;
    cursor:pointer;
    font-size:13px;
    transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display:flex;
    align-items:center;
    gap:8px;
    backdrop-filter:blur(10px);
    font-weight:600;
  }
  
  .control-btn:hover,.control-btn.active{
    background:linear-gradient(135deg, var(--brand), var(--accent));
    color:white;
    transform:scale(1.05);
    box-shadow:0 4px 15px rgba(29, 185, 84, 0.4);
  }
  
  .favorite-btn{
    background:none;
    border:none;
    color:var(--muted);
    cursor:pointer;
    font-size:20px;
    transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    padding:8px;
    border-radius:50%;
  }
  
  .favorite-btn:hover{
    color:#ff4444;
    transform:scale(1.2);
    background:rgba(255, 68, 68, 0.1);
  }
  
  .favorite-btn.active{
    color:#ff4444;
    animation:bounce 0.6s ease;
  }
  
  .download-btn{
    background:linear-gradient(135deg, var(--success), #2e7d32);
    border:none;
    color:white;
    padding:8px 12px;
    border-radius:20px;
    cursor:pointer;
    font-size:11px;
    transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display:flex;
    align-items:center;
    gap:6px;
    font-weight:600;
    box-shadow:0 2px 10px rgba(76, 175, 80, 0.3);
  }
  
  .download-btn:hover{
    background:linear-gradient(135deg, #2e7d32, #1b5e20);
    transform:scale(1.05);
    box-shadow:0 4px 15px rgba(76, 175, 80, 0.5);
  }
  
  .download-btn.downloaded{
    background:var(--muted);
    cursor:default;
    transform:none;
  }
  
  .delete-song-btn{
    background:linear-gradient(135deg, var(--error), #cc0000);
    border:none;
    color:white;
    padding:8px 12px;
    border-radius:20px;
    cursor:pointer;
    font-size:11px;
    transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display:flex;
    align-items:center;
    gap:6px;
    font-weight:600;
    box-shadow:0 2px 10px rgba(255, 68, 68, 0.3);
  }
  
  .delete-song-btn:hover{
    background:linear-gradient(135deg, #cc0000, #990000);
    transform:scale(1.05);
    box-shadow:0 4px 15px rgba(255, 68, 68, 0.5);
  }
  
  .playlist-btn{
    background:linear-gradient(135deg, var(--accent), #e55722);
    border:none;
    color:white;
    padding:8px 12px;
    border-radius:20px;
    cursor:pointer;
    font-size:11px;
    transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display:flex;
    align-items:center;
    gap:6px;
    font-weight:600;
    box-shadow:0 2px 10px rgba(255, 107, 53, 0.3);
  }
  
  .playlist-btn:hover{
    background:linear-gradient(135deg, #e55722, #d84315);
    transform:scale(1.05);
    box-shadow:0 4px 15px rgba(255, 107, 53, 0.5);
  }
  
  .download-progress{
    width:100%;
    height:6px;
    background:rgba(255,255,255,0.1);
    border-radius:4px;
    overflow:hidden;
    margin-top:6px;
  }
  
  .download-progress-bar{
    height:100%;
    background:linear-gradient(135deg, var(--success), #2e7d32);
    transition:width 0.3s ease;
    border-radius:4px;
    box-shadow:0 0 10px rgba(76, 175, 80, 0.5);
  }
  
  #albumView,#favoritesView,#downloadsView,#playlistsView,#playlistView,#searchView{display:none}
  
  .album-hero,.playlist-hero{
    display:flex;
    gap:20px;
    align-items:center;
    margin-bottom:32px;
    padding:20px;
    background:var(--glass-bg);
    backdrop-filter:blur(20px);
    border-radius:20px;
    border:1px solid var(--glass-border);
  }
  
  .album-hero img,.playlist-hero img{
    width:120px;
    height:120px;
    border-radius:16px;
    border:2px solid rgba(255,255,255,0.1);
    object-fit:cover;
    background:#0b0b0b;
    box-shadow:0 10px 30px rgba(0, 0, 0, 0.5);
  }
  
  .album-hero .info,.playlist-hero .info{min-width:0;flex:1}
  
  .album-hero .title,.playlist-hero .title{
    font-size:32px;
    font-weight:900;
    margin-bottom:8px;
    background:linear-gradient(135deg, var(--brand), var(--accent));
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    background-clip:text;
  }
  
  .album-hero .meta,.playlist-hero .meta{
    color:var(--muted);
    font-size:16px;
    font-weight:500;
  }
  
  .playlist-hero img{
    background:linear-gradient(135deg,var(--brand),var(--accent));
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:4rem;
  }
  
  .song-plain-list{margin-top:16px}
  
  .song-plain-item{
    padding:16px 12px;
    border-bottom:1px solid rgba(255,255,255,0.05);
    display:flex;
    align-items:center;
    gap:16px;
    transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius:12px;
    margin-bottom:4px;
    cursor:pointer;
    position:relative;
    overflow:hidden;
  }
  
  .song-plain-item::before{
    content:'';
    position:absolute;
    inset:0;
    background:linear-gradient(135deg, rgba(29,185,84,0.1), rgba(255,107,53,0.1));
    opacity:0;
    transition:opacity 0.3s;
  }
  
  .song-plain-item:last-child{border-bottom:none}
  
  .song-plain-item:hover{
    background:rgba(29, 185, 84, 0.1);
    transform:translateX(8px);
    border-radius:12px;
  }
  
  .song-plain-item:hover::before{
    opacity:1;
  }
  
  .song-plain-item .idx{
    min-width:32px;
    text-align:center;
    color:var(--muted);
    font-weight:600;
    font-size:14px;
  }
  
  .song-plain-item .title{
    flex:1;
    font-weight:600;
    font-size:16px;
  }
  
  .song-plain-item .actions{
    display:flex;
    gap:8px;
    align-items:center;
    flex-wrap:wrap;
  }
  
  .song-plain-item .more{
    font-size:20px;
    color:var(--muted);
    cursor:pointer;
    padding:8px;
    border-radius:50%;
    transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .song-plain-item .more:hover{
    background:rgba(255,255,255,0.1);
    transform:scale(1.2);
    color:var(--brand);
  }
  
  .backline{
    display:flex;
    align-items:center;
    gap:16px;
    margin-bottom:24px;
  }
  
  .back-btn{
    background:rgba(255,255,255,0.1);
    border:1px solid rgba(255,255,255,0.2);
    color:#fff;
    width:48px;
    height:48px;
    border-radius:12px;
    font-size:20px;
    display:grid;
    place-items:center;
    cursor:pointer;
    transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    backdrop-filter:blur(10px);
  }
  
  .back-btn:hover{
    background:rgba(255,255,255,0.2);
    transform:scale(1.1);
    box-shadow:0 4px 15px rgba(255,255,255,0.2);
  }
  
  /* Player Premium con Waveform */
  .player{
    position:fixed;
    left:0;
    right:0;
    bottom:55px;
    background:linear-gradient(135deg, #1f1f1f 0%, #2a2a2a 100%);
    border-top:2px solid rgba(29, 185, 84, 0.3);
    padding:12px 16px;
    z-index:20;
    display:none;
    height:70px;
    cursor:pointer;
    transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    backdrop-filter:blur(20px);
    box-shadow:0 -8px 25px rgba(0, 0, 0, 0.6);
  }
  
  .player.show{
    display:flex;
    align-items:center;
    gap:16px;
  }
  
  .player:hover{
    background:linear-gradient(135deg, #2a2a2a 0%, #333333 100%);
    border-top-color:var(--brand);
  }
  
  .np{
    display:flex;
    align-items:center;
    gap:12px;
    min-width:0;
    flex:1;
    padding:8px;
    border-radius:12px;
    transition:all 0.3s ease;
  }
  
  .np img{
    width:50px;
    height:50px;
    border-radius:10px;
    border:2px solid rgba(255,255,255,0.1);
    object-fit:cover;
    background:#0b0b0b;
    box-shadow:0 4px 15px rgba(0, 0, 0, 0.3);
  }
  
  .np .titles{min-width:0;flex:1}
  
  .np .titles .t{
    font-weight:700;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    font-size:16px;
    line-height:1.3;
  }
  
  .np .titles .a{
    color:var(--muted);
    font-size:13px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    line-height:1.2;
    margin-top:2px;
    font-weight:500;
  }
  
  .player-controls{
    display:flex;
    align-items:center;
    gap:12px;
  }
  
  .player-controls .circle{
    width:44px;
    height:44px;
    border-radius:50%;
    display:grid;
    place-items:center;
    border:2px solid rgba(255,255,255,0.2);
    background:linear-gradient(135deg, #2a2a2a, #3a3a3a);
    font-size:18px;
    font-weight:900;
    cursor:pointer;
    transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow:0 4px 15px rgba(0, 0, 0, 0.3);
  }
  
  .player-controls .circle:hover{
    transform:scale(1.1);
    background:linear-gradient(135deg, var(--brand), var(--brand-hover));
    border-color:var(--brand);
    box-shadow:0 6px 20px rgba(29, 185, 84, 0.4);
  }
  
  .player-controls .sm{width:38px;height:38px;font-size:16px}
  
  .player-seek{
    display:flex;
    align-items:center;
    gap:10px;
    min-width:140px;
  }
  
  .player-seek input[type="range"]{
    width:120px;
    height:6px;
    -webkit-appearance:none;
    background:rgba(255,255,255,0.2);
    border-radius:3px;
    outline:none;
  }
  
  .player-seek input[type="range"]::-webkit-slider-thumb{
    -webkit-appearance:none;
    width:16px;
    height:16px;
    background:var(--brand);
    border-radius:50%;
    cursor:pointer;
    box-shadow:0 2px 8px rgba(29, 185, 84, 0.4);
  }
  
  .player-seek .time{
    font-size:12px;
    color:var(--muted);
    min-width:40px;
    text-align:center;
    font-weight:500;
  }
  
  .vol{
    display:flex;
    align-items:center;
    gap:8px;
    min-width:100px;
  }
  
  .vol span{
    font-size:12px;
    color:var(--muted);
    font-weight:600;
  }
  
  .vol input[type="range"]{
    width:80px;
    height:6px;
    -webkit-appearance:none;
    background:rgba(255,255,255,0.2);
    border-radius:3px;
    outline:none;
  }
  
  .vol input[type="range"]::-webkit-slider-thumb{
    -webkit-appearance:none;
    width:14px;
    height:14px;
    background:var(--brand);
    border-radius:50%;
    cursor:pointer;
  }
  
  .tag{
    padding:8px 12px;
    border:1px solid rgba(255,255,255,0.2);
    border-radius:12px;
    font-size:12px;
    color:var(--muted);
    background:rgba(255,255,255,0.05);
    font-weight:600;
    backdrop-filter:blur(10px);
  }
  
  .search-songs-list{
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  
  .search-song-item{
    display:flex;
    align-items:center;
    gap:16px;
    padding:12px 16px;
    border-radius:16px;
    cursor:pointer;
    transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    background:rgba(255,255,255,0.02);
    border:1px solid rgba(255,255,255,0.05);
  }
  
  .search-song-item:hover{
    background:rgba(29, 185, 84, 0.1);
    transform:translateX(8px);
    border-color:rgba(29, 185, 84, 0.3);
    box-shadow:0 4px 20px rgba(29, 185, 84, 0.2);
  }
  
  .search-song-cover{
    width:60px;
    height:60px;
    border-radius:12px;
    object-fit:cover;
    background:#0b0b0b;
    border:2px solid rgba(255,255,255,0.1);
    box-shadow:0 4px 15px rgba(0, 0, 0, 0.3);
  }
  
  .search-song-info{flex:1;min-width:0}
  
  .search-song-title{
    font-weight:700;
    font-size:16px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    margin-bottom:4px;
  }
  
  .search-song-artist{
    color:var(--muted);
    font-size:14px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    font-weight:500;
  }
  
  .search-song-actions{
    display:flex;
    gap:12px;
    align-items:center;
  }
  
  .search-song-play{
    background:linear-gradient(135deg, var(--brand), var(--brand-hover));
    border:none;
    color:white;
    width:44px;
    height:44px;
    border-radius:50%;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:16px;
    transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow:0 4px 15px rgba(29, 185, 84, 0.4);
  }
  
  .search-song-play:hover{
    background:linear-gradient(135deg, var(--brand-hover), #17c653);
    transform:scale(1.1);
    box-shadow:0 6px 20px rgba(29, 185, 84, 0.6);
  }
  
  .no-results{
    text-align:center;
    color:var(--muted);
    padding:60px 40px;
    font-size:18px;
    font-weight:500;
  }
  
  /* Bottom Bar Premium */
  #bottomBar{
    position:fixed;
    bottom:0;
    left:0;
    width:100%;
    height:65px;
    background:linear-gradient(135deg, var(--panel2) 0%, #252525 100%);
    border-top:2px solid rgba(29, 185, 84, 0.2);
    display:grid;
    grid-template-columns:1fr 1fr 1fr 1fr;
    place-items:center;
    padding:8px 16px 4px;
    z-index:40;
    backdrop-filter:blur(20px);
    box-shadow:0 -4px 20px rgba(0, 0, 0, 0.5);
  }
  
  #bottomBar button{
    background:transparent;
    border:none;
    color:var(--muted);
    cursor:pointer;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:4px;
    font-size:10px;
    font-weight:600;
    text-transform:uppercase;
    letter-spacing:0.5px;
    user-select:none;
    transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    padding:8px;
    border-radius:12px;
    position:relative;
  }
  
  #bottomBar button.active,#bottomBar button:hover{
    color:var(--brand);
    transform:translateY(-3px);
    background:rgba(29, 185, 84, 0.1);
  }
  
  #bottomBar .icon{
    width:24px;
    height:24px;
    stroke:currentColor;
    stroke-width:2.5;
    fill:none;
    transition:all 0.3s ease;
  }
  
  #bottomBar button:hover .icon{
    transform:scale(1.1);
    filter:drop-shadow(0 0 6px currentColor);
  }
  
  #bottomBar .label{
    font-size:10px;
    font-weight:700;
    margin-top:2px;
  }
  
  .soundwave{
    width:100px;
    height:40px;
    display:flex;
    align-items:center;
    gap:4px;
    padding:8px;
  }
  
  .bar{
    width:5px;
    height:16px;
    background:linear-gradient(to top,var(--brand),var(--accent));
    border-radius:3px;
    animation:wave 1.2s infinite ease-in-out;
    animation-fill-mode:both;
    box-shadow:0 0 10px currentColor;
  }
  
  .bar:nth-child(1){animation-delay:-1.1s}
  .bar:nth-child(2){animation-delay:-0.9s}
  .bar:nth-child(3){animation-delay:-0.7s}
  .bar:nth-child(4){animation-delay:-0.5s}
  .bar:nth-child(5){animation-delay:-0.3s}
  
  .status-indicator{
    position:fixed;
    top:100px;
    right:24px;
    z-index:100;
  }
  
  .error-msg{
    background:linear-gradient(135deg,var(--error),#cc0000);
    color:white;
    padding:16px 20px;
    border-radius:16px;
    font-size:14px;
    font-weight:600;
    box-shadow:0 8px 25px rgba(255, 68, 68, 0.4);
    border:1px solid rgba(255, 68, 68, 0.3);
  }
  
  .success-msg{
    background:linear-gradient(135deg,var(--success),#2e7d32);
    color:white;
    padding:16px 20px;
    border-radius:16px;
    font-size:14px;
    font-weight:600;
    box-shadow:0 8px 25px rgba(76, 175, 80, 0.4);
    border:1px solid rgba(76, 175, 80, 0.3);
  }
  
  .warning-msg{
    background:linear-gradient(135deg,var(--warning),#f57f17);
    color:black;
    padding:16px 20px;
    border-radius:16px;
    font-size:14px;
    font-weight:700;
    box-shadow:0 8px 25px rgba(255, 171, 0, 0.4);
    border:1px solid rgba(255, 171, 0, 0.3);
  }
  
  /* Now Playing Overlay Premium */
  #npOverlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.95);
    backdrop-filter:blur(30px);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:40;
    animation:fadeIn 0.5s ease;
    transition:opacity 0.4s ease;
  }
  
  #npCard{
    background:linear-gradient(145deg, #111 0%, #222 50%, #111 100%);
    border:2px solid rgba(29, 185, 84, 0.3);
    border-radius:24px;
    width:min(480px,95vw);
    padding:32px;
    display:grid;
    gap:20px;
    justify-items:center;
    animation:slideUp 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow:0 25px 60px rgba(0, 0, 0, 0.8);
    position:relative;
    overflow:hidden;
  }
  
  #npCard::before{
    content:'';
    position:absolute;
    inset:0;
    background:linear-gradient(45deg, transparent, rgba(29,185,84,0.05), transparent);
    pointer-events:none;
  }
  
  #npCard img{
    width:min(360px,85vw);
    height:min(360px,85vw);
    border-radius:20px;
    object-fit:cover;
    border:3px solid rgba(255,255,255,0.1);
    background:#0b0b0b;
    transition:all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    cursor:pointer;
    touch-action:manipulation;
    box-shadow:0 15px 40px rgba(0, 0, 0, 0.6);
  }
  
  #npCard img:hover{
    transform:scale(1.02);
    box-shadow:0 20px 50px rgba(29, 185, 84, 0.3);
    border-color:rgba(29, 185, 84, 0.5);
  }
  
  #npCard .t{
    font-size:24px;
    font-weight:900;
    text-align:center;
    line-height:1.3;
    background:linear-gradient(135deg, var(--brand), var(--accent));
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    background-clip:text;
  }
  
  #npCard .a{
    color:var(--muted);
    text-align:center;
    font-size:18px;
    font-weight:500;
    margin-top:-8px;
  }
  
  .controls{
    display:flex;
    flex-direction:column;
    gap:20px;
    width:100%;
  }
  
  .controls .buttons{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:24px;
  }
  
  .controls .buttons .circle{
    width:80px;
    height:80px;
    border-radius:50%;
    display:grid;
    place-items:center;
    border:3px solid rgba(255,255,255,0.2);
    background:linear-gradient(135deg, #222, #333);
    font-size:32px;
    font-weight:900;
    cursor:pointer;
    transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow:0 8px 25px rgba(0, 0, 0, 0.5);
  }
  
  .controls .buttons .circle:hover{
    transform:scale(1.1);
    background:linear-gradient(135deg, var(--brand), var(--brand-hover));
    border-color:var(--brand);
    box-shadow:0 12px 35px rgba(29, 185, 84, 0.4);
  }
  
  .controls .buttons .sm{width:64px;height:64px;font-size:24px}
  
  .controls .seek{
    display:flex;
    align-items:center;
    gap:16px;
    margin-top:10px;
  }
  
  .controls input[type="range"]{
    width:100%;
    height:8px;
    -webkit-appearance:none;
    background:rgba(255,255,255,0.2);
    border-radius:4px;
    outline:none;
  }
  
  .controls input[type="range"]::-webkit-slider-thumb{
    -webkit-appearance:none;
    width:20px;
    height:20px;
    background:var(--brand);
    border-radius:50%;
    cursor:pointer;
    box-shadow:0 2px 10px rgba(29, 185, 84, 0.5);
  }
  
  /* Modal Styles */
  .playlist-modal{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.9);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:50;
    animation:fadeIn 0.4s ease;
    backdrop-filter:blur(15px);
  }
  
  .playlist-modal-content{
    background:linear-gradient(145deg, var(--panel), var(--panel2));
    border-radius:24px;
    padding:32px;
    width:min(480px,95vw);
    max-height:80vh;
    overflow-y:auto;
    border:2px solid rgba(29, 185, 84, 0.2);
    box-shadow:0 25px 60px rgba(0, 0, 0, 0.8);
  }
  
  .playlist-grid{
    display:grid;
    gap:12px;
    margin-top:20px;
    max-height:400px;
    overflow-y:auto;
  }
  
  .playlist-item{
    display:flex;
    align-items:center;
    gap:16px;
    padding:12px;
    border-radius:16px;
    cursor:pointer;
    transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border:1px solid rgba(255,255,255,0.05);
  }
  
  .playlist-item:hover{
    background:rgba(29, 185, 84, 0.1);
    border-color:rgba(29, 185, 84, 0.3);
    transform:translateX(4px);
  }
  
  .playlist-item img{
    width:48px;
    height:48px;
    border-radius:8px;
    background:linear-gradient(135deg,var(--brand),var(--accent));
    display:flex;
    align-items:center;
    justify-content:center;
    color:white;
    font-size:20px;
    box-shadow:0 4px 15px rgba(29, 185, 84, 0.3);
  }
  
  .playlist-item .info{flex:1}
  
  .playlist-item .name{
    font-weight:700;
    font-size:16px;
    margin-bottom:2px;
  }
  
  .playlist-item .count{
    color:var(--muted);
    font-size:13px;
    font-weight:500;
  }

/* ===== OPTIMIZACIONES MÓVILES ULTRA COMPACTAS ===== */

/* Media queries específicas para móviles */
@media (max-width: 768px) {
  body {
    padding-bottom: var(--mobile-bottom-bar-height);
    font-size: 14px;
  }
  
  /* Header más compacto */
  header {
    padding: 12px 16px;
    height: var(--mobile-header-height);
  }
  
  header .row {
    gap: 12px;
  }
  
  .brand {
    font-size: 18px;
    gap: 8px;
  }
  
  .brand .logo {
    width: 28px;
    height: 28px;
    font-size: 16px;
  }
  
  /* Container más compacto */
  .container {
    padding: var(--mobile-padding);
  }
  
  /* Section titles más pequeños */
  .section-title {
    font-size: 20px;
    margin: 4px 0 12px;
  }
  
  .section-title::before {
    width: 40px;
    height: 3px;
  }
  
  /* Tags más pequeños */
  .tag {
    padding: 6px 10px;
    font-size: 10px;
    border-radius: 8px;
  }
  
  /* Grid de álbumes ultra compacto */
  .grid.albums {
    grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
    gap: 12px;
  }
  
  .grid.playlists {
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 12px;
  }
  
  /* Álbumes más pequeños */
  .album-card, .playlist-card {
    padding: 12px;
    border-radius: 16px;
    transition: all 0.2s ease;
  }
  
  .album-card:hover, .playlist-card:hover {
    transform: translateY(-6px) scale(1.01);
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3);
  }
  
  .album-title, .playlist-title {
    font-size: 12px;
    margin: 8px 0 2px;
    line-height: 1.2;
  }
  
  .album-meta, .playlist-meta {
    font-size: 10px;
    line-height: 1.2;
  }
  
  /* Botones más pequeños */
  .btn {
    padding: 8px 12px;
    font-size: 11px;
    border-radius: 8px;
  }
  
  .btn.small {
    padding: 6px 10px;
    font-size: 10px;
    border-radius: 6px;
  }
  
  .icon-btn {
    padding: 8px 10px;
    font-size: 14px;
    border-radius: 8px;
  }
  
  /* Inputs más compactos */
  input[type="text"], input[type="email"], input[type="password"], select, textarea {
    padding: 10px 14px;
    font-size: 14px;
    border-radius: 8px;
  }
  
  .inputs {
    grid-template-columns: 1fr;
    gap: 12px;
  }
  
  /* Búsqueda inteligente móvil */
  .smart-search-container {
    margin: 0 auto 16px;
  }
  
  .search-input-wrapper {
    padding: 8px 16px;
    border-radius: 25px;
    gap: 8px;
  }
  
  .search-icon {
    width: 16px;
    height: 16px;
  }
  
  #smartSearchInput {
    font-size: 14px;
  }
  
  .search-filters {
    gap: 6px;
    margin-top: 12px;
  }
  
  .filter-btn {
    padding: 6px 12px;
    font-size: 10px;
    border-radius: 16px;
  }
  
  /* Resultados de búsqueda móvil */
  .search-song-item {
    padding: 8px 12px;
    gap: 12px;
    border-radius: 12px;
  }
  
  .search-song-cover {
    width: 45px;
    height: 45px;
    border-radius: 8px;
  }
  
  .search-song-title {
    font-size: 14px;
  }
  
  .search-song-artist {
    font-size: 12px;
  }
  
  .search-song-play {
    width: 36px;
    height: 36px;
    font-size: 14px;
  }
  
  /* Player móvil ultra compacto */
  .player {
    height: var(--mobile-player-height);
    padding: 6px 12px;
    bottom: var(--mobile-bottom-bar-height);
    gap: 8px;
  }
  
  .np {
    gap: 8px;
    padding: 4px;
  }
  
  .np img {
    width: 40px;
    height: 40px;
    border-radius: 6px;
  }
  
  .np .titles .t {
    font-size: 13px;
    line-height: 1.2;
  }
  
  .np .titles .a {
    font-size: 11px;
    line-height: 1.1;
  }
  
  .player-controls {
    gap: 8px;
  }
  
  .player-controls .circle {
    width: 32px;
    height: 32px;
    font-size: 14px;
  }
  
  .player-controls .sm {
    width: 28px;
    height: 28px;
    font-size: 12px;
  }
  
  /* Waveform móvil */
  .waveform-container {
    height: 30px;
    margin: 6px 0;
    border-radius: 15px;
  }
  
  .vol {
    min-width: 60px;
    gap: 4px;
  }
  
  .vol span {
    font-size: 10px;
  }
  
  .vol input[type="range"] {
    width: 40px;
    height: 4px;
  }
  
  /* Bottom bar móvil */
  #bottomBar {
    height: var(--mobile-bottom-bar-height);
    padding: 4px 8px 2px;
    grid-template-columns: 1fr 1fr 1fr 1fr;
  }
  
  #bottomBar button {
    padding: 4px;
    gap: 2px;
    font-size: 8px;
    border-radius: 8px;
  }
  
  #bottomBar .icon {
    width: 18px;
    height: 18px;
    stroke-width: 2;
  }
  
  #bottomBar .label {
    font-size: 8px;
    font-weight: 600;
  }
  
  /* Expansión de álbum móvil */
  .album-expansion {
    padding: 12px;
    margin: 12px 0;
    border-radius: 16px;
  }
  
  /* Song items móvil */
  .song-plain-item {
    padding: 10px 8px;
    gap: 12px;
    border-radius: 8px;
    margin-bottom: 2px;
  }
  
  .song-plain-item .idx {
    min-width: 24px;
    font-size: 12px;
  }
  
  .song-plain-item .title {
    font-size: 14px;
  }
  
  .song-plain-item .actions {
    gap: 6px;
  }
  
  .favorite-btn {
    font-size: 16px;
    padding: 6px;
  }
  
  .download-btn {
    padding: 6px 8px;
    font-size: 10px;
    border-radius: 12px;
  }
  
  /* Modal móvil */
  .playlist-modal-content, #loginModal {
    width: min(380px, 95vw);
    padding: 20px;
    border-radius: 16px;
  }
  
  /* Now Playing móvil */
  #npCard {
    width: min(350px, 95vw);
    padding: 20px;
    gap: 16px;
    border-radius: 20px;
  }
  
  #npCard img {
    width: min(280px, 75vw);
    height: min(280px, 75vw);
    border-radius: 16px;
  }
  
  #npCard .t {
    font-size: 18px;
  }
  
  #npCard .a {
    font-size: 14px;
  }
  
  .controls .buttons .circle {
    width: 50px;
    height: 50px;
    font-size: 20px;
  }
  
  .controls .buttons .sm {
    width: 40px;
    height: 40px;
    font-size: 16px;
  }
  
  /* Visualizador móvil */
  .audio-visualizer {
    margin: 12px 0;
    padding: 12px;
    border-radius: 12px;
  }
  
  .visualizer-canvas {
    height: 100px;
    border-radius: 8px;
  }
  
  .visualizer-controls {
    gap: 8px;
    margin-top: 8px;
  }
  
  .viz-btn {
    padding: 6px 12px;
    font-size: 11px;
    border-radius: 16px;
  }
  
  #vizType {
    padding: 6px 8px;
    font-size: 11px;
    border-radius: 6px;
  }
  
  /* Toast notifications móvil */
  .toast-notification {
    bottom: 60px;
    right: 12px;
    padding: 12px 16px;
    font-size: 12px;
    border-radius: 12px;
    max-width: 250px;
  }
  
  /* Admin panel móvil */
  .pill {
    padding: 8px 12px;
    font-size: 12px;
    border-radius: 20px;
  }
  
  /* Modo inmersivo móvil */
  .immersive-content {
    padding: 20px;
  }
  
  .immersive-artwork img {
    width: min(300px, 75vw);
    height: min(300px, 75vw);
    border-radius: 16px;
  }
  
  .immersive-title {
    font-size: 1.5rem;
  }
  
  .immersive-artist {
    font-size: 0.9rem;
  }
  
  .gesture-hints {
    grid-template-columns: 1fr;
    gap: 6px;
    font-size: 10px;
    bottom: 12px;
  }
  
  .hint {
    padding: 6px 10px;
    border-radius: 16px;
    font-size: 10px;
  }
  
  /* Loading screen móvil */
  .loading .spinner {
    width: 45px;
    height: 45px;
  }
  
  .loading .text {
    font-size: 16px;
    margin-top: 16px;
  }
  
  /* Optimizar animaciones para móvil */
  .slide-up {
    animation-duration: 0.2s;
  }
  
  .fade-in {
    animation-duration: 0.3s;
  }
  
  /* Reducir sombras para mejor performance */
  .card, .album-card, .playlist-card {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }
  
  .card:hover, .album-card:hover, .playlist-card:hover {
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
  }
}

/* Móviles muy pequeños */
@media (max-width: 480px) {
  .container {
    padding: 8px;
  }
  
  /* Grid ultra compacto */
  .grid.albums {
    grid-template-columns: repeat(auto-fill, minmax(65px, 1fr));
    gap: 8px;
  }
  
  .grid.playlists {
    grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
    gap: 8px;
  }
  
  /* Álbumes extra pequeños */
  .album-card, .playlist-card {
    padding: 8px;
  }
  
  .album-title, .playlist-title {
    font-size: 11px;
    margin: 6px 0 2px;
  }
  
  .album-meta, .playlist-meta {
    font-size: 9px;
  }
  
  /* Header extra compacto */
  header {
    padding: 8px 12px;
  }
  
  .brand {
    font-size: 16px;
  }
  
  .brand .logo {
    width: 24px;
    height: 24px;
    font-size: 14px;
  }
  
  /* Section title extra pequeño */
  .section-title {
    font-size: 18px;
    margin: 2px 0 8px;
  }
  
  /* Player extra compacto */
  .player {
    height: 50px;
    padding: 4px 8px;
  }
  
  .np img {
    width: 36px;
    height: 36px;
  }
  
  .np .titles .t {
    font-size: 12px;
  }
  
  .np .titles .a {
    font-size: 10px;
  }
  
  .player-controls .circle {
    width: 30px;
    height: 30px;
    font-size: 12px;
  }
  
  .player-controls .sm {
    width: 26px;
    height: 26px;
    font-size: 10px;
  }
  
  /* Bottom bar extra compacto */
  #bottomBar {
    height: 40px;
    padding: 2px 6px 1px;
  }
  
  #bottomBar button {
    padding: 2px;
    gap: 1px;
  }
  
  #bottomBar .icon {
    width: 16px;
    height: 16px;
  }
  
  #bottomBar .label {
    font-size: 7px;
  }
  
  /* Expansión álbum extra compacta */
  .album-expansion {
    padding: 8px;
    margin: 8px 0;
  }
  
  /* Botones extra pequeños */
  .btn {
    padding: 6px 8px;
    font-size: 10px;
  }
  
  .btn.small {
    padding: 4px 6px;
    font-size: 9px;
  }
  
  /* Toast extra compacto */
  .toast-notification {
    bottom: 50px;
    right: 8px;
    padding: 8px 12px;
    font-size: 11px;
    max-width: 200px;
  }
  
  /* Now playing extra compacto */
  #npCard {
    width: min(320px, 98vw);
    padding: 16px;
    gap: 12px;
  }
  
  #npCard img {
    width: min(240px, 70vw);
    height: min(240px, 70vw);
  }
  
  #npCard .t {
    font-size: 16px;
  }
  
  #npCard .a {
    font-size: 12px;
  }
  
  .controls .buttons .circle {
    width: 45px;
    height: 45px;
    font-size: 18px;
  }
  
  .controls .buttons .sm {
    width: 36px;
    height: 36px;
    font-size: 14px;
  }
}

/* Móviles en landscape */
@media (max-width: 768px) and (orientation: landscape) {
  .container {
    padding: 8px 16px;
  }
  
  .grid.albums {
    grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
  }
  
  .immersive-content {
    flex-direction: row;
    align-items: center;
    gap: 20px;
    padding: 16px;
  }
  
  .immersive-artwork {
    margin-bottom: 0;
  }
  
  .immersive-artwork img {
    width: min(200px, 40vw);
    height: min(200px, 40vw);
  }
}
</style>
</head>

<body>
<div id="loadingScreen" class="loading">
  <div class="spinner"></div>
  <div class="text">Cargando KLMZ MUSIC...</div>
</div>
<div id="gestureHint" class="gesture-hint"></div>

<!-- Modo Inmersivo -->
<div id="immersiveMode" class="immersive-overlay">
  <div class="immersive-background"></div>
  <div class="immersive-content">
    <div class="immersive-artwork">
      <img id="immersiveArtwork" alt="Album Art">
      <div class="artwork-glow"></div>
    </div>
    <div class="immersive-info">
      <h1 class="immersive-title">—</h1>
      <p class="immersive-artist">—</p>
    </div>
    <div class="immersive-controls">
      <button class="immersive-btn" onclick="exitImmersive()">✕ Salir del Modo Inmersivo</button>
    </div>
  </div>
  <div class="gesture-hints">
    <div class="hint">👆 Desliza arriba: Volumen +</div>
    <div class="hint">👇 Desliza abajo: Volumen -</div>
    <div class="hint">👈 Desliza izquierda: Anterior</div>
    <div class="hint">👉 Desliza derecha: Siguiente</div>
  </div>
</div>

<header>
  <div class="row">
    <div class="brand">
      <span class="logo">🔥</span> 
      KLMZ MUSIC
    </div>
    <div class="tools">
      <span class="muted" id="albumsTitle">Tu música</span>
      <button class="icon-btn" id="btn-login" title="Admin" onclick="showLogin()">🔑</button>
      <button class="btn ghost" id="btn-logout" style="display:none" onclick="logout()">Salir</button>
    </div>
  </div>
</header>
<div class="container">
  <div class="row muted" style="margin-bottom:24px;">
    <span class="tag">Catálogo público</span>
    <span id="adminTag" class="tag" style="display:none;background:linear-gradient(135deg, var(--brand), var(--accent));color:white;">Admin</span>
    <span id="userTag" class="tag" style="display:none;background:linear-gradient(135deg, var(--accent), #e55722);color:white;">Usuario</span>
    <span id="offlineTag" class="tag" style="display:none;background:linear-gradient(135deg, var(--success), #2e7d32);color:white;">Offline</span>
  </div>
  <div id="musicControls" class="music-controls" style="display:none;">
    <button class="control-btn" id="shuffleBtn" onclick="toggleShuffle()" title="Aleatorio">
      <span>🔀</span> Shuffle
    </button>
    <button class="control-btn" id="repeatBtn" onclick="toggleRepeat()" title="Repetir">
      <span>🔁</span> Repeat
    </button>
    <button class="control-btn" onclick="showFavorites()" title="Favoritos">
      <span>❤️</span> Favoritos
    </button>
    <button class="control-btn" onclick="showDownloads()" title="Descargas">
      <span>⬇</span> Offline
    </button>
  </div>
  
  <!-- Audio Visualizer -->
  <div class="audio-visualizer" id="audioVisualizer" style="display:none;">
    <canvas id="audioVisualizerCanvas" class="visualizer-canvas"></canvas>
    <div class="visualizer-controls">
      <button class="viz-btn" onclick="toggleVisualizer()">🎵 Visualizador</button>
      <select id="vizType" onchange="changeVisualizerType(this.value)">
        <option value="bars">Barras</option>
        <option value="circular">Circular</option>
        <option value="waveform">Onda</option>
      </select>
    </div>
  </div>
  
  <div id="searchView" style="display:none;">
    <div class="backline">
      <button class="back-btn" onclick="closeSearchView()" title="Volver">←</button>
      <span class="muted">Volver</span>
    </div>
    <div class="section-title">🔍 Buscar Música</div>
    
    <!-- Búsqueda Inteligente -->
    <div class="smart-search-container">
      <div class="search-input-wrapper">
        <svg class="search-icon" viewBox="0 0 24 24">
          <circle cx="11" cy="11" r="7"/>
          <line x1="16.5" y1="16.5" x2="21" y2="21"/>
        </svg>
        <input type="text" id="smartSearchInput" placeholder="Buscar canciones, artistas, álbumes..." autocomplete="off" oninput="smartSearch(this.value)">
        <button class="search-clear-btn" onclick="clearSearch()" style="display:none;">✕</button>
      </div>
      <div id="searchSuggestions" class="search-suggestions"></div>
      <div class="search-filters">
        <button class="filter-btn active" data-filter="all" onclick="setSearchFilter('all')">Todo</button>
        <button class="filter-btn" data-filter="songs" onclick="setSearchFilter('songs')">Canciones</button>
        <button class="filter-btn" data-filter="albums" onclick="setSearchFilter('albums')">Álbumes</button>
        <button class="filter-btn" data-filter="artists" onclick="setSearchFilter('artists')">Artistas</button>
      </div>
    </div>
    
    <div id="searchResults" class="search-songs-list"></div>
    <div id="noSearchResults" class="no-results" style="display:none;">
      <div style="font-size:64px;margin-bottom:20px">🔍</div>
      <div>Escribe algo para buscar música</div>
    </div>
  </div>
  <div id="favoritesView" style="display:none;">
    <div class="backline">
      <button class="back-btn" onclick="closeFavoritesView()" title="Volver">←</button>
      <span class="muted">Volver</span>
    </div>
    <div class="section-title">❤️ Mis Favoritos</div>
    <div id="favoritesList" class="search-songs-list"></div>
    <div id="emptyFavorites" class="no-results" style="display:none;">
      <div style="font-size:64px;margin-bottom:20px">❤️</div>
      <div>No tienes favoritos aún</div>
    </div>
  </div>
  <div id="downloadsView" style="display:none;">
    <div class="backline">
      <button class="back-btn" onclick="closeDownloadsView()" title="Volver">←</button>
      <span class="muted">Volver</span>
    </div>
    <div class="section-title">⬇ Música Offline</div>
    <div id="downloadsList" class="search-songs-list"></div>
    <div id="emptyDownloads" class="no-results" style="display:none;">
      <div style="font-size:64px;margin-bottom:20px">⬇</div>
      <div>No tienes música offline</div>
    </div>
  </div>
  <div id="playlistsView" style="display:none;">
    <div class="backline">
      <button class="back-btn" onclick="closePlaylistsView()" title="Volver">←</button>
      <span class="muted">Volver</span>
    </div>
    <div class="row" style="align-items:center;justify-content:space-between;margin-bottom:16px">
      <div class="section-title" style="margin:0">📱 Mis Playlists</div>
      <button class="btn small" onclick="createNewPlaylist()">+ Nueva</button>
    </div>
    <div id="playlistsGrid" class="grid playlists"></div>
    <div id="emptyPlaylists" class="no-results" style="display:none;">
      <div style="font-size:64px;margin-bottom:20px">📱</div>
      <div>No tienes playlists aún</div>
      <button class="btn" onclick="createNewPlaylist()" style="margin-top:20px">Crear mi primera playlist</button>
    </div>
  </div>
  <div id="playlistView" class="card stack">
    <div class="backline">
      <button class="back-btn" onclick="closePlaylistView()" title="Volver">←</button>
      <span class="muted">Volver</span>
    </div>
    <div class="playlist-hero">
      <div id="pvCover">📱</div>
      <div class="info">
        <div id="pvTitle" class="title">—</div>
        <div id="pvMeta" class="meta">—</div>
        <div class="row" style="margin-top:12px;gap:12px">
          <button class="btn small" id="pvPlayBtn" onclick="playPlaylist()">▶ Reproducir</button>
          <button class="btn small ghost" id="pvDeleteBtn" onclick="deletePlaylist()">🗑️ Eliminar</button>
        </div>
      </div>
    </div>
    <div id="pvSongs" class="song-plain-list"></div>
  </div>

  <!-- PANEL ADMIN PREMIUM -->
  <div id="adminPanel" class="card stack" style="display:none">
    <div class="section-title">🛠️ Panel de Administración</div>
    <div class="inputs">
      <div class="stack">
        <div class="pill">➕ Crear nuevo álbum</div>
        <input id="albumTitle" type="text" placeholder="Título del álbum" />
        <input id="albumArtist" type="text" placeholder="Artista del álbum" />
        <input id="albumCover" type="file" accept="image/*" />
        <button class="btn" onclick="uploadAlbum()">✨ Subir Álbum</button>
      </div>
      <div class="stack">
        <div class="pill">🎵 Agregar canciones a álbum</div>
        <select id="albumSelect"></select>
        <input id="songTitle" type="text" placeholder="Título de la canción (opcional si subes 1)" />
        <input id="songFiles" type="file" accept="audio/*" multiple />
        <button class="btn" onclick="uploadSong()">📤 Subir Canciones</button>
      </div>
      <div class="stack">
        <div class="pill">✏️ Editar información de álbum</div>
        <select id="editInfoAlbumSelect"></select>
        <div class="row" style="gap:8px">
          <input id="editAlbumTitle" type="text" placeholder="Nuevo título" />
          <input id="editAlbumArtist" type="text" placeholder="Nuevo artista" />
        </div>
        <input id="editAlbumCover" type="file" accept="image/*" />
        <div class="row" style="gap:8px">
          <button class="btn" onclick="editAlbumInfo()">💾 Actualizar Info</button>
          <button class="btn warning" onclick="editAlbumCoverOnly()">🖼️ Solo Portada</button>
        </div>
      </div>
      <div class="stack">
        <div class="pill">🗑️ Eliminar canciones individuales</div>
        <select id="deleteSongAlbumSelect" onchange="loadSongsForDeletion()">
          <option value="">Selecciona un álbum</option>
        </select>
        <select id="deleteSongSelect" style="display:none">
          <option value="">Selecciona una canción</option>
        </select>
        <button class="btn danger" onclick="deleteSong()" id="deleteSongBtn" style="display:none">🗑️ Eliminar Canción</button>
      </div>
      <div class="stack">
        <div class="pill">💥 Eliminar álbumes completos</div>
        <select id="deleteAlbumSelect"></select>
        <button class="btn danger" onclick="deleteAlbum()">💀 Eliminar Álbum Completo</button>
      </div>
    </div>
  </div>

  <div id="homeContent">
    <div class="row" style="align-items:center;justify-content:space-between;margin-bottom:16px">
      <div class="section-title"
      <div class="section-title" style="margin:0">Albums</div>
      <div class="row" style="gap:8px">
        <button class="btn small" onclick="enterImmersiveMode()" style="display:none" id="immersiveBtn">🎭 Inmersivo</button>
        <select id="albumSort" onchange="sortAlbums(this.value)" style="display:none;background:rgba(255,255,255,0.05);border:2px solid rgba(255,255,255,0.1);color:var(--text);padding:8px 12px;border-radius:12px;font-size:14px;backdrop-filter:blur(10px);">
          <option value="date">Por fecha</option>
          <option value="title">Por título</option>
          <option value="artist">Por artista</option>
        </select>
      </div>
    </div>
    <div id="albumsGrid" class="grid albums"></div>
    <div id="emptyAlbums" class="no-results" style="display:none">
      <div style="font-size:64px;margin-bottom:20px">🎵</div>
      <div>No hay álbumes todavía</div>
    </div>
  </div>
  <div id="albumView" class="card stack">
    <div class="backline">
      <button class="back-btn" onclick="closeAlbumView()" title="Volver">←</button>
      <span class="muted">Volver</span>
    </div>
    <div class="album-hero">
      <img id="avCover" alt="cover">
      <div class="info">
        <div id="avTitle" class="title">—</div>
        <div id="avMeta" class="meta">—</div>
      </div>
    </div>
    <div id="avSongs" class="song-plain-list"></div>
  </div>
</div>

<!-- Player con Waveform -->
<div class="player" id="player" onclick="openNowPlaying()">
  <div class="np">
    <img id="npCover" alt="cover">
    <div class="titles">
      <div id="npTitle" class="t">Cargando...</div>
      <div id="npAlbum" class="a">—</div>
    </div>
  </div>
  <div class="player-controls">
    <button class="circle sm" onclick="event.stopPropagation(); prevTrack()">⏮</button>
    <button class="circle" id="playBtn" onclick="event.stopPropagation(); togglePlay()">▶</button>
    <button class="circle sm" onclick="event.stopPropagation(); nextTrack()">⏭</button>
  </div>
  <!-- Waveform Container -->
  <div class="waveform-container" onclick="event.stopPropagation()">
    <canvas id="waveformCanvas" class="waveform-canvas"></canvas>
    <div class="waveform-progress" id="waveformProgress"></div>
    <div class="player-seek" style="position:absolute;top:0;left:0;right:0;height:100%;opacity:0">
      <span id="curTime" class="time">0:00</span>
      <input id="seek" type="range" min="0" max="100" value="0" oninput="seekAudio(this.value)" style="width:100%" />
      <span id="durTime" class="time">0:00</span>
    </div>
  </div>
  <div class="vol">
    <span>🔊</span>
    <input id="vol" type="range" min="0" max="1" step="0.01" value="1" oninput="setVolume(this.value)" onclick="event.stopPropagation()" />
  </div>
  <div class="soundwave" id="soundwave" style="display:none">
    <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
  </div>
  <audio id="audio" preload="none" crossorigin="anonymous"></audio>
</div>

<div id="npOverlay" onclick="closeNowPlaying()">
  <div id="npCard" onclick="event.stopPropagation()">
    <img id="npBigCover" alt="cover" ondblclick="enterImmersiveMode()">
    <div class="t" id="npBigTitle">—</div>
    <div class="a" id="npBigAlbum">—</div>
    
    <div class="row" style="margin:20px 0">
      <button class="favorite-btn" id="npFavoriteBtn" onclick="toggleCurrentFavorite()" title="Favorito">🤍</button>
      <button class="download-btn" id="npDownloadBtn" onclick="downloadCurrentSong()" title="Descargar">⬇</button>
      <button class="btn small" onclick="enterImmersiveMode()" title="Modo Inmersivo">🎭</button>
    </div>
    
    <div class="soundwave" style="margin:24px 0;">
      <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
    </div>
    
    <div class="controls" style="width:100%;max-width:600px">
      <div class="buttons">
        <button class="circle sm" onclick="prevTrack()">⏮</button>
        <button class="circle" onclick="togglePlay()" id="playBtnBig">▶</button>
        <button class="circle sm" onclick="nextTrack()">⏭</button>
      </div>
      <div class="seek">
        <span id="curTimeBig" class="muted">0:00</span>
        <input id="seekBig" type="range" min="0" max="100" value="0" oninput="seekAudio(this.value)" />
        <span id="durTimeBig" class="muted">0:00</span>
      </div>
    </div>
  </div>
</div>
<div id="bottomBar">
  <button id="btn-home" title="Inicio" onclick="goHome()" class="active">
    <svg class="icon" viewBox="0 0 24 24"><path d="M3 11L12 2l9 9v9a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2v-5H9v5a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-9z"/></svg>
    <span class="label">Inicio</span>
  </button>
  <button id="btn-search" title="Buscar" onclick="showSearch()">
    <svg class="icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="7"/><line x1="16.5" y1="16.5" x2="21" y2="21"/></svg>
    <span class="label">Buscar</span>
  </button>
  <button id="btn-playlists" title="Playlists" onclick="showPlaylists()">
    <svg class="icon" viewBox="0 0 24 24"><path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/></svg>
    <span class="label">Playlists</span>
  </button>
  <button id="btn-account" title="Cuenta" onclick="showAccount()">
    <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="7" r="4"/><path d="M5.5 21a7.5 7.5 0 0 1 13 0"/></svg>
    <span class="label">Cuenta</span>
  </button>
</div>
<div id="playlistModal" class="playlist-modal">
  <div class="playlist-modal-content">
    <div class="section-title">Agregar a Playlist</div>
    <div class="playlist-grid" id="playlistModalGrid"></div>
    <div class="row" style="margin-top:20px;gap:12px">
      <button class="btn small" onclick="createPlaylistFromModal()">+ Nueva Playlist</button>
      <button class="btn small ghost" onclick="closePlaylistModal()">Cancelar</button>
    </div>
  </div>
</div>
<div id="loginModal" class="card" style="display:none;position:fixed;inset:0;margin:auto;max-width:480px;height:max-content;z-index:50">
  <div class="stack">
    <div class="section-title">Iniciar sesión</div>
    <input id="email" type="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Contraseña" />
    <div class="row">
      <button class="btn" onclick="login()">Entrar</button>
      <button class="btn ghost" onclick="hideLogin()">Cancelar</button>
    </div>
    <small class="muted" style="text-align:center;margin-top:12px;">Crea una cuenta o inicia sesión para gestionar playlists.</small>
  </div>
</div>

<script>
const SUPABASE_URL = "https://nqbldvpnqhngdtalvzov.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xYmxkdnBucWhuZ2R0YWx2em92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyMjY0NjUsImV4cCI6MjA3MDgwMjQ2NX0.Zzg5D219sW7bhvl0_R5ypX9MF6nRzBSDIeo2Lvebab0";
const ADMIN_EMAIL = "klmzr@gmail.com";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let isAdmin = false, isLoggedIn = false, currentUser = null;
let albums = [], userPlaylists = [], publicPlaylists = [];
let songsByAlbum = {}, songsByPlaylist = {}, flatSongs = [];
let queue = [], qIndex = -1, currentAlbum = null, currentPlaylist = null;
let searchFilter = 'all';
let audioVisualizer = null;
let gestureController = null;

// ===== DETECTAR MÓVIL Y OPTIMIZACIONES =====

// Detectar dispositivo móvil
function isMobile() {
  return window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}

// Debounce function para mejor performance
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// Ajustar grid según tamaño de pantalla
function adjustMobileGrid() {
  const albumsGrid = document.getElementById("albumsGrid");
  if (!albumsGrid) return;
  
  const width = window.innerWidth;
  let columns;
  
  if (width <= 320) {
    columns = 'repeat(auto-fill, minmax(60px, 1fr))';
  } else if (width <= 480) {
    columns = 'repeat(auto-fill, minmax(65px, 1fr))';
  } else if (width <= 768) {
    columns = 'repeat(auto-fill, minmax(70px, 1fr))';
  } else {
    columns = 'repeat(auto-fill, minmax(100px, 1fr))';
  }
  
  albumsGrid.style.gridTemplateColumns = columns;
}

// Optimizar interfaz para móviles
function optimizeForMobile() {
  if (isMobile()) {
    // Reducir calidad del visualizador en móviles
    if (audioVisualizer && audioVisualizer.analyser) {
      audioVisualizer.analyser.fftSize = 128; // Menor resolución
    }
    
    // Optimizar scroll en móviles
    document.body.style.overflow = 'auto';
    document.body.style.webkitOverflowScrolling = 'touch';
    
    // Ajustar grid de álbumes según ancho de pantalla
    adjustMobileGrid();
    
    // Configurar gestos mejorados
    if (gestureController) {
      gestureController.threshold = 30; // Gestos más sensibles en móvil
    }
    
    console.log('📱 Optimizaciones móviles aplicadas');
  }
}

// ===== CLASES PROFESIONALES =====

// Audio Visualizer Class
class AudioVisualizer {
  constructor() {
    this.canvas = document.getElementById('audioVisualizerCanvas');
    this.ctx = this.canvas ? this.canvas.getContext('2d') : null;
    this.audioContext = null;
    this.analyser = null;
    this.dataArray = null;
    this.animationId = null;
    this.isActive = false;
    this.type = 'bars';
  }

  async init(audioElement) {
    if (!this.canvas || !this.ctx) return;
    
    try {
      this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
      this.analyser = this.audioContext.createAnalyser();
      const source = this.audioContext.createMediaElementSource(audioElement);
      
      source.connect(this.analyser);
      this.analyser.connect(this.audioContext.destination);
      
      this.analyser.fftSize = isMobile() ? 128 : 256;
      this.dataArray = new Uint8Array(this.analyser.frequencyBinCount);
      
      this.resize();
      this.isActive = true;
      this.draw();
    } catch (error) {
      console.error('Error inicializando visualizador:', error);
    }
  }

  resize() {
    if (!this.canvas) return;
    this.canvas.width = this.canvas.offsetWidth;
    this.canvas.height = this.canvas.offsetHeight;
  }

  draw() {
    if (!this.isActive || !this.analyser || !this.ctx) return;
    
    this.animationId = requestAnimationFrame(() => this.draw());
    this.analyser.getByteFrequencyData(this.dataArray);
    
    this.ctx.fillStyle = 'rgba(10, 10, 10, 0.1)';
    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
    
    if (this.type === 'bars') {
      this.drawBars();
    } else if (this.type === 'circular') {
      this.drawCircular();
    } else if (this.type === 'waveform') {
      this.drawWaveform();
    }
  }

  drawBars() {
    const barWidth = (this.canvas.width / this.dataArray.length) * 2.5;
    let barHeight;
    let x = 0;
    
    for (let i = 0; i < this.dataArray.length; i++) {
      barHeight = (this.dataArray[i] / 255) * this.canvas.height * 0.8;
      
      const r = barHeight + 25 * (i / this.dataArray.length);
      const g = 250 * (i / this.dataArray.length);
      const b = 50;
      
      this.ctx.fillStyle = `rgb(${r},${g},${b})`;
      this.ctx.fillRect(x, this.canvas.height - barHeight, barWidth, barHeight);
      
      x += barWidth + 1;
    }
  }

  drawCircular() {
    const centerX = this.canvas.width / 2;
    const centerY = this.canvas.height / 2;
    const radius = Math.min(centerX, centerY) - 10;
    
    for (let i = 0; i < this.dataArray.length; i++) {
      const angle = (i / this.dataArray.length) * Math.PI * 2;
      const barHeight = (this.dataArray[i] / 255) * 50;
      
      const x1 = centerX + Math.cos(angle) * radius;
      const y1 = centerY + Math.sin(angle) * radius;
      const x2 = centerX + Math.cos(angle) * (radius + barHeight);
      const y2 = centerY + Math.sin(angle) * (radius + barHeight);
      
      this.ctx.strokeStyle = `hsl(${i * 2}, 100%, 50%)`;
      this.ctx.lineWidth = 2;
      this.ctx.beginPath();
      this.ctx.moveTo(x1, y1);
      this.ctx.lineTo(x2, y2);
      this.ctx.stroke();
    }
  }

  drawWaveform() {
    this.ctx.strokeStyle = '#1db954';
    this.ctx.lineWidth = 2;
    this.ctx.beginPath();
    
    const sliceWidth = this.canvas.width / this.dataArray.length;
    let x = 0;
    
    for (let i = 0; i < this.dataArray.length; i++) {
      const v = this.dataArray[i] / 255;
      const y = v * this.canvas.height;
      
      if (i === 0) {
        this.ctx.moveTo(x, y);
      } else {
        this.ctx.lineTo(x, y);
      }
      
      x += sliceWidth;
    }
    
    this.ctx.stroke();
  }

  stop() {
    this.isActive = false;
    if (this.animationId) {
      cancelAnimationFrame(this.animationId);
    }
  }

  changeType(type) {
    this.type = type;
  }
}

// Gesture Controller Class
class GestureController {
  constructor() {
    this.startY = 0;
    this.startX = 0;
    this.threshold = isMobile() ? 30 : 50;
    this.isEnabled = false;
  }

  init() {
    this.isEnabled = true;
    
    document.addEventListener('touchstart', (e) => {
      if (!this.isEnabled) return;
      this.startY = e.touches[0].clientY;
      this.startX = e.touches.clientX;
    }, { passive: true });

    document.addEventListener('touchend', (e) => {
      if (!this.isEnabled) return;
      const endY = e.changedTouches[0].clientY;
      const endX = e.changedTouches.clientX;
      const diffY = this.startY - endY;
      const diffX = this.startX - endX;

      if (Math.abs(diffY) > this.threshold) {
        if (diffY > 0) {
          this.adjustVolume(0.1);
          showToast('🔊 Volumen subido', 'info');
        } else {
          this.adjustVolume(-0.1);
          showToast('🔉 Volumen bajado', 'info');
        }
      } else if (Math.abs(diffX) > this.threshold) {
        if (diffX > 0) {
          prevTrack();
          showToast('⏮ Canción anterior', 'info');
        } else {
          nextTrack();
          showToast('⏭ Canción siguiente', 'info');
        }
      }
    }, { passive: true });
  }

  adjustVolume(change) {
    const audio = document.getElementById('audio');
    if (!audio) return;
    
    const newVolume = Math.max(0, Math.min(1, audio.volume + change));
    audio.volume = newVolume;
    const volSlider = document.getElementById('vol');
    if (volSlider) volSlider.value = newVolume;
  }

  enable() {
    this.isEnabled = true;
  }

  disable() {
    this.isEnabled = false;
  }
}

// ===== FUNCIONES MEJORADAS =====

// Toast notifications mejoradas
function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = `toast-notification ${type}`;
  toast.textContent = message;
  
  // Optimizaciones móviles
  if (isMobile()) {
    toast.style.fontSize = '11px';
    toast.style.padding = '8px 12px';
    toast.style.maxWidth = '200px';
    toast.style.bottom = '50px';
    toast.style.right = '8px';
  }
  
  document.body.appendChild(toast);
  
  setTimeout(() => toast.classList.add('show'), 100);
  
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => {
      if (document.body.contains(toast)) {
        document.body.removeChild(toast);
      }
    }, 400);
  }, isMobile() ? 2000 : 3000);
}

// Waveform drawing optimizado
function drawWaveform() {
  const canvas = document.getElementById('waveformCanvas');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  canvas.width = canvas.offsetWidth;
  canvas.height = canvas.offsetHeight;
  
  ctx.strokeStyle = '#1db954';
  ctx.lineWidth = 2;
  ctx.beginPath();
  
  const step = isMobile() ? 6 : 3; // Menos puntos en móvil
  for (let i = 0; i < canvas.width; i += step) {
    const height = Math.random() * canvas.height * 0.8;
    ctx.moveTo(i, canvas.height - height);
    ctx.lineTo(i, canvas.height);
  }
  ctx.stroke();
}

// Smart Search con sugerencias optimizado
function smartSearch(query) {
  const resultsEl = document.getElementById('searchResults');
  const suggestionsEl = document.getElementById('searchSuggestions');
  const noResultsEl = document.getElementById('noSearchResults');
  const clearBtn = document.querySelector('.search-clear-btn');
  
  if (!resultsEl || !noResultsEl) return;
  
  // Mostrar/ocultar botón de limpiar
  if (clearBtn) {
    clearBtn.style.display = query.trim() ? 'block' : 'none';
  }
  
  resultsEl.innerHTML = '';
  suggestionsEl.innerHTML = '';
  
  if (!query || query.trim() === '') {
    noResultsEl.style.display = 'block';
    suggestionsEl.style.display = 'none';
    return;
  }
  
  noResultsEl.style.display = 'none';
  
  // Generar sugerencias (limitadas en móvil)
  const suggestions = generateSuggestions(query);
  const maxSuggestions = isMobile() ? 3 : 5;
  
  if (suggestions.length > 0) {
    suggestionsEl.style.display = 'block';
    suggestions.slice(0, maxSuggestions).forEach(suggestion => {
      const item = document.createElement('div');
      item.className = 'suggestion-item';
      item.innerHTML = `
        <span style="margin-right:8px;">🔍</span>
        <span>${suggestion}</span>
      `;
      item.onclick = () => {
        document.getElementById('smartSearchInput').value = suggestion;
        suggestionsEl.style.display = 'none';
        performSearch(suggestion);
      };
      suggestionsEl.appendChild(item);
    });
  } else {
    suggestionsEl.style.display = 'none';
  }
  
  // Realizar búsqueda
  performSearch(query);
}

function generateSuggestions(query) {
  const lowerQuery = query.toLowerCase();
  const suggestions = new Set();
  
  flatSongs.forEach(song => {
    if (song.title.toLowerCase().includes(lowerQuery)) {
      suggestions.add(song.title);
    }
    if (song.album_title && song.album_title.toLowerCase().includes(lowerQuery)) {
      suggestions.add(song.album_title);
    }
  });
  
  albums.forEach(album => {
    if (album.title.toLowerCase().includes(lowerQuery)) {
      suggestions.add(album.title);
    }
    if (album.artist && album.artist.toLowerCase().includes(lowerQuery)) {
      suggestions.add(album.artist);
    }
  });
  
  return Array.from(suggestions);
}

function performSearch(query) {
  const resultsEl = document.getElementById('searchResults');
  const noResultsEl = document.getElementById('noSearchResults');
  
  const lowerQuery = query.toLowerCase();
  let filtered = [];
  
  // Limitar resultados en móvil para mejor performance
  const maxResults = isMobile() ? 10 : 20;
  
  if (searchFilter === 'all' || searchFilter === 'songs') {
    const songs = flatSongs.filter(song => {
      const titleMatch = song.title.toLowerCase().includes(lowerQuery);
      const albumMatch = song.album_title ? song.album_title.toLowerCase().includes(lowerQuery) : false;
      const album = albums.find(a => a.title === song.album_title);
      const artistMatch = album && album.artist ? album.artist.toLowerCase().includes(lowerQuery) : false;
      return titleMatch || albumMatch || artistMatch;
    }).slice(0, maxResults);
    
    filtered = filtered.concat(songs.map(song => ({...song, type: 'song'})));
  }
  
  if (searchFilter === 'all' || searchFilter === 'albums') {
    const albumResults = albums.filter(album => {
      const titleMatch = album.title.toLowerCase().includes(lowerQuery);
      const artistMatch = album.artist ? album.artist.toLowerCase().includes(lowerQuery) : false;
      return titleMatch || artistMatch;
    }).slice(0, maxResults);
    
    filtered = filtered.concat(albumResults.map(album => ({...album, type: 'album'})));
  }
  
  if (filtered.length === 0) {
    noResultsEl.style.display = 'block';
    return;
  }
  
  noResultsEl.style.display = 'none';
  resultsEl.innerHTML = '';
  
  // Renderizado optimizado
  filtered.slice(0, maxResults).forEach((item, index) => {
    const div = document.createElement('div');
    div.className = 'search-song-item slide-up';
    div.style.animationDelay = `${index * 0.05}s`;
    
    if (item.type === 'song') {
      const album = albums.find(a => a.title === item.album_title);
      div.innerHTML = `
        <img class="search-song-cover" src="${item.cover_url || ''}" alt="Portada" 
             onerror="this.style.background='var(--panel)'; this.innerHTML='🎵';" loading="lazy">
        <div class="search-song-info">
          <div class="search-song-title">🎵 ${item.title}</div>
          <div class="search-song-artist">${album?.artist || item.album_title || 'Desconocido'}</div>
        </div>
        <div class="search-song-actions">
          <button class="search-song-play" onclick="event.stopPropagation(); playTrackFromSearch('${item.id}')" title="Reproducir">▷</button>
        </div>
      `;
      div.onclick = () => playTrackFromSearch(item.id);
    } else if (item.type === 'album') {
      div.innerHTML = `
        <img class="search-song-cover" src="${item.cover_url || ''}" alt="Portada" 
             onerror="this.style.background='var(--panel)'; this.innerHTML='🎵';" 
             style="border-radius:50%;" loading="lazy">
        <div class="search-song-info">
          <div class="search-song-title">💿 ${item.title}</div>
          <div class="search-song-artist">${item.artist || 'Sin artista'}</div>
        </div>
        <div class="search-song-actions">
          <button class="search-song-play" onclick="event.stopPropagation(); openAlbumFromSearch('${item.id}')" title="Ver álbum">👁</button>
        </div>
      `;
      div.onclick = () => openAlbumFromSearch(item.id);
    }
    
    resultsEl.appendChild(div);
  });
}

function setSearchFilter(filter) {
  searchFilter = filter;
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.filter === filter);
  });
  
  const query = document.getElementById('smartSearchInput').value;
  if (query.trim()) {
    performSearch(query);
  }
}

function clearSearch() {
  const input = document.getElementById('smartSearchInput');
  const clearBtn = document.querySelector('.search-clear-btn');
  const suggestionsEl = document.getElementById('searchSuggestions');
  
  if (input) input.value = '';
  if (clearBtn) clearBtn.style.display = 'none';
  if (suggestionsEl) suggestionsEl.style.display = 'none';
  
  smartSearch('');
}

function openAlbumFromSearch(albumId) {
  const album = albums.find(a => a.id === albumId);
  if (album) {
    goHome();
    setTimeout(() => {
      openAlbum(album);
    }, 300);
  }
}

// Visualizer functions
function toggleVisualizer() {
  const visualizer = document.getElementById('audioVisualizer');
  const audio = document.getElementById('audio');
  
  if (!visualizer) return;
  
  if (visualizer.style.display === 'none' || !visualizer.style.display) {
    visualizer.style.display = 'block';
    if (!audioVisualizer) {
      audioVisualizer = new AudioVisualizer();
    }
    if (audio && !audio.paused) {
      audioVisualizer.init(audio);
    }
    showToast('🎵 Visualizador activado', 'info');
  } else {
    visualizer.style.display = 'none';
    if (audioVisualizer) {
      audioVisualizer.stop();
    }
    showToast('🎵 Visualizador desactivado', 'info');
  }
}

function changeVisualizerType(type) {
  if (audioVisualizer) {
    audioVisualizer.changeType(type);
    showToast(`🎵 Visualizador: ${type}`, 'info');
  }
}

// Immersive Mode
function enterImmersiveMode() {
  const overlay = document.getElementById('immersiveMode');
  const artwork = document.getElementById('immersiveArtwork');
  const title = document.querySelector('.immersive-title');
  const artist = document.querySelector('.immersive-artist');
  const background = document.querySelector('.immersive-background');
  
  if (!overlay) return;
  
  const currentSong = queue[qIndex];
  if (!currentSong) {
    showToast('⚠️ No hay canción reproduciéndose', 'error');
    return;
  }
  
  if (artwork) artwork.src = currentSong.cover_url || '';
  if (title) title.textContent = currentSong.title || '—';
  if (artist) artist.textContent = currentSong.album_title || '—';
  if (background && currentSong.cover_url) {
    background.style.backgroundImage = `url(${currentSong.cover_url})`;
  }
  
  overlay.style.display = 'flex';
  
  // Habilitar gestos
  if (!gestureController) {
    gestureController = new GestureController();
    gestureController.init();
  }
  gestureController.enable();
  
  showToast('🎭 Modo inmersivo activado', 'success');
}

function exitImmersive() {
  const overlay = document.getElementById('immersiveMode');
  if (overlay) {
    overlay.style.display = 'none';
  }
  
  if (gestureController) {
    gestureController.disable();
  }
  
  showToast('🎭 Modo inmersivo desactivado', 'info');
}

// Skeleton loading
function showSkeletonLoading() {
  const albumsGrid = document.getElementById("albumsGrid");
  if (!albumsGrid) return;
  
  albumsGrid.innerHTML = '';
  
  const skeletonCount = isMobile() ? 6 : 8;
  for (let i = 0; i < skeletonCount; i++) {
    const skeleton = document.createElement('div');
    skeleton.className = 'album-card';
    skeleton.innerHTML = `
      <div class="album-skeleton"></div>
      <div class="album-title" style="background:#333;color:transparent;border-radius:4px;">Loading...</div>
      <div class="album-meta" style="background:#333;color:transparent;border-radius:4px;">Loading...</div>
    `;
    albumsGrid.appendChild(skeleton);
  }
}

// Utility Functions
function setActiveNav(activeButton) {
  document.querySelectorAll('#bottomBar button').forEach(btn => btn.classList.remove('active'));
  const targetBtn = document.getElementById(`btn-${activeButton}`);
  if (targetBtn) targetBtn.classList.add('active');
}

function showError(msg) {
  showToast(`❌ ${msg}`, 'error');
}

function showSuccess(msg) {
  showToast(`✅ ${msg}`, 'success');
}

function updateAdminSelects() {
  const adminSel = document.getElementById("albumSelect");
  const delSel = document.getElementById("deleteAlbumSelect");
  const editSel = document.getElementById("editInfoAlbumSelect");

  if (adminSel) {
    adminSel.innerHTML = '<option value="">Selecciona un álbum</option>';
    albums.forEach(album => {
      const option = document.createElement("option");
      option.value = album.id;
      option.textContent = `${album.title} - ${album.artist || 'Sin artista'}`;
      adminSel.appendChild(option);
    });
  }
  
  if (delSel) {
    delSel.innerHTML = '<option value="">Selecciona un álbum</option>';
    albums.forEach(album => {
      const option = document.createElement("option");
      option.value = album.id;
      option.textContent = `${album.title} - ${album.artist || 'Sin artista'}`;
      delSel.appendChild(option);
    });
  }
  
  if (editSel) {
    editSel.innerHTML = '<option value="">Selecciona un álbum para editar</option>';
    albums.forEach(album => {
      const option = document.createElement("option");
      option.value = album.id;
      option.textContent = `${album.title} - ${album.artist || 'Sin artista'}`;
      editSel.appendChild(option);
    });
  }
}

// Función para reproducir desde búsqueda
function playTrackFromSearch(songId) {
  const song = flatSongs.find(s => s.id === songId);
  if (!song) {
    showError('Canción no encontrada');
    return;
  }
  
  queue = [song];
  qIndex = 0;
  playTrack(song);
}

// Función para crear playlist
async function createNewPlaylist() {
  if (!isLoggedIn) {
    showError('Debes iniciar sesión para crear playlists');
    showLogin();
    return;
  }
  
  const name = prompt('🎵 Nombre de la nueva playlist:');
  if (!name || name.trim() === '') {
    showError('Nombre inválido');
    return;
  }
  
  try {
    const { data, error } = await sb.from('playlists').insert([{
      name: name.trim(),
      user_id: currentUser.id,
      is_public: false,
      description: null
    }]);
    
    if (error) {
      showError('Error creando playlist: ' + error.message);
      return;
    }
    
    showSuccess('Playlist creada exitosamente');
    await loadPlaylists();
  } catch (e) {
    console.error('Error en createNewPlaylist:', e);
    showError('Error creando playlist');
  }
}

// Función para cargar playlists
async function loadPlaylists() {
  if (!isLoggedIn) return;
  
  try {
    const { data, error } = await sb
      .from('playlists')
      .select('*')
      .eq('user_id', currentUser.id)
      .order('created_at', {ascending: false});
    
    if (error) {
      showError('Error cargando playlists: ' + error.message);
      return;
    }
    
    userPlaylists = data || [];
    
    const grid = document.getElementById('playlistsGrid');
    const emptyPlaylists = document.getElementById('emptyPlaylists');
    
    if (!grid) return;
    
    grid.innerHTML = '';
    
    if (!userPlaylists.length) {
      if (emptyPlaylists) emptyPlaylists.style.display = 'block';
      return;
    } else {
      if (emptyPlaylists) emptyPlaylists.style.display = 'none';
    }
    
    userPlaylists.forEach((playlist, index) => {
      const div = document.createElement('div');
      div.className = 'playlist-card slide-up';
      div.style.animationDelay = `${index * 0.1}s`;
      div.innerHTML = `
        <div class="playlist-cover">🎵</div>
        <div class="playlist-title">${playlist.name}</div>
        <div class="playlist-meta">Playlist • ${new Date(playlist.created_at).toLocaleDateString()}</div>
      `;
      div.onclick = () => openPlaylistDetails(playlist);
      grid.appendChild(div);
    });
  } catch (e) {
    console.error('Error en loadPlaylists:', e);
    showError('Error cargando playlists');
  }
}

function openPlaylistDetails(playlist) {
  showToast(`🎵 Playlist: ${playlist.name} - Funcionalidad próximamente`, 'info');
}

// NUEVA FUNCIÓN: Editar información completa del álbum
async function editAlbumInfo() {
  if (!isAdmin) return alert("❌ No autorizado");
  const albumId = document.getElementById("editInfoAlbumSelect").value;
  const newTitle = document.getElementById("editAlbumTitle").value.trim();
  const newArtist = document.getElementById("editAlbumArtist").value.trim();
  
  if (!albumId) {
    showError("Selecciona un álbum para editar");
    return;
  }
  
  if (!newTitle && !newArtist) {
    showError("Ingresa al menos un título o artista nuevo");
    return;
  }
  
  try {
    const updateData = {};
    if (newTitle) updateData.title = newTitle;
    if (newArtist) updateData.artist = newArtist;
    
    const { error } = await sb.from("albums").update(updateData).eq("id", albumId);
    if (error) {
      showError("Error actualizando álbum: " + error.message);
      return;
    }
    
    showSuccess("Información del álbum actualizada correctamente");
    document.getElementById("editAlbumTitle").value = "";
    document.getElementById("editAlbumArtist").value = "";
    await refreshCatalog();
  } catch (error) {
    console.error('Error en editAlbumInfo:', error);
    showError('Error actualizando información del álbum');
  }
}

// NUEVA FUNCIÓN: Editar solo portada del álbum
async function editAlbumCoverOnly() {
  if (!isAdmin) return alert("❌ No autorizado");
  const albumId = document.getElementById("editInfoAlbumSelect").value;
  const file = document.getElementById("editAlbumCover").files[0];
  
  if (!albumId) {
    showError("Selecciona un álbum");
    return;
  }
  
  if (!file) {
    showError("Selecciona una nueva imagen de portada");
    return;
  }
  
  try {
    const path = `${Date.now()}-${safeName(file.name)}`;
    const { error: upErr } = await sb.storage.from("covers").upload(path, file);
    if (upErr) {
      showError("Error subiendo portada: " + upErr.message);
      return;
    }
    
    const { data: pub } = sb.storage.from("covers").getPublicUrl(path);
    const cover_url = pub.publicUrl;
    
    const { error } = await sb.from("albums").update({ cover_url }).eq("id", albumId);
    if (error) {
      showError("Error actualizando portada: " + error.message);
      return;
    }
    
    showSuccess("Portada del álbum actualizada correctamente");
    document.getElementById("editAlbumCover").value = "";
    await refreshCatalog();
  } catch (error) {
    console.error('Error en editAlbumCoverOnly:', error);
    showError('Error actualizando portada');
  }
}

// Data Loading Functions optimizado para móviles
async function refreshCatalog() {
  console.log('🔄 Cargando catálogo...');
  showSkeletonLoading();
  
  try {
    // Limitar carga inicial en móviles
    const limit = isMobile() ? 20 : 50;
    const { data: alb, error: e1 } = await sb
      .from("albums")
      .select("*")
      .order("created_at", {ascending: false})
      .limit(limit);
    
    if (e1) { 
      console.error('❌ Error cargando álbumes:', e1); 
      showError('Error cargando álbumes: ' + e1.message); 
      return; 
    }
    
    albums = alb || [];
    console.log('✅ Álbumes cargados:', albums.length);
    
    const emptyAlbums = document.getElementById("emptyAlbums");
    if (emptyAlbums) {
      emptyAlbums.style.display = albums.length ? "none" : "block";
    }
    
    songsByAlbum = {};
    flatSongs = [];
    
    // Cargar canciones por lotes en móvil
    for (const album of albums) {
      try {
        const { data: ss, error: e2 } = await sb
          .from("songs")
          .select("*")
          .eq("album_id", album.id)
          .order("created_at", {ascending: true});
        
        if (e2) { 
          console.error('❌ Error cargando canciones para álbum:', album.title, e2); 
          continue; 
        }
        
        songsByAlbum[album.id] = ss || [];
        
        for (const song of (ss || [])) {
          flatSongs.push({
            ...song, 
            album_title: album.title, 
            cover_url: album.cover_url
          });
        }
      } catch (error) {
        console.error('❌ Error procesando álbum:', album.title, error);
      }
    }
    
    renderAlbums();
    updateAdminSelects();
    showToast('Catálogo cargado', 'success');
    
  } catch (error) {
    console.error('❌ Error en refreshCatalog:', error);
    showError('Error cargando catálogo');
  }
}

function renderAlbums(list = albums) {
  console.log('🎨 Renderizando álbumes:', list.length);
  
  const albumsGrid = document.getElementById("albumsGrid");
  const emptyAlbums = document.getElementById("emptyAlbums");
  
  if (!albumsGrid) return;
  
  albumsGrid.innerHTML = "";
  
  if (list.length === 0) {
    if (emptyAlbums) emptyAlbums.style.display = 'block';
    return;
  }
  
  if (emptyAlbums) emptyAlbums.style.display = 'none';
  
  // Renderizado por lotes para mejor performance en móvil
  if (isMobile()) {
    const batchSize = 6;
    let currentIndex = 0;
    
    function renderBatch() {
      const batch = list.slice(currentIndex, currentIndex + batchSize);
      
      batch.forEach((album, index) => {
        const count = (songsByAlbum[album.id]?.length || 0);
        const card = document.createElement("div");
        card.className = "album-card slide-up";
        card.style.animationDelay = `${(currentIndex + index) * 0.05}s`;
        
        card.innerHTML = `
          <img class="album-cover" src="${album.cover_url || ''}" alt="${album.title}" 
               onerror="this.style.background='var(--panel)'; this.innerHTML='🎵'; this.style.fontSize='1.5rem';"
               loading="lazy">
          <div class="album-title">${album.title}</div>
          <div class="album-meta">${album.artist || 'Sin artista'} • ${count}</div>
        `;
        
        card.onclick = () => openAlbum(album);
        albumsGrid.appendChild(card);
      });
      
      currentIndex += batchSize;
      
      if (currentIndex < list.length) {
        setTimeout(renderBatch, 50); // Pequeña pausa entre lotes
      }
    }
    
    renderBatch();
  } else {
    // Renderizado normal para desktop
    list.forEach((album, index) => {
      const count = (songsByAlbum[album.id]?.length || 0);
      const card = document.createElement("div");
      card.className = "album-card slide-up";
      card.style.animationDelay = `${index * 0.1}s`;
      
      card.innerHTML = `
        <img class="album-cover" src="${album.cover_url || ''}" alt="${album.title}" onerror="this.style.background='var(--panel)'; this.innerHTML='🎵';">
        <div class="album-title">${album.title}</div>
        <div class="album-meta">${album.artist || 'Sin artista'} • ${count} ${count === 1 ? 'canción' : 'canciones'}</div>
      `;
      
      card.onclick = () => openAlbum(album);
      albumsGrid.appendChild(card);
    });
  }
}

// ===== FUNCIÓN DE ÁLBUM CON EXPANSIÓN OPTIMIZADA PARA MÓVIL =====
function openAlbum(album) {
  console.log('🎵 Abriendo álbum:', album.title);
  currentAlbum = album;
  const songs = songsByAlbum[album.id] || [];
  
  // Encontrar la tarjeta del álbum para expandir ahí mismo
  const albumsGrid = document.getElementById("albumsGrid");
  const albumCards = albumsGrid.querySelectorAll('.album-card');
  
  let targetCard = null;
  albumCards.forEach(card => {
    const title = card.querySelector('.album-title').textContent;
    if (title === album.title) {
      targetCard = card;
    }
  });
  
  if (!targetCard) return;
  
  // Remover expansiones previas
  const existingExpansion = albumsGrid.querySelector('.album-expansion');
  if (existingExpansion) {
    existingExpansion.remove();
  }
  
  // Crear la expansión con las canciones
  const expansion = document.createElement('div');
  expansion.className = 'album-expansion slide-up';
  
  // Header optimizado según dispositivo
  const headerHTML = isMobile() ? `
    <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 16px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 12px;">
      <img src="${album.cover_url || ''}" alt="${album.title}" 
           style="width: 80px; height: 80px; border-radius: 12px; object-fit: cover;"
           onerror="this.style.background='var(--panel)'; this.innerHTML='🎵'; this.style.display='flex'; this.style.alignItems='center'; this.style.justifyContent='center'; this.style.fontSize='2rem';">
      <div style="flex: 1; min-width: 0;">
        <h3 style="margin: 0 0 4px 0; font-size: 18px; font-weight: 800; color: var(--brand);">${album.title}</h3>
        <p style="margin: 0 0 8px 0; color: var(--muted); font-size: 12px;">${album.artist || 'Sin artista'} • ${songs.length} canciones</p>
        <div style="display: flex; gap: 6px; flex-wrap: wrap;">
          <button class="btn small" onclick="playAllFromAlbum('${album.id}')" style="font-size: 9px; padding: 4px 8px;">▶ Todo</button>
          <button class="btn small ghost" onclick="closeAlbumExpansion()" style="font-size: 9px; padding: 4px 8px;">✕</button>
        </div>
      </div>
    </div>
  ` : `
    <div style="display: flex; gap: 20px; align-items: center; margin-bottom: 24px; padding: 20px; background: rgba(255,255,255,0.03); border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);">
      <img src="${album.cover_url || ''}" alt="${album.title}" 
           style="width: 120px; height: 120px; border-radius: 16px; object-fit: cover; box-shadow: 0 8px 25px rgba(0,0,0,0.4);"
           onerror="this.style.background='var(--panel)'; this.innerHTML='🎵'; this.style.display='flex'; this.style.alignItems='center'; this.style.justifyContent='center'; this.style.fontSize='3rem';">
      <div style="flex: 1;">
        <h2 style="margin: 0 0 8px 0; font-size: 32px; font-weight: 900; background: linear-gradient(135deg, var(--brand), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">${album.title}</h2>
        <p style="margin: 0 0 12px 0; color: var(--muted); font-size: 18px; font-weight: 500;">${album.artist || 'Sin artista'} • ${songs.length} ${songs.length === 1 ? 'canción' : 'canciones'}</p>
        <div style="display: flex; gap: 12px; margin-top: 16px; flex-wrap: wrap;">
          <button class="btn small" onclick="playAllFromAlbum('${album.id}')" style="background: linear-gradient(135deg, var(--brand), var(--brand-hover));">▶ Reproducir todo</button>
          <button class="btn small" onclick="toggleVisualizer()" style="background: linear-gradient(135deg, var(--accent), #e55722);">🎵 Visualizador</button>
          <button class="btn small ghost" onclick="closeAlbumExpansion()" style="background: rgba(255,255,255,0.1);">✕ Cerrar</button>
        </div>
      </div>
    </div>
  `;
  
  // Lista de canciones optimizada
  let songsHTML = '';
  if (!songs.length) {
    songsHTML = isMobile() ? 
      `<div style="text-align: center; padding: 30px 20px; color: var(--muted);"><div style="font-size: 48px; margin-bottom: 12px;">🎵</div><div style="font-size: 14px;">Sin canciones</div></div>` :
      `<div style="text-align: center; padding: 60px 40px; color: var(--muted);"><div style="font-size: 64px; margin-bottom: 20px;">🎵</div><div style="font-size: 18px; font-weight: 500;">Este álbum no tiene canciones todavía</div></div>`;
  } else {
    songsHTML = '<div style="display: grid; gap: 4px;">';
    const maxSongs = isMobile() ? 10 : songs.length; // Limitar en móvil
    
    songs.slice(0, maxSongs).forEach((song, idx) => {
      const itemStyle = isMobile() ? 
        `padding: 8px; font-size: 12px; cursor: pointer;` :
        `animation-delay: ${idx * 0.05}s; cursor: pointer; padding: 16px; border-radius: 12px; transition: all 0.3s ease; border: 1px solid rgba(255,255,255,0.05);`;
      
      songsHTML += `
        <div class="song-plain-item" style="${itemStyle}" 
             onclick="playAlbumSong('${album.id}', ${idx})"
             ${!isMobile() ? `onmouseover="this.style.background='rgba(29, 185, 84, 0.1)'; this.style.transform='translateX(8px)'; this.style.borderColor='rgba(29, 185, 84, 0.3)';"
             onmouseout="this.style.background='transparent'; this.style.transform='translateX(0)'; this.style.borderColor='rgba(255,255,255,0.05)';"` : ''}>
          <div style="display: flex; align-items: center; gap: ${isMobile() ? '8px' : '16px'};">
            <div style="min-width: ${isMobile() ? '20px' : '32px'}; text-align: center; color: var(--muted); font-weight: 600; font-size: ${isMobile() ? '11px' : '14px'};">${idx + 1}</div>
            <div style="flex: 1; font-weight: 600; font-size: ${isMobile() ? '13px' : '16px'}; ${isMobile() ? 'overflow: hidden; text-overflow: ellipsis; white-space: nowrap;' : ''}">${song.title}</div>
            <div style="display: flex; gap: ${isMobile() ? '6px' : '8px'}; align-items: center;">
              <button class="favorite-btn" onclick="event.stopPropagation(); toggleFavorite('${song.id}')" title="Favorito" style="background: none; border: none; color: var(--muted); font-size: ${isMobile() ? '14px' : '18px'}; padding: ${isMobile() ? '4px' : '8px'}; border-radius: 50%; transition: all 0.3s ease; cursor: pointer;">🤍</button>
              ${!isMobile() ? `<button class="download-btn" onclick="event.stopPropagation(); downloadSong('${song.id}')" title="Descargar" style="background: linear-gradient(135deg, var(--success), #2e7d32); border: none; color: white; padding: 8px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">⬇</button>` : ''}
            </div>
          </div>
        </div>
      `;
    });
    
    if (isMobile() && songs.length > maxSongs) {
      songsHTML += `<div style="text-align: center; padding: 8px; color: var(--muted); font-size: 11px;">+${songs.length - maxSongs} canciones más</div>`;
    }
    songsHTML += '</div>';
  }
  
  expansion.innerHTML = headerHTML + songsHTML;
  
  // Insertar la expansión después de la tarjeta del álbum
  targetCard.parentNode.insertBefore(expansion, targetCard.nextSibling);
  
  // Scroll suave hacia la expansión
  setTimeout(() => {
    expansion.scrollIntoView({behavior: 'smooth', block: isMobile() ? 'nearest' : 'center'});
  }, 100);
  
  // Mostrar botón de modo inmersivo si hay canciones
  const immersiveBtn = document.getElementById('immersiveBtn');
  if (immersiveBtn && songs.length > 0) {
    immersiveBtn.style.display = 'inline-block';
  }
}

// Función para reproducir una canción específica del álbum
function playAlbumSong(albumId, songIndex) {
  const album = albums.find(a => a.id === albumId);
  if (!album) return;
  
  const songs = songsByAlbum[albumId] || [];
  if (!songs[songIndex]) return;
  
  queue = songs.map(s => ({
    ...s, 
    album_title: album.title, 
    cover_url: album.cover_url
  }));
  qIndex = songIndex;
  playTrack(queue[qIndex]);
}

// Función para reproducir todo el álbum
function playAllFromAlbum(albumId) {
  const album = albums.find(a => a.id === albumId);
  if (!album) return;
  
  const songs = songsByAlbum[albumId] || [];
  if (!songs.length) {
    showError('Este álbum no tiene canciones');
    return;
  }
  
  queue = songs.map(s => ({
    ...s, 
    album_title: album.title, 
    cover_url: album.cover_url
  }));
  qIndex = 0;
  playTrack(queue[0]);
  showSuccess(`▶ Reproduciendo "${album.title}" completo`);
}

// Función para cerrar la expansión del álbum
function closeAlbumExpansion() {
  const expansion = document.querySelector('.album-expansion');
  if (expansion) {
    expansion.classList.add('slide-down');
    setTimeout(() => {
      expansion.remove();
    }, 300);
  }
  currentAlbum = null;
  
  const immersiveBtn = document.getElementById('immersiveBtn');
  if (immersiveBtn) {
    immersiveBtn.style.display = 'none';
  }
}

function closeAlbumView() {
  const albumView = document.getElementById("albumView");
  if (albumView) albumView.style.display = "none";
  currentAlbum = null;
}

// Player Functions
function startQueueAt(idx) { 
  if (!queue.length) return; 
  qIndex = idx; 
  playTrack(queue[qIndex]); 
}

function playTrack(song) {
  console.log('🎵 Reproduciendo:', song.title);
  
  if (!song.song_url) {
    showError(`Error: No hay URL de audio para "${song.title}"`);
    return;
  }
  
  const audioEl = document.getElementById("audio");
  const npTitle = document.getElementById("npTitle");
  const npAlbum = document.getElementById("npAlbum");
  const npCover = document.getElementById("npCover");
  const npBigTitle = document.getElementById("npBigTitle");
  const npBigAlbum = document.getElementById("npBigAlbum");
  const npBigCover = document.getElementById("npBigCover");
  const playerElement = document.getElementById("player");
  const playBtn = document.getElementById("playBtn");
  const playBtnBig = document.getElementById("playBtnBig");
  
  audioEl.pause();
  audioEl.currentTime = 0;
  audioEl.src = song.song_url;
  
  if (npTitle) npTitle.textContent = song.title;
  if (npAlbum) npAlbum.textContent = song.album_title || "—";
  if (npCover) npCover.src = song.cover_url || "";
  if (npBigTitle) npBigTitle.textContent = song.title;
  if (npBigAlbum) npBigAlbum.textContent = song.album_title || "—";
  if (npBigCover) npBigCover.src = song.cover_url || "";
  
  if (playerElement) {
    playerElement.classList.add('show');
    document.body.style.paddingBottom = isMobile() ? '95px' : '125px';
  }
  
  // Inicializar visualizador si está activo
  if (audioVisualizer && document.getElementById('audioVisualizer').style.display !== 'none') {
    audioVisualizer.init(audioEl);
  }
  
  // Dibujar waveform
  drawWaveform();
  
  audioEl.play().then(() => {
    if (playBtn) playBtn.textContent = "⏸";
    if (playBtnBig) playBtnBig.textContent = "⏸";
    console.log('✅ Reproducción exitosa:', song.title);
    
    // Mostrar botón de modo inmersivo
    const immersiveBtn = document.getElementById('immersiveBtn');
    if (immersiveBtn) {
      immersiveBtn.style.display = 'inline-block';
    }
  }).catch(error => {
    console.error('❌ Error reproduciendo:', error);
    showError(`Error reproduciendo "${song.title}"`);
  });
}

function togglePlay() {
  const audioEl = document.getElementById("audio");
  const playBtn = document.getElementById("playBtn");
  const playBtnBig = document.getElementById("playBtnBig");
  
  if (audioEl.paused) { 
    audioEl.play().then(() => {
      if (playBtn) playBtn.textContent = "⏸";
      if (playBtnBig) playBtnBig.textContent = "⏸";
    });
  } else { 
    audioEl.pause(); 
    if (playBtn) playBtn.textContent = "▶";
    if (playBtnBig) playBtnBig.textContent = "▶";
  }
}

function nextTrack() { 
  if (!queue.length) return; 
  qIndex = (qIndex + 1) % queue.length; 
  playTrack(queue[qIndex]); 
}

function prevTrack() { 
  if (!queue.length) return; 
  qIndex = (qIndex - 1 + queue.length) % queue.length; 
  playTrack(queue[qIndex]); 
}

function setVolume(v) { 
  const audioEl = document.getElementById("audio");
  audioEl.volume = v; 
}

function seekAudio(percent) { 
  const audioEl = document.getElementById("audio");
  if (!audioEl.duration || isNaN(audioEl.duration)) return; 
  audioEl.currentTime = (percent / 100) * audioEl.duration; 
}

function fmt(t) { 
  if (!isFinite(t)) return "0:00"; 
  const m = Math.floor(t / 60);
  const s = Math.floor(t % 60); 
  return `${m}:${s.toString().padStart(2, "0")}`; 
}

function openNowPlaying() {
  const npOverlay = document.getElementById("npOverlay");
  if (npOverlay) npOverlay.style.display = "flex";
}

function closeNowPlaying() { 
  const npOverlay = document.getElementById("npOverlay");
  if (npOverlay) npOverlay.style.display = "none"; 
}

// Navigation Functions Premium
function hideAllViews() {
  const views = ['homeContent', 'searchView', 'favoritesView', 'downloadsView', 'playlistsView', 'albumView', 'playlistView'];
  views.forEach(viewId => {
    const view = document.getElementById(viewId);
    if (view) view.style.display = 'none';
  });
  
  const adminPanel = document.getElementById('adminPanel');
  if (adminPanel && isAdmin) adminPanel.style.display = 'block';
  else if (adminPanel) adminPanel.style.display = 'none';
}

function goHome() {
  console.log('🏠 Volviendo al inicio');
  hideAllViews();
  document.getElementById('homeContent').style.display = 'block';
  setActiveNav('home');
  window.scrollTo({top: 0, behavior: 'smooth'});
  
  // Cerrar expansiones
  closeAlbumExpansion();
}

function showSearch() {
  console.log('🔍 Mostrando búsqueda');
  hideAllViews();
  document.getElementById('searchView').style.display = 'block';
  const noResults = document.getElementById('noSearchResults');
  if (noResults) noResults.style.display = 'block';
  setActiveNav('search');
  
  setTimeout(() => {
    const searchInput = document.getElementById('smartSearchInput');
    if (searchInput) searchInput.focus();
  }, 100);
}

function closeSearchView() {
  console.log('Cerrando búsqueda');
  goHome();
}

function showPlaylists() {
  console.log('📱 Mostrando playlists');
  if (!isLoggedIn) {
    showLogin();
    showError('Inicia sesión para gestionar playlists');
    return;
  }
  hideAllViews();
  document.getElementById('playlistsView').style.display = 'block';
  loadPlaylists();
  setActiveNav('playlists');
}

function closePlaylistsView() {
  console.log('Cerrando playlists');
  goHome();
}

function showAccount() {
  if(isAdmin) {
    alert(`👑 Cuenta Admin: ${ADMIN_EMAIL}\n\n✨ Funcionalidades:\n• Crear álbumes\n• Subir canciones\n• Editar información completa\n• Eliminar álbumes\n• Gestionar playlists\n• Panel de administración avanzado\n• Modo inmersivo\n• Visualizador de audio\n• Búsqueda inteligente\n• Gestión completa del catálogo`);
  } else if (isLoggedIn) {
    alert(`👤 Información de Cuenta\n\n📧 Usuario: ${currentUser.email}\n\n🎵 Funcionalidades:\n• Crear playlists personalizadas\n• Gestionar tu música favorita\n• Favoritos y descargas\n• Experiencia personalizada\n• Modo inmersivo\n• Visualizador de audio\n• Búsqueda avanzada`);
  } else {
    showLogin();
  }
  setActiveNav('account');
}

// Auth Functions Premium
function showLogin() { 
  const modal = document.getElementById("loginModal");
  if (modal) {
    modal.style.display = "block";
    modal.classList.add('fade-in');
  }
}

function hideLogin() { 
  const modal = document.getElementById("loginModal");
  if (modal) {
    modal.classList.add('slide-down');
    setTimeout(() => {
      modal.style.display = "none";
      modal.classList.remove('slide-down', 'fade-in');
    }, 300);
  }
}

async function login() {
  const emailEl = document.getElementById("email");
  const passwordEl = document.getElementById("password");
  
  if (!emailEl || !passwordEl) {
    showError('Error: elementos de login no encontrados');
    return;
  }

  const email = emailEl.value.trim();
  const password = passwordEl.value;
  
  if (!email || !password) {
    showError('Ingresa email y contraseña');
    return;
  }
  
  try {
    let result = await sb.auth.signInWithPassword({ email, password });
    
    if (result.error) {
      result = await sb.auth.signUp({ email, password });
      if (result.error) {
        showError("Error: " + result.error.message);
        return;
      }
      showSuccess('Cuenta creada! Revisa tu email si es necesario.');
    } else {
      showSuccess('Bienvenido de vuelta!');
    }
    
    currentUser = result.data.user;
    isLoggedIn = !!currentUser;
    isAdmin = (email.toLowerCase() === ADMIN_EMAIL.toLowerCase());
    
    const btnLogin = document.getElementById("btn-login");
    const btnLogout = document.getElementById("btn-logout");
    const adminPanel = document.getElementById("adminPanel");
    const adminTag = document.getElementById("adminTag");
    const userTag = document.getElementById("userTag");
    
    if (btnLogin) btnLogin.style.display = "none";
    if (btnLogout) btnLogout.style.display = "inline-flex";
    
    if (isAdmin && adminPanel && adminTag) {
      adminPanel.style.display = "block";
      adminTag.style.display = "inline-block";
      showSuccess('Modo Administrador activado');
    }
    
    if (isLoggedIn && userTag) {
      userTag.style.display = "inline-block";
    }
    
    hideLogin();
    await refreshCatalog();
    if (isLoggedIn) await loadPlaylists();
    
  } catch (error) {
    console.error('❌ Error en login:', error);
    showError('Error de conexión');
  }
}

async function logout() {
  try {
    await sb.auth.signOut();
    currentUser = null;
    isLoggedIn = false;
    isAdmin = false;
    
    const adminPanel = document.getElementById("adminPanel");
    const adminTag = document.getElementById("adminTag");
    const userTag = document.getElementById("userTag");
    const btnLogin = document.getElementById("btn-login");
    const btnLogout = document.getElementById("btn-logout");
    
    if (adminPanel) adminPanel.style.display = "none";
    if (adminTag) adminTag.style.display = "none";
    if (userTag) userTag.style.display = "none";
    if (btnLogin) btnLogin.style.display = "inline-flex";
    if (btnLogout) btnLogout.style.display = "none";
    
    showSuccess('Sesión cerrada correctamente');
    goHome();
    
  } catch (error) {
    console.error('❌ Error en logout:', error);
  }
}

// Admin Functions Premium
function safeName(name) { 
  return name.replace(/[^a-zA-Z0-9_\-.]+/g, "-"); 
}

async function uploadAlbum() {
  if (!isAdmin) return alert("❌ No autorizado");
  const title = document.getElementById("albumTitle").value.trim();
  const artist = document.getElementById("albumArtist").value.trim();
  const file = document.getElementById("albumCover").files[0];
  
  if (!title || !artist || !file) return alert("📝 Completa título, artista y portada");
  
  try {
    showSuccess('Subiendo álbum...');
    const path = `${Date.now()}-${safeName(file.name)}`;
    const { error: upErr } = await sb.storage.from("covers").upload(path, file);
    if (upErr) return alert("❌ Error subiendo portada: " + upErr.message);
    
    const { data: pub } = sb.storage.from("covers").getPublicUrl(path);
    const cover_url = pub.publicUrl;
    
    const { error: insErr } = await sb.from("albums").insert([{ 
      title, 
      artist, 
      cover_url 
    }]);
    if (insErr) return alert("❌ Error guardando álbum: " + insErr.message);
    
    document.getElementById("albumTitle").value = "";
    document.getElementById("albumArtist").value = "";
    document.getElementById("albumCover").value = "";
    showSuccess("Álbum creado exitosamente");
    await refreshCatalog();
  } catch (error) {
    console.error('❌ Error en uploadAlbum:', error);
    showError('Error creando álbum');
  }
}

async function uploadSong() {
  if (!isAdmin) return alert("❌ No autorizado");
  const albumId = document.getElementById("albumSelect").value;
  const titleInput = document.getElementById("songTitle").value.trim();
  const files = document.getElementById("songFiles").files;
  if (!albumId || files.length === 0) return alert("📝 Selecciona un álbum y al menos un archivo de audio");
  
  try {
    showSuccess('Subiendo canciones...');
    let ok = 0, fail = 0;
    for (const file of files) {
      if (!file.type.startsWith('audio/')) {
        fail++;
        continue;
      }
      
      const path = `${Date.now()}-${safeName(file.name)}`;
      const { error: upErr } = await sb.storage.from("songs").upload(path, file);
      if (upErr) { 
        fail++; 
        continue; 
      }
      
      const { data: pub } = sb.storage.from("songs").getPublicUrl(path);
      const song_url = pub.publicUrl;
      
      const title = (files.length === 1 && titleInput) ? titleInput : file.name.replace(/\.[^/.]+$/, "");
      const { error: insErr } = await sb.from("songs").insert([{ album_id: albumId, title, song_url }]);
      if (insErr) { 
        fail++; 
      } else { 
        ok++; 
      }
    }
    
    document.getElementById("songTitle").value = "";
    document.getElementById("songFiles").value = "";
    showSuccess(`Subida completa: ${ok} exitosas, ${fail} error(es)`);
    await refreshCatalog();
  } catch (error) {
    console.error('❌ Error en uploadSong:', error);
    showError('Error subiendo canciones');
  }
}

async function deleteAlbum() {
  if (!isAdmin) return alert("❌ No autorizado");
  const albumId = document.getElementById("deleteAlbumSelect").value;
  if (!albumId) return alert("📝 Selecciona un álbum");
  if (!confirm("⚠️ ¿Eliminar álbum y todas sus canciones? Esta acción no se puede deshacer.")) return;
  
  try {
    const { error: delSongsErr } = await sb.from("songs").delete().eq("album_id", albumId);
    if (delSongsErr) { alert("❌ Error borrando canciones: " + delSongsErr.message); return; }
    
    const { error: delAlbErr } = await sb.from("albums").delete().eq("id", albumId);
    if (delAlbErr) { alert("❌ Error borrando álbum: " + delAlbErr.message); return; }
    
    showSuccess("Álbum eliminado exitosamente");
    if (currentAlbum?.id === albumId) closeAlbumView();
    await refreshCatalog();
  } catch (error) {
    console.error('❌ Error en deleteAlbum:', error);
    showError('Error eliminando álbum');
  }
}

// Event listener premium para autocompletar información al editar
document.addEventListener("DOMContentLoaded", () => {
  const editSel = document.getElementById("editInfoAlbumSelect");
  if (editSel) {
    editSel.addEventListener("change", function() {
      const albumId = this.value;
      const album = albums.find(a => a.id === albumId);
      const editTitleInput = document.getElementById("editAlbumTitle");
      const editArtistInput = document.getElementById("editAlbumArtist");
      
      if (editTitleInput && editArtistInput && album) {
        editTitleInput.value = album.title || "";
        editArtistInput.value = album.artist || "";
        editTitleInput.placeholder = `📝 Actual: ${album.title}`;
        editArtistInput.placeholder = `🎤 Actual: ${album.artist || 'Sin artista'}`;
      }
    });
  }
  
  // Inicializar optimizaciones móviles
  optimizeForMobile();
  adjustMobileGrid();
  
  if (isMobile()) {
    console.log('📱 KLMZ MUSIC optimizado para móviles');
    showToast('Optimizado para móviles', 'success');
  }
});

// Event Listeners Premium
document.getElementById("audio").addEventListener("timeupdate", () => {
  const audioEl = document.getElementById("audio");
  const seekEl = document.getElementById("seek");
  const curTime = document.getElementById("curTime");
  const durTime = document.getElementById("durTime");
  const seekBig = document.getElementById("seekBig");
  const curTimeBig = document.getElementById("curTimeBig");
  const durTimeBig = document.getElementById("durTimeBig");
  const waveformProgress = document.getElementById("waveformProgress");
  
  if (!audioEl.duration) return;
  const p = (audioEl.currentTime / audioEl.duration) * 100;
  
  if (seekEl) seekEl.value = p;
  if (curTime) curTime.textContent = fmt(audioEl.currentTime);
  if (durTime) durTime.textContent = fmt(audioEl.duration);
  if (seekBig) seekBig.value = p;
  if (curTimeBig) curTimeBig.textContent = fmt(audioEl.currentTime);
  if (durTimeBig) durTimeBig.textContent = fmt(audioEl.duration);
  if (waveformProgress) waveformProgress.style.width = `${p}%`;
});

document.getElementById("audio").addEventListener("ended", () => nextTrack());

// Event listeners para optimizaciones móviles
window.addEventListener('resize', debounce(() => {
  adjustMobileGrid();
  optimizeForMobile();
  if (audioVisualizer) {
    audioVisualizer.resize();
  }
  drawWaveform();
}, 150));

window.addEventListener('orientationchange', debounce(() => {
  setTimeout(() => {
    adjustMobileGrid();
    optimizeForMobile();
  }, 100);
}, 150));

// Placeholder functions premium
function toggleFavorite(songId) { 
  console.log('❤️ Toggle favorite:', songId); 
  showToast('❤️ Función de favoritos próximamente', 'info');
}

function downloadSong(songId) { 
  console.log('⬇ Download song:', songId); 
  showToast('⬇ Función de descarga próximamente', 'info');
}

function showFavorites() { 
  console.log('❤️ Show favorites'); 
  showToast('❤️ Sección de favoritos próximamente', 'info');
}

function showDownloads() { 
  console.log('⬇ Show downloads'); 
  showToast('⬇ Sección de descargas próximamente', 'info');
}

function toggleShuffle() { 
  console.log('🔀 Toggle shuffle'); 
  showToast('🔀 Modo aleatorio próximamente', 'info');
}

function toggleRepeat() { 
  console.log('🔁 Toggle repeat'); 
  showToast('🔁 Modo repetir próximamente', 'info');
}

function toggleCurrentFavorite() { 
  console.log('❤️ Toggle current favorite'); 
  showToast('❤️ Favorito agregado', 'success');
}

function downloadCurrentSong() { 
  console.log('⬇ Download current song'); 
  showToast('⬇ Descargando canción...', 'info');
}

function createPlaylistFromModal() { 
  console.log('📱 Create playlist from modal'); 
  createNewPlaylist();
}

function closePlaylistModal() { 
  console.log('❌ Close playlist modal'); 
  const modal = document.getElementById('playlistModal');
  if (modal) modal.style.display = 'none';
}

function playPlaylist() { 
  console.log('▶ Play playlist'); 
  showToast('▶ Reproduciendo playlist...', 'info');
}

function deletePlaylist() { 
  console.log('🗑️ Delete playlist'); 
  if (confirm('⚠️ ¿Eliminar esta playlist?')) {
    showToast('🗑️ Playlist eliminada', 'success');
  }
}

function loadSongsForDeletion() { 
  console.log('📋 Load songs for deletion'); 
  showToast('📋 Función próximamente', 'info');
}

function deleteSong() { 
  console.log('🗑️ Delete song'); 
  if (confirm('⚠️ ¿Eliminar esta canción?')) {
    showToast('🗑️ Canción eliminada', 'success');
  }
}

function sortAlbums(value) { 
  console.log('📊 Sort albums:', value); 
  showToast('📊 Ordenamiento próximamente', 'info');
}

function closePlaylistView() { 
  console.log('❌ Close playlist view'); 
  goHome();
}

function closeFavoritesView() { goHome(); }
function closeDownloadsView() { goHome(); }

// Hide loading screen with premium animation
setTimeout(() => {
  const loadingScreen = document.getElementById('loadingScreen');
  if (loadingScreen) {
    loadingScreen.classList.add('slide-down');
    setTimeout(() => {
      loadingScreen.style.display = 'none';
    }, 500);
  }
}, 2000);

// Initialization Premium
(async () => {
  console.log('🚀 Inicializando KLMZ MUSIC PREMIUM ULTRA MÓVIL...');
  
  try {
    const { data } = await sb.auth.getSession();
    
    if (data?.session?.user?.email) {
      const email = data.session.user.email;
      currentUser = data.session.user;
      isLoggedIn = true;
      isAdmin = (email.toLowerCase() === ADMIN_EMAIL.toLowerCase());
      
      const btnLogin = document.getElementById("btn-login");
      const btnLogout = document.getElementById("btn-logout");
      const adminPanel = document.getElementById("adminPanel");
      const adminTag = document.getElementById("adminTag");
      const userTag = document.getElementById("userTag");
      
      if (btnLogin) btnLogin.style.display = "none";
      if (btnLogout) btnLogout.style.display = "inline-flex";
      
      if (isAdmin && adminPanel && adminTag) {
        adminPanel.style.display = "block";
        adminTag.style.display = "inline-block";
        console.log('👑 Modo Administrador activado');
      }
      
      if (isLoggedIn && userTag) {
        userTag.style.display = "inline-block";
      }
    }
    
    await refreshCatalog();
    
    // Inicializar waveform después de cargar
    setTimeout(() => {
      drawWaveform();
      optimizeForMobile();
    }, 1000);
    
    console.log('✅ KLMZ MUSIC PREMIUM ULTRA MÓVIL inicializado correctamente');
    showToast('🚀 KLMZ MUSIC cargado exitosamente', 'success');
    
  } catch (error) {
    console.error('❌ Error en inicialización:', error);
    showError('Error inicializando aplicación');
  }
})();

</script>

</body>
</html>

